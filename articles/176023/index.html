<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET MVC Lesson 5. Creating a Database Entry</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of the lesson. Track all the way to create a record in the database and output it. Error output. Validation. Mappers. Writing a validation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET MVC Lesson 5. Creating a Database Entry</h1><div class="post__text post__text-html js-mediator-article">  <b>The purpose of the lesson.</b>  Track all the way to create a record in the database and output it.  Error output.  Validation.  Mappers.  Writing a validation attribute.  Captcha  Creating data in the database. <br><br><h5>  Introduction </h5><br>  Finally, go to one of the most important lessons, which will be discussed about the creation of records.  Any action on the site, from complex ones, when we fill out a registration form, to simple ones, when we like it, happens as follows: <br><ul><li>  Post \ get request to the site </li><li>  Authorization and Authentication </li><li>  Validation of data entered (validation) for correctness </li><li>  If verification of the entered data has shown that the entered data is incorrect, then a warning is displayed in the form to be filled out. </li><li>  If verification of the entered data has shown that this data is correct, then they are saved in the database and a confirmation page is displayed. </li></ul><br><a name="habracut"></a><br><br><h5>  check in </h5><br>  Make a form for user registration.  When registering, the user must recognize the captcha and re-enter the password.  But let's start without it.  Create a Register method in the UserController and View controller. <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); }</code> </pre> <br>  Create and pass to View a new User object.  Since we have only two fields, create a View to fill in: <br><pre> <code class="html hljs xml">@using (Html.BeginForm("Register", "User", FormMethod.Post, new { @class = "form-horizontal" })) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"control-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"control-label"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Email"</span></span></span><span class="hljs-tag">&gt;</span></span> Email <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"controls"</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.ValidationMessage("Email") @Html.TextBox("Email", Model.Email) <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"control-group"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"control-label"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FirstName"</span></span></span><span class="hljs-tag">&gt;</span></span> Password <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"controls"</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.ValidationMessage("Password") @Html.Password("Password", Model.Password) <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-actions"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag">&gt;</span></span> Register <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> @Html.ActionLink("Cancel", "Index", null, null, new { @class = "btn" }) <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">fieldset</span></span></span><span class="hljs-tag">&gt;</span></span> }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All these divs, fieldsets and buttons are made in a similar way as described in the <a href="http://twitter.github.io/bootstrap/">bootstrap</a> framework (we will study further). <br>  Let's study the main Html-inserts: <br><pre> <code class="cs hljs">Html.BeginForm(<span class="hljs-string"><span class="hljs-string">"Register"</span></span>, <span class="hljs-string"><span class="hljs-string">"User"</span></span>, FormMethod.Post, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { @<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = <span class="hljs-string"><span class="hljs-string">"form-horizontal"</span></span> })</code> </pre><br>  - forms a tag <code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code class="cs"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email) <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code></code> </pre> <code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code><code class="cs"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>) <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code></code> </pre> <code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code><code class="cs"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> @Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password) <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code></code> </pre> <code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <h5> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </h5> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <ul><li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> </ul> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <h6> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </h6> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <ul><li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> </ul> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <h5> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </h5> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code><code><code class="bash"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code><code><code class="cs"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope(); <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code><code><code class="cs"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> @model LessonProject.Models.ViewModels.UserView <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <h6> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </h6> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <ol><li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li><li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li><li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li><li> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> </ol> <code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <h5> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </h5> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <div class="spoiler"> <code><code><code><code><b class="spoiler_title"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br>  Tools/CaptchaImage.cs: <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></b></code></code></code></code> <div class="spoiler_text"> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </div></div> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <ul><li> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> <li> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </li> </ul> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> <pre> <code class="hljs cmake"><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, Model.Email)</code> <br> -   <code><code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>)</code> <br> -       <br> <br> <code class="cs">@Html.Password(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, Model.Password)</code> <br> -   <code><code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUser); } [HttpPost] public ActionResult Register(User user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       <span class="hljs-number"><span class="hljs-number">2</span></span>  (   ),       User partial class: <br> <code class="cs">public partial class User { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Confirm Password &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>) @Html.Password(<span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span>, Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt;   <span class="hljs-number"><span class="hljs-number">1234</span></span> &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.ValidationMessage(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>) @Html.TextBox(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     <span class="hljs-number"><span class="hljs-number">1234</span></span>. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         <span class="hljs-number"><span class="hljs-number">1234</span></span> <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GetActivateUrl() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>); } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Email)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] {<span class="hljs-string"><span class="hljs-string">"Email"</span></span>}); } // Email var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(Email); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  email"</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Email"</span></span> }); } //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(Password)) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">" "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Password"</span></span> }); } //  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Password != ConfirmPassword) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new ValidationResult(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, new <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"ConfirmPassword"</span></span> }); } } }</code> <br>     <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, user.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash"><span class="hljs-keyword"><span class="hljs-keyword">Install</span></span>-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Inject] public IMapper ModelMapper { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != <span class="hljs-string"><span class="hljs-string">"1234"</span></span>) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); } var anyUser = Repository.Users.Any(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, userView.Email) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anyUser) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"   email  "</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" email"</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required(ErrorMessage=<span class="hljs-string"><span class="hljs-string">" "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Compare(<span class="hljs-string"><span class="hljs-string">"Password"</span></span>, ErrorMessage=<span class="hljs-string"><span class="hljs-string">"  "</span></span>)] public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConfirmPassword { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Captcha { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> AvatarPath { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     <span class="hljs-number"><span class="hljs-number">5</span></span>  <span class="hljs-number"><span class="hljs-number">6</span></span>  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(value is <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var source = value as <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(source)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } var regex = new Regex(@<span class="hljs-string"><span class="hljs-string">"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*"</span></span>, RegexOptions.Compiled); var match = regex.Match(source); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       <span class="hljs-number"><span class="hljs-number">2012</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> <br>   Birthdate  datetime <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code><code class="cs">@Html.DropDownList(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> <br>  , ,  <span class="hljs-number"><span class="hljs-number">1</span></span> - apple, <span class="hljs-number"><span class="hljs-number">2</span></span> ‚Äì orange (), <span class="hljs-number"><span class="hljs-number">3</span></span> - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"1"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"apple"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"2"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"orange"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem() { Value = <span class="hljs-string"><span class="hljs-string">"3"</span></span>, Text = <span class="hljs-string"><span class="hljs-string">"banana"</span></span>, Selected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateMonth { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public int BirthdateYear { get; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">13</span></span>; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = new DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, i, <span class="hljs-number"><span class="hljs-number">1</span></span>).ToString(<span class="hljs-string"><span class="hljs-string">"MMMM"</span></span>), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = <span class="hljs-number"><span class="hljs-number">1910</span></span>; i &lt; DateTime.Now.Year; i++) { yield <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class=<span class="hljs-string"><span class="hljs-string">"control-group"</span></span>&gt; &lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; Birth date &lt;/label&gt; &lt;div class=<span class="hljs-string"><span class="hljs-string">"controls"</span></span>&gt; @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateDay"</span></span>, Model.BirthdateDaySelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateMonth"</span></span>, Model.BirthdateMonthSelectList) @Html.DropDownList(<span class="hljs-string"><span class="hljs-string">"BirthdateYear"</span></span>, Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CaptchaValueKey = <span class="hljs-string"><span class="hljs-string">"CaptchaImageText"</span></span>; public <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Text { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> text; } } public Bitmap Image { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> image; } } public int Width { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> width; } } public int Height { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> height; } } // Internal properties. private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> text; private int width; private int height; private <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s, int width, int height, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> aHeight. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aWidth &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aWidth"</span></span>, aWidth, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (aHeight &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) throw new ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">"aHeight"</span></span>, aHeight, <span class="hljs-string"><span class="hljs-string">"Argument out of range, must be greater than zero."</span></span>); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> aFamilyName) { // <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the named font is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> installed, default to a system font. try { Font font = new Font(aFamilyName, <span class="hljs-number"><span class="hljs-number">12</span></span>F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new <span class="hljs-number"><span class="hljs-number">32</span></span>-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text font. SizeF size; float fontSize = rect.Height + <span class="hljs-number"><span class="hljs-number">1</span></span>; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (size.Width &gt; rect.Width); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = <span class="hljs-number"><span class="hljs-number">4</span></span>F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(<span class="hljs-number"><span class="hljs-number">0</span></span>F, <span class="hljs-number"><span class="hljs-number">0</span></span>F); path.Warp(points, rect, matrix, WarpMode.Perspective, <span class="hljs-number"><span class="hljs-number">0</span></span>F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = <span class="hljs-keyword"><span class="hljs-keyword">Math</span></span>.Max(rect.Width, rect.Height); for (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (int)(rect.Width * rect.Height / <span class="hljs-number"><span class="hljs-number">30</span></span>F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); int h = random.Next(m / <span class="hljs-number"><span class="hljs-number">50</span></span>); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(<span class="hljs-number"><span class="hljs-number">1111</span></span>, <span class="hljs-number"><span class="hljs-number">9999</span></span>).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), <span class="hljs-number"><span class="hljs-number">211</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-string"><span class="hljs-string">"Arial"</span></span>); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span>; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> null; }</code> <br> <br>   : <br>       <span class="hljs-number"><span class="hljs-number">1111</span></span>  <span class="hljs-number"><span class="hljs-number">9999</span></span>.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class=<span class="hljs-string"><span class="hljs-string">"control-label"</span></span> for=<span class="hljs-string"><span class="hljs-string">"FirstName"</span></span>&gt; &lt;img src=<span class="hljs-string"><span class="hljs-string">"@Url.Action("</span></span>Captcha<span class="hljs-string"><span class="hljs-string">", "</span></span>User<span class="hljs-string"><span class="hljs-string">")"</span></span> alt=<span class="hljs-string"><span class="hljs-string">"captcha"</span></span> /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userView.Captcha != (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError(<span class="hljs-string"><span class="hljs-string">"Captcha"</span></span>, <span class="hljs-string"><span class="hljs-string">"    "</span></span>); }</code> <br> <br>   , .     ,   : <br> <code class="cs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> RedirectToAction(<span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </pre> <code><code><code><code><code>     Dispose()</code> (  <code>using() {}</code> ) <br> <br> <code class="cs">@Html.TextBox("Email", Model.Email)</code> <br> -   <code class="cs"> (..      Email  ) <br> <br> @Html.ValidationMessage("Password")</code> <br> -       <br> <br> <code class="cs">@Html.Password("Password", Model.Password)</code> <br> -   <code><br> <br>     Register  Http-  POST (  FormMethod.Post</code>    Email=&amp;Password=. <br>   Register,      User,     HttpPost,   ‚Äî  HttpGet.  ,          ,  : <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUser = new User(); return View(newUser); } [HttpPost] public ActionResult Register(User user) { return View(user); }</code> <br> <br>       Register  ,     : <br> <br> <img src="https://habrastorage.org/storage2/9f5/ae9/2ab/9f5ae92ab59520133a199c60c35a5f61.jpg"> <br> <br> ,   Email  Password ,       (default). <br>       2  (   ),       User partial class: <br> <code class="cs">public partial class User { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } }</code> <br> <br>    View: <br> <code class="html">&lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Confirm Password &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("ConfirmPassword") @Html.Password("ConfirmPassword", Model.ConfirmPassword) &lt;/div&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Captcha &lt;/label&gt; &lt;/div&gt; &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt;   1234 &lt;/label&gt; &lt;div class="controls"&gt; @Html.ValidationMessage("Captcha") @Html.TextBox("Captcha", Model.Captcha) &lt;/div&gt; &lt;/div&gt;</code> <br>     ,     1234. <br> <br>  <br>    : <br>  email   Email ‚Äì     , ..   Email    -         1234 <br> <br>  -     ,   . <br> <br> IValidatableObject <br>      User - partial,       IValidatableObject ,  , ,     System.Component.DataAnnotation.    ,       ,   ‚Äì     MVC.       . <br>  User: <br> <code class="cs">public partial class User : IValidatableObject { public static string GetActivateUrl() { return Guid.NewGuid().ToString("N"); } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public IEnumerable&lt;ValidationResult&gt; Validate(ValidationContext validationContext) { //  Email if (string.IsNullOrWhiteSpace(Email)) { yield return new ValidationResult(" email", new string[] {"Email"}); } // Email var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(Email); if (!(match.Success &amp;&amp; match.Length == Email.Length)) { yield return new ValidationResult("  email", new string[] { "Email" }); } //   if (string.IsNullOrWhiteSpace(Password)) { yield return new ValidationResult(" ", new string[] { "Password" }); } //  if (Password != ConfirmPassword) { yield return new ValidationResult("  ", new string[] { "ConfirmPassword" }); } } }</code> <br>     4  6  ,    ,      . <br>  , : <br> <br> <img src="https://habrastorage.org/storage2/3bd/d97/21e/3bdd9721ec275df450beecee0eca7a40.jpg"> <br> <br> ,      . <br> <br>      :  Html.ValidationMessage(‚ÄúErrorField‚Äù)  Html.ValidationSummary().   ,     ,   ‚Äî   (  ) . <br> <br>           Email   (/Areas/Default/UserController.cs:Register): <br> <code class="cs">if (user.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, user.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); }</code> <br>  : <br> <br> <img src="https://habrastorage.org/storage2/155/453/b8b/155453b8be57a9a3428ad1bf2a886217.jpg"> <br> <br>  ,    ,   ,   ,    : <br>  User           , , ,      ,      . ..     ,   :  ,   ,   .      Model-    Controller- ‚Äì    . <br> <br>   ,   ,     User,  .    UserView     Models/ViewModels: <br> <code class="cs">public class UserView { public int ID { get; set; } public string Email { get; set; } public string Password { get; set; } public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> Automapping <br>       ,  ,     .     ,        User,   ,   -        UserView  User ,   .        ‚Äì  ,   ,        Update[Table]  .         object-to-object. <br>    ,  automapper ( <a href="http://automapper.org/">http://automapper.org/</a> ). ,            , ,    ,       . <br> <br>  Automapper: <br> <code class="bash">Install-Package AutoMapper</code> <br> <br>         ,    +      Ninject,      . <br>   /Mappers: <br> <br> <code class="cs">public interface IMapper { object Map(object source, Type sourceType, Type destinationType); }</code> <br> : <br> <code class="cs">public class CommonMapper : IMapper { static CommonMapper() { Mapper.CreateMap&lt;User, UserView&gt;(); Mapper.CreateMap&lt;UserView, User&gt;(); } public object Map(object source, Type sourceType, Type destinationType) { return Mapper.Map(source, sourceType, destinationType); } }</code> <br> <br>  (   -) (/App_Start/NinjectWebCommon.cs): <br> <br> <code class="cs">kernel.Bind&lt;IMapper&gt;().To&lt;CommonMapper&gt;().InSingletonScope();</code> <br> <br>  BaseController (/Controllers/BaseController.cs): <br> <code class="cs"> public abstract class BaseController : Controller { [Inject] public IRepository Repository { get; set; } [Inject] public IMapper ModelMapper { get; set; } }</code> <br>   UserController ( View)   UserView: <br> <code class="cs">[HttpGet] public ActionResult Register() { var newUserView = new UserView(); return View(newUserView); } [HttpPost] public ActionResult Register(UserView userView) { if (userView.Captcha != "1234") { ModelState.AddModelError("Captcha", "    "); } var anyUser = Repository.Users.Any(p =&gt; string.Compare(p.Email, userView.Email) == 0); if (anyUser) { ModelState.AddModelError("Email", "   email  "); } if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); //TODO:  } return View(userView); }</code> <br> <br>   Register.cshtml   : <br> <code class="cs">@model LessonProject.Models.ViewModels.UserView</code> <br> <br>  <br>  UserView     . <br> <br>  : <br> <code class="cs"> using System.ComponentModel.DataAnnotations; public class UserView { public int ID { get; set; } [Required(ErrorMessage=" email")] public string Email { get; set; } [Required(ErrorMessage=" ")] public string Password { get; set; } [Compare("Password", ErrorMessage="  ")] public string ConfirmPassword { get; set; } public string Captcha { get; set; } public string AvatarPath { get; set; } }</code> <br> <br> : <br> <br> <img src="https://habrastorage.org/storage2/2ba/8ce/e6a/2ba8cee6a6ae92cda271b82fb98dbe7e.jpg"> <br> <br>     5  6  . ,    email ‚Äì .     -,    email: <br> <code class="cs"> [AttributeUsage(AttributeTargets.Property, AllowMultiple = false)] public class ValidEmailAttribute : ValidationAttribute { public override bool IsValid(object value) { if (value == null) { return true; } if (!(value is string)) { return true; } var source = value as string; if (string.IsNullOrWhiteSpace(source)) { return true; } var regex = new Regex(@"\w+([-+.']\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*", RegexOptions.Compiled); var match = regex.Match(source); return (match.Success &amp;&amp; match.Length == source.Length); } }</code> <br> <br>  ,     ,    ,    ¬´¬ª  .   ,  ¬´     ¬ª, ..       ‚Äì   ,     .  ,    , .  ,               . <br> <br> <i>:   DataAnnotationsExtensions,       ( <a href="http://dataannotationsextensions.org/">http://dataannotationsextensions.org/</a> )</i> <br> <br>     . ,  ,  ,     . <br> <br>    . Birthdate datetime null. <br> <i>: ,     ,     :</i> <br> <img src="https://habrastorage.org/storage2/3d4/c6d/cb1/3d4c6dcb18c9a12f6b24a76369549397.jpg"> <br>       2012-1-1 <br>   Birthdate  datetime not null   <code>LessonProjectDb.dbml</code>  User     Server Explorer  SqlRepository/User.cs    UpdateUser(): <br> <code class="cs">public bool UpdateUser(User instance) { User cache = Db.Users.Where(p =&gt; p.ID == instance.ID).FirstOrDefault(); if (cache != null) { cache.Birthdate = instance.Birthdate; cache.AvatarPath = instance.AvatarPath; cache.Email = instance.Email; Db.Users.Context.SubmitChanges(); return true; } return false; }</code> <br>  UserView         Bithdate.      . <br> <br>       : <br> <br> <img src="https://habrastorage.org/storage2/cc5/404/43b/cc540443b61ecda733a52aa4630f513d.jpg"> <br> <br>     .    ‚Äì     .  Html (     )  DropDownList,    . <br>  : <br> <code class="cs">@Html.DropDownList(string name, IEnumerable selectList) <br> <br>  SelectListItem: <br> public class SelectListItem { public SelectListItem(); public bool Selected { get; set; } public string Text { get; set; } public string Value { get; set; } }</code> <br>  , ,  1 - apple, 2 ‚Äì orange (), 3 - banana     : <br> <code class="cs">public IEnumerable&lt;SelectListItem&gt; SelectFruit { get { yield return new SelectListItem() { Value = "1", Text = "apple", Selected = false }; yield return new SelectListItem() { Value = "2", Text = "orange", Selected = true }; yield return new SelectListItem() { Value = "3", Text = "banana", Selected = false }; } }</code> <br> <br>    <code>DropDownList()</code>  ,   ‚Äì name,    Value   () . <br> C     : <br> <br> <code class="cs">public int BirthdateDay { get; set; } public int BirthdateMonth { get; set; } public int BirthdateYear { get; set; } public IEnumerable&lt;SelectListItem&gt; BirthdateDaySelectList { get { for (int i = 1; i &lt; 32; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateDay == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateMonthSelectList { get { for (int i = 1; i &lt; 13; i++) { yield return new SelectListItem { Value = i.ToString(), Text = new DateTime(2000, i, 1).ToString("MMMM"), Selected = BirthdateMonth == i }; } } } public IEnumerable&lt;SelectListItem&gt; BirthdateYearSelectList { get { for (int i = 1910; i &lt; DateTime.Now.Year; i++) { yield return new SelectListItem { Value = i.ToString(), Text = i.ToString(), Selected = BirthdateYear == i }; } } }</code> <br> <br>   View: <br> <code class="html"> &lt;div class="control-group"&gt; &lt;label class="control-label" for="FirstName"&gt; Birth date &lt;/label&gt; &lt;div class="controls"&gt; @Html.DropDownList("BirthdateDay", Model.BirthdateDaySelectList) @Html.DropDownList("BirthdateMonth", Model.BirthdateMonthSelectList) @Html.DropDownList("BirthdateYear", Model.BirthdateYearSelectList) &lt;/div&gt; &lt;/div&gt;</code> <br> <br>     - point   . ,           UserView: <br> <br> <img src="http://habrastorage.org/storage2/72b/cba/4e5/72bcba4e5fe5ac5e1a1e45624a246217.jpg"> <br> <br> <img src="http://habrastorage.org/storage2/1ba/353/f37/1ba353f37fdf868c3810f5cf938d6f4e.jpg"> <br> <br>        User.       (/Mappers/CommonMapper.cs): <br> <code class="cs"> Mapper.CreateMap&lt;User, UserView&gt;() .ForMember(dest =&gt; dest.BirthdateDay, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Day)) .ForMember(dest =&gt; dest.BirthdateMonth, opt =&gt; opt.MapFrom(src =&gt; src.Birthdate.Month)) .ForMember(dest =&gt; dest.BirthdateYear, opt =&gt; opt.MapFrom(src =&gt;src.Birthdate.Year)); Mapper.CreateMap&lt;UserView, User&gt;() .ForMember(dest =&gt; dest.Birthdate, opt =&gt; opt.MapFrom(src =&gt; new DateTime(src.BirthdateYear, src.BirthdateMonth, src.BirthdateDay)));</code> <br> <br>         BirthdateDay, BirthdateMonth, BirthdateYear  Birthdate  . <br> <br> Captcha <br>   ,    ,          .       .      .    ,     . <br> <b class="spoiler_title"> Tools/CaptchaImage.cs:</b> <code class="cs">/// &lt;summary&gt; ///   /// &lt;/summary&gt; public class CaptchaImage { public const string CaptchaValueKey = "CaptchaImageText"; public string Text { get { return text; } } public Bitmap Image { get { return image; } } public int Width { get { return width; } } public int Height { get { return height; } } // Internal properties. private string text; private int width; private int height; private string familyName; private Bitmap image; // For generating random numbers. private Random random = new Random(); public CaptchaImage(string s, int width, int height) { text = s; SetDimensions(width, height); GenerateImage(); } public CaptchaImage(string s, int width, int height, string familyName) { text = s; SetDimensions(width, height); SetFamilyName(familyName); GenerateImage(); } // ==================================================================== // This member overrides Object.Finalize. // ==================================================================== ~CaptchaImage() { Dispose(false); } // ==================================================================== // Releases all resources used by this object. // ==================================================================== public void Dispose() { GC.SuppressFinalize(this); Dispose(true); } // ==================================================================== // Custom Dispose method to clean up unmanaged resources. // ==================================================================== protected virtual void Dispose(bool disposing) { if (disposing) // Dispose of the bitmap. image.Dispose(); } // ==================================================================== // Sets the image aWidth and aHeight. // ==================================================================== private void SetDimensions(int aWidth, int aHeight) { // Check the aWidth and aHeight. if (aWidth &lt;= 0) throw new ArgumentOutOfRangeException("aWidth", aWidth, "Argument out of range, must be greater than zero."); if (aHeight &lt;= 0) throw new ArgumentOutOfRangeException("aHeight", aHeight, "Argument out of range, must be greater than zero."); width = aWidth; height = aHeight; } // ==================================================================== // Sets the font used for the image text. // ==================================================================== private void SetFamilyName(string aFamilyName) { // If the named font is not installed, default to a system font. try { Font font = new Font(aFamilyName, 12F); familyName = aFamilyName; font.Dispose(); } catch (Exception) { familyName = FontFamily.GenericSerif.Name; } } // ==================================================================== // Creates the bitmap image. // ==================================================================== private void GenerateImage() { // Create a new 32-bit bitmap image. Bitmap bitmap = new Bitmap(width, height, PixelFormat.Format32bppArgb); // Create a graphics object for drawing. Graphics g = Graphics.FromImage(bitmap); g.SmoothingMode = SmoothingMode.AntiAlias; Rectangle rect = new Rectangle(0, 0, width, height); // Fill in the background. HatchBrush hatchBrush = new HatchBrush(HatchStyle.SmallConfetti, Color.LightGray, Color.White); g.FillRectangle(hatchBrush, rect); // Set up the text font. SizeF size; float fontSize = rect.Height + 1; Font font; // Adjust the font size until the text fits within the image. do { fontSize--; font = new Font(familyName, fontSize, FontStyle.Bold); size = g.MeasureString(text, font); } while (size.Width &gt; rect.Width); // Set up the text format. StringFormat format = new StringFormat(); format.Alignment = StringAlignment.Center; format.LineAlignment = StringAlignment.Center; // Create a path using the text and warp it randomly. GraphicsPath path = new GraphicsPath(); path.AddString(text, font.FontFamily, (int)font.Style, font.Size, rect, format); float v = 4F; PointF[] points = { new PointF(random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, random.Next(rect.Height) / v), new PointF(random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v), new PointF(rect.Width - random.Next(rect.Width) / v, rect.Height - random.Next(rect.Height) / v) }; Matrix matrix = new Matrix(); matrix.Translate(0F, 0F); path.Warp(points, rect, matrix, WarpMode.Perspective, 0F); // Draw the text. hatchBrush = new HatchBrush(HatchStyle.LargeConfetti, Color.LightGray, Color.DarkGray); g.FillPath(hatchBrush, path); // Add some random noise. int m = Math.Max(rect.Width, rect.Height); for (int i = 0; i &lt; (int)(rect.Width * rect.Height / 30F); i++) { int x = random.Next(rect.Width); int y = random.Next(rect.Height); int w = random.Next(m / 50); int h = random.Next(m / 50); g.FillEllipse(hatchBrush, x, y, w, h); } // Clean up. font.Dispose(); hatchBrush.Dispose(); g.Dispose(); // Set the image. image = bitmap; } }</code> <br> <br> <br>  ,    Image  ,    (    )  GenerateImage(). <br> <br>     UserController.Captcha(): <br> <code class="cs">public ActionResult Captcha() { Session[CaptchaImage.CaptchaValueKey] = new Random(DateTime.Now.Millisecond).Next(1111, 9999).ToString(); var ci = new CaptchaImage(Session[CaptchaImage.CaptchaValueKey].ToString(), 211, 50, "Arial"); // Change the response headers to output a JPEG image. this.Response.Clear(); this.Response.ContentType = "image/jpeg"; // Write the image to the response stream in JPEG format. ci.Image.Save(this.Response.OutputStream, ImageFormat.Jpeg); // Dispose of the CAPTCHA image object. ci.Dispose(); return null; }</code> <br> <br>   : <br>       1111  9999.   ci  CatchaImage     header  mime-  http-  ‚Äúimage/jpeg‚Äù ..   jpeg.  bitmap      ImageFormat.Jpeg   Bitmap  null,          <br> <br>    Register.cshtml (/Areas/Default/View/User/Register.cshtml): <br> <code class="html">&lt;label class="control-label" for="FirstName"&gt; &lt;img src="@Url.Action("Captcha", "User")" alt="captcha" /&gt; &lt;/label&gt;</code> <br> <br>  (/Areas/Default/Controllers/UserController.cs): <br> <code class="cs">if (userView.Captcha != (string)Session[CaptchaImage.CaptchaValueKey]) { ModelState.AddModelError("Captcha", "    "); }</code> <br> <br>   , .     ,   : <br> <code class="cs">if (ModelState.IsValid) { var user = (User)ModelMapper.Map(userView, typeof(UserView), typeof(User)); Repository.CreateUser(user); return RedirectToAction("Index"); }</code> <br> <br>      <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a></code></code></code></code> </div><p>Source: <a href="https://habr.com/ru/post/176023/">https://habr.com/ru/post/176023/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176013/index.html">#FailOverConf - how it was, presentations and videos</a></li>
<li><a href="../176015/index.html">Whatsapp not for sale</a></li>
<li><a href="../176017/index.html">ASP NET.MVC Lesson 3. Working with the Database</a></li>
<li><a href="../176019/index.html">Rapid deployment of the telephone network to Asterisk + Cisco</a></li>
<li><a href="../176021/index.html">ASP.NET MVC Lesson 4. Routing</a></li>
<li><a href="../176029/index.html">Xbox Durango may be submitted on May 21st (+ vote)</a></li>
<li><a href="../176033/index.html">Lionel Messi managed to score a goal for the robot only from the fourth time - video</a></li>
<li><a href="../176035/index.html">Microsoft, Nokia and Oracle have filed a complaint with the European Commission on the monopoly of Android applications from Google</a></li>
<li><a href="../176039/index.html">Network Virtualization in Hyper-V. Customization</a></li>
<li><a href="../176041/index.html">AsteriskNotifier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>