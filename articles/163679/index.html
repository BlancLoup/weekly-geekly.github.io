<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weak links in various programming languages</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In languages ‚Äã‚Äãwith automatic memory management, the garbage collector deletes objects when they are no longer accessible by reference. Usually this i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weak links in various programming languages</h1><div class="post__text post__text-html js-mediator-article">  In languages ‚Äã‚Äãwith automatic memory management, the garbage collector deletes objects when they are no longer accessible by reference.  Usually this is exactly what you need: the object exists as long as it is possible to access it. <br>  Sometimes this behavior is not suitable.  For example, the program needed to store some supporting information about instances of a certain class, but you cannot add your field to this class.  In this case, you can create a mapping, in which the key is the object, and the value is auxiliary information. <br>  This is where the problems begin.  Since the mapping stores references to keys, those objects to which the auxiliary information was tied cease to be freed from memory.  If the program in the course of its work creates many objects, the memory ends sooner or later. <a name="habracut"></a><br>  Weak links help to avoid such problems.  Weak references differ from the usual ones in that they do not prevent the object from being deleted from memory.  When the memory occupied by the object is released, all weak references pointing to it are reset.  In some implementations, in this case, the user-defined handler is also called - finalizer. <br>  In the example above, you need to replace the normal display with a display that stores weak references to keys.  When the key disappears, the entry in the display automatically disappears along with it, after which the value can also be released. <br>  Another example - a function by complex calculations gets a great value by a set of parameters.  In order not to calculate the same thing several times, you can make a cache of calculated values.  If a value is an object, then there is no point in deleting it from the cache as long as it is referenced.  Here you can use a mapping as a cache with weak references to values, not keys. <br>  Let's return to the example with supporting information.  Sometimes it happens that the supporting information is an object, and it contains a link to the key.  Mapping with weak references to keys ceases to work: since the reference to the value is not weak, and the value has a reference to the key, the key is always reachable through normal links, and the memory is not released.  This problem can be solved by making the link from the value too weak. <br>  But in some languages ‚Äã‚Äãthis problem can be solved with the help of a special kind of weak links: <a href="http://en.wikipedia.org/wiki/Ephemeron">ephemeron</a> .  Ephemeron supports links to two objects: a key and a value.  As long as the key is reachable by normal links, neither the key nor the value is deleted.  If the key is no longer reachable, then both links are reset and the key is released.  The whole point is that key references from a value are not taken into account when determining reachability, so if in the example above we replace the mapping with weak references to keys with a map that uses ephemerons, then everything will work again. <br>  From the point of view of the garbage collector, the presence of ephemeron creates a weak link from ephemeron to the key and a strong link from key to value.  In some languages, such as Haskell, there is also a strong link from the key to the ephemeron itself, so that the ephemeron continues to exist as long as the key exists, which allows you not to save the link to the ephemeron. <br><br><h1>  C # </h1><br>  In C #, weak references are implemented in two classes: <a href="http://msdn.microsoft.com/en-us/library/system.weakreference.aspx"><code>WeakReference</code></a> and <a href="http://msdn.microsoft.com/en-us/library/gg712738.aspx"><code>WeakReference&lt;T&gt;</code></a> in the <a href="http://msdn.microsoft.com/en-us/library/yxcx7skw.aspx"><code>System</code></a> namespace.  These classes are distinguished by the fact that the second one is a generic type, that is, it allows you to specify the type of the object to which the link points, in addition, they have different interfaces for accessing the object that the link points to: the first one uses this properties <code>IsAlive</code> and <code>Target</code> , and the second - methods <code>TryGetTarget</code> and <code>SetTarget</code> . <br>  Unlike other languages, C # allows you to change what object a weak reference points to after it has been created.  Also weak links have a constructor that accepts an additional parameter of type <code>bool</code> : if its value is <code>false</code> , then a normal weak link is created, and if <code>true</code> , the link will behave like a <code>PhantomReference</code> in Java.  In C #, weak links have no finalizers, as well as other ways to quickly find that one of the many weak links has been reset. <br><br><h1>  C ++ </h1><br>  In C ++, the <a href="http://en.cppreference.com/w/cpp/memory/weak_ptr"><code>std::weak_ptr</code></a> class is responsible for weak references, which is intended to be used in conjunction with the <a href="http://en.cppreference.com/w/cpp/memory/shared_ptr"><code>std::shared_ptr</code></a> class.  To work with an object to which a weak link points, you first need to get a strong link using the <code>lock</code> method. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Code example: <br><pre> <code class="hljs vbscript">#include &lt;iostream&gt; #include &lt;memory&gt; using namespace std; void print_weak(weak_ptr&lt;<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>&gt; w) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (auto s = w.lock()) { cout &lt;&lt; *s &lt;&lt; endl; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { cout &lt;&lt; <span class="hljs-string"><span class="hljs-string">"   "</span></span> &lt;&lt; endl; } } <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> main(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> argc, char *argv[]) { shared_ptr&lt;<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>&gt; s(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">123</span></span>)); weak_ptr&lt;<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>&gt; w(s); print_weak(w); s = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; print_weak(w); }</code> </pre><br><br><h1>  Haskell </h1><br>  Unlike many other languages, Haskell supports ephemerons.  All weak links are of type <code>Weak</code> , which is defined in the <a href="http://hackage.haskell.org/packages/archive/base/latest/doc/html/System-Mem-Weak.html"><code>System.Mem.Weak</code></a> module.  In Haskell, a weak link will exist at least as long as the key is reachable by reference, so you can create a weak link with the finalizer, ‚Äúforget‚Äù about it, and the finalizer will still be called.  The <code>addFinalizer</code> function <code>addFinalizer</code> just that.  To create a weak link, there are functions <code>mkWeak</code> and <code>mkWeakPtr</code> . <br><br>  Code example: <br><pre> <code class="haskell hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Control.Exception <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> System.Mem.Weak main = do l &lt;- getLine mkWeakPtr l (<span class="hljs-type"><span class="hljs-type">Just</span></span> $ <span class="hljs-title"><span class="hljs-title">putStrLn</span></span> "   ") evaluate $ sum [1..100000]</code> </pre><br><br><h1>  Java </h1><br>  In Java, a weak reference is a separate object, and in order to work with an object pointed to by a weak reference, you must first obtain a regular reference using the <code>get</code> method.  There are as many as 3 kinds of weak links: ‚Äúsoft‚Äù links (class <a href="http://docs.oracle.com/javase/7/docs/api/index.html%3Fjava/lang/ref/SoftReference.html"><code>SoftReference</code></a> in the <a href="http://docs.oracle.com/javase/7/docs/api/index.html%3Fjava/lang/ref/package-summary.html"><code>java.lang.ref</code></a> ), common weak links ( <a href="http://docs.oracle.com/javase/7/docs/api/index.html%3Fjava/lang/ref/WeakReference.html"><code>WeakReference</code></a> ) and ‚Äúphantom‚Äù links ( <a href="http://docs.oracle.com/javase/7/docs/api/index.html%3Fjava/lang/ref/PhantomReference.html"><code>PhantomReference</code></a> ).  They differ in that when the garbage collector will release objects reachable by such links.  If an object is reachable via soft links, it will be freed only if there is not enough free space on the heap.  Such links are well suited for all kinds of caches.  Normal weak links are different from ‚Äúphantom‚Äù ones when the link is reset: the first ones are reset before the finalizer is called, and the second ones after, just before the memory is released.  To prevent access to finalized objects, the read function for the <code>PhantomReference</code> always returns <code>null</code> .  The only way to benefit from them is to use link queues. <br>  If the program uses a lot of weak links, then checking each of them, if it is not nullified, it can be expensive.  Java does not allow you to set finalizers for weak links, but instead you can create a special object ‚Äî <a href="http://docs.oracle.com/javase/7/docs/api/index.html%3Fjava/lang/ref/ReferenceQueue.html"><code>ReferenceQueue</code></a> ‚Äî and set up weak links so that they add themselves when they are zeroed out.  Now you can check not all links, but only one queue. <br>  Also in Java there is a class <a href="http://docs.oracle.com/javase/7/docs/api/index.html%3Fjava/lang/ref/ReferenceQueue.html"><code>WeakHashMap</code></a> - an analogue of <code>HashMap</code> with weak references to keys. <br><br>  Code example: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.ref.*; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WeakRefTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,    // ,     . public static void printWhenUnreachable(Object obj) { ReferenceQueue&lt;Object&gt; queue = new ReferenceQueue&lt;Object&gt;(); WeakReference&lt;Object&gt; ref = new WeakReference&lt;Object&gt;(obj, queue); new Thread(new WeakRefTest(ref, queue)).start(); } private final WeakReference&lt;Object&gt; ref; private final ReferenceQueue&lt;Object&gt; queue; private WeakRefTest(WeakReference&lt;Object&gt; ref, ReferenceQueue&lt;Object&gt; queue) { this.ref = ref; this.queue = queue; } public void run() { try { queue.remove(); System.out.println("   "); } catch (InterruptedException e) { throw new RuntimeException(e); } } }</span></span></code> </pre><br>  Notice that the <code>WeakRefTest</code> class has a <code>ref</code> field that is not used.  It is necessary so that the weak link itself is not released prematurely, otherwise it will not work. <br><br><h1>  Lua </h1><br>  Lua supports weak references through <a href="http://www.lua.org/manual/5.2/manual.html">‚Äúweak tables‚Äù</a> : in the corresponding metatable, the <code>__mode</code> key can be set to a string value, and then if it contains the <code>k</code> character, then the keys references will be weak, and if it contains the <code>v</code> character, then the references to values ‚Äã‚Äãwill be weak .  The type of the table can be changed after its creation, but the changes will take effect only at the next garbage collection.  As in other implementations of tables with weak references, when a key or value is zeroed out, the entire record is deleted. <br>  If the references to the keys are weak, and the values ‚Äã‚Äãare strong, then the records in the table will behave like ephemerons: a reference from the value to the key will not prevent the entry from being deleted. <br><br><h1>  Perl </h1><br>  In Perl, any link can be made weak using the <code>weaken</code> method of the <a href="http://perldoc.perl.org/Scalar/Util.html"><code>Scalar::Util</code></a> package.  Unlike other languages, if you copy a weak link, the copy will be a regular link. <br><br><h1>  Python </h1><br>  Python supports weak references, but they can only be created on instances of those classes that support it.  These include most custom classes and some built-in ones.  In addition, in Python there are 2 classes for weak links: from instances of the class <code>ref</code> (package <a href="http://docs.python.org/3/library/weakref.html"><code>weakref</code></a> ), the usual link to the object must be obtained explicitly, and with instances of the class <code>proxy</code> you can work directly. <br>  When creating a weak reference, you can specify a finalizer.  It is also possible for any object to get a list of weak links to it (normal, by the way, too). <br>  Unlike Java, Python has as many as 3 types of collections with weak links: <code>WeakSet</code> , <code>WeakKeyDictionary</code> and <code>WeakValueDictionary</code> . <br><br>  Code example: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf8 -*- from weakref import * def finalizer(ref): print("   ") obj = set() reference = ref(obj, finalizer) del obj</span></span></code> </pre><br>  As in Java, if the reference is deleted before the object, the finalizer is not called. <br><br><h1>  Ruby </h1><br>  In Ruby, weak links are implemented in a single <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/weakref/rdoc/WeakRef.html"><code>WeakRef</code></a> class, which behaves similarly to the <code>proxy</code> class in Python, that is, you can work with a weak link in the same way as with the object itself.  In addition to the methods of the object itself, weak links have a <code>weakref_alive?</code> method <code>weakref_alive?</code>  , which returns <code>true</code> if the object to which the link points still exists, otherwise <code>false</code> . <br><br>  <strong>UPD:</strong> sorted the languages ‚Äã‚Äãin alphabetical order, added C # and Lua, described the behavior of ephemerons in more detail. </div><p>Source: <a href="https://habr.com/ru/post/163679/">https://habr.com/ru/post/163679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163663/index.html">Playing with images in Python</a></li>
<li><a href="../163665/index.html">SharePoint Foundation Corporate Site: Some Practical Tips</a></li>
<li><a href="../163667/index.html">Video digest of the latest gaming industry news | Geek Week # 6</a></li>
<li><a href="../163673/index.html">The revolution that flowed into evolution under the auspices of Apple</a></li>
<li><a href="../163677/index.html">Is it possible to create an artificial mind?</a></li>
<li><a href="../163681/index.html">Game Theory: An Introduction</a></li>
<li><a href="../163683/index.html">Designer developer Arduino named entrepreneur of the year in the US</a></li>
<li><a href="../163685/index.html">Christmas sale on Google Play! Discounts up to 86%!</a></li>
<li><a href="../163687/index.html">What else can you type?</a></li>
<li><a href="../163689/index.html">Minicomputer from a router with OpenWRT: we are developing a USB video card</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>