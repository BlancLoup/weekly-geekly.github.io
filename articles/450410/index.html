<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Terraformer - Infrastructure To Code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to tell you about the new CLI tool that I wrote to solve one old problem. 

 Problem 
 Terraform has long become a standard in the Devops...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Terraformer - Infrastructure To Code</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/3ac/04c/136/3ac04c136f4060b5f1cc3c80401cb8b4.png" alt="image"><br>  I would like to tell you about the new CLI tool that I wrote to solve one old problem. <br><br><h3>  Problem </h3><br>  Terraform has long become a standard in the Devops / Cloud / IT community.  The thing is very convenient and useful to deal with infrastructure as code.  There are many charms in Terraform as well as many forks, sharp knives and rakes. <br>  With Terraform it is very convenient to do new things and then manage, change or delete them.  And what about those who have a huge infrastructure in the cloud and are not created through Terraform?  Rewriting and re-creating the entire cloud is expensive and unsafe. <br>  I encountered such a problem in 2 papers, the simplest example is when you want everything to be in the form of file terraform files, and you have 250+ buckets and write something for the terraform with your hands like that a lot. <br>  There is an <a href="https://github.com/hashicorp/terraform/issues/581">issue</a> since 2014 in terrafom which was closed in 2016 with the hope that it will be import. <br><br>  In general, everything is as in the picture only from right to left <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Warnings: The author lives half the life not in Russia and writes little in Russian.  Caution spelling errors. <br><br><h3>  Solutions </h3><br>  1. There are ready and old solutions for AWS <a href="https://github.com/dtan4/terraforming">terraforming</a> .  When I tried to get my 250+ bakes through it, I realized that everything was bad there.  AWS has long been a lot of new options and terraforming does not know about them, and in general his ruby <a href="">templet looks poor</a> .  After 2 in the evening I sent a <a href="https://github.com/dtan4/terraforming/pull/396">pull request</a> to add more features there and I realized that such a solution does not work at all. <br>  How terraforming works it takes data from the AWS SDK and generates tf and tfstate via the templet. <br>  There are 3 problems here: <br>  1. There will always be a lag in updates. <br>  2. tf files sometimes come out broken <br>  3. tfstate is set up separately from tf and does not always converge. <br>  In general, it is difficult to get a result in which `terraform plan` will say that there are no changes. <br><br>  2. `terraform import` - built-in command in terraform.  How does it work? <br>  You write an empty TF file with the name and type of the resource, then you run the `terraform import` and pass the resource ID.  terraform accesses the provider and receives the data and makes a tfstate file. <br>  There are 3 problems here: <br>  1. We get only the tfstate file and the tf empty must be manually written or converted with tfstate <br>  2. Able to work with only one resource each time and does not support all resources.  And what do I do again with 250+ bakes <br>  3. You need to know the resource ID - that is, you need to wrap it in the code that gets the list of resources <br>  In general, the result is partial and does not scale well. <br><br><h3>  My decisions <br></h3>  Requirements: <br>  1. The ability to create files tf and tfstate resources.  For example, download all buckets / security group / load balancer and that `terraform plan` returned no changes <br>  2. You need 2 GCP + AWS clouds <br>  3. Global solutions that are easy to update every time and do not waste time on each resource for 3 days of work <br>  4. Making an open source is a problem for everyone <br><br>  Go language - because I love, and it has a library for creating HCL files that is used in terraform + a lot of code in terraform which can be useful <br><br><h3>  Way </h3><br>  Attempt first <br>  Started a simple option.  Referring to the cloud via the SDK for the desired resource and converting it into fields for terraform.  The attempt died immediately on the security group because I did not like to convert only the security group for 1.5 days (and there are many resources).  Long and then fields can be changed / added <br><br>  Attempt second <br>  Based on the idea described <a href="https://github.com/hashicorp/terraform/issues/15608">here</a> .  Just take and convert tfstate to tf.  All data is there and the fields are the same.  How to get full tfstate for a lot of resources ??  This is where the `terraform refresh` command came to the rescue.  terraform takes all the resources in tfstate and by ID pulls data from them and writes everything to tfstate.  That is, to create an empty tfstate only with names and IDs, run `terraform refresh`, then we get full tfstate.  Hooray! <br>  Now let's do <s>recursive pornography,</s> writing a converter for tfstate to tf.  For those who have never read tfstate, this is JSON, but special. <br>  Here is its important part attributes <br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"attributes"</span></span>: { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"default/backend-logging-load-deployment"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.annotations.%"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.generate_name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.generation"</span></span>: <span class="hljs-string"><span class="hljs-string">"24"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.labels.%"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.labels.app"</span></span>: <span class="hljs-string"><span class="hljs-string">"backend-logging"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.name"</span></span>: <span class="hljs-string"><span class="hljs-string">"backend-logging-load-deployment"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.resource_version"</span></span>: <span class="hljs-string"><span class="hljs-string">"109317427"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.self_link"</span></span>: <span class="hljs-string"><span class="hljs-string">"/apis/apps/v1/namespaces/default/deployments/backend-logging-load-deployment"</span></span>, <span class="hljs-string"><span class="hljs-string">"metadata.0.uid"</span></span>: <span class="hljs-string"><span class="hljs-string">"300ecda1-4138-11e9-9d5d-42010a8400b5"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.min_ready_seconds"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.paused"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.progress_deadline_seconds"</span></span>: <span class="hljs-string"><span class="hljs-string">"600"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.replicas"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.revision_history_limit"</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.selector.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>,</code> </pre> <br>  There is: <br>  1. id - string <br>  2. metadata - array of size 1 and in it an object with fields which is described below <br>  3. spec - hash size 1 and in it key, value <br>  In short, a fun format, everything can be in depth, too, on several levels <br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"spec.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.min_ready_seconds"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.paused"</span></span>: <span class="hljs-string"><span class="hljs-string">"false"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.progress_deadline_seconds"</span></span>: <span class="hljs-string"><span class="hljs-string">"600"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.replicas"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.revision_history_limit"</span></span>: <span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.selector.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.selector.0.match_expressions.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.selector.0.match_labels.%"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.selector.0.match_labels.app"</span></span>: <span class="hljs-string"><span class="hljs-string">"backend-logging-load"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.strategy.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.annotations.%"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.generate_name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.generation"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.labels.%"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.labels.app"</span></span>: <span class="hljs-string"><span class="hljs-string">"backend-logging-load"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.name"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.resource_version"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.self_link"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.metadata.0.uid"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.spec.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.spec.0.active_deadline_seconds"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.spec.0.container.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-string"><span class="hljs-string">"spec.0.template.0.spec.0.container.0.args.#"</span></span>: <span class="hljs-string"><span class="hljs-string">"3"</span></span>,</code> </pre> <br>  In general, who wants a programming problem for an interview, then just ask to write a parser for this thing :) <br>  After long attempts to write a parser without bugs, I found a part of it in the code of terraform and the most important part.  And everything seemed to work norms <br><br>  Attempt three <br>  The terraform provider is a binary in which there is a code with all the resources and logic for working with the cloud API.  Each cloud has its own provider and the terraform itself only calls them through its RPC protocol between two processes. <br>  Now I decided to contact the terraform providers directly via RPC calls.  So it turned out beautifully and made it possible to change the terraform providers to newer ones and get new opportunities without changing the code.  It turned out that not all fields in tfstate should be in tf, but how to find out?  Just ask the provider about it.  Then another <s>recursive pornography on the assembly of regular expressions</s> Gimp began with the search for fields inside tfstate at all levels in depth. <br><br>  At the end, we got a useful CLI tool with a common infrastructure for all terraform providers and you can easily add a new one.  Also adding resources takes a little code.  Plus all sorts of buns like connection between resources.  Of course there were many different problems that can not be described. <br>  Named animal Terrafomer. <br><br><h3>  The final </h3><br>  Using Terrafomer, we generated 500-700 thousand lines of tf + tfstate code from two clouds.  We were able to take Legacy things and start touching them only through a terraform, as in the best ideas infrastructure as code.  Just magic when you take a huge cloud and get it through the command of it in the form of a terraform file of workers.  And then grep / replace / git and so on. <br><br>  Combed and put in order, received permission.  Released on githab for all on Thursday (05/02/19).  <a href="https://github.com/GoogleCloudPlatform/terraformer">github.com/GoogleCloudPlatform/terraformer</a> <br>  Already received 600 stars, 2 pull requests add support for openstack and kubernetes.  Good feedback.  In general, the project is useful for people. <br>  I advise everyone who wants to start working with Terraform and not rewrite everything for this. <br>  I will be glad to pull requests, issues, stars. <br><br>  Demo <br> <a href="https://asciinema.org/a/243961"><img src="https://asciinema.org/a/243961.svg"></a> <br><br>  Updates: screwed up minimal support for Openstack and kubernetes support is almost ready, thanks to people for PRs </div><p>Source: <a href="https://habr.com/ru/post/450410/">https://habr.com/ru/post/450410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450394/index.html">Investigation into one unknown archive</a></li>
<li><a href="../450398/index.html">The most fearless poisons</a></li>
<li><a href="../4504/index.html">Pensioners are being introduced into social networks</a></li>
<li><a href="../45040/index.html">Wonders of automation or how real geeks send SMS</a></li>
<li><a href="../45041/index.html">Work with ANSI console</a></li>
<li><a href="../450412/index.html">Snake on C # and Onion aka Clean Architecture</a></li>
<li><a href="../450416/index.html">How shareware VPN providers sell your data</a></li>
<li><a href="../45042/index.html">Useful stuff for a novice developer Sharepoint</a></li>
<li><a href="../450420/index.html">Why Data Science teams need generalists, not specialists</a></li>
<li><a href="../450422/index.html">Limitations of image recognition algorithms</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>