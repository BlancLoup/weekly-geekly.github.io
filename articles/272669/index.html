<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tarantool as an application server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi,% Habrayuser%. The Tarantula team continues to share insights and expertise to work effectively with data in high-load projects. Today we will try ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tarantool as an application server</h1><div class="post__text post__text-html js-mediator-article">  Hi,% Habrayuser%.  The Tarantula team <a href="http://habrahabr.ru/company/mailru/blog/252065/">continues</a> to share insights and expertise to work effectively with data in high-load projects.  Today we will try to figure out why Tarantool is ‚Äútwo in one‚Äù: not only the database, but also the application server.  Probably, some have heard of the Tarantula as a super-fast persistent in-memory replication repository and storage on Lua.  Imagine that we take Redis slices, add frozen Node.js, fill Go from above, and then cook, <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D1%2580%25D0%25B8%25D0%25B1%25D0%25BE%25D0%25B2%25D0%25B0%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5">stirring slowly, for five minutes after boiling</a> .  It would seem, what have the Application Server? <br><br><img src="https://habrastorage.org/files/324/120/7b1/3241207b147d439095581566628e28ef.jpg"><br><a name="habracut"></a><br>  Many will probably be surprised, but such great products as nginx, Go, Node.js, Redis, MongoDB, Tarantool and others have a lot in common in architectural terms.  To create any high-performance network server, one way or another, a set of libraries is needed that provides non-blocking I / O, asynchronous event handling, memory handling, error handling, logging, demonization, etc., etc. This runtime usually represents is a rather complicated thing that requires a deep understanding of the basics of the work of various systems and skills of low-level programming. <br><br>  We in the Tarantool team have come a very long way, having created our runtime with asynchronous event processing, non-blocking I / O, green threads in user-space (faybery), cooperative multitasking, a family of specialized memory allocators, etc., etc. It turned out something architecturally most similar to Go (fools have the same thoughts), but only in the form of libraries for pure C. Thanks to this basis, we managed to create a database that is capable of processing up to 6M requests per second on <b>one core of an</b> ordinary laptop and has the best memory  footprint on the market.  At some point, we decided to give unlimited freedom to application developers, allowing in stored procedures to do not only database queries, but also use our entire toolkit in full.  Retrieving and parsing JSON's HTTP over a cloud service directly from the database is easy.  Start your REST service directly in the DBMS - please.  Go over the data on a dozen servers, processing requests in parallel - no problem!  All features and tools in the hands of developers!  Developers, developers, developers! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  How to make X, Y, Z in Tarantool? </h1><br><img src="https://habrastorage.org/files/026/3a1/426/0263a1426aa8404eaf30d807aeae326e.jpg"><br><br>  We are often asked if there are queues in Tarantool, data expiration, pub / sub, multiget, or something else from hundreds of Redis commands.  No, in Tarantool there is nothing of this, it was not and never will be (weeds, caties).  We abandoned this path and offer a slightly different approach.  As you know, give a man a fish, and he will be fed one day, teach him to fish, and he will always be fed.  Tarantool provides the tools ("fishing rod"), with which you can solve various problems, including those emerging from the category of patterns and patterns.  Automatic deletion of old data - background file on Lua.  Multiget from several tables by a certain condition - two lines of Lua.  Return data in JSON format - upload the web server module directly to the database.  <a href="http://tarantool.org/doc/reference/box.html">Think out of the box</a> ! <br><br>  Let's see what tools Tarantool provides: <br><br><ul><li>  <a href="http://tarantool.org/doc/reference/fiber.html">fiber</a> - cooperative multitasking and channels (as in Go); </li><li>  <a href="http://tarantool.org/doc/reference/socket.html">socket</a> , <a href="http://tarantool.org/doc/reference/fio.html">fio</a> - asynchronous non-blocking socket and file I / O; </li><li>  json / msgpack / yaml - data packers-unpackers; </li><li>  <a href="https://github.com/tarantool/mysql">mysql</a> / <a href="https://github.com/tarantool/pg">pg</a> / whatever - clients for MySQL, PostgreSQL from the Tarantula itself; </li><li>  <a href="http://tarantool.org/doc/reference/net_box.html">net.box</a> - client to the Tarantula from the Tarantula itself; </li><li>  <a href="http/">http</a> - a primitive HTTP server and client; </li><li>  <a href="http://tarantool.org/doc/reference/tap.html">tap</a> - testing for applications and modules; </li><li>  <a href="http://tarantool.org/doc/reference/console.html">console</a> - server status inspection, hot code download, change settings on the fly; </li><li>  <a href="http://tarantool.org/doc/reference/log.html">log</a> - event logging, logrotate; </li><li>  init scripts, RPM / DEB packages, deployment tools, etc. </li></ul><br>  In the role of the cherry on the cake is <a href="http://tarantool.org/doc/book/box/index.html">box</a> - a <a href="http://articles.rvncerr.org/how-to-chose-an-in-memory-nosql-solution-performance-measuring/">super</a> - <a href="http://articles.rvncerr.org/how-to-chose-an-in-memory-nosql-solution-performance-measuring/">fast</a> multi-engine database with transaction support and multi-master replication, working directly in the same address space as the applications. <br><br><h1>  Interestingly, but we have a three-tier architecture? </h1><br><img src="https://habrastorage.org/files/15f/325/d2d/15f325d2d8134502992bbdee726a280b.jpg"><br><br>  ‚ÄúIs it really again proposed to transfer all business logic to the database, instead of a separate application server (Node.js, PHP, Python, whatever) and DBMS (Redis, MongoDB, etc.)?‚Äù You reasonably argue.  No, we <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B6%25D0%25BE%25D1%2580%25D0%25B4%25D0%25B0%25D0%25BD%25D0%25BE_%25D0%2591%25D1%2580%25D1%2583%25D0%25BD%25D0%25BE">do not encroach</a> on the foundations of the universe.  Let's just look a little more pragmatically.  At a time when <s>space</s> applications can already be written <a href="http://bellard.org/jslinux/">directly in the browser</a> , the server side remains at most for data storage and processing, while the browser can request and update all the necessary information dynamically via AJAX.  What then does your application server do (PHP / Node / Go / Python)?  Idle waiting for a response from the base, then immediately give it all in the form of JSON in nginx?  But you need to open a transaction, then over the network, extort data from the database, change some fields in the application server, send updates back to the database, close the transaction and return the result to nginx.  How many extra network round trip and switchings of userspace &lt;-&gt; kernel &lt;-&gt; userspace will we spend?  And yet, the database should support for you a complete read-view data for each open transaction, for example, at the cost of using locks or other equally heavy mechanisms.  And all this in order to select five records from one label, update two records to another and return the result to our REST service? <br><br>  For this kind of microservices, Tarantula offers <s>to</s> write the storage right next to the data itself, inside the database.  The <a href="http">tarantool-http</a> and <a href="https://github.com/tarantool/nginx_upstream_module">nginx_tarantool_upstream module</a> easily organizes a REST service from Tarantula, simplifying the service architecture and removing the unnecessary link as a dedicated application server.  At the same time, no one offers to rewrite the entire application in this way, because you can select into microservice only the most loaded parts of the project, where the performance margin of traditional solutions is not enough.  For the rest, you can use the same Tarantool as a general-purpose DBMS via connectors from different programming languages. <br><br><h1>  Fine, but there Lua ?! </h1><br><img src="https://habrastorage.org/files/703/4df/89b/7034df89b5d14d6cbc67377cffd64c00.jpg"><br><br>  ‚ÄúWe do not know how to write on Lua!  And where can we get such programmers? ‚Äù- you ask.  <a href="">Don't panic</a> !  Lua (Portuguese. Moon) - simple as a penny language, does not require to work to study the <a href="http://www.amazon.com/s/ref%3Dnb_sb_noss_2%3Furl%3Dsearch-alias%253Daps%26field-keywords%3D.net%2Bframework%26rh%3Di%253Aaps%252Ck%253A.net%2Bframework">collected works of authors</a> in ten volumes.  We looked at the examples instead of viewing ads in the subway - and you can already begin <s>to rob</s> code.  In Mail.Ru Group, Lua's C / C ++ programmers as well as Python, Perl, Ruby and JS developers write procedures on Lua equally well.  But why Lua?  Tarantool gives the developer a real Turing-complete high-level programming language, allowing to solve any problems.  Say your hard iron is <b>not</b> programming in <a href="https://en.wikipedia.org/wiki/PL/SQL">PL / SQL</a> , <a href="https://en.wikipedia.org/wiki/XSLT">XML</a> , <a href="http://docs.ansible.com/ansible/playbooks_conditionals.html">YAML</a> and <a href="http://www.freedesktop.org/software/systemd/man/systemd.service.html">ini-files</a> (God forgive me).  In addition, Lua is extremely simple and <a href="http://rtsisyk.github.io/luafun/intro.html">works very fast</a> .  With Lua, there is no dispute about what 10% of the language functionality is allowed to use in the project. <br><br>  By the way, Tarantool also has <a href="http://tarantool.org/doc/reference/capi.html">an API</a> that allows you to achieve unprecedented performance and, in theory, the ability to use any other languages.  We will talk about this in more detail in the next series, do not disconnect. <br><br><h1>  And let's try! </h1><br><img src="https://habrastorage.org/files/c45/903/3d4/c459033d4ee24556b4f5e245e8d30306.jpg"><br><br>  Install Tarantool from the <a href="http://tarantool.org/download.html">tarantool.org/download.html</a> page.  The repositories on the site have binary packages for the main Linux distributions, as well as ports for FreeBSD and brew for OS X. After installation, enter the tarantool command in the <code>tarantool</code> , which by default launches the interactive console (like Python, Node, irb, etc.): <br><br><pre> <code class="bash hljs">roman@book:~$ tarantool tarantool: version 1.6.8-123-gbe2ce21 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-string"><span class="hljs-string">'help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> interactive <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> tarantool&gt;</code> </pre><br>  In the interpreter, you can enter an arbitrary Lua code, and the result of the execution will be displayed in a readable format (YAML) in the console: <br><br><pre> <code class="bash hljs">tarantool&gt; 2 + 2 --- - 4 ... tarantool&gt; { name = <span class="hljs-string"><span class="hljs-string">"Roman"</span></span>, gender = <span class="hljs-string"><span class="hljs-string">"male"</span></span> } --- - name: Roman gender: male ... tarantool&gt; <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">'Hello'</span></span>) Hello --- ...</code> </pre><br>  All the same can be written as a script in a separate file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env tarantool print('Hello world!')</span></span></code> </pre><br>  Run the script in the same way as Bash, Python or Ruby: <br><br><pre> <code class="bash hljs">roman@desktop:~$ edit ololo.lua roman@desktop:~$ chmod a+x ololo.lua roman@desktop:~$ ./ololo.lua Hello world!</code> </pre><br>  Tarantool is fully compatible with Lua 5.1 and LuaJIT at the script level and can be used as a drop-in replacement.  All modules from Lua work in Tarantool. <br><br>  The <code>box.cfg{}</code> function configures and launches the embedded database (box), after which you can create tables (space) and execute queries: <br><br><pre> <code class="bash hljs">tarantool&gt; box.cfg {} [cut] tarantool&gt; space = box.schema.space.create(<span class="hljs-string"><span class="hljs-string">'test'</span></span>) [cut] tarantool&gt; box.space.test:create_index(<span class="hljs-string"><span class="hljs-string">'primary'</span></span>, { <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">'tree'</span></span>, parts = { 1, <span class="hljs-string"><span class="hljs-string">'num'</span></span> }}) [cut] tarantool&gt; box.space.test:insert({48, <span class="hljs-string"><span class="hljs-string">'some data'</span></span>, { key = <span class="hljs-string"><span class="hljs-string">'value'</span></span>, key2 = <span class="hljs-string"><span class="hljs-string">'value2'</span></span> }}) --- - [48, <span class="hljs-string"><span class="hljs-string">'some data'</span></span>, {<span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-string"><span class="hljs-string">'key2'</span></span>: <span class="hljs-string"><span class="hljs-string">'value2'</span></span>}] ... tarantool&gt; box.space.test:select() --- - - [48, <span class="hljs-string"><span class="hljs-string">'some data'</span></span>, {<span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-string"><span class="hljs-string">'key2'</span></span>: <span class="hljs-string"><span class="hljs-string">'value2'</span></span>}] ...</code> </pre><br>  If you now stop the interactive console (via CTRL + D or <code>os.exit(0)</code> ), then in the directory you can see the new * .snap, * .xlog files.  These files are used to ensure the persistence of our database in memory.  <code>tarantool</code> restore all data: <br><br><pre> <code class="bash hljs">tarantool&gt; box.cfg{} --- ... tarantool&gt; box.space.test:select() --- - - [48, <span class="hljs-string"><span class="hljs-string">'some data'</span></span>, {<span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'value'</span></span>, <span class="hljs-string"><span class="hljs-string">'key2'</span></span>: <span class="hljs-string"><span class="hljs-string">'value2'</span></span>}] ...</code> </pre><br>  And now let's try something more complicated (example from the main page): <br><br><pre> <code class="lua hljs">#!/usr/bin/env tarantool box.cfg{} <span class="hljs-comment"><span class="hljs-comment">--      box.once('schema', function() box.schema.create_space('hosts') box.space.hosts:create_index('primary', { type = 'hash', parts = {1, 'str'} }) end) --  GET-  / local function handler(self) --  IP-  local ipaddr = self.peer.host --         box.space.hosts:upsert({ ipaddr, 1 }, {{'+', 2, 1}}) --      JSON  return self:render{ json = box.space.hosts:select() } end local httpd = require('http.server') local server = httpd.new('127.0.0.1', 8080) server:route({ path = '/' }, handler) server:start()</span></span></code> </pre><br>  To run, you need the <a href="http/">tarantool-http</a> module, which can be supplied from packages or from GitHub.  The script at the first start will create the <code>hosts</code> table, after which the HTTP server will be started, which on `/` will increment the counter for each IP address and return all the addresses in JSON format to the client.  It is also easy to put in front of the nginx service.  By the way, <a href="http://try.tarantool.org/">try.tarantool.org is</a> written in Tarantool itself.  We <a href="https://en.wikipedia.org/wiki/Eating_your_own_dog_food">ourselves eat our cacti</a> and try to make the life of developers better. <br><br><h1>  We roll out on production </h1><br><img src="https://habrastorage.org/files/679/cef/82b/679cef82bffa4914ab7f76ec6f974130.jpg"><br><br>  How better to place our simple application on a working server?  After all, it's one thing to play around in the console, and quite another to launch it all into battle.  <a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2583%25D1%2580%25D1%2581_%25D1%2582%25D0%25B5%25D0%25BE%25D1%2580%25D0%25B5%25D1%2582%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B9_%25D1%2584%25D0%25B8%25D0%25B7%25D0%25B8%25D0%25BA%25D0%25B8_%25D0%259B%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0%25D1%2583_%25D0%25B8_%25D0%259B%25D0%25B8%25D1%2584%25D1%2588%25D0%25B8%25D1%2586%25D0%25B0">It's simple</a> .  We transfer the script to <code>/etc/tarantool/instances.enabled/myapp.lua</code> and run it through the ready-made utilities for init ( <code>tarantoolctl start myapp</code> or even <code>service tarantool restart</code> ).  Works!  Simply? <br><br>  You can do as many applications as you like, the init system itself will launch the required number of Tarantool daemons and monitor them.  We recommend running slightly less tarantulas than you have physical cores.  This approach will provide the best performance per server and <a href="http://www.highload.ru/2015/abstracts/1930.html">save millions of dollars</a> .  In the process list, you can easily find a demon with the name of your application.  Log files are written to <code>/var/log/tarantool/myapp.log</code> by default, data are stored in <code>/var/lib/tarantool/myapp/</code> , and the pid file is written to <code>/run/tarantool</code> .  In other words, everything is exactly as intended in your favorite distribution.  To build RPM and DEB packages you can use our <a href="https://github.com/tarantool/modulekit">template</a> . <br><br>  From the useful is worth special mention the command <code>tarantoolctl enter myapp</code> , which allows you to connect the console to a working daemon for introspecting the state and changing the code on the fly.  Also via <code>box.cfg({listen = 3313 })</code> you can open the network port for connecting with connectors from other programming languages ‚Äã‚Äãand frameworks (we promised you that we would not break the whole world order!). <br><br><h1>  What next? </h1><br>  In the next series, we will describe in more detail how to ensure the modular architecture of your application, organize testing and continuous integration of code.  The secret know-how to prepare the Tarantula for processing up to 6M requests per second on a single physical core will also be revealed. <br><br>  We are waiting for questions and comments. <br><br>  Z. Y.  On January 28, we will hold the second Tarantool Meetup at the <a href="http://www.the-village.ru/village/city/interior/137211-ofis-nedeli">super-modern</a> office of the Mail.Ru Group at <a href="https://corp.mail.ru/ru/company/contacts/">Airport</a> .  At the meeting there will be new insights from both our team and external users of the Tarantula.  Admission is free after <a href="https://corp.mail.ru/ru/press/events/149/">registration</a> , all nishtyaki included.  You have a good mood and desire to try Tarantool in your projects. </div><p>Source: <a href="https://habr.com/ru/post/272669/">https://habr.com/ru/post/272669/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272655/index.html">How we taught 1C to generate an IVR menu for Asterisk</a></li>
<li><a href="../272657/index.html">Architecture IoT-solutions on a real example</a></li>
<li><a href="../272659/index.html">Next, in search of palindromes 3</a></li>
<li><a href="../272661/index.html">NOT unlimited mailbox, or Tale about the secret limitation of Mail.ru</a></li>
<li><a href="../272667/index.html">Practice: How to set up an HP ProLiant ML10v2 server and prepare it for OS installation</a></li>
<li><a href="../272671/index.html">ICQ mobile application design contest</a></li>
<li><a href="../272673/index.html">Shadows of the characters in the video The Blacksmith</a></li>
<li><a href="../272675/index.html">PostgreSQL Designing a Document-Oriented API: Comprehensive Queries (Part 4)</a></li>
<li><a href="../272677/index.html">Perl5 plugin for IntelliJ IDEA v1.2: Moose and Signatures</a></li>
<li><a href="../272679/index.html">Neural network in Python, part 2: gradient descent</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>