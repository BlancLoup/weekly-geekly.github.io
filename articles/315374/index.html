<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Where in Java problems with encodings and the possible reason of falling of a Martian probe emerge</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The planet Mars is not the first year inhabited by robots. Here and there unmanned electric vehicles and flying drones appear, and in programs written...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Where in Java problems with encodings and the possible reason of falling of a Martian probe emerge</h1><div class="post__text post__text-html js-mediator-article">  The planet Mars is not the first year inhabited by robots.  Here and there unmanned electric vehicles and flying drones appear, and in programs written in Java, problems with encodings appear with enviable regularity. <br><br>  I want to share my thoughts on why this is happening. <br><a name="habracut"></a><br>  Suppose we have a file that stores the text we need.  To work with this text in Java, we need to drive the data into a String.  How to do it? <br><br><div class="spoiler">  <b class="spoiler_title">readFile</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileName, String encoding)</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; InputStream inputStream = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Reader reader = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { inputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(fileName); reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(inputStream, encoding); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = reader.read(buf); i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i = reader.read(buf)) { out.append(buf, <span class="hljs-number"><span class="hljs-number">0</span></span>, i); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FileNotFoundException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (UnsupportedEncodingException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { reader.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inputStream != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { inputStream.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } } String result = out.toString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br></div></div><br>  Please note that reading a file is not enough just to know its name.  You also need to know in which encoding it contains the data.  The binary representation of characters in the memory of a Java machine and in a file on a hard disk almost never coincides, so you cannot simply take and copy data from a file into a string.  First you need to get a sequence of bytes, and only then convert to a sequence of characters.  In the example above, the class InputStreamReader does this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The code is quite cumbersome, despite the fact that the need to convert from bytes to characters and back occurs very often.  In this regard, it would be logical to provide the developer with auxiliary functions and classes that facilitate the work on recoding.  What did the Java developers do for this?  They have introduced functions that do not require encoding.  For example, the class InputStreamReader has a constructor with one parameter of type InputStream. <br><br><div class="spoiler">  <b class="spoiler_title">readFile</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileName)</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[<span class="hljs-number"><span class="hljs-number">1024</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ( InputStream inputStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(fileName); Reader reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(inputStream); ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = reader.read(buf); i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i = reader.read(buf)) { out.append(buf, <span class="hljs-number"><span class="hljs-number">0</span></span>, i); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FileNotFoundException e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } String result = out.toString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br></div></div><br>  It became a little easier.  But here, Java developers have buried a serious rake.  They used the so-called ‚Äú <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/charset/Charset.html">default character encoding</a> ‚Äù as the encoding for data conversion. <br><br>  The default charset is installed by the Java machine once at the start based on data taken from the operating system and is stored for informational purposes in the file.encoding system property.  In this regard, the following problems arise. <br><br><ol><li>  The default encoding is a global parameter.  It is impossible to set one encoding for some classes or functions, and another encoding for others. </li><li>  The default encoding cannot be changed during program execution. </li><li>  The default encoding depends on the environment, so you cannot know in advance what it will be. </li><li>  The behavior of methods depending on the default encoding cannot be reliably covered with tests, because there are a lot of encodings and their set of values ‚Äã‚Äãcan be extended.  Any new OS with UTF-48 type encoding may come out, and all tests on it will be useless. </li><li>  When errors occur, you have to analyze more code to find out which particular encoding a particular function used. </li><li>  The behavior of the JVM in the event of a change in the environment after the start becomes unpredictable. </li></ol><br>  But the main thing is that an important aspect of the program‚Äôs work is hidden from the developer, and he may simply not notice that he used a function that will work differently in different environments.  The FileReader class does not contain any functions that allow you to specify the encoding, although the class itself is logical and convenient, so it encourages the user to create platform-specific code. <br><br>  Because of this, amazing things happen.  For example, a program may incorrectly open a file that it itself has previously created. <br><br>  Or, say, we have an XML file that has encoding = ‚ÄúUTF-8‚Äù written in the header, but in a Java program this file is opened using the FileReader class, and hello.  Somewhere will open normally, but somewhere not. <br><br>  The problem file.encoding manifests itself especially vividly in Windows.  In it, Java uses the ANSI encoding as the default encoding, which for Russia is equal to Cp1251.  Windows itself says that "this parameter sets the language for displaying text in programs that do not support Unicode."  What does Java have to do here, which was originally conceived for full Unicode support, is unclear, because for Windows, the native encoding is UTF-16LE, starting somewhere with Windows 95, 3 years before the release of 1st Java. <br><br>  So if you saved a file on your computer using your Java program and sent it to your colleague in Europe, the recipient may not be able to open it using the same program, even if the operating system version is the same as yours .  And when you move from Windows to Mac or Linux, then you can not read your own files. <br><br>  But there is still a Windows console that works in OEM-coding.  We all watched how, up to Java 1.7, any output of Russian text in a black window using System.out produced crocodiles.  This is also the result of using functions based on default character encoding. <br><br>  I solve the problem of encodings in Java as follows: <br><br><ol><li>  I always run Java with the -Dfile.encoding = UTF-8 option.  This allows you to remove the dependence on the environment, makes the behavior of the programs deterministic and compatible with most operating systems. </li><li>  When testing my programs, I definitely do tests with non-standard (incompatible with ASCII) encoding by default.  This allows you to catch libraries that use classes like FileReader.  When I find such libraries, I try not to use them, because, firstly, there will be problems with encodings, and secondly, the quality of the code in such libraries is seriously in doubt.  I usually run java with the -Dfile.encoding = UTF-32BE option to be sure. </li></ol><br>  This does not provide an absolute guarantee against problems, because there are also launchers who run Java in a separate process with the parameters that they consider necessary.  For example, many plugins to Antu did this.  The ant itself worked with file.encoding = UTF-8, but some code generator called by the plugin worked with the default encoding, and the usual porridge from different encodings was obtained. <br><br>  In theory, over time, the code should become better, the programs more reliable, the formats more standardized.  However, this does not happen.  Instead, there is a surge of errors with encodings in Java programs.  Apparently, this is due to the fact that people who are not used to solving the problem of encodings immigrated to the Java world.  For example, in C #, <a href="https://msdn.microsoft.com/en-us/library/system.io.streamreader.aspx">UTF-8 encoding</a> is used by default, so a developer who has moved from C #, quite reasonably believes that InputStreamReader by default uses the same encoding, and does not go into the details of its implementation. <br><br>  Recently stumbled upon a similar <a href="https://issues.apache.org/jira/browse/FELIX-5345">error in the maven-scr-plugin</a> . <br><br>  But the real surprise had to experience when moving to eight.  Tests have shown that the problem with the encoding was getting lost in the <a href="http://bugs.java.com/bugdatabase/view_bug.do%3Fbug_id%3DJDK-8169693">JDK</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Bug in JDK 8</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.charset.Charset; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.charset.StandardCharsets; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.crypto.Cipher; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PemEncodingBugDemo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String str = <span class="hljs-string"><span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ012345467890\r\n /=+-"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ascii[] = str.getBytes(StandardCharsets.US_ASCII); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> current[] = str.getBytes(Charset.defaultCharset()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Arrays.equals(ascii, current)) { System.err.printf(<span class="hljs-string"><span class="hljs-string">"Run this test with non-ascii native encoding,%n"</span></span>); System.err.printf(<span class="hljs-string"><span class="hljs-string">"for example java -Dfile.encoding=UTF-16%n"</span></span>); } Cipher.getInstance(<span class="hljs-string"><span class="hljs-string">"RC4"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Throwable e) { e.printStackTrace(); } } }</code> </pre><br></div></div><br>  On the nine it is not reproduced, apparently, they have already repaired it. <br><br>  Searching through the error database, I found another recently closed <a href="https://bugs.openjdk.java.net/browse/JDK-8160267">error</a> related to the same functions.  And characteristically, they even fix is ‚Äã‚Äãnot quite right.  Colleagues forget that for standard encodings, starting with Java 7, you should use constants from the <a href="https://docs.oracle.com/javase/8/docs/api/java/nio/charset/StandardCharsets.html">StandardCharsets</a> class.  So ahead, unfortunately, we are still waiting for a lot of surprises. <br><br>  Running grep on the JDK source, I found dozens of places where platform-specific functions are used.  All of them will work incorrectly in an environment where the native encoding is incompatible with ASCII.  For example, the Currency class, although it would seem that this class should take into account all aspects of localization. <br><br>  When some functions begin to create problems, and there is an adequate alternative for them, it has long been known what to do.  It is necessary to mark these functions as outdated and indicate what they should be replaced.  This is a well-proven mechanism of deprecation, which even plan <a href="http://openjdk.java.net/jeps/277">to develop</a> . <br><br>  I believe that functions that depend on the default encoding should be outdated, especially since there are not so many of them: <br><br><table><tbody><tr><th>  Function </th><th>  What to replace </th></tr><tr><td>  Charset.defaultCharset () </td><td>  remove </td></tr><tr><td>  FileReader.FileReader (String) </td><td>  FileReader.FileReader (String, Charset) </td></tr><tr><td>  FileReader.FileReader (File) </td><td>  FileReader.FileReader (File, Charset) </td></tr><tr><td>  FileReader.FileReader (FileDescriptor) </td><td>  FileReader.FileReader (FileDescriptor, Charset) </td></tr><tr><td>  InputStreamReader.InputStreamReader (InputStream) </td><td>  InputStreamReader.InputStreamReader (InputStream, Charset) </td></tr><tr><td>  FileWriter.FileWriter (String) </td><td>  FileWriter.FileWriter (String, Charset) </td></tr><tr><td>  FileWriter.FileWriter (String, boolean) </td><td>  FileWriter.FileWriter (String, boolean, Charset) </td></tr><tr><td>  FileWriter.FileWriter (File) </td><td>  FileWriter.FileWriter (File, Charset) </td></tr><tr><td>  FileWriter.FileWriter (File, boolean) </td><td>  FileWriter.FileWriter (File, boolean, Charset) </td></tr><tr><td>  FileWriter.FileWriter (FileDescriptor) </td><td>  FileWriter.FileWriter (FileDescriptor, Charset) </td></tr><tr><td>  OutputStreamWriter.OutputStreamWriter (OutputStream) </td><td>  OutputStreamWriter.OutputStreamWriter (OutputStream, Charset) </td></tr><tr><td>  String.String (byte []) </td><td>  String.String (byte [], Charset) </td></tr><tr><td>  String.String (byte [], int, int) </td><td>  String.String (byte [], int, int, Charset) </td></tr><tr><td>  String.getBytes () </td><td>  String.getBytes (Charset) </td></tr></tbody></table><br><div class="spoiler">  <b class="spoiler_title">I almost forgot</b> <div class="spoiler_text">  Yes, and what about the spacecraft on Mars? <br><br>  Part of the software for the Martian probe Schiaparelli was written in Java, on the current version 1.7 at that time.  Launched the product in the spring, and the path to the destination was six months.  While he was flying, the JDK was updated at the European Space Agency. <br><br>  So what?  Software development for the current mission has been completed, software must be done for the next one, and we are still sitting on the seven.  NASA and Roskosmos have already moved to the eight for a long time, and then there are lambdas, streams, default interface methods, a new garbage collector, and in general. <br><br>  They were updated and, before landing, they sent a control command to the spacecraft not in the encoding in which he had expected. <br><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/315374/">https://habr.com/ru/post/315374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315360/index.html">With a small or large</a></li>
<li><a href="../315362/index.html">Attack of the BlackNurse: How to disable the firewall using a laptop and ICMP</a></li>
<li><a href="../315366/index.html">Replacing the help desk system. 8 universal tips on how to sabotage migration to a new solution</a></li>
<li><a href="../315368/index.html">Not ‚ÄúTanks‚Äù as one - we miss with benefit in DIY style</a></li>
<li><a href="../315370/index.html">Fast testing of 3CX for Linux on Oracle Virtualbox</a></li>
<li><a href="../315376/index.html">The vulnerability of Cryptsetup initialization scripts in Debian: just enough to hold Enter</a></li>
<li><a href="../315378/index.html">Vulnerability of old Ubuntu through an audio file played by 1975 processor emulation</a></li>
<li><a href="../315382/index.html">GraphQL CMS, the second version is already publicly available.</a></li>
<li><a href="../315384/index.html">Class for editing configuration files</a></li>
<li><a href="../315388/index.html">Hacker Record: Albert Gonzalez. 20 years in prison and 170 million stolen credit cards</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>