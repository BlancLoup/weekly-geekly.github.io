<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating an emulator arcade machine. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing an arcade emulator is a great learning project, and in this tutorial we will look at the whole development process in great detail. Want to re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating an emulator arcade machine. Part 1</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6eb/735/b99/6eb735b9990860a94f9ef0a18ba46a82.jpg" alt="image"></div><br>  Writing an arcade emulator is a great learning project, and in this tutorial we will look at the whole development process in great detail.  Want to really understand the processor?  Then creating an emulator is the best way to learn it. <br><br>  You will need knowledge of C, as well as knowledge of assembly language.  If you do not know assembly language, then writing an emulator is the best way to master it.  You will also need to learn hexadecimal math (also known as base 16 or just ‚Äúhex‚Äù).  I will tell about this topic. <br><br>  I decided to choose the Space Invaders machine emulator, which uses an 8080 processor. This game and this processor are very popular, so you can find a lot of information about them on the Internet.  To complete the project you will need it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All tutorial source code is uploaded to <a href="http://github.com/kpmiller/emulator101">github</a> .  If you have not mastered working with git, then on the github page there is a ‚ÄúDownload ZIP‚Äù button that allows you to download an archive with all the code. <br><a name="habracut"></a><br><h1>  Introduction to Binary and Hexadecimal Numbers </h1><br>  In the "ordinary" mathematics uses the decimal number system.  Each digit of a number can have a value from zero to nine, and when we exceed 9, we add one to the number in the next digit and start again from zero.  It's all quite simple and straightforward, and you probably never thought about it. <br><br>  You may know or have heard that computers work with binary data.  Computer geeks call decimal mathematics base-10, and binary ones are called base-2.  In binary terms, each digit of a number can have only two values, zero or one.  In binary code, the counting is as follows: 0, 1, 10, 11, 100, 101, 110, 111, 1000. These are not decimal numbers, so you cannot call them ‚Äúzero, one, ten, eleven, one hundred, one hundred one‚Äù.  They are pronounced ‚Äúzero, one, one-zero, one-one, one-zero-zero‚Äù, etc.  I rarely read binary numbers out loud, but if necessary, I need to clearly indicate the number system used.  Ten, eleven and one hundred have no meaning in binary. <br><br>  In decimal, the number has the following digits: units, tens, hundreds, thousands, tens of thousands, etc.  In the binary system, the following digits: units, twos, fours, eights, etc.  <strong>In computer science, the value of each binary digit is called a bit.</strong>  <strong>8 bits are one byte.</strong> <br><br>  In binary terms, the string of numbers quickly becomes very long.  To represent a decimal number of 20,000 in binary terms, 16 digits are required: 0b100111000100000.  To eliminate this problem, it is convenient to use hexadecimal notation, also known as base-16 (or hex).  In base-16, each digit contains 16 values.  For values ‚Äã‚Äãfrom zero to nine, the same symbols are used as in base-10, but for the remaining 6 values, substitutions are used in the form of the first 6 letters of the alphabet, from A to F. <br><br>  The counting in the hexadecimal system is performed as follows: 0 1 2 3 4 5 6 7 8 9 ABCDEF 10 11 12, etc.  In hexadecimal dozens, hundreds and so on do not have the same meaning as in decimal, so people pronounce the numbers separately.  For example, $ A57 is pronounced out loud as "A-five-seven."  For clarity, you can also add hex, for example ‚ÄúA-five-seven-hex‚Äù.  In hexadecimal, the analogue of the decimal number 20,000 is $ 4E20, a much more compact form compared to the 16 bits of the binary system. <br><br>  I think the hexadecimal system was chosen because of the very natural conversion from binary to hexadecimal and back.  Each hex digit corresponds to 4 bits (4 bits) of the same binary number.  <strong>2 hex digits are one byte (8 bits).</strong>  A separate hexadecimal digit can be called a nibble, and some people even write it through y, as ‚Äúnybble‚Äù. <br><br><table><tbody><tr><th colspan="4">  Each hex digit is 4 binary digits. </th></tr><tr><td>  Hex </td><td>  A </td><td>  five </td><td>  7 </td></tr><tr><td>  Binary </td><td>  1010 </td><td>  0101 </td><td>  0111 </td></tr></tbody></table><br>  When writing C code, it is considered that the number is decimal (base-10), unless it is marked otherwise.  To tell the C compiler that the number is binary, we add the number zero and the letter b in lower case, like this: <code>0b1101101</code> .  A hexadecimal number can be written in C code by adding a zero at the beginning and a lowercase x: <code>0xA57</code> .  In some assembly languages, the dollar sign $: <code>$A57</code> used to designate hex numbers. <br><br>  If you think about it, the connection between binary, hexadecimal, and decimal numbers is quite obvious, but with the first engineer, who had thought of this before the invention of the computer, this was supposed to be a moment of insight. <br><br>  Got it all?  Fine. <br><br><h1>  Brief introduction to the processor </h1><br>  <em>If you already know this, you can safely skip the section.</em> <br><br>  The central processing unit (CPU, CPU) is a machine designed to run programs.  The fundamental blocks of the CPU are registers and instructions.  As a software developer, you can treat these registers as variables.  In our processor 8080, among other registers, there are 8-bit registers called A, B, C, D and E. You can take these registers as the following code in C: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> A, B, C, D, E;</code> </pre> <br>  All processors also have a program counter (Program Counter, PC).  You can take it as a pointer. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* pc;</code> </pre> <br>  For a CPU, a program is a sequence of hexadecimal numbers.  Each assembly language command in 8080 corresponds to 1-3 bytes in the program.  In order to find out which team corresponds to which number, a handbook on the processor (or any other information about the 8080 processor from the Internet) is useful. <br><br>  Names of commands (instructions) are often mnemonics from operations performed by these commands.  The mnemonic for loading in 8080 is MOV (move), and ADD is used to perform addition. <br><br><h4>  Examples </h4><br>  The current value of the memory pointed to by the command counter is 0x79.  This corresponds to the <code>MOV A,C</code> instruction of the 8080 processor. This assembly code in the C code looks like <code>A=C;</code>  . <br><br>  If instead the value in the PC would be 0x80, then the processor would execute <code>ADD B</code>  In C, this corresponds to the string <code>A = A + B;</code>  . <br><br>  A complete list of 8080 processor commands can be found <a href="http://www.emulator101.com/reference/8080-by-opcode.html">here</a> .  To implement our emulator, we will use this information. <br><br><h4>  Timings </h4><br>  In the CPU, each instruction takes a certain amount of time (timing), measured in cycles.  In modern processors, this information can be difficult to obtain, because the timings depend on many different aspects.  But in old processors like 8080, the timings are constant and this information is often provided by the processor manufacturer.  For example, the transfer instruction from register to register MOV takes 1 cycle. <br><br>  Information about timings is useful for writing efficient code in the processor.  A programmer may strive to avoid instructions that take many cycles to execute. <br><br>  More important for us is that we use information about timings to emulate a processor.  In order for the game to work in the same way as on the original, the instructions must be executed at the correct speed.  Some emulators put a lot of effort into this, but when we get there, we‚Äôll have to decide what accuracy we want. <br><br><h1>  Logical operations </h1><br>  Before we close the topic of binary and hexadecimal numbers, we should talk about logical operations.  Probably, you are already used to using logic in code, for example, in such constructions as <code>if ((conditionA) and (conditionB))</code> .  In programs that work directly with hardware, you often have to manipulate individual bits of numbers. <br><br><h3>  AND operation (AND) </h3><br>  Here are all the possible results of the AND (AND) operation (truth table) between two single-bit numbers. <br><br><table><tbody><tr><td>  x </td><td>  y </td><td>  Result </td></tr><tr><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0 </td><td>  one </td><td>  0 </td></tr><tr><td>  one </td><td>  0 </td><td>  0 </td></tr><tr><td>  one </td><td>  one </td><td>  one </td></tr></tbody></table><br>  The result of AND is equal to one only when both values ‚Äã‚Äãare equal to one.  When we combine two numbers with the AND operation, for each bit of one number, AND is executed with the corresponding bit of the other number.  The result is stored in this bit of the receiver number.  Probably better just look at an example: <br><br><table><tbody><tr><td></td><td colspan="8">  binary </td><td>  hex </td></tr><tr><td>  source x </td><td>  0 </td><td>  one </td><td>  one </td><td>  0 </td><td>  one </td><td>  0 </td><td>  one </td><td>  one </td><td>  $ 6B </td></tr><tr><td>  source y </td><td>  one </td><td>  one </td><td>  0 </td><td>  one </td><td>  0 </td><td>  0 </td><td>  one </td><td>  0 </td><td>  $ D2 </td></tr><tr><td>  x AND y </td><td>  0 </td><td>  one </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  one </td><td>  0 </td><td>  $ 42 </td></tr></tbody></table><br>  In C, the logical AND operation is a simple ampersand "&amp;". <br><br><h3>  OR operation (OR) </h3><br>  The OR operation works in a similar way.  The only difference is that the result will be equal to one if at least one of the values ‚Äã‚Äãof x or y is equal to one. <br><br><table><tbody><tr><td>  x </td><td>  y </td><td>  Result </td></tr><tr><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  0 </td><td>  one </td><td>  one </td></tr><tr><td>  one </td><td>  0 </td><td>  one </td></tr><tr><td>  one </td><td>  one </td><td>  one </td></tr></tbody></table><br><table><tbody><tr><td></td><td colspan="8">  binary </td><td>  hex </td></tr><tr><td>  source x </td><td>  0 </td><td>  one </td><td>  one </td><td>  0 </td><td>  one </td><td>  0 </td><td>  one </td><td>  one </td><td>  $ 6B </td></tr><tr><td>  source y </td><td>  one </td><td>  one </td><td>  0 </td><td>  one </td><td>  0 </td><td>  0 </td><td>  one </td><td>  0 </td><td>  $ D2 </td></tr><tr><td>  x or y </td><td>  one </td><td>  one </td><td>  one </td><td>  one </td><td>  one </td><td>  0 </td><td>  one </td><td>  one </td><td>  $ Fb </td></tr></tbody></table><br>  In C, the logical OR operation is indicated by a vertical bar "|". <br><br><h3>  Why is it important? </h3><br>  In many old processors, and especially in arcade machines, the game often requires working with only one bit of the number.  Often there is a similar code: <br><br><pre> <code class="cpp hljs"> <span class="hljs-comment"><span class="hljs-comment">/*  1:     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buttons_ptr = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)<span class="hljs-number"><span class="hljs-number">0x2043</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buttons = *buttons_ptr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buttons &amp; <span class="hljs-number"><span class="hljs-number">0x4</span></span>) HandleLeftButton(); <span class="hljs-comment"><span class="hljs-comment">/*  2:  LED-    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * LED_pointer = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *) <span class="hljs-number"><span class="hljs-number">0x2089</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> led = *LED_pointer; led = led | <span class="hljs-number"><span class="hljs-number">0x40</span></span>; <span class="hljs-comment"><span class="hljs-comment">//,  LED   6 *LED_pointer = led; /*  3:   LED- */ char * LED_pointer = (char *) 0x2089; char led = *LED_pointer; led = led &amp; 0xBF; //  6 *LED_pointer = led;</span></span></code> </pre> <br>  In example 1, the memory address of $ 2043 is the address of the buttons on the control panel.  This code reads and responds to the pressed button.  (Of course, in Space Invaders this code will be in assembly language!) <br><br>  In example 2, the game wants to light up the LED indicator, which is located in bit 6 of the $ 2089 distributed memory address.  The code should read the already existing value, change only one bit, and write it back. <br><br>  In example 3, you need to disable the indicator from example 2, so the code should reset bit 6 of the address $ 2089.  This can be done by performing the AND operation with a value for which the indicator control byte has only bit 6. Thus, we will affect only 6, leaving the remaining bits unchanged. <br><br>  This is usually called a ‚Äúmask.‚Äù  In C, the mask is usually written using the NOT operator denoted by a tilde ("~").  Therefore, instead of writing <code>0xBF</code> , I will simply write down <code>~0x40</code> and get the same number, but without investing much effort. <br><br><h1>  Introduction to Assembly Language </h1><br>  If you are reading this tutorial, you are probably familiar with computer programming, for example, in Java or Python.  These languages ‚Äã‚Äãallow you to do a lot of work in just a few lines of code.  The code is considered to be cleverly written if it performs as much work as possible in as few lines as possible, perhaps even with the help of built-in library functionality.  Such languages ‚Äã‚Äãare called high-level languages. <br><br>  In assembly language, on the other hand, there are no built-in life-simplifying capabilities, and simple tasks may require many lines of code.  Assembly language is considered a low level language.  In it, you have more to get used to thinking in the style of "what specific sequence of steps must be done to accomplish this task?" <br><br>  The most important thing to know about assembly language is that each line is translated into one processor command. <br><br>  Consider the following construction from the C language: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = b + <span class="hljs-number"><span class="hljs-number">100</span></span>;</code> </pre> <br>  In assembly language, this task will have to be performed in the following sequence: <br><br><ol><li>  Load the address of variable B into register 1 </li><li>  Load the contents of this memory address into register 2 </li><li>  Add immediate value 0x64 to register 2 </li><li>  Load variable address A into register 1 </li><li>  Write the contents of register 2 to the address stored in register 1 </li></ol><br>  In the code, it will look something like this: <br><br><pre> <code class="hljs pgsql"> lea a1, #<span class="hljs-meta"><span class="hljs-meta">$1000</span></span> ;   a lea a2, #<span class="hljs-meta"><span class="hljs-meta">$1008</span></span> ;   b <span class="hljs-keyword"><span class="hljs-keyword">move</span></span>.l d0,(a2) <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>.l d0, #<span class="hljs-meta"><span class="hljs-meta">$64</span></span> mov (a1),d0</code> </pre> <br>  It is worth noting the following: <br><br><ul><li>  In a high-level language, the compiler decides for itself where to place variables in memory.  When writing code in assembler, you yourself are responsible for each memory address you will use. </li><li>  In most assembly languages, brackets mean "memory at this address." </li><li>  In most assembly languages, # denotes an algebraic number, also called an immediate value.  For example, in line 1 of the example above, the code actually writes the value # 0x1000 to register a1.  If the code looked like <code>move.l a1, ($1000)</code> , then a1 would get the contents of the memory at 0x1000. </li><li>  Each processor has its own assembly language, and it can be difficult to transfer code from one processor to another. </li><li>  This is not a real processor assembler language, I came up with it for an example. </li></ul><br>  However, there is one similar trait between high level smart programmers and assembler masters.  Assembly language programmers consider it their honor to complete the task as efficiently as possible and minimize the number of commands used.  The code for arcade machines is usually highly optimized, and all juices are squeezed out of each extra byte and cycle. <br><br><h1>  Stacks </h1><br>  Let's talk a little more about assembly language.  In any rather complex computer program in assembler, subroutines are used.  In most CPUs, there is a structure called the stack. <br><br>  Imagine a stack in the form of a stack.  If we need to save a number, we put it on the top of the stack.  When we need to return it back, we take it from the top of the pile.  Assembly language programmers call writing a number onto the stack ‚Äúpush‚Äù, and extracting a number using pop. <br><br>  Suppose my program needs to call a subroutine.  I can write similar code: <br><br><pre> <code class="hljs css"> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">d0</span></span> ;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">d0</span></span>   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1004</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> ;     0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1008</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">d1</span></span> ;  <span class="hljs-selector-tag"><span class="hljs-selector-tag">d1</span></span>   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1010</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> ;  .. 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1014</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">a0</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1018</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x101C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1020</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1024</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>), <span class="hljs-selector-id"><span class="hljs-selector-id">#0x1030</span></span> ;   0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1028</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x102C</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-id"><span class="hljs-selector-id">#0x2040</span></span> ;   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x2040</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1030</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span>, (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>) ;    0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1034</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span> ;    0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x1038</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">move</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a0</span></span>, (<span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>) ;    0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x103c</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.l</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sp</span></span>, <span class="hljs-selector-id"><span class="hljs-selector-id">#4</span></span>  ..</code> </pre> <br>  The code shown above writes d0, d1, a0, and a1 to the stack.  Most processors use a stack pointer.  This can be a regular register, by convention used as a stack pointer, or a special register with functions for certain instructions. <br><br>  In 68K series processors, the stack pointer is determined only by agreement; otherwise, this is an ordinary register.  In our 8080 processor, the SP register is a special register.  He has PUSH and POP commands that write and eject from the stack in just one command. <br><br>  In our emulator project, we will not write code from scratch.  But if you need to analyze programs in assembly language, then it is good to learn how to recognize such constructs. <br><br><h4>  High level languages </h4><br>  When writing a program in a high-level language, all operations of saving and restoring registers are performed at each function call.  We don‚Äôt think about them, because the compiler deals with them.  Calling functions in a high-level language can take a lot of memory and CPU time. <br><br>  Have you ever had a program crash when calling a subroutine in an infinite loop?  This can occur because each function call pushes the values ‚Äã‚Äãof the registers onto the stack, and at some point the stack runs out of memory.  (If the stack grows too large, this is called a stack overflow, or stack overflow.) <br><br>  You may have heard about inline functions.  They allow you to avoid saving and restoring registers by including the code of the subroutine in the calling function.  The code becomes larger at the same time, but this saves several commands and read / write operations into memory. <br><br><h4>  Calling conventions </h4><br>  When writing a program in assembly language that calls only your code, you can decide for yourself how the subroutines will communicate with each other.  For example, how do I return to the calling function after the subroutine is completed?  One way is to write the return address to a specific register.  Another is to place the return address at the top of the stack.  Very often, the decision depends on what the processor supports.  The 8080 has a CALL command that populates the return address of a function.  You may use this 8080 command to implement subroutine calls. <br><br>  We need to take one more decision.  Is register saving the responsibility of the calling function or subroutine?  In the example shown above, the registers are saved by the calling function.  But what if we have 32 registers?  Saving and restoring 32 registers when the subroutine uses only a small part of them will be a waste of time. <br><br>  Compromise can be a mixed approach.  Suppose we have chosen a policy in which the subroutine can use the registers r10-r32 without saving their contents, but cannot destroy r1-r9.  In this situation, the calling function knows the following: <br><br><ul><li>  When returning from a function, the contents of r1-r9 will remain unchanged. </li><li>  I can not depend on the contents of r10-r32 </li><li>  If I need a value in r10-r32 after calling a subroutine, then before calling it I need to save it somewhere </li></ul><br>  Likewise, each subroutine knows the following: <br><br><ul><li>  I can destroy r10-r32 </li><li>  If I want to use r1-r9, then I need to save the contents and restore it before returning to the function that called me. </li></ul><br><h4>  ABI </h4><br>  On most modern platforms, such policies are created by engineers and published in documents called ABI (Application Binary Interface).  Thanks to this document compiler creators know how to compile code that can invoke code compiled by other compilers.  If you want to write an assembler code that can function in a similar environment, then you need to know the ABI and write the code in accordance with it. <br><br>  ABI knowledge also helps in debugging code when you do not have access to the source code.  ABI defines the locations of parameters for functions, so when you look at any subroutine, you can examine these addresses to understand what is being passed to functions. <br><br><h4>  We return to the emulator </h4><br>  Most of the hand-written assembly code, especially for older processors and arcade games, does not follow ABI.  Programs are coded in assembler and there may not be many subroutines.  Each routine saves and restores registers only when absolutely necessary. <br><br>  If you want to understand what the program is doing, it would be nice to start by marking the addresses that are the target for the CALL commands. </div><p>Source: <a href="https://habr.com/ru/post/418635/">https://habr.com/ru/post/418635/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418625/index.html">Andy Grove's Secret Call That Helped Apple Buy NeXT</a></li>
<li><a href="../418627/index.html">More about methods for solving systems of linear algebraic equations</a></li>
<li><a href="../418629/index.html">How to independently verify whether you can patent your product and conduct a patent search</a></li>
<li><a href="../418631/index.html">7 recommendations on the design of the JavaScript code</a></li>
<li><a href="../418633/index.html">Reactivity in JavaScript: a simple and clear example</a></li>
<li><a href="../418637/index.html">Kubernetes to the masses: Slurm starts on August 3</a></li>
<li><a href="../418639/index.html">Akka Streams for mere mortals</a></li>
<li><a href="../418641/index.html">A mistake that prevents a designer from growing</a></li>
<li><a href="../418645/index.html">Reports from the spring conference C ++ Russia 2018</a></li>
<li><a href="../418649/index.html">Constant generation of alternative versions of TLS will solve the problem of the ‚Äúossification‚Äù of the old protocol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>