<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Disassemble and reassemble the USB stack</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Illustrated projection of the OSI network interconnection model on a universal serial bus. 

 Three "wonderful" levels of the USB stack 
 I was not sa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Disassemble and reassemble the USB stack</h1><div class="post__text post__text-html js-mediator-article">  Illustrated projection of the OSI network interconnection model on a universal serial bus. <br><br><h4>  Three "wonderful" levels of the USB stack </h4><br>  I was not satisfied with the view of the USB stack, which can be found most often in the network: <br><br><div class="spoiler">  <b class="spoiler_title">Not very useful USB stack</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/66f/c9d/723/66fc9d723cd447e68fa0eec627a0ea98.gif"></div></div><br>  Bus level, logical, functional ... These, of course, are wonderful abstractions, but they are more likely for those who are going to make a driver or application software for a host.  On the side of the microcontroller, I expect a sample state machine, in the nodes of which we usually embed our useful code, and it will first be buggy according to all the laws of the genre.  Or the software on a host will be buggy.  Or a driver.  In any case, someone will fail.  In libraries MK, too, with a swoop can not figure out.  And here I look at the traffic on the USB bus with the analyzer, where the events in an unfamiliar language with three remarkable levels do not tally at all.  Interestingly, is it in my mind from the flu fever in my head that dissonance? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If the reader had similar feelings, I suggest an alternative vision of the USB stack, which came to me unexpectedly clearly in an overheated brain, based on the favorite 7-level OSI model.  I limited myself to five levels: <br><br><img src="https://habrastorage.org/files/598/dd0/64f/598dd064f07e4cad8b252f57e31b44d7.png"><br><br>  I do not want to say that all software and libraries have already been made or should be designed on the basis of this model.  For engineering reasons, the code with levels will be strongly mixed.  But I want to help those who are starting their acquaintance with the USB bus, who want to understand device exchange protocols and subject area terminology, get closer to ready-made examples, libraries, and better navigate them.  This model is not for download in the MK, but in your brilliant minds, dear friends.  And then your golden hands will do everything themselves, I have no doubt :) <br><a name="habracut"></a><br>  So, go, correct, if you see the shoals.  This is a draft version, and if it has already been drawn somewhere, I ask you to forgive, I did not find it and therefore I tied it myself.  I think the picture will not run away, but for the time being I will explain to the venerable public why I even took up this publication. <br><br><div class="spoiler">  <b class="spoiler_title">Regular Flashback from the Nineties</b> <div class="spoiler_text">  I shook out my first bug out of someone else‚Äôs code in the late nineties, when I was a student in a part-time job.  It was pppd under FreeBSD, which we then screwed onto a modem pool.  Motorol modems stuck in the end, nobody could get through, the line disappeared in vain, and for some reason, the only remaining way through PPP keep-alive was buggy.  That's when I found out that pppd is for some reason waiting for six LCP bytes instead of four ones.  Then I felt myself a kind of dashing <i>zhukotryas</i> from the nineties :-) What does the PPP have to do with it?  It just looks like USB: batch and point-to-point.  True, unlike USB 2.0, full duplex. </div></div><br>  Whether we like it or not, the evolution of microcontrollers is clearly not going to stand in place.  No, no, yes, and there is a glimpse in publications ( <a href="http://habrahabr.ru/post/208026/">http://habrahabr.ru/post/208026/</a> , <a href="http://habrahabr.ru/post/233391/">http://habrahabr.ru/post/233391/</a> ) "heavy peripherals" - mounted on the USB implementation bus, with parsing examples, using HID, etc.  We must pay tribute to the author of <a href="https://habrahabr.ru/users/raja/" class="user_link">RaJa</a> : out of eight examples given in the standard library <a href="http://www.st.com/web/en/catalog/tools/PF258157">STSW-STM32121 (UM0424)</a> and somehow <a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/user_manual/CD00158241.pdf">documented</a> , he chose the most useful (Custom HID), ported it into a free environment Em :: Blocks, outlined in understandable language, a little embellished, bravo!  It saved me a lot of time. <br><br><h4>  How do I get to the library? </h4><br>  Having received on the GitHub the project <a href="https://github.com/RavWin/RHIDDemo">RHIDDemo</a> for Em :: Blocks, kindly laid out by the author, I started porting it to Keil (my FTDI-based CoLink debugger; somebody, tell me the Coocox plugin for Em :: Blocks).  But he could not understand in any way: where the hell did the author get the SPL 3.6.1 release of 2012, if the site has 3.5.0 of 2011?  I went through a rather boring quest, which to my surprise led ... directly to the finished Custom HID project for Keil as part of the USB FS 4.0.0 library.  Lies in public view, like a mouse under a broom.  Well, okay.  But I finally lit up the releases of STMicroelectronics, found the description of the USB FS library <a href="http://www.st.com/web/en/catalog/tools/PF258157">STSW-STM32121 (UM0424)</a> and stopped the attempts of the developer to drive me crazy.  Tell me, is it okay to put a vintage CMSIS 1.30 of the sample of 2009 into the SPL 3.5.0 set of the release of 2011, the new SPL 3.6.1 of the release of 2012 to hide in USB-FS 4.0.0 of the release of 2013 (putting the same CMSIS 3.0.1 from 2012), despite the fact that they also posted the latest version of CMSIS 3.30 release 2014?  By the way, in SPL 3.6.x for STM32F10X fixed a couple of USART bugs related to buffer overflow signals.  Thank you, though release notes left ... <br><br><h4>  HID vs SNMP </h4><br>  So, having taken the STM32F103C8T6, I also decided to slightly move on the USB HID topic, the USB HID abstraction painfully fits into the concept of all sorts of sensors, sensors and other PWM-driven power drivers.  Something reminded me of SNMP, only in a highly simplified form: HID descriptors play the role of an SNMP MIB.  When the device is initialized by the host: ‚ÄúHello, host!  I'm a coffee maker.  I have a [start] button, regulators [cream], [sugar], sensors [coffee residue], [water residue], [sugar residue], [cream residue].  Pull up the driver, push the button, drink some coffee. ‚Äù  Nothing like?  An example of an SNMP conversation: ‚ÄúWell, hello, management station with software for $ 100,000.  And I have a switchboard chassis for $ 200,000, and I have 4 more modules for $ 100,000 each;  in each of 16 more ports with indecent speed, and all the functions here simply do not list ... ask separately for each item;  oh, yes, the processor load is so, the memory is so much ... ".  And a dozen more pages in the same spirit. <br><br>  I liked the idea of ‚Äã‚ÄãHID.  But it was enough to get out of Windows beyond the training tasks of flashing LEDs (forward to real UNIX environments!), As I began to see through all the <a href="http://wiki.freebsd.org/uhidd">unused gaps</a> , and I felt like some kind of helpless lamer.  Debugging the project, I instinctively grabbed some sort of tcpdump (and called: <a href="https://www.freebsd.org/cgi/man.cgi%3Fquery%3Dusbdump%26sektion%3D8">usbdump (8)</a> , or <a href="https://www.kernel.org/doc/Documentation/usb/usbmon.txt">usbmon</a> ), but I saw only messages in an unfamiliar language. <br><br>  It became obvious: there is a lack of fundamental knowledge about the USB bus.  If the OSI model and the TCP / IP stack are understood by any grated IT specialist somewhere at the level of the spinal cord simply because of necessity, then the situation with USB is different.  This is understandable: there you can (need) to spy traffic through the same tcpdump and configure hardware with software, and then complete plug and play, and you can fix something by updating the driver or firmware (or reinstalling the OS).  But you and I are here just to make good firmware, aren't we?  After reading some USB descriptions on the network, I was surprised how confusing the documentation could be.  I even had the feeling that they specifically wanted to lead us astray, letting fog and get rid of competition in the bud.  I do not agree with this state of affairs! <br><br><h4>  Another great scheme </h4><br>  In the open spaces of the network I met another such illustration (it was in BMP format, no joke): <br><img src="https://habrastorage.org/files/09e/8c8/676/09e8c867640c4676988f8dd836823703.png"><br><br>  At first it looks optimistic.  Finally, the stack is disassembled.  Frames, however, are marked unsuccessfully: I would draw them with vertical dashed lines, and EOF is just a pause, in fact, the data is not transmitted.  But we start to read the context and <s>lose the</s> understanding of the author‚Äôs true intention (to confuse us): <br><br><blockquote>  The USB bus interface host controller <b>frames</b> ; <br>  <b>Frames</b> are transmitted by sequential transmission of bits using the NRZI method. </blockquote>  And here's another: <br><blockquote>  each <b>frame</b> consists of the highest priority <b>parcels</b> , the composition of which forms the host driver; <br>  each <b>transfer</b> consists of one or more transactions; <br>  each transaction consists of <b>packages</b> ; <br>  each <b>packet</b> consists of a packet identifier, data (if any) and a checksum. </blockquote><br>  It seems to be drawn and everything is correct, but as you read the questions becomes more and more.  Is the minimum bus data structure transmitted ‚Äî is it a frame or a packet?  In general, it is necessary to look from the top down or vice versa?  And what is encoded by the <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4%25D1%258B_%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F_%25D1%2586%25D0%25B8%25D1%2584%25D1%2580%25D0%25BE%25D0%25B2%25D1%258B%25D1%2585_%25D1%2581%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B2">NRZI</a> method - frames, packets, or just the entire bitstream over the bus?  Transaction consists of a parcel, transmission, or, maybe, a valuable parcel post? <br>  Why can't it be simple: the <i>host groups the packets in a transaction and distributes them in time slots, called frames, to give priority to time-critical data (video, audio) based on the current bus bandwidth?</i>  Yes, there are some nuances in USB with scheduling the transfer of packets, I haven‚Äôt affected them yet. <br><br><h4>  My vision of the USB stack </h4><br>  I consider as good documentation the <a href="http://www.beyondlogic.org/usbnutshell/usb1.shtml">USB in a NutShell</a> mentioned here on <a href="http://www.beyondlogic.org/usbnutshell/usb1.shtml">Habr√©</a> (hurray, <a href="http://microsin.ru/content/view/1107/44/">translation</a> ), as well as <a href="http://www.usbmadesimple.co.uk/">USB Made Simple</a> .  According to them, I collected my version of the USB stack, I will draw it again. <br><br><img src="https://habrastorage.org/files/598/dd0/64f/598dd064f07e4cad8b252f57e31b44d7.png"><br><br><h5>  Physical level </h5><br>  At the physical level, a set of electrical modes of a differential pair of conductors (along with earth) is used to denote the states by which the bitstream is encoded using the <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4%25D1%258B_%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F_%25D1%2586%25D0%25B8%25D1%2584%25D1%2580%25D0%25BE%25D0%25B2%25D1%258B%25D1%2585_%25D1%2581%25D0%25B8%25D0%25B3%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B2">NRZI</a> method with <a href="http://en.wikipedia.org/wiki/Bit_stuffing">bit stuffing</a> : here after six consecutive "1" (well, I wanted to transfer, say , 0xffff) is inserted "0", so that the receiver will not stick for a long time in one state;  the receiver recognizes the inserted ‚Äú0‚Äù and as the data does not count, this is a fairly common trick in coding for better auto-tuning of frequencies.  A pair of wires together with the ground makes it possible to form at least four static states (they are denoted by J, K, SE0, SE1).  In USB 2.0, the SE1 is not used, and the three remaining ones are additionally played in dynamics (with clocks and transitions) to transfer several more control characters (packet boundaries, reset, connect / disconnect, power saving / exit).  Good illustrations are in <a href="http://www.usbmadesimple.co.uk/ums_3.htm">USB Made Simple, Part 3 - Data Flow</a> . <br>  Those.  as a result, data is transmitted in the form of zeros and ones, plus any control characters, so that normal data packets can be prepared from the entire electrodynamic kitchen. <br>  <b>(supplemented at the request of readers)</b> <br><br><h5>  Batch level </h5><br>  At the packet level, addressless packets are transmitted between the host and the device (a pair of devices on a half-duplex line can do without addressing).  A packet consists of a SYNC token for synchronizing receiver ticks, a sequence of bytes, and an EOP character.  The packet length is variable, but is negotiated through the upper levels of the stack.  The first byte is called Packet Identifier (PID), it has a simple redundant format for noise immunity and is suitable for feeding to the next level machine (for assembling transaction from packets).  Packages with a filling (longer than one PID byte) are supplied with a checksum (short CRC5 or long CRC16, depending on the type of packet).  A protocol analyzer should, at a minimum, show us packets. <br><br><h5>  Transaction level </h5><br>  At the next level, <i>transactions</i> are collected from <i>packets</i> .  A transaction is a small set of packets (in Full Speed ‚Äã‚ÄãUSB 1, 2 or 3) that follow one after another, which (in half-duplex mode) the host exchanges with the endpoint (endpoint), and only with one.  It is very important that the transaction is opened only by the host, this is USB specific (we have less trouble in the MK firmware).  At the transaction level, you can talk about <i>the</i> pipe (pipe) between the host and one of the device‚Äôs endpoints, but I deliberately avoid the term ‚Äúdata link‚Äù (Data Link) from the OSI model.  The protocol analyzer must at least decode transactions. <br><br><h5>  Gear level </h5><br>  Above the transaction we place the level of transfers (transfers).  Four types of them are used in USB: control with end point # 0 (control transfers), transfers with interrupts (interrupt transfers), isochronous (isochronous transfers) and large-block transfers (bulk transfers).  The last three are variants of stream channels (stream pipe), about which I will say a few words.  This level should also display a good protocol analyzer. <br><br><h5>  Application layer </h5><br>  Crowns the stack, as usual, the application layer.  Here they are: setting the address to the device by the host, telling the device about itself in the language of descriptors, host commands to select a configuration (control transmissions), exchanging data with HID devices (in the examples I found the transmission with interrupts, I want to try the control one), print to a printer and scanning, access to USB storage (large-block), communication via headsets and webcams (isochronous), and many other wonderful things. <br><br><h5>  Finishing touch </h5><br>  Having run down by levels for a second, you can add that the host periodically throws those same Start of Frame (SOF) packets on the bus, breaking the time into equal intervals, but not to split the transactions themselves.  Therefore, SOF packages can be considered independent transactions.  Do not confuse the frame (frame) USB with the homonym of the data link layer of the OSI model.  It is better to remember the frames (frames) of an audio CD, it's just a time slice: the host is ‚Äúticking‚Äù into the bus with SOF packets, so that the connected devices plan in advance to participate in the so-called  <i>isochronous transmissions</i> that <i>drive</i> real-time data streams.  Well, or like this: groups of transactions are scheduled by the host at time intervals called frames.  The frame is 1ms for Full Speed ‚Äã‚Äãand 125¬µs for High Speed ‚Äã‚ÄãUSB, but High Speed ‚Äã‚Äãis a more complex standard, it is better to study it separately. <br>  <b>UPD:</b> <br>  A good question was asked by the readers: what about fragmentation?  I did not find in USB 2.0 signs of fragmentation at the transaction level and below, i.e.  transactions for this purpose are to be transferred entirely.  Transfers in some cases can and should be broken up into several transactions, especially taking into account isochronous modes.  And I will repeat that all planning is in our hands while the host is in charge (on the MK side, you have to think less). <br><br><h4>  We look at the traffic via USB </h4><br>  A good selection of illustrations is in the mentioned book USB Made Simple, Chapter 5: <a href="http://www.usbmadesimple.co.uk/ums_5.htm">www.usbmadesimple.co.uk/ums_5.htm</a> <br><div class="spoiler">  <b class="spoiler_title">Here is one of them</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/925/42b/e8c/92542be8c362408f98f87f4c91eb4e9e.gif"></div></div><br>  So, the transaction is always initiated by the host in relation to one selected end point on the device (in addition to the special point number 0, there can be up to 15 more on one device, for example, a combined keyboard with a mouse, a thermometer, a flash drive, a coffee maker and an order <s>plumber</s> button pizza). <br>  In case the host receives data from the device, the latter cannot open the transaction itself, but can only wait for the <i>right moment</i> and participate in it.  The host opens a transaction to the device with a package with PID = IN (Token group) and guarantees freedom of the bus at the right time, the device drops a packet from the Data group, depending on the type of transaction the host can confirm success with a third packet from the Handshake group (ACK, NAK, STALL, NYET ), the transaction is closed. <br>  When sending data to a device (PID = OUT, Token group), the host opens a transaction, sends a packet with data (Data), and, depending on the mode, can receive a Handshake packet confirming the success of the transaction. <br>  At the end of the transaction, everything will return to normal, the device will again wait for control packets from the host. <br><br><h4>  USB transfer modes in STM32 USB FS examples </h4><br>  In order for one pair of wires to be able to drive copying from a disc simultaneously with an audio-video stream, mouse gestures, and a speed oscilloscope signal, there are different types of messages and broadcasts. <br>  Just above, I just described a simple <i>streaming channel</i> (Stream Pipe) between the host and the endpoint, where the packets with the filling (Data groups) do not carry any special or control information to the USB subsystem itself.  Full freedom of correspondence, the controller's library should provide primitives for uploading a buffer of arbitrary size from the MK memory to the host or back.  Cutting into packets, forwarding, and "defragmenting" let the MK library work together with the host driver.  In STM32, this is USB_SIL_Write () and USB_SIL_Read (), described in UM0424.  They are the very logical level of abstraction.  On the host side, see the description of the corresponding driver (for example, on FreeBSD, this is <a href="https://www.freebsd.org/cgi/man.cgi%3Fugen">ugen (4)</a> ). <br>  However, I consider using heavy peripherals like USB to organize a simple streaming channel to be sacrilege (the question is: what did USART not please?).  But situations, of course, are all sorts. <br>  In any case, so that the USB subsystem comes to life at all and the device is determined, the exchange of control transactions is required. <br><br><h4>  DISCLAIMER </h4><br>  Further examples will be mentioned from the same <a href="http://www.st.com/web/en/catalog/tools/PF258157">UM0424 library</a> for working with Full Speed ‚Äã‚ÄãUSB from STMicroelectronics, but they are designed for their native demos.  Take the example of the author <a href="https://habrahabr.ru/users/raja/" class="user_link">Raja</a> , show engineering ingenuity in adapting projects for your demo payment. <br><br>  On software, everything is clear: these are examples not for industrial use, there may be bugs, some parts (such as the reference table in the Mass storage example) are protected by a patent, and you do not have the right to use them in a commercial project.  But this is nothing, the Chinese manage to sell USB products on the market, which even the library <abbr title="Vendor id">VID</abbr> and <abbr title="Product id">PID</abbr> did not bother to change. <br><br>  For iron, as I understand it, you need to start with quartz.  I have a Chelyabinsk PinBoard II with 12 MHz quartz (all libraries are sharpened at 8 MHz), I changed the PLL multiplier from 9 to 6 ( <a href="http://forum.easyelectronics.ru/viewtopic.php%3Fp%3D185059%26sid%3D4d806556713135b52554d53ea6c8946f">link</a> with explanations), otherwise the MC will accelerate to 108 MHz instead of 72 MHz, and USB to 72 MHz instead of 48 MHz will not go at all.  You can still slow down the speed of MK to 48 MHz, changing the USB bus divider from one and a half to one.  <a href="http://easyelectronics.ru/arm-uchebnyj-kurs-taktovyj-generator-stm32.html">Specialists do not like to</a> use the internal generator MK HSI: the frequency may slightly swim away from heating, I find it difficult to predict the consequences for USB.  Well, do not forget about the periphery, of course.  Without the SPI / SDIO flash memory from the Mass storage example, you can only make an analogue of / dev / null, but you can format it as hell :-) <br><br><h5>  Control transfers and message channels </h5><br>  Thinking about USB, I remember the good old PPP protocol with its <abbr title="Link Control Protocol">LCP</abbr> , <abbr title="IP Control Protocol">IPCP</abbr> , <abbr title="Compression Control Protocol">CCP</abbr> and also <abbr title="Horseradish Knows What Control Protocol">xCP</abbr> .  Host exchange with end point # 0 of a special type of message is the local equivalent of xcCP. <br>  Through check transfers, the device is initialized, gets an address, tells the host about itself in the language of descriptors (so that it can find and activate the necessary driver).  Without control operations, simple streaming will not ‚Äúgo‚Äù, if the device does not respond in form, the host will quickly shut down the port: the protocol must be followed. <br>  In principle, the protocol does not prohibit hanging on the checkpoint number 0 and the exchange of data, similar to the mode with interrupts.  At the same time think: how will you update the firmware MK, so to speak, in the field?  Is the programmer on hold?  There is another solution. <br>  Example: <b>Device firmware upgrade</b> <br><br><h5>  Interrupt transfers </h5><br>  This kind of ( <i>interrupt transfer</i> ) is designed for the exchange of small transactions, similar to the control.  No, the device cannot interrupt the host, it waits for polling, their frequency and packet sizes are negotiated in advance in the device descriptor.  Well suited for all kinds of consoles, sensors, sensors, mice, LEDs and other HID-coffee makers.  The channel with interrupts of each point is unidirectional. <br>  Examples: <b>Custom HID</b> , <b>Joystick mouse</b> , <b>Virtual COM port</b> <br><br><h5>  Isochronous transfers </h5><br>  œÅœåŒΩŒøœÇ in Greek means "time."  Isochronous transfer ( <i>isochronous transfer</i> ) - a local high-tech that allows you to control the flow of data in real time.  It features guaranteed (but not necessarily broad) bandwidth and no confirming transactions, almost like UDP with QoS.  Broken package?  This god Chronos pushed MK along the leg.  Do not try to send the package again, otherwise God will be upset.  Checksums, however, check quietly from Chronos.  Isochronous transfers are good for audio-video and real-time measurement systems, as well as other <i>dual-use</i> toys.  Although some of them m.  more interesting to hang any AVR, linking it with our ARM on USART or SPI.  Isochronous operations are involved in frame signaling (recall the ticking of the SOF package). <br>  Example: <b>USB voice speaker</b> <br><br><h5>  Large block transmissions </h5><br>  No, we will not carry bags of cement.  I think everyone learned the mode of operation of various USB drives.  <i>Bulk transfer</i> transmissions have the goal to send data as much as possible and faster, always with the transfer of broken packets, but without guarantees for bandwidth, yielding it to isochronous transfers if necessary (as in TCP without QoS).  I have already <a href="http://habrahabr.ru/post/214803">told</a> you about the internal structure of USB flash drives, now you can download and run a working prototype.  I did not try it myself, but the table of SCSI commands in the description of the example (as if, by the way) is very symbolic.  I did not find any signs of the wear control algorithm for NAND memory :-) <br>  ATTENTION: STM patent protection is in place. <br>  Example: <b>Mass storage</b> <br><br><h4>  What remains undisclosed </h4><br>  I don‚Äôt have a goal to make another USB tutorial, there are enough of them without me, and there they are well described: electrical part, protocol details, work with hubs, descriptor language and HID abstraction level, problems with unique VID / PID, USB 3.0 and many Other great USB bus features, both useful to us and not so great.  IT specialists especially recommend an excursion to the dark side with an overview of enemy devices (a flash drive with a disguised HID-keyboard that will do scary things). <br><br><h4>  Links </h4><br>  Adaptation of the Custom HID example to the free Em :: Blocks environment and the STM32F103C8T6 budget demo from <a href="http://www.lctech-inc.com/Hardware/">LC-Tech</a> : <a href="http://habrahabr.ru/post/208026/">habrahabr.ru/post/208026</a> <br>  Battle of the UPS: <a href="http://habrahabr.ru/post/233391/">habrahabr.ru/post/233391</a> another battle for the UPS: <a href="http://habrahabr.ru/post/233391/">habrahabr.ru/post/233391/#comment_7944489</a> <br>  Excursion to the dark side (spy device from AVR): <a href="http://habrahabr.ru/post/153571/">habrahabr.ru/post/153571</a> <br>  Instructions for USB analysis in Wireshark for Windows and Linux: <a href="http://wiki.wireshark.org/CaptureSetup/USB">wiki.wireshark.org/CaptureSetup/USB</a> <br>  USB in a NutShell book: <a href="http://www.beyondlogic.org/usbnutshell/usb1.shtml">www.beyondlogic.org/usbnutshell/usb1.shtml</a> <br>  Translation USB in a NutShell: <a href="http://microsin.ru/content/view/1107/44/">microsin.ru/content/view/1107/44</a> <br>  Book USB Made Simple (really simplified): <a href="http://www.usbmadesimple.co.uk/">www.usbmadesimple.co.uk</a> <br>  STSW-STM32121, STMicroelectronics USB library full speed device library and all examples mentioned (UM0424) <a href="http://www.st.com/web/en/catalog/tools/PF258157">www.st.com/web/en/catalog/tools/PF258157</a> <br><br>  <b>PS</b> <br>  Reading publications on Habr√©, devoted in varying degrees to microelectronics, I saw two engineering castes, let's call them conditionally: <i>Promelectronics</i> and <i>IT specialists</i> .  This is a kind of engineering Yin and Yang, in each of us there is a share of both. <br><br>  Promelectrons have brilliant knowledge and skills on the gland, solder radio components as thick as their hair with their left hand with eyes closed (and then it works).  Having looked at the electronic circuit, almost physically they begin to feel all its currents with potentials, they also work with power circuits and with (large, fast, dangerous) industrial products.  The approach to programming MK is appropriate: it just has to give the right logic levels to the right legs at the right time, it‚Äôs not so important how.  Conservative in technology (do not fit - it works), the heavy periphery of the MC is not particularly favored.  When discussing object-oriented programming, information security, giant projects in a million lines of code and all the clever graphical interfaces will be boring.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead of a packet-oriented USB bus, USART streaming mode is preferred, enhanced either by the usual RS-232 or more brutal RS-485 (serial bus for industrial applications, up to 10 Mbit / s at 15m, up to 100kBit / s at 1200m, up to 32 devices).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IT specialists are brought up on the understanding of operating systems, network infrastructure and complex interactions, the elite are well-versed in information security and understands all sorts of invisible ways of penetrating someone else's system. Some of them are very fond of cats (well, how can you not love them? I really do not hold, breed or cook :-). Many love the freedom of information, curse corporations / governments and conquer the forces of nature with an effort of thought. They are pathetically lazy, but they adore new technologies and twisted engineering puzzles with expensive toys (preferably solved at the level of software or, as a last resort, jumpers). Relationship with a soldering iron wary: do not ask the IT specialist if he loves a soldering iron, may misunderstand; better ask if he likes to solder electronic circuits.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What am I for? </font><font style="vertical-align: inherit;">We just see this world in different ways ... After all, the same Linux guys have built the Linux kernel, from modules on C and assembler inserts for specific platforms, and they seem to have done without holivars. </font><font style="vertical-align: inherit;">I see a really serious project as a multi-core system that combines the latest MKs with heavy peripherals, but I don‚Äôt exclude bundles with classical models of the AVR type: they can weigh some critical rapidly rotating points of technical progress. </font><font style="vertical-align: inherit;">If the code is proven over the years, then why not?</font></font></div><p>Source: <a href="https://habr.com/ru/post/236401/">https://habr.com/ru/post/236401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236389/index.html">When did it all start?</a></li>
<li><a href="../236391/index.html">OpenOffice and LibreOffice have to unite?</a></li>
<li><a href="../236395/index.html">Android L, Nexus 5, Google Search and all-all-all</a></li>
<li><a href="../236397/index.html">How to make nandroid backup device directly to your computer, bypassing the sdcard</a></li>
<li><a href="../236399/index.html">RailsClub'Moscow 2014: Interview with Bozhidar Batsov</a></li>
<li><a href="../236403/index.html">String enum - string enum</a></li>
<li><a href="../236409/index.html">Mailbox eyes of letters</a></li>
<li><a href="../236411/index.html">Directed IT attacks in the sphere of large business: how it happens in Russia</a></li>
<li><a href="../236413/index.html">LinkMeUp. Issue number 19. The company Zelaks, technical support and data transmission through power lines</a></li>
<li><a href="../236415/index.html">Global interface update for Skype for Windows Desktop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>