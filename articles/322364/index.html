<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RTM Cybergroup specializes in stealing funds from Russian companies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are several cyber groups that specialize in stealing funds from Russian companies. We observed attacks with the use of loopholes in security sys...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RTM Cybergroup specializes in stealing funds from Russian companies</h1><div class="post__text post__text-html js-mediator-article"><p>  There are several cyber groups that specialize in stealing funds from Russian companies.  We observed attacks with the use of loopholes in security systems, opening access to the network of target objects.  Having gained access, attackers study the network structure of the organization and deploy their own tools to steal funds.  A classic example of this trend is the hacker groups Buhtrap, Cobalt and Corkow. </p><br><p><img src="https://habrastorage.org/files/acd/3b0/ca2/acd3b0ca2f1745518a17c4ac193e5383.png" alt="image"></p><br><p>  The RTM group that this report is about is part of this trend.  It uses specially designed malware written in Delphi, which we will look at in more detail in the following sections.  The first traces of these tools in the ESET telemetry system were discovered at the end of 2015.  As needed, the group loads various new modules into infected systems.  The attacks are aimed at the users of RBS systems in Russia and some neighboring countries. </p><br><p><a name="habracut"></a>  <b>1. Goals</b> </p><br><p>  The RTM campaign is targeted at corporate users - this is evident from the processes that attackers are trying to detect in a compromised system.  In focus accounting software for working with remote banking systems. </p><br><p>  The list of processes of interest to RTM resembles the corresponding list of the Buhtrap group, but at the same time the infection vectors are different for groups.  If Buhtrap used fake pages more often, then RTM is a drive-by download attack (attacks on the browser or its components) and spam by email.  According to telemetry, the threat is aimed at Russia and several nearby countries (Ukraine, Kazakhstan, the Czech Republic, Germany).  However, due to the use of mass distribution mechanisms, malware detection outside the target regions is not surprising. </p><br><p>  The total number of malware detections is relatively small.  On the other hand, the RTM campaign uses sophisticated programs, which indicates a high targeting of attacks. </p><br><p>  We found several bait documents used by RTM, including non-existent contracts, invoices, or tax records.  The nature of the lures in combination with the type of software that the attack is aimed at indicates that the attackers ‚Äúenter‚Äù the networks of Russian companies through the accounting department.  The <a href="https://habrahabr.ru/company/eset/blog/255325/">Buhtrap</a> group <a href="https://habrahabr.ru/company/eset/blog/255325/">acted</a> in the same way in 2014‚Äì2015. </p><br><img src="https://habrastorage.org/files/85e/22e/dd1/85e22edd1d2e4680bc5f0871d0afb035.png" alt="image"><br><p>  During the study, we were able to interact with several C &amp; C servers.  We will list the full list of commands in the following sections, but for now we can say that the client sends data from the keylogger directly to the attacker's server, from which additional commands are then received. </p><br><p>  However, the days when you could just connect to the command server and collect all the data of interest are over.  We recreated realistic log files to get several relevant commands from the server. </p><br><p>  The first one is a request to the bot to transfer the 1c_to_kl.txt file - the transport file of the 1C: Enterprise 8 program, the appearance of which is actively tracked by RTM.  1C interacts with RBS systems by uploading data about outgoing payments to a text file.  The file is then sent to the RBS system for automation and execution of the payment order. </p><br><p>  The file contains payment details.  If the malefactors change the data on outgoing payments, the transfer will go through the false details to the attackers' accounts. </p><br><p><img src="https://habrastorage.org/files/a67/853/579/a678535797e34686bbc55383f6d176bf.png" alt="image"></p><br><p>  About a month after the request of these files from the command server, we observed loading of the new plug-in 1c_2_kl.dll into the compromised system.  The module (DLL) is designed to automatically analyze the file upload by penetrating the processes of accounting software.  We will describe it in detail in the following sections. </p><br><p>  Interestingly, at the end of 2016, ‚ÄúFinCERT‚Äù of the Bank of Russia issued a bulletin with a warning about cybercriminals using upload files 1c_to_kl.txt.  The developers of 1C also know about this scheme, they have already made an official statement and listed the precautions. </p><br><p>  Other modules were loaded from the command server, in particular, VNC (its 32 and 64-bit versions).  It resembles the VNC module that was previously used in Dridex Trojan attacks.  This module is supposedly used to remotely connect to an infected computer and study the system in detail.  Next, the attackers try to navigate the network, extracting user passwords, gather information and ensure the constant presence of malware. </p><br><p>  <strong>2. Vectors of infection</strong> </p><br><p>  The following figure shows the infection vectors found during the study period of the campaign.  The group uses a wide range of vectors, but mostly drive-by download and spam attacks.  These tools are convenient for targeted attacks, since in the first case, attackers can choose sites visited by potential victims, and in the second case, send email with attachments directly to the right employees of companies. </p><br><p><img src="https://habrastorage.org/files/3b8/477/1c9/3b84771c92fd45cd8ea94f1f1b232229.png" alt="image"></p><br><p>  Malicious software is distributed in several channels, including RIG and Sundown exploit kits or spam mailings, indicating that the attackers have connections with other cyber attackers offering these services. </p><br><p>  <strong>2.1.</strong>  <strong>How are RTM and Buhtrap related?</strong> </p><br><p>  The RTM campaign is very similar to Buhtrap.  A logical question: how are they related to each other? </p><br><p>  In September 2016, we observed the distribution of the RTM sample using the Buhtrap loader.  In addition, we found two digital certificates used in both Buhtrap and RTM. </p><br><p>  The first one, allegedly issued by DNISTER-M, was used to digitally sign the second form of Delphi (SHA-1: 025C718BA31E43DB1B87DC13F94A61A9338C11CE) and the Buhtrap DLL (SHA-1: 1E2642B454A2C889B6D41116CCD83836666666666666666666666666116CCD838366666666666166116666661661166661166611666116611661166116661166636C11CE </p><br><p><img src="https://habrastorage.org/files/c80/403/6b4/c804036b4c9d4097b5d6acdeb8084fc7.png" alt="image"></p><br><p>  Second, issued us Bit-Tredj, used for signature loaders Buhtrap (SHA-1: 7C1B6B1713BD923FC243DFEC80002FE9B93EB292 and B74F71560E48488D2153AE2FB51207A0AC206E2B), as well as unloading and installation RTM components. </p><br><p><img src="https://habrastorage.org/files/a61/554/cb6/a61554cb6232476691fe31a0c6b5db96.png" alt="image"></p><br><p>  RTM operators use certificates that are common with other malware families, but they also have a unique certificate.  According to the ESET telemetry system, it was issued to Kit-SD and was used only to sign some RTM malware (SHA-1: 42A4B04446A20993DDAE98B2BE6D5A797376D4B6). </p><br><p>  RTM uses the same loader as Buhtrap, RTM components are loaded from the Buhtrap infrastructure, so the groups have similar network indicators.  Nevertheless, according to our estimates, RTM and Buhtrap are different groupings, at least, because RTM is distributed in different ways (not only with the help of an ‚Äúalien‚Äù bootloader). </p><br><p>  Despite this, hacker groups use similar principles of work.  They target companies that use accounting software, similarly collect information about the system, look for smart card readers, and deploy an array of malicious tools to spy on victims. </p><br><p>  <strong>3. Evolution</strong> </p><br><p>  In this section, we will look at the different versions of malware found during the study. </p><br><p>  <strong>3.1.</strong>  <strong>Versionality</strong> </p><br><p>  RTM stores configuration data in the registry key, the most interesting part of the botnet-prefix.  A list of all the values ‚Äã‚Äãthat we saw in the studied samples is presented in the table below. </p><br><p><img src="https://habrastorage.org/files/b67/dc7/3d8/b67dc73d8cfd40caacf8a3aaec19d670.png" alt="image"></p><br><p>  Perhaps the values ‚Äã‚Äãcan be used to record versions of the malware.  However, we did not notice any special differences between the versions, such as bit2 and bit3, 0.1.6.4 and 0.1.6.6.  Moreover, one of the prefixes exists from the very beginning and has evolved from a typical C &amp; C domain to a .bit domain, as will be shown later. </p><br><p>  <strong>3.2.</strong>  <strong>Schedule</strong> </p><br><p>  Using telemetry data, we created a graph of the appearance of samples. </p><br><p><img src="https://habrastorage.org/files/cbb/94e/180/cbb94e1801b74ddbb0564da89968d1c1.png" alt="image"></p><br><p>  <strong>4. Technical analysis</strong> </p><br><p>  In this section, we describe the main functions of the RTM banking trojan, including resilience mechanisms, its own version of the RC4 algorithm, network protocol, spyware functionality, and some other features.  In particular, we will focus on samples SHA-1 AA0FA4584768CE9E16D67D8C529233E99FF1BBF0 and 48BC113EC8BA20B8B80CD5D4DA92051A19D1032B. </p><br><p>  <strong>4.1.</strong>  <strong>Install and save</strong> </p><br><p>  <strong>4.1.1.</strong>  <strong>Implementation</strong> </p><br><p>  Kernel RTM - DLL, the library is loaded onto the disk using .EXE.  The executable file is usually packaged and contains the DLL code.  Once launched, it extracts the DLL and starts it using the following command: </p><br><pre><code class="hljs mel">rundll32.exe ‚Äú%PROGRAMDATA%\Winlogon\winlogon.lnk‚Äù,DllGetClassObject host</code> </pre> <br><p>  <strong>4.1.2.</strong>  <strong>Dll</strong> </p><br><p>  The main DLL is always loaded onto the disk as winlogon.lnk in the% PROGRAMDATA% \ Winlogon folder.  This file extension is usually associated with a shortcut, but the file is actually a DLL written in Delphi, named by the developer core.dll, as shown in the figure below. </p><br><p><img src="https://habrastorage.org/files/9b4/3c4/0c8/9b43c40c83bf4746b042c468eb38e14d.png" alt="image"></p><br><p>  Example of the name of the DLL F4C746696B0F5BB565D445EC49DD912993DE6361 </p><br><p>  Once launched, the trojan activates the stability mechanism.  This can be done in two different ways, depending on the privileges of the victim in the system.  If you have administrator rights, the Trojan adds the Windows Update entry to the HKLM \ SOFTWARE \ Microsoft \ Windows \ CurrentVersion \ Run registry.  Commands contained in Windows Update will run at the beginning of a user session. </p><br><p>  HKLM \ SOFTWARE \ Microsoft \ Windows \ CurrentVersion \ Run \ Windows Update [REG_SZ] <br>  = rundll32.exe ‚Äú% PROGRAMDATA% \ winlogon.lnk‚Äù, DllGetClassObject host </p><br><p>  The Trojan also tries to add a task to the Windows Task Scheduler.  The task will launch the winlogon.lnk DLL with the same parameters as above.  Standard user rights allow the Trojan to add a Windows Update entry with the same data to the registry HKCU \ Software \ Microsoft \ Windows \ CurrentVersion \ Run \: </p><br><pre> <code class="hljs mel">rundll32.exe ‚Äú%PROGRAMDATA%\winlogon.lnk‚Äù,DllGetClassObject host</code> </pre> <br><p>  <strong>4.2.</strong>  <strong>Modified RC4 Algorithm</strong> </p><br><p>  Despite the known flaws, the RC4 algorithm is regularly used by malware authors.  Nevertheless, the creators of RTM modified it a bit - probably to complicate the task of virus analysts.  The modified version of RC4 is widely used in malicious RTM tools to encrypt strings, network data, configuration, and modules. </p><br><p>  <strong>4.2.1.</strong>  <strong>Differences</strong> </p><br><p>  The original RC4 algorithm includes two stages: initialization of the s-block (also known as KSA - Key-Scheduling Algorithm) and generation of a pseudo-random sequence (PRGA - Pseudo-Random Generation Algorithm).  The first stage involves the initialization of the s-block using the key; in the second stage, the source text is processed using the s-block for encryption. </p><br><p>  The RTM authors added an intermediate step between the initialization of the s-box and encryption.  The additional key is a variable and is set at the same time as the data for encryption and decryption.  The function that performs this extra step is shown in the figure below. </p><br><p><img src="https://habrastorage.org/files/261/ac4/a47/261ac4a47a3a49cb9540b1a9c37c81d7.png" alt="image"></p><br><p>  <strong>4.2.2.</strong>  <strong>String Encryption</strong> </p><br><p>  At first glance, there are several readable lines in the main DLL library.  The rest are encrypted using the algorithm described above, whose structure is shown in the following figure.  We found more than 25 different RC4 keys to encrypt strings in analyzed samples.  The XOR key is different for each row.  The value of the digital field separating lines is always 0xFFFFFFFF. </p><br><p>  At the start of execution, RTM decodes strings into a global variable.  When it is necessary to access a string, the trojan dynamically calculates the address of the decrypted strings based on the base address and offset. </p><br><p>  The strings contain interesting information about the functions of the malware.  Some sample lines are presented in section 6.8. </p><br><p><img src="https://habrastorage.org/files/598/6ce/dbe/5986cedbe736430aaf87807c65f9e21f.png" alt="image"></p><br><p>  <strong>4.3.</strong>  <strong>Network</strong> </p><br><p>  The way RTM malware contacts the command server varies from version to version.  The first modifications (October 2015 - April 2016) used traditional domain names to update the command list along with the RSS channel on livejournal.com. </p><br><p>  Since April 2016, we observed the transition to .bit domains in the telemetry data.  This confirms the domain registration date - the first domain RTM fde05d0573da.bit was registered on March 13, 2016. </p><br><p>  All the URLs we saw while monitoring the campaign had a common path: /r/z.php.  It is rather unusual, and it will help identify RTM requests in network flows. </p><br><p>  <strong>4.3.1.</strong>  <strong>Channel for commands and control</strong> </p><br><p>  Older samples used this channel to update their list of command servers.  Hosting is on livejournal.com, at the time of preparing the report, it remained at the URL hxxp: // f72bba81c921 (.) Livejournal (.) Com / data / rss. </p><br><p>  Livejournal is a Russian-American company providing a platform for blogs.  RTM operators create a LiveJournal blog in which they post an article with coded commands - see screenshot. </p><br><p><img src="https://habrastorage.org/files/027/5fd/9d9/0275fd9d95f44aad8d9675620bfde39b.png" alt="image"></p><br><p>  Command and control strings are encoded using the modified RC4 algorithm (Section 4.2).  The current version (November 2016) of the channel contains the following command and control server addresses: </p><br><ul><li>  hxxp: // cainmoon (.) net / r / z.php </li><li>  hxxp: // rtm (.) dev / 0-3 / z.php </li><li>  hxxp: // vpntap (.) top / r / z.php </li></ul><br><p>  <strong>4.3.2.</strong>  <strong>.Bit domains</strong> </p><br><p>  In most recent RTM samples, authors connect to C &amp; C domains that use the top level domain TLD .bit.  It is not in the list of top-level domains of ICANN (Domain Name and IP Addresses Management Corporation).  Instead, it uses the Namecoin system, built on the basis of Bitcoin technology.  Malware authors do not often use the .bit TLD for their domains, although an example of such use was previously observed in the version of the Necurs botnet. </p><br><p>  Unlike Bitcoin, Namecoin distributed database users have the ability to save data.  The main application of this feature is the top-level domain .bit.  You can register domains that will be stored in a distributed database.  The corresponding entries in the database contain the IP addresses allowed by the domain.  This TLD is ‚Äúcensored‚Äù because only the registrant can change the resolution of the .bit domain.  This means that stopping a malicious domain when using this type of TLD is much more difficult. </p><br><p>  RTM Trojan does not build the software needed to read the Namecoin distributed database.  It uses central DNS servers, such as dns.dot-bit.org or OpenNic servers, to resolve .bit domains.  Therefore, it has the same stability as DNS servers.  We observed that some command domains were no longer defined after they were mentioned in the blog entry. </p><br><p>  Another advantage of TLD .bit for hackers is cost.  To register a domain, operators need to pay only 0.01 NC, which corresponds to $ 0.00185 (as of December 5, 2016).  For comparison: domain.com costs at least $ 10. </p><br><p>  <strong>4.3.3.</strong>  <strong>Protocol</strong> </p><br><p>  To communicate with the command server, RTM uses HTTP POST requests with data formatted using a custom protocol.  The path value is always /r/z.php;  Mozilla / 5.0 user agent (compatible; MSIE 9.0; Windows NT 6.1; Trident / 5.0).  In requests to the server, the data is formatted as follows, where the offset values ‚Äã‚Äãare expressed in bytes: </p><br><p><img src="https://habrastorage.org/files/fa9/ed7/ed1/fa9ed7ed1b5240279ea49e0ed8eff31e.png" alt="image"></p><br><p>  Bytes from 0 to 6 are not encoded;  bytes starting at 6 are encoded using the modified RC4 algorithm.  The command response package structure is simpler.  Bytes are coded from 4 to packet size. </p><br><p><img src="https://habrastorage.org/files/740/5b6/e25/7405b6e250fc4f05b896e798c452fdb9.png" alt="image"></p><br><p>  The list of possible byte values ‚Äã‚Äãof the action is presented in the table below: </p><br><p><img src="https://habrastorage.org/files/934/186/62b/93418662b8fa4faeab378f8cba16036f.png" alt="image"></p><br><p>  The malware always calculates the decrypted CRC32 data and compares it with what is presented in the packet.  If they are different, the trojan drops the packet. <br>  Additional data may contain various objects, including a PE file, a file for searching in the file system, or new command URLs. </p><br><p>  <strong>4.3.4.</strong>  <strong>Panel</strong> </p><br><p>  We have noticed that RTM uses the panel on command servers.  The screenshot below: </p><br><p><img src="https://habrastorage.org/files/918/0c9/9e8/9180c99e89e448d88a27397646c0cc14.png" alt="image"></p><br><p>  <strong>4.4.</strong>  <strong>Characteristic feature</strong> </p><br><p>  RTM is a typical banking trojan.  No wonder operators need information about the victim system.  On the one hand, the bot collects general information about the OS.  On the other hand, it finds out whether the compromised system contains attributes associated with Russian systems of remote banking. </p><br><p>  <strong>4.4.1.</strong>  <strong>general information</strong> </p><br><p>  When malware is installed or launched after a reboot, a report containing general information is sent to the command server, including: </p><br><ul><li>  Timezone; </li><li>  default system language; </li><li>  Authorized user credentials </li><li>  process integrity level; </li><li>  Username; </li><li>  computer name; </li><li>  OS version; </li><li>  additional installed modules; </li><li>  installed antivirus program; </li><li>  list of smart card readers. </li></ul><br><p>  <strong>4.4.2 Remote Banking System</strong> </p><br><p>  The typical target of a trojan is the RBS system, and RTM is no exception.  One of the modules of the program is called TBdo, it performs various tasks, including scanning disks and history of visits. </p><br><p>  Scanning a disk, the trojan checks whether the banking software is installed on the machine.  A complete list of target programs is in the table below.  Having found the file of interest, the program sends information to the command server.  The following actions depend on the logic given by the command center algorithms (C &amp; C). </p><br><p><img src="https://habrastorage.org/files/941/24b/584/94124b584ee442149d3d61369f592158.png" alt="image"></p><br><p>  RTM also searches for URL patterns in the browser‚Äôs browsing history and in open tabs.  In addition, the program examines the use of the FindNextUrlCacheEntryA and FindFirstUrlCacheEntryA functions, and also checks each entry for matching the URL to one of the following patterns: </p><br><p><img src="https://habrastorage.org/files/5b8/0ed/740/5b80ed740d0e475e9fd0dd36705f812a.png" alt="image"></p><br><p>  Upon discovering open tabs, the trojan accesses Internet Explorer or Firefox via Dynamic Data Exchange (DDE) to check if the tab matches the pattern. </p><br><p>  Checking the history of visits and open tabs is performed in the WHILE loop (a loop with a precondition) with a break of 1 second between checks.  Other data that is tracked in real time will be discussed in section 4.5. </p><br><p>  If a pattern is found, the program reports this to the command server using a list of rows from the following table: </p><br><p><img src="https://habrastorage.org/files/69e/f2e/a32/69ef2ea323b04efba693d6243c5f5fcd.png" alt="image"></p><br><p>  <strong>4.5 Monitoring</strong> </p><br><p>  During the operation of the Trojan, information about the characteristics of the infected system (including data on the presence of banking software) is sent to the command server.  Digital fingerprinting occurs when RTM first launches the monitoring system immediately after the initial scan of the OS. </p><br><p>  <strong>4.5.1.</strong>  <strong>Remote Banking</strong> </p><br><p>  The TBdo module is also responsible for monitoring banking related processes.  It uses dynamic data exchange to check tabs in Firefox and Internet Explorer at the time of the initial scan.  Another TShell module is used to monitor command windows (Internet Explorer or Explorer). </p><br><p>  The module uses the IShellWindows COM interfaces, iWebBrowser, DWebBrowserEvents2 and IConnectionPointContainer to monitor windows.  When a user goes to a new web page, the malware marks this.  She then compares the URL of the page with the above patterns.  When a match is found, the trojan takes six consecutive screenshots with an interval of 5 seconds and sends them to the C &amp; C command server.  The program also checks some names of windows related to banking software - the full list below: </p><br><p><img src="https://habrastorage.org/files/3dc/2c1/ca6/3dc2c1ca61da44149971f153d512881f.png" alt="image"></p><br><p>  <strong>4.5.2.</strong>  <strong>Smart card</strong> </p><br><p>  RTM allows you to monitor smart card readers connected to infected computers.  These devices are used in some countries to verify payment orders.  If devices of this type are connected to a computer, for a trojan this may indicate the use of the machine for banking transactions. </p><br><p>  Unlike other banking Trojans, RTM cannot interact with such smart cards.  Perhaps this functionality is included in an additional module that we have not yet seen. </p><br><p>  <strong>4.5.3.</strong>  <strong>Keylogger</strong> </p><br><p>  An important part of monitoring an infected PC is intercepting keystrokes.  It seems that the RTM developers do not miss any information, as they track not only the usual keys, but also the virtual keyboard and the clipboard. </p><br><p>  To do this, use the SetWindowsHookExA function.  Attackers register keystrokes or keys corresponding to the virtual keyboard, along with the name and date of the program.  The buffer is then sent to the command C &amp; C server. </p><br><p>  To intercept the clipboard, use the SetClipboardViewer function.  Hackers register the contents of the clipboard when the data is text.  Before sending the buffer to the server, the name and date are also recorded. </p><br><p>  <strong>4.5.4.</strong>  <strong>Screenshots</strong> </p><br><p>  Another feature of RTM is interception of screenshots.  This feature is used when the window monitoring module detects a site or banking software of interest.  Screenshots are made using the library of graphic images and transferred to the command server. </p><br><p>  <strong>4.6.</strong>  <strong>Uninstall</strong> </p><br><p>  C &amp; C server can stop the operation of malware and clean the computer.  The command allows you to clear files and registry entries created during RTM operation.  Then, using the DLL library, the malware and the winlogon file are removed, after which the command shuts down the computer.  As shown in the figure below, the DLL is removed by developers using erase.dll. </p><br><p><img src="https://habrastorage.org/files/5b0/7f2/186/5b07f21863f049dcb9d77fecf5da8235.png" alt="image"></p><br><p>  The server can send the destructive uninstall-lock command to the Trojan.  In this case, if you have administrator rights, RTM will remove the MBR boot sector on the hard disk.  If this fails, the Trojan will attempt to shift the MBR boot sector to a random sector ‚Äî then the computer will not be able to boot the OS after shutdown.  This can lead to a complete reinstallation of the OS, that is, the destruction of evidence. </p><br><p>  In the absence of administrative authority, the malware writes .EXEs encoded in the main RTM DLL.  The executable file executes the code necessary to shut down the computer and registers the module in the registry section HKCU \ CurrentVersion \ Run.  Every time a user starts a session, the computer immediately shuts down. </p><br><p>  <strong>4.7.</strong>  <strong>configuration file</strong> </p><br><p>  By default, RTM has almost no configuration file, but the command server can send configuration values ‚Äã‚Äãthat will be stored in the registry and used by the program.  The list of configuration keys is presented in the table below: </p><br><p><img src="https://habrastorage.org/files/283/ea5/5e5/283ea55e5fca4b8d853481a49c199c96.png" alt="image"></p><br><p>  The configuration is stored in the Software [Pseudo-random string] registry key.  Each value corresponds to one of the rows presented in the previous table.  Values ‚Äã‚Äãand data are encoded using the RC4 algorithm in RTM. </p><br><p>  The data has the same structure as the network or rows.  A four-byte XOR key is added at the beginning of the encoded data.  For configuration values, the XOR key is different and depends on the size of the value.  It can be calculated as follows: </p><br><p>  xor_key = (len (config_value) &lt;&lt; 24) |  (len (config_value) &lt;&lt; 16) <br>  |  len (config_value) |  (len (config_value) &lt;&lt; 8) </p><br><p>  <strong>4.8.</strong>  <strong>Other features</strong> </p><br><p>  Next, consider the other features that RTM supports. </p><br><p>  <strong>4.8.1.</strong>  <strong>Additional modules</strong> </p><br><p>  Trojan includes additional modules that are DLL files.  Modules sent from the command C &amp; C server can be executed as external programs, reflected in memory and run in new threads.  For storage, the modules are stored in .dtt files and are encoded using the RC4 algorithm with the same key used for network communications. </p><br><p>  So far, we have seen the installation of the VNC module (8966319882494077C21F66A8354E2CBCA0370464), the browser data extraction module (03DE8622BE6B2F75A364A275995C3411626C4D9F) and the 1c_2_kl module (B1EE562E1F69CH4C4D9F) (171_6_kl (B1EE562E1F69C6C4D9F) and the module 1c_2_kl (B1EE562E1F69Cht6C4D9F) (CI2_kl (B1EE562E1F6C6D4F9F)), if you are using a 1C_2_kl module (B1EE562E1F69C6D4F9F), you need to apply the default value of 860K4D9F) </p><br><p>  To load the VNC module, the command server sends a command requesting connections to the VNC server at a specific IP address on port 44443. The browser's data extraction plugin performs a TBrowserDataCollector, which can read the history of IE.  Then it sends the full list of visited URLs to the command C &amp; C server. </p><br><p>  The last module found is called 1c_2_kl.  It can interact with the 1C Enterprise software package.  The module includes two parts: the main part - the DLL and two agents (32-bit and 64-bit), which will be implemented in each process, registering the binding to WH_CBT.  Having entered into process 1C, the module binds the functions CreateFile and WriteFile.  Whenever the bound CreateFile function is called, the module stores the file path 1c_to_kl.txt in memory.  After intercepting the WriteFile call, it calls the WriteFile function and sends the file path 1c_to_kl.txt to the main DLL module, passing it the Windows created WM_COPYDATA message. </p><br><p>  The main module of the DLL opens and analyzes the file to determine payment orders.  It recognizes the amount and number of transactions contained in the file.  This information is sent to the command server.  We believe that this module is currently in development, because it contains a debugging message and cannot automatically modify 1c_to_kl.txt. </p><br><p>  <strong>4.8.2.</strong>  <strong>Privilege escalation</strong> </p><br><p>  RTM may attempt to elevate privileges by displaying false error messages.  Malware mimics the registry scan (see figure below) or uses the real icon of the registry editor.  Note the spelling error wait - whait.  After a few seconds of scanning, the program displays a false error message. </p><br><p><img src="https://habrastorage.org/files/01c/db1/22e/01cdb122ee9f4abaa91b63154d328081.png" alt="image"></p><br><p><img src="https://habrastorage.org/files/607/72a/905/60772a9058e34ffba3bfbd4942477cc6.png" alt="image"></p><br><p>  The false message easily deceives the average user, despite the grammatical errors.  If the user clicks on one of the two links, RTM will try to elevate its privileges in the system. </p><br><p>  After selecting one of the two recovery options, the Trojan launches the DLL using the runas option in the ShellExecute function with administrator privileges.  The user will see a real Windows query (see figure below) for elevating permissions.  If the user gives the necessary permissions, the trojan will work with administrator privileges. </p><br><p><img src="https://habrastorage.org/files/d44/e99/191/d44e9919145d4045b10413dbb46c2773.png" alt="image"></p><br><p>  Depending on the default language installed in the system, the trojan displays error messages in Russian or English. </p><br><p>  <strong>4.8.3.</strong>  <strong>Certificate</strong> </p><br><p>  RTM can add certificates in the Windows Store and confirm the reliability of the addition by automatically clicking on the "yes" button in the csrss.exe dialog box.  This behavior is not new, for example, the banking Trojan Retefe also independently confirms the installation of a new certificate. </p><br><p>  <strong>4.8.4.</strong>  <strong>Reverse connection</strong> </p><br><p>  RTM authors also created a Backconnect TCP tunnel.  So far we have not seen the function in operation, but it is intended for remote monitoring of infected PCs. </p><br><p>  <strong>4.8.5.</strong>  <strong>File management node</strong> </p><br><p>  The command C &amp; C server can send the Trojan a command to modify the Windows host file.  The host file is used to create custom DNS permissions. </p><br><p>  <strong>4.8.6.</strong>  <strong>Find and send file</strong> </p><br><p>  The server may request to search and download the file in the infected system.  For example, during the study we received a request for the file 1c_to_kl.txt.  As previously described, this file is generated by the 1C: Enterprise 8 accounting system. </p><br><p>  <strong>4.8.7.</strong>  <strong>Update</strong> </p><br><p>  Finally, RTM authors can update the software by sending a new DLL to change the current version. </p><br><p>  <strong>5. Conclusion</strong> </p><br><p>  The RTM study shows that the Russian banking system still attracts cyber attackers.  Such groups as Buhtrap, Corkow and Carbanak successfully steal money from financial institutions and their clients in Russia.  RTM is a new player in this industry. </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">According to ESET telemetry, malicious RTM tools have been in use since at least the end of 2015. </font><font style="vertical-align: inherit;">The program has a full range of spyware capabilities, including reading smart cards, intercepting keystrokes and monitoring banking operations, as well as searching for 1C: Enterprise 8 transport files.</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The use of a decentralized uncensored top-level domain .bit ensures high infrastructure resilience. </font></font></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/322364/">https://habr.com/ru/post/322364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322350/index.html">Personal experience: TeamCity and character server integration</a></li>
<li><a href="../322352/index.html">As I made the fastest resize of images. Part 1, general optimizations</a></li>
<li><a href="../322354/index.html">Manage application state with Vuex</a></li>
<li><a href="../322360/index.html">Interesting features of Python, which you could not guess</a></li>
<li><a href="../322362/index.html">Red Hat acquires 3scale, which develops API management systems, and intends to open source code of products</a></li>
<li><a href="../322366/index.html">Analytical data outside Wrike analytics</a></li>
<li><a href="../322368/index.html">CSS for Swift: using styles for any subclass of UIView</a></li>
<li><a href="../322370/index.html">Genetic Algorithms and Turing Machine</a></li>
<li><a href="../322372/index.html">We write simple DSL on Kotlin in 2 steps</a></li>
<li><a href="../322374/index.html">Three-letter service quality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>