<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android - Live Wallpaper on OpenGL ES 2.0 with Simplified DOF Effect</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The idea for the creation of the application was the video, in turn, inspired by the design of Deus Ex: Human Revolution, namely its elements with gla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android - Live Wallpaper on OpenGL ES 2.0 with Simplified DOF Effect</h1><div class="post__text post__text-html js-mediator-article">  The idea for the creation of the application was the video, in turn, inspired by the design of Deus Ex: Human Revolution, namely its elements with glass fragments.  For a couple of days, the final vision of the scene matured and as a result, over the weekend, the first version of the finished application was created. <br><br> <a href="http://s1365.photobucket.com/user/Aleksandr_Popov/media/title_zps88207f0f.jpg.html"><img src="https://habrastorage.org/getpro/habr/post_images/dfd/84e/773/dfd84e7732b2603e570c50346a2fbc5f.jpg" alt="photo title_zps88207f0f.jpg"></a> <br><a name="habracut"></a><br><h4>  Building a scene </h4><br>  The scene is extremely simple.  It consists of actually smoothly rotating glass fragments, suspended in the air.  Fragments are divided into 2 groups - located near and far.  Objects in the distance are blurred to add extra volume to the scene.  There is also a blurred background of arbitrary color.  The camera moves left-right according to the movement of the finger on the screen, and thus the fragments move. <br><br>  Technically, this is implemented as follows: Glass fragments are placed along the cylinder around the chamber.  Shards located beyond a certain distance are drawn into a separate texture and blurred.  Together with them the background is drawn also.  First, blurred objects are drawn away and fragments closer to the camera are already drawn on top of them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was in such a simple way that we implemented the simplified depth-of-field (DOF) effect, which is quite enough for this scene.  The full implementation of DOF is somewhat more complicated and more resource-intensive.  This would require rendering into separate textures a map of the depth of the scene, the finished scene, and it again with blur.  And then draw on the screen at the same time a blurry and clear scene, mixing them according to the depth map and the parameters of the camera focus. <br><br><h4>  Implementation </h4><br>  Since all objects in the scene are transparent, the entire rendering is done with different blending modes.  At the same time, the entry in the depth buffer is not conducted so that the transparent glasses do not cut the objects behind them.  Since the glasses themselves are few, this does not cause too large re-drawing of the pixels.  To create highlights and reflections, fragment objects are drawn with a cubemap size 128x128. <br><br><h6>  Background rendering order: </h6><br>  1. Ochitska FBO with glClearColor desired color. <br>  2. A mask is drawn over the entire frame buffer size.  Thus, we obtain decorative colored blurred spots for the background instead of a solid color. <br>  3. Then draw the glass for the background.  The resolution is 256x256, the image is quite pixelated. <br>  4. Blur the entire background.  Low resolution background almost imperceptibly. <br><br> <a href="http://s1365.photobucket.com/user/Aleksandr_Popov/media/bg_zps70ce1ce5.jpg.html"><img src="https://habrastorage.org/getpro/habr/post_images/bd0/c9f/904/bd0c9f904c68008ac8343dab94822a72.jpg" alt="photo bg_zps70ce1ce5.jpg"></a> <br><br><h6>  Drawing the main scene and layout of two plans: </h6><br>  1. Cleaning the screen. <br>  2. Drawing the background. <br>  3. Rendering Foreground Glasses. <br>  This rendering is done without writing to the depth buffer, since all objects are transparent. <br><br> <a href="http://s1365.photobucket.com/user/Aleksandr_Popov/media/fg_zps0f2e8074.jpg.html"><img src="https://habrastorage.org/getpro/habr/post_images/84c/f16/295/84cf16295b201c93b3088cbfc3645b65.jpg" alt="photo fg_zps0f2e8074.jpg"></a> <br><br><h4>  Blur objects in the background. </h4><br>  Blur is implemented by sequential drawing of the image between two frame buffers with a special shader.  The shader can do horizontal or vertical blur, it is set by parameters.  This blur is called ping-pong rendering.  Its essence lies in the fact that first the texture from frame buffer A is drawn with horizontal blur in frame buffer B, and then vice versa from B to A, but with vertical blur.  This procedure can be repeated the necessary number of iterations to achieve the required quality of blurring the original image.  An example of the implementation of this effect of post-processing was taken long ago from some bloom example, unfortunately I can‚Äôt find the link. <br><br>  It is noteworthy that modern phones and tablets (and even very old devices, too) can manage to do not even one, but several iterations of blur fairly quickly.  In practice, it turned out that the Nexus 10 produces a stable 50-40 fps even with 6-8 passes of the texture blur 256x256, with one pass being full - horizontal + vertical blur. <br><br>  Selecting a fairly compromise ratio of texture resolution, number of passes, and blur quality, we stopped at three iterations and a resolution of 256x256. <br><br><h4>  Mali </h4><br>  In the previous article I threw a stone in the nVidia garden.  This is not because I just dislike NVIDIA - I also dislike any other hardware manufacturers that provide buggy drivers for their GPUs.  For example, when developing the described live wallpapers, we encountered a problem on the Nexus 10. The problem is the incorrect rendering into the texture, and this only manifests when the orientation of the device changes.  How the orientation of the tablet can affect the rendering in texture is a mystery to us, but it is a fact. <br><br>  First, in order to make sure that I just missed some nuance when initializing the context, I wrote a question on Stack Overflow: <a href="http://stackoverflow.com/questions/17403197/nexus-10-render-to-external-rendertarget-works-only-in-landscape">stackoverflow.com/questions/17403197/nexus-10-render-to-external-rendertarget-works-only-in- landscape</a> And here it is worth praising ARM employees for the work of those.  support  After a couple of days, I received a letter from an ARM engineer in which he suggested giving a request for this bug to the Mali Developer Center forum.  I prepared a simple test application and described the steps to reproduce the error: <a href="http://forums.arm.com/index.php%3F/topic/16894-nexus-10-render-to-external-rendertarget-works-only-in-landscape/page__gopid__41612">forums.arm.com/index.php?/topic/16894-nexus-10-render-to-external-rendertarget-works-only-in-landscape/page__gopid__41612</a> .  And after only 4 (!) Days, I received an answer that there really is a bug in the current version of the video driver for Nexus 10. The most interesting thing is that ARM offered a workaround to solve my problem, which miraculously helped - you just need to call glViewport ( ) after glBindFramebuffer ().  For such work those.  ARM support they need to put a monument in their lifetime - the ARM employee was not too lazy to find my e-mail (and he is not listed on the Stack Overflow), and those engineers.  ARM support found and solved the problem faster than I even expected. <br><br>  All interested in the quality of Android on Nexus 10, please vote for the corresponding bug in the Google tracker: <a href="http://code.google.com/p/android/issues/detail%3Fid%3D57391">code.google.com/p/android/issues/detail?id=57391</a> <br><br><h4>  Result </h4><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/YOzn3FTp1Nw%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700191,15700253&amp;usg=ALkJrhhWS8hhN0ryG2zN0rHIloq_Uj14kQ" frameborder="0" allowfullscreen=""></iframe><br>  You can download the program from Google Play at the link: <a href="https://play.google.com/store/apps/details%3Fid%3Dorg.androidworks.livewallpaperglass">play.google.com/store/apps/details?id=org.androidworks.livewallpaperglass</a> <br><br>  The described method of the simplified DOF effect can be applied not only to the scene with the same objects as in our application, but also in any other cases where the main scene can be separated from the background. </div><p>Source: <a href="https://habr.com/ru/post/191442/">https://habr.com/ru/post/191442/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191432/index.html">Algorithm for generating a course for the game Scrabble</a></li>
<li><a href="../191434/index.html">Search for vulnerabilities in habrosite</a></li>
<li><a href="../191436/index.html">Automatic code generation in Yii</a></li>
<li><a href="../191438/index.html">Why is not everything normal with normal distribution</a></li>
<li><a href="../191440/index.html">Delegation</a></li>
<li><a href="../191444/index.html">Acer Aspire R7 laptop video review</a></li>
<li><a href="../191446/index.html">Yandex.Disk client for Linux. Cantilevered</a></li>
<li><a href="../191448/index.html">Slightly anonymous</a></li>
<li><a href="../191450/index.html">The rise and fall of the novice phreaker</a></li>
<li><a href="../191452/index.html">Information and analytical system for monitoring and managing road safety</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>