<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The hardware paravirtualization mode will be available in the Xen 4.4 hypervisor and the Linux 3.14 kernel.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Transfer. Original on the Xen blog . 

 From the translator: currently the stable version of the Xen hypervisor supports two virtualization modes. In ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The hardware paravirtualization mode will be available in the Xen 4.4 hypervisor and the Linux 3.14 kernel.</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1bd/d4f/bfb/1bdd4fbfbe80a4594e878ef8c453e30f.png"><br>  <i>Transfer.</i>  <i>Original <a href="http://blog.xen.org/index.php/2014/01/31/linux-3-14-and-pvh/%3Futm_s">on the Xen blog</a></i> . <br><br>  <i>From the translator: currently the stable version of the Xen hypervisor supports two virtualization modes.</i>  <i>In the paravirtual (PV) mode, the equipment is not emulated, and the guest OS must be specially modified to work in such an environment.</i>  <i>Starting with version 3.0, the Linux kernel supports launching in paravirtual mode without recompiling with third-party patches.</i>  <i>The advantage of the PV mode is that it does not require support for hardware virtualization from the CPU, and also does not spend computational (sometimes very significant) resources to emulate hardware on a PCI bus.</i> <i><br></i>  <i>The hardware virtualization mode (HVM) appeared in Xen, starting with version 3.0 of the hypervisor, and requires hardware support.</i>  <i>In this mode, QEMU is used to emulate virtual devices, which is very slow even with paravirtual drivers.</i>  <i>However, over time, support for hardware virtualization in hardware has become so widespread that it is used even in notebook CPUs.</i>  <i>Therefore, developers have a desire to use fast switching of the execution context between the hypervisor and the guest OS and in paravirtual mode, using the capabilities of the equipment.</i>  <i>So a new mode appeared - hardware paravirtualization, which will be available in Xen, starting with version 4.4.</i> <br><a name="habracut"></a><br>  The Linux 3.14 kernel will support the new mode developed by Mukesh Rathor <br>  from Oracle Corporation.  The hardware paravirtualization (PVH) mode allows the guest OS to use the hardware capabilities of the platform, but does not require hardware emulation using QEMU.  This is an impressive step in the evolution of the para-virtual mode. <br><br>  The history and subtleties of the implementation of the PVH regime are described in detail in the article <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/">The Paravirtualization Spectrum, Part 2: From poles to a spectrum</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In short, the guest OS in Xen can now work in hardware virtualization (HVM) or paravirtualization (PV) mode.  In PV mode, the guest OS kernel allows the hypervisor to program tables of memory pages, segments, etc.  If the processor supports EPT / NPT extensions, then the cost of managing the memory in HVM mode (when the guest OS manages memory) is much less than when the hypervisor does in PV mode.  So, in the new mode, the hypervisor does not manage memory and system calls inside the guest OS ‚Äî all this happens inside the virtual machine container. <br><br>  Such a ‚Äúhybrid‚Äù paravirtualization mode is called ‚Äúhardware paravirtualization‚Äù (PVH). <br><br>  The advantages of this approach are in reducing the amount of code, more performance when making system calls (there is no context switching between the guest OS and the hypervisor), less delays in performing various operations, in a word - in a faster response of the guest OS. <br><br>  The code implementing the PVH mode will be available in Xen, starting with version 4.4 (the 3rd release candidate of this version has already been released).  If you compare the new mode with the para-virtualization mode, but there are almost no differences, except that the guest OS runs in HVM mode (but without PCI devices) and runs much faster.  We are still working on the intricacies of ABI in the new mode, so ABI is still unstable. <br><br>  This means that the next version of Xen may not even work with the current version of Linux ABI (and maybe it will).  The new regime is highly experimental and unstable.  We intend to bring it to the level of practical application, and by all means we strive for this goal. <br><br>  It will help us a lot if users try to use the new mode, so that we can track errors and problems that we couldn‚Äôt imagine during the development phase. <br><br>  <b>How to use hardware paravirtualization?</b> <br><ul><li>  Download the latest version of Xen and collect it.  Details can be found on the links <a href="http://wiki.xen.org/wiki/Compiling_Xen_From_Source">wiki.xen.org/wiki/Compiling_Xen_From_Source</a> and <a href="http://wiki.xen.org/wiki/Xen_4.4_RC3_test_instructions">wiki.xen.org/wiki/Xen_4.4_RC3_test_instructions</a> </li><li>  Download the latest version of the Linux kernel.  Details by reference <a href="http://wiki.xenproject.org/wiki/Mainline_Linux_Kernel_Configs">wiki.xenproject.org/wiki/Mainline_Linux_Kernel_Configs#Configuring_the_Kernel</a> <br>  cd $ HOME <br>  git clone git: //git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git <br>  cd linux </li><li>  Build the kernel with the CONFIG_XEN_PVH = y option <br><ul><li>  Configuration based on your distro's kernel settings <br>  cp / boot / config-`uname -r `$ HOME / linux / .config <br>  make menuconfig <br>  then select Processor type and features -&gt; Linux guest support -&gt; Support for running as a PVH guest (NEW) in the menu </li><li>  If you prefer to edit the .config file, you should indicate in it: <br>  CONFIG_HYPERVISOR_GUEST = y <br>  CONFIG_PARAVIRT = y <br>  CONFIG_PARAVIRT_GUEST = y <br>  CONFIG_PARAVIRT_SPINLOCKS = y <br>  CONFIG_XEN = y <br>  CONFIG_XEN_PVH = y <br>  You should also include block and network devices, console, etc. </li></ul></li><li>  Compile and install the kernel. <br>  make modules_install &amp;&amp; install <br>  You should also create a boot image (initrd), copy it and the kernel to the / boot directory and configure the boot loader. </li><li>  Start the guest OS with the pvh = 1 parameter, for example: <br>  extra = "console = hvc0 debug kgdboc = hvc0 nokgdbroundup initcall_debug debug" <br>  kernel = "/ boot / vmlinuz-3.13 +" <br>  ramdisk = "/ boot / initramfs-3.13 + .cpio.gz" <br>  memory = 1024 <br>  vcpus = 4 <br>  name = "pvh" <br>  vif = ['mac = 00: 0F: 4B: 00: 00: 68'] <br>  vfb = ['vnc = 1, vnclisten = 0.0.0.0, vncunused = 1'] <br>  disk = ['phy: / dev / sdb1, xvda, w'] <br>  pvh = 1 <br>  on_reboot = "preserve" <br>  on_crash = "preserve" <br>  on_poweroff = "preserve </li><li>  Use the xl utility, the xm utility does not support the new mode. </li></ul><br>  The guest OS will boot as paravirtual, but the xen-detect utility will show that it is running in hardware virtualization mode. <br><br>  <b>The following features have not been tested:</b> <br><ul><li>  Virtual Machine Migration </li><li>  32-bit OS in guest mode (do not even try them in PVH mode) </li><li>  Forwarding PCI devices </li><li>  Working in hypervisor mode (dom0) - patches for this have not yet been taken to the main branch of the Xen code.  If you want to try, you can use a branch from Mukesh Razor: <br>  cd $ HOME / xen <br>  git pull git: //oss.oracle.com/git/mrathor/xen.git dom0pvh-v7 <br>  In this case, when loading, transfer the Xen parameter <b>dom0pvh = 1</b> .  Guest OS in this mode is not supported yet. </li></ul><br><br>  <b>The following functions do not work:</b> <br><ul><li>  Filtering processor identification command output (CPUID).  Now the result of the team is passed to the guest without changes. </li><li>  Hardware virtualization on the AMD platform </li><li>  Run 32-bit guest OS </li></ul><br><br>  If you find an error, please send us the following information to xen-devel@lists.xenproject.org: <br><ul><li>  xl dmesg </li><li>  xl list </li><li>  xenctx -s $ HOME / linux / System.map -f -a -C [domain id] </li><li>  Output the guest OS console </li><li>  Everything else that seems important to you </li></ul><br><br>  Please save your kernel images (vmlinuz).  We may need them in the future, but they are too large to send them via e-mail. </div><p>Source: <a href="https://habr.com/ru/post/211034/">https://habr.com/ru/post/211034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211024/index.html">Proxmox API. Introduction</a></li>
<li><a href="../211026/index.html">You like to read exciting books - love and wear a vest ...</a></li>
<li><a href="../211028/index.html">Browser game "Cyberset" - continued</a></li>
<li><a href="../211030/index.html">Google enters into a contract with the sea driver</a></li>
<li><a href="../211032/index.html">How to create a web page. Part 2 - Bootstrap</a></li>
<li><a href="../211040/index.html">Sometimes free lunches do happen.</a></li>
<li><a href="../211042/index.html">Capture filters for network analyzers (tcpdump, Wireshark, Paketyzer)</a></li>
<li><a href="../211044/index.html">Welcome to Moscow PM 06/02</a></li>
<li><a href="../211046/index.html">Curiosity explores the way through the sand dunes</a></li>
<li><a href="../211050/index.html">Chef for 21 days. Part Three Chef and AWS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>