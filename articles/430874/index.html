<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transition to Google Cloud Platform (Google Cloud Platform - GCP)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[part 2 of 2] 


 [part 1 of 2] 





 How we did it 


 We decided to switch to GCP to improve application performance ‚Äî while increasing the scale, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transition to Google Cloud Platform (Google Cloud Platform - GCP)</h1><div class="post__text post__text-html js-mediator-article"><h3 id="chast-2-iz-2">  [part 2 of 2] </h3><br><p>  <a href="https://habr.com/company/southbridge/blog/427347/">[part 1 of 2]</a> </p><br><img src="https://habrastorage.org/webt/6m/2c/sx/6m2csxdumpxfx00xrft85x4vdng.png"><br><p><br></p><br><h2 id="kak-nam-eto-udalos">  How we did it </h2><br><p>  We decided to <a href="https://blog.hike.in/migration-to-google-cloud-platform-gcp-17c397e564b8">switch to GCP</a> to improve application performance ‚Äî while increasing the scale, but without significant costs.  The whole process took more than 2 months.  To solve this problem, we have formed a special group of engineers. </p><br><p>  In this publication we will talk about the chosen approach and its implementation, as well as how we managed to achieve the main goal - to carry out this process as smoothly as possible and transfer the entire infrastructure to the cloud platform of the Google Cloud Platform, without compromising the quality of customer service. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/5d3/693/ee65d3693b51048de4322274109bd23d.png" alt="image"></p><a name="habracut"></a><br><h2 id="planirovanie">  Planning </h2><br><ol><li>  A detailed checklist has been prepared defining each possible step.  Created a flowchart to describe the sequence. </li><li>  A plan to return to the original state, which we, if anything, could use. </li></ol><br><p>  Several brainstorming sessions - and we have identified the most understandable and simple approach for implementing the ‚Äúactive-active‚Äù scheme.  It lies in the fact that a small set of users is located on one cloud, and the rest - on the other.  However, this approach caused problems, especially on the client side (related to DNS management), and caused delays in database replication.  Because of this, it was almost impossible to implement it safely.  The obvious method did not give the desired solution, and we had to develop a specialized strategy. </p><br><p>  Based on the dependency diagram and operational security requirements, we divided infrastructure services into 9 modules. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/290/5eb/c21/2905ebc2190ea9f8d480e5532a196a1f.jpg" alt="image"></p><br><p>  <em>(Basic modules for infrastructure hosting deployment)</em> </p><br><p>  Each infrastructure group managed common internal and external services. </p><br><p>  ‚äπ <strong>Infrastructure messaging service</strong> : MQTT, HTTPs, Thrift, Gunicorn server, queuing module, Async client, Jetty server, Kafka cluster. <br>   <strong>Data Warehouse Services</strong> : MongoDB, Redis, Cassandra, Hbase, MySQL, and MongoDB distributed cluster. <br>  ‚äπ <strong>Infrastructure analysis service</strong> : Kafka cluster, data storage cluster (HDFS, HIVE). </p><br><h2 id="podgotovka-k-znamenatelnomu-dnyu">  Preparing for a momentous day: </h2><br><p>  ‚úì Detailed GCP transition plan for each service: sequence, data storage, reset plan. <br>  ‚úì Inter-project network interactions (shared virtual private cloud VPC [XPN]) in the GCP to isolate various parts of the infrastructure, optimize management, increase security and connectivity. <br>  ‚úì Multiple VPN tunnels between the GCP and the running Virtual Private Cloud (VPC) to simplify the transfer of large amounts of data across the network during the replication process, as well as for possible later deployment of a parallel system. <br>  ‚úì Automate the installation and configuration of the entire stack using Chef. <br>  ‚úì Scripts and automation tools for deploying, monitoring, logging, etc. <br>  ‚úì Configure all required subnets and managed firewall rules for the system flow. <br>  ‚úì Replication in multiple data centers (Multi-DC) for all storage systems. <br>  ‚úì Configure load balancers (GLB / ILB) and groups of managed instances (MIG). <br>  ‚úì Scripts and code for transferring the object storage container to the GCP Cloud Storage cloud storage with checkpoints. </p><br><p>  Soon we completed all the necessary prerequisites and prepared a checklist of the elements for transferring the infrastructure to the GCP platform.  After numerous discussions, as well as taking into account the number of services and their dependency diagram, we decided to transfer the cloud infrastructure to GCP over three nights to cover all the server-side services and data storage. </p><br><h2 id="perehod">  Transition </h2><br><h3 id="strategiya-perenosa-balansirovschika-nagruzki">  Load Balancer Transfer Strategy: </h3><br><p>  We used the previously managed HAProxy cluster to replace the global load balancer to handle tens of millions of active users daily connections. </p><br><p>  ‚äπ <strong>Stage 1:</strong> </p><br><ul><li>  Created by MIG with packet forwarding rules to forward all traffic to the MQTT IP addresses in the existing cloud. </li><li>  Created SSL balancer and TCP Proxy with MIG as server side. </li><li>  For MIG, HAProxy is running with MQTT servers as server side. </li><li>  The weighting factor has been added to the DNS in the routing policy with the external IP address of GLB. </li></ul><br><p>  Gradually deployed user connections while tracking their performance. </p><br><p>  ‚äπ <strong>Stage 2:</strong> Intermediate phase transition, beginning service deployment in GCP. <br>  <strong>Stage 3:</strong> The final stage of the transition, all services are transferred to the GCP. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebb/fcb/614/ebbfcb614345c40b20de5c9e8edd9a8e.png" alt="image"></p><br><p>  <em>(Stages transfer load balancer)</em> </p><br><p>  At this stage, everything worked as expected.  Soon it was time to deploy several internal HTTP services in GCP with routing ‚Äî given the weight of the coefficients.  We closely followed all indicators.  When we began to gradually increase traffic, then one day before the planned transition, delays during VPC interaction over VPN (delays of 40 ms - 100 ms were recorded, although they were less than 10 ms before) increased. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b6c/af5/3bc/b6caf53bc304c2fd42c9342dd11faf82.png" alt="image"></p><br><p>  <em>(Snapshot network latency check when two VPCs interact)</em> </p><br><p>  Monitoring clearly showed that there is something wrong with both cloud-based network channels using VPN tunnels.  Even the throughput of the VPN tunnel did not reach the optimal level.  This situation has begun to negatively affect some of our user services.  We immediately returned all previously transferred HTTP services to their original state.  I contacted the TAM and cloud services support teams, provided the necessary source data and started to figure out why the delays are growing.  The support specialists concluded that the maximum network bandwidth in the cloud channel between the two cloud service providers was reached.  From here and growth of delays in a network at transfer of internal systems. </p><br><p>  This incident forced to suspend the transition to the cloud.  Cloud service providers could not double the bandwidth fast enough.  Therefore, we returned to the planning stage and revised the strategy.  We decided to transfer the cloud infrastructure to GCP overnight instead of three, and included in the plan all the server-side and data storage services.  When the ‚ÄúX‚Äù hour arrived, everything went like clockwork: the workloads were successfully transferred to Google Cloud without being noticed by our users! </p><br><h2 id="strategiya-perenosa-bazy-dannyh">  Database migration strategy: </h2><br><p>  It was necessary to transfer more than 50 database endpoints for a relational DBMS, in-memory storage, as well as NoSQL and low-latency distributed and scalable clusters.  Replicas of all databases we placed in GCP.  This was done for all deployments, with the exception of HBase. </p><br><p>   <strong>master-slave replication:</strong> implemented for MySQL, Redis, MongoDB and MongoS clusters. <br>  ‚äπ <strong>Multi-DC Replication:</strong> implemented for Cassandra clusters. <br>  ‚äπ <strong>Dual Clusters: a</strong> parallel cluster was configured for Hbase in GCP.  Existing data was transferred, a double entry was set up in accordance with the strategy for maintaining data consistency in both clusters. </p><br><p>  In the case of HBase, the problem was to configure with Ambari.  We encountered some difficulties when placing clusters in several data centers, for example, there were problems with the DNS, the rack recognition script, and so on. </p><br><p>  The final steps (after the servers were migrated) included moving the replicas to the main servers and disabling the old databases.  As planned, determining the order of database transfer, we used Zookeeper for the necessary configuration of application clusters. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/550/4e6/6d3/5504e66d3db5f8e35db7eccbfb1cfa6e.png" alt="image"></p><br><h2 id="strategiya-perenosa-sluzhb-prilozheniy">  Application Services Migration Strategy </h2><br><p>  We used the lift-and-shift approach to transfer the application services workloads from the current hosting to the GCP cloud.  For each application service, we created a group of managed instances (MIG) with automatic scaling. </p><br><p>  In accordance with the detailed plan, we began to transfer services to GCP, taking into account the sequence and dependencies of data warehouses.  All messaging stack services have been ported to GCP without the slightest downtime.  Yes, there were some minor failures, but we dealt with them immediately. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b1b/70f/159/b1b70f159f2698731b5b6e166afa1079.png" alt="image"></p><br><p>  Since the morning, as the activity of users increased, we closely followed all information panels and indicators to quickly identify problems.  Some difficulties and the truth arose, but we were able to quickly eliminate them.  One of the problems was due to the limitations of the internal load balancer (ILB), capable of serving no more than 20,000 simultaneous connections.  And we needed 8 times more!  Therefore, we added additional ILBs to our compound management layer. </p><br><p>  During the first hours of the peak load after the transition, we controlled all parameters especially carefully, since the entire load of the messaging stack was transferred to the GCP.  There were a few minor glitches, which we very quickly figured out.  When migrating other services, we followed the same approach. </p><br><h2 id="perenos-hranilischa-obektov">  Transferring object storage: </h2><br><p>  We use the object storage service mainly in three ways. </p><br><p>  ‚äπ Storage of media files sent to a personal or group chat.  The retention period is determined by the lifecycle management policy. <br>  ‚äπ Storage of images and thumbnails of a user profile. <br>  ‚äπ Storage of media files from the ‚ÄúHistory‚Äù and ‚ÄúTimeline‚Äù sections and corresponding thumbnails. </p><br><p>  We used Google's storage transfer tool to copy old objects from S3 to GCS.  We also used a custom Kafka-based MIG to transfer objects from S3 to GCS when special logic was required. </p><br><h3 id="perehod-s-s3-na-gcs-vklyuchal-sleduyuschie-shagi">  The transition from S3 to GCS included the following steps: </h3><br><p>  ‚óè For the first use case of the object storage, we began to write new data in both S3 and GCS, and after the expiration date, we began to read data from GCS using the application-side logic.  Transferring old data does not make sense, and this approach is cost-effective. <br>  ‚óè For the second and third use cases, we started recording new objects in GCS and changed the path for reading data so that the search is first performed in GCS and only then, if the object is not found, in S3. <br>  The planning, validation of the concept, preparation and prototyping took <strong>months</strong> , but then we decided to go and implemented it very quickly.  We assessed the risks and realized that fast migration is preferable and almost imperceptible. <br>  This large-scale project has helped us take confident positions and increase team productivity in many areas, since most of the manual operations for managing cloud infrastructure are now in the past. <br>  ‚óè As for the users, we now have everything necessary to ensure the highest quality of their service.  Downtime has almost disappeared, and new features are being introduced faster. <br>  ‚óè Our team spends less time on maintenance tasks and can focus on automation projects and creating new tools. <br>  ‚óè We have access to an unprecedented set of tools for working with big data, as well as ready-made functionality for machine learning and analysis.  See details <a href="https://blog.hike.in/moving-to-bigquery-data-at-our-fingertips-2273a71252ce">here.</a> <br>  ‚óè Google Cloud‚Äôs commitment to the open source <a href="https://kubernetes.io/">Kubernetes</a> project <a href="https://kubernetes.io/">is</a> also in line with our development plan for this year. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/430874/">https://habr.com/ru/post/430874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430864/index.html">Matches is not a toy?</a></li>
<li><a href="../430866/index.html">Beijing will introduce a social rating for residents of the city in 2020</a></li>
<li><a href="../430868/index.html">What you need to remember when buying NGFW? Check list</a></li>
<li><a href="../430870/index.html">Installing BigBlueButton on Ubuntu 16.04</a></li>
<li><a href="../430872/index.html">Who wins the mesh versus ESB debate</a></li>
<li><a href="../430876/index.html">Development through testing: improving skills</a></li>
<li><a href="../430878/index.html">PhpStorm 2018.3 Available</a></li>
<li><a href="../430880/index.html">Another implementation of Data Processing</a></li>
<li><a href="../430882/index.html">Xiaomi Aqara Switch rework from ZigBee to Z-Wave</a></li>
<li><a href="../430884/index.html">Printing Factory: Why LANIT-Integration has launched its own ‚Äúprinting house‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>