<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Juniper MX + IX + SynFlood</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I would like to talk about one fairly simple method of protection against Syn Flood attacks on Juniper MX series routers. This method...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Juniper MX + IX + SynFlood</h1><div class="post__text post__text-html js-mediator-article">  In this article, I would like to talk about one fairly simple method of protection against <a href="https://en.wikipedia.org/wiki/SYN_flood">Syn Flood</a> attacks on Juniper MX series routers.  This method can help with several conditions, which are described below.  Of course, there are hardware and software solutions, technologies <a href="https://en.wikipedia.org/wiki/SYN_cookies">Syn Cookies</a> , Syn Proxy and others.  But, sometimes, it turns out that most of the traffic is blocked on the router without the use of additional mechanisms or expensive devices.  Since we used to configure some articles of our <a href="https://habrahabr.ru/post/186566/">colleagues</a> for the router, we decided to share our experience, it is quite specific, but we hope it will be useful.  An example of such an attack is shown in the chart below. <br><img src="https://habrastorage.org/files/0b0/81f/23f/0b081f23f4f04a57abf764ee3d6858d5.png"><br><a name="habracut"></a><br><h2>  Some theory </h2><br>  <b>Syn Flood</b> is one of the types of network attacks such as denial of service, which consists in sending a large number of SYN requests in a relatively short time.  The SYN packet itself is small in size (with data link headers of 54+ bytes), even with a 1G band, you can generate a large number of packets per second.  Some providers do not prohibit sending packets with a substitute source address from their network, and even one server with a 1G band hosted by such a provider can generate an attack that creates many problems.  Most Internet providers for end users do not release packages from their network with a fake source address and, as a result, most of the attacks are coming from DC‚Äôs clients, while the number of attacking machines is small. <br><br><h2>  What can be done on the Router? </h2><br>  Initially, we need to proceed from the fact that we have good connectivity and many traffic exchange points are connected.  Of course, if you have a single UPLINK and, suppose, Syn Flood comes from the same machine, you can try to analyze the traffic, and if the person who organizes the DDOS is completely lazy and has not taken care of different <a href="https://en.wikipedia.org/wiki/Time_to_live">ttl</a> , you can block traffic by ttl + dst ip.  In this case, all traffic with the current ttl will be cut off - this is certainly better than if the server was lying completely, but not optimally. <br><br>  Currently, in my <a href="http://beget.ru/">work,</a> in addition to backbone providers and providers providing incomplete connectivity, such traffic exchange points are connected, such as: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  DataIX </li><li>  Cloud IX </li><li>  Pirix </li><li>  WIX </li><li>  Spbix </li><li>  Mskyx </li><li>  Codix </li><li>  Globalix </li><li>  Ihome </li></ul><br>  Quite a large number of providers, data centers and service providers are connected to data <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25BE%25D1%2587%25D0%25BA%25D0%25B0_%25D0%25BE%25D0%25B1%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B0_%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D0%25BD%25D0%25B5%25D1%2582-%25D1%2582%25D1%2580%25D0%25B0%25D1%2584%25D0%25B8%25D0%25BA%25D0%25BE%25D0%25BC">IX</a> .  Most of them provide L2 connectivity between participants.  Using these facts, you can simply locate the source of the attack if traffic goes through IX. <br><br><h2>  How to do it </h2><br>  Initially, you need to connect IX to a separate virtual-switch - to be able to filter by MAC addresses.  That is, even if the src address is changed, the packets will come with the src MAC address of the border router.  For example, we can assume that we only connected DataIX and the anomalous traffic goes through it. <br><br><div class="spoiler">  <b class="spoiler_title">Connection Configuration IX</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">interfaces { xe<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> { description "UPLINK_IX: DATAIX XX.XX.XX.XX 255.255.252.0 (path XXX);"; flexible-vlan-tagging; native-vlan-id <span class="hljs-number"><span class="hljs-number">20</span></span>; encapsulation flexible-ethernet-services; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { encapsulation vlan-bridge; vlan-id <span class="hljs-number"><span class="hljs-number">20</span></span>; } } irb { unit <span class="hljs-number"><span class="hljs-number">20</span></span> { description "DataIX route interface"; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { #    } address XX.XX.XX.XX/<span class="hljs-number"><span class="hljs-number">22</span></span>; } } } } firewall { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> bridge { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> ix_mac_filter { #   } } } protocols { bgp { <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> dataix { #  BGP } } } routing-instances { switch_dataix { description "DATAIX - prometey XX.XX.XX.XX 255.255.252.0"; instance-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> virtual-switch; bridge-domains { switch_dataix_bridge { <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> bridge; vlan-id <span class="hljs-number"><span class="hljs-number">20</span></span>; interface xe<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">3</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span>; routing-interface irb<span class="hljs-number"><span class="hljs-number">.20</span></span>; forwarding-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> ix_mac_filter; } } } } } }</code> </pre> </div></div><br>  Then you can see the MAC addresses that came from this IX: <br><blockquote><pre>  root @ rt01&gt; show bridge mac-table
 MAC flags (S -static MAC, D -dynamic MAC, L -locally learned, C -Control MAC
            SE -Statistics enabled, NM -Non configured MAC, R -Remote PE MAC)

 Routing instance: switch_dataix
  Bridging domain: switch_dataix_bridge, VLAN: 20
    MAC MAC Logical NH RTR
    address flags interface Index ID
    00: 01: e8: a3: ed: 20 D, SE xe-0/3 / 0.0      
    00: 03: fe: 0a: ac: 00 D, SE xe-0/3 / 0.0      
    00: 04: 80: f4: bc: 00 D, SE xe-0/3 / 0.0      
    00: 04: 96: 51: ba: 84 D, SE xe-0/3 / 0.0      
    00: 04: 96: 52: 05: a4 D, SE xe-0/3 / 0.0      
    00: 04: 96: 52: 05: ea D, SE xe-0/3 / 0.0      
    00: 04: 96: 52: 06: 14 D, SE xe-0/3 / 0.0      
    00: 04: 96: 6d: 13: a9 D, SE xe-0/3 / 0.0      
    00: 04: 96: 6d: 14: 79 D, SE xe-0/3 / 0.0      
    00: 04: 96: 6d: 17: 79 D, SE xe-0/3 / 0.0      
    00: 04: 96: 6d: 52: 3e D, SE xe-0/3 / 0.0      
    00: 04: 96: 6d: 5b: 26 D, SE xe-0/3 / 0.0      
    00: 04: 96: 6d: 6f: f0 D, SE xe-0/3 / 0.0      
    00: 04: 96: 7d: bf: 68 D, SE xe-0/3 / 0.0      
    00: 04: 96: 7d: f8: 99 D, SE xe-0/3 / 0.0      
 ... </pre></blockquote>  And based on this data, you can create a filter that will count the number of packets that came from the MAC address to the server being attacked: <br><blockquote><pre>  filter ix_mac_filter {
     term 00: 01: e8: a3: ed: 20 {
         from {
             source-mac-address {
                 00: 01: e8: a3: ed: 20/48;
             }
             ip-destination-address {
                 # address of the attacked server
             }
         }
         then {
             count 00: 01: e8: a3: ed: 20;
             accept;
         }
     }
     term 00: 03: fe: 0a: ac: 00 {
         from {
             source-mac-address {
                 00: 03: fe: 0a: ac: 00/48;
             }
             ip-destination-address {
                 # address of the attacked server
             }
         }
         then {
             count 00: 03: fe: 0a: ac: 00;
             accept;
         }
     }
     term other {
         then {
             count other;
             accept;
         }
     } </pre></blockquote>  Judging by the documentation in the Juniper MX series routers, there is a limit of 1024 rules with the counter action, but we did not rest on this limit.  We reset the state of the counters in this filter and after some time (1-2 minutes) we look at the result: <br><blockquote><pre>  root @ rt01&gt; clear firewall filter ix_mac_filter  
 root @ rt01&gt; show firewall filter ix_mac_filter                               

 Filter: ix_mac_filter                                          
 Counters:
 Name Bytes Packets
 00: 01: e8: a3: ed: 20 142632382856 288079929
 00: 02: 4a: 2f: a0: 1a 5159885 75880
 00: 03: fe: 0a: ac: 00 14915791420 72085522
 00: 04: 96: 6d: 6f: f0 2508125168 35985837
 00: 04: 96: 7d: f8: 99 362692758 5352205
 00: 04: 96: 82: 4d: 57 216046092 2851369
 ... </pre></blockquote><br>  And, if there is an anomaly, we look at what IP address is associated with this MAC address, then we see who owns it, and, if it is not a gateway, set the reject policy.  Thereby minimizing the effects of the attack. <br><br>  Of course, this is not a panacea, part of the Internet is blocked, but, in most cases, it is data center boarders - they are not our traffic consumers.  The blocking is quite simple and, for example, if there are no other means, this protection is fully justified.  When the process is fully automated, it allows you to understand where the attack is coming from and whether several teams can handle it, which greatly simplifies life. <br><br>  ps  After installation in one DPCe and MPC chassis, this scheme began to work not quite correctly, some of the packets in the filter just do not appear.  If someone tells you why, I will be grateful. </div><p>Source: <a href="https://habr.com/ru/post/278613/">https://habr.com/ru/post/278613/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278601/index.html">WG Labs Announces Developer Contest</a></li>
<li><a href="../278603/index.html">Build FreeType library for Android x86 using NDK</a></li>
<li><a href="../278605/index.html">The history of one technology. Mob</a></li>
<li><a href="../278607/index.html">libuniset2 is a library for creating ACS. It‚Äôs better to see once ... Part 5 (uniset2-testsuite)</a></li>
<li><a href="../278611/index.html">Reverse engineering "Kazakov", part two: increase the queue</a></li>
<li><a href="../278615/index.html">ZeroNet - A truly distributed network - a year later</a></li>
<li><a href="../278617/index.html">Vivaldi Beta 3 browser release</a></li>
<li><a href="../278619/index.html">EDA approach in Angular</a></li>
<li><a href="../278621/index.html">Selection of materials for the novice developer of JavaScript games</a></li>
<li><a href="../278623/index.html">Humane VimScript: minimalistic object orientation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>