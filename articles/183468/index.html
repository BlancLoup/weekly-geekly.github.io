<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Forwarding a video card in KVM from under ubuntu</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 About two years ago I decided to switch completely to Linux, but the need for a Vend did not fall, so I always kept 2 operating systems. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Forwarding a video card in KVM from under ubuntu</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  About two years ago I decided to switch completely to Linux, but the need for a Vend did not fall, so I always kept 2 operating systems.  About a month ago I tried to install VirtualBox and install Windows on it, in general I liked working with 2 operating systems, but there was one problem, I program only computer graphics and I needed support for OpenGL 3.3 and higher, unfortunately VirtualBox did not provide me such opportunities.  Googling stumbled upon such a thing as Xen, tried for a long time to do something on it, in the end nothing came of it, most likely because of the main video card, nVidia GeForce 580 GTX, the hypervisor simply did not want to run even ubuntu, let alone Windows.  I started looking for other hypervisors, and came across KVM, I had to tinker with it, but in the end it all worked. <br><br><h4>  Configuration </h4><br>  So, we will need: <br><ul><li>  Processor with support for virtualization (in Intel - this is VT-d, in AMD - AMD-Vi).  Important: the chipset must also support this technology. </li><li>  Motherboard with I / O Memory Control Unit (IOMMU) </li><li>  Two video cards, for guest OS it is desirable to use an AMD video card, since  with her problems should not be.  NVidia video cards do not work. </li></ul><br>  My configuration: <br><ul><li>  AMD Phenom II x4 Processor </li><li>  ASUS M5A99X EVO R2.0 motherboard </li><li>  Video Card for Ubuntu: NVidia GeForce 580 GTX </li><li>  Guest OS Video Card: AMD Radeon HD 5800 </li></ul><br><a name="habracut"></a><br><h4>  Training </h4><br>  First you need to reboot into the BIOS and enable IOMMU.  To check if IOMMU for AMD is working: <br><br> <code>dmesg | grep -iE "(IOMMU|AMD-Vi)"</code> <br> <br>  or for Intel: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>dmesg | grep -iE "(IOMMU|VT-d)"</code> <br> <br>  Now you need to enable iommu in grub.  Open / etc / default / grub, look for GRUB_CMDLINE_LINUX, bring it to the form: <br><br> <code>GRUB_CMDLINE_LINUX="max_loop=64 iommu=pt iommu=1 amd_iommu=fullflush"</code> <br> <br>  Thus, we are increasing the number of LOOP devices, including IOMMU support for AMD.  If everything has become flattened when you boot the operating system (usually this is because of 2x video cards), add the nomodeset to the previous line, we get: <br><br> <code>GRUB_CMDLINE_LINUX="nomodeset max_loop=64 iommu=pt iommu=1 amd_iommu=fullflush"</code> <br> <br>  Also, to reduce glitches, you can prohibit downloading drivers from AMD (if you have both graphics cards from AMD, then you should not do this) by adding them to the blacklist.  Open /etc/modprobe.d/blacklist.conf and add the following: <br><br> <code>blacklist fglrx</code> <br> <code>blacklist radeon</code> <br> <br>  Now you need to prepare a video card for forwarding, disconnecting it from the driver on the host and connecting it to the pci-stub.  To select our map, enter lspci and look for our map: <br><br> <code>02:00.0 VGA compatible controller: Advanced Micro Devices [AMD] nee ATI Cypress PRO [Radeon HD 5850]</code> <br> <code>02:00.1 Audio device: Advanced Micro Devices [AMD] nee ATI Cypress HDMI Audio [Radeon HD 5800 Series]</code> <br> <br>  in my case, this is 02: 00.0 and 02: 00.1.  02: 00.1 is the sound chip.  The video card is visible as video and audio, so they should be transferred together. <br>  Then, we need vendor id and device id.  you can see it by running lspci with the key -n <br><br> <code>02:00.0 0300: 1002:6899</code> <br> <code>02:00.1 0403: 1002:aa50</code> <br> <br>  Now let's connect our devices to the pci-stub.  Video card: <br><br> <code>echo "1002 6899" &gt; /sys/bus/pci/drivers/pci-stub/new_id</code> <br> <code>echo "0000:02:00.0" &gt; /sys/bus/pci/devices/0000\:02\:00.0/driver/unbind</code> <br> <code>echo "0000:02:00.0" &gt; /sys/bus/pci/drivers/pci-stub/bind</code> <br> <br>  Please note that there is no colon in between VendorID and DeviceID. <br>  Sound card: <br><br> <code>echo "1002 aa50" &gt; /sys/bus/pci/drivers/pci-stub/new_id</code> <br> <code>echo "0000:02:00.1" &gt; /sys/bus/pci/devices/0000\:02\:00.1/driver/unbind</code> <br> <code>echo "0000:02:00.1" &gt; /sys/bus/pci/drivers/pci-stub/bind</code> <br> <br>  for convenience, you can write a script and add it to autorun. <br><br><div class="spoiler">  <b class="spoiler_title">Show script</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash hostgr="0000:02:00.0" hostau="0000:02:00.1" grid="1002 6899" auid="1002 aa50" # echo $grid &gt; "/sys/bus/pci/drivers/pci-stub/new_id" echo $hostgr &gt; "/sys/bus/pci/devices/$hostgr/driver/unbind" echo $hostgr &gt; "/sys/bus/pci/drivers/pci-stub/bind" echo $auid &gt; "/sys/bus/pci/drivers/pci-stub/new_id" echo $hostau &gt; "/sys/bus/pci/devices/$hostau/driver/unbind" echo $hostau &gt; "/sys/bus/pci/drivers/pci-stub/bind"</span></span></code> </pre></div></div><br><h4>  Installation </h4><br>  First you need to install several packages: <br><br> <code>sudo apt-get install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils</code> <br> <br>  This is an installation on a server without gui; for convenient work with kvm, we also install virt-manager: <br><br> <code>sudo apt-get install virt-manager</code> <br> <br>  After this, the menu item ‚ÄúVirtual Machine Manager‚Äù should appear in the menu. <br>  Next we pass the option allow_unsafe_assigned_interrupts = 1 to the kvm module.  Create a file in /etc/modprobe.d/kvm.conf with the contents and reload the module. <br><br> <code>options kvm allow_unsafe_assigned_interrupts=1</code> <br> <br>  Next, run the virt-manager, a window will appear: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc8/773/bf6/dc8773bf6793a60852ba5278f28935fc.png" alt="image"><br><br>  Right-click on localhost and select New or click on the monitor on the left in the panel.  Then follow the instructions to create a virtual machine.  After installing the system, we can forward the devices we need.  Enter the View-&gt; Details menu.  A window like this should appear: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16a/905/65b/16a90565bf21a764d908d3f08060127f.png" alt="image"><br><br>  Click on the Add hardware button, select the PCI Host Device, and look for our video card.  The same should be done with the sound chip from the video card.  In the same way, you can forward USB hosts to make them work, you should indicate in the Controller USB in the field Model: USB2. <br>  When launching, our adapter should appear in the computer‚Äôs devices: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/772/c64/569/772c64569a59f10b5bc1f1fdd923ff28.png" alt="image"><br><br>  The next thing we need to do is download the driver.  Download from the manufacturer‚Äôs website and install it into the system.  When I tried to install the driver, the system desperately went to BSOD, I decided to fix this problem by installing a newer Windows.  You can also try installing the driver through the device manager, but with me it just hung. <br>  To finish, turn off the virtual machine and restart the computer, if this is not done, the system can go back to BSOD when it is restarted. <br>  At the moment, kvm, when restarting a guest with a forwarding video card, hangs the entire system, so if you turn off the virtual machine, you will also have to restart the entire computer. <br><br><h4>  Total </h4><br>  Now, after starting, the virtual machine console will turn off after loading the video card driver, in the case of Windows 7, the ‚ÄúStarting Windows‚Äù picture remains there, but the image itself should already be output to the forwarded video card.  Although the image will not be displayed at the console, nevertheless it will transfer data from input devices and it will be possible to control the guest from the keyboard and mouse like a regular virtual machine. <br>  We cling the second monitor to the pro-forward video card, and we admire the work done. <br>  Lastly, a screenshot of the system performance evaluation: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ff/110/8f9/1ff1108f9458a9d16b7eb0be480456ec.png" alt="image"><br><br><h4>  Sources </h4><br>  <a href="https://help.ubuntu.com/community/KVM">help.ubuntu.com/community/KVM</a> <br>  <a href="http://www.linux.org.ru/wiki/en/%25D0%259F%25D1%2580%25D0%25BE%25D0%25B1%25D1%2580%25D0%25BE%25D1%2581_%25D0%25B2%25D0%25B8%25D0%25B4%25D0%25B5%25D0%25BE%25D0%25BA%25D0%25B0%25D1%2580%25D1%2582%25D1%258B_%25D0%25B2_%25D0%25B2%25D0%25B8%25D1%2580%25D1%2582%25D1%2583%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%2583%25D1%258E_%25D0%25BC%25D0%25B0%25D1%2588%25D0%25B8%25D0%25BD%25D1%2583">www.linux.org.ru/wiki/en/Pro_Video_Card_in_Virtual_Machine</a> </div><p>Source: <a href="https://habr.com/ru/post/183468/">https://habr.com/ru/post/183468/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../183454/index.html">Return by value and const variables in C ++ 11</a></li>
<li><a href="../183458/index.html">Mobile Web Development: HTML5 Android App</a></li>
<li><a href="../183460/index.html">Amazon has a section on selling 3D printers.</a></li>
<li><a href="../183462/index.html">Practice of using XOR in programming</a></li>
<li><a href="../183466/index.html">Wall mounted aircraft, jumping glider and quadrocopter on the ceiling</a></li>
<li><a href="../183470/index.html">Lock audio records Vkontakte. Restore playlist</a></li>
<li><a href="../183474/index.html">RF Government Decree No. 539, or Wi-Fi Legalize</a></li>
<li><a href="../183476/index.html">Currently, the memory effect is also found in lithium-ion batteries.</a></li>
<li><a href="../183478/index.html">The digest of news from the world of mobile development for the last week ‚Ññ16 (June 10 - 16, 2013)</a></li>
<li><a href="../183482/index.html">NSA recognized the fact of wiretapping</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>