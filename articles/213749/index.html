<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Homemade phase laser range finder</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the article I will talk about how I did the laser range finder and about the principle of its work. Immediately, I note that the design is a layout...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Homemade phase laser range finder</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cfe/c40/27a/cfec4027a19ce7676e664dfd93deabc8.jpg" alt="image" align="right"><br>  In the article I will talk about how I did the laser range finder and about the principle of its work.  Immediately, I note that the design is a layout, and it cannot be used for practical use.  It was done only in order to make sure that the phase rangefinder is really to collect yourself. <br><a name="habracut"></a><br><br><h4>  Theory </h4><br>  Often it is necessary to meet the opinion that with the help of a laser the distance is measured only by direct measurement of the time of flight of a laser pulse from the laser to the reflecting object and back.  In fact, this method (it is called pulsed or time-of-flight, TOF) is used mainly in cases where the distance to the desired object is large enough (&gt; 100 m).  Since the speed of light is very high, in a single laser pulse it is quite difficult to measure the time of flight of light, and therefore the distance, with great accuracy.  The light passes 1 meter in about 3.3 ns, so the time measurement accuracy should be nanosecond, although the accuracy of the distance measurement will still be tens of centimeters.  To measure the time intervals with such accuracy use FPGA and specialized chips. <br><br> <a href="http://img-fotki.yandex.ru/get/9820/14557097.2/0_cc690_9a6390ea_orig"><img src="https://habrastorage.org/getpro/habr/post_images/63d/689/649/63d6896499be0206c75707c2242f97d8.png" alt="image" align="right"></a> <br>  However, there are other laser methods for changing distances, one of which is phase.  In this method, unlike the previous one, the laser operates continuously, but its radiation is amplitude modulated by a signal of a certain frequency (usually it is less than 500 MHz).  I note that the laser wavelength remains unchanged (it is in the range of 500 - 1100 nm). <br>  The radiation reflected from the object is received by the photodetector, and its phase is compared with the phase of the reference signal - from the laser.  The presence of a delay in the propagation of a wave creates a phase shift, which is measured by a rangefinder. <br>  The distance is determined by the formula: <br><img src="https://habrastorage.org/getpro/habr/post_images/e10/1fe/c14/e101fec142ed8edd2755d2afd7b26bcb.gif"><br>  Where c is the speed of light, f is the laser modulation frequency, ph is the phase shift. <br>  This formula is valid only if the distance to the object is less than half the wavelength of the modulating signal, which is equal to c / 2f. <br>  If the modulation frequency is 10 MHz, then the measured distance can be up to 15 meters, and when the distance changes from 0 to 15 meters, the phase difference will change from 0 to 360 degrees.  A change in the phase shift of 1 degree in this case corresponds to a movement of the object by about 4 cm. <br>  When this distance is exceeded, ambiguity occurs - it is impossible to determine how many periods of the wave fit into the measured distance.  To resolve the ambiguity, the modulation frequency of the laser is switched, after which the resulting system of equations is solved. <br>  The simplest case is the use of two frequencies, the distance to the object is approximately determined at a low (but the maximum distance is still limited), the distance is determined at a high with the required accuracy - with the same accuracy of phase shift measurement, with high frequency the distance measurement accuracy will be much higher. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since there are relatively simple ways to measure the phase shift with high accuracy, the accuracy of the distance measurement in such rangefinders can be up to 0.5 mm.  It is the phase principle that is used in range finders that require high measurement accuracy - geodesic range finders, laser tape measures, scanning range finders mounted on robots. <br>  However, the method also has drawbacks - the radiation power of a constantly operating laser is noticeably less than that of a pulsed laser, which does not allow the use of phase rangefinders for measuring large distances.  In addition, the phase measurement with the required accuracy can take some time, which limits the speed of the device. <br><br>  The most important process in such a rangefinder is the measurement of the phase difference of the signals, which determines the accuracy of the distance measurement.  There are various ways to measure phase difference, both analog and digital.  Analog is much simpler, digital give greater accuracy.  In this case, using digital methods to measure the phase difference of high-frequency signals is more difficult - the time delay between signals is measured in nanoseconds (this delay occurs the same as in a pulse rangefinder). <br><br>  In order to simplify the task, heterodyne conversion of signals is used - the signals from the photodetector and the laser are separately mixed with a signal of close frequency, which is formed by an additional generator - local oscillator.  The frequencies of the modulating signal and the local oscillator differ by kilohertz or megahertz units.  From the received signals using the low-pass filter, the signals of the difference frequency are extracted. <br> <a href="http://img-fotki.yandex.ru/get/9812/14557097.2/0_cc75e_d29d8dec_orig"><img src="https://habrastorage.org/getpro/habr/post_images/148/499/448/14849944888fe5880b865875757da751.png"></a> <br>  An example of a block diagram of a range finder with a local oscillator.  M - laser modulation signal generator; G - local oscillator. <br><br>  The phase difference of the signals in this conversion does not change.  After that, the phase difference of the obtained low-frequency signals is measured by digital methods much easier - you can easily digitize signals with a low-speed ADC, or measure the delay between signals (it decreases noticeably with decreasing frequency) with a counter.  Both methods are quite simple to implement on a microcontroller. <br><br>  There is another way to measure phase difference - digital synchronous detection.  If the frequency of the modulating signal is not very high (less than 15 MHz), then such a signal can be digitized by a high-speed ADC synchronized with the laser modulation signal.  From the Kotelnikov theorem, it follows that the sampling frequency in this case should be twice as high as the laser modulation frequency.  However, since a narrowband signal is being digitized (except for the modulation frequency, there are no other signals at the ADC input), a subsampling method can be used, thanks to which the ADC sampling frequency can be markedly reduced to units of megahertz.  It is clear that the analog part of the rangefinder is simplified. <br>  In more detail (with all the necessary formulas) this method is considered <a href="http://www.hit.bme.hu/~papay/edu/Conv/pdf/Poujouly.pdf">here (in English)</a> and <a href="http://engjournal.ru/articles/359/html/files/assets/common/downloads/publication.pdf">here (in Russian)</a> . <br>  The first article states that if the signal sampling rate (fsp) is related to the modulation frequency (fo) as follows: <br><img src="https://habrastorage.org/getpro/habr/post_images/426/fe2/157/426fe21579770c32123f2e3f7e9e25d7.jpg"><br>  where p is an integer, the phase calculation process is greatly simplified. <br>  It is enough to take N samples of the signal X [i], after which the phase difference can be calculated by the following formulas: <br><img src="https://habrastorage.org/getpro/habr/post_images/68a/947/ea8/68a947ea8a0d11cb0cf89202af1766af.png"><br>  I note that both of the above methods are often used together - low-frequency signals are fed directly to the ADC, high-frequency signals are transferred to lower frequencies due to the heterodyne conversion, and also fed to the ADC. <br><br>  It is the second version of the phase meter, using 10 MHz modulation frequency, that I decided to implement in my layout a range finder. <br><br><h4>  Practice </h4><br>  The block diagram of my rangefinder: <br><br> <a href="http://img-fotki.yandex.ru/get/9932/14557097.2/0_cc785_bd5311fe_orig"><img src="https://habrastorage.org/getpro/habr/post_images/c93/a4d/883/c93a4d883d22850218cd1e092a4276ad.png"></a> <br>  In fact, the whole structure consists of 3 parts - a debug board with a microcontroller, a laser signal amplifier with the laser itself, and a photo-receiver with an amplifier and a filter. <br>  In the above theory it was assumed that the laser radiation is modulated by a sinusoidal signal.  It is not easy to form such a signal with a frequency of 10 MHz using a controller, so in my design I am applying a 10 MHz square wave to the laser.  After amplifying the signal from the photodetector, unnecessary harmonics are cut off from the received signal by a band-pass LC filter tuned to a frequency of 10 MHz, with the result that a signal very close to sinusoidal appears at the filter output. <br><br>  Analog part circuit (laser amplifier and receiver part): <br> <a href="http://img-fotki.yandex.ru/get/9112/14557097.1/0_cc5c4_65bd6d2_orig"><img src="https://habrastorage.org/getpro/habr/post_images/a2c/f82/3da/a2cf823da6ab93f5a6187038c21b4744.png"></a> <br>  The scheme was taken from the <a href="http://ronja.twibright.com/">Ronja</a> laser communication <a href="http://ronja.twibright.com/">project</a> , the <a href="http://radus.laserlink.org/schem.html">description is in Russian</a> .  In this project, data transfer with a speed of 10Mbit is just implemented, which corresponds to the selected modulation frequency. <br>  As can be seen from the diagram - the power amplifier for the laser is the simplest, assembled on a 74HC04 chip (contains 6 inverters).  The inclusion of the chip is not entirely correct, but it works.  The current through the laser is limited by resistors (also not the best solution).  The power supply voltage of 5V for the amplifier is taken from the debug board. <br>  In order for the signal from the amplifier not to be directed to the rest of the circuit, the amplifier body is made of metal, all wires are shielded. <br>  The laser itself (red) is taken from a DVD burner, its power can be set high enough, and it is guaranteed to operate at a frequency of 10 MHz. <br><br>  The receiver consists of a photodiode and an amplifier assembled on a field-effect transistor and a chip-high-speed amplifier.  Since the illumination of the photodiode decreases strongly with increasing distance, the gain must be sufficiently large (in this scheme, it is approximately 4000).  In addition, with increasing frequency, the signal at the output of the photodiode noticeably decreases (its capacity affects).  I note that the amplifier in this design is the most important and most whimsical part.  As it turned out, its gain is clearly not enough.  Initially, I assumed that the gain could be changed (in order to attenuate the signal when it was too large), the scheme used allows doing this by changing the voltage on the second gate of the transistor.  However, it turned out that when the gain changes, the phase shift introduced by the amplifier changes sufficiently, which degrades the accuracy of the distance measurement, so we had to set the gain to maximum by applying a 3V voltage from the battery to the gate of the transistor. <br>  The receiver requires 12V for operation, so you have to use a separate power supply to power it. <br>  The amplifier is very sensitive to external interference, so it must also be shielded.  I took the finished case from a non-working optical sensor, and placed the amplifier in it (white stripe - foil for additional photodiode shielding): <br> <a href="http://img-fotki.yandex.ru/get/9748/14557097.1/0_cc5c3_ec6e555c_orig"><img src="https://habrastorage.org/getpro/habr/post_images/09e/cfc/24e/09ecfc24e2c344b4f352b659f80f20ef.jpg"></a> <br>  I note that the pickup of the signal from the laser to the receiver rather worsens the accuracy of measuring the phase difference, so you need to control that there is no such pickup. <br><br>  LC filter used in the rangefinder - taken from the <a href="http://habrahabr.ru/post/204310/">receiver</a> .  Since the filter cuts off the DC component of the signal, and does not perceive negative signals from the ADC, it has to be added using the resistor divider R15, R16.  The constant voltage applied to the divider is taken from the debug board (VCC). <br><br>  Debug board - STM32F4-DISCOVERY.  I chose it because for the formation of two sufficiently different frequencies a generator of sufficiently high frequency is needed (PLL STM32F4 can produce frequencies greater than 100 MHz). <br>  In the formula linking the modulation and sampling frequencies, the ‚Äúp‚Äù coefficient I assumed to be 6, so that at a modulation frequency of 10 MHz, the sampling frequency should be 1.6 MHz. <br><br>  To generate a frequency of 10 MHz, a timer TIM2 is used, which operates in the PWM signal generation mode.  With a system frequency of 160 MHz, its period is 16 ticks. <br>  The ADC receives start requests from timer TIM2.  To form a frequency of 1.6 MHz, its period is 100 "ticks".  All data from the ADC using DMA are stored in an array, the size of which must be equal to two in the N degree.  Both timers, ADC and DMA run once when turned on and are no longer disabled.  Thus, since the timers are clocked from one source, and four data samples correspond to one period of the measured signal, it turns out that an integer number of signal periods always fall into the array. <br>  Since it is not desirable to stop the DMA (this simplifies the management of data capture), when the first half of the array is filled, an interrupt is generated.  Having found that half of the array is full, the controller copies its contents to another array (in order to simplify the program, the second half of the main array is not used).  After that, the obtained data is processed - the average amplitude and phase of the signal are calculated, the phase shift is recalculated into the distance. <br>  The obtained values ‚Äã‚Äãare displayed on the LCD indicator from the cash register, also connected to the debug board. <br><br>  The range finder should know where the origin is.  To calibrate it when turned on, the object is set at a ‚Äúzero‚Äù distance from the range finder, after which a button is pressed on the debug board, the measured distance value is recorded in memory, after which this value will be subtracted from the distance measured by the range finder. <br><br>  As I noted above, automatic gain control failed.  In this case, a change in the amplitude of the received signal leads to a change in the phase shifts in the amplifier, and, consequently, to additional errors. <br>  Therefore, I had to adjust the illumination of the photodiode with the help of a mechanical flap, turned by a servo - when the illumination is too high, the flap blocks the light flux.  The PWM signal for controlling the drive is generated by the timer TIM3. <br><br>  About optics.  Without it, the range finder is impossible.  Its design is clearly visible in the photos below.  The laser is located inside a plastic tube installed vertically.  A small sleeve with a mirror prism is inserted into it.  The sleeve can be rotated, raised and lowered, thus moving the laser beam.  Since I guessed that the gain was not enough, I used a large Fresnel lens to receive the signal. <br>  Since the laser, lens and photodiode are aligned, then at close distances the laser closes its own beam from the photodiode.  To compensate for this effect, I installed a second lens (magnifier with a rim), although the effect is not completely eliminated, so the maximum signal is observed at a distance of about 50-70 cm from the laser. <br><br>  And here are the photos of the resulting structure: <br> <a href="http://img-fotki.yandex.ru/get/9168/14557097.1/0_cc5bd_d36c76b7_orig"><img src="https://habrastorage.org/getpro/habr/post_images/cbf/50c/c82/cbf50cc82c0962a7ea78e83f5b72b5c1.jpg"></a> <br>  On the indicator, the first number is the amplitude in ADC units, the second number is the distance in centimeters from the edge of the board. <br><br> <a href="http://img-fotki.yandex.ru/get/9829/14557097.1/0_cc5be_55bbfc6b_orig"><img src="https://habrastorage.org/getpro/habr/post_images/3ed/598/d33/3ed598d33796d7f1fa15bb0774dbf6d4.jpg"></a> <br><br> <a href="http://img-fotki.yandex.ru/get/9829/14557097.1/0_cc5bf_3a266af6_orig"><img src="https://habrastorage.org/getpro/habr/post_images/422/7a9/ee6/4227a9ee69f65b1e0c75ddcc6789b1cc.jpg"></a> <br><br>  Video of the rangefinder: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/TGT65tKHEMk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  The range of the resulting rangefinder came out quite small: 1.5-2 m, depending on the reflection coefficient of the object. <br>  In order to increase the range, you can use a special reflector, which will need to direct the laser beam. <br>  For experiments, I made a lens reflector consisting of a lens in which the focus is matte paper.  This design reflects the light at the same point from which it was released, however, the beam diameter increases. <br>  Photo reflector: <br><img src="https://habrastorage.org/getpro/habr/post_images/1c2/5af/9f7/1c25af9f7b45e6663620d1b3f5fd2ed8.jpg"><br><br>  Using a reflector: <br> <a href="http://img-fotki.yandex.ru/get/9116/14557097.1/0_cc5c0_5780a38a_orig"><img src="https://habrastorage.org/getpro/habr/post_images/beb/5b8/d12/beb5b8d12c2000c682ac21c43356e40d.jpg"></a> <br>  As can be seen, the distance to the reflector is 6.4 meters (in reality, it was approximately 6.3).  The signal increases so much that it has to be attenuated, directing the laser beam to the edge of the reflector. <br><br>  The accuracy of the resulting rangefinder is 1-2 centimeters, which corresponds to the accuracy of measuring the phase shift - 0.2-0.5 degrees.  At the same time, to achieve such accuracy, the data have to be averaged too long - it takes 0.5 seconds for one measurement.  Perhaps this is due to the use of PLL to generate signals - it has quite a big jitter.  Although I think that for an improvised layout, the analog part of which is made rather clumsily, in which there are quite long wires, even such accuracy is pretty good. <br>  I note that I could not find on the Internet a single existing project of a phase rangefinder (at least with the design scheme), which was the reason for writing this article. <br><br>  Controller program: <a href="https://github.com/iliasam/STM32F4_phase_laser_rangefinder">link</a> </div><p>Source: <a href="https://habr.com/ru/post/213749/">https://habr.com/ru/post/213749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213739/index.html">NginX load balancing on Apache servers</a></li>
<li><a href="../213741/index.html">Authorizing clients in nginx via SSL certificates</a></li>
<li><a href="../213743/index.html">Published list of open-source organizations participating in Google Summer of Code 2014</a></li>
<li><a href="../213745/index.html">Reverse engineering comic xkcd</a></li>
<li><a href="../213747/index.html">Samsung announced Galaxy S5</a></li>
<li><a href="../213751/index.html">Ten most controversial theses about time</a></li>
<li><a href="../213755/index.html">MWC 2014. App Planet. Intel Software</a></li>
<li><a href="../213757/index.html">Thinking out loud: TV firewall for older people</a></li>
<li><a href="../213759/index.html">Samsung introduced the Gear Fit fitness bracelet at # MWC2014</a></li>
<li><a href="../213761/index.html">Report from the Integrated Systems Europe-2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>