<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New solutions to the old problem</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Or transfer the bike to jet thrust 
 There is one very old problem, the age of which is equal to the age of the American Standard Code for Information...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New solutions to the old problem</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cfc/abd/c0f/cfcabdc0f16d5e7af55a35012fdf8cf3.jpg" alt="image"><br><h5>  Or transfer the bike to jet thrust </h5><br>  There is one very old problem, the age of which is equal to the age of the American Standard Code for Information Exchange.  More specifically, the task of converting an integer to its hexadecimal representation of an ASCII string. <br>  In this publication, we will consider converting a whole unsigned sixty-four-bit number into a string of fixed length without truncating the leading zeros. <br>  The task at first glance seems elementary.  It would be such if the ASCII table was different.  But we have, what we have. <br>  All solutions will be only for IA-32 and Intel 64 architectures. <br><a name="habracut"></a><br>  Consider the input-output data and the algorithm for solving this problem. <br>  <b>Entrance:</b> <br>  64-bit integer unsigned number, which occupies 8 bytes at addresses from low to high.  The digits of the number are in the same order.  Each bit occupies 4 bits, there are two bits in each byte. <br>  <b>Output:</b> <br>  A string of ASCII characters, each occupying one byte.  Each byte represents one digit of the original number.  The order of the characters - the first byte (lowest address) - the most significant digit of the original number. <br><br>  Algorithm: <br>  1) Go from the older tetrads to the younger ones <br>  2) Take a tetrad and convert it to a byte with zero extension. <br>  3) Add 30h <br>  4) If the value turned out more than 39h then <br>  4.1) Add another 17 (decimal) <br>  4.2) Go to 5 <br>  4.3) Otherwise go to 5 <br>  5) Save received byte in line <br>  6) While not all tetrads are processed, go to 2 <br><br>  Decision number 1 <br><div class="spoiler">  <b class="spoiler_title">Head-on</b> <div class="spoiler_text"><pre><code class="hljs pgsql">mov cx,<span class="hljs-number"><span class="hljs-number">8</span></span> mov si,<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> mov di,hexstr <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> si,cx ;highest byte <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-type"><span class="hljs-type">dec</span></span> si next_tetrade: std lodsb mov bl,al <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al,<span class="hljs-number"><span class="hljs-number">0</span></span>fh <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> digit cld stosb mov al,bl shr al,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> digit <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> next_tetrade ret digit: <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> al,<span class="hljs-number"><span class="hljs-number">30</span></span>h cmp al,<span class="hljs-number"><span class="hljs-number">39</span></span>h jnb _zero-nine ;digit greater than <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> al,<span class="hljs-number"><span class="hljs-number">11</span></span>h _zero-nine: ret</code> </pre> </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Like most solutions to the forehead, it is no different neither beauty nor speed.  Home ugliness - conditional transition, which bypasses only one team.  There are two ways of pointing beauty. <br>  The first is to use the ancient "magic" as a sequence of AAA AAD 17 commands. <br>  Decision number 2 <br><div class="spoiler">  <b class="spoiler_title">AAA AAD 17</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">mov cx,<span class="hljs-number"><span class="hljs-number">8</span></span> mov si,<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> mov di,hexstr <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> si,cx ;highest byte <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-type"><span class="hljs-type">dec</span></span> si next_tetrade: std lodsb mov bl,al <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al,<span class="hljs-number"><span class="hljs-number">0</span></span>fh <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> digit cld stosb mov al,bl shr al,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> digit <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> next_tetrade ret digit: mov ah,<span class="hljs-number"><span class="hljs-number">30</span></span>h aaa aad <span class="hljs-number"><span class="hljs-number">11</span></span>h ret</code> </pre></div></div><br><br>  Another way is to use the XLATB command. <br>  Decision number 3 <br><div class="spoiler">  <b class="spoiler_title">XLATB</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> mov cx,<span class="hljs-number"><span class="hljs-number">8</span></span> mov si,<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> mov di,hexstr mov bx,hextable <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> si,cx <span class="hljs-type"><span class="hljs-type">dec</span></span> si m3: std lodsb mov ah,al <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al,<span class="hljs-number"><span class="hljs-number">0</span></span>fh xlatb cld stosb mov al,ah shr al,<span class="hljs-number"><span class="hljs-number">4</span></span> xlatb stosb <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> m3 ret hextable db "0123456789ABCDEF"</code> </pre></div></div><br><br>  Both solutions are almost identical.  But Solution # 2 will not work in 64-bit processor mode, due to the elimination of support for AAA and AAD commands in it. <br>  But is it really possible, with the ability to process 8 bytes at a time, will we accept the processing of only 4 bits? <br>  Are there ways to turn 9 (1001) into 39h (00111001) and A (1010) into 41h (01000001)? <br>  Let's try to reveal the essence of a pair of AAA AAD teams, and select a replacement for them. <br><div class="spoiler">  <b class="spoiler_title">AAA AAD Replacement</b> <div class="spoiler_text"><pre> <code class="hljs cs"> mov bl,<span class="hljs-number"><span class="hljs-number">0</span></span>ah xor ah,ah div bl ; al - , ah -. ,     <span class="hljs-number"><span class="hljs-number">9</span></span>    <span class="hljs-number"><span class="hljs-number">1.</span></span> mov bh,al ; shl al,<span class="hljs-number"><span class="hljs-number">4</span></span> ;       <span class="hljs-number"><span class="hljs-number">11</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> al,bh <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> al,<span class="hljs-number"><span class="hljs-number">30</span></span>h ; voila!</code> </pre></div></div><br><br>  This code, of course, is not suitable for our purposes, but it gives valuable information.  Indicates that you can get a hyphenation unit for numbers greater than 9. And it shows how to use this unit later.  Now, if each tetrade could be turned into a byte, then these bytes could be processed in parallel.  Eight digits at a time! <br>  Let the initial number be in rax.  To isolate the lower tetrad, you just need to perform a conjunction with a mask.  And so that the older tetrads are not lost, we copy them into rbx. <br><div class="spoiler">  <b class="spoiler_title">Unpuck</b> <div class="spoiler_text"><pre> <code class="hljs delphi"> mov rdx,<span class="hljs-number"><span class="hljs-number">0</span></span>f0f0f0f0f0f0f0fh mov rbx,rax <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rax,rdx <span class="hljs-keyword"><span class="hljs-keyword">shr</span></span> rbx,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rbx,rdx</code> </pre></div></div><br><br>  Unfortunately, it will not be possible to get the necessary transfer by division.  Are there any other methods? <br>  Actually, elementary: 10h-0ah = 6.  It is enough to add 6 to each byte and get the necessary unit in the high tetrad. <br><div class="spoiler">  <b class="spoiler_title">Carry</b> <div class="spoiler_text"><pre> <code class="hljs delphi"> mov rdx,<span class="hljs-number"><span class="hljs-number">0</span></span>f0f0f0f0f0f0f0fh mov rcx,<span class="hljs-number"><span class="hljs-number">0606060606060606</span></span>h mov rbx,rax <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rax,rdx mov rdi,rax ;   <span class="hljs-keyword"><span class="hljs-keyword">shr</span></span> rbx,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rbx,rdx add rax,rcx <span class="hljs-keyword"><span class="hljs-keyword">shr</span></span> rax,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rax,rdx ;    ,     <span class="hljs-number"><span class="hljs-number">9</span></span>,  .   - .</code> </pre></div></div><br><br>  Unlike the previous method of obtaining units of transfer using division, instead of the remainder of division, we still have the original number.  That is, where was the number A - there it will remain, and will not turn into 0. Therefore, you need to add not 11h, but 41h-3ah = 7. <br>  And now another problem arises, how to make a seven out of one?  Yes, so as not to affect the neighboring bytes.  After all, 7 = 0111b, it means you can get what you need by two shifts to the left and two disjunctions. <br><div class="spoiler">  <b class="spoiler_title">One to seven</b> <div class="spoiler_text"><pre> <code class="hljs delphi"> mov rsi,rax <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> rsi,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rax,rsi ;<span class="hljs-number"><span class="hljs-number">11</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> rsi,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rax,rsi ; <span class="hljs-number"><span class="hljs-number">111</span></span>b</code> </pre></div></div><br><br>  Now let's put the pieces together and see what happens. <br><div class="spoiler">  <b class="spoiler_title">Unsigned to hex ver 0.1</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> mov rax,[<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>] mov rdx,<span class="hljs-number"><span class="hljs-number">0</span></span>f0f0f0f0f0f0f0fh mov rcx,<span class="hljs-number"><span class="hljs-number">0606060606060606</span></span>h mov rbx,rax mov rbp,<span class="hljs-number"><span class="hljs-number">3030303030303030</span></span>h shr rbx,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rax,rdx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rbx,rdx mov rdi,rax mov r9,rbx <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rax,rcx <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rbx,rcx shr rax,<span class="hljs-number"><span class="hljs-number">4</span></span> shr rbx,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rax,rdx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rbx,rdx mov rsi,rax mov r8,rbx shl rsi,<span class="hljs-number"><span class="hljs-number">1</span></span> shl r8,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rax,rsi <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rbx,r8 shl rsi,<span class="hljs-number"><span class="hljs-number">1</span></span> shl r8,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rax,rsi <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rbx,r8 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rax,rbp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rbx,rbp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rax,rdi <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rbx,r9 mov [hexstr],rax mov [hexstr+<span class="hljs-number"><span class="hljs-number">8</span></span>],rbx</code> </pre></div></div><br><br>  If you compile and run this code, one trouble will be revealed - the order of the numbers in the string is not in order.  First, the numbers go backwards, and secondly, the even and odd numbers are grouped together.  You can, of course, give to the conclusion and so, but we are honest and still bring order. <br><div class="spoiler">  <b class="spoiler_title">Deinterleaving</b> <div class="spoiler_text"><pre> <code class="hljs vhdl"> mov rcx,<span class="hljs-number"><span class="hljs-number">4</span></span> highpart: <span class="hljs-keyword"><span class="hljs-keyword">rol</span></span> rbx,<span class="hljs-number"><span class="hljs-number">8</span></span> shrd [hexstr],rbx,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rol</span></span> rax,<span class="hljs-number"><span class="hljs-number">8</span></span> shrd [hexstr],rax,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> highpart mov rcx,<span class="hljs-number"><span class="hljs-number">4</span></span> lowpart: <span class="hljs-keyword"><span class="hljs-keyword">rol</span></span> rbx,<span class="hljs-number"><span class="hljs-number">8</span></span> shrd [hexstr+<span class="hljs-number"><span class="hljs-number">8</span></span>],rbx,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rol</span></span> rax,<span class="hljs-number"><span class="hljs-number">8</span></span> shrd [hexstr+<span class="hljs-number"><span class="hljs-number">8</span></span>],rax,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> lowpart ret</code> </pre></div></div><br><br>  From what they wanted to leave, they came to that.  Again byte processing in 64 mode.  In order to flip the bytes, put them backwards, Intel has already made the bswap command for a long time.  But for deinterliving you will have to look towards the MMX, SSE and their development.  And there is such a command and its name is punpcklbw.  We use our finds. <br><div class="spoiler">  <b class="spoiler_title">Deinterleaving ver.</b>  <b class="spoiler_title">2</b> <div class="spoiler_text"><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+8]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqu</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqu</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">punpcklbw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqu</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span></code> </pre></div></div><br><br>  Stop stop stop.  If we started using SSE, maybe there is something else useful?  Maybe rewrite our code completely on SSE. <br><div class="spoiler">  <b class="spoiler_title">Unsigned to hex ver 1.1</b> <div class="spoiler_text"><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqu</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[value]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pxor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">punpcklbw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psllq</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">por</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[sixes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psrlq</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pxor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psubb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[sevens]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[zeroes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqu</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+8]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">efes</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">f0f0f0f0f0f0f0fh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">f0f0f0f0f0f0f0fh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">zeroes</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 3030303030303030<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 3030303030303030<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sixes</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 0606060606060606<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 0606060606060606<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sevens</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 0707070707070707<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dq</span></span> 0707070707070707<span class="hljs-selector-tag"><span class="hljs-selector-tag">h</span></span></code> </pre></div></div><br>  Here we have simplified unpacking, and getting the sevens is organized in another way, using one subtraction and one conjunction. <br><br>  And what did we win at all?  Let's compare the speed of each method. <br><table><tbody><tr><th>  CPU </th><th>  one </th><th>  2 </th><th>  3 </th><th>  four </th><th>  five </th><th>  6 </th><th>  7 </th><th>  eight </th></tr><tr><td>  Core 2 Quad Q8200 </td><td>  670 </td><td>  600 </td><td>  150 </td><td>  77 </td><td>  70 </td><td>  77 </td><td>  76 </td><td>  1170 </td></tr><tr><td>  AMD C-60 </td><td>  290 </td><td>  195 </td><td>  290 </td><td>  120 </td><td>  105 </td><td>  120 </td><td>  140 </td><td>  290 </td></tr></tbody></table><br><ol><li>  Lodsb stosb with jnb </li><li>  Lodsb stosb with xlatb </li><li>  General purpose registers with shrd </li><li>  General purpose registers with punpck </li><li>  SSE 64 bit </li><li>  SSE 64 bit unaligned </li><li>  SSE 128 bit </li><li>  Lodsb stosb with xlatb 128 bit </li></ol><br>  The values ‚Äã‚Äãin parrots are the average number of processor ticks. <br>  If Intel's numbers fit the theory well, then they are somewhat mysterious in AMD.  A pleasant surprise was the high speed of the SSE code on the Intel processor.  You can safely increase the digit capacity of the converted numbers to 256 bits with a small increase in the required time, the benefit is still a lot of free xmm registers in 64-bit mode.  In general, initially it would seem a consistent task, it became possible to solve a very parallel method. <br>  The inverse problem of converting a hexadecimal string to a number is no less interesting. <br><br>  For a snack: <br><div class="spoiler">  <b class="spoiler_title">SSE 128 bit</b> <div class="spoiler_text"><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[value]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pxor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">punpcklbw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">punpckhbw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psllq</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psllq</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span>,4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">por</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">por</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[sixes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psrlq</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[sixes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psrlq</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span>,4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">pxor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[efes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psubb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pxor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm10</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[sevens]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">psubb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm10</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm9</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pand</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm10</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[sevens]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[zeroes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">paddb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[zeroes]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">movdqa</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+16]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+16]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+16+8]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rbx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bswap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+8+16]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+8]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[hexstr+16]</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">rdx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre></div></div></div><p>Source: <a href="https://habr.com/ru/post/239375/">https://habr.com/ru/post/239375/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239361/index.html">DSL Application Development and Code Generation</a></li>
<li><a href="../239365/index.html">Spherical screens for UAV operators and remotely controlled vehicles</a></li>
<li><a href="../239367/index.html">Wal Commander - Far Manager replacement for OS X and Linux</a></li>
<li><a href="../239369/index.html">Dummy about Dummies and one exciting journey into the depths of Excel. Long-awaited RegExp in tables</a></li>
<li><a href="../239373/index.html">Pitfalls of responsive web design</a></li>
<li><a href="../239377/index.html">The best gift is a book. We make a beautiful cover</a></li>
<li><a href="../239379/index.html">Study: internal threats in large companies turned out to be more dangerous than viruses</a></li>
<li><a href="../239381/index.html">Storage systems: how to choose?</a></li>
<li><a href="../239385/index.html">YouTrack 6.0, distinct and flexible. What can a new tracker?</a></li>
<li><a href="../239387/index.html">Testing embedded systems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>