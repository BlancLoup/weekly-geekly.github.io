<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>5 stages of the API: what we understood by writing two versions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we want to talk about the secret - we have an API. 

 We wrote and then rewrote it again for four years. And during this time, almost all the cl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>5 stages of the API: what we understood by writing two versions</h1><div class="post__text post__text-html js-mediator-article">  Today we want to talk about the secret - we have an API. <br><br>  We wrote and then rewrote it again for four years.  And during this time, almost all the classical stages of ‚Äúaccepting the inevitable‚Äù have passed.  Except for one - the fourth.  And we want to share the <s>overwhelmingly hard-earned</s> conclusions about what to do and not to do if you decide to make your ‚Äúpowerful epiai‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6bc/14a/998/6bc14a9980b44b1596b3e0afb74b418b.jpg"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>The process of creating API uCoz sometimes resembled the plot of the series The Knick (Nikerkoker Hospital) - with unsuccessful operations, guts and experiments on living people.</i> <br><br><h2>  Stage One - Denial </h2><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">According to the concept of the five stages:</b> <div class="spoiler_text">  <i>At the first stage, a person refuses to accept what happened to him.</i> <br></div></div><br>  In general, API for site designers is a rarity even now.  And in 2010, no one else had such a tool on the market. <br><br>  On the one hand, there was a definite need for an API: we saw that people actively googled ‚Äúscripts for uCoz‚Äù, received requests directly - some users wanted to create their own additions and modifications.  On the other hand, <b>and this was a problem</b> , in those days all resources were thrown onto other projects. <br><br>  The question "to be or not to be" was solved simply.  The API was needed by us ‚Äî to run the PHP support function in the constructor.  We singled out one developer, and in six months he made our ‚Äúinitial API‚Äù - it was a get-only interface, to which it was possible to get page data from 11 modules.  Data was given only in XML.  By the time of the planned PHP announcement, we didn‚Äôt have time to establish at least the addition of content, but the API had some advantages: with it, you could run php scripts in a free version of Yukoza. <br><br>  In general, we went to the users.  It turned out straight on the classics: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/af3/c24/7e6/af3c247e63734b49b0befe73d922db1d.jpg"></div><br><br>  They didn‚Äôt accept us very much ... Or rather, they praised me mostly.  But for PHP.  And in the ‚Äúepiay‚Äù people did not see what they imagined with this magic word.  The tech support started asking questions: ‚ÄúHow to add materials?  How to edit?  How to get in json? ‚ÄùAnd all this was not. <br><br><h2>  Stage Two - Anger </h2><br><div class="spoiler">  <b class="spoiler_title">According to the concept of the five stages:</b> <div class="spoiler_text">  <i>At this stage, there is aggression towards the whole world.</i> <br></div></div><br>  To the question that the API needs to be developed, they returned to the company somewhere in a year.  The priorities were mobile clients - and we decided to write everything anew taking into account the requirements of the guys who made clients for iOS and Android.  The initial version remained to live on its own (and even still alive, because some people still use it), and we began to pick up the performer for a new project. <br><br>  <b>‚ÄúMyself a manager.‚Äù</b>  An intelligent guy Ilya came to the Rostov office: he knew Perl, on which part of the old uCoz was written, and when he was traditionally offered several tasks, he chose to work on the API.  The problem was that at the time the guy had to become his own manager. <br><br>  Then anger came: ‚ÄúAs it turned out in the process, I understood the Perl syntax, but the spirit did not. <br><br><img src="https://habrastorage.org/files/410/bd2/d7b/410bd2d7b0ce4784a5e525f58caec3bb.jpg"><br><br>  Therefore, for a long time I tried not to work, but to make the world better: I thought to rewrite everything, to introduce objects-classes-patterns.  It took a lot of time to get comfortable with the ideology of the language.  And then, what at first seemed scary and I wanted to rewrite, it seemed to be the norm. ‚Äù <br><br>  By the time of enlightenment, a manager appeared and began to demand a report.  And only content delivery by several modules was ready ... In general, once again anger, now on the other hand, - and Ilya was transferred to a new project.  Its API version was never destined to see the light. <br><br><br><h2>  ... Between the stages ... </h2><br>  <b>‚ÄúThe ideal learning challenge.‚Äù</b>  By the time the company tried to open an R &amp; D office in Kazan.  On-site, we needed a carrier of knowledge about the entire system - and the idea was to ‚Äúgrow‚Äù it through work on an API that would affect the main modules of the system. <br><br>  So in this story Rinat appeared: <br><br><img src="https://habrastorage.org/files/fe2/d63/06e/fe2d6306e8564538b3c964a23ceb0ae6.jpg"><br><br>  On the one hand, he was quite passionate to take on the project (he is a bit extreme at all).  On the other hand, the work is calm and reasonable: not only 700+ parachute jumps, but also 20 years of experience in IT. <br><br>  He was also familiar with Perl and had a fresh experience with other people's APIs ‚Äî he integrated Metric and GA into the webmaster panel. <br><br>  The first thing that came in handy to us was his judgment.  Rinat asked for a pause in order to examine in more detail the intricate ‚Äúguts‚Äù of the system, and only then announce the deadlines and the implementation plan.  A month later, he came out with the following proposal: <br><br>  * We <b>rewrite and duplicate part of the functions purely under the API</b> - during the creation of the system a lot of old code has accumulated in it.  And some functions, if you try to shove something else in there, you would have turned out to be kilometer-long.  So cleaned twins are needed purely under the API. <br><br>  * <b>We use REST</b> - to simplify the query architecture, which will help increase performance. <br><br>  * <b>Use Oauth 1.0a</b> - authentication, which seemed the most secure at the time. <br><br>  * <b>We give in different formats</b> - JSON, XML, Text Plain. <br><br>  * <b>Well,</b> get, post, put, delete, peace, labor, may ... <br><br><br><h2>  Third Stage - Bargaining </h2><br><div class="spoiler">  <b class="spoiler_title">According to the concept of the five stages:</b> <div class="spoiler_text">  <i>Here you have thoughts about how to agree with someone about a better fate.</i> <br></div></div><br>  To a common understanding of how to make it convenient, we sort of came.  But the devil was in the details and arguments. <br><br>  <b>The principal issue</b> was the scope of tokens.  Our server system, as Rinat says, ‚Äúis a complete encapsulated figovina‚Äù: N users spin on each server, and when the space on it ends, a new hardware is taken. <br><br>  Rinat wanted to use one token to access all sites.  ‚ÄúOk, let's talk about this,‚Äù and we called our colleagues to the Skype chat.  As it happens in collective chats, they argued, argued, but did not come to a collective decision.  And in the heat of development, the topic was forgotten and re-emerged when integration was ready for half of the modules. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/75e/ae4/399/75eae43990894efaa8f7c97419e8c7e9.jpg"></div><br><br>  We didn‚Äôt have another option on how to replicate the token: this is how an architecture with one main authorization server appeared - having received one token there, it can be used everywhere. <br><br>  <b>Designed as an array or object?</b>  For us, it was not a problem of discharging what is right and what is wrong.  It was a problem of details. <br><br>  For example, we give data in JSON - and there is a problem with typed languages.  Not all structures received from the API are conveniently parsed - because the amount of code on the client side increases. <br><br>  But the API is focused on web pribludy, so we listened to the opinion of Java and C ++ developers and came to the standard: we give the fields in any case, we supplement the named parameters with code. <br><br>  <b>Fields and parameters.</b>  Here the trades and discussions went all the time.  For example, is it worth issuing an empty parameter?  Since we were also oriented towards mobile development using the API, Rinat proved in the process that it was not necessary: ‚Äã‚Äãafter all, traffic is important in mobile applications. <br><br>  And what fields are needed?  Here I, the project manager, had to look for and give examples from real practice.  Often I took the help of the hall - I interviewed future API users.  If a third-party case sent seemed valuable, we implemented the necessary fields in the API itself so that people would not do it through crutches.  And later they came up with a more elegant solution - we will tell about it later. <br><br><br><br><h2>  The fourth stage - ... (and about terms) </h2><br><div class="spoiler">  <b class="spoiler_title">According to the concept of the five stages:</b> <div class="spoiler_text">  <i>In the fourth stage, you have depression.</i>  <i>[We somehow passed this stage]</i> <br></div></div><br>  The work scheduled for the year took almost two.  In the process there were completely unforeseen difficulties.  We quickly realized that: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/53a/310/2ec/53a3102ecb9543cd92c8bab5238bc9bd.jpeg"></div><br><br>  <b>Problems with the second developer.</b>  According to the plan, after Rinat made authorization, a second developer had to connect to the API integration with the modules. <br><br>  We painted a google doc, putting the modules in alphabetical order.  Work on them was divided between the performers in half.  Defined schedule - one module per month from each.  When it was time to start, the second man left.  And we have already made a new project - the designer of uKit, to which the main resources were thrown.  With the loss of a second programmer, almost 7 months were added to the implementation period. <br><br>  <b>Problems with testing.</b>  In theory, the process was conceived as follows: after the developer‚Äôs server, everything goes to the alpha server, and if the tester says ‚Äúcome on,‚Äù then it is being beta tested and the update is spread over a hundred servers. <br><br>  But it turned out that our usual testers were not very suitable for working with the API - because they are ‚Äúsharpened‚Äù for testing web pages.  The API is a subtle thing.  For example, when there was a change inside the module with which we integrated, something could fall off - but the testers did not notice this at first (then we taught them). <br><br>  Then we opened 4 test servers and invited advanced users at the earliest stages.  Such a crowd, and therefore not very controlled (you are not sure when a person will do something and will not quit), testing also affected the increase in the time frame. <br><br><h2><br>  Fifth Stage - Humility (and Conclusions) </h2><br><div class="spoiler">  <b class="spoiler_title">According to the concept of the five stages:</b> <div class="spoiler_text">  <i>According to the canons, there is agreement with the inevitable</i> <br></div></div> <br>  In the end, we have come to terms with the inevitable - the API, like the repair, can be started, but it is not so easy to finish.  Here are some recipes for how to organize the process to make it easier for you. <br><br>  <b>1. Get feedback.</b>  <b>More communication.</b> <br><br>  In addition to the forum thread and blog posts, i.e.  public means of exchanging comments, I started a section ‚ÄúLaboratory‚Äù on the site with new documentation.  In fact, it was a feedback form where you could discuss your case in personal correspondence. <br><br>  We informed the early users about the new API in February 2015, and completed the process of rolling out all the modules to the servers only this year.  All this time we received reports, suggestions and interesting cases from users (which I also used in the ‚Äúauction‚Äù with Rinat) through the ‚ÄúLaboratory‚Äù. <br><br><img src="https://habrastorage.org/files/e76/a6f/5b5/e76a6f5b55cf41ce96467fa2442e0e6d.png"><br>  <i>The flow of applications has decreased only in the last two months.</i> <br><br>  Each time, having received an appeal ‚Äúhow to do this or what to do here,‚Äù we took the time and sat down to watch, but what better?  Sometimes interesting stories came from this. <br><br>  <b>2. Personally help those who did not understand or [Script as a gift].</b> <br><br>  Sometimes, the message from the ‚ÄúLab‚Äù was so interesting that we started writing the script ourselves.  And then gave the ready solution to the user, <br><br>  What is the profit?  As they say, ‚Äúif you want to find a bug, be a bug.‚Äù  And if you want to immerse yourself in a project, do as much as possible on it to check the performance and convenience.  At the same time, the first solutions appeared on the uScript exchange with the use of uAPI - authorization through social networks and non-buggy output of pictures in the block of recommended materials. <br><br>  <b>3. Run an internal hackathon.</b> <br><br>  As you remember, we lacked testers.  This is how the idea of ‚Äã‚Äãan internal hackathon for product verification appeared.  For some of our developers, working with the API was a completely new and unusual task, so we had the opportunity to closely observe how people act with different skills. <br><br><img src="https://habrastorage.org/files/d63/bf4/169/d63bf4169c454dbd94bfe0d9a5582458.jpg"><br>  <i>Rinat did not usually communicate directly with users, but came to Kazan developers from the Kazan hackathon.</i>  <i>He says, ‚Äúwith the exception of trolling, I was satisfied with the data collected in the process and criticism.‚Äù</i> <br><br><br>  <b>4. Try to automate something.</b> <br><br>  My favorite feature for working with API was the semi-automatic creation of an application and a token. <br><br><img src="https://habrastorage.org/files/404/23f/435/40423f43591a4f82bf1299774c115cc9.jpg"><br><br>  Initially, this system appeared from my personal needs - at one moment I was tired of wasting time on signing requests while creating an application.  Then I decided to write a semi-automatic mode - so that I do not have to think about anything, but I copied the data - and the application is ready.  As it turned out, now people mostly use a semi-automatic solution. <br><br>  <b>5. Consult and change documentation.</b> <br><br>  Initially, we painted an example query in PHP and CURL. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/339/6bb/2ce/3396bb2ce0af4f92968aa4e3327e94f7.png"></div><br>  <i>It was.</i>  <i>As it turned out in the process, no one used CURL.</i> <br><br>  But people asked, for example, in what format and which way to send the request.  It became clear that the first implementation was not obvious to everyone. <br><br>  We decided that there should be an additional module (written in a modern, OOP), where the signature for oauth will be automatically generated.  Once I called this module - and then you just write the path and method of the request. <br><br>  In parallel, I walked through our programmers and asked - the documentation for which APIs do they consider worthy role models?  I looked at the recommended examples and compiled a new version of the <a href="http://api.ucoz.net/ru/manual">documentation</a> with their consideration: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/642/cdb/cb9/642cdbcb9ae24d939184c62d442aa065.png"></div><br><br>  And as a test before publication, I asked a colleague from our second office to check the compliance of the API work with the descriptions in the documentation for all methods. <br><br>  <b>6. Implement mobility.</b> <br><br>  Firstly, it will help you get good reviews and broaden your audience: <br><br><blockquote>  It has long been a dream of creating a mobile application for your site.  I will study uAPI, to finally bring it to life </blockquote><br>  Secondly, it can be a valuable and new experience for the internal team.  For example, on the hackathon, several of our guys wrote down this application: <br><br><img src="https://habrastorage.org/files/c7f/932/b50/c7f932b50ae240fda6c959befaee79ef.png"><br>  <i><a href="https://drive.google.com/folderview%3Fid%3D0Bzk4-dN9zw8xfl9uOVpTS3R1b0JDSl9vNS1hWGczWVpZZTUyNWp2b3VhU1puLUhwQkJBSm8%26usp%3Dsharing">Here</a> you can see the application code.</i> <br><br>  <b>7. Do not limit the desires of users.</b> <br><br>  Let's return to the question of fields.  Since you can‚Äôt foresee all cases, in the end we made a query builder with which you can realize any bold fantasies on this topic: <br><br><img src="https://habrastorage.org/files/6b7/548/d8a/6b7548d8a8004d87907aee2ea4b99ee3.jpg"><br><br>  Finally, we came to the conclusion that the API is a two-way traffic.  Today, using uAPI, you can make authorization for any site, transfer materials from uCoz and vice versa, use only our database, but output data on a third-party site.  The more user cases you take into the tool, the longer the implementation.  But at the same time the area of ‚Äã‚Äãits application is growing. <br><br><br>  <b>PS</b> <br><br>  The whole process of rolling out and combat testing of the new version took us 14 months and 20 updates.  Here is a <a href="http://api.ucoz.net/ru/version">visualization</a> . <br><br>  It happens, after the next update, they write to us: ‚ÄúWhen will you finish it already?‚Äù But the process is really very difficult to stop (we were not joking about the repair).  Sometimes - for technical reasons: for example, when the system update requires a change in the API.  And sometimes - for creative.  For example, now we are thinking: when all the integrations with the modules are completed, why not work through the themes of changing the design and settings of the site via API? </div><p>Source: <a href="https://habr.com/ru/post/282385/">https://habr.com/ru/post/282385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282375/index.html">Antispam in Mail.Ru: how a machine recognizes a hacker by his behavior</a></li>
<li><a href="../282377/index.html">A little about the "law of Moore"</a></li>
<li><a href="../282379/index.html">Reverse Polish notation: how to cook a hot dog?</a></li>
<li><a href="../282381/index.html">Gaming Digest: March</a></li>
<li><a href="../282383/index.html">Hydra Slayer: kill time and numbers</a></li>
<li><a href="../282387/index.html">Cybercriminals tried to commit the largest bank robbery</a></li>
<li><a href="../282391/index.html">Optimization of the game on unity and dev story Tap Tap Builder</a></li>
<li><a href="../282393/index.html">GitLab in Russia</a></li>
<li><a href="../282395/index.html">New memory for new storage architecture</a></li>
<li><a href="../282397/index.html">Angular.js - webApi module development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>