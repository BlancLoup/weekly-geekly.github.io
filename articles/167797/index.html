<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart home, as I sunk to such. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, I talked about the reasons that prompted me to start building my ‚Äúsmart home‚Äù, and about the ‚Äúhardware‚Äù used. 
 But ‚Äúhardware‚Äù, in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart home, as I sunk to such. Part 2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/84e/4d6/a0a/84e4d6a0a1a78a2adf8f726da48765b3.png" align="right"><br>  In the <a href="http://habrahabr.ru/post/158911/">first</a> part, I talked about the reasons that prompted me to start building my ‚Äúsmart home‚Äù, and about the ‚Äúhardware‚Äù used. <br>  But ‚Äúhardware‚Äù, in itself, cannot be clever, the main thing is ‚Äúsoftware‚Äù.  Here I also want to tell about this side of the project in this part.  Banal lighting control from the console, of course, looks cool in the eyes of the uninitiated public, but there is no ‚Äúmind‚Äù here. <br>  So what is so clever you can do?  And, most importantly, how? <br><a name="habracut"></a><br>  As I said earlier, I have connected to the system: <br><ul><li>  All apartment lighting </li><li>  Warm floor </li><li>  Ventilation </li><li>  CCTV </li><li>  Climate sensors </li><li>  Motion sensors </li><li>  Sensors for opening doors and windows </li></ul><br><br>  To begin with, I will give an incomplete list of what my system can do (and examples of what it is used for): <br><ul><li>  Banal management of all that is connected from the web / smartphone / tablet :) </li><li>  Monitoring what is happening in the apartment and around from anywhere in the world where there is Internet (so, my houses, sleep during the day, I will not wake up while calling; the alarm went off on a motorcycle at the entrance - I connected to the camera, made sure everything was fine, etc. ) </li><li>  The inclusion of lighting in the corridor when someone came home and at the same time it was dark on the street, and nobody was at home </li><li>  Turning off the lights in the entire apartment and transfer the floor to the economy mode when there is no one </li><li>  Schedule lighting control (imitation of presence) </li><li>  Scenario lighting control with one touch: extinguish everything (the child wakes up and do not need to wake up, 3 o'clock in the morning, the parents still roam;)), extinguish everything except the light in the corridor (I carry the child out of the bathroom with the words, look everyone is asleep and it's time you) etc. </li><li>  Management of a heat-insulated floor according to the schedule and temperature </li><li>  Ventilation control on schedule and temperature </li><li>  Disable ventilation when windows are open (to save filter resource) </li><li>  Manage video recording of various events (unlocked front door, movement, etc.) </li><li>  Managed event alerts (someone came, everyone left, the front door is not locked for 15 minutes, etc.) </li><li>  ... </li></ul><br><br>  The most difficult task at first glance seemed to be solving the problem: ‚ÄúIs there anyone at home?‚Äù <br><img src="https://habrastorage.org/getpro/habr/post_images/090/067/f2a/090067f2aea6cb50386f9b2a966988dc.jpg"><br>  After all, if there is, but they are sleeping, then no motion sensor will detect anything, and turning on the light at the entrance is undesirable, as well as turning off the heating.  For a long time I broke my head over it, starting with the options for counting incoming / outgoing and ending with the definition of all movements in the apartment (the end point is the door, it means no one, the bed, then they sleep). <br>  But as they say, all ingenious is simple, I paid attention to the regularity that has become a habit: <br><ul><li>  If someone comes home, it always closes the latch. </li><li>  If someone does not leave the last, then closes one lock (so that the rest would be more convenient to open </li><li>  And only if everyone is gone, then we close all the locks and at the same time it is impossible to close the latch </li></ul><br>  I put the sensors on all the locks and voila, in a year and a half not a single false alarm, 100% determination of the presence of someone‚Äôs home. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>System architecture</b> <br>  The system has the following entities: <br><ul><li>  Sensor - this is where you can read data </li><li>  Trigger - a condition dependent on the sensor or time control controls </li><li>  Control - what you can control </li><li>  The messenger is essentially the same as the control, only it sends the message </li></ul><br>  The control (messenger) is associated with several triggers, which, in turn, are triggered by events from the sensors. <br><img src="https://habrastorage.org/getpro/habr/post_images/8a8/d10/e38/8a8d10e38fd2a0bb32963a7b0bccc9f8.png"><br><br>  <b>Sensors</b> are divided into five groups: <br><ul><li>  Sensor value: returns an absolute value, such as temperature </li><li>  Sensor-key: returns the time since the last triggering and a state, for example, a motion sensor </li><li>  Sensor command: returns the value of an arbitrary linux shell command, for example, disk temperature </li><li> Macrosensor: a combination of several sensors, for example, the NOBODY_HOME sensor is defined as: <code>min(abs(FRONTDOOR_KEY), <br> -FRONTDOOR_LATCH_KEY, <br> FRONTDOOR_LOCK_LOWER_KEY, <br> FRONTDOOR_LOCK_UPPER_KEY)</code> <code>min(abs(FRONTDOOR_KEY), <br> -FRONTDOOR_LATCH_KEY, <br> FRONTDOOR_LOCK_LOWER_KEY, <br> FRONTDOOR_LOCK_UPPER_KEY)</code> <br>  What translates into Russian means: no one is home from the moment the door was closed (FRONTDOOR_KEY), the heck is opened (FRONTDOOR_LATCH_KEY) and the locks are closed (FRONTDOOR_LOCK_LOWER_KEY, FRONTDOOR_LOCK_UPPER_KEY) </li><li>  Sensor control: returns the time since the last control change and its state </li></ul><br><br>  <b>Triggers</b> can do the following: <br><ul><li>  on - enable control when a condition occurs </li><li>  off - Disable control when a condition occurs. </li><li>  switch on - enable on condition and off when non-compliant </li><li>  switch off - turn off when the condition is met and turn on when non-compliance </li></ul><br><br>  <b>Controls</b> are divided into three groups: <br><ul><li>  1-wire control - on / off device on the bus 1-wire </li><li>  cmd control - execute linux shell command </li><li>  Custom control - everything your heart desires, but you have to go into the code </li></ul><br><br>  Let us analyze this scheme on the example of a simplified version of the management of a warm floor. <br>  For example, we have the following tasks: <br><ul><li>  Maintain a temperature of 34 degrees </li><li>  Disconnect for the night </li><li>  Turn off when there is no one </li><li>  Turn on when somebody is at home </li></ul><br><br>  We depict the interaction scheme in the diagram: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a0a/fb0/b98/a0afb0b98d4b676426a18ebe70137c02.png"><br><br><ul><li>  Trigger 1, means that when the temperature drops below 34 the floor must be turned on, otherwise off </li><li>  Trigger 2, means that from 1:00 AM, within 8 hours, the floor should be off. </li><li>  Trigger 3, means that since when no one is home more than 1 second, you need to turn off the floor </li><li>  Trigger 4 means that when someone is at home for more than 1 second, you need to turn on the floor </li></ul><br><br>  Here is such a simple architecture that allows you to specify most of the actions I need.  There are, of course, more difficult situations.  In such cases, I just write custom control.  For example, to turn on / off ventilation, you need more complex logic than just turning on / off a duct fan, you also need to close the flap according to certain rules. <br><br>  <b>Party projects</b> <br>  My whole system is written in Python and is running on a server running Ubuntu.  MySQL is used as a database.  For connection to 1-wire, the <a href="http://owfs.sourceforge.net/owpython.html">owpython</a> library is <a href="http://owfs.sourceforge.net/owpython.html">used</a> . <br>  But of course, it makes no sense to write everything; it is often easier to take ready-made solutions. <br><img src="https://habrastorage.org/getpro/habr/post_images/807/c32/0f7/807c320f724818c1b8ddddd9ac0533c4.jpg" align="right"><br>  For video surveillance, I did not reinvent the bikes and used the OpenSource system <a href="http://www.zoneminder.com/">ZoneMinder</a> , especially since it has a very good API that allows, for example, to enable / disable recording according to the rules I need.  Or vice versa, hang your event handling when movement appears in a protected area.  She can also give the image from the camera. <br><br>  <b>User interface</b> <br>  The system has three main management interfaces: <br><ul><li>  Classic (switches on the walls) </li><li>  Native Android application </li><li>  Web interface </li></ul><br>  From the point of view of the system, a <b>classic</b> switch is simply a sensor-key, which with the help of triggers is attached to any control.  If desired, you can tie, for example, a switch in the kitchen to the light in the nursery (which I usually do on the 1st of April) <br><img src="https://habrastorage.org/getpro/habr/post_images/533/e2e/560/533e2e56058fb7e54a6956d9f48e52ca.jpg"><br><br>  Since, while writing the <b>Android</b> application, I was fascinated by the Star Trek TV series, I also made a theme for the style of the terminals from this cult tape. <br>  The terminal has a main window that displays the general state of the system: <br><img src="https://habrastorage.org/getpro/habr/post_images/6ef/230/cae/6ef230cae479b2f9cc57cd3fd19258c8.png"><br>  On the left - the general condition. <br>  In the middle - an apartment plan, with a display of the state of the main controls and sensors. <br>  Above is a common information panel for the entire application. <br>  On the right - the main buttons (turn off all, street sensor monitor, settings) <br><br>  Windows for each room.  Actually, in each room where the tablet hangs, the window of this particular room is open and the lighting is turned on / off with one touch of a rather large button, which does not cause any inconvenience. <br><img src="https://habrastorage.org/getpro/habr/post_images/7fe/8f5/ed9/7fe8f5ed908b737f77d5815925520e7e.png"><br><br>  Also in each room you can see different information on the sensors, for example, a temperature graph <br><img src="https://habrastorage.org/getpro/habr/post_images/eb4/dd3/eba/eb4dd3ebaf2b8f871ec64ff53c00ba14.png"><br><br>  I am not a designer and not a <s>layout</s> <b>fronder,</b> so <b>my web interface</b> is simple, clumsy and minimalist. <br><img src="https://habrastorage.org/getpro/habr/post_images/7e5/cb8/985/7e5cb89858f918674a91455c226ab811.png"><br>  Upper Blocks - Monitoring <br>  Left - control and trigger management <br>  In the center - video surveillance <br>  On the right - reference information not directly related to the "smart home". <br><br>  It was originally intended to use classic switches on the walls as the main interface in the children's habitats, and where adults use Android tablets instead of switches, but life seems to make its own adjustments.  So, it turned out that children are much more interesting to poke on the tablet, and my wife is more like ordinary buttons. <br><br>  UP: <br>  Continued here <a href="http://habrahabr.ru/post/198842/">Smart home, as I sunk to such.</a>  <a href="http://habrahabr.ru/post/198842/">Part 3</a> </div><p>Source: <a href="https://habr.com/ru/post/167797/">https://habr.com/ru/post/167797/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../167779/index.html">Antisploit: antivirus industry in the fight against exploits (essay)</a></li>
<li><a href="../167783/index.html">From code to product. Ciklum Speakers' Corner, Dnepropetrovsk</a></li>
<li><a href="../167787/index.html">modern.IE - testing sites for Internet Explorer just got easier!</a></li>
<li><a href="../167789/index.html">Asus K95VJ laptop video review</a></li>
<li><a href="../167793/index.html">Form Validation in AngularJS</a></li>
<li><a href="../167799/index.html">Gaming technology - to life</a></li>
<li><a href="../167801/index.html">Statistics in Teradata DBMS</a></li>
<li><a href="../167803/index.html">The most notable problems of cloud providers for 2012</a></li>
<li><a href="../167805/index.html">IOS Alarm Log Demystification</a></li>
<li><a href="../167807/index.html">Yandex Map Kit for Android. Card rotation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>