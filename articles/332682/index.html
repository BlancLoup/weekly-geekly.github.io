<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Oracle Data Integrator. SubstitutionAPI: The order of the substitutions. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Who is this article for?  This article is intended for experienced ODI (Oracle Data Integrator) developers. Here are considered poorly documented aspe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Oracle Data Integrator. SubstitutionAPI: The order of the substitutions. Part 1</h1><div class="post__text post__text-html js-mediator-article"><div class="spoiler">  <b class="spoiler_title">Who is this article for?</b> <div class="spoiler_text">  This article is intended for experienced ODI (Oracle Data Integrator) developers.  Here are considered poorly documented aspects related to the order of execution of BeanShell-substitutions. <br></div></div><br><h2>  The%? $ @ Substitutions </h2><br>  Calm  ‚Äú%? $ @‚Äù Is not a euphemism, but special characters used for different types of BeanShell substitutions.  Although in this way the developer could say about them, who decided to use them all together, and without understanding a number of subtleties.  Meanwhile, it is an extremely powerful tool that provides flexible generation of code executed in scripts. <br><br>  When and where are the substitutions performed?  Do they repeat in the Target code for each source line?  Can I embed substitutions of different levels?  And the same?  If I declared a Java variable, where can I still use it?  Why sometimes the Substitution API functions do not work, and sometimes they work (it is not documented at what level of substitutions which functions are applicable)?  And so on.  A series of articles is devoted to these poorly documented subtleties.  And this is the first one. <br><a name="habracut"></a><br>  A common feature of any substitutions is that the code in the language <a href="http://www.beanshell.org/manual/bshmanual.html">BeanShell Script</a> is executed inside the substitution.  Handling substitutions is like parsing JSP or PHP.  Similarly, there are two syntax substitutions: short and full.  In short, the substitution contains only an expression whose result replaces this substitution when executed. <br><br><pre><code class="java hljs">&lt;%=odiRef.getSysDate(<span class="hljs-string"><span class="hljs-string">"yyyy-MM-DD HH:mm:ss.SSS"</span></span>)%&gt;</code> </pre> <br>  The full syntax contains a full BeanShell code that can ‚Äúprint‚Äù something using <b>out.print ()</b> , or not do it at all, and do other useful work on the sly.  In the latter case, after performing the substitution, it is simply removed from the code without leaving any traces there. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs">&lt;%out.print(odiRef.getSysDate(<span class="hljs-string"><span class="hljs-string">"yyyy-MM-DD HH:mm:ss.SSS"</span></span>));%&gt;</code> </pre> <br><h2>  Substitution levels </h2><br><h3>  % Level </h3><br>  Substitutions of the form &lt;% ...%&gt; are executed immediately at the start of the session even before, and physically this substitution is performed on the host that performs the launch.  That is, if you run an ODI session from the designer, then the% substitution takes place on your workstation, and if the substitution script decides to access, for example, the file system (and in beanshell, in addition to all the Java features, there are also native functions ), then it will see your local disk.  When an already assembled ODI script is launched ‚Äî a call to an <a href="https://docs.oracle.com/cd/E17904_01/integrate.1111/e12643/running_executions.htm">InvokeStartScen</a> operation or a launch from the scheduler ‚Äî then the client initiating the launch is the ODI agent itself: the physical place of the% substitution is the ODI agent server. <br><br>  If an exception occurs during the execution of the% -flash, then a crash does not occur.  The whole stack of errors falls into output, it becomes the result of the substitution.  This result becomes the source code (already invalid), which will try to be interpreted at the next level, and the session will be dropped there. <br><br>  This substitution does not work inside the Set Variable and Evaluate Variable steps.  That is, it is perceived there as plain text and is not processed in any way. <br><br>  From this level, you can not connect to either the source or the target connection, but only to the work repository.  Those.  odiRef.getJDBCConnection ("WORKREP") is already available, but neither this function with other arguments nor getJDBCConnectionFromLSchema () work.  Because no connections yet exist: the work of the session has not yet begun. <br><br><h3>  Level? </h3><br>  So, the script is already in the agent and started to run.  Session created.  For the first step (step), the final code generation takes place: an entry appears in <b>SNP_STEP_LOG</b> , and the final code of all tasks of this step is formed.  This is where the &lt;? ...?&gt; Substitution is performed.  After successful execution (or in the absence of substitutions) records are created in <b>SNP_SESS_TASK_LOG</b> , where the result is placed - the final code.  If an error occurs during interpretation, the entry in <b>SNP_SESS_TASK_LOG is</b> not created, and the error message must be searched above - in <b>SNP_STEP_LOG</b> .  When the whole step is prepared, it immediately begins running.  The interpreter? -Computing will resume work before the next step. <br><br>  The? substitution is similarly ignored in the Set Variable and Evaluate Variable steps.  It is already possible to use source- and target-connections, receiving them with the odiRef.getJDBCConnection function, in this substitution.  This means that for flexible code generation, you can attract data lying somewhere in the tables. <br><br><h3>  Level $ </h3><br>  This is a special level that is performed immediately before the execution of the task (task), and the result of this substitution is used to update the record in SNP_SESS_TASK_LOG.  Moreover, if the $ -permutation prints something, and within the substitution, ODI-variables are used, then in the logs you will see the values ‚Äã‚Äãof the variables, and not the names, as usual.  That is, this substitution can be effectively used to see the value of the variable in the operator logs. <br><br>  In addition, $ -permutation is the only place where you can call the function <b>odiRef.setTaskName ()</b> , which does not print anything, but changes the name of the task in the logs.  In fact, these are the only two applications where $ substitution is useful. <br><br>  And this substitution also does not work in the Set Variable and Evaluate Variable steps. <br><br><h3>  Level @ </h3><br>  Not so final is the final task code, as it turned out.  The interpretation and execution of the final code is carried out in the language corresponding to the technology, but in the code of any technology, you can include the @ -substitution with Java BeanShell code.  Naturally, the substitution is performed first.  If it prints something, then it additionally modifies the ‚Äúfinal‚Äù task code before execution. <br><br>  The @ -substitution can be applied in the Set Variable step.  Thus, an ODI variable can be easily assigned to the result of a java-expression.  There is still nothing in the Evaluate Variable.  If an exception occurs during the substitution, then the session falls at the current step. <br><br><h2>  Source or Target, who is first? </h2><br>  Any session in ODI consists of steps, in each step there is one or several tasks, and in each task there are always 2 levers ‚Äî source and target.  Even, for example, refresh or set by an ODI variable is the same task, just with an empty body source.  Since substitutions can be on both shoulders, it is interesting, and sometimes it is important to know which one will be executed before.  Because it is important to first declare and assign a java-variable, and then use, and not vice versa. <br><br>  Surprisingly, but the% substitutions?  and $ are executed first for the target leverage, and then for the source.  But the @ -subscription is the opposite. <br><br>  Knowing this property, you can correctly initialize variables, functions, script objects, and the usual BeanShell classes, and then use them correctly. <br><br><h2>  Repetition of @ -substitution </h2><br>  With other levels, it's simple.  Target is interpreted first and then Source.  With level @ everything is different, and depends on many factors. <br><br>  Suppose we have selected Oracle technology on sorce- and on target-leverage, which supports prepareStatement.  And also on both shoulders there are @ -compositions.  In such a situation, there is a limitation: the source can only use select.  It is impossible to perform both there and there, for example, a pl / sql-block. <br><br>  If there is a non-empty code on the source-shoulder, then it is executed first.  Accordingly, before executing the source code, the substitutions are performed in it once. <br><br>  Source gives us a ResultSet, which ODI is obliged to fetch, and for each fetch try to fulfill the target leverage.  You can access the Source-fields in different ways.  You can use the entry <b>: FILAMENT NAME</b> or <b># FAMILY NAME</b> .  If the target-technology driver supports the prepareStatement operation (this is typical for all JDBC drivers) and only the notation is used <b>: field_NAME</b> for the fields, then ODI performs the @ -substitution and prepareStatement once.  And then for each fetch, it performs only the binding of variables and the execution of the operator. <br><br>  If at least once a reference is used for the field via # (which means simple text substitution), or the driver does not support prepareStatement, then the formation of the target operator will be special (individual) at each iteration, so the @-substitutions will be performed multiple times. <br><br>  Consider an example: <br><br>  Source: <br><br><pre> <code class="sql hljs">&lt;@long i=0L;@&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> f1, f2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    10  */</span></span></code> </pre><br>  Target (option 1): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> stored_Procedure(&lt;@=++i@&gt;, :f1, :f2); <span class="hljs-comment"><span class="hljs-comment">/*     = 1,      1   prepareStatement */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre><br>  Target (option 2): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> stored_Procedure(&lt;@=++i@&gt;, <span class="hljs-comment"><span class="hljs-comment">#f1, #f2); /*    = 1, 2, 3.....   ,       ,       i   10, ..   */ end;</span></span></code> </pre><br>  In the first variant, @ -subblings are performed 1 time when prepareStatement occurs.  And in the second, each fetch gives rise to the formation of a new operator text and a new implementation of @ -substitution. <br><br>  If the target-technology does not provide for the ability to do prepareStatement, (for example, OdiTools), then accessing the source-fields through the colon is either impossible or not different from #. <br><br>  In future articles, we will consider other difficulties associated with substitutions and the use of the Substitution API.  In particular, <a href="https://habrahabr.ru/company/raiffeisenbank/blog/332738/">next time we will tell about the nested, including recursive, interpretation of</a> substitutions of the same and different levels.  A lot of unexpected discoveries are waiting for you and you will exclaim more than once: ‚ÄúOh, here‚Äôs why it works that way!‚Äù </div><p>Source: <a href="https://habr.com/ru/post/332682/">https://habr.com/ru/post/332682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332670/index.html">Smart IDReader SDK - add recognition to Android apps</a></li>
<li><a href="../332672/index.html">Google will soon cease to trust all certificates WoSign and StartCom</a></li>
<li><a href="../332674/index.html">Why I switched from React to Cycle.js</a></li>
<li><a href="../332676/index.html">3D mouse integration in Renga</a></li>
<li><a href="../332678/index.html">Understanding oracles in the blockchain</a></li>
<li><a href="../332684/index.html">Vulnerability VKontakte: send a message with the page recovery code to someone else's number</a></li>
<li><a href="../332686/index.html">Meet Apache BookKeeper - a replicable log service</a></li>
<li><a href="../332688/index.html">Lecture about two libraries of Yandex for working with big data</a></li>
<li><a href="../332690/index.html">Automation IP-network. Part 2 - Monitoring the speed of opening Web pages</a></li>
<li><a href="../332692/index.html">Binary image segmentation using the level set method</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>