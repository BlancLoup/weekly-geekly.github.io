<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Storage. Multi-tier software-defined storage. Why, why, and how is implemented using the example of the MIRhosting cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The topic of clouds has recently become more and more in demand. Now, even in the Russian Federation, companies increasingly understand why they can u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Storage. Multi-tier software-defined storage. Why, why, and how is implemented using the example of the MIRhosting cloud</h1><div class="post__text post__text-html js-mediator-article">  The topic of clouds has recently become more and more in demand.  Now, even in the Russian Federation, companies increasingly understand why they can use this cloud and even begin to actively use it.  The more companies are interested in the clouds, the more questions arise for us, software developers for the cloud, on the implementation of new trends and technologies, and on service providers that provide the fault-tolerant work of the platform as a whole. <br><br>  In this article, I would like to share the experience of only one of the sides of the cloud, but at the same time, perhaps the most complex and important is the implementation of disk space.  The article was prepared by Andrey Nesterenko, an expert on cloud technologies at <a href="https://mirhosting.com/cloud">MIRhosting</a> , which is one of the hosting providers using Jelastic PaaS, who last month announced the opening of a third region of the cloud platform - in Russia. <br><img src="https://habrastorage.org/webt/a4/3u/ny/a43unyat_50wzxxuyft2impyhuc.png" alt="image"><br><a name="habracut"></a><br>  First, some background information on how the cloud platform works as a whole.  Yes, we are talking specifically about the cloud platform, and not about selling VPS and naming this action Cloud.  In our understanding, the key differences are fault tolerance (which, in particular, automatically excludes the use of local data storage), access to the ‚Äúunlimited‚Äù resource pool at any time, and <a href="https://docs.jelastic.com/pricing-model%3Futm_source%3Dhabr-mirhosting">payment upon the use of</a> these resources, and not for limits or tariffs.  The technical implementation of such a cloud requires the collaboration of all elements: equipment, network, orchestration, technical support. <br><br>  Below we describe how we implemented only one component - fault-tolerant disk space. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Software-defined storage (SDS) </h3><br>  Technologically, data storage runs on <a href="https://virtuozzo.com/products/virtuozzo-storage/">Virtuozzo Storage</a> .  For those who are not familiar with the idea is similar to other implementations of SDS, the most well-known open source solution is Ceph.  The choice of Virtuozzo Storage, rather than Ceph, is primarily related to commercial support and development, better <a href="https://virtuozzo.com/wp-content/uploads/vz7/doc/Virtuozzo7_Platform_Benchmarck_DS_EN_Ltr_20160720.pdf">performance characteristics</a> , and ‚Äúsharpened‚Äù live container migration and, as a result, the resiliency of these containers.  Also an important reason was that Jelastic offers this integration with VZ SDS out of the box.  I will write about Virtuozzo Storage, but with a few changes.  All this can be applied to Ceph, and to other similar solutions. <br><br>  So, architecturally in Virtuozzo Storage there are 2 components: Metadata Servers and Chunk Servers.  Data is cut into so-called chunks, i.e.  essentially binary "chunks".  These "pieces" are smeared over Chunk Servers, which can and should be as much as possible.  In practice, Chunk Servers is a separate drive (no matter if the HDD or SSD or NVME), that is, if we have one server with 12 drives, then we will have 12 Chunk Servers that provide RAID 0 performance.  Of course, there should be several such separate servers to ensure fault tolerance, 5 - the minimum recommended number.  The more servers and chunks on them, the better the performance and faster replication in case of failure of individual chank servers. <br><br>  The server metadata, respectively, manages all this mess from chunks of data spread across multiple chunk servers.  Only one metadata server is required for correct operation, but if it fails, the entire cluster will become inaccessible.  On the other hand, the more metadata servers, the more sags performance, since any i / o cluster action should be recorded on more and more servers.  There is also a classic problem with split brain: in case of failure of one or several metadata servers, the rest should remain in the ‚Äúmajority‚Äù in order to be guaranteed active and unique.  Usually, 3 metadata servers are made for small clusters, and 5 for larger ones. <br><br>  This is what a typical cluster looks like: <br><img src="https://habrastorage.org/webt/qc/xi/so/qcxiso6pspckkyc44zijdefb5sw.jpeg" alt="image"><br>  <i>(picture from the blog Virtuozzo, I think the guys will not mind)</i> <br><br>  The cluster administrator can set in the global settings how many replicas should be guaranteed to be available.  In other words, how many server chunk can fail without data loss?  Suppose we have physically 3 servers, each of which has 3 disks (chan-server) and we set the recommended value: 3 replicas.  The first thing that comes to mind is: what happens if one entire server fails and, accordingly, 3 chank servers on it? <br><br>  If 3 replicas of some data were recorded just on these 3 chank servers within one physical server, then these data will be lost, despite the fact that we still have 2 physical servers online with 6 chank servers on them.  To manage this situation, you can configure different levels of replication: at the chunk server level (not recommended), at the host level (by default) or at the rack level and at the building / location level. <br><br>  Returning to our example above, when using the default values ‚Äã‚Äã- at the host level, the metadata servers automatically determine which chank servers are located on the same physical servers, and provide replication to different physical machines.  In order for replication to work at the rack or location level, you need to specify which machine is in which rack and / or location.  In this case, fault tolerance will work at the level of different racks or even data centers.  This is exactly what we have done at MIRhosting: the data is divided into 2 independent data centers. <br><br><h3>  Enough theory, tell something really interesting. </h3><br>  So, using such SDS technologies, we get theoretically perfect fault tolerance, however, theory and white paper on the site is one thing, and practice and demanding customers are another <br><br>  The first thing you have to face is a network.  In a normal situation, the traffic between chunk servers is about 200 mbps and rarely exceeds 500 mbps.  The more servers, the more traffic is ‚Äúsmeared‚Äù across different servers.  But in case of failure of chank-server / servers, urgent replication begins to restore the correct balance of data.  And the more servers we have, the more data is gone, the more data begins to fly over the network, easily creating 5 Gbps and higher.  So, 10 Gbps network is the minimum requirement, as well as 9000 MTU (Jumbo frames).  Of course, if we want to provide really good fault tolerance and overall stability, it is better to have two separate 10 Gbps switches and connect each data store through 2 ports. <br><img src="https://habrastorage.org/webt/hj/dl/2a/hjdl2anm4aziciaoocxhji_kfiy.png"><br>  By the way, this at the same time solves such a complex issue as updating the firmware in the switches. <br><br>  The second thing we decided was to ensure the operation of the cluster on the basis of dual data centers.  Initially, the network for the data warehouse worked on pure L2.  However, with the growth of the cloud platform as a whole and the amount of data storage as its component, in particular, we came to a logical decision that we need to switch to pure L3.  This step is very much tied to another topic - the work of containers in the conditions of dual data centers and live migration.  The network for the data storage was made similarly to the internal and external network of containers, for unification.  The topic is worth a separate article, I hope it will be interesting to the community.  No performance degradation with the transition to L3 was observed. <br><br>  The third and probably most important thing is performance.  Clients are different, they have different requirements, different projects, and in the conditions of a public cloud this becomes a complex problem.  In itself, this is divided into 2 parts: the overall performance of the i / o cluster and the various required performance for different clients.  Let's start with the first. <br><br>  In many ways, the solution of the performance issue was carried out using the ‚Äúspear method‚Äù, since neither in the documentation nor in the information from the Virtuozzo technical support, there are no such best practices as such.  One support staff member of Virtuozzo, who spent 30 minutes of his time on the phone and told a lot of things, helped a lot.  Having collected all the available information, adding a little brain and passing through the colander of experience, we came to the following scheme: <br><img src="https://habrastorage.org/webt/ti/fv/kz/tifvkzh-z7a4prg3tnk9vj6dxps.png"><br>  Compute Node (node ‚Äã‚Äãwhere containers are started) - the system runs on SSD, it also hosts pfcache.  The second SSD, and recently NVMe - under the client‚Äôs cache.  And one or two SSD / NVMe for local chunks.  Using RAID1 is possible, but it seems to us at this stage in the development of SSD drives that are of no particular importance, given the automatic recovery of containers at failover in any case.  Client cache has less effect than chunk on compute node.  The system determines the nearest available chunk and tries to use it for ‚Äúhot‚Äù data. <br><br>  Storage Node (node, which is used only for chunks, without containers), obviously, is filled with SSD and NVMe.  HDD is historically still used, in fact, to provide "cold" replicas. <br><br>  HDD caching is not used, and we are already trying to completely replace HDDs with SSDs.  Those storage systems that still have HDDs are sure to work through a good raid card, RAID0, with a caching write operation, which improves the performance of these HDDs. <br><br>  The overall available cluster performance depends directly on the number of chunks, i.e.  drives. <br><br>  The second task is the need to regulate i / o in the conditions of a public cloud and various customer requests.  Each container in the cloud is assigned certain i / o limits on the number of operations (iops) and bandwidth (io limit through traffic).  At the moment, the cloud MIRhosting gives the default 500 iops and bandwidth of 200 Mb / s, which is almost equal to the double performance of the SATA HDD drive.  For the vast majority of customers, these numbers are more than enough, given that these limits are given for each container, which the customer can create in any quantities. <br><br>  However, some customers require increased i / o performance.  Obviously, this is solved by different limits for different clients.  But it is not economically profitable to have a cluster capable of giving, say, 10,000 iops per container (and having the appropriate stock), and selling its resources with lower limits. <br><br>  There is a good solution - it is the ability to use different levels in the data warehouse.  Let's say the first level will be built on SSD + HDD, and the second level will be built on SSD + NVMe. <br>  We will provide the stated characteristics and make it economically viable (which is directly related to the cost).  The transfer of containers from one level to another occurs ‚Äúlive‚Äù and is implemented in Jelastic PaaS as well as hourly pay, like other cloud resources. <br><img src="https://habrastorage.org/webt/tr/xt/hc/trxthctdycmtfptp9opxfoqmqwe.gif"><br>  Suppose we have one container, which is located on the first Compute node.  Its file system is divided into 5 chunks.  We also have a cluster configured to use 3 replicas, that is, each chunk will be hosted on 3 different servers.  The first slide of the gif is how the chunks will be placed when placed on tier 0. The following shows the process of crawling chunks onto Tier 1 carriers. <br><br>  At the moment, cloud storage resources are quite stable and difficult to imagine how you can live differently.  The failure of disks, and even the entire node, does not create any visible problems for customers and requires planned actions to replace and add disks. <br><br>  PS Already in the process of preparing this material, an article was published <a href="https://habrahabr.ru/post/341168/">habrahabr.ru/post/341168</a> , in which similar issues and topics are discussed.  Our article reflects a slightly different view on the same tasks and problems, and I would like to hope that it will be useful to the community. <br><br>  The mentioned drawbacks in the article would also be interesting to consider separately, but most of these drawbacks are not related to the data storage itself, but to the more global work of the cloud, in particular with migration issues. <br><br>  If the topic is interesting, we can share our own developments on the work of containers within the cloud on the basis of dual data centers.  In particular, from the network and live migration under such a scheme. <br><br>  In general, I have to agree with SyCraft that there are bugs, and the technical support of Virtuozzo cannot always clearly say what is happening and why.  Nevertheless, this solution, in fact, is the only one in its class, which provides the necessary set of services, is actively developing and is commercial, that is, supported by developers. <br><br>  You can try this solution of fault-tolerant disk space in combination with automatic distribution and orchestration of containers, taking into account the specifics of a specific application from Jelastic PaaS, as well as the performance of the MIRhosting infrastructure by <a href="https://jelastic.cloud/details/mirhosting%3Futm_source%3Dhabr-mirhosting">registering with the link</a> .  We welcome your feedback. </div><p>Source: <a href="https://habr.com/ru/post/342278/">https://habr.com/ru/post/342278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342266/index.html">Digital events in Moscow from November 13 to 19</a></li>
<li><a href="../342268/index.html">Digital power industry</a></li>
<li><a href="../342270/index.html">The office writes: adult chatting on the site</a></li>
<li><a href="../342272/index.html">Intel processor frequency control rakes</a></li>
<li><a href="../342276/index.html">Weekdays tester, or what's the Pyramid of Maslow</a></li>
<li><a href="../342280/index.html">HistoryAPI: How to write once, and so that the head does not hurt</a></li>
<li><a href="../342282/index.html">Question: Does the software really use the new instruction sets?</a></li>
<li><a href="../342284/index.html">New release Oh, My Code - Cloud, Perl and good programmers</a></li>
<li><a href="../342286/index.html">Bible movements doom. Part 2</a></li>
<li><a href="../342288/index.html">SparrowHub Plugin Overview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>