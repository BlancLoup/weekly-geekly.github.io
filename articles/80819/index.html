<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How-to install gitosis (manual taking into account problems arising during installation) + integration into redmine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="gitosis - software for hosting Git repositories 


 Installation: 

 An auto install script appeared while testing 
 sudo apt-get install python-setup...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How-to install gitosis (manual taking into account problems arising during installation) + integration into redmine</h1><div class="post__text post__text-html js-mediator-article"><h4>  gitosis - software for hosting Git repositories </h4><br><img align="right" src="https://habrastorage.org/getpro/geektimes/post_images/125/7e7/b66/1257e7b667e0e4fb0f257bc628c68525.png" alt="image"><br><br><h5>  Installation: </h5><br><br><blockquote> An auto install script appeared <b>while testing</b> <br> <code>sudo apt-get install python-setuptools git-core -y <br> mkdir ~/src <br> cd ~/src <br> git clone git://github.com/sc0rp1us/gitosis-tools.git <br> cd gitosis-tools/gitautoinstall <br> sudo bash main <br></code> <br>  Next, follow the script instructions. <br></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But back to the article <br>  First, install the necessary components to run gitosis: <br><ul><li>  For debian &amp; ubuntu, run the following commands from the root user </li></ul><br><blockquote> <code>apt-get update <br> apt-get upgrade <br> apt-get install python-setuptools git-core -y <br> cd ~/src <br> git clone git://eagain.net/gitosis.git <br> cd gitosis <br> python setup.py install</code> <br> </blockquote><br><br>  Next, let's log into the account through which we will manage gitosis'om (let's call it gitadmin), unload the distribution and install it <br><br><h5>  Setup: </h5><br><br>  Now we will need to create a user who will own the repository (the name can be any, but I prefer to use just git), besides, there may be several accounts owning the repositories on the same server, such an account does not need a password, but a valid shell is needed otherwise SSH will refuse to work with him: <br>  PS You can of course use an existing account, but for security reasons, it is not recommended to do this <br><a name="habracut"></a><br><ul><li>  For debian &amp; ubuntu, run the following command. </li></ul><br><br><blockquote> <code>sudo adduser --system --shell /bin/sh --gecos 'git version control' --group \ <br> --disabled-password --home /home/git git</code> <br> </blockquote><br><br>  Now we create RSA key for passwordless access. <br><br><blockquote> <code>ssh-keygen -t rsa</code> <br> </blockquote><br>  Next, we need to execute an initialization command, it will create / home / git / repositories, which will contain the git repositories, and / home / git /.  gitosis.conf, which is a symbolic link to the configuration file /home/git/repositories/gitosis-admin.git/gitosis.conf itself, and adds the SSH public key to the .ssh / authorized_keys also adding the option = to it = which will restrict ssh access start gitosis-serve. <br><br><blockquote> <code>sudo -H -u git gitosis-init &lt; /home/gitadmin/.ssh/id_rsa.pub</code> <br> </blockquote><br><br><h6>  <s>IT HANDLING SHOULD DO IT ALL, BUT DO NOT ALWAYS DO FAR OTHER, THERE ARE OF THE APPLICANTS OF THE OVEN, TAKE A CLEANING OF THE OVEN, LEFT HAND, AND A LIGHT MOTION OF THE HAND OF THE OTHER ARE THE PRO THE MAUR OF THE PRO THE PRO THE MA THE PRO THE PRO THE MA THE PRO THE MA THE PRO THE MA THE PRO THE MA THE PRO THE MA THE PRO THE MA THE PRO THE MA THE PRO THE MA THE PRO THE MA THE PRO THE AP THE MA THE THE PRODUC THE THE PRO THE THE AP THE MA THE THE PRODUC THE THE PRO THE THE AP THE MA THE THE PRODUC THE THE PRO THE THE AP THE MA THE THE PRODUC THE THE THE PRO THE THE AP THE MA THE THE THE PRO THE THE PRODUC THE THE PRODUC THE THE THE THE THE THE THE THE PRO THE THE THE THE THE THE THE CUR THE THE THE THE THE EFF.</s> </h6><br><br>  After that, we perform the following action (This crutch is needed not everywhere, let's say in Debian everything works without it, and RedHat users of such systems will most likely come in handy (This is the mysterious consideration of problems encountered during installation, or rather one of them)) <br><br><blockquote> <code>su - git <br> cat .ssh/authorized_keys | sed 's#gitosis-serve#/usr/local/bin/gitosis-serve#g' &gt; 0 <br> cat 0 &gt; .ssh/authorized_keys &amp;&amp; rm 0</code> <br> </blockquote><br><br>  By the way, some systems may have problems with PATH paths, so in the file below you will need to add the line ". / Etc / profile" after the "set -e" option <br><br>  <u>/home/git/repositories/gitosis-admin.git/hooks/post-update</u> <br><br>  Then clone the repository <br><br><blockquote> <code>git clone git@SERVER:gitosis-admin.git</code> <br> </blockquote><br><br>  and you will get the SSH keystore / home / gitadmin / gitosis-admin / keydir / (in which you will need to put the clients' public keys), and /home/gitadmin/gitosis-admin/gitosis.conf (in which you will need to write the repository settings) <br><br><blockquote> <code><b>git clone ssh://git@localhost/gitosis-admin.git</b> <br> Initialized empty Git repository in /usr/gitosis-admin/.git/ <br> remote: Counting objects: 5, done. <br> remote: Compressing objects: 100% (4/4), done <br> remote: Total 5 (delta 0), reused 5 (delta 0) <br> Receiving objects: 100% (5/5), done <br> <br> <b>sudo chmod 755 /home/git/repositories/gitosis-admin.git/hooks/post-update</b></code> <br> </blockquote><br><br><h6>  <i>A warning</i> </h6><br><br>  Now, gitosis uses the HOME environment variable to write files.  If you use sudo without the -H option, git will leave the old HOME value in place, and this will cause problems.  This can be bypassed in the future, but for now don't forget to use -H. <br><br>  You should always edit the configuration file via GIT.  File symbolic links to ~ /.  gitosis.conf on the server will be overwritten when sending changes to the gitosis-admin.git repository. <br><br>  Change the settings as desired, and commit and push. <br>  After sending to the server, gitosis will immediately make changes and apply them on the server. <br><br><h5>  Control </h5><br><br>  Adding new users: <br><br>  - Add keys / USER.pub file <br>  - Allow the group to read / write to the repository (or simply allow the <a href="https://geektimes.ru/users/all/" class="user_link">All</a> group) <br><br>  To create a new repository, simply grant the write access to the group and push. <br>  For example: suppose your username is jdoe and you want to create a repository MyProject. <br>  In your gitosis-admin clone, edit gitosis.conf and add: <br><br><blockquote> <code>[group myteam] <br> members = jdoe <br> writable = myproject</code> <br> </blockquote><br><br>  Now we need to send changes to gitosis <br><br><blockquote> <code>git add . <br> git commit -am 'add new project Michael Queally-1 and users' <br> git push</code> <br> </blockquote><br><br>  Now we need to re-initialize gitosis <br><br><blockquote> <code>sudo -H -u git gitosis-init &lt; /home/gitadmin/.ssh/id_rsa.pub <br> su - git <br> cat .ssh/authorized_keys | sed 's#gitosis-serve#/usr/local/bin/gitosis-serve#g' &gt; 0 &amp;&amp; \ <br> cat 0 &gt; .ssh/authorized_keys &amp;&amp; rm 0 <br></code> <br></blockquote><br><br>  Create a repository on the local machine in the account where the PUBLIC key was taken from <br><br><blockquote> <code>mkdir myproject <br> cd mypyroject <br> git init <br> git remote add MYSERVER git@MYSERVER:myproject.git <br> touch testfile <br> git add . <br> git commit -am 'add test file' <br> git push MYSERVER master:refs/heads/master <br></code> <br></blockquote><br><br>  That's all.  Now, if you add other members to members, they will also be able to use this repository. <br><br><h5>  Integration into redmine: </h5><br><br>  Create a directory for bare repositories, and set the owner <br><br><blockquote> <code>mkdir -p /srv/redmine/git_repositories/ <br> chown wwwrun:wwwrun /srv/redmine/git_repositories/ <br></code> <br></blockquote><br><br>  We generate the ssh key for the user under which the web server works (in my case it is apache) <br><br><blockquote> <code><b>sudo -H -u wwwrun ssh-keygen</b> <br> Generating public/private rsa key pair. <br> Enter file in which to save the key (/var/lib/wwwrun/.ssh/id_rsa): <br> Created directory '/var/lib/wwwrun/.ssh'. <br> Enter passphrase (empty for no passphrase): <br> Enter same passphrase again: <br> Your identification has been saved in /var/lib/wwwrun/.ssh/id_rsa. <br> Your public key has been saved in /var/lib/wwwrun/.ssh/id_rsa.pub. <br> The key fingerprint is: <br> 86:58:61:7b:56:5e:55:85:74:4f:12:33:ad:dc:1f:90 wwwrun@vzserv <br> The key's randomart image is: <br> +--[ RSA 2048]----+ <br> | o . o**+* | <br> | oo ..Eo+. | <br> | .. o. . | <br> | o .. | <br> | .. | <br> | . | <br> | | <br> | | <br> | | <br> +----------------------+ <br></code> <br></blockquote><br><br>  Add a key to keydir and assign rights to it. <br><br><blockquote> <code>cp /var/lib/wwwrun/.ssh/id_rsa.pub /home/gitadmin/gitosis-admin/keydir/wwwrun@vzserv.pub <br> chown gitadmin:gitadmin /home/gitadmin/gitosis-admin/keydir/wwwrun@vzserv.pub <br></code> <br></blockquote><br><br>  Add user to repository <br><br><blockquote> <code><b>su - gitadmin <br> cd gitosis-admin/ <br> vim gitosis.conf #       <br> git add . <br> git commit -am 'add redmine'</b> <br> Created commit 7f94aac: add redmine <br> 2 files changed, 2 insertions(+), 1 deletions(-) <br> create mode 100644 keydir/wwwrun@vzserv.pub <br> <br> <b>git push</b> <br> Counting objects: 8, done. <br> Compressing objects: 100% (5/5), done. <br> Writing objects: 100% (5/5), 745 bytes, done. <br> Total 5 (delta 2), reused 0 (delta 0) <br> To git@127.0.0.1:gitosis-admin.git <br> 608aa58..7f94aac master -&gt; master</code> <br> </blockquote><br><br>  We re-initiate gitosis (after which it will recreate .ssh / authorized_keys, but sometimes it does it crookedly) <br><br><blockquote> <code><b>sudo -H -u git gitosis-init &lt; /home/gitadmin/.ssh/id_rsa.pub</b> <br> gitadmin's password: <br> Reinitialized existing Git repository in /home/git/repositories/gitosis-admin.git/ <br> Reinitialized existing Git repository in /home/git/repositories/gitosis-admin.git/ <br></code> <br></blockquote><br><br>  We do a couple of shaman actions replace in <b>.ssh / authorized_keys gitosis-serve</b> with <b>/ usr / local / bin / gitosis-serve</b> <br><br><blockquote> <code>su - git <br> cat .ssh/authorized_keys | sed 's#gitosis-serve#/usr/local/bin/gitosis-serve#g' &gt; 0 &amp;&amp; cat 0 &gt; .ssh/authorized_keys &amp;&amp; rm 0 <br></code> <br></blockquote><br><br>  Create a directory for the bare repository and make the correct git clone <br><br><blockquote> <code><b>cd /srv/redmine/git_repositories</b> <br> <br> <b>sudo -H -u wwwrun git clone --bare git@127.0.0.1:PROJECTNAME.git <br> cd PROJECTNAME <br> sudo -H -u wwwrun git --bare remote add origin git@127.0.0.1:PROJECTNAME.git <br> ls</b> <br> HEAD branches config description hooks info objects packed-refs refs</code> <br> </blockquote><br><br>  Now we are writing a script for self-updating the local redmine repository, I called it gir (gitosis-in-redmine) and save it, say in / root / scripts <br><blockquote> <code>#!/bin/sh <br> #The script for pull in bare gitosis repository <br> <br> #set var <br> uname=wwwrun #         httpd(   apache2) <br> rdir=/srv/redmine/git_repositories #     bare  <br> tmpls=/tmp/tmpls #  temp  !!!        !!! <br> #end var <br> <br> #start check <br> if [ `whoami` == $uname ] <br> then <br> <br> #start exec <br> touch $tmpls <br> ls -1 $rdir &gt; $tmpls <br> while read LINE; do <br> cd $rdir/$LINE <br> git --bare fetch origin :master <br> echo "update git repository $LINE" <br> done &lt; $tmpls <br> rm $tmpls <br> #end exec <br> <br> else <br> echo "Start me from the user $uname" <br> fi <br> #end check <br></code> </blockquote><br><br>  And add it to cron. <br><br><blockquote> <code>echo "10 * * * * wwwrun /root/scripts/gir" &gt;&gt; /etc/crontab <br> /etc/init.d/cron restart <br> Shutting down CRON daemon done <br> Starting CRON daemon <br></code> <br></blockquote><br><br>  Now the relevance of this repository for resmine will be 10 minutes <br>  Next, open the browser and go to the Redmine ( <u>Do not forget that this bare repository should be on the same server together with Redmine'om</u> ) <br>  Click the following sequence <br><br>  <b>Projects&gt; projectname&gt; Settings&gt; Repository&gt;</b> <br><br>  Next, in the <b>SCM</b> field, select <b>GIT</b> , and in the <b>Path to .git directory</b> field <br>  prescribe the path we got <b>/srv/redmine/git_repositories/PROJECTNAME.git</b> <br><br>  And actually everything! </div><p>Source: <a href="https://habr.com/ru/post/80819/">https://habr.com/ru/post/80819/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../80803/index.html">HP Compaq T5000 - Home Seedbox</a></li>
<li><a href="../80804/index.html">pytesser - Python OCR Library (Optical Character Recognition)</a></li>
<li><a href="../80805/index.html">The art of caring for your monkeys</a></li>
<li><a href="../80812/index.html">Boxes of flash drives</a></li>
<li><a href="../80813/index.html">We write a parser on Java + MySQL</a></li>
<li><a href="../80820/index.html">Internet Explorer vulnerability exploited in Google</a></li>
<li><a href="../80821/index.html">Coke mobile phone</a></li>
<li><a href="../80822/index.html">UFO: Alien Invasion</a></li>
<li><a href="../80823/index.html">Backstage hotmail</a></li>
<li><a href="../80827/index.html">Pron on the Moscow billboard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>