<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>From Rails 4 to Rails 5: how it was</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once there was a cloud service provider and he wanted to keep up with progress. And he decided to upgrade from Rails 4.2.8 to Rails 5.0.2. And how it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>From Rails 4 to Rails 5: how it was</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/9f1/9ba/6d0/9f19ba6d0eb34211a686f46df70648e7.png" align="left">  Once there was a cloud service provider and he wanted to keep up with progress.  And he decided to upgrade from Rails 4.2.8 to Rails 5.0.2.  And how it was, that fell off along the way, that vdarilo on the forehead with acceleration and what experience from this carried out - read under the cut. </p><a name="habracut"></a><br><p>  I will narrate separately, since most of the features and problems are in no way connected with each other.  Therefore, if you meet something dull or famous - feel free to move on to the next item, it may be more interesting there. </p><br><p>  The purpose of the story: there will be no universal transition algorithm, I just want to share the information found and the details of varying degrees of intimacy about why you can‚Äôt just go to Rails 5 by correcting versions in Gemfile. </p><br><h2 id="anamnez">  Anamnesis </h2><br><p>  Our application is average: Ruby 2.2.3, three with a tail, hundreds of gems, ~ 1500 action games, postgres, elastic, radish.  In general, nothing special.  Is that the tests covered by 90% +.  This, it seems, is not very typical for some modern applications. </p><br><h2 id="nachnyom-s-nachala">  Start over </h2><br><p>  Although Rails 5.2 is already looming on the horizon, no one is in a hurry to update the major version.  Therefore, the Internet is not so much information about the features of the transition, as we would like.  There is a more or less informative description <a href="http://mensfeld.pl/2015/12/upgrading-to-ruby-on-rails-5-0-from-rails-4-2-application-use-case/">here</a> .  There are reductions for <a href="http://edgeguides.rubyonrails.org/5_0_release_notes.html">5.0</a> and <a href="http://edgeguides.rubyonrails.org/5_1_release_notes.html">5.1</a> (by the way, who won't read them yet?).  There is <a href="http://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html">off-road</a> with the main steps to upgrade to Rails 5. It‚Äôs good, but I want more information, especially regarding gems, their compatibility and other facilities, which usually fall off during updates.  Although, in fairness, if we had studied it in more detail, we would not have walked through a pair of noble grabeleks (they will be discussed below).  Therefore, further I will mention some points from the guide (that is, some basic changes), which, however, turned out to be quite important for us. </p><br><h2 id="prichiny-osnovnyh-problem-ili-vmesto-tldr">  Causes major problems or instead of TL; DR </h2><br><ul><li><p>  Some of the gems used are either poorly compatible or not compatible with Rails 5 at all, which is why they have to either be cut and replaced with the native capabilities of the rails, or to finish the gems to working condition.  In any case, you need to pick them and answer the questions: "how did it work?", "Will it work?", "What should it do to make it work?".  Then start to fork / contribute / patch. </p><br></li><li><p>  Updates of major versions of gems following the major version of Rails and, therefore, major changes in interfaces, APIs, and other squiggles that gems provide.  This entails mass replacements and / or re-cutting what previously worked and did not ask for food. </p><br></li><li>  Core_ext, the beloved and hated by everyone: core and gem patchies for personal use.  The most vicious shoals were precisely because of them.  There are a lot of questions like: "why did they do it and how did it work?", "Why did they do it like that?", "And in the new version of gem they rewrote everything to hell, what to do?". </li></ul><br><h2 id="obnovlenie-gemov">  Gems update </h2><br><p>  For something to fall, you need to update something.  Naturally, you need to start with the rails heme and its dependencies.  Here you can hang on a day or two, and there are no recipes.  Just a lot of dancing with a tambourine around <em>Gemfile</em> , <em>Gemfile.lock</em> and a gradual understanding of the fact that the update will need even a good half of everything that is in the project, so that at least it will be bundled.  The stages are as follows: </p><br><ul><li>  fuck, </li><li>  the console starts up </li><li>  starting the server </li><li>  There are at least 3 (three) actions / requests in a row. </li></ul><br><h2 id="zhest-kak-ona-est">  Tin as it is </h2><br><p>  Now at odds with everything. </p><br><h4 id="alias_method_chain-vypilivaetsya">  alias_method_chain cut </h4><br><p> For those who still do not know: now you need to do <code>prepend</code> .  In short: this thing adds a module after the class, and not before, like the well-known <code>include</code> .  As a bonus, we get <code>super</code> instead of with / without methods.  Details and examples look <a href="http://www.justinweiss.com/articles/rails-5-module-number-prepend-and-the-end-of-alias-method-chain/">here</a> . </p><br><h4 id="mnogo-novyh-defoltnyh-konfigov">  Many new default configs </h4><br><p>  They are generated via <code>rails app:update</code> .  But this problem is very dull and just creates files, and if you already had one of them, merge yourself and let the force come with you. </p><br><h4 id="gem-device_async">  Heme device_async </h4><br><p>  For new versions of the device, it is not needed and is replaced by a couple of lines of code by <a href="https://github.com/plataformatec/devise">off-mantle</a> .  In fairness, it works starting with Rails 4.2, but in the 5th rails the gem finally stops working and you still need to rewrite everything to ActiveJob. </p><br><h4 id="gem-cancan">  Heme cancan </h4><br><p>  It needs to be replaced by <a href="https://github.com/CanCanCommunity/cancancan">CanCanCan</a> .  Since CanCan is running out of support and a cloud of deprecation is pouring in, which will become a problem in Rails 5.1.  In general, there should be no big replacement problems.  We had our CanCan endings under <a href="https://github.com/activeadmin/inherited_resources">inherited_resources</a> , so we suffered a bit more. </p><br><h4 id="gem-grape-swagger">  Heme grape-swagger </h4><br><p>  We had <del>  extended </del>  patched option.  He was able to substitute the API-key in the request.  But the drinker in the last major version of the Swagger happened notable.  Therefore, after switching to 3.0, we could not find any familiar landmarks and the old patch was stupid to insert nowhere.  As a result, it turned out that there is now a documented feature for custom http-headers, but it didn‚Äôt take off and had to be a little <a href="https://github.com/ruby-grape/grape-swagger/commit/95675e33b100555e8cc153e4831ac4a66a50ccdc">contributory</a> .  Now everything works. </p><br><h4 id="vstavka-nevalidnyh-obektov-v-has_many-associaciyu">  Insert invalid objects in has_many association </h4><br><p>  When the association of an invalid object is inserted into has_many, everything falls in Rails 5 (the object is persisted and invalid we only made it in memory).  Previously there was a preservation and the original object from the database got into association, and the changes from the memory either skipped (or skipped validation), or xs that happened to it, did not dig deep. </p><br><h4 id="concat-dlya-relation">  concat for Relation </h4><br><p>  It is somewhere delhi and it does not work anymore. </p><br><h4 id="ne-bag-no-deprecation-pro-uniq">  Not a bug, but deprecation about uniq </h4><br><p>  Uniq was replaced with distinct and in 5.1 they finally uniq for Reilation.  As I understand it, it finally came to the realization that Relation, which mimics Array, is not a feature, but a lot of crap. </p><br><h4 id="gem-postgres_ext">  Heme postgres_ext </h4><br><p>  Need to decisively cut.  All that he <a href="">can</a> do is quite simply replaced with raw-sql and / or Arel.  The heme itself, for the time being, is not compatible with Rails 5. When trying to use it in new rails, we get errors in unexpected places, for example, when calling <code>count</code> on an STI class: </p><br><pre> <code class="ruby hljs"><span class="hljs-symbol"><span class="hljs-symbol">ArgumentError:</span></span> wrong number of arguments (given <span class="hljs-number"><span class="hljs-number">1</span></span>, expected <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-comment"><span class="hljs-comment"># /Users/username/.rvm/gems/ruby-2.3.3</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@gemset</span></span></span><span class="hljs-comment">/gems/arel-7.1.4/lib/arel/visitors/reduce.rb:12:in `visit' # /Users/username/.rvm/gems/ruby-2.3.3</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@gemset</span></span></span><span class="hljs-comment">/gems/postgres_ext-3.0.0/lib/postgres_ext/arel/4.1/visitors/postgresql.rb:22:in `block in</span></span></code> </pre> <br><h4 id="gem-simple_form">  Simple_form heme </h4><br><p>  For some reason, almost nothing happened to us.  He just continued to work.  The opportunity to do simultaneously <code>include_blank</code> and <code>require</code> for the field just fell off. </p><br><h3 id="raznoe-vokrug-activerecorda">  Miscellaneous around ActiveRecord </h3><br><ul><li>  AR swears on transfer in conditions of constants (in particular classes), speaks transfer lines, but not constants.  Actually, for example, in the case of a search in a table with STI: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#      Model.where(content_type: SharedFile) #    Model.where(content_type: SharedFile.name ) #   Model.where(content_type: 'SharedFile')</span></span></code> </pre> </li><li>  All models now need to inherit from <code>ApplicationRecord</code> instead of <code>ActiveRecord::Base</code> .  That is, an intermediate abstract class appears: <br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationRecord</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">abstract_class</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> </li><li><p>  Significantly changed the principle of database mapping in the model.  In particular, this concerns the <code>column_names</code> method.  It no longer returns the attributes defined by the user, for example, through <a href="https://apidock.com/rails/ActiveRecord/Attributes/ClassMethods/attribute">attribute</a> (details can be found in the diffs of this method in AR between 4 and 5 rails).  Now the concept of <code>attributes_to_define_after_schema_loads</code> appeared.  And now, if you have logic based on "virtual" attributes, and you want <code>column_names</code> to still return everything, you need to do something like this: </p><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">column_names</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">super</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">+</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attributes_to_define_after_schema_loads</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keys</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre> <br></li><li><p>  The constant <code>ActiveRecord::ConnectionAdapters::Column::TRUE_VALUES</code> .  As far as I know, many people used it and now there are two options: to bring her back with her hands, or to switch to using <code>FALSE_VALUES</code> , which was left alive. </p><br></li><li>  Passing the argument to <code>reload</code> (for force reload) is cut out.  Now you need to call reload on a specific relation.  For example: <br><pre> <code class="ruby hljs">first_model = Model.first first_model.has_many_relation_name.reload</code> </pre> </li><li><p>  Similar thing for has_one associations: </p><br><pre> <code class="ruby hljs">second_model = Model.second second_model.reload_has_one_relation_name</code> </pre> <br></li><li><p>  Stop <code>before_</code> callbacks when returning <code>false</code> - sawn.  Now you need to explicitly raise <code>throw(:abort)</code> in callbacks.  Here is the MR with a notable holivar about it. </p><br></li><li><p>  The raise_in_transactional_callbacks <code>raise_in_transactional_callbacks=</code> parameter is <code>raise_in_transactional_callbacks=</code> , which is responsible for throwing exceptions from <code>after_commit</code> / <code>after_rollback</code> in the event that false returns from them (he had previously quietly wrote a message to the log and could not throw out the action).  The thing was written down in Rails 4, but, it seems, very few people attended to the rewriting.  Now it's time, and soon the old behavior will be cut out. </p><br></li><li><p>  All <code>belong_to</code> have become mandatory by default.  To get everything in place, you need to poke the config.active_record.belongs_to_required_by_default parameter. </p><br></li><li><p>  There was the <code>ActiveRecord::Relation#update</code> method, which allows you to update the <code>Relation</code> , causing callbacks and validations.  In essence, this is sugar: there will be many queries to the database and inside it is just a map.  Details in <a href="https://github.com/rails/rails/pull/11898/files">mr</a> . </p><br></li><li>  Now you can do <code>LEFT JOIN</code> without side effects.  Prior to Rails 5, the <code>OUTER JOIN</code> could have been written explicitly via <a href="https://apidock.com/rails/ActiveRecord/QueryMethods/joins">joins</a> , or we could include <a href="https://apidock.com/rails/ActiveRecord/QueryMethods/includes">includes</a> + <a href="https://apidock.com/rails/ActiveRecord/QueryMethods/references">references</a> , or equivalent <a href="https://apidock.com/rails/ActiveRecord/QueryMethods/eager_load">eager_load</a> .  As an overhang, we get the download of all the above reports, since the main purpose of all of the above (with the exception of <code>joins</code> ) is to assist in solving N + 1.  Now there is <code>ActiveRecord::Relation#left_outer_joins</code> , which simply does the left join and nothing extra.  For details, go to <a href="https://github.com/rails/rails/pull/21762">mr</a> . </li></ul><br><h3 id="params-v-kontrollerah">  params in controllers </h3><br><p>  Now this is not <code>HashWithIndifferentAccess</code> , but an independent class <code>ActionController::Parameters</code> , which mimics a hash for backward compatibility, but swears strongly if it is used as a hash, that is, if they do <code>merge</code> , <code>update</code> , etc.  That is, if I correctly understood the idea, <code>params</code> two goals: to store what has come from the client and to filter the content using <a href="https://github.com/rails/strong_parameters">Strong Parameters</a> .  No other modifications are needed on it.  In other words, modifying data directly in <code>params</code> , exactly like adding yours there, is a bad form.  Make a separate object for these actions, either call <code>params.to_h</code> or even <code>params.to_unsafe_hash</code> and after that work with the hash as before. </p><br><h3 id="dobavlenie-oshibok-v-model-cherez-errors">  Adding errors to the model through errors [] = </h3><br><p>  <code>ActiveModel::Errors#[]=</code> cut in Rails 5.1, at the end you need to use <code>model.errors.add(:name, "can't be blank")</code> .  Messages in the logs about this, of course, are present. </p><br><h3 id="nemnogo-pro-arel">  Little about arel </h3><br><p>  If in <code>eq</code> (and, most likely, in any similar predicate) from Arel for the <code>id</code> field (with other fields everything is OK) to transfer the object itself, then in 4 rails an idish (pk) pulled out of this object and was substituted into the query, and in the 5th rails this does not happen.  Instead of trying to pull pk out of an object, it simply substitutes NULL and it turns out something like "account_id = NULL".  Example: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  Rails 4 MyModel.arel_table[:my_field].eq(MyModel.first).to_sql =&gt; "my_models"."my_field" = 1 MyModel.arel_table[:id].eq(MyModel.first).to_sql =&gt; "my_models"."id" = 1 #  Rails 5 MyModel.arel_table[:my_field].eq(MyModel.first).to_sql =&gt; "my_models"."my_field" = 1 MyModel.arel_table[:id].eq(MyModel.first).to_sql =&gt; "my_models"."id" = NULL</span></span></code> </pre> <br><p>  Therefore: try to always explicitly indicate the value. </p><br><h3 id="pro-skip_callback">  About skip_callback </h3><br><p>  <code>skip_callback(:create, :after, :my_method)</code> in 4 rails allows you to transfer any parameters and does not fall even if there is no such method in the chain of callbacks, in 5 rails a similar method raises an exception if you have not found a method that need to skipnut.  Therefore, strange falls can happen and will have to delve into industrial archeology in order to understand "was there a boy?". </p><br><h3 id="malenkaya-revolyuciya-v-render">  Little revolution in render </h3><br><p>  Change <code>:text</code> and other formats to an explicit indication of <code>mime_type</code> .  Replace <code>:nothing</code> on <code>:head</code> and so on.  That is, they return to their origins and make the names closer to the essence, and not accessible to any domohozkoy. </p><br><h3 id="izmenenie-poryadka-progona-testov">  Changing the test run order </h3><br><p>  Now the default order of the run <code>:random</code> .  If your tests depend on the execution sequence, this is not very good, but returning the old behavior is quite simple: </p><br><pre> <code class="ruby hljs">Rails.application.configure <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> config.active_support.test_order = <span class="hljs-symbol"><span class="hljs-symbol">:sorted</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><h3 id="observery">  Observers </h3><br><p>  They are in the 5th rails so far (or already) no one supports.  <a href="https://github.com/rails/rails-observers">The original observers</a> stopped at 4 rails.  In the wizard they have declared support for the 5th, but nothing works.  There is some Japanese with <a href="https://github.com/yasaichi/everett">an alternative to observers</a> for the 5th rail (which is very similar to copy-paste and rebranding), but this thing does not work either.  The best way out is to use native callbacks from AR. </p><br><h3 id="bagi-v-activerecord">  ActiveRecord bugs </h3><br><p>  Found a couple: </p><br><ul><li>  <a href="https://github.com/rails/rails/issues/28717">the first</a> is the old one about <code>uniq</code> on <code>ActiveRecord::Associations::CollectionProxy</code> , which turned out to be famous and has already been fixed in 5.1; </li><li>  <a href="https://github.com/rails/rails/issues/28718">the second</a> is new and more interesting: how can you implicitly freeze the attribute (s) on the AR model? </li></ul><br><h3 id="gem-shoulda-matchers">  Heme shoulda-matchers </h3><br><p>  Updated it to 3.1.1 and povladilo many different little things: </p><br><ul><li>  There is a default <code>email</code> check for case sensitive; </li><li>  the scope check has been tightened: if <code>should validate_uniqueness_of(:name)</code> before <code>should validate_uniqueness_of(:name)</code> passed even when <code>scope</code> for <code>uniqueness</code> specified in the model, then the test now drops and you need to explicitly indicate <code>should validate_uniqueness_of(:name).scoped_to(:vendor_id)</code> ; </li><li>  kosyachno checks serialized attributes and <code>should serialize(:metadata).as(Hash)</code> falls with <code>cast_type</code> ; </li><li>  Previously, the method <code>allow_value('foo', 'bar', 'baz')</code> took only the first value of the passed arguments, and now it was fixed and began to take everything. </li></ul><br><h3 id="migracii">  Migrations </h3><br><p>  Changed the way of forming the names of the indices and a few more things that completely broke backward compatibility.  Therefore, it is necessary to explicitly indicate to all migrations in which version they were created.  Specify via class parameter: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OldMigrationName</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Migration[4.2] ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewMigrationName</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Migration[5.0] ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  It was also given the opportunity to specify <code>foreign_key</code> in options for <code>references</code> .  And the default settings of the generator <a href="https://github.com/rails/rails/pull/21762/files">have changed a</a> little: now it makes pk (which id) by default not an integer, but uuid. </p><br><p>  For some reason, we also had problems defining models within migrations.  That is, in the form of the form: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeMigration</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Migration </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StubForModel</span></span></span><span class="hljs-class"> &lt; ActiveRecord::Base </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_one</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">something</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">up</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StubForModel</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destroy_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">down</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># do nothing end end</span></span></span></span></code> </pre> <br><p>  someone strongly swears at what <code>Base</code> cannot find.  Until you figure out the cause, so be vigilant.  As we will understand - we will update the description. </p><br><h2 id="posledovatelnost-kolbekov-v-kontrollere">  The sequence of callbacks in the controller </h2><br><p>  The <code>csrf</code> token check (protect from forgery) in Rails 4 always went up and was executed by the first callback in the controller.  In Rails 5, it does not go anywhere and runs according to where it is defined and if you need to raise it, you must explicitly specify <code>prepend: true</code> . </p><br><p>  All is good, but we, it seems, did not carefully read the guides, the links to which resulted in the beginning.  We just fell off authentication.  We dug up the whole device and almost believed in magic.  It turned out that at first the device successfully authenticates and cuts the token from the parameters, and then comes protect from forgery and strongly resents the curve (actually missing) token. </p><br><h2 id="mankipatchi">  Mankipatchi </h2><br><p>  "His example to others is science ..." </p><br><ul><li>  In controller tests, <code>get</code> dropped from <em>stack level too deep</em> in the cookies area.  They broke a pair of light heads and for the second time almost didn‚Äôt believe in magic, until the monkipatch associated with <a href="https://github.com/steveklabnik/request_store">RequestStore was excavated</a> . </li><li>  The above case with a csrf token was slightly complicated by its <del>  dopilami </del>  sequins authentication.  In fact, we had two checks of the <code>csrf</code> token: one before the device and one after.  This did not help simplify the search for a problem. </li><li>  Earlier, the aforementioned CanCan was also patched and there was little pleasant. </li><li>  We had our own finished <code>ActiveRecord::Type</code> , which was pretty dug up in new rails: <a href="https://github.com/rails/rails/tree/4-2-stable/activerecord/lib/active_record/type">it was</a> , <a href="https://github.com/rails/rails/tree/5-0-stable/activerecord/lib/active_record/type">it</a> <a href="https://github.com/rails/rails/tree/4-2-stable/activerecord/lib/active_record/type">was</a> , and they <a href="https://github.com/rails/rails/tree/5-0-stable/activemodel/lib/active_model/type">transferred it</a> to <code>ActiveModel</code> . </li><li>  There are still a lot of things that could be talked about, but they almost did not participate in the transition to new rails, so we‚Äôll leave for later. </li></ul><br><p>  Why am I all this: <code>core_ext</code> should not be.  Totally.  And the transition to the new rails is an excellent reason to start with them and try to cut as much as possible, and look at everything else with a very picky look and recall the history (undoubtedly very colorful) preceding the appearance of this extension.  So it will be much easier to understand when it will fall off in the transition process. </p><br><h2 id="obnovlenie-versii-ruby">  Ruby version upgrade </h2><br><p>  Honestly, we are overwhelmed.  Vigorously sticking 2.4.0 after 2.2.3, we grabbed a bunch of unknown garbage and decided not to quit and go into two stages: first Ruby 2.3.3, in which there is nothing very revolutionary, plus the transition to new rails.  And then - update Ruby.  Therefore, so far we can not say anything about the new cut.  Unless there is an opinion of experienced comrades that if you have compiled native extensions for gems, then you have bypassed most of the transition problems and there should not be any serious obstacles. </p><br><h2 id="magiya-zadachka-na-podumat-esli-est-vremya-i-zhelanie">  Magic (problem to think about if you have time and desire) </h2><br><p>  Regardless of the transition to new rails, just a strange code, which was dug up during the transition and that worked, although it should not (summary of the three files of AR-classes): </p><br><pre> <code class="ruby hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Base</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TYPES</span></span></span><span class="hljs-class"> = {</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">First</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">second</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Second</span></span></span><span class="hljs-class">} </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">First</span></span></span><span class="hljs-class"> &lt; Base;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Second</span></span></span><span class="hljs-class"> &lt; Base;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  This thing can not work according to all the laws of the genre (and in general it does not work on clean projects under Rails 4/5).  Since when accessing someone from the heirs, the autoload goes into the cyclic loading of classes and falls.  If you first refer to the base class, and then to the heirs, then everything is fine.  But for some reason we worked in Rails 4, but fell off in Rails 5, although we did not find an explicit reference to <code>Base</code> to load it earlier than all the others, and we didn‚Äôt touch anything related to autoload at all.  If someone knows more ways how it can work or what interesting happened to the autoload in Rails 5, please let us know. </p><br><h2 id="konec">  the end </h2><br><p>  Thank you for reading.  I hope at least something will come in handy (or has already come in handy) and we have at least a little bit saved you time to go. </p><br><p>  Please feel free to share your knowledge and experience on the topic in the comments and not so much. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/326706/">https://habr.com/ru/post/326706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326690/index.html">Virtual studio and motion capture using Htc Vive</a></li>
<li><a href="../326694/index.html">Aspects of a successful mobile application architecture</a></li>
<li><a href="../326696/index.html">PHP version performance comparison</a></li>
<li><a href="../326700/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ258 (April 10 - 16, 2017)</a></li>
<li><a href="../326702/index.html">IT internships: waiting vs reality</a></li>
<li><a href="../326712/index.html">The composition of protocols for injection dependencies</a></li>
<li><a href="../326714/index.html">Source Code Analysis and Prince of Persia Copy Protection</a></li>
<li><a href="../326716/index.html">Native ECMAScript Modules - First Review</a></li>
<li><a href="../326718/index.html">Go to your personal account on zakupki.gov.ru without Internet Explorer and other useful tips when working with CryptoPro</a></li>
<li><a href="../326720/index.html">Record a WebRTC video stream from a webcam browser towed to Amazon S3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>