<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The time has come java 12! Review of hot JEPs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Half a year has passed, which means time to install a new Java ! It was a long way, and only a few got to the end. Of the interesting JEPs, the raw li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The time has come java 12! Review of hot JEPs</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/k8/rn/qa/k8rnqagstd_wu4hezoj_bnjzfem.png"></p><br><p>  Half a year has passed, which means <a href="https://mail.openjdk.java.net/pipermail/jdk-dev/2019-March/002718.html">time to install a new Java</a> !  It was a long way, and only a few got to the end.  Of the interesting JEPs, the <a href="https://openjdk.java.net/jeps/326">raw lines</a> fell off, but we'll talk about the rest under the cut. </p><a name="habracut"></a><br><h1 id="kak-vsyo-proishodit">  How is it going </h1><br><p>  The release of a new version of Java is taking place according to a new ‚Äúaccelerated‚Äù release cycle, about six months in length.  The exact dates are defined on <a href="https://openjdk.java.net/projects/jdk/12/">the project page</a> .  For JDK 12, there were several major phases: </p><br><ul><li>  2018/12/13 - First deceleration phase (at this moment fork is made from the main branch in the repository); </li><li>  2019/01/17 - The second phase of the slowdown (complete everything you can); </li><li>  2019/02/07 - Release candidate (only the most important bugs are fixed); </li><li>  2019/03/19 - Release, General Availability.  <strong>&lt;- you are here</strong> </li></ul><br><p>  What to us from this schedule?  Yes, in fact, nothing - we just came to the finish line, and the lordly look at the fans of Legacy from the height of a brand new, fresh JDK 12. </p><br><h1 id="bagi-panika-vse-na-dno">  Bugs!  Panic!  All to the bottom! </h1><br><p><img src="https://habrastorage.org/webt/9j/jw/j8/9jjwj87t8vtlqyiv4zmox4xljem.jpeg"></p><br><p>  When a new non-LTS version comes out, usually everyone doesn‚Äôt care about new features.  More interesting, if it does not fall apart to the devil. </p><br><p>  Of course, there are a lot of bugs, but not in JDK 12 :) Judging by the format, everything is normal: </p><br><p><img src="https://habrastorage.org/webt/st/yr/cr/styrcrroe8hobgqc6jpxgv5hknw.jpeg"></p><br><p>  I will quote a request so that you understand <em>exactly</em> what ‚Äúnorm‚Äù is: </p><br><pre><code class="plaintext hljs">project = JDK AND issuetype = Bug AND status in (Open, "In Progress", New) AND priority in (P1) AND (fixVersion in (12) OR fixVersion is EMPTY AND affectedVersion in (12) AND affectedVersion not in regexVersion("11.*", "10.*", "9.*", "8.*", "7.*", "6.*")) AND (labels is EMPTY OR labels not in (jdk12-defer-request, noreg-demo, noreg-doc, noreg-self)) AND (component not in (docs, globalization, infrastructure) OR component = infrastructure AND subcomponent = build) AND reporter != "Shadow Bug" ORDER BY priority, component, subcomponent, assignee</code> </pre> <br><p>  Of course, <em>in general,</em> bugs have a place to be, they are not going anywhere in such a huge project.  It is claimed only that right now P1 bugs are not noticed. </p><br><p>  More formally, communication with the bugs is declared in a special document, the <a href="https://openjdk.java.net/jeps/3">JEP 3: JDK Release Process</a> , which is owned by our immortal steward on the troubled waves of the Java-ocean - Mark Reinhold. </p><br><p>  And especially worth <a href="https://openjdk.java.net/jeps/3">getting to the paragraph</a> , telling, <del>  Who is to blame and what to do </del>  , how to transfer tickets, if by the 12th release no longer have time.  It is necessary to put the <code>jdk$N-defer-request</code> tag in the bugtracker in which N indicates which release you would like to transfer from and leave a comment, the first line of which is <em>Deferral Request</em> .  Further, reviews of all such requests are taken by the leads of the respective areas and projects. </p><br><p>  The problems of passing TCK cannot be ignored in this way - it is guaranteed that Java remains Java, and not something toad.  The <code>jdk$N-defer-request label</code> does not disappear anywhere.  Interestingly, what they do with people who violate the rule of tag removal - I suggest feeding them to guinea pigs. </p><br><p>  However, this way you can see how many bugs are ported to JDK 13. Let's try this query: </p><br><pre> <code class="plaintext hljs">project = JDK AND issuetype = Bug AND status in (Open, "In Progress", New) AND (labels in (jdk12-defer-request) AND labels not in (noreg-demo, noreg-doc, noreg-self)) AND (component not in (docs, globalization, infrastructure) OR component = infrastructure AND subcomponent = build) AND reporter != "Shadow Bug" ORDER BY priority, component, subcomponent, assignee</code> </pre> <br><p>  Only 1 thing, <a href="https://bugs.openjdk.java.net/browse/JDK-8216039">JDK-8216039</a> : "TLS with BC and RSASSA-PSS breaks ECDHServerKeyExchange".  Not much.  If this argument still does not help, then, as your lawyer, I recommend trying a sedative. </p><br><h1 id="i-chto-zhe-v-suhom-ostatke">  And what about the bottom line? </h1><br><p><img src="https://habrastorage.org/webt/ef/uf/mx/efufmx-2rdphagrcihuscp0cswo.png"></p><br><p>  It is clear that most features affect not the users (Java programmers), but the developers of the OpenJDK itself.  Therefore, just in case, I divide the features into <strong>external</strong> and <strong>internal</strong> .  Internal can be skipped, but I will be offended, I wrote so much text. </p><br><p>  <strong>189: <a href="http://openjdk.java.net/jeps/189">Shenandoah: A Low-Pause-Time Garbage Collector (Experimental)</a></strong> </p><br><p>  <strong>External feature</strong> .  In short, people do not like it when Java slows down, especially if the SLA requires responsiveness of the order of 10-500 milliseconds.  Now we have a free low-gap GC that is trying to work closer to the left edge of this range.  The trade-off is that we exchange CPU and RAM for reduced delays.  Phase labeling and hip seal work in parallel with the live application threads.  The remaining small pauses are due to the fact that you still need to search and update the roots of the object graph. </p><br><p>  If none of the above makes any sense to you - it does not matter, Shenandoah <em>just works</em> , regardless of understanding or misunderstanding of the underlying processes. </p><br><p>  Alexey Shipilyov, Kristina Flood and Roman Kennke are working on it - you need to try hard not to know about these people.  If you generally understand how GC works, but you can‚Äôt imagine what the developer can do there, I recommend looking at the wonderful translation by Lyoshina of the article <a href="https://habr.com/ru/company/jugru/blog/443250/">‚ÄúHomemade garbage collector for OpenJDK‚Äù</a> or on the <a href="https://shipilev.net/jvm/anatomy-quarks/">JVM Anatomy Quarks</a> series.  This is <strong>very interesting</strong> . </p><br><blockquote>  <strong>Extremely important.</strong>  Oracle decided not to ship Sheandoah with any of its release builds - with the one on jdk.java.net, or from the one on oracle.com.  Considering that Shenandoah is one of the most important features of JDK 12, it is worthwhile to install some other official build, <a href="https://www.azul.com/downloads/zulu/">for example, from Azul</a> . </blockquote><br><hr><br><p>  <strong>230: <a href="http://openjdk.java.net/jeps/230">Microbenchmark Suite</a></strong> </p><br><p>  <strong>Internal feature</strong> .  If you have ever tried to write microbench marks, then you know that this is done on JMH.  JMH is a framework for creating, assembling, running and analyzing micro-benchmarks for Java and other JVM-languages, written <a href="https://shipilev.net/">by you understand who</a> (all the coincidences are random).  Unfortunately, not everything that is done in the world of "normal" applications can be applied inside the JDK.  For example, we are unlikely to ever see normal Spring Framework code there. </p><br><p>  Fortunately, since version 12 you can use at least JMH, and there is already a set of tests that are written on it.  You can see it in <a href="https://hg.openjdk.java.net/jdk/jdk12/file/0276cba45aac/test/micro/org/openjdk/bench"><code>jdk/jdk/test/micro/org/openjdk/bench</code></a> (you can see directly in the browser, this path is a link). </p><br><p>  For example, here‚Äôs what <a href="">a GC test</a> looks like. </p><br><blockquote>  Let me remind you that here we don‚Äôt have StackOverflow, and using code from copy-paste, here and hereafter, is prohibited without reading and following all the licenses from the <a href="">corresponding file</a> and <a href="https://hg.openjdk.java.net/jdk/jdk12/file/0276cba45aac">the OpenJDK project</a> in general, otherwise you will easily sue your socks on any court. </blockquote><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.AverageTime) <span class="hljs-meta"><span class="hljs-meta">@OutputTimeUnit</span></span>(TimeUnit.NANOSECONDS) <span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Thread) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Alloc</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LENGTH = <span class="hljs-number"><span class="hljs-number">400</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ARR_LEN = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> largeLen = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> smalllen = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLargeConstArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blackhole bh)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> localArrlen = ARR_LEN; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; LENGTH; i++) { Object[] tmp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[localArrlen]; bh.consume(tmp); } } <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br><hr><br><p>  <strong><a href="http://openjdk.java.net/jeps/325">325: Switch Expressions (Preview)</a></strong> </p><br><p>  <strong>External feature</strong> .  Radically change your approach to writing endless switches over two screens long.  Look: </p><br><h3 id="virgin-java-switch-vs-">  Virgin Java Switch vs ... </h3><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dayNum = -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (day) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MONDAY: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> FRIDAY: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SUNDAY: dayNum = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TUESDAY: dayNum = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> THURSDAY: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SATURDAY: dayNum = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> WEDNESDAY: dayNum = <span class="hljs-number"><span class="hljs-number">9</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre> <br><p>  <strong>Why is bad</strong> : a lot of letters, you can skip the break (especially if you are a drug addict, or you suffer from ADHD). </p><br><h3 id="-vs-chad-java-swtich-expression">  ... vs Chad Java Swtich Expression! </h3><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dayNum = <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (day) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MONDAY -&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> TUESDAY -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k = day.toString().length(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = f(k); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> result; } };</code> </pre> <br><p>  <strong>Why is good</strong> : few letters, safe, convenient, new cool feature. </p><br><p>  <strong>Bonus</strong> : if you are a sadist, then you will receive the deepest satisfaction, as thousands of IDE developers are now tormented with the support of this feature.  Yes, <a href="https://habr.com/ru/users/lany/" class="user_link">lany</a> , yes? <del>  You can catch him <a href="https://jpoint.ru/talks/4ltyzdxqzmpeofbgkld7ns/">after the report on April 6th</a> and gently ask him to give out all the dirty details. </del></p><br><blockquote>  <strong>This preview feature, just because it does not work!</strong>  When compiling, in <code>javac</code> you need to pass the command line options <code>--enable-preview --release 12</code> , and to run via <code>java</code> - only the <code>--enable-preview</code> flag. </blockquote><br><hr><br><p>  <strong>334: <a href="http://openjdk.java.net/jeps/334">JVM Constants API</a></strong> </p><br><p>  <strong>Internal feature</strong> .  Developers want to manipulate class files.  It is necessary to do this conveniently, and this is a statement of the problem.  At least, Brian Goetz, who owns this JEP, said so :-) This is all part of a larger battlefield, but for now we will not go deeper. </p><br><p>  In each Java class there is a so-called "constant pool", where there is a dump of either some values ‚Äã‚Äã(like strings and ints), or runtime entities like classes and methods.  Digging in this dump can be <a href="https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-6.html">done</a> using <a href="https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-6.html">the ldc</a> - "load costant" instruction, so all this junk is called loadable constants.  There is a special case for invokedynamic, but it doesn't matter. </p><br><p>  If we work with classfiles, we want to conveniently simulate bytecode instructions, and therefore - loadable constants.  The first desire is to simply make the corresponding Java types, but how to present them with the "live" class, the structure of <a href="https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-4.html"><code>CONSTANT_Class_info</code></a> ?  <code>Class</code> objects depend on the correctness and consistency of loading classes, and with classes being loaded in Java, hellish bacchanalia is created.  Let's start with the fact that not all classes can be loaded into a VM, but we still need to describe them! </p><br><p>  I would like to somehow manage things like classes, methods and less well-known animals like method handles and dynamic constants, taking into account all these subtleties. </p><br><p>  This is solved by introducing new <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/doc-files/ValueBased.html">value-based</a> types of symbolic links (in the sense of <a href="https://docs.oracle.com/javase/specs/jvms/se11/html/jvms-5.html">JVMS 5.1</a> ), each of which describes a particular kind of constant.  Describes purely nominally, in isolation from loading classes or access issues.  They live in packages like <code>java.lang.invoke.constant</code> and they don‚Äôt ask, but you can <a href="http://cr.openjdk.java.net/~vromero/constant.api/webrev.04/constants.api.patch">take a look</a> at the patch <a href="http://cr.openjdk.java.net/~vromero/constant.api/webrev.04/constants.api.patch">here</a> . </p><hr><br><p>  <strong>340: <a href="http://openjdk.java.net/jeps/340">One AArch64 Port, Not Two</a></strong> <br>  <strong>External feature</strong> .  Already in JDK 9 there was a strange situation when Oracle and Red Hat simultaneously put their ARM ports on combat duty.  And here we see the end of the story: the 64-bit part of the Oracle port was removed from the Upstream. </p><br><p>  It would be possible to delve into history for a long time, but there is a better way.  <a href="http://bell-sw.com/">BellSoft</a> participated in the development of this JEP, and its office is located in St. Petersburg, next to the former office of Oracle. </p><br><p>  Therefore, I immediately turned immediately to Alexey Voitylov, CTO of BellSoft: </p><br><blockquote>  "BellSoft releases Liberica JDK, which, in addition to x86 Linux / Windows / Mac and Solaris / SPARC, supports ARM. Starting from JDK 9 for ARM, we focused on improving the performance of the AARCH64 port for server applications and continued to support the 32-bit part of the ARM port for embedded solutions. Thus, at the time of the release of JDK 11, there was a situation when nobody supported the 64-bit part of the port from Oracle (including Oracle), and the OpenJDK community decided to remove it in order to focus on the AARCH64 port. At the moment it is more productive ( see, for example, <a href="http://openjdk.java.net/jeps/315">JEP 315</a> , which we  I integrated into JDK 11) and, starting with JDK 12, supports all the features present in the Oracle port (the last one, Minimal VM, I integrated in September), so I gladly helped Bob Vandette remove this rudiment in JDK 12. As a result, OpenJDK the community received one port on AARCH64 and one port on ARM32, which certainly facilitates their support. " </blockquote><br><hr><br><p>  <strong>341: <a href="http://openjdk.java.net/jeps/341">Default CDS Archives</a></strong> </p><br><p>  <strong>Internal feature</strong> .  The problem is that when launching Java applications, thousands of classes are loaded, which creates the feeling that Java significantly slows down at startup.  But to whom to lie, this is not just a "feeling" - the way it is.  To correct the problem since ancient times, various rituals are practiced. </p><br><p>  Class Data Sharing is a feature that came to us <a href="http://www.oracle.com/technetwork/java/javase/8u40-relnotes-2389089.html">from time immemorial</a> as a commercial feature from JDK 8 Update 40. It allows you to pack all this startup debris into the archive of some kind of its own format (you do not need to know which one), then the launch speed applications increases.  And after a while, <a href="https://openjdk.java.net/jeps/310">JEP 310</a> appeared: Application Class-Data Sharing, which allowed not only system classes, but also application classes to do the same. </p><br><p>  For JDK classes, it looks like this.  First, we dump the classes with the <code>java -Xshare:dump</code> , and then launch the application, telling it to use this cache: <code>java -Xshare:on -jar app.jar</code> .  Everything, the startup improved a little.  So you knew about this feature?  Many who do not know so far! </p><br><p>  It looks strange here: why every time it is self-ritual to write <code>-Xshare:dump</code> , if the default result of executing this command is a bit predictable at the stage of creating the JDK distribution?  According to the <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/class-data-sharing.html">documentation</a> , if the Java 8 distribution was installed using the installer, then right at the time of installation it should run the necessary commands for you.  Like, the installer quietly mined in the corner.  But why?  And what to do with the distribution kit, which is distributed not in the form of an installer, but as a zipnik? </p><br><p>  It's simple: starting with JDK 12, the CDS archive will be generated by the creators of the distribution, immediately after linking.  Even for nightly builds (assuming they are 64-bit and native, not for cross-compiling). </p><br><p>  Users do not even need to know about the presence of this feature, because, starting with JDK 11, <code>-Xshare:auto</code> enabled by default, and this archive will pick up automagically.  Thus, the mere <strong>fact of updating to JDK 12 speeds up the launch of the application!</strong> </p><hr><br><p>  <strong>344: <a href="http://openjdk.java.net/jeps/344">Abortable Mixed Collections for G1</a></strong> </p><br><p>  <strong>Internal feature</strong> .  Honestly, <del>  I do not understand anything in the work of G1 </del>  GC features explanation is unrewarding, because  requires an understanding of the details of his work from both the explanatory and the understanding.  For most people, GC is some kind of little devil from a snuffbox, which can be screwed up in case of anything.  Therefore, the problem should be explained as something simpler. </p><br><p>  <strong>Problem</strong> : G1 could work better. </p><br><p>  Well, the problem is that GC is a compromise of many parameters, one of which is the duration of the pause.  Sometimes the pause is too long, and then it‚Äôs good to be able to cancel it. </p><br><p>  When does this happen?  G1 does analyze the behavior of the application and selects the scope of work (expressed in the form of a <em>collection set</em> ) on the basis of its conclusions.  When the scope of work is approved, G1 is taken to collect all the living objects in the collection set, stubbornly and non-stop, in one sitting.  Sometimes it takes too much time.  In essence, this means that G1 miscalculated the amount of work.  You can fool him by suddenly changing the behavior of your application so that heuristics will work on top of rotten data when too many old regions fall into the collection set. </p><br><p>  To get out of the situation, G1 was modified by the following mechanism: if the heuristics regularly selects the wrong amount of work, G1 switches to incremental garbage collection, step by step, and each next step (if it did not fit into the target runtime) can be canceled.  It does not make sense to increment something incrementally (young regions), so all such work is allocated to the "mandatory" unit, which is still being carried out continuously. </p><br><p>  What to do with the end user?  Nothing, you need to upgrade to JDK 12, everything will be better by itself. </p><hr><br><p>  <strong>346: <a href="http://openjdk.java.net/jeps/346">Promptly Return Unused Committed Memory from G1</a></strong> </p><br><p>  <strong>Internal feature</strong> .  The problem is that if we have a big hip that no one actively uses, it seems fair to get all this inactive memory back into the operating system.  Before JDK 12, however, this did not happen. </p><br><p>  To achieve its goal in terms of the admissible pause length, G1 produces a set of incremental, parallel, and multistage cycles.  In JDK 11, it gives commited memory to the operating system only with full GC, or during the parallel labeling phase.  If you connect logging (-Xloggc: /home/gc.log -XX: + PrintGCDetails -XX: + PrintGCDateStamps), then this phase is displayed like this: </p><br><pre> <code class="plaintext hljs">8801.974: [G1Ergonomics (Concurrent Cycles) request concurrent cycle initiation, reason: occupancy higher than threshold, occupancy: 12582912000 bytes, allocation request: 0 bytes, threshold: 12562779330 bytes (45.00 %), source: end of GC] 8804.670: [G1Ergonomics (Concurrent Cycles) initiate concurrent cycle, reason: concurrent cycle initiation requested] 8805.612: [GC concurrent-mark-start] 8820.483: [GC concurrent-mark-end, 14.8711620 secs]</code> </pre> <br><p>  The funny thing is that G1 as it can struggles with full stops, and the concurrent cycle starts only with frequent allocations and clogged heap.  Our situation, when hip nobody touches - it is just the opposite.  Situations when G1 will scratch to give memory to the operating system will occur very well, very rarely! </p><br><p>  So everyone would have scored on this problem (‚Äúbuy even more RAM, what a niggard!‚Äù), But for one thing - there are all kinds of clouds and containers in which this means insufficient utilization and loss of serious money.  Look, what a <a href="https://www.slideshare.net/jelastic/elastic-jvm-automatic-vertical-scaling-of-the-java-heap">cool report</a> , filled to the brim with pain. </p><br><p>  The decision was to teach G1 to behave well in this particular case, as Shenanda or GenCon from OpenJ9 already know how.  It is necessary to determine the inadequate utilization of the hip and, accordingly, reduce its use.  On some tests on Tomkate, this reduced the memory consumption by almost two times. </p><br><p>  The bottom line is that the application is considered inactive, or if the interval has expired (in milliseconds) since the last build and there is no concurrent cycle, or if <code>getloadavg()</code> on a one-minute period showed a load below a certain threshold.  As soon as some of this has happened, periodic garbage collection is launched - it will certainly not clean as well as a full assembly, but it will affect the application as little as possible. </p><br><p>  You can poke it into this log: </p><br><pre> <code class="plaintext hljs">(1) [6.084s][debug][gc,periodic ] Checking for periodic GC. [6.086s][info ][gc ] GC(13) Pause Young (Concurrent Start) (G1 Periodic Collection) 37M-&gt;36M(78M) 1.786ms (2) [9.087s][debug][gc,periodic ] Checking for periodic GC. [9.088s][info ][gc ] GC(15) Pause Young (Prepare Mixed) (G1 Periodic Collection) 9M-&gt;9M(32M) 0.722ms (3) [12.089s][debug][gc,periodic ] Checking for periodic GC. [12.091s][info ][gc ] GC(16) Pause Young (Mixed) (G1 Periodic Collection) 9M-&gt;5M(32M) 1.776ms (4) [15.092s][debug][gc,periodic ] Checking for periodic GC. [15.097s][info ][gc ] GC(17) Pause Young (Mixed) (G1 Periodic Collection) 5M-&gt;1M(32M) 4.142ms (5) [18.098s][debug][gc,periodic ] Checking for periodic GC. [18.100s][info ][gc ] GC(18) Pause Young (Concurrent Start) (G1 Periodic Collection) 1M-&gt;1M(32M) 1.685ms (6) [21.101s][debug][gc,periodic ] Checking for periodic GC. [21.102s][info ][gc ] GC(20) Pause Young (Concurrent Start) (G1 Periodic Collection) 1M-&gt;1M(32M) 0.868ms (7) [24.104s][debug][gc,periodic ] Checking for periodic GC. [24.104s][info ][gc ] GC(22) Pause Young (Concurrent Start) (G1 Periodic Collection) 1M-&gt;1M(32M) 0.778ms</code> </pre> <br><p>  Understood?  Me not.  In JEP there is a detailed sign language translation of each line of the log, and how the algorithm works, and everything else. </p><br><p>  "So what, why did I find out?"  - you ask.  Now we have two additional handles: <code>G1PeriodicGCInterval</code> and <code>G1PeriodicGCSystemLoadThreshold</code> , which can be turned when it becomes bad.  After all, bad things will definitely be, this is Java, baby! </p><hr><br><h1 id="itogi">  Results </h1><br><p>  As a result, we have a strong release in our hands - not a revolution, but an evolution focused on improving performance.  Exactly half of the improvements relate to performance: three JEPs about GC and one about CDS, which promise to turn on by themselves, once you upgrade to JDK 12. In addition, we received one language feature (switch expressions), two new tools for JDK developers ( Constants API and tests for JMH), and now the community can better focus on a single 64-bit port on ARM. </p><br><p>  In general, go to JDK 12 now, and may the Force be with you.  You will need it. </p><br><blockquote>  Minute advertising.  Very soon, on April 5-6, the JPoint conference will take place, which will bring together a huge number of people who know a lot about JDK and all sorts of new features.  For example, there will definitely be Simon Ritter from Azul with the report <a href="https://jpoint.ru/talks/35kmzgw4ds3gyt849hbaeo/%3Futm_source%3Dhabr%26utm_medium%3D444434">"JDK 12: Pitfalls for the unwary"</a> .  The right place to discuss the latest release!  More information about the JPoint can be found on the <a href="https://jpoint.ru/%3Futm_source%3Dhabr%26utm_medium%3D444434">official website</a> . </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/444434/">https://habr.com/ru/post/444434/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444422/index.html">As it was in 2018: Industrial FDM printing at Top 3D Expo</a></li>
<li><a href="../444426/index.html">Lyft and Uber go IPO. Why invest in Lyft?</a></li>
<li><a href="../444428/index.html">Mountain Car: solve the classic problem with the help of training with reinforcements</a></li>
<li><a href="../444430/index.html">Parsing: how to properly use Present Perfect in English</a></li>
<li><a href="../444432/index.html">The use of Linux and open source software in our school: to be or not to be?</a></li>
<li><a href="../444436/index.html">What is the Mirai botnet, and how can I protect my devices?</a></li>
<li><a href="../444438/index.html">A brief history of open source - how free software has fought proprietary</a></li>
<li><a href="../444442/index.html">Jetson Nano: Nvidia Machine Learning Single Board</a></li>
<li><a href="../444444/index.html">The best files of our conferences (Joker, JPoint, DotNext, Mobius, TechTrain and so on)</a></li>
<li><a href="../444446/index.html">Making a modern web application from scratch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>