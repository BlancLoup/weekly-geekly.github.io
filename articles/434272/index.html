<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RoadRunner: PHP is not created to die, or Golang to the rescue</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! We at Badoo are actively working on the performance of PHP , since we have a fairly large system in this language and the issue of performan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RoadRunner: PHP is not created to die, or Golang to the rescue</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/iw/kn/au/iwknauolmahz8ueoadgkp3mp0zs.jpeg"><br><br>  Hi, Habr!  We at Badoo are actively <a href="https://habr.com/company/badoo/blog/430722/">working on the performance of PHP</a> , since we have a fairly large system in this language and the issue of performance is a matter of saving money.  More than a decade ago, we created for this PHP-FPM, which initially represented a set of patches for PHP, and later entered into an official delivery. <br><br>  In recent years, PHP has progressed significantly: the garbage collector has improved, the level of stability has improved - today you can write demons and long-lived scripts for PHP without any special problems.  This allowed Spiral Scout to go further: RoadRunner, unlike PHP-FPM, does not clear the memory between requests, which gives an additional performance gain (although this approach complicates the development process).  We are now experimenting with this tool, but so far we have no results to share.  To wait for them was more fun, we <b>publish the translation of the announcement RoadRunner from Spiral Scout.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The approach from the article is close to us: in solving our problems, we also often use a bunch of PHP and Go, taking advantage of both languages ‚Äã‚Äãand not giving up one in favor of the other. <br><br>  Enjoy! <br><a name="habracut"></a><br><hr><br>  In the past ten years, we have been creating applications for <a href="https://ru.wikipedia.org/wiki/Fortune_Global_500">Fortune 500 companies</a> and for businesses with an audience of no more than 500 users.  All this time, our engineers have been developing backend mainly in PHP.  But two years ago, something strongly influenced not only the performance of our products, but also their scalability - we introduced Golang (Go) into our technology stack. <br><br>  Almost immediately, we discovered that Go allows us to create larger applications with an increase in performance up to 40 times.  With it, we were able to extend existing products written in PHP, improving them thanks to the combination of advantages of both languages. <br><br>  We will tell you how a bunch of Go and PHP helps to solve real development problems and how it has become for us a tool that can eliminate some of the problems associated with the <a href="https://habr.com/post/179399/">PHP dying model</a> . <br><br><h3>  Your daily PHP development environment </h3><br>  Before telling how Go can be used to revive the PHP dying model, let's take a look at your standard PHP development environment. <br><br>  In most cases, you run the application using a combination of the nginx web server and the PHP-FPM server.  The first serves static files and redirects specific requests to PHP-FPM, and PHP-FPM itself executes PHP code.  Perhaps you are using a less popular bundle from Apache and mod_php.  But although it works a little differently, the principles are the same. <br><br>  Consider how PHP-FPM executes application code.  When a request arrives, the PHP-FPM initializes the child PHP process, and sends the details of the request as part of its state (_GET, _POST, _SERVER, etc.). <br><br>  The state cannot change during the execution of the PHP script, so getting a new set of input data is possible only in one way: by clearing the process memory and initializing it again. <br><br>  Such a model of performance has many advantages.  You do not need to worry much about memory consumption, all processes are completely isolated, and if one of them "dies", it will be automatically recreated and it will not affect the other processes.  But there is such an approach and disadvantages that occur when trying to scale the application. <br><br><h3>  Disadvantages and inefficiencies of a typical PHP environment </h3><br>  If you are engaged in professional development in PHP, then you know where to start a new project - with the choice of framework.  It is a library for dependency injection, ORMs, translations and templates.  And, of course, all user input data can be conveniently placed in one object (Symfony / HttpFoundation or PSR-7).  The frameworks are cool! <br><br>  But everything has its price.  In any enterprise framework, in order to process a simple user request or access a database, you will need to load at least dozens of files, create numerous classes, and parse several configurations.  But the worst thing is that after the completion of each task, you will need to reset everything and start anew: all the code you just initiated becomes useless, with its help you will not process another request.  Tell about this to any programmer who writes in some other language - and you will see bewilderment on his face. <br><br>  For years, PHP engineers have been looking for ways to solve this problem, have used lazy loading techniques, microframes, optimized libraries, cache, etc. But in the end, you still have to drop the entire application and start over, again and again.  <i>(Translator‚Äôs note: this problem will be partially solved with the advent of <a href="https://wiki.php.net/rfc/preload">preload</a> in PHP 7.4)</i> <i><br><br></i> <h3>  Can PHP use Go for more than one request? </h3><br>  You can write PHP scripts that last longer than a few minutes (up to hours or days): for example, cron tasks, CSV parsers, queue disassemblers.  All of them work according to the same scenario: they retrieve the task, carry it out, wait for the following.  The code resides in memory, saving precious milliseconds, since many additional actions are required to load the framework and application. <br><br>  But developing long-lived scripts is not so easy.  Any error completely kills the process, diagnosing memory leaks leads to rabies, and you cannot use F5 debugging anymore. <br><br>  The situation has improved with the release of PHP 7: a reliable garbage collector has appeared, it has become easier to handle errors, and kernel extensions are now protected from leaks.  True, engineers still need to carefully handle the memory and remember the problems of the state in the code (and is there a language in which you can not pay attention to these things?).  And yet, in PHP 7, there are fewer surprises. <br><br>  Is it possible to take a model of working with long-lived PHP scripts, adapt it for more trivial tasks like processing HTTP requests and thereby eliminate the need to download everything from scratch with each request? <br><br>  To solve this problem, you first needed to implement a server application that could receive HTTP requests and redirect them one by one to the PHP worker without killing it every time. <br><br>  We knew that we could write a web server in pure PHP (PHP-PM) or using the C-extension (Swoole).  And although each method has its merits, both options did not suit us - I wanted something more.  We needed not just a web server - we expected to get a solution that would save us from the problems associated with the ‚Äúheavy start‚Äù in PHP, which at the same time can be easily adapted and expanded for specific applications.  That is, we needed an application server. <br><br>  Can Go help with this?  We knew that it could, because this language compiles applications into single binary files;  it is cross-platform;  uses its own, very elegant, parallel processing model (concurrency) and a library for working with HTTP;  and finally, thousands of open-source libraries and integrations will be available to us. <br><br><h3>  The difficulty of combining two programming languages </h3><br>  First of all, it was necessary to determine how two or more applications would communicate with each other. <br><br>  For example, using the <a href="https://github.com/deuill/go-php">beautiful library of</a> Alex Palaestras, memory sharing between PHP and Go processes (like mod_php in Apache) could be realized.  But this library has features that limit its use to solve our problem. <br><br>  We decided to use another, more common, approach: to build the interaction between processes through sockets / pipelines.  This approach over the past decade has proven its reliability and has been well optimized at the operating system level. <br><br>  To begin with, we created a simple binary protocol for exchanging data between processes and handling transmission errors.  In its simplest form, this type of protocol is similar to <a href="https://en.wikipedia.org/wiki/Netstring">netstring</a> with <a href="">a fixed-size packet header</a> (in our case, 17 bytes), which contains information about the type of packet, its size, and a binary mask to check the integrity of the data. <br><br>  On the PHP side, we used <a href="https://github.com/spiral/goridge/blob/master/php-src/SocketRelay.php">the pack function</a> , and on the Go side, the <a href="">encoding / binary</a> library. <br><br>  One protocol seemed to us a little - and we added the ability to call <a href="">net / rpc Go services directly from PHP</a> .  Later, this helped us a lot in development, since we could easily integrate Go libraries into PHP applications.  The result of this work can be seen, for example, in our other open-source product <a href="https://github.com/spiral/goridge">Goridge</a> . <br><br><h3>  Distribution of tasks across several PHP workers </h3><br>  After the implementation of the interaction mechanism, we began to think how best to transfer tasks to PHP processes.  When a task arrives, the application server must select a free worker to perform it.  If the worker / process terminates with an error or ‚Äúdies,‚Äù we get rid of it and create a new one in return.  And if the worker / process has completed successfully, we return it to the pool of workers available to perform the tasks. <br><br><img src="https://habrastorage.org/webt/we/eo/5_/weeo5_2hl44jkd6xgtqt33gzbza.png"><br><br>  To store the pool of active workers, we used a <a href="">buffered channel</a> , to remove unexpectedly "dead" workers from the pool, we added a mechanism for tracking errors and states of workers. <br><br>  As a result, we got a working PHP server capable of processing any requests presented in binary form. <br><br>  In order for our application to start working as a web server, we had to choose a reliable PHP standard to represent any incoming HTTP requests.  In our case, we simply <a href="https://github.com/spiral/roadrunner/blob/master/service/">convert the</a> net / http request from Go to the <a href="https://www.php-fig.org/psr/psr-7/meta/">PSR-7</a> format so that it is compatible with most of the PHP frameworks available today. <br><br>  Since PSR-7 is considered immutable (someone would say that technically it is not), developers have to write applications that, in principle, do not treat the request as a global entity.  This fits in perfectly with the concept of long-lived PHP processes.  Our final implementation, which has not yet received the title, looked like this: <br><br><img src="https://habrastorage.org/webt/xa/px/ak/xapxakkcbhrws7c2-p83lqgkmhk.png"><br><br><h3>  Introducing RoadRunner - <a href="https://github.com/spiral/roadrunner">High</a> - <a href="https://github.com/spiral/roadrunner">Performance PHP Application Server</a> </h3><br>  Our first test task was an API backend on which bursts of requests periodically appeared unpredictably (much more often than usual).  Although in most cases the nginx capabilities were sufficient, we regularly encountered the error 502, because we could not quickly balance the system under the expected increase in load. <br><br>  To replace this solution, we deployed our first PHP / Go application server in early 2018.  And immediately got an incredible effect!  We not only completely got rid of error 502, but also managed to reduce the number of servers by two thirds, saving a lot of money and headache tablets for engineers and product managers. <br><br>  By the middle of the year, we perfected our solution, published it on GitHub under the MIT license, and called <a href="https://github.com/spiral/roadrunner">RoadRunner</a> , thus emphasizing its incredible speed and efficiency. <br><br><h3>  How RoadRunner can improve your development stack </h3><br>  The use of <a href="https://github.com/spiral/roadrunner">RoadRunner</a> allowed us to use Middleware net / http on the Go side to perform JWT verification even before the request enters PHP, and also to process WebSockets and globally aggregate states in Prometheus. <br><br>  Thanks to the built-in RPC, you can open the API of any Go-libraries for PHP without writing extensions-wrappers.  More importantly, using RoadRunner, you can deploy new servers other than HTTP.  Examples include running <a href="https://github.com/spiral/roadrunner/wiki/AWS-Lambda">AWS Lambda</a> handlers in PHP, creating robust queue <a href="https://github.com/spiral/php-grpc">pickers,</a> and even adding <a href="https://github.com/spiral/php-grpc">gRPC</a> to our applications. <br><br>  Using the PHP and Go communities, we increased the stability of the solution, increased the application performance up to 40 times in some tests, improved debugging tools, implemented integration with the Symfony framework, and added support for HTTPS, HTTP / 2, plug-ins and PSR-17. <br><br><h3>  Conclusion </h3><br>  Some are still in the thrall of the outdated concept of PHP as a slow, cumbersome language, suitable only for writing plugins under WordPress.  These people can even say that PHP has such a limitation: when an application becomes large enough, you have to choose a more ‚Äúmature‚Äù language and rewrite the code base that has accumulated over many years. <br><br>  I want to answer all this: think again.  We believe that only you yourself set some restrictions for PHP.  You can spend your whole life moving from one language to another, trying to find the perfect combination with your needs, or you can start to perceive languages ‚Äã‚Äãas tools.  Imaginary flaws of a language like PHP can actually be the reasons for its success.  And if you combine it with another language like Go, then you will create much more powerful products than if you limited yourself to using any one language. <br><br>  Having worked with a bunch of Go and PHP, we can say that we love them.  We do not plan to sacrifice one for the other - on the contrary, we will look for ways to get even more benefit from this double stack. <br><br>  <i>UPD: Welcome to the creator of RoadRunner and the co-author of the original article - <a href="https://habr.com/users/lachezis/" class="user_link">Lachezis</a></i> </div><p>Source: <a href="https://habr.com/ru/post/434272/">https://habr.com/ru/post/434272/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434262/index.html">We write and reduce the album under Linux (Ubuntu 16.04, Ardour, Hydrogen, Kontakt)</a></li>
<li><a href="../434264/index.html">Intel 2018. Results of the year</a></li>
<li><a href="../434266/index.html">Notes of the IoT provider: may there be light, or the history of the first government order for LoRa</a></li>
<li><a href="../434268/index.html">Top 3 Mobile Software Security Testing Innovators</a></li>
<li><a href="../434270/index.html">In Japan, the proportion of high school students with a vision below 1.0 has reached a record level of 67.09%</a></li>
<li><a href="../434274/index.html">Parallels become part of Corel?</a></li>
<li><a href="../434276/index.html">Slack apologizes for blocking accounts by mistake</a></li>
<li><a href="../434278/index.html">Amateur mathematician found the smallest universal coverage</a></li>
<li><a href="../434280/index.html">How face recognition technology helps the police</a></li>
<li><a href="../434282/index.html">Bitfury Crystal: how it works and where our tool is used to track suspicious crypto transactions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>