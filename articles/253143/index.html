<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatics for the KTC or extend battery life</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a result of the publication of stories about my autonomous solar power system, described here , here and here , similar questions were frequent: wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatics for the KTC or extend battery life</h1><div class="post__text post__text-html js-mediator-article">  As a result of the publication of stories about my autonomous solar power system, described <a href="http://habrahabr.ru/post/251359/">here</a> , <a href="http://habrahabr.ru/post/251449/">here</a> and <a href="http://habrahabr.ru/post/252223/">here</a> , similar questions were frequent: what is the payback period and how long will the system last?  It should be noted that one of the most expensive and capricious parts of the system are batteries.  It is energy storage devices that wear out the fastest, the battery capacity drops and the number of remaining charge-discharge cycles decreases steadily.  Motorists are well acquainted with the reduced capacity of batteries, when a sudden sharp frost leaves no chance for the old battery to start the car. <br>  I wondered how to determine the residual battery capacity so that it was as simple and fast as possible. <br><br><img src="https://habrastorage.org/files/511/cb3/685/511cb36856b241ca98a974b8c27657f9.jpg"><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, a little theory to understand how to measure the residual capacity of a battery and what it takes. <br><br>  The charge-discharge control and training cycle is conducted to prevent sulfation and to determine the battery capacity.  Control and training cycles are carried out at least once a year and are performed as follows: charge the battery with a normal current to a full charge;  maintain AB for 3 hours after the cessation of charge;  correct the density of the electrolyte;  include charging for 20-30 minutes for mixing the electrolyte;  conduct a test discharge with a constant normal current of 10-hour mode and control the time of full discharge to a voltage of 1.7 V per bank (10.2 V per AB);  battery capacity is defined as the product of the discharge current value and discharge time.  After the test discharge, the battery is immediately charged and fully charged.  If it turns out that the capacity of the battery is less than 50% of the nominal, it is considered faulty. <br>  Manual test discharge requires the constant presence of staff to fix and adjust the discharge current.  (c) <a href="http://www.kuppol.ru/infozarbat.html">taken from here</a> <br><br>  That is, to determine the residual capacity, we need to discharge the battery with a load with a known and constant power up to a value of 10.2 (in other sources, it is recommended to discharge a 12V battery not lower than up to 10.8V) Volt.  You can just buy <a href="http://www.kuppol.ru/razriadka.html">such a device</a> and not wrestle with the invention of a bicycle, but the daily struggle with laziness requires new accomplishments and inventions. <br><img src="https://habrastorage.org/files/424/d1f/399/424d1f39926c4793af67e9e55d36038e.jpg"><br><br>  So, guided by the principle ‚ÄúThe simpler, the more reliable‚Äù, it was decided to assemble our own automated device for measuring the residual capacity of the battery, and at the same time, carrying out the KTC.  Since I already had a <a href="http://www.orionspb.ru/store/catalog/charger/puskovoe-ustroystvo-vympel-50/">charger</a> , there was no need to reinvent the wheel.  It was necessary only to turn on this charge on time.  But it is necessary to discharge something that has a constant load, regardless of the ambient temperature and battery voltage.  The easiest way is to discharge it with car incandescent bulbs.  The power rating is written directly to them, so the current consumption can be calculated by simple arithmetic: W / 12 = load current.  That is, a 60 watt lamp will consume 5 amps.  The battery is discharged with a current of 10% capacity or 0.1 ¬∞ C and charged with the same current. <br>  As a result of a five-minute meditation, a ToR for the future device was compiled: <br>  1. Fixing the start time of the discharge process <br>  2. Monitoring Battery Voltage <br>  3. Upon reaching the critical voltage, the device must disconnect the load and turn on the charger <br>  4. Fixing the end of the discharge process <br><br>  From all this followed that we need: <br>  1. <a href="http://www.ebay.com/itm/Mini-USB-Nano-V3-0-ATmega328P-5V-16M-Micro-controller-Board-For-Arduino-NEW-GOOD-/151575131604%3Fpt%3DLH_DefaultDomain_2%26hash%3Ditem234a94f5d4">Arduino Nano</a> - 175 rubles <br>  2. <a href="http://www.ebay.com/itm/New-Real-Time-Clock-Module-Arduino-RTC-DS1302-For-AVR-ARM-PIC-SMD-/121370859759%3Fpt%3DLH_DefaultDomain_15%26hash%3Ditem1c424458ef">RTC1307</a> - 56 rubles <br>  3. <a href="http://www.ebay.com/itm/5V-2-Canal-De-Relais-Bouclier-Module-Pour-For-Arduino-ARM-PIC-AVR-DSP-/191477601533%3Fpt%3DFR_YO_MaisonJardin_Bricolage_ElectroniqueComposants%26hash%3Ditem2c94f454fd">Relay</a> - 131 rubles <br>  4. <a href="http://www.ebay.com/itm/IIC-I2C-TWI-SP-I-Serial-Interface1602-16X2-Character-LCD-Module-Display-Blue-/310565065847%3Fpt%3DLH_DefaultDomain_0%26hash%3Ditem484f1ed477">LCD 2x16 i2c</a> - 222 rubles <br>  5. 3 resistors of 10 kŒ© each, a certain amount of wires - 50 rubles <br>  Total: 634 rubles <br><br>  In order for Arduin to understand the voltage at each time point on the battery, it was necessary to connect the battery to the Arduino.  This can not be done directly, since the analog inputs of the controller can take no more than 5V, so it was decided to assemble a voltage divider of 3 resistors of 10 kŒ© each.  Negative battery and minus controller are directly linked.  The controller was powered from a separate power source.  Connection diagram and code are presented below: <br><br><img src="https://habrastorage.org/files/461/ae0/063/461ae00637fe40759f1ce5c2278eca15.jpg"><br><br><div class="spoiler">  <b class="spoiler_title">Sketch KTC</b> <div class="spoiler_text"><pre><code class="hljs pgsql">// <span class="hljs-type"><span class="hljs-type">Date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">functions</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> a DS1307 RTC connected via I2C <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> Wire lib #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;EEPROM.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;Wire.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;DS1307.h&gt; #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "RTClib.h" #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> &lt;LiquidCrystal_I2C.h&gt; <span class="hljs-type"><span class="hljs-type">int</span></span> rtc[<span class="hljs-number"><span class="hljs-number">7</span></span>]; byte rr[<span class="hljs-number"><span class="hljs-number">7</span></span>]; LiquidCrystal_I2C lcd(<span class="hljs-number"><span class="hljs-number">0x27</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the LCD address <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">0x27</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a <span class="hljs-number"><span class="hljs-number">16</span></span> chars <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> display #define RELE_NAGRUZKA <span class="hljs-number"><span class="hljs-number">2</span></span> //      <span class="hljs-number"><span class="hljs-number">2</span></span> #define RELE_ZARYADKA <span class="hljs-number"><span class="hljs-number">3</span></span> //      <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> analogPin = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">int</span></span> flag=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> val=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">float</span></span> valkoef=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> setup () { DDRC|=_BV(<span class="hljs-number"><span class="hljs-number">2</span></span>) |_BV(<span class="hljs-number"><span class="hljs-number">3</span></span>); // POWER:Vcc Gnd PORTC |=_BV(<span class="hljs-number"><span class="hljs-number">3</span></span>); // VCC PINC3 RTC.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(rtc,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); lcd.init(); // initialize the lcd lcd.backlight(); lcd.home(); pinMode(RELE_NAGRUZKA, OUTPUT); //     pinMode(RELE_ZARYADKA, OUTPUT); //     lcd.clear(); digitalWrite(RELE_NAGRUZKA, HIGH); digitalWrite(RELE_ZARYADKA, HIGH); RTC.SetOutput(DS1307_SQW32KHZ); EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>, rtc[<span class="hljs-number"><span class="hljs-number">2</span></span>]); //     ,  EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, rtc[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //     ,  } <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> () { val = analogRead(analogPin); //       valkoef=val/<span class="hljs-number"><span class="hljs-number">74</span></span>,<span class="hljs-number"><span class="hljs-number">49</span></span>; //          RTC.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(rtc,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); lcd.setCursor (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print (rtc[<span class="hljs-number"><span class="hljs-number">2</span></span>]); lcd.print (":"); lcd.print (rtc[<span class="hljs-number"><span class="hljs-number">1</span></span>]); lcd.print (":"); lcd.print (rtc[<span class="hljs-number"><span class="hljs-number">0</span></span>]); lcd.print (" str"); lcd.print (EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)); lcd.print (":"); lcd.print (EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)); lcd.setCursor (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); lcd.print (valkoef); lcd.print (" "); lcd.print (flag); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (valkoef &lt; <span class="hljs-number"><span class="hljs-number">10.72</span></span>) { flag=<span class="hljs-number"><span class="hljs-number">1</span></span>; EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>, rtc[<span class="hljs-number"><span class="hljs-number">2</span></span>]); //    ,  EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, rtc[<span class="hljs-number"><span class="hljs-number">1</span></span>]); //    ,  } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flag==<span class="hljs-number"><span class="hljs-number">1</span></span>) { digitalWrite(RELE_ZARYADKA, LOW); //   digitalWrite(RELE_NAGRUZKA, HIGH); //   lcd.print (" stp"); lcd.print (EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)); //     lcd.print (":"); lcd.print (EEPROM.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((valkoef &gt; <span class="hljs-number"><span class="hljs-number">10.72</span></span>) &amp;&amp; (flag==<span class="hljs-number"><span class="hljs-number">0</span></span>)) { digitalWrite(RELE_NAGRUZKA, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(RELE_NAGRUZKA, LOW); } delay(<span class="hljs-number"><span class="hljs-number">500</span></span>); }</code> </pre> <br></div></div><br><br>  How does the device work?  Elementary! <br><br>  The load is connected to the first relay, to the second memory.  And it is better to break the high-voltage power supply circuit of the charger, so as not to leave the device turned on without a battery.  When the controller is turned on, the first line displays the current time and the time the load started working.  The second line displays the current voltage on the battery and the end time of the discharge when the battery reaches the critical voltage.  As soon as the values ‚Äã‚Äãare reached, the load relay is switched off and the charge relay is switched on.  If you add a couple of buttons, you can easily adjust the voltage threshold adjustment or the real-time clock setting.  At this stage, there was no such task, so the code is as simple and functional as possible.  Subtracting from the end of the time of the start of discharge, you can get the capacity, if you multiply the time by the current consumed by the load. <br><br>  Conclusion <br>  So, it is very easy to organize a control and training cycle for any battery with a charger, 600-700 rubles for spare parts and a couple of hours.  Do not forget that a charged battery lasts longer, and periodic KTC gives confidence at least that you know for sure that the car will start in the morning, despite any frosts. </div><p>Source: <a href="https://habr.com/ru/post/253143/">https://habr.com/ru/post/253143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253131/index.html">CSS Sans - a font written in CSS</a></li>
<li><a href="../253133/index.html">Perl 6 Lexical Variables</a></li>
<li><a href="../253135/index.html">PHP Digest number 58 - interesting news, materials and tools (February 22 - March 16, 2015)</a></li>
<li><a href="../253137/index.html">How to bypass the two factor Authy Authentification with ../sms</a></li>
<li><a href="../253139/index.html">Test Chef cookbook</a></li>
<li><a href="../253145/index.html">"Patch" mirror in the car</a></li>
<li><a href="../253149/index.html">Corporate search</a></li>
<li><a href="../253151/index.html">The Groovy project intends to join the Apache Software Foundation</a></li>
<li><a href="../253153/index.html">Brutfors passwords of the engineering menu of the radio station</a></li>
<li><a href="../253155/index.html">How are we tested</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>