<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hardware support for the AES algorithm with modern processors</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2008, Intel proposed new commands for the x86 architecture, which added support for the hardware level of the AES (Advanced Encryption Standard) sy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hardware support for the AES algorithm with modern processors</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/94a/068/dc7/94a068dc736ba89c67245a9dc3e214e4.jpg"><br>  In 2008, Intel proposed new commands for the x86 architecture, which added support for the hardware level of the AES (Advanced Encryption Standard) symmetric encryption algorithm.  At the moment, AES is one of the most popular block encryption algorithms.  Therefore, the hardware implementation should lead to an increase in the performance of programs using this encryption algorithm (OpenSSL, The Bat, TrueCrypt <a href="http://en.wikipedia.org/wiki/AES_instruction_set">...</a> ).  The new expansion of the teams received the name AES-NI.  It contains the following instructions: <br><ul><li>  AESENC - Perform one round of AES encryption, </li><li>  AESENCLAST- Perform the latest AES encryption round, </li><li>  AESDEC - Perform one round of AES decryption, </li><li>  AESDECLAST - Perform the latest AES decryption round, </li><li>  AESKEYGENASSIST - Contribute to the generation of the AES round key, </li><li>  AESIMC - Reverse Mix Columns. </li></ul><br>  Since much has already been said about the AES encryption algorithm itself, in this post we will look at how you can use these instructions. <br><br><a name="habracut"></a><br>  First, let's remember how AES works.  This is required in order to understand what mechanisms are implemented in these instructions. <br>  The AES algorithm uses 4 functions: <br><ol><li>  AddRound - XOR (exclusive or) key messages, </li><li>  SubBytes - substitution function, </li><li>  ShiftRows - cyclic shift of fields in a block according to a given rule, </li><li>  MixColumns - the mixing procedure. </li></ol><br>  The encryption algorithm itself looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/7a1/fcf/78e/7a1fcf78e72162de0cb21856500ad709.jpg"><br><h2>  Getting started </h2><br>  For a start, you need to make sure that the AES-NI extension is present in our processor.  To do this, there is a special CPUID command, which, with the value eax = 0x00000001, must set bits in registers relative to the extensions present.  For the AES extension, this is the 25 bits of the ECX register: <br>  AES-NI verification code: <br><pre><code class="hljs bash">mov eax,0x00000001; CPUID; <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ecx,0x2000000; je L_no_AES;</code> </pre> <br>  If the bit is set to 1, then we can proceed to encryption. <br><h2>  Key Expansion / ExpandKey </h2><br>  The key expansion algorithm in pseudocode looks like this: <br><pre> <code class="delphi hljs">KeyExpansion(byte key[<span class="hljs-number"><span class="hljs-number">4</span></span>*Nk], word w[Nb*(Nr+<span class="hljs-number"><span class="hljs-number">1</span></span>)], Nk) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> word temp i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( i &lt; Nk) w[i] = word(key[<span class="hljs-number"><span class="hljs-number">4</span></span>*i], key[<span class="hljs-number"><span class="hljs-number">4</span></span>*i+<span class="hljs-number"><span class="hljs-number">1</span></span>], key[<span class="hljs-number"><span class="hljs-number">4</span></span>*i+<span class="hljs-number"><span class="hljs-number">2</span></span>], key[<span class="hljs-number"><span class="hljs-number">4</span></span>*i+<span class="hljs-number"><span class="hljs-number">3</span></span>]) i = i+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> i = Nk <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( i &lt; Nb * (Nr+<span class="hljs-number"><span class="hljs-number">1</span></span>)) temp = w[i-<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> Nk = <span class="hljs-number"><span class="hljs-number">0</span></span>) temp = SubWord(RotWord(temp)) xor Rcon[i/Nk] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Nk &gt; <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">mod</span></span> Nk = <span class="hljs-number"><span class="hljs-number">4</span></span>) temp = SubWord(temp) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> w[i] = w[i-Nk] xor temp i = i + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  For hardware support, you must use the AESKEYGENASSIST statement, which will execute: <br><pre> <code class="delphi hljs">AESKEYGENASSIST xmm1, xmm2/m128, imm8 Tmp := xmm2/LOAD(m128) X3[<span class="hljs-number"><span class="hljs-number">31</span></span>-<span class="hljs-number"><span class="hljs-number">0</span></span>] = Tmp[<span class="hljs-number"><span class="hljs-number">127</span></span>-<span class="hljs-number"><span class="hljs-number">96</span></span>]; X2[<span class="hljs-number"><span class="hljs-number">31</span></span>-<span class="hljs-number"><span class="hljs-number">0</span></span>] = Tmp[<span class="hljs-number"><span class="hljs-number">95</span></span>-<span class="hljs-number"><span class="hljs-number">64</span></span>]; X1[<span class="hljs-number"><span class="hljs-number">31</span></span>-<span class="hljs-number"><span class="hljs-number">0</span></span>] = Tmp[<span class="hljs-number"><span class="hljs-number">63</span></span>-<span class="hljs-number"><span class="hljs-number">32</span></span>]; X0[<span class="hljs-number"><span class="hljs-number">31</span></span>-<span class="hljs-number"><span class="hljs-number">0</span></span>] = Tmp[<span class="hljs-number"><span class="hljs-number">31</span></span>-<span class="hljs-number"><span class="hljs-number">0</span></span>]; RCON[<span class="hljs-number"><span class="hljs-number">7</span></span>-<span class="hljs-number"><span class="hljs-number">0</span></span>]:= imm8; RCON [<span class="hljs-number"><span class="hljs-number">31</span></span>-<span class="hljs-number"><span class="hljs-number">8</span></span>]:= <span class="hljs-number"><span class="hljs-number">0</span></span>; xmm1 :=[RotWord (SubWord (X3)) XOR RCON, SubWord (X3), RotWord (SubWord (X1)) XOR RCON, SubWord (X1)]</code> </pre><br>  As it is easy to notice, the instruction does not execute: <br><pre> <code class="delphi hljs">w[i] = w[i-Nk] xor temp</code> </pre><br>  These operations will have to be performed using MMX instructions. <br><div class="spoiler">  <b class="spoiler_title">Example of 128b key expansion</b> <div class="spoiler_text"><pre> <code class="hljs go">aeskeygenassist xmm2, xmm1, <span class="hljs-number"><span class="hljs-number">0x1</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>  pshufd xmm2, xmm2, <span class="hljs-number"><span class="hljs-number">0xff</span></span>; movups xmm3, xmm4; pxor xmm2,xmm3; pshufd xmm2, xmm2, <span class="hljs-number"><span class="hljs-number">0x00</span></span>; pshufd xmm3, xmm3, <span class="hljs-number"><span class="hljs-number">0x39</span></span>; pslldq xmm3,<span class="hljs-number"><span class="hljs-number">0x4</span></span>; pxor xmm2,xmm3; pshufd xmm2, xmm2, <span class="hljs-number"><span class="hljs-number">0x14</span></span>; pshufd xmm3, xmm3, <span class="hljs-number"><span class="hljs-number">0x38</span></span>; pslldq xmm3,<span class="hljs-number"><span class="hljs-number">0x4</span></span>; pxor xmm2,xmm3; pshufd xmm2, xmm2, <span class="hljs-number"><span class="hljs-number">0xA4</span></span>; pshufd xmm3, xmm3, <span class="hljs-number"><span class="hljs-number">0x34</span></span>; pslldq xmm3,<span class="hljs-number"><span class="hljs-number">0x4</span></span>; pxor xmm2,xmm3;</code> </pre><br></div></div><br><br><h2>  Encryption / Encryption </h2><br>  To implement one round of encryption, use the AESENC instruction, which performs the following actions: <br><img src="https://habrastorage.org/getpro/habr/post_images/9f1/19b/b9c/9f119bb9cfab70a456e149777105943b.jpg"><br><pre> <code class="delphi hljs">AESENC xmm1, xmm2/m128 Tmp = xmm1 Round Key := xmm2/m128 Tmp = ShiftRows (Tmp) Tmp = SubBytes (Tmp) Tmp = MixColumns (Tmp) xmm1 = Tmp xor Round Key</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The last round of encryption is implemented using the AESENCLAST instruction: <br><pre> <code class="delphi hljs">AESENC xmm1, xmm2/m128 Tmp = xmm1 Round Key := xmm2/m128 Tmp = ShiftRows (Tmp) Tmp = SubBytes (Tmp) xmm1 = Tmp xor Round Key</code> </pre><br>  The difference between this instruction and AESENC is that the MixColums operation is not performed at the last step: <br><div class="spoiler">  <b class="spoiler_title">Sample encryption procedure</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">aesenc</span></span> xmm1, xmm2 ; <span class="hljs-attribute"><span class="hljs-attribute">aesenclast</span></span> xmm1, xmm3;</code> </pre><br></div></div><br><h2>  Decryption / decryption </h2><br>  To implement the decryption procedure, use the AESDEC instruction: <br><img src="https://habrastorage.org/getpro/habr/post_images/d0d/998/bee/d0d998bee7287e84d47862b7e56f3bea.jpg"><br><pre> <code class="delphi hljs">AESDEC xmm1, xmm2/m128 Tmp = xmm1 Round Key = xmm2/m128 Tmp = InvShift Rows (Tmp) Tmp = InvSubBytes (Tmp) Tmp = InvMixColumns (Tmp) xmm1 = Tmp xor Round Key</code> </pre><br>  To get InvKey, you must perform the InvMixClomuns operation for the key.  The instruction that does this is AESIMC xmm1.xmm2 <br>  And for the last decryption round, the AESDECLAST Statement is used: <br><pre> <code class="delphi hljs">AESDECLAST xmm1, xmm2/m128 State = xmm1 Round Key = xmm2/m128 Tmp = InvShift Rows (State) Tmp = InvSubBytes (Tmp) xmm1= Tmp xor RoundKey</code> </pre><br><div class="spoiler">  <b class="spoiler_title">An example of the decryption procedure</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">aesmic</span></span> xmm2,xmm2; <span class="hljs-attribute"><span class="hljs-attribute">aesdec</span></span> xmm1, xmm2 ; <span class="hljs-attribute"><span class="hljs-attribute">aesdeclast</span></span> xmm1, xmm3;</code> </pre><br></div></div><br><br>  So, hardware support should give us a decent boost to encryption speed.  As the end of the post I will give a <a href="https://github.com/ostikawm/AES-on-AES-NI-instructions">class in C ++</a> that implements encryption and decryption operations in ECB mode.  After the test run, the encryption speed on a single i5-3740 (3.2GHz) core was reached, equal to <b>320MB / sec</b> <br><h3>  References: </h3><br><ol><li>  <a href="http://download-software.intel.com/sites/default/files/article/165683/aes-wp-2012-09-22-v01.pdf">Intel Advanced Encryption Standard (AES) New Instructions Set</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2588%25D0%25B8%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D1%258B_%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4_AES">List of processors supporting the expansion of AES-NI commands</a> </li><li>  <a href="https://github.com/ostikawm/AES-on-AES-NI-instructions">C ++ class with AES-NI assembler inserts</a> </li><li>  <a href="">Animation how AES works</a> </li><li>  <a href="http://en.wikipedia.org/wiki/AES_instruction_set">Wikipedia article with a list of libraries and programs using AES-Ni instructions</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/201114/">https://habr.com/ru/post/201114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201104/index.html">Data Center risks: we built, built and finally built ... Or actions on the construction site</a></li>
<li><a href="../201106/index.html">Megaphone has disabled sending sms with an alphabetic addressee</a></li>
<li><a href="../201108/index.html">Web performance: how Swish.com got 40% faster</a></li>
<li><a href="../201110/index.html">Airlike - BUMP without striking cams</a></li>
<li><a href="../201112/index.html">Is Wi-Fi Beacon an Alternative to QR Codes?</a></li>
<li><a href="../201116/index.html">Google will link the phone number and photo from Google+</a></li>
<li><a href="../201118/index.html">Educational resources and materials on open data</a></li>
<li><a href="../201120/index.html">From dating to the city</a></li>
<li><a href="../201122/index.html">Vertical scaling and Money. The evolution of the hosting industry</a></li>
<li><a href="../201124/index.html">Why is the assessment of compliance of information security tools and there is certification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>