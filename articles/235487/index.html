<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we (almost) defeated DirCrypt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translation of an article from the company Check Point's Malware Research Team. 

 DirCrypt is one of the worst types of Malawary money extorting mone...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we (almost) defeated DirCrypt</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/988/319/4e0/9883194e04d24a0997f9ca9f7267fbfa.jpg"><br><br>  <i>Translation of an <a href="http://www.checkpoint.com/download/public-files/TCC_WP_Hacking_The_Hacker.pdf">article</a> from the company Check Point's Malware Research Team.</i> <br><br>  DirCrypt is one of the worst types of Malawary money extorting money.  It does not just encrypt all found user files, demanding a ransom for decrypting them, but remains in the system, picking up and encrypting the files saved by the user on the fly.  After its appearance, work on the computer turns into a torment. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Victims of such malware are usually recommended to restore files from an early backup.  But if there is no such backup, we face a difficult choice - to accept the loss of data or pay the attacker.  However, we (Check Point's Malware Research Team) managed to find a way to recover almost all data in the case of DirCrypt, taking advantage of its weak points in the implementation of encryption. <br><a name="habracut"></a><br>  A typical victim of DirCrypt learns about the attack only on the fact of its commission.  Malvar combing hard drives in search of documents, images and archives.  After that, the line ".enc.rtf" is added to the name of the files found.  If you try to view their contents in ‚Äúraw‚Äù form - you will not see a trace of old data.  And after opening this file as an RTF document, you will be presented with instructions on how to pay the money to the scammer. <br><br><img src="https://habrastorage.org/files/d81/177/738/d81177738f1f49a9baef1096c8360916.jpg"><br>  <i>File system before file encryption</i> <br><br><img src="https://habrastorage.org/files/68a/ae6/624/68aae662474c4b12a12fc6e5af81d86c.JPG"><br>  <i>File system after file encryption</i> <br><br>  Here we begin our investigation.  The disassembled code of the program is confused and obfuscated, and we have to find in it the code that performs the encryption.  Since the suffix ".enc.rtf" is added to each processed file, it is possible to make a logical conclusion that somewhere in the region of the encryption functions we will see a link to this line.  But after a cursory inspection at Hex-Rays' IDA-Pro, we find that most of the strings and the binary are obfuscated.  Thus, we face the first task: to decipher these lines. <br><br>  One way to search for encrypted strings is to simply examine all sections for the presence of a block of seemingly random data at first glance.  After that, you need to find a function with a cross-reference (DATA XREF) to this piece of binary data.  If an index is placed in this function that is in certain limited limits, then we have found what we were looking for. <br><br>  It turned out to be quite easy to find the area with encrypted data - it is a big chunk in the .data section. <br><br><img src="https://habrastorage.org/files/f0b/d62/b24/f0bd62b2404a4b1a90b3d601da2aa664.JPG"><br>  <i>Encrypted strings</i> <br><br>  Having studied the cross-references to this data block, we learn that several functions access it, one of which is called 170 times in the code.  Turning directly to the places of its call, we see that in it the first parameter is the index.  Bingo, we caught you! <br><br>  The code itself for decoding strings is quite long and complicated.  Since our goal is to decipher the lines as soon as possible, we did not reverse this algorithm, but wrote a small script for Windbg, which did the hard work for us: <br><br><pre><code class="hljs mel">.<span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (@$t0 &lt; <span class="hljs-number"><span class="hljs-number">0xe1</span></span>) { .printf ‚Äú\n%02x‚Äù, @$t0; r eip = <span class="hljs-number"><span class="hljs-number">0x40456a</span></span>; p; p; p; eb esp @$t0; p; du @eax; r $t0 = @$t0 + <span class="hljs-number"><span class="hljs-number">0x01</span></span> }</code> </pre> <br><br>  This code in the loop calls the decryption function, passing in turn the index values ‚Äã‚Äãfrom the range, and the decoded lines themselves are output to the terminal window. <br><br><img src="http://i.imgur.com/Cb0P0OZ.jpg"><br>  <i>Sample output of decoded windbg strings</i> <br><br>  Now we need to transfer the received lines to IDA-Pro for the convenience of static analysis.  We decided to include them in the text as comments in the places where they are used.  To do this, IdaPython wrote a small script that accepts a file (‚Äústrings.txt‚Äù) with a Windbg output dump and inserts strings where the function is being called to decrypt them.  Now we can quickly navigate through cross-references to strings of interest from the DecryptString dialog. <br><br><img src="http://i.imgur.com/wAoXUbf.jpg"><br><br>  Now in the table of such links we find ".enc.rtf" and find that it is used only in one place.  Since the suffix is ‚Äã‚Äãadded to files after encryption, we can safely assume that we are close to the code that executes it. <br><br>  The code for the function that refers to ".enc.rtf" is pretty obvious, and IDA-Pro did some of the work for us, correctly defining its argument as a file name.  At the beginning of the function, another function is called, after which the ".enc.rtf" suffix is ‚Äã‚Äãreceived and decoded, and then the file is renamed.  That is, it is clear that the encryption process itself takes place before renaming in that very first function. <br><br>  Having moved to it, we find a volume code with a repeating pattern: data is read from the file by chunks, which are then changed and written back to the file.  This is the classic behavior of crypting functions, so you can be sure: we found what we were looking for.  Now the fun begins. <br><br><img src="http://i.imgur.com/JZgHlZw.jpg"><br>  <i>External wrapper function that performs encryption</i> <br><br>  The malware in the loop reads chunks of the contents of the file, encrypts them in memory and writes them at the same offsets, erasing the previous data. <br><br><img src="http://i.imgur.com/fLdgCKy.jpg"><br>  <i>Encryption loop</i> <br><br>  Climbing a little deeper, we understand that there are actually two encryption functions.  The first is called for each chunk of read data and thus encrypts the entire file.  As an argument, a pointer to the object, the data for which is created in the second function, is passed to this function.  An experienced eye will recognize here the initialization of the S-box RC4 algorithm. <br><br>  Encryption is performed for each file separately, and the S-box initialization is performed with the same key for each file. <br><br><img src="http://i.imgur.com/kEyVU4g.jpg"><br>  <i>Initialization and operation of the RC4 algorithm</i> <br><br>  If you have ever seen bloopers in cryptography, here you just can not believe your eyes.  And since the S-box is constantly reinitialized, then the same key stream is used for each file.  It remains for us to take the final step: if we know the original contents of the encrypted file on the victim's computer, then to obtain the key stream, we need to perform a XOR operation between original and encrypted data, byte-by-bye. <br><br>  OK, we need to find the file that is guaranteed to be on the Windows file system.  These are, for example, standard images for the desktop background.  Their size is about 100 Kb, so that, without spending much effort, we can get a keystream of the same size. <br><br>  And only this thought flashed through our heads, as the following code rushed into our eyes: <br><br><img src="http://i.imgur.com/cxa4Eie.jpg"><br>  <i>Supplement RC4 key to the end of the encrypted file</i> <br><br>  Having picked up the jaw from the floor, we begin to pity the author of this unfinished Malvari seriously.  Probably confused about where to save the key, he somehow decided to append it to the end of the file, where everyone can find it.  For some reason, this idea seemed to him suitable. <br><br>  This is also beneficial for us: now we can use the same RC4 to completely decrypt the file. <br><br>  But wait.  Here we have another problem: not only RC4 is used to encrypt files. <br><br><img src="http://i.imgur.com/nDmN53n.jpg"><br>  <i>Encryption of the first 1024 bytes of RSA</i> <br><br>  The first chunk of 1024 bytes is encrypted using the RSA algorithm.  Inside the file, the private key is not saved, so one of the ways to obtain it is to pay money to the attacker in exchange for the key.  Assuming that we will not pay the money (and we will not attack the key issuing server), the only way out is to save everything except the first 1024 bytes. <br><br>  In some cases (depending on the format of the file being restored) this task can be successfully solved.  Let's take a standard .doc file for example.  In it, starting at offset 0x1A00, is the text of the file in unicode.  Let DirCrypt encrypt our experimental file and compare its contents ‚Äúbefore‚Äù and ‚Äúafter‚Äù: <br><br><img src="http://i.imgur.com/Jl1Nb5B.jpg"><br>  <i>Experimental document created in Microsoft Word</i> <br><br><img src="http://i.imgur.com/JQb7DWI.jpg"><br>  <i>Document in hex editor before encryption</i> <br><br><img src="http://i.imgur.com/lUWrXtc.jpg"><br>  <i>Document in hex editor after encryption</i> <br><br>  In the case of .doc files, we wrote a simple Python script that extracts the RC4 key, decrypts the file with it (except for the first 1024 bytes) and saves the text in ASCII.  By running it for our experimental file, we were able to completely recover the text of the document. <br><br><img src="http://i.imgur.com/wELn6Fj.jpg"><br>  <i>Extracted text</i> <br><br><h4>  Afterword </h4><br>  In this article, we talked about tricks that will help you find vulnerabilities in crypto-mall.  The original goal for us was to demonstrate that the attacks that this category of malware makes are amenable to analysis to a greater or lesser extent, and the defending party can almost always detect and use the unsuccessful moves of the attacker. </div><p>Source: <a href="https://habr.com/ru/post/235487/">https://habr.com/ru/post/235487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235473/index.html">Cach√© Native Access - working with native libraries in Cach√©</a></li>
<li><a href="../235477/index.html">Firefox 32 release</a></li>
<li><a href="../235479/index.html">Another "smart" outlet with your own hands. Part 1</a></li>
<li><a href="../235483/index.html">On the verge of madness</a></li>
<li><a href="../235485/index.html">Yii2 RBAC setup</a></li>
<li><a href="../235489/index.html">Apple Update Review Guideline, Redget Statistics and All Reports from the Unity Event - Main Mobile News for the Week</a></li>
<li><a href="../235491/index.html">Do you really need the source code?</a></li>
<li><a href="../235493/index.html">Structure attachments to list items in Sharepoint 2010</a></li>
<li><a href="../235495/index.html">How to buy shares of IT companies before, during and after the IPO</a></li>
<li><a href="../235501/index.html">Asus smart watches at IFA 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>