<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Performance comparison of hierarchical models of Django and PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear readers. 


 Today's article will be devoted to comparing models of work with hierarchical data in PostgreSQL, through the Django...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Performance comparison of hierarchical models of Django and PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"><p>  Good afternoon, dear readers. </p><br><p>  Today's article will be devoted to comparing models of work with hierarchical data in PostgreSQL, through the Django application.  In this article, I do not specifically use a clean implementation in the database, because I am interested in performance in an environment close to the combat one. </p><a name="habracut"></a><br><p>  <strong>All tests were conducted on my data and the results are relevant for these data, on your data the result may differ from those obtained in the article.</strong> </p><br><h3 id="modeli-realizacii-ierarhicheskih-struktur-v-bd">  Model implementation of hierarchical structures in the database </h3><br><p>  The following <a href="https://medium.com/notes-from-a-messy-desk/representing-trees-in-postgresql-cbcdae419022">models</a> can be used to work with such structures in PostgreSQL: </p><br><ol><li>  <strong>Adjacency model (AM)</strong> - model when the parent is stored in the column; </li><li>  <a href="https://communities.bmc.com/docs/DOC-9902"><strong>Nested Sets (NS)</strong></a> - model, when a range of all nested elements is stored in a pair of columns; </li><li>  <a href="https://communities.bmc.com/docs/DOC-9902"><strong>Materialized Path model (MP)</strong></a> - model, when the full path to the element is stored in the column. </li></ol><br><p>  You can also read more about the implementation of hierarchical structures in a relational database <a href="https://habrahabr.ru/post/193166/">here</a> . </p><br><p>  The following tools are selected for their implementation in Django: </p><br><ol><li>  AM - Django-based ForeignKey-based recursion; </li><li>  NS - <a href="https://github.com/django-mptt/django-mptt">django-mptt</a> module; </li><li>  MP - PostgreSQL <a href="https://www.postgresql.org/docs/9.1/static/ltree.html">ltree</a> module with <a href="https://github.com/yyjinlong/ltreefield">LtreeField</a> wrapper; </li></ol><br><h3 id="metodika-testirovaniya">  Testing method </h3><br><p>  Testing will be conducted on a data set of 150 thousand companies.  Time will be measured for <br>  the following requests: </p><br><ol><li>  Reading the whole tree </li><li>  Read arbitrary node </li><li>  Insert node </li><li>  Moving a subtree between levels </li></ol><br><p>  <em>The query execution time</em> will be considered the average execution time of 1000 queries for each item, to a randomly selected element of the tree. </p><br><h3 id="apparatnoe-obespechenie-testovogo-stenda">  Test bench hardware </h3><br><ul><li>  CPU Core i5 2.5 GHz </li><li>  RAM 1600 MHz DDR3 </li><li>  SSD Samsung 850 EVO 500GB </li></ul><br><h3 id="programmnoe-obespechenie-testovogo-stenda">  Test bench software </h3><br><ul><li>  Python 2.7 </li><li>  Postgres 9.6 </li><li>  Django 1.8 </li><li>  psycopg2 </li></ul><br><h3 id="opisanie-instrumenta-testirovaniya">  Testing Tool Description </h3><br><p>  For testing created a <a href="https://github.com/kuznetsovin/sql-tree-perfomance">separate Django</a> application.  It created 3 models, one for each storage scheme described above.  This is done so that at any time it was possible to conduct similar testing on different data sets. </p><br><p>  This application has two commands: </p><br><ul><li> <code>load_tree</code> - loads data for a test </li><li>  <code>analize</code> - performs data collection and analysis based on the specified number of requests </li></ul><br><p>  To run the application and collect statistics, you need to run a sequence of commands: </p><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">python</span></span> manage.py migrate <span class="hljs-keyword"><span class="hljs-keyword">python</span></span> manage.py load_tree &lt;    &gt; <span class="hljs-keyword"><span class="hljs-keyword">python</span></span> manage.py load_tree analize &lt;-   &gt;</code> </pre> <br><p>  The results of the <code>analize</code> are stored in the <em>report</em> folder. </p><br><h3 id="rezultaty">  results </h3><br><p>  After executing the specified commands, for my data, I received the following results.  To ensure that the names of the models do not mislead you, I will give below the correspondence between the models from the test and the storage models: </p><br><ul><li>  <em>Raw</em> - adjacency model </li><li>  <em>Mptt</em> - nested sets </li><li>  <em>Ltree</em> - materialized path </li></ul><br><h4 id="chtenie-vsego-dereva">  Reading the whole tree </h4><br><p><img src="https://kuznetsovin.github.io/resource/sql_tree_perform_files/read_tree_chart.png" alt="read_tree_chart"></p><br><p>  As can be seen from the diagram, the <em>Mptt</em> and <em>Ltree models</em> showed approximately the same result, but the native <em>Raw</em> model was faster. </p><br><h4 id="chtenie-proizvolnogo-uzla">  Read arbitrary node </h4><br><p><img src="https://kuznetsovin.github.io/resource/sql_tree_perform_files/read_node_chart.png" alt="read_node_chart"></p><br><p>  In this test, unlike the previous point, the <em>Mptt</em> model <em>caught up</em> in speed with the standard implementation, while the <em>Ltree,</em> on the contrary, worsened its result.  It should be noted that the <em>Raw</em> model uses a recursive query (WITH RECURSION) to get descendants, and, in spite of this, it worked the fastest. </p><br><h4 id="vstavka-uzla">  Insert node </h4><br><p><img src="https://kuznetsovin.github.io/resource/sql_tree_perform_files/insert_node_chart.png" alt="insert_node_chart"></p><br><p>  When inserting a node, the <em>Ltree</em> model again fell behind, but in this case it was most likely due to the fact that the field of the tree where the tree was stored consisted of id records, so I had to make 2 queries (insert, and then update the path field), which affected accordingly on performance. </p><br><h4 id="peremeschenie-poddereva-mezhdu-urovnyami">  Moving a subtree between levels </h4><br><p><img src="https://kuznetsovin.github.io/resource/sql_tree_perform_files/move_node_chart.png" alt="move_node_chart"></p><br><p>  In the displacement of a node with a subtree, <em>Mptt</em> showed the worst result, most likely due to the fact that when moving it must recount all the fields of the transferred nodes, which is not a quick operation.  Moving <em>Raw</em> is the fastest, because, in fact, it‚Äôs just updating one field.  <em>Ltree is</em> not much behind the leader, as it must update the paths of all all nodes of the portable subtree. </p><br><h3 id="itogi">  Results </h3><br><p>  <a href="https://habrahabr.ru/post/46659/">After comparing the implementation of</a> hierarchical structures, I expected the implementation of the <strong>MP</strong> (Ltree) model to show the best result, but to my surprise, it showed only the second result, yielding to the native implementation of the <strong>AM</strong> (Raw) model.  Well, the implementation of the <strong>NS</strong> (Mptt) model got the 3rd place, because in 2 tests out of 4 it lost by a large margin from the competitors. </p><br><p>  Summary table with the results: </p><br><table><thead><tr><th>  model </th><th>  insert_node </th><th>  move_node </th><th>  read_node </th><th>  read_tree </th></tr></thead><tbody><tr><td>  <em>Ltree</em> </td><td>  0.001955 </td><td>  0.010375 </td><td>  0.008745 </td><td>  0.025522 </td></tr><tr><td>  <em>Mptt</em> </td><td>  0.001006 </td><td>  0.855293 </td><td>  0.00104 </td><td>  0.115597 </td></tr><tr><td>  <em>Raw</em> </td><td>  0.001002 </td><td>  0.001 </td><td>  0.001012 </td><td>  0.021957 </td></tr></tbody></table><br><p>  <em>It should also be noted that the results may vary for other data sets and therefore it is recommended to conduct a similar test for your data before making a decision.</em> </p><br><h3 id="ispolzuemye-stati">  Articles used: </h3><br><ol><li>  <a href="https://medium.com/notes-from-a-messy-desk/representing-trees-in-postgresql-cbcdae419022">Representing Trees in PostgreSQL</a> </li><li>  <a href="https://communities.bmc.com/docs/DOC-9902">Trees in SQL Paths and Materialized Path</a> </li><li>  <a href="https://habrahabr.ru/post/193166/">Storage of trees in the database.</a> </li><li>  <a href="https://github.com/kuznetsovin/sql-tree-perfomance">Benchmark tree structure for Django</a> </li><li>  <a href="https://habrahabr.ru/post/46659/">Hierarchical Data Structures and Doctrine</a> </li><li>  <a href="https://www.postgresql.org/docs/9.1/static/ltree.html">Ltree</a> </li><li>  <a href="https://github.com/django-mptt/django-mptt">Django-mptt</a> </li><li>  <a href="https://github.com/yyjinlong/ltreefield">LtreeFiled</a> </li></ol><br><blockquote>  PS This is a cross-post of the <a href="https://kuznetsovin.github.io/post/sql-tree-perform/">original article</a> from my blog. <br><br>  PS Updated tree reading schedule after adding sorts </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/329204/">https://habr.com/ru/post/329204/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329194/index.html">Use Cake to build C # code.</a></li>
<li><a href="../329196/index.html">How to quickly set up autoposting for Facebook and Twitter</a></li>
<li><a href="../329198/index.html">We invite you to a meeting of ThinkJava # 5 in Kharkov</a></li>
<li><a href="../329200/index.html">ArcaOS 5.0 - a new version of OS / 2 has become available to the public.</a></li>
<li><a href="../329202/index.html">Nimble Storage on HPE: How InfoSight allows you to see the invisible in your infrastructure</a></li>
<li><a href="../329206/index.html">You measure CPU usage incorrectly.</a></li>
<li><a href="../329208/index.html">Issue # 2: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../329212/index.html">Play music on RIT ++</a></li>
<li><a href="../329214/index.html">Korean colleagues: understand and forgive</a></li>
<li><a href="../329216/index.html">The reverse side of recruitment: what HR technologies have changed for candidates</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>