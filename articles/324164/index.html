<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using scripts in Openvpn to integrate it with other system services (Firewall, DB, etc.)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I wanted to collect a VPN processor that would take users from the database, set up a firewall for this user, and write logs to the database. 

 OpenV...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using scripts in Openvpn to integrate it with other system services (Firewall, DB, etc.)</h1><div class="post__text post__text-html js-mediator-article">  I wanted to collect a VPN processor that would take users from the database, set up a firewall for this user, and write logs to the database. <br><br>  OpenVPN for each event (connection, disconnection of the client) can cause an external program.  We will use this. <br><a name="habracut"></a><br>  I use FreeBSD, but everything described below will work on any Linux, I just need to change the paths.  Postgresql will act as a database.  Authorization by certificate and password. <br>  I will write the script of interaction with external services in Perl <br><br>  Create a database: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="sql hljs">psql -Upgsql template1 ctreate database vpn; \q</code> </pre> <br>  Description of the tables in the database: <br><br>  <b>users</b> - from the name it is clear that there will be users in it. <br>  columns: <br><br><ul><li>  <b>id</b> </li><li>  <b>login</b> - in my system login is digital, just so convenient. </li><li>  <b>name</b> - name of the user. </li><li>  <b>password</b> - the password in MD5. </li><li>  <b>groups_id</b> - group id to which the user belongs. </li><li>  <b>active</b> - the status of the user, whether it is determined by it or not, the user can connect to vpn. </li><li>  <b>hwkey</b> - I have users who use eToken, this field defines such.  If the user has an eToken, then the password check is not performed. </li></ul><br>  <b>groups</b> - a table with groups <br><br><ul><li>  <b>id</b> </li><li>  <b>groupname</b> is the name of the group. </li><li>  <b>active</b> - group status, active or not. </li></ul><br>  <b>log</b> - <b>log</b> table, I will write the start and end of the session into it <br><br><ul><li>  <b>id</b> </li><li>  <b>date</b> - date </li><li>  <b>users_id</b> - user id </li><li>  <b>realaddress</b> - real ip address </li><li>  <b>virtualaddress</b> - internal address issued by the OpenVPN server </li><li>  <b>action</b> - an event is written here (start / stop) </li></ul><br>  <b>stat</b> - online users table <br><br><ul><li>  <b>id</b> </li><li>  <b>date</b> - connection date </li><li>  <b>name</b> - user name </li><li>  <b>realaddress</b> - real ip address </li><li>  <b>virtualaddress</b> - address issued by the OpenVPN server </li></ul><br>  Create tables: <br><br><pre> <code class="sql hljs">psql -Upgsql vpn; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span>, <span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-string"><span class="hljs-string">"groups_id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"active"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"hwkey"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>, ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span>, <span class="hljs-string"><span class="hljs-string">"groupname"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"active"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>, <span class="hljs-string"><span class="hljs-string">"users_id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"realaddress"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>), <span class="hljs-string"><span class="hljs-string">"virtualaddress"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>), <span class="hljs-string"><span class="hljs-string">"status"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> stat ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span>, <span class="hljs-string"><span class="hljs-string">"date"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span>, <span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>); "realaddress" varchar(32), "virtualaddress" varchar(32) );</code> </pre><br>  Create a user with read permissions for the users and groups tables, and write to log and stat <br><br><pre> <code class="sql hljs">psql -Upgsql template1 <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ovpn <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> <span class="hljs-string"><span class="hljs-string">'password'</span></span>; \q psql -Upgsql vpn <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> ovpn; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ovpn; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ovpn; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> stat <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ovpn; \q</code> </pre><br>  Filling tables: <br><br>  For example, create two groups, <b>admins</b> with full access to the internal network and <b>rdp</b> with access to the servers via RDP. <br><br>  Accordingly, we will create two users: <br><br>  100101 - admin <br>  100102 - with access to RDP <br><br><pre> <code class="sql hljs">psql -Upgsql vpn <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>(dafault,<span class="hljs-string"><span class="hljs-string">'admins'</span></span>,<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>,<span class="hljs-string"><span class="hljs-string">'rdp'</span></span>,<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>,<span class="hljs-number"><span class="hljs-number">100101</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">md5</span></span>(<span class="hljs-string"><span class="hljs-string">'password'</span></span>),(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> groupname = <span class="hljs-string"><span class="hljs-string">'admins'</span></span>),<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>,<span class="hljs-number"><span class="hljs-number">100102</span></span>,<span class="hljs-string"><span class="hljs-string">' ..'</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">md5</span></span>(<span class="hljs-string"><span class="hljs-string">'password'</span></span>),(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> groupname = <span class="hljs-string"><span class="hljs-string">'rdp'</span></span>),<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-literal"><span class="hljs-literal">false</span></span>);</code> </pre><br>  As a result, two groups were created with id 1 and 2. In accordance with these id, tables will be created in the firewall, to which corresponding permissions will be determined. <br><br>  <b>Certificates</b> <br><br>  If there is no root certificate yet, you need to create it.  I have certificates in / root / ca <br><br><pre> <code class="hljs objectivec">cd /root/ca openssl req -x509 -newkey rsa:<span class="hljs-number"><span class="hljs-number">1024</span></span> -keyout /root/ca/ssl.key/ca.key -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /root/ca/ssl.crt/ca.crt -days <span class="hljs-number"><span class="hljs-number">9999</span></span> -nodes -subj <span class="hljs-string"><span class="hljs-string">"/C=RU/ST=MSK/L=MSK/O=COMPANY/CN=CA"</span></span></code> </pre><br>  Certificate for server signed with CA certificate: <br><br><pre> <code class="hljs pgsql">openssl req -<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> -newkey rsa:<span class="hljs-number"><span class="hljs-number">1024</span></span> -nodes -keyout /root/ca/ssl.key/ovpn.key -subj /CN=ovpn.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>.ru -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /root/ca/ssl.csr/ovpn.csr openssl ca -config ca.conf -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /root/ssl.csr/ovpn.csr -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /root/ssl.crt/ovpn.crt -batch</code> </pre><br>  ovpn.key, ovpn.crt and ca.crt must be copied to the OpenVPN server. <br><br>  To generate user certificates, I use the following script, it packs the user's key and certificate into a password-protected p12 file. <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use Getopt::Long; GetOptions ('a=s' =&gt; \$action, 'u=s' =&gt; \$user, 'O=s' =&gt; \$ou, 'o=s'=&gt; \$options, 'help' =&gt; sub {HelpMessage()}); # variables $ca='ca'; $ca_dir='/root/ca/'; $key_id='1000'; if (length($action)==0){ HelpMessage(); exit; } if ($action=~/^help$/){ print "actions: adduser # Add a new User certificate gen_revoke # Generate revoke file\n"; exit; } if ($action=~/^adduser$/){ adduser(); } if ($action=~/^gen_revoke$/){ gen_revoke(); } sub HelpMessage { print "usage: ".$0. " -a &lt;adduser|gen_revoke&gt; -u &lt;login&gt; -O &lt;VPN&gt;\n"; exit; } sub adduser { $p12_password = randomPassword(6); print "~~Add User(Soft)~~\n"; if (length($user)==0 || length($ou)==0){ print "Error, User and OU must be\n"; exit; } # create cert print "create User certificate\n"; system(`openssl req -new -newkey rsa:1024 -nodes -keyout $ca_dir/ssl.key/$user.key -subj /CN=$user/OU=$ou -out $ca_dir/ssl.csr/$user.csr`); # sign USER cert print "sign certificate\n"; system(`openssl ca -config ca.conf -in $ca_dir/ssl.csr/$user.csr -out $ca_dir/ssl.crt/$user.crt -batch`); # p12 print "create p12\n"; system(`openssl pkcs12 -export -in $ca_dir/ssl.crt/$user.crt -inkey $ca_dir/ssl.key/$user.key -certfile $ca_dir/ssl.crt/$ca.crt -out p12/$user.p12 -passout pass:$p12_password`); print "p12_password: ".$p12_password."\n"; # unlink files unlink('$ca_dir/ssl.csr/$user.csr','$ca_dir/ssl.crt/$user.crt','$ca_dir/ssl.key/$user.key'); } sub gen_revoke { # gen CRL system(`openssl ca -config $ca_dir/ca.conf -gencrl -crldays 365 -out $ca_dir/ssl.crl/certPEM.crl`); system(`openssl crl -in $ca_dir/ssl.crl/certPEM.crl -outform DER -out $ca_dir/ssl.crl/certDER.crl`); print "pls copy ./ssl.crl/certDER.crl to OpenVPN server\n"; } sub randomPassword { $password; $_rand; $password_length = $_[0]; if (!$password_length) { $password_length = 10; } @chars = split(" ", "ABCDEFGHIJK LMNOPQRSTUVWXYZ abcdefghijklmnopqrstu vwxyz 0 1 2 3 4 5 6 7 8 9"); srand; for (my $i=0; $i &lt;= $password_length ;$i++) { $_rand = int(rand 41); $password .= $chars[$_rand]; } return $password; }</span></span></code> </pre><br>  Create certificates for our users <br><br><pre> <code class="hljs">/root/ca/gen_cert.pl -a adduser -U 100101 -O VPN /root/ca/gen_cert.pl -a adduser -U 100102 -O VPN</code> </pre><br>  the output will be two files /root/ca/p12/100101.p12 and /root/ca/p12/100102.p12 and passwords to them, which the script will type in the console.  These files will need to be installed on user computers (tablets / phones) in a secure storage.  As a rule, container passwords are not communicated to users, this excludes the possibility for users to transfer their keys to others. <br><br>  You can immediately create a file of revoked crl certificates <br><br><pre> <code class="hljs">/root/ca/gen_cert.pl -a gen_revoke</code> </pre><br>  It must be copied to the OpenVPN server. <br><br>  <b>OpenVPN server setup</b> <br><br><pre> <code class="hljs pgsql">port <span class="hljs-number"><span class="hljs-number">1194</span></span> proto udp dev tun ca /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/ssl/ca.crt cert /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/ssl/ovpn.crt key /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/ssl/ovpn.key crl-verify /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/ssl/certPEM.crl dh /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/ssl/dh2048.pem tls-verify "/usr/local/etc/openvpn/scripts/intra.pl tls-verefy" topology subnet <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.40</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> push "route 172.16.0.0 255.255.0.0" push "dhcp-option DOMAIN domain.local" push "dhcp-option DNS 172.16.38.10" client-<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/openvpn/scripts/intra.pl client-disconnect /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/openvpn/scripts/intra.pl auth-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-pass-verify "/usr/local/etc/openvpn/scripts/intra.pl auth-user-pass-verify" via-env keepalive <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span> persist-key persist-tun status /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/openvpn-status.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/openvpn.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-append /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/openvpn.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> management localhost <span class="hljs-number"><span class="hljs-number">7505</span></span> verb <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  So, in four places in the config, the external script is called: <br><br>  <b>The tls-verify</b> parameter allows you to verify a client certificate for some compliance.  In my case, I check that the same thing is written to CN as the client sends to Login, in other words, I check that CN = Login.  This eliminates the possibility that a user having one certificate would try to log in as another user by entering his username and password.  I also check that in the OU field there is a VPN value.  I add both values ‚Äã‚Äãwhen generating user certificates. <br><br>  <b>client-connect the</b> script is called at the user connection stage.  Here I add the user's address to the appropriate firewall table, and make entries in the log and stat tables. <br><br>  <b>client-disconnect the</b> script is called at the stage of disconnecting the user.  I delete records from the firewall, write to the log and stat tables. <br><br>  <b>auth-user-pass-verify</b> verification of the transmitted login and password in the database. <br><br>  Actually, the script itself is lower. <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use DBI; use Digest::MD5 qw(md5_hex); $dbh=DBI-&gt;connect("DBI:Pg:dbname=vpn;host=localhost","ovpn","password"); ($script_type,$common_name,$ifconfig_pool_remote_ip,$untrusted_ip) = ($ENV{'script_type'},$ENV{'common_name'},$ENV{'ifconfig_pool_remote_ip'},$ENV{'untrusted_ip'}); if ($script_type eq "client-connect") { insert_to_firewall_group(); logging('start'); } if ($script_type eq "client-disconnect") { delete_from_firewall_group(); logging('stop'); } if ($script_type eq "tls-verefy"){ tls_verefy(); } if ($script_type eq "auth-user-pass-verify"){ auth_user_pass_verefy(); } sub get_group { my $req="SELECT groups.id FROM groups INNER JOIN users ON (users.groups_id = groups.id) WHERE users.login='$common_name'"; @row = $dbh-&gt;selectrow_array($req); } sub insert_to_firewall_group { get_group(); `/sbin/ipfw table 0 add $untrusted_ip`; `/sbin/ipfw table $row[0] add $ifconfig_pool_remote_ip`; } sub delete_from_firewall_group { get_group(); `/sbin/ipfw table 0 delete $untrusted_ip`; `/sbin/ipfw table $row[0] delete $ifconfig_pool_remote_ip`; } sub tls_verefy { ($script_type, $depth, $x509) = @ARGV; @X509=split(",",$x509); $X509[0] =~s/^OU=//g;$ou = $X509[0]; $X509[1] =~s/^ CN=//g; $cn = $X509[1]; @ous=('VPN'); if ($depth == 0) { #verefy OU foreach(@ous){ if ($_ eq $ou) { $ou_status = 1; #exit 0; } } #verefy CN $req = "SELECT login FROM users WHERE login = '$cn' AND active = true"; @row = $dbh-&gt;selectrow_array($req); if ($row[0] eq $cn) { $cn_status = 1; } if ($ou_status == 1 &amp;&amp; $cn_status == 1){ exit 0; } exit 1; } } sub logging { ($status) = @_; $date = `date '+%Y-%m-%d %H:%M:%S'`; chop $date; $req = "INSERT INTO log VALUES(DEFAULT,'$date',(SELECT id FROM Users WHERE login='$common_name'),'$untrusted_ip','$ifconfig_pool_remote_ip','$status')"; $dbh-&gt;do($req); if ($status eq "start"){ $st = "INSERT INTO stat VALUES(DEFAULT,'$date','$common_name','$untrusted_ip','$ifconfig_pool_remote_ip')"; $dbh-&gt;do($st); } else { $st = "DELETE FROM stat WHERE login='$common_name'"; $dbh-&gt;do($st); } } sub auth_user_pass_verefy { $username = $ENV{'username'}; $password = $ENV{'password'}; $common_name = $ENV{'common_name'}; $q_hw = "SELECT hwkey FROM users WHERE login = '$common_name' AND active = true"; @row = $dbh-&gt;selectrow_array($q_hw); if ($row[0] == 1 ){ exit 0; } $password = md5_hex($password); $req = "SELECT login FROM users WHERE login = '$username' AND password = '$password' AND active = true"; @row = $dbh-&gt;selectrow_array($req); if ($row[0] eq $username) { exit 0; } exit 1; }</span></span></code> </pre><br>  <b>Firewall</b> <br><br>  The firewall created tables where the table number = group id from the groups table <br><br><pre> <code class="hljs mel">#!/bin/sh ipfw=<span class="hljs-string"><span class="hljs-string">'/sbin/ipfw -q'</span></span> clients_real_ip=<span class="hljs-string"><span class="hljs-string">"table(0)"</span></span> #     ,    admins=<span class="hljs-string"><span class="hljs-string">"table(1)"</span></span> #    admins rdp=<span class="hljs-string"><span class="hljs-string">"table(2)"</span></span> #    rdp ${ipfw} flush # --    -- ${ipfw} add allow ip from ${admins} to any #     ${ipfw} add allow tcp from ${rdp} to any <span class="hljs-number"><span class="hljs-number">3389</span></span> #   rdp   RDP ${ipfw} add deny all from ${rdp} to any #     rdp # --   --</code> </pre><br>  it remains to install p12 on the user device, copy ca.crt and such a config <br><br><pre> <code class="hljs tex">client dev tun proto udp remote ovpn.domain.ru 1194 resolv-retry infinite nobind persist-key persist-tun script-security 3 ca "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>Program Files<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>OpenVPN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>config<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>ca.crt" cryptoapicert "SUBJ:100101" auth-user-pass comp-lzo log "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>Program Files<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>OpenVPN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>log<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>client.log" log-append "C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>Program Files<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>OpenVPN<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>log<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>client.log" verb 3 route-delay 5 30 tap-sleep 5</code> </pre><br>  Finally, delicious for those who use dashboard <a href="http://dashing.io/">dashboard</a> .  The script must be put in the dashboard / jobs <br><br>  vpn_stat.rb <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'pg'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'geoip'</span></span> $conn = PG.connect( <span class="hljs-symbol"><span class="hljs-symbol">:hostaddr=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">'ovpn.domain.local'</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:user=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">'ovpn'</span></span></span></span>,<span class="hljs-symbol"><span class="hljs-symbol">:password=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">'password'</span></span></span></span>,<span class="hljs-symbol"><span class="hljs-symbol">:dbname=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">'vpn'</span></span></span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getVPNstat</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">all</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Hash</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">value:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params"> })</span></span></span></span> result = $conn.exec( <span class="hljs-string"><span class="hljs-string">"SELECT COALESCE(users.name,stat.login) AS name,stat.realaddress AS ip FROM stat,users WHERE stat.login = users.login"</span></span>) result.each <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">| row |</span></span> user = row[<span class="hljs-string"><span class="hljs-string">'name'</span></span>] user = user[<span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">8</span></span>].downcase ip = row[<span class="hljs-string"><span class="hljs-string">'ip'</span></span>] country = geoip(ip) all[user] = {<span class="hljs-symbol"><span class="hljs-symbol">label:</span></span> user,<span class="hljs-symbol"><span class="hljs-symbol">value:</span></span> country } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> send_event(<span class="hljs-string"><span class="hljs-string">'vpnstat'</span></span>, { <span class="hljs-symbol"><span class="hljs-symbol">items:</span></span> all.values }) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">geoip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ip)</span></span></span></span> c = GeoIP.new(<span class="hljs-string"><span class="hljs-string">'/usr/local/www/ruby/dashboard/geoip/GeoIP.dat'</span></span>).country(ip) country = c[<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> country <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> SCHEDULER.every <span class="hljs-string"><span class="hljs-string">'20s'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> getVPNstat <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Download GeoIP database: <br><br><pre> <code class="hljs ruby">wget -N <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/geolite.maxmind.com/download</span></span><span class="hljs-regexp"><span class="hljs-regexp">/geoip/database</span></span><span class="hljs-regexp"><span class="hljs-regexp">/GeoLiteCountry/</span></span>GeoIP.dat.gz</code> </pre> <br>  and unpack it in the dashboard / geoip /. <br><br>  Add tiles to dashboards: <br><br><pre> <code class="hljs kotlin"> &lt;li <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-row=<span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-col=<span class="hljs-string"><span class="hljs-string">"5"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-sizex=<span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-sizey=<span class="hljs-string"><span class="hljs-string">"2"</span></span>&gt; &lt;div <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-id=<span class="hljs-string"><span class="hljs-string">"vpnstat"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-view=<span class="hljs-string"><span class="hljs-string">"Currency"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-unordered=<span class="hljs-string"><span class="hljs-string">"true"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>-title=<span class="hljs-string"><span class="hljs-string">"VPN"</span></span> style=<span class="hljs-string"><span class="hljs-string">"background-color:green"</span></span>&gt;&lt;/div&gt; &lt;/li&gt;</code> </pre><br>  It will look like this: <br><br><img src="https://habrastorage.org/files/57a/750/7ed/57a7507edfc24d839f4616f84e487532.png"><br><br>  That's all.  It remains only to write a simple web admin area for the most lazy. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/324164/">https://habr.com/ru/post/324164/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324152/index.html">Practical application of Fourier transform for signal processing</a></li>
<li><a href="../324156/index.html">Cisco Smart Install. We study technology, we look for attack vectors</a></li>
<li><a href="../324158/index.html">Harmonic Linearization with Python Tools</a></li>
<li><a href="../324160/index.html">Parametric modeling in CAD SolveSpace: Introduction</a></li>
<li><a href="../324162/index.html">Direct charity: children - toys, adults - the right to drawings</a></li>
<li><a href="../324166/index.html">Liscript - REPL bots online</a></li>
<li><a href="../324170/index.html">Names or semantics of classes in programming</a></li>
<li><a href="../324172/index.html">Filtering and chaining in functional JavaScript</a></li>
<li><a href="../324174/index.html">What should we build an email marketing service? An inside look, part two</a></li>
<li><a href="../324176/index.html">Create a web application using VueJS and .NET</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>