<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another bike to fight callback hell in javascript</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is believed that the JavaScript world is booming: new language standards are regularly published, new syntactic features appear, and developers imm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another bike to fight callback hell in javascript</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/aee/d54/935/aeed54935bc74d30b61fd9b072102164.jpg"><br><br>  It is believed that the JavaScript world is booming: new language standards are regularly published, new syntactic features appear, and developers immediately adapt and rewrite all their frameworks, libraries, and other projects so that all this is used.  Now, for example, if you still write in the code var, and not const or let, then this is sort of like a moveton.  And if the function is not described using the arrow syntax, then it's a shame ... <br><br>  However, all these const-s, let-s, class-s and most other innovations are nothing more than cosmetics, which, although it makes the code more beautiful, does not solve really acute problems. <br><a name="habracut"></a><br>  I think that the main problem of JavaScript, which has long been ripe and overripe, and which should have been resolved in the first place, is the impossibility of suspending execution, and as a result, the need to do everything through callbacks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What are good callbacks? </h4><br>  In my opinion, only by giving us eventfulness and asynchrony, which allows us to instantly respond to events, do a great job in one process, save resources, etc. <br><br><h4>  What are bad callbacks? </h4><br>  The first thing a newbie usually encounters is the fact that as the complexity grows, the code quickly turns into incomprehensible, repeatedly embedded blocks - ‚Äúcallback hell‚Äù: <br><br><pre><code class="javascript hljs">fetch(‚Äúlist_of_urls‚Äù, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">array_of_urls</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; array_of_urls.length; i++) { fetch(array_of_urls[i], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">profile</span></span></span><span class="hljs-function">)</span></span>{ fetch(profile.imageUrl, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">image</span></span></span><span class="hljs-function">)</span></span>{ ... }); }); } });</code> </pre> <br>  Secondly, if functions with callbacks are connected to each other by logic, then this logic has to be split up and put into separate named functions or modules.  For example, the code above will execute the ‚Äúfor‚Äù loop and start the <i>fetch</i> set <i>(array_of_urls [i] ...</i> instantly, and if <i>array_of_urls is</i> too large, then the JavaScript engine will hang and / or crash with an error. <br><br>  This can be dealt with by rewriting the ‚Äúfor‚Äù loop into a recursive function with a callback, but recursion can overflow the stack and also drop the engine.  In addition, recursive programs are more difficult to understand. <br><br>  Other solutions require the use of additional tools or libraries: <br><br><ul><li>  Promises - allows you to write callback code inside certain objects.  As a result, these are the same callbacks, but with less nesting and chained together: <br><br><pre> <code class="hljs pgsql">firstMethod().<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(secondMethod).<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(thirdMethod);</code> </pre> <br>  In my opinion Promises is a crutch, because <br><br><ol><li>  chains call functions in only one given order, </li><li>  if the order can change according to some logic, you still have to split the logic in callbacks into separate functions, </li><li>  to encode logic between functions, you still have to invent something, instead of just using standard if, for, while, etc. </li><li>  logic with Promises looks obscure. </li></ol><br></li><li>  async (library) - allows you to declare an array of functions with callbacks, and execute them one after the other, or simultaneously.  The disadvantages are the same as those of Promises. </li><li>  async / await - a new feature in JavaScript, based on generators, allows you to stop and resume the execution of a function. </li></ul><br>  The future, apparently, for async / await, but so far this future has not come, and many engines do not support this feature. <br><br>  In order to be able to execute code with async / await on JavaScript 2015 engines that are currently relevant, transpilers were created - code converters from new JavaScript to old.  The most famous of them, Babel, allows you to convert Javascript 2017 code with async / await in JavaScript 2015 and run it on almost all engines currently used. <br><br>  It looks like this: <br><br>  JavaScript 2017 source code: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyUserFriends</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user_id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> friends = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> getUserFriends(user_id); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;friends.length; i++) { friend = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> getUser(friends[i].id); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sent = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> sendEmail(freind.email,<span class="hljs-string"><span class="hljs-string">"subject"</span></span>,<span class="hljs-string"><span class="hljs-string">"body"</span></span>); } }</code> </pre><br>  Converted JavaScript code 2015: <br><br><div class="spoiler">  <b class="spoiler_title">Hidden in spoiler</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">"use strict"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> notifyUserFriends = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ref = _asyncToGenerator(regeneratorRuntime.mark(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_callee</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user_id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> friends, i, sent; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> regeneratorRuntime.wrap(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_callee$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_context</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_context.prev = _context.next) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: _context.next = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getUserFriends(user_id); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: friends = _context.sent; i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(i &lt; friends.length)) { _context.next = <span class="hljs-number"><span class="hljs-number">14</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } _context.next = <span class="hljs-number"><span class="hljs-number">7</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getUser(friends[i].id); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>: friend = _context.sent; _context.next = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sendEmail(freind.email, <span class="hljs-string"><span class="hljs-string">"subject"</span></span>, <span class="hljs-string"><span class="hljs-string">"body"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>: sent = _context.sent; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>: i++; _context.next = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"end"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _context.stop(); } } }, _callee, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); })); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyUserFriends</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_x</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _ref.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); }; }(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_asyncToGenerator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gen = fn.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">step</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key, arg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> info = gen[key](arg); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> value = info.value; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { reject(error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.done) { resolve(value); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.resolve(value).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) </span></span>{ step(<span class="hljs-string"><span class="hljs-string">"next"</span></span>, value); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ step(<span class="hljs-string"><span class="hljs-string">"throw"</span></span>, err); }); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> step(<span class="hljs-string"><span class="hljs-string">"next"</span></span>); }); }; }</code> </pre><br></div></div><br>  To be able to debug such code, you need to configure and use much of what is listed in <a href="https://habrahabr.ru/post/312022/">this article</a> . <br><br>  All this in itself requires nontrivial efforts.  In addition, Babel draws about 100 kb of the minified code "babel-polyfill", and the converted code works slowly (which is indirectly hinted at by the numerous constructions <i>case number_string</i> in the generated code). <br><br>  Looking at all this, I decided to write my bike - SynJS.  It allows you to write and synchronously execute code with callbacks: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myTestFunction1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">paramA,paramB</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res, i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (i &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) { setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ res = <span class="hljs-string"><span class="hljs-string">'i='</span></span> + i; SynJS.resume(_synjsContext); <span class="hljs-comment"><span class="hljs-comment">// &lt; ‚Äì-   ,    }, 1000); SynJS.wait(); // &lt; ‚Äì ,   console.log(res, new Date()); i++; } return "myTestFunction1 finished"; }</span></span></code> </pre> <br>  You can execute the function as follows: <br><br><pre> <code class="javascript hljs">SynJS.run(myTestFunction1,<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ret</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done all:'</span></span>, ret); });</code> </pre><br>  The result will be: <br><br><pre> <code class="hljs pgsql">i=<span class="hljs-number"><span class="hljs-number">0</span></span> Wed <span class="hljs-type"><span class="hljs-type">Dec</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">33</span></span> GMT<span class="hljs-number"><span class="hljs-number">-0700</span></span> (Mountain Standard <span class="hljs-type"><span class="hljs-type">Time</span></span>) i=<span class="hljs-number"><span class="hljs-number">1</span></span> Wed <span class="hljs-type"><span class="hljs-type">Dec</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span> GMT<span class="hljs-number"><span class="hljs-number">-0700</span></span> (Mountain Standard <span class="hljs-type"><span class="hljs-type">Time</span></span>) i=<span class="hljs-number"><span class="hljs-number">2</span></span> Wed <span class="hljs-type"><span class="hljs-type">Dec</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> GMT<span class="hljs-number"><span class="hljs-number">-0700</span></span> (Mountain Standard <span class="hljs-type"><span class="hljs-type">Time</span></span>) i=<span class="hljs-number"><span class="hljs-number">3</span></span> Wed <span class="hljs-type"><span class="hljs-type">Dec</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span> GMT<span class="hljs-number"><span class="hljs-number">-0700</span></span> (Mountain Standard <span class="hljs-type"><span class="hljs-type">Time</span></span>) i=<span class="hljs-number"><span class="hljs-number">4</span></span> Wed <span class="hljs-type"><span class="hljs-type">Dec</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span> GMT<span class="hljs-number"><span class="hljs-number">-0700</span></span> (Mountain Standard <span class="hljs-type"><span class="hljs-type">Time</span></span>)</code> </pre> <br>  Compared to Babel, he: <br><br><ul><li>  lighter (35kb without minimization), </li><li>  has no dependencies </li><li>  does not require compilation </li><li>  executes about 40 times faster (although this may not be so critical when working with slower functions). </li></ul><br>  SynJS takes a pointer to a function as a parameter, parses this function into individual operators (parses the nested operators recursively, if necessary), wraps them all in a function, and places these functions in a tree structure equivalent to the function code.  Then, an execution context is created in which local variables, parameters, current stack status, program counters, and other information needed to stop and continue execution are stored.  After that, the statements in the tree structure are executed one by one, using the context as the data store. <br><br>  The function can be performed via SynJS as follows: <br><br><pre> <code class="javascript hljs">SynJS.run(funcPtr,obj, param1, param2 [, more params],callback)</code> </pre> <br>  Options: <br><br>  - funcPtr: a pointer to the function to be executed synchronously <br>  - obj: an object that will be available in the function through this <br>  - param1, param2: parameters <br>  - callback: function to be executed upon completion <br><br>  In order to wait for the completion of the callback in SynJS, there is a SynJS.wait () operator that allows you to stop the execution of the function launched via SynJS.run ().  The operator can take 3 forms: <br><br>  - SynJS.wait () - stops execution until SynJS.resume () is called <br>  - SynJS.wait (number_of_milliseconds) - suspends execution for the time number_of_milliseconds <br>  - SynJS.wait (some_non_numeric_expr) - checks (!! some_non_numeric_expr), and stops the execution if false. <br><br>  With SynJS.wait, you can expect the completion of one or more callbacks: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cb1, cb2; setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ cb1 = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; SynJS.resume(_synjsContext); }, <span class="hljs-number"><span class="hljs-number">1000</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ cb2 = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; SynJS.resume(_synjsContext); }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); SynJS.wait(cb1 &amp;&amp; cb2);</code> </pre> <br>  To give a signal about the completion of the callback in the main thread, use the function <br><br>  SynJS.resume (context) <br><br>  The required <i>context</i> parameter contains a link to the execution context that needs to be notified (since each call to SynJS.run creates and runs a separate context, there can be several running contexts in the system at the same time). <br><br>  When parsing, SynJS wraps each statement into a function as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_synjsContext</span></span></span><span class="hljs-function">) </span></span>{ ...   ... }</code> </pre> <br>  Thus, the _synjsContext parameter in the callback code can be used to signal the completion: <br><br><pre> <code class="javascript hljs">SynJS.resume(_synjsContext);</code> </pre> <br><h4>  Handling local variables. </h4><br>  When parsing the body of a function, SynJS determines the declarations of local variables by the keyword var, and creates a hash for them in the execution context.  When wrapping a function, the operator code is modified, and all references to local variables are replaced with references to the hash in the execution context. <br><br>  For example, if the source statement in the function body looked like this: <pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, res; ... setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ res = <span class="hljs-string"><span class="hljs-string">'i='</span></span>+i; SynJS.resume(_synjsContext); },<span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre><br>  then the operator wrapped in the function will look like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_synjsContext</span></span></span><span class="hljs-function">) </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _synjsContext.localVars.res = <span class="hljs-string"><span class="hljs-string">'i='</span></span>+_synjsContext.localVars.i; SynJS.resume(_synjsContext); },<span class="hljs-number"><span class="hljs-number">1000</span></span>); }</code> </pre> <br>  <i>Some examples of using SynJS</i> <br><br>  1. <a href="http://stackoverflow.com/a/41490833/1464130">Select from the database an array of parent records, for each of them get a list of children</a> . <br><br>  2. According to the list of URLs, receive them one by one until the content of the URL satisfies the condition. <br><br><div class="spoiler">  <b class="spoiler_title">code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> SynJS = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'synjs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fetchUrl = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fetch'</span></span>).fetchUrl; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context,url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'fetching started:'</span></span>, url); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = {}; fetchUrl(url, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, meta, body</span></span></span><span class="hljs-function">)</span></span>{ result.done = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; result.body = body; result.finalUrl = meta.finalUrl; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'fetching finished:'</span></span>, url); SynJS.resume(context); } ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myFetches</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules, urls</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;urls.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = modules.fetch(_synjsContext, urls[i]); SynJS.wait(res.done); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(res.finalUrl.indexOf(<span class="hljs-string"><span class="hljs-string">'github'</span></span>)&gt;=<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'found correct one!'</span></span>, urls[i]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modules = { <span class="hljs-attr"><span class="hljs-attr">SynJS</span></span>: SynJS, <span class="hljs-attr"><span class="hljs-attr">fetch</span></span>: fetch, }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> urls = [ <span class="hljs-string"><span class="hljs-string">'http://www.google.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://www.yahoo.com'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://www.github.com'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// This is the valid one 'http://www.wikipedia.com' ]; SynJS.run(myFetches,null,modules,urls,function () { console.log('done'); });</span></span></code> </pre><br></div></div><br>  3. In the database, bypass all children, grandchildren, etc.  some parent. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> global.SynJS = global.SynJS || <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'synjs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mysql = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mysql'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection = mysql.createConnection({ <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-attr"><span class="hljs-attr">user</span></span> : <span class="hljs-string"><span class="hljs-string">'tracker'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span> : <span class="hljs-string"><span class="hljs-string">'tracker123'</span></span>, <span class="hljs-attr"><span class="hljs-attr">database</span></span> : <span class="hljs-string"><span class="hljs-string">'tracker'</span></span> }); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mysqlQueryWrapper</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules,context,query, params</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res={}; modules.connection.query(query,params,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, rows, fields</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; res.rows = rows; res.done = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; SynJS.resume(context); }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChildsWrapper</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules, context, doc_id, children</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res={}; SynJS.run(modules.getChilds,<span class="hljs-literal"><span class="hljs-literal">null</span></span>,modules,doc_id, children, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ret</span></span></span><span class="hljs-function">) </span></span>{ res.result = ret; res.done = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; SynJS.resume(context); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChilds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">modules, doc_id, children</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ret={}; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'processing getChilds:'</span></span>,doc_id,SynJS.states); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> docRec = modules.mysqlQueryWrapper(modules,_synjsContext,<span class="hljs-string"><span class="hljs-string">"select * from docs where id=?"</span></span>,[doc_id]); SynJS.wait(docRec.done); ret.curr = docRec.rows[<span class="hljs-number"><span class="hljs-number">0</span></span>]; ret.childs = []; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> docLinks = modules.mysqlQueryWrapper(modules,_synjsContext,<span class="hljs-string"><span class="hljs-string">"select * from doc_links where doc_id=?"</span></span>,[doc_id]); SynJS.wait(docLinks.done); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; docLinks.rows &amp;&amp; i &lt; docLinks.rows.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currDocId = docLinks.rows[i].child_id; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(currDocId) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'synjs run getChilds start'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> child = modules.getChildsWrapper(modules,_synjsContext,currDocId,children); SynJS.wait(child.done); children[child.result.curr.name] = child.result.curr.name; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modules = { <span class="hljs-attr"><span class="hljs-attr">SynJS</span></span>: SynJS, <span class="hljs-attr"><span class="hljs-attr">mysqlQueryWrapper</span></span>: mysqlQueryWrapper, <span class="hljs-attr"><span class="hljs-attr">connection</span></span>: connection, <span class="hljs-attr"><span class="hljs-attr">getChilds</span></span>: getChilds, <span class="hljs-attr"><span class="hljs-attr">getChildsWrapper</span></span>: getChildsWrapper, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> children={}; SynJS.run(getChilds,<span class="hljs-literal"><span class="hljs-literal">null</span></span>,modules,<span class="hljs-number"><span class="hljs-number">12</span></span>,children,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ret</span></span></span><span class="hljs-function">) </span></span>{ connection.end(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done'</span></span>,children); });</code> </pre><br></div></div><br>  At the moment I use SynJS to write browser tests in which I want to imitate complex user scripts (click "New", fill out a form, click "Save", wait, check what was written through the API, etc.) - SynJS allows you to reduce code, and most importantly, increase its clarity. <br><br>  I hope that someone will also find it useful until the bright future has come with async / await. <br><br>  ‚Üí <a href="https://github.com/amaksr/SynJS">Project on githaba</a> <br>  ‚Üí <a href="https://www.npmjs.com/package/synjs">NPM</a> <br><br>  <b>PS I</b> almost forgot, SynJS has an operator SynJS.goto ().  Why not? </div><p>Source: <a href="https://habr.com/ru/post/319094/">https://habr.com/ru/post/319094/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319082/index.html">Dual Wan and the features of the implementation of NetWatch in MikroTik</a></li>
<li><a href="../319084/index.html">Google‚Äôs promises started to come true - now https sites are marked as trusted</a></li>
<li><a href="../319086/index.html">From nuclear power plants to data centers: a new trend in the world of telecommunications</a></li>
<li><a href="../319088/index.html">Darken an image in CollapsingToolbarLayout or Image Scrim</a></li>
<li><a href="../319092/index.html">Lebab is like Babel, just the opposite</a></li>
<li><a href="../319096/index.html">About Z-order and R-tree</a></li>
<li><a href="../319100/index.html">Comparing objects by value - 6: Structure Equality Implementation</a></li>
<li><a href="../319104/index.html">3CX integration with amoCRM</a></li>
<li><a href="../319106/index.html">Is Nuklear the perfect GUI for micro projects?</a></li>
<li><a href="../319110/index.html">One Core API to edit Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>