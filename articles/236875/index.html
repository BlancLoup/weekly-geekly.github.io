<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django + API Vkontakte: post entries with attachments, get a list of groups and entries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, Habr! 

 Recently I developed a python / django site and I needed the ability to use the Vkontakte API. Namely: 

 ‚Ä¢ Posting articles from s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django + API Vkontakte: post entries with attachments, get a list of groups and entries</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/74c/9b4/30b/74c9b430b079495e8c99ab7260a1da84.png" alt="image"></div><br><br>  Good day, Habr! <br><br>  Recently I developed a python / django site and I needed the ability to use the Vkontakte API.  Namely: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ‚Ä¢ Posting articles from site to page in Vkontakte, as well as to selected groups (in which the administrator was a member); <br>  ‚Ä¢ The ability to attach documents and pictures to the records; <br>  ‚Ä¢ Getting a list of groups and records using the updated script and uploading all this to the django admin area. <br><br>  Actually, for the administrator, this functionality is managed through the admin area. <br><br>  I'll tell you step by step the implementation of this functionality. <br><a name="habracut"></a><br>  At the first stage, the administrator needs to create his application in "Vkontakte", and also get a token to work with the API.  To get a token, I use the VKAppAuth module ( <a href="https://github.com/speechkey/VKAppAuth">link</a> to GitHub, there is also an example of using the module). <br><br>  Settings for getting saved in a separate file and connect it to models.py.  In models.py I add fields for "Vkontakte" to the article model: <br><br><pre><code class="django hljs"><span class="xml"><span class="xml">photo_vk = models.ImageField(upload_to=photo_vk_path, verbose_name=u'   ', max_length = 1000, blank=True) file_vk = models.FileField(upload_to=files_vk_path, verbose_name=u'   ', max_length = 1000, blank=True) wall_user_vk = models.BooleanField(verbose_name=u'    ', default=False) group_vk = models.ManyToManyField(Vk_groups, verbose_name=u'    ', blank=True) group_stat = models.BooleanField(verbose_name=u'    ', default=False)</span></span></code> </pre> <br><br>  The group_vk field displays all Vkontakte groups from the Vk_groups table.  The code for the Vk_groups class in models.py: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml">class Vk_groups(models.Model): title = models.CharField(max_length=1000, verbose_name=u' ') gid = models.CharField(max_length=1000, verbose_name=u'ID ') is_closed = models.BooleanField(verbose_name=u' ', default=False) is_admin = models.BooleanField(verbose_name=u'  ', default=False) def __str__(self): return self.title.encode('utf8') class Meta: verbose_name = " " verbose_name_plural = " "</span></span></code> </pre><br><br>  Also created a model for records "Vkontakte".  They will be loaded using a script automatically updated on the server, so the admin panel will have actual entries from the admin page and from the groups in which it belongs. <br><br>  Model Fields: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml">class Vk_posts(models.Model): group = models.CharField(max_length=1000, verbose_name=u'/', blank=True) text = HTMLField(verbose_name=u' ', blank=True) date = models.DateTimeField(verbose_name=u' ', blank=True)</span></span></code> </pre><br><br>  For the article model, I redefined the save () method so that when you save any article, you access the Vkontakte API and send the record to Vkontakte, if the corresponding checkboxes are set. <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> def save(self, *args, **kwargs): use_vk(self) model = super(Page, self).save(*args, **kwargs)</span></span></code> </pre><br><br>  Before saving, the use_vk function is called, in which the API is accessed. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     photo_vk_path = 'photo_vk' files_vk_path = 'files_vk' def use_vk(self): #  msg = self.title + '\n' + self.text msg = re.sub('&lt;.*?&gt;','',msg) #  ,     post_vk = 0 #   groups = [g for g in self.group_vk.all()] if len(groups) or self.wall_user_vk: post_vk = 1 if post_vk: attachments = [] #   if self.photo_vk: server = vk.photos.getWallUploadServer(uid = my_id) path = MEDIA_ROOT + photo_vk_path + '/' + re.split('/', self.photo_vk.url)[-1] r = requests.post(server['upload_url'], files={'photo': open(path,"rb")}) params = {'server': r.json()['server'], 'photo': r.json()['photo'], 'hash': r.json()['hash']} wallphoto = vk.photos.saveWallPhoto(**params) attachments.append(wallphoto[0]['id']) #   if self.file_vk: server = vk.docs.getWallUploadServer() path = MEDIA_ROOT + files_vk_path + '/' + re.split('/', self.file_vk.url)[-1] r = requests.post(server['upload_url'], files={'file': open(path,"rb")}) params = {'file': r.json()['file']} doc = vk.docs.save(**params) attachments.append('doc' + str(my_id) + '_' + str(doc[0]['did'])) params = {'attachments': ','.join(attachments), 'message': msg} #      if self.wall_user_vk: params['owner_id'] = my_id vk.wall.post(**params) #      if len(groups): if self.group_stat: params['from_group'] = 1 for g in groups: params['owner_id'] = g.gid vk.wall.post(**params)</span></span></code> </pre><br><br>  It should be noted that the bootloader for photos and documents produced an incorrect path to files in folders by calling its url method (I do not rule out that it was me), so I myself composed the path to pictures and documents (path variable). <br><br>  More information about the stages of uploading a photo or document to an entry: <br><br>  a) Sending a request for the address of the server Vkontakte, where you can upload a photo or document; <br>  b) Getting the address of the server Vkontakte; <br>  c) Formation of a post-request to the server address with the loading of a document or photo on it; <br>  d) Upon successful upload, receiving a response with the identifier of the uploaded document or photo; <br>  e) Formation of a list of attributes for posting to Vkontakte, including the ID of a photo or document. <br><br>  After attaching a photo / document, the final API vk.wall.post (** params) method is used, which sends an entry to the administrator / group wall entry. <br><br>  To get a list of groups and save new records from groups and from the administrator's wall, a script is used that is automatically updated on the server at a specified time.  This script receives the django settings, imports the necessary models and the token receipt file to itself, and then, through the API, receives the administrator groups, records from the wall / from the groups, and updates the database tables: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time sys.path = [<span class="hljs-string"><span class="hljs-string">'C:/site/umc/'</span></span>] + sys.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.core.management <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> setup_environ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings setup_environ(settings) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> www.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vk_groups, Vk_posts <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> umc.vk_response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * count_posts = <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_posts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(owner_id, g_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""              Vk_posts"""</span></span> params = {<span class="hljs-string"><span class="hljs-string">'owner_id'</span></span>: owner_id, <span class="hljs-string"><span class="hljs-string">'count'</span></span>: count_posts} answer = vk.wall.get(**params) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(count_posts): params = { <span class="hljs-string"><span class="hljs-string">'group'</span></span>: g_name, <span class="hljs-string"><span class="hljs-string">'text'</span></span>: answer[i+<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'text'</span></span>], <span class="hljs-string"><span class="hljs-string">'date'</span></span>: time.strftime(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d %H:%M:%S+06:00"</span></span>, time.localtime(answer[i+<span class="hljs-number"><span class="hljs-number">1</span></span>][<span class="hljs-string"><span class="hljs-string">'date'</span></span>])) } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: Vk_posts.objects.get_or_create(**params) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: params[<span class="hljs-string"><span class="hljs-string">'text'</span></span>] = <span class="hljs-string"><span class="hljs-string">u'   '</span></span> Vk_posts.objects.get_or_create(**params) <span class="hljs-comment"><span class="hljs-comment">#     Vk_groups params = {'owner_id': my_id, 'extended': 1, 'filter': 'events, groups, admin'} answer = vk.groups.get(**params) for i in range(answer[0]): Vk_groups.objects.get_or_create(title = answer[i+1]['name'], gid = '-' + str(answer[i+1]['gid']), is_admin = answer[i+1]['is_admin'], is_closed = answer[i+1]['is_closed']) #       Vk_posts groups = Vk_groups.objects.all() for g in groups: get_posts(g.gid, g.title) #        Vk_posts user = vk.users.get(uid = my_id) get_posts(my_id, user[0]['first_name']+ ' ' + user[0]['last_name'])</span></span></code> </pre><br><br>  Actually, now you can try to send records from the admin to the wall or any group (if the access rights allow you to place the records on the group wall), and check the work. <br><br>  Hope the article was helpful. <br>  Link to the project: <a href="https://github.com/julia-bikova/DjangoVkPosting">github.com/julia-bikova/DjangoVkPosting</a> <br><br>  Enjoy your work with Django! </div><p>Source: <a href="https://habr.com/ru/post/236875/">https://habr.com/ru/post/236875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236863/index.html">Parable about programmers and coders</a></li>
<li><a href="../236865/index.html">Website development (web applications) in C ++ (and not only) in the form of link libraries (* .so, * .dll)</a></li>
<li><a href="../236867/index.html">How Om Nom from Cut the Rope 2 moved to Amazon Fire Phone</a></li>
<li><a href="../236871/index.html">HP Unified Wired and Wireless Access</a></li>
<li><a href="../236873/index.html">A battery-free pacemaker works like a clock</a></li>
<li><a href="../236877/index.html">Discussion of the prohibition of Bitcoin in Russia continues and goes to a new level</a></li>
<li><a href="../236879/index.html">How not to do federal information systems</a></li>
<li><a href="../236881/index.html">An open letter from Autodesk CIS CEO to Russian customers and partners</a></li>
<li><a href="../236883/index.html">Why small technology companies have stopped going IPO</a></li>
<li><a href="../236885/index.html">The first intermediate results of the competition Android-developers Moverio Apps Market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>