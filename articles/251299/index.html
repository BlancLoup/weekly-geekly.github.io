<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lamp showing the weather forecast</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many of us, before leaving the house in the morning, check the weather forecast for the day ahead. I always used my smartphone for this and, one day, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lamp showing the weather forecast</h1><div class="post__text post__text-html js-mediator-article">  Many of us, before leaving the house in the morning, check the weather forecast for the day ahead.  I always used my smartphone for this and, one day, I thought, why not make this process more simple and convenient.  So, I came up with the idea of ‚Äã‚Äãcreating a room lamp that would be able to show the weather forecast in my area, as well as warn about possible precipitation and wind speed. <br><br><img src="https://habrastorage.org/files/1c8/a5a/8a9/1c8a5a8a9c09477b8c09655e48f07e44.jpg"><br><br>  Under the cut video and images showing the work of this lamp and detailed instructions for creating it. <br><a name="habracut"></a><br><h2>  Demonstration of work </h2><br>  The lamp can show the weather forecast for 14 hours ahead.  Technically, inside the lamp there are 14 horizontal levels (RGB LED strips of 20 LEDs each).  The first level below is the weather that will be at the beginning of the next hour.  Each next level is plus 1 hour.  Horizontal movement at each level is the wind speed.  There is also a rain effect - parts flashing smoothly with all colors at the beginning and end of each level. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here it should be warned that all the photos and videos in this article were taken by long torment, since the lamp shines very much, and I am not a very experienced photographer and my DSLR just did not want to shoot how it really is.  I honestly tried so many times but did not achieve the same picture as in reality. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/IOq3F_2ylqA%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700190,15700253&amp;usg=ALkJrhg5uUR5MeDbw3YxY4v7hAgfhLsvoQ" frameborder="0" allowfullscreen=""></iframe><br><br>  You can also watch a <a href="https://www.youtube.com/watch%3Fv%3DZgb83-r9nsQ">video of the lamp operation without a cover</a> and a <a href="https://www.youtube.com/watch%3Fv%3D7Y2U9VxDY3c">video demonstrating the display of precipitation</a> (the edges of the stripes glowing in all colors). <br><br><h3>  Requirements and design </h3><br>  To begin with, let's try to formulate the requirements: <br><br><ul><li>  Permanent internet connection.  We will need to receive a weather forecast from the Internet. </li><li>  Autonomy.  The lamp should not depend on other devices. </li><li>  Ability to display various weather data (temperature, rain, thunder, wind) </li></ul><br>  After some thought, I decided to stop at a rectangular lamp in which there will be 12 horizontal levels with 20 LEDs in each.  This will allow us to display the weather forecast 12 hours ahead.  The color of each level depends on the air temperature at that time.  In this case, each level will have a sufficient number of LEDs to display various effects, such as rain, wind or thunder.  Already then the number of levels was increased to 14, as there were extra LEDs. <br><br><h3>  Iron </h3><br>  First of all, it is necessary to determine the platform: a real-time microcontroller such as an Arduino or a full-fledged computer, such as the Raspberry Pi with an operating system on board.  Each of these options has its pros and cons.  At first glance, the Arduino is ideal for this project, if only because we don‚Äôt have to wait 10 seconds for the OS to load on the Raspberry Pi.  But even if you use Arduino, an instant cold start will not work - there will still be a delay in the initialization of the wifi shield and the weather request on the server.  I was also a little confused by the question about the simultaneous operation of wifi shild (at the time of requesting a forecast to the server) and the operation of the LED strip. <br><br>  In turn, if you use the Raspberry Pi, we have only one drawback - load time. <br><br>  It was decided to use the Raspberry Pi with the WiFi USB dongle EdiMax.  This dongle was used by me on other projects and proved itself quite well. <br><br>  Next you need to find the appropriate light sources.  In rough estimate, the minimum we need is about 240 LEDs (12 levels of 20 LEDs each).  The option in which they all have to be soldered one by one has not even been considered.  Our choice is not big: either LED panels or LED strip.  The panels are perfect for those who want a lamp that is not larger in size without different curvatures on the surface.  I stopped at the LED tape, because I wanted to make a lamp of medium size. <br><br>  Thus, an RGB LED strip of 2 meters with a pixel density of 144 pieces per meter was ordered.  This tape has address LEDs (digitally-addressable type of LED strip), which means that we can form a signal in such a way that each LED will receive its data and display the color it should.  For this is responsible WS2811 chip, which is located in each LED on the tape.  Since there are 288 LEDs in total in the ribbon, it was decided to use them to the maximum and make 14 levels with 20 LEDs) <br><br>  It should be noted that the Raspberry Pi delivers only 3.3 volts on its GPIO ports, but for the tape we need a control signal of 5 volts.  Thus, we need a voltage converter (level converter chip).  I used 74AHCT125. <br><br>  Connection diagram (was taken from <a href="https://learn.adafruit.com/neopixels-on-raspberry-pi">Adafruit Tutorial</a> ): <br><br><img src="https://habrastorage.org/files/10d/463/3a6/10d4633a6ae04693b1978b06042119ab.png"><br><br>  In the nearest shop, a donor lamp with dimensions of 60 by 20 cm was looked after and purchased. The lamp was bought with the expectation that we would need to place a power supply unit for the LED strip there.  Since we got 280 RGB + Raspberry Pi LEDs, a 5 volt 10 amp unit was ordered in a fairly compact package. <br><br>  It was the turn to place all this in the lamp.  With the power supply, the Raspberry Pi, everything was clear.  What can not be said about how to fix the 14 segments with LEDs, which previously had to be soldered to each other.  The LEDs would have to be at a certain distance from the matte cover, otherwise they would be visible and the light would be too harsh. <br><br>  The original idea was to use aluminum strips and already stick pieces of tape to them.  But having made one frame, I quickly realized that it would take too much time.  After that I decided to print frames on a 3D printer.  If you have access to a laser engraver, you will make it even faster.  In the extreme case, you can do everything with your hands - cut out of wood or cardboard (after it is repeatedly gluing the layers). <br><br>  Frame printing: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/y4oduAgaqvs%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700190,15700253&amp;usg=ALkJrhikkjiwoVa-JAuE_aY5-OVG4b47Cw" frameborder="0" allowfullscreen=""></iframe><br><br>  The first tests of the tape on the framework: <br><br><img src="https://habrastorage.org/files/410/043/016/4100430166354e37af56dc5cf3fc979b.JPG"><br><br>  So we got all the necessary components and it was the turn of the assembly.  The LED strip was cut into pieces of 20 LEDs.  The pieces were soldered to each other and glued to the frames.  Frames, in turn, were glued to the body.  The power supply, all wiring and Raspberry Pi were placed in the space between the frames and the case. <br><br>  Lamp assembly process: <br><br><img src="https://habrastorage.org/files/186/070/f1f/186070f1f878404a83fee8685509c415.JPG"><br><br>  Result ( <a href="">In higher resolution</a> ): <br><br><img src="https://habrastorage.org/files/218/e00/af0/218e00af048146a682499188626bacd9.jpg"><br><br><h2>  Service for weather forecasting </h2><br>  The lamp requires a service to get a weather forecast.  There is a large number of free and shareware services for this.  For example <a href="http://openweathermap.org/api">openweathermap.org</a> or <a href="https://developer.forecast.io/">forecast.io</a> .  All of them have their limitations or certain specific features. <br><br>  One of my main criteria was the ability to get an hourly weather forecast for the next 12+ hours.  Unfortunately, openweathermap can only return the weather forecast for 3 hours in free mode.  I also did not like the speed of this service, although it was not at all critical given that we are going to update the weather forecast no more than once every half hour. <br><br>  At the same time, the not quite free forecast. I was pleased with the speed and detail of the data.  He allowed to receive in one request all the data that I needed (temperature, wind speed and precipitation) for 12 hours ahead and even more.  The number of requests that you can make is limited to 1000 per day in a free mode, but this is well within my requirements.  In the end, I chose this resource, to be honest, just relying on my intuition. <br><br>  We had to decide how we would receive the data: through an intermediate resource or directly from forecast.io.  The JSON file that returned the forecast.io service weighed about 40 kilobytes for my location, which seemed redundant to me.  I needed only 3 values ‚Äã‚Äãfor each of 12 hours.  In the end, I decided to create my own small service for 2 reasons - to minimize the amount of data sent to the lamp and ensure future extensibility if I have to change the source of data in the future or change the provider.  Considering the fact that we need only 3 values ‚Äã‚Äã(temperature, wind speed and amount of precipitation) for each hour, we need to transmit 168 bytes (14 * 3 * int = 4).  Also, my service will allow you to set the coordinates of the terrain and the values ‚Äã‚Äãof the minimum and maximum temperatures for a given terrain, to avoid storing this information on the Raspberry Pi side. <br><br>  I wrote a Java servlet for working with forecast.io, which can cache values ‚Äã‚Äãbetween requests and returns requests from the cache in case of too frequent requests (in order not to exceed the limit of 1000 free requests per day).  We only request a new forecast once every 5 minutes.  The coordinates of the location as well as the API key for forecast.io the servlet takes from the system properties, so if we need to change the area, we can do it from outside the web application. <br><br><div class="spoiler">  <b class="spoiler_title">Servlet code</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ForecastServlet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HttpServlet</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String API_KEY = System.getenv(<span class="hljs-string"><span class="hljs-string">"AL_API_KEY"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> REQUEST_PERIOD = <span class="hljs-number"><span class="hljs-number">5</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> START_HOUR = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> END_HOUR = <span class="hljs-number"><span class="hljs-number">14</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DATA_SIZE = <span class="hljs-number"><span class="hljs-number">3</span></span> * <span class="hljs-number"><span class="hljs-number">4</span></span> * (END_HOUR - START_HOUR); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TEMP_MULTIPLY = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> WIND_MULTIPLY = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PRECIP_MULTIPLY = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String mutex = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ByteArrayOutputStream data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(DATA_SIZE); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastRequestTime; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpServletRequest req, HttpServletResponse response)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ServletException, IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (mutex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((System.currentTimeMillis() - lastRequestTime) &gt; REQUEST_PERIOD) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { updateForecast(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { e.printStackTrace(); } } response.setHeader(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/octet-stream"</span></span>); response.setHeader(<span class="hljs-string"><span class="hljs-string">"Content-Length"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span> + data.size()); response.getOutputStream().write(data.toByteArray()); response.getOutputStream().flush(); response.getOutputStream().close(); lastRequestTime = System.currentTimeMillis(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateForecast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxTemp = Integer.valueOf(System.getenv(<span class="hljs-string"><span class="hljs-string">"AL_MAX_TEMP"</span></span>)) * TEMP_MULTIPLY; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> minTemp = Integer.valueOf(System.getenv(<span class="hljs-string"><span class="hljs-string">"AL_MIN_TEMP"</span></span>)) * TEMP_MULTIPLY; BufferedReader reader = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { String urlTemplate = <span class="hljs-string"><span class="hljs-string">"https://api.forecast.io/forecast/%s/%s,%s"</span></span>; URL url = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(String.format(urlTemplate, API_KEY, System.getenv(<span class="hljs-string"><span class="hljs-string">"AL_LAT"</span></span>), System.getenv(<span class="hljs-string"><span class="hljs-string">"AL_LON"</span></span>))); InputStreamReader streamReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(url.openStream()); reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedReader(streamReader); JSONParser jsonParser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONParser(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { JSONObject jsonObject = (JSONObject) jsonParser.parse(reader); JSONArray hourly = (JSONArray) ((JSONObject) jsonObject.get(<span class="hljs-string"><span class="hljs-string">"hourly"</span></span>)).get(<span class="hljs-string"><span class="hljs-string">"data"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = START_HOUR; i &lt; END_HOUR; i++) { JSONObject hour = (JSONObject) hourly.get(i); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> temperature = safeIntFromJson(hour, <span class="hljs-string"><span class="hljs-string">"apparentTemperature"</span></span>, TEMP_MULTIPLY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temperature &gt; maxTemp) { temperature = maxTemp; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (temperature &lt; minTemp) { temperature = minTemp; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> tempFloat = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) <span class="hljs-number"><span class="hljs-number">100</span></span> / (maxTemp - minTemp) * (temperature - minTemp); temperature = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (tempFloat * TEMP_MULTIPLY); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> wind = safeIntFromJson(hour, <span class="hljs-string"><span class="hljs-string">"windSpeed"</span></span>, WIND_MULTIPLY); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> precip = safeIntFromJson(hour, <span class="hljs-string"><span class="hljs-string">"precipIntensity"</span></span>, PRECIP_MULTIPLY); data.write(intToBytes(temperature)); data.write(intToBytes(wind)); data.write(intToBytes(precip)); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ParseException e) { e.printStackTrace(); } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) reader.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException ioe) { ioe.printStackTrace(); } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] intToBytes(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ByteBuffer.allocate(<span class="hljs-number"><span class="hljs-number">4</span></span>).putInt(value).array(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">safeIntFromJson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> JSONObject data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String dataKey, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> multiply)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ Object jsonAttrValue = data.get(dataKey); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (jsonAttrValue <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Long) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ((Long) jsonAttrValue * multiply); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ((Double) jsonAttrValue * multiply); } } }</code> </pre> </div></div><br>  It is necessary to clarify what 5 properties mean, the values ‚Äã‚Äãof which we request in runtime: <br><br>  AL_API_KEY - Developer‚Äôs secret key forecast.io <br>  AL_LAT, AL_LON - Coordinates <br>  AL_MAX_TEMP, AL_MIN_TEMP - Values ‚Äã‚Äãof the minimum and maximum temperatures for a given area.  This is necessary not to waste some areas in the used color range: let's say in my area (Texas, USA) - the temperature never drops below zero, and I would like the purple color (the lowest one in our palette) to be 0 and not -25, as could be set for Moscow.  Thus, our service does not return real temperature - it returns one hundredth percent between AL_MIN_TEMP &amp; AL_MAX_TEMP. <br><br>  The source code of the web application along with the maven assembly file is available in the <a href="https://github.com/manusovich/aladdin-service">github.com/manusovich/aladdin-service</a> repository. <br><br>  Next we need any hosting for our Java web application.  I used my favorite <a href="https://heroku.com/">heroku</a> , but you can use any other.  The repository already contains the file needed to run the application in the heroku environment called Procfile. <br><br>  So, if we use heroku, all we need to do is: <br><br><ul><li>  Create New Application </li><li>  Identify 3 new system properties </li><li>  Link it to our git repository </li><li>  Deploy the application.  To do this, you must perform Manual Deploy, with all the code will be automatically downloaded from the github repository, compiled and run </li></ul><br>  Now our servlet can be executed by opening the <a href="https://aladdin-service.herokuapp.com/forecast">https://aladdin-service.herokuapp.com/forecast</a> link in the browser.  This will return a file with the weather forecast (168 bytes in size) for the specified location (property for the heroku application) <br><br><h2>  Software on the lamp side </h2><br>  First of all, it is necessary to decide how we will send a signal to our LED strip.  The tape uses a WS2811 chip to control the LED.  After a brief search, I came across a tutorial from Adafruit - <a href="https://learn.adafruit.com/neopixels-on-raspberry-pi">learn.adafruit.com/neopixels-on-raspberry-pi</a> , where I found reference to the <a href="https://github.com/jgarff/rpi_ws281x">rpi_ws281x</a> library, which just allows you to generate a signal for a tape based on WS281x chips. <br><br>  I fork the library into my <a href="https://github.com/manusovich/rpi_ws281x">repository</a> and added the necessary code to main.c (see below in the lamp controller section) to simplify development to a minimum. <br><br>  It is necessary to make a small digression and tell how I usually develop code for my projects based on Raspberry Pi.  I found editing code through ssh completely uncomfortable.  Copy code permanently via ssh too.  So I just create a GitHub repository, upload all the code there and use my favorite IDE for development.  On the Raspberry Pi side, I create a shell script, which every 10 seconds tries to get changes from the repository.  If they are, the script stops the program execution, downloads updates, compiles everything and starts the program.  The script is hung up on autoload.  This allows you to develop code remotely and at the same time speeds up the process of checking changes on the device.  But at the same time loads the wifi network.  When software development is complete, I make the update period longer ‚Äî for example, 60 minutes and leave it forever in this state. <br><br>  The algorithm thus turns out the following: <br><br><ul><li>  Request changes to git </li><li>  If there is a change in reproduction, then <br><ul><li>  Update code </li><li>  Compile code </li><li>  If the compilation was successful then <br><ul><li>  Stop running application </li><li>  Launch New Application </li></ul></li></ul></li></ul><br><h3>  Configure RaspberryPi </h3><br><ul><li>  First you need to configure Wifi </li><li>  After that we need to clone the repository to the / home / pi / rpi_ws281x directory (run in the / home / pi directory): <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/manusovich/rpi_ws281x</code> </pre> <br>  Shell script <a href="">/home/pi/rpi_ws281x/forecast.sh</a> should be added to startup /etc/rc.local: <br><br><pre> <code class="bash hljs">sudo sh /home/pi/rpi_ws281x/forecast.sh &gt;&gt; /home/pi/ws281.log &amp;</code> </pre> </li></ul><br>  This script updates the forecast, launches the application, as well as in the background, updates the weather forecast every 10 minutes and every 60 minutes checks the project repository for changes.  If there are changes, they are taken from the repository, compiled and run. <br><br><div class="spoiler">  <b class="spoiler_title">Script code</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo "Read forecast" curl https://aladdin-service.herokuapp.com/forecast &gt; /home/pi/rpi_ws281x/forecast echo "Kill old instance..." pkill test echo "Run new instance..." exec /home/pi/rpi_ws281x/test &amp; echo "Start pooling for changes" C=0 while true; do C=$((C+1)) # once per 10 minutes if [ $((C%60)) -eq 0 ] then echo "Update forecast... " curl https://aladdin-service.herokuapp.com/forecast &gt; /home/pi/rpi_ws281x/forecast fi # once per one hour if [ $((C%360)) -eq 0 ] then echo "Check repository... " cd /home/pi/rpi_ws281x git fetch &gt; build_log.txt 2&gt;&amp;1 if [ -s build_log.txt ] then echo "Application code has been changed. Getting changes..." cd /home/pi/rpi_ws281x git pull echo "Bulding application..." scons echo "Kill old application..." pkill test echo "Launch new application..." exec /home/pi/rpi_ws281x/test &amp; echo "Done" else echo "No changes in the repository ($N)" fi fi sleep 10s done</span></span></code> </pre></div></div><br>  Some points should be clarified: <br><br><ol><li>  Absolute paths - this script will be run from autorun and we need to specify all paths.  Thus, it turns out that on the Raspberry Pi our repository should be cloned into the / home / pi / rpi_ws281x directory.  If you have another way, you will need to update this shell script. </li><li>  This script must be run as administrator, as the ribbon control code uses direct memory access and must be run as administrator. </li></ol><br><h2>  Lamp controller </h2><br>  Now let's look at the LED control code on the LED strip.  This code is in the <a href="">main.c</a> file and is an infinite loop and a set of procedures for changing the color of the LEDs. <br><br>  The main program method contains the library's initialization of the rpi_ws281x library for working with LED tape and starts an infinite loop on the drawing of states: <br><br><div class="spoiler">  <b class="spoiler_title">Main method code</b> <div class="spoiler_text"><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *argv[])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> frames_per_second = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = <span class="hljs-number"><span class="hljs-number">0</span></span>; setup_handlers(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ws2811_init(&amp;ledstring)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> c = <span class="hljs-number"><span class="hljs-number">0</span></span>; update_forecast(); matrix_render_forecast(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { matrix_fade(); matrix_render_wind(); matrix_render_precip(c); matrix_render(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ws2811_render(&amp;ledstring)) { ret = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } usleep((<span class="hljs-keyword"><span class="hljs-keyword">useconds_t</span></span>) (<span class="hljs-number"><span class="hljs-number">1000000</span></span> / frames_per_second)); c++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c % (frames_per_second * <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">5</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// each 5 minutes update forecast update_forecast(); } } ws2811_fini(&amp;ledstring); return ret; }</span></span></code> </pre></div></div><br>  The update_forecast method reads the current weather forecast from the file / home / pi / rpi_ws281x / forecast <br><br>  The matrix_render_forecast method fills in the matrix with the current values ‚Äã‚Äãof the weather forecast.  In this case, we use a palette of 23 colors taken from the site <a href="http://paletton.com/">paletton.com</a> : <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">ws2811_led_t</span></span> dotcolors[] = { <span class="hljs-number"><span class="hljs-number">0x882D61</span></span>, <span class="hljs-number"><span class="hljs-number">0x6F256F</span></span>, <span class="hljs-number"><span class="hljs-number">0x582A72</span></span>, <span class="hljs-number"><span class="hljs-number">0x4B2D73</span></span>, <span class="hljs-number"><span class="hljs-number">0x403075</span></span>, <span class="hljs-number"><span class="hljs-number">0x343477</span></span>, <span class="hljs-number"><span class="hljs-number">0x2E4272</span></span>, <span class="hljs-number"><span class="hljs-number">0x29506D</span></span>, <span class="hljs-number"><span class="hljs-number">0x226666</span></span>, <span class="hljs-number"><span class="hljs-number">0x277553</span></span>, <span class="hljs-number"><span class="hljs-number">0x2D882D</span></span>, <span class="hljs-number"><span class="hljs-number">0x609732</span></span>, <span class="hljs-number"><span class="hljs-number">0x7B9F35</span></span>, <span class="hljs-number"><span class="hljs-number">0x91A437</span></span>, <span class="hljs-number"><span class="hljs-number">0xAAAA39</span></span>, <span class="hljs-number"><span class="hljs-number">0xAAA039</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA9739</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA8E39</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA8439</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA7939</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA6C39</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA5939</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA3939</span></span> };</code> </pre><br>  The matrix_fade method suppresses any color variations from the predicted temperature. <br><br>  The matrix_render_wind method draws excitement that moves horizontally back and forth at a speed that is equal to wind speed * per coefficient. <br><br>  The matrix_render_precip method draws precipitations along the edges of levels.  He needs a total counter, since the total update rate is 30 frames per second and this turned out to be very fast in order to change colors.  Therefore, we do this only 15 times per second. <br><br>  All rendering goes to the XRGB matrix [WIDTH] [HEIGHT].  We need the XRGB structure to store floating point numbers instead of integer colors.  This allows us to increase the smoothness of transitions and directly convert to RGB in the matrix_render method. <br><br>  When launched, the program displays the current forecast value (temperature, wind and precipitation) to the console.  It should be noted that the temperature value is a base point (one hundredth of a percent). <br><br><pre> <code class="bash hljs">pi@raspberrypi ~/rpi_ws281x $ sudo ./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> Temp: 5978, Wind: 953, Precip: 0 Temp: 5847, Wind: 1099, Precip: 0 Temp: 5744, Wind: 1157, Precip: 0 Temp: 5657, Wind: 1267, Precip: 0 Temp: 5612, Wind: 1249, Precip: 1 Temp: 5534, Wind: 1357, Precip: 1 Temp: 5548, Wind: 1359, Precip: 0 Temp: 5605, Wind: 1378, Precip: 0 Temp: 5617, Wind: 1319, Precip: 0 Temp: 5597, Wind: 1281, Precip: 0 Temp: 5644, Wind: 1246, Precip: 0 Temp: 5667, Wind: 1277, Precip: 0</code> </pre><br><h2>  Alternative modes of operation </h2><br>  You can consider the resulting product as a platform to display anything.  At your disposal there are about 300 independent LEDs and you decide what can be displayed there.  For example, you can organize the display of assembly states on the continuous integration server or simply make an unusual lamp that will play with the colors of the rainbow like in the next video. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/93qKPvEVcRE%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700190,15700253&amp;usg=ALkJrhj9ZxqA3JiQpumFbpadmDsQ2Y40jw" frameborder="0" allowfullscreen=""></iframe><br><br><h2>  Estimate and conclusion </h2><br>  Power supply 5 volts 10 amps - $ 25 <br>  2 meters of RGB tape (144 LEDs per meter) - $ 78 <br>  Raspberry Pi - $ 30 <br>  Edimax Wifi USB - $ 8 <br>  3D printing of frames for LED strip - $ 15 for PLA plastic <br>  Lamp donor - $ 35 <br><br>  In total, the total cost of the product turned out to be about $ 200 for home manufacturing. <br>  I hope this article will be useful to you.  If you have any questions, feel free to ask in the comments. </div><p>Source: <a href="https://habr.com/ru/post/251299/">https://habr.com/ru/post/251299/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251289/index.html">Corporate and unincorporated IaaS: how not to get lost in the cloud market</a></li>
<li><a href="../251291/index.html">Data Owners - Thoughts on, Pros and Cons</a></li>
<li><a href="../251293/index.html">What bugs did LibreOffce find in PVS-Studio?</a></li>
<li><a href="../251295/index.html">Data compression methods</a></li>
<li><a href="../251297/index.html">Ekspozzer - creating a panorama from a video, averaging a video stream</a></li>
<li><a href="../251301/index.html">Administration of computers on the local network before loading the operating system</a></li>
<li><a href="../251303/index.html">16 months of functional programming</a></li>
<li><a href="../251307/index.html">node-seq in a new way (again about asynchrony)</a></li>
<li><a href="../251309/index.html">IBM invites to the ‚ÄúSoftlayer Introduction‚Äù webinar</a></li>
<li><a href="../251311/index.html">Implementation of the universal aquarium controller</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>