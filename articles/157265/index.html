<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Control flow abstraction</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Any programmer, even if he does not look at his work in this way, is constantly engaged in building abstractions. Most often, we abstract calculations...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Control flow abstraction</h1><div class="post__text post__text-html js-mediator-article">  Any programmer, even if he does not look at his work in this way, is constantly engaged in building abstractions.  Most often, we abstract calculations (write functions) or behavior (procedures and classes), but apart from these two cases, there are many repetitive patterns in our work, especially when handling errors, managing resources, writing standard handlers and optimizations. <br><br>  What does abstraction of control flow or ‚Äúcontrol flow‚Äù mean, as our overseas friends put it?  In the case when no one shows off, the flow of control structures involved.  Sometimes these control structures are not enough and we add our own, abstracting the behavior of the program we need.  This is easy in languages ‚Äã‚Äãlike lisp, ruby ‚Äã‚Äãor perl, but in other languages ‚Äã‚Äãthis is possible, for example, using higher order functions. <a name="habracut"></a><br><br><h4>  Abstractions </h4><br>  Start over.  What needs to be done to build a new abstraction? <br><ol><li>  Select a piece of functionality or behavior. </li><li>  Give him a name. </li><li>  Implement it. </li><li>  Hide implementation behind the selected name. </li></ol><br>  I must say that the third point is not always fulfilled.  The ability to implement depends heavily on the flexibility of the language and on what you are abstracting. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What if your language is not flexible enough?  It's okay, instead of implementation, you can simply describe your technique in detail, make it popular and, thus, generate a new ‚Äúdesign pattern‚Äù.  Or simply switch to a more powerful language, if creating patterns does not tempt you. <br><br>  But enough theory, let's do business ... <br><br><h4>  Life example </h4><br>  The usual code on python (taken from a real project with minimal changes): <br><br><pre><code class="python hljs">urls = ... photos = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> url <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> urls: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attempt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(DOWNLOAD_TRIES): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: photos.append(download_image(url)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ImageTooSmall: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-comment"><span class="hljs-comment">#     except (urllib2.URLError, httplib.BadStatusLine, socket.error), e: if attempt + 1 == DOWNLOAD_TRIES: raise</span></span></code> </pre> <br>  This code has many aspects: iterating through the url list, downloading images, collecting downloaded images in photos, skipping small images, and repeated download attempts when network errors occur.  All these aspects are confused in a single piece of code, although many of them would be useful in their own right, if only we could isolate them. <br><br>  In particular, the iteration + collection of results is implemented in the built-in <code>map</code> function: <br><br><pre> <code class="python hljs">photos = map(download_image, urls)</code> </pre><br>  Let's try to catch the other aspects.  Let's start with skipping small images, it could look like this: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@contextmanager def skip(error): try: yield except error: pass for url in urls: with skip(ImageTooSmall): photos.append(download_image(url))</span></span></code> </pre><br>  Not bad, but there is a drawback - I had to abandon the use of the <code>map</code> .  Let's leave this problem for now and move on to the aspect of resistance to network errors.  Similarly, the previous abstraction could be written: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> retry(DOWNLOAD_TRIES, (urllib2.URLError, httplib.BadStatusLine, socket.error)): <span class="hljs-comment"><span class="hljs-comment"># ... do stuff</span></span></code> </pre><br>  Only it will not work, <code>with</code> in python cannot execute its block of code more than once.  We have stumbled upon the limitations of the language and now have to either minimize and use alternative solutions, or generate another ‚Äúpattern‚Äù.  Noticing such situations is important if you want to understand the differences in languages, and than one can be more powerful than the other, despite the fact that they are all turing.  In ruby ‚Äã‚Äãand with less convenience in perl we could continue to manipulate the blocks, in the Lisp - blocks or code (the latter in this case, apparently, to nothing), in the python we have to use an alternative option. <br><br>  Let us return to the functions of a higher order, or rather to their special variety - decorators: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@decorator def retry(call, tries, errors=Exception): for attempt in range(tries): try: return call() except errors: if attempt + 1 == tries: raise http_retry = retry(DOWNLOAD_TRIES, (urllib2.URLError, httplib.BadStatusLine, socket.error)) harder_download_image = http_retry(download_image) photos = map(harder_download_image, urls)</span></span></code> </pre><br>  As we can see, this approach fits well with the use of <code>map</code> , we also got a couple of things that we will someday come in handy - <code>retry</code> and <code>http_retry</code> . <br><br>  Rewrite <code>skip</code> in the same style: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@decorator def skip(call, errors=Exception): try: return call() except errors: return None skip_small = skip(ImageTooSmall) http_retry = retry(DOWNLOAD_TRIES, (urllib2.URLError, httplib.BadStatusLine, socket.error)) download = http_retry(skip_small(download_image)) photos = filter(None, map(download, urls))</span></span></code> </pre><br>  <code>filter</code> needed to skip the dropped pictures.  In fact, the <code>filter(None, map(f, seq))</code> pattern <code>filter(None, map(f, seq))</code> so common that in some languages ‚Äã‚Äãthere is a <a href="http://clojuredocs.org/clojure_core/clojure.core/keep">built-in function for such a case</a> . <br><br>  We can also implement this: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">keep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(f, seq)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> filter(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, map(f, seq)) photos = keep(download, urls)</code> </pre><br>  What is the result?  Now all aspects of our code are visible, easily distinguishable, changeable, replaceable and removable.  And as a bonus, we received a set of abstractions that can be used in the future.  And also, I hope, I made someone see a new way to make my code better. <br><br>  <b>PS</b> The implementation of <code>@decorator</code> can be taken <a href="https://github.com/Suor/funcy/blob/master/funcy/decorators.py">here</a> . <br><br>  <b>PPS</b> Other examples of abstraction of control flow: <a href="http://underscorejs.org/">manipulations with functions in underscore.js</a> , list and generator expressions, <a href="https://github.com/Suor/overload">function overloading</a> , caching wrappers for functions, and much more. <br><br>  <b>PPPS</b> Seriously, you need to come up with a better translation for the expression ‚Äúcontrol flow‚Äù. </div><p>Source: <a href="https://habr.com/ru/post/157265/">https://habr.com/ru/post/157265/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157253/index.html">The network posted a dump Android 4.2 c Nexus 4</a></li>
<li><a href="../157255/index.html">Library for authorization through Habrahabr</a></li>
<li><a href="../157257/index.html">Microsoft is testing its own smartphone</a></li>
<li><a href="../157259/index.html">Test suite to help a freelancer survive on Elance.com</a></li>
<li><a href="../157263/index.html">Ocean robot Mercury withstood the onslaught of Hurricane Sandy</a></li>
<li><a href="../157267/index.html">Entity Framework 6 - ALPHA</a></li>
<li><a href="../157271/index.html">What caused general dissatisfaction with the state of innovation?</a></li>
<li><a href="../157273/index.html">Java.util.concurrent. * Overview</a></li>
<li><a href="../157275/index.html">Minix NEO G4 - a miniature PC with a dual-core processor for 76 $.</a></li>
<li><a href="../157279/index.html">A selection of tools for creating web interfaces in the style of Metro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>