<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Log Log Monitoring: Such a Vulnerable Log or How to Put a Pig On to Colleagues</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Monitoring or analyzing logs, whether it concerns security topics, load analysis, or creating statistics and analytics for a sales person or feeding a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Log Log Monitoring: Such a Vulnerable Log or How to Put a Pig On to Colleagues</h1><div class="post__text post__text-html js-mediator-article"><p>  Monitoring or analyzing logs, whether it concerns security topics, load analysis, or creating statistics and analytics for a sales person or feeding a neural network, is often associated with many problems. </p><br><p>  Unfortunately, this is often associated with the human factor, namely, with the unwillingness or misunderstanding of some simple rather many things by many program developers, APIs and services that log the same information needed for monitoring. <br>  Below is exactly how it is often done and why it is impossible to continue living like this.  We'll talk about log formats, analyze a couple of examples, write a few regular expressions, etc ... </p><br><p>  Dear colleagues, of course, this is your business, as well as what you write in the logs of your program, however, it‚Äôs still worth thinking only for yourself ... Perhaps, besides you, some user of yours is looking at this line now with despair programs, and even smart to impossible, but swearing in vain, bot. </p><br><p>  I also wrote this post, made another file with such a complex log format for analysis, which led to another ‚Äúvulnerability‚Äù, up to and including writing a ready-made exploit in the search process. </p><br><p>  And if I encourage at least one developer to think about this article, this will already be a big deal, and perhaps, next time analyzing the journals written by his program, he will not be remembered with a dirty word, but on the contrary will be gratefully praised. </p><a name="habracut"></a><br><p>  First, foul language ... </p><br><div class="spoiler">  <b class="spoiler_title">click (you were warned) ...</b> <div class="spoiler_text"><pre><code class="bash hljs">clear; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">"U2FsdGVkX19d2YHsJhZ9re6p/Gc7bK+Ri9MHvcrVSUsU0+a1UtXfEdIJNu88cQ56\nt6eC8VK5yIr5fiwVSV2e9zhpJLEq3BQQ/U1fthG6Jz4GMpFrqreajRhfVCXdrbpg\nMttWTW/3ljnX5hflOuh4OOycnXDL6kK7W5FOhe9nqnki6oYGj8UYkv06aM0acsea\nRq5OpvZrYT+/7E2ABqp+sg+opfDsaoOITtZPkoJMBPm1Ne4o//yq4tGJypLC/d0f\neWypmTRGEdCadPiFUqL97qWJYE2N7e8oIaETB6stHKfwULChVkI4TUff+ClzC1ZH\nJ9eDUa1qEnEtAvvbKxpumoxClF15hYa4Zb12jcaEM6OPIXiFw+fGk7BT6R64k/gN\nUufDNRQuxevX0C1ZJxAX311rqmqC4w9zQrAfiyrObxmk11x6+pj/Ukqn3V/w7Nt4\njfpxks49Ovnr7vy8Zo5uBHu2YcOAxOIjhj13onW2CK73fQ/vonvG/B0gMC9+FMaE\nk9RIRlRGmWJZLnqj6+RLKzakcoa91c60PXChzMCTC6BlXK5obW33uiPRhKmp6/nX\nVJo1XUI1d39yRny9N9m7hxuodFPSS0dgkT2FufzDexmwnFaTl7FvMo3bndbuNAIM\nA49+tM3qha7Bewc7J5cwGi2gFtkfYTJstjZh/rYA7rph2IsI7AJai7DGDhLDVeVV\nWSsFQ3KAkuD4VfdijDA4YLtYVsQguTMgiTwQ+5khqX9VPj9UXhhnX+pBUGj9ZKfa\nycT1gfkwya1+MCzDgAo28oXpoFj5/tGTNQuzi2AT6BteDJJy8U5P64zH4jgEmUD8\nvidPry7DaHY4PQQ8oF09ay5Jv/Z0ugK66+Al8wP15VRC8x0+W+HWzcC2a9LLz+Mx\n9uphZPo2Cl9nVIrWfhjqMKCJttpa3TT2j/pcciZZHJTiTg0hm5mU45YI68kl6s/a\nOxa5clTDOs6zJp79fbNk0jnjyb9Xx/9dcHNZzv1A3sUVDdhzG0EzMr6Fm5Mvg+op\noJ6TGFLuZrlcvdnBPc+J+ywOuhUCI9FPjr7JnkDbCKTMm9VykRqki+bWdURlKJ34\nlEI8LGT4Qrh5McBtruFu3KqC12giO1BvIKV8mj7jdzCflokW7/k+UI6+p1e8IP2j\n9rxlBgdym1t+ZaR3hhWo+WTMCbxzBrzmZaGNMsl5WVYKXUuAZ5hglbI12AcJzNyj\n5vQIft362+zcVY/opWuvhI61d3FdI+WuBGocexb63R/8TiQOaOD+WyElRZYwSFEI\nEd4uHtZOGFYwFJyghNlk6ubNq3BYHdp3RyBDr+R56ndEM25QemAj35TKwdOckqEi\nQCPoDTJwpsSO7pKBpER56O4rBwSu48PDXb95Mi3uBGUQZljXtJ1AHSWUJU3AIcUk\nvWpC0gzIWj9Ev4SXHxrCjqmXRrkfC8iJ7lLlTl3xF7v4Nxa5lorq6frF5500lmsH\nnEI7QmyuRJrE/JuiVbvUApOKnpmIJIlAw4ZCBuXo/PDsWwEwK4+Imi3hFTGtOv+Z\nj+cbOGetk5PWrIgDdbCGEnzWcKbdv31ASRdqfvwjqCpLN8kwRA2+pT7uFR65kkpd\ntpeZrnWc0RiVwwoyxI1IFLQvbWec4UXl/iJ1t8WuueI0BiK5crjzVhns/8v9uSDo\n1jtleZN5vaPlEWKuUUM4SrdS6NLOkqeHN0omtoP38fZoRkpwdytosbj07gI691cf\noc0c3nUo357d0GPq1Jmn3XCuLPnjv4Vn1+f1ryo+y8ang7rFI1C7+1wWEt2pp2nc\nDmQzAIFp0ncrSOTrLeCfVjy12+QAZ96ddG/cMVFcU4DFF/zxS9YIHJlbCF0/wjUY\nKcrpkIPc5Jb616WWUwbVZ0Kw4oPJf923Itu9LlcoNhlrGEUSVQXBwSm8cdWKcdlx\niVp22UjEn7Ycw6O7gZHJrpP2ysCBzpOFKSkd0274p8nT3bIva1aKtwEK0E49mPtr\n+WZ504z2blfHexYoVLtObrSOB2kktCuXLy6NpfhJyLDaywo3n1MHFOjfPE4dDPo4\nrTOEkFzsZukR8M+L77lQhuhskJ3zIZtpSqiL2qyfo8ZIS9t3ft+Vstj06BcbZSHJ\nGn/bKpAxAhHmaoy/qeEYh+fehn7KxGAc0eppPnwoPhfc5DPuXKtyfhBY5Ci9SZyV\nFOc8VcplHt5ED0lr0sfHeLLwUCaZGJY3tkHCPewQ2qGt+jGsbt8uI2s/gBKjePmU\nLTWts/eDPT9JzpTXcJmY6CqZccDsjOY5Pl4lqZwEc+yqMJHqXq+BbIsAwl/Wf19P\nPpv1VJ0L/MlM5r+o+QX5b70c9WEpSVlx946UlJbbPssrEAvgknwJrpKoNRF5gCAx\nDzDZ/ayUr5rlr8hfBcYUqGRYKGJPpzFvNkM6cuRIu8BSklZPmv4KaWdrpjZt5KdQ\nJ1vY6fe5Y/mB0w/qGeCbCb3bPGLnkhS2KDVazHHrsfdj50BMVtsJGmMTu4vwtUzF\nMTE6IjJJWL71DP5pCla9vLoyrUJboNFmQk9QqmOMrs2mLmJzIdL1zb51OpBIZOSG\nboYc0xU9sUMX7w2goPauyw=="</span></span> | openssl enc -aes-128-cbc -a -d -salt -pass pass:wtf</code> </pre> <br><p>  I apologize to my colleagues from Windows, although it is likely that revelations will open under gitbash or mingw ... </p></div></div><br><p>  Everyone calmed down and went ... </p><br><p>  <sub>(Footnote for skiddie: there is no mentioned exploit in the article, - to think and write yourself)</sub> </p><br><p>  So, what is happening in the development world with regards to logging: </p><br><ul><li>  The format of the log records is written, I apologize, from the bald - completely without any "standard", structure or order </li><li>  often the structure of the record itself is so dynamic that it almost completely depends on the "input" data </li><li>  user-input or foreign-data is often not disguised (escape), randomly interferes with the format haphazardly, worse - often, even if there is a valid or disguised value, for some reason the original is written to the log (well, if at least cut off) without any hesitation it is fraught </li><li>  in each subsequent release of the new version of the software, the format of almost every interesting log record will necessarily be changed (or even completely rewritten beyond recognition), which brings with it a lot of pleasure to sort it all out and analyze, once again running around the source (with availability of these) and generating a bunch of logs, making fun of the program in 20 different ways. </li></ul><br><p>  <a href="https://github.com/fail2ban/fail2ban/pull/1479">Here is</a> my little analysis (eng) with which you have to fight in a particular case (using fail2ban as an example) and why this is at least not good. </p><br><p>  Now the specifics: as an example, look at the following two lines: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Aug</span></span> 18 08<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:04</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:51</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">srv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sshd</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2131]</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Failed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">password</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">for</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">invalid</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span> 46589 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span> 58946 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Aug</span></span> 18 08<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:04</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:55</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">srv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sshd</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[2131]</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Failed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">password</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">for</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span> 58946 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ruser</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span> 46589 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span></code> </pre> <br><p>  Let's forget for a minute a log analyzer (aka bot) and look at them with a human eye.  Do you understand everything here? <br>  No, that there is something "exploit" or trying to find vulnerability, can be seen with the naked eye.  Those.  at least should be confused by the presence of two different IP addresses in each of them. </p><br><p>  The question is: which of these two addresses is bad? </p><br><p>  Let us briefly digress and look at the damn interesting OpenSSH sources (module <code>auth.c</code> ), namely, where these lines were created (yes, yes, you understood correctly - they were made by one function): </p><br><pre> <code class="hljs pgsql">authmsg = authenticated ? "Accepted" : "Failed"; authlog("%s %s%s%s for %s%.100s from %.200s port %d ssh2%s%s", authmsg, <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>, submethod != <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ? "/" : "", submethod == <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ? "" : submethod, authctxt-&gt;<span class="hljs-keyword"><span class="hljs-keyword">valid</span></span> ? "" : "invalid user ", authctxt-&gt;<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>, ssh_remote_ipaddr(ssh), ssh_remote_port(ssh), authctxt-&gt;<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ? ": " : "", authctxt-&gt;<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ? authctxt-&gt;<span class="hljs-keyword"><span class="hljs-keyword">info</span></span> : "");</code> </pre> <br><p>  Already much clearer, right?  Well, now you already know the answer?  Still not? .. Hmm ... </p><br><p>  Okay, I will not drag out the intrigue: this is 4.3.2.1 </p><br><p>  In the first case, from host 4.3.2.1 try to perform "Injecting on username" ( <code>authctxt-&gt;user</code> ) with the user name - <code>"test from 1.2.3.4 port 46589 ssh2"</code> . <br>  In the second case, from host 4.3.2.1 try to perform "Injecting into info" ( <code>authctxt-&gt;info</code> ) with a value equal to <code>"ruser from 1.2.3.4 port 46589 ssh2"</code> . </p><br><p>  Is it true, the intuitive record format? </p><br><p>  The key to <em>this particular case</em> is the presence of a colon, which is created by <code>authctxt-&gt;info != NULL ? ": " : "",</code> <code>authctxt-&gt;info != NULL ? ": " : "",</code> </p><br><p>  What I thought (and) the developer (s) of this masterpiece, I really do not understand ... </p><br><p>  Now let us estimate the complexity of the machine analysis of this, if I may say so, ‚Äústructure‚Äù from the point of view of security monitoring (specifically, for example, in fail2ban).  In assessing, HOST (or IP address) is important to us first of all, the difficulty of getting it in this particular example is related to the unpredictability of the location of the latter.  Yes, it always stands after <code>from</code> , but due to the lack of foreign-data masking and writing it after this data to the log (the sixth parameter, <code>ssh_remote_ipaddr(ssh)</code> ), determining its current position is not very easy. </p><br><p>  We are not looking for easy ways (in fact, we have no choice), so simply, as an example of complexity, we will try to assemble a regular expression suitable for this record. <br>  I will use regular expressions syntax for python (as the language in which fail2ban is made) ... </p><br><p>  Firstly, the "statics" and the strictly typed component: </p><br><ul><li>  the actual "structure" of the entry - <code>Failed ... for ... from ... port ... ssh2</code> </li><li>  + submethod method - <code>\S+</code> (password, challenge-response, publickey, hostbased, gssapi-with-mic etc) </li><li>  optionally invalid login - <code>(?:invalid user )?</code> </li><li>  host address, for simplicity we use IPv4 - <code>(?:(?:\d{1,3}\.){3}\d{1,3})</code> </li><li>  port - <code>\d+</code> </li></ul><br><p>  That's all, now the "dynamics": </p><br><ul><li>  username (for the sake of simplicity, we assume that there is an honest user, that is, there are no spaces) - <code>\S*</code> </li><li>  optional information at the end of the record from the authentication method, etc.  (for the sake of simplicity, let's take everything to the end) - <code>(?:: .*)?$</code> </li></ul><br><p>  Those.  we get the following expression, anchored for reliability on both sides ( <code>^...$</code> ): </p><br><pre> <code class="hljs tex">^Failed (?P&lt;meth&gt;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">S</span></span></span></span>+) for (?P&lt;valid&gt;invalid user )?(?P&lt;user&gt;<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">S*</span></span></span></span>) from (?P&lt;host&gt;(?:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d</span></span></span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{1,3}</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">.</span></span></span></span>){3}<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d</span></span></span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{1,3}</span></span></span></span>)(?: port <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d*</span></span></span></span>)?(?: ssh<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">d*</span></span></span></span>)?(?P&lt;info&gt;: .*)?<span class="hljs-formula"><span class="hljs-formula">$</span></span></code> </pre> <br><p>  A check on two examples showing that the simplest case works: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">##      (bash): $ _test() { python -c 'import sys, re; regex, log = sys.argv[1:]; print(log); r = re.search(regex, log); print(r.groupdict() if r else "*NOT-FOUND*")' "$1" "$2"; }; alias t=_test; ##  : $ regex='^Failed (?P&lt;meth&gt;\S+) for (?P&lt;valid&gt;invalid user )?(?P&lt;user&gt;\S*) from (?P&lt;host&gt;(?:\d{1,3}\.){3}\d{1,3})(?: port \d*)?(?: ssh\d*)?(?P&lt;info&gt;: .*)?$' ##  ‚Ññ 1 $ t "$regex" 'Failed password for invalid user test from 4.3.2.1 port 58946 ssh2' {'info': None, 'host': '4.3.2.1', 'valid': 'invalid user ', 'meth': 'password', 'user': 'test'} ##  ‚Ññ 2 $ t "$regex" 'Failed publickey for root from 4.3.2.1 port 58946 ssh2: RSA SHA256:v3dpapGleDaUKf...' {'info': ': RSA SHA256:v3dpapGleDaUKf...', 'host': '4.3.2.1', 'valid': None, 'meth': 'publickey', 'user': 'root'}</span></span></code> </pre> <br><p>  Now we will try to complicate the conditions (the username contains spaces) using non-greedy catch-all, although I do not like them, but we remember - we did not have much choice.  Those.  yuzay <code>.*?</code>  instead of <code>\S+</code> in username. </p><br><p>  Why it is not good - for example, since the anchor on the right is almost open, because <code>.*$</code> equivalent to an open expression on the right without an anchor.  About the speed and cpu-load on the long lines already keep silent.  But for now, let's continue this way (at least a colon is required in this case): </p><br><pre> <code class="bash hljs">$ regex=<span class="hljs-string"><span class="hljs-string">'^Failed (?P&lt;meth&gt;\S+) for (?P&lt;valid&gt;invalid user )?(?P&lt;user&gt;.*?) from (?P&lt;host&gt;(?:\d{1,3}\.){3}\d{1,3})(?: port \d*)?(?: ssh\d*)?(?P&lt;info&gt;: .*)?$'</span></span> $ t <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$regex</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">'Failed password for invalid user hello from space from 4.3.2.1 port 58946 ssh2'</span></span> {<span class="hljs-string"><span class="hljs-string">'info'</span></span>: None, <span class="hljs-string"><span class="hljs-string">'host'</span></span>: <span class="hljs-string"><span class="hljs-string">'4.3.2.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'valid'</span></span>: <span class="hljs-string"><span class="hljs-string">'invalid user '</span></span>, <span class="hljs-string"><span class="hljs-string">'meth'</span></span>: <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>: <span class="hljs-string"><span class="hljs-string">'hello from space'</span></span>}</code> </pre> <br><p>  Works!  Well, now we try on the top examples with injections: </p><br><pre> <code class="bash hljs">$ t <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$regex</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">'Failed password for invalid user test from 1.2.3.4 port 46589 ssh2 from 4.3.2.1 port 58946 ssh2'</span></span> {<span class="hljs-string"><span class="hljs-string">'info'</span></span>: None, <span class="hljs-string"><span class="hljs-string">'host'</span></span>: <span class="hljs-string"><span class="hljs-string">'4.3.2.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'valid'</span></span>: <span class="hljs-string"><span class="hljs-string">'invalid user '</span></span>, <span class="hljs-string"><span class="hljs-string">'meth'</span></span>: <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>: <span class="hljs-string"><span class="hljs-string">'test from 1.2.3.4 port 46589 ssh2'</span></span>} $ t <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$regex</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-string"><span class="hljs-string">'Failed password for user test from 4.3.2.1 port 58946 ssh2: ruser from 1.2.3.4 port 46589 ssh2'</span></span> {<span class="hljs-string"><span class="hljs-string">'info'</span></span>: <span class="hljs-string"><span class="hljs-string">': ruser from 1.2.3.4 port 46589 ssh2'</span></span>, <span class="hljs-string"><span class="hljs-string">'host'</span></span>: <span class="hljs-string"><span class="hljs-string">'4.3.2.1'</span></span>, <span class="hljs-string"><span class="hljs-string">'valid'</span></span>: None, <span class="hljs-string"><span class="hljs-string">'meth'</span></span>: <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>: <span class="hljs-string"><span class="hljs-string">'user test'</span></span>}</code> </pre> <br><p>  What we see, it also seems to work correctly (both times we have the correct value of <code>'host': '4.3.2.1'</code> ). <br>  But ... Always, there is a "but", isn't it? </p><br><p>  Both of these examples are simple, even without taking into account the undesirable use of catch-all, if you make an injection more complicated, then our expression ‚Äúbreaks‚Äù or, much worse, returns incorrect data (which theoretically is a vulnerability, because we can either fail2ban to block a ‚Äúforeign‚Äù host, or to go through passwords indefinitely, because we are ‚Äúinvisible‚Äù). </p><br><p>  I will not include a gear grinder here and immediately cite the ‚Äúcorrect‚Äù (no, rather more appropriate) expression.  I don‚Äôt really like it either (for many reasons), but what is - that is ... </p><br><pre> <code class="hljs ruby">^Failed (<span class="hljs-string"><span class="hljs-string">?P</span></span>&lt;meth&gt;\S+) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-string"><span class="hljs-string">?P</span></span>&lt;cond_inv&gt;invalid user )?(<span class="hljs-string"><span class="hljs-string">?P</span></span>&lt;user&gt;(<span class="hljs-string"><span class="hljs-string">?P</span></span>&lt;cond_user&gt;\S+)<span class="hljs-params"><span class="hljs-params">|(?(cond_inv)(?:(?! from ).)*?|</span></span>[^<span class="hljs-symbol"><span class="hljs-symbol">:</span></span>]+)) from (<span class="hljs-string"><span class="hljs-string">?P</span></span>&lt;host&gt;(?<span class="hljs-symbol"><span class="hljs-symbol">:</span></span>\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>}\.){<span class="hljs-number"><span class="hljs-number">3</span></span>}\d{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>})(?: port \d+)?(?: ssh\d*)?(?(cond_user)<span class="hljs-symbol"><span class="hljs-symbol">:|</span></span>(<span class="hljs-string"><span class="hljs-string">?P</span></span>&lt;info&gt;(?<span class="hljs-symbol"><span class="hljs-symbol">:</span></span>(?! from ).)*)$)</code> </pre> <br><p>  Below I will explain a little what it does.  But why is it and what kind of injections (test-cases) does it cover, I will keep silent for now ... </p><br><p>  Let it be like homework, well, or if you want to prevent script-kiddies from being tempted, although on the other hand they also need to learn something ... </p><br><p>  So - this is a complicated (subordinate) expression with conditional "transitions" that in python look like </p><br><pre> <code class="hljs xml">(?P<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">-</span></span></span><span class="hljs-tag">&gt;</span></span>)? ... (?(-) -1 | -2)</code> </pre> <br><p>  Briefly why it is difficult (subordinate): </p><br><ul><li><p>  the expression sparsit is completely anchored to the right, if we have the simplest username, exactly one <code>" from "</code> (or not <code>" from "</code> before <code>":"</code> and-or not <code>" from "</code> after <code>":"</code> );  despite the fact that the conditional anchor on the right plays an important role, because it must check all this completely </p><br></li><li><p>  or we have no <code>":"</code> (usually ends with ssh2), in this case the host is preferred after the last <code>" from "</code> </p><br></li><li>  otherwise, it always prefers the host after the first <code>" from "</code> . </li></ul><br><p>  Yes, the expression <code>"(?:(?! from ).)*"</code> - "conditional" catch-all, which will collect everything, if (so far) there is no <code>" from "</code> . </p><br><p>  In fact, there are logs, much more complicated than the above example, right up to completely structural ones, which are not regularly understood in principle (or because of their complexity, because the three-story conditional transitions there will take the brain away from the word at all).  Sometimes it is possible to collect trailer data from several records (if they have a common identifier). </p><br><p>  Neural networks, unfortunately also not a panacea at all, because  as a rule, they must first be fed with the necessary information, where, in the process of learning, they ideally should not collect any "garbage". </p><br><p>  Unfortunately, such logs are more common than we would like, and there are often a lot of other questions to the "manufacturers" of logs.  On this basis, disputes often arise (for example, your humble servant with SW. Prof. <a href="https://habrahabr.ru/users/yarikoptic/" class="user_link">yarikoptic</a> ) - how (how strictly) it is better to design a regular schedule: </p><br><ul><li><p>  use a short expression (not an anchor on the right) that covers the known stable information up to the first dynamic component, which does not carry any payload, which theoretically is some risk if tomorrow the developer changes or rewrites the logging (and a similar log entry appears but is not in class desired). <br>  For some reason, this will allow parsing logs successfully, if this dynamic component changes almost completely (and we remember, it is not important). </p><br></li><li>  or cover (currently known) the structure completely (with anchors from both ends), which is associated with other risks - even with a slight deviation, we will lose some records (for they will no longer match the desired expression). </li></ul><br><p>  Instead of the conclusion, a little more, as I believe, you need to do logging (something else, be it an API, or the most complex servers): </p><br><ul><li><p>  it is desirable to have (and begin) with a unique record identifier (for example, some prefix like "Auth attempt:" is appropriate here) </p><br></li><li><p>  static, permanently valid, strictly typed data we always write to the beginning of the record (in our example, HOST, identification method, user presence or "invalid user") </p><br></li><li><p>  the dynamic or strongly modified component of the record is placed accordingly at the end (for example, the user name and / or authctxt-&gt; info transmitted by the client) </p><br></li><li><p>  if possible, non-typed data is desirable to write already disguised (and cropped), i.e.  escape at least newline ( <code>"\n" -&gt; "\\n"</code> ) as a separator for records and some special characters used as block delimiters in the record format structure (for example, comma and colon) </p><br></li><li><p>  the structure of the log entry should be well thought out before its first appearance in releases (important for the next item) </p><br></li><li><p>  If possible, do not change the log structure, i.e.  the structure of the log entries already published in the release is frozen and stored forever (at least partially, at least its more or less static component) </p><br></li><li>  it is desirable to avoid a structure that allows the <s>brain</s> to tolerate an ambiguous interpretation of the record, vulnerable to "injection" by foreign-data, etc. </li></ul><br><p>  Well, for this particular entry, it would look something like this (everything is "strictly typed" at the beginning; the user name and other dynamic information at the end, for example, in quotes; well, we mask (quotes, spaces), for example, url_encode from above): </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Auth</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">attempt</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Failed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">password</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span> 58946 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">invalid</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span>+1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span>+46589+<span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">Auth</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">attempt</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Failed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">password</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span> 58946 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span>", <span class="hljs-selector-tag"><span class="hljs-selector-tag">info</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">ruser</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span>+1<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span>+46589+<span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">Auth</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">attempt</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Failed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">publickey</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">port</span></span> 58946 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ssh2</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">root</span></span>", <span class="hljs-selector-tag"><span class="hljs-selector-tag">info</span></span>: "<span class="hljs-selector-tag"><span class="hljs-selector-tag">RSA</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">SHA256</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:v3dpapGleDaUKf..."</span></span></code> </pre> <br><p>  You can actually think up many more such points, but if it is at least to follow these rules or some of them, the world of many people (and not only people) will again start playing with new colors. </p><br><p>  And thank you so much from your grateful users, your colleagues who understand your logs, and especially from some of the pieces (burdened with artificial intelligence, all kinds of neural networks and other bots) with rays of gratitude will be spilled on your karma. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/308116/">https://habr.com/ru/post/308116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308102/index.html">Development for SailfishOS: menu</a></li>
<li><a href="../308104/index.html">From juniors to developers: we get the first job</a></li>
<li><a href="../308106/index.html">As I avoided burnout, having worked as a programmer for more than three decades</a></li>
<li><a href="../308108/index.html">What does HPE Mobile Center test?</a></li>
<li><a href="../308112/index.html">Joker Student Edition: The best videos of past conferences</a></li>
<li><a href="../308118/index.html">ReactJS year of use: sum up</a></li>
<li><a href="../308122/index.html">Meeting Big Data Lovers</a></li>
<li><a href="../308124/index.html">Announcement Rust 1.11</a></li>
<li><a href="../308126/index.html">Qt: Report output by standard means (or we live without report generators)</a></li>
<li><a href="../308128/index.html">How our neural network talked with the FSB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>