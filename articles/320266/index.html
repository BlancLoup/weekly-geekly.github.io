<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JunOS update on EX4500 switches in VirtualChassis - what could go wrong? Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Searching on Habr√©, did not find the article covering this topic in the required amount, hence the post. There will be two parts, since there is a bit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JunOS update on EX4500 switches in VirtualChassis - what could go wrong? Part 1</h1><div class="post__text post__text-html js-mediator-article">  Searching on Habr√©, did not find the article covering this topic in the required amount, hence the post.  There will be two parts, since there is a bit too much for a trial article. <br><br>  Since I'm new here, let me introduce myself: my name is Yura and at the moment I am working as a network engineer in the company as a service provider.  Behind him is teaching at the Cisco Networking Academy, quite a close acquaintance with the lower / middle line of their devices and the last four years with Juniper devices.  For a long time I could not collect my thoughts about this post, but in the end, the thirst for epistolary recognition and the desire to help colleagues took up. <br><br>  As an introduction, I can say that the principle of updating and the above calculations are valid for most (if not all) Juniper devices.  In my case, these are two EX4500 switches operating in VirtualChassis (virtual chassis / VC).  The VirtualChassis technology itself will not be considered by me, as this will inflate the post to indecent sizes.  In addition, the topic was discussed earlier on Habr√© <a href="https://habrahabr.ru/company/muk/blog/283546/">here</a> .  I will only note that it vaguely resembles VSS from Cisco: several physical devices are combined into one logical one with a common control panel, configuration, protocols, tables, etc.  I won‚Äôt get too bogged down and reflect on the advantages / disadvantages, implementation and other internal subtleties - the comparison here is more like a reference mark, the differences between VC and VSS are large, as well as between Cisco IOS and JunOS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      My patient is two EX4500 physical switches combined into the mentioned VC (that is, one logical device) and located in the network core.  Above the network are two independent BGP routers, each of which is connected to its physical EX4500 (‚Äúmember‚Äù in the virtual chassis) with one link and sends the default route, summarizing the Full View table.  Below is a network of servers with virtual servers and physical servers that use VC as the default gateway.  The original version of JunOS 11.1R3.5, uptime - with the installation, about 800 days. <br><a name="habracut"></a><br>  The update itself and its need for vital long before my appearance in the company (hence the rather ancient version), but either nobody decided, given the importance of the piece of iron, or there was no time for it, or ‚Äúit works ‚Äî don't touch it,‚Äù but it no longer important.  The term of support for this version was coming to an end and the update had to be done.  Since this is the core of the service provider network, among which clients are many critical to the unavailability of customers, the downtime requirements are quite stringent.  Among other things, internal traffic is added (for example, backups) that passes through the core.  Looking ahead to say that without a bit of luck, I would have failed these requirements.  On the other hand, without a share of failure, this post would not exist. <br><br>  So, according to information from the manufacturer, the system can be updated in the following ways: <br><br><ol><li>  Normal update </li><li>  Nonstop Software Upgrade (NSSU) </li><li>  In-service Software Upgrade (ISSU) </li></ol><br>  From the end - ISSU.  The idea here is that the OS is first updated on the main RoutingEngine (RE), and all management and traffic is switched to standby RoutingEngine (RE).  Then there is a switch between the engines and update the backup RE.  Protocols and tables for this must be synchronized between the engines - this is achieved using Graceful Routing Engine Switchover (GRES) and Nonstop Bridging / Routing (NSB / NSR) technologies. <br><br>  This type of update is suitable for devices with dual physical RoutingEngine (aka ControlPlane, <a href="https://habrahabr.ru/post/307696/">here</a> you can see information about the architecture and RoutingEngins) and / or devices on which JunOS is virtualized, for example, some MX routers or QFX5100 and EX4600 switches, but only working in stand -alone mode.  That is, in my case, the span on both articles. <br><br>  NSSU is suitable for devices with a single physical RE integrated into a VC or VCF (VirtualChassis Fabric, to put it simply - the next generation of VC).  In this case, the role of standby RoutingEngine plays RE on another device.  This procedure updates the system in a virtual chassis, overloading one member device at a time, which allows minimizing downtime, provided that aggregated channels are used that are terminated on different VC members and are suitable for any supported VC / VCF configurations.  The presence of GRES and NSB / NSR here is advisory in nature and allows you to reduce downtime.  It sounds great, but with two reservations - the minimum version of JunOS 12.1 and the strong recommendation not to use it from Juniper TAC.  The target version of the system in my case is 12.3, the highest recommended by the manufacturer at that time.  It just allows NSSU, as well as NSB / NSR - it allows you to change the main RE in the chassis on the fly without loss of packets, as well as update the system without downtime for users. <br><br>  In the end, considering my realities, there was only one way left - the ‚Äúnormal‚Äù update.  Under the usual here refers to the update with a simultaneous reboot of all VC devices, respectively, about 5-15 minutes of network failure.  The estimated time is taken from the manufacturer‚Äôs manuals, in my case it was about 4 minutes.  The procedure for such an update (no problem) is also reviewed <a href="https://habrahabr.ru/post/230755/">here</a> .  If you are tired of reading and you are not afraid of possible problems when updating, I recommend to visit. <br><br>  Since I spent quite a long time preparing, I would venture to bring the full calculations, even considering that not all of them were applicable in my situation.  In addition, it is likely that they will be useful to you. <br><br>  First of all, the manufacturer (and now I) recommends that you check and update the JunOS loader version and the layout of the internal storage.  In my particular case, it was not necessary to do this, but later I will show why this may be important. <br><br>  If you update devices from version 10.4R2 or earlier to 10.4R3 or later, you will need to update the bootloader specific for each platform in addition to the actual OS upgrade.  Upgrading the bootloader will also reformat the internal storage and create a second partition to store the operating system.  As a result, there will be two sections with the operating system on the device - one active and one spare, as well as two sections for other files (logs, home directory, etc.).  In what situations need to update the bootloader?  First, if the output of the show chassis firmware command does not contain information about the bootloader version after the words "U-boot", before the brackets: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> chassis firmware Part <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span> FPC <span class="hljs-number"><span class="hljs-number">0</span></span> uboot U-Boot (May <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">2010</span></span> - <span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>) loader FreeBSD/PowerPC U-Boot bootstrap loader <span class="hljs-number"><span class="hljs-number">2.2</span></span></code> </pre> <br>  Note that this command, as well as many subsequent ones, displays information about each individual device member of the VC.  Each device is identified by its FPC number (0, 1, 2, etc., depending on the number of devices).  In this case, the device was one, as there was not enough old devices in the production and I took one of the labs. <br><br>  Second, if the internal storage contains only three sections (referred to as slice) in the output of the show system storage command: <br><br><div class="spoiler">  <b class="spoiler_title">Command output</b> <div class="spoiler_text">  user @ switch&gt; show system storage <br>  fpc0: <br>  - Filesystem Size Used Avail Capacity Mounted on <br>  / dev / da0s1a 184M 120M 50M 71% / <br>  devfs 1.0K 1.0K 0B 100% / dev <br>  / dev / md0 35M 35M 0B 100% / packages / mnt / jbas e <br>  / dev / md1 18M 18M 0B 100% / packages / mnt / jcry pto-ex-10.3R1.9 <br>  / dev / md2 6.4M 6.4M 0B 100% / packages / mnt / jdoc s-ex-10.3R1.9 <br>  / dev / md3 145M 145M 0B 100% / packages / mnt / jker nel-ex-10.3R1.9 <br>  / dev / md4 22M 22M 0B 100% / packages / mnt / jpfe -ex42x-10.3R1.9 <br>  / dev / md5 46M 46M 0B 100% / packages / mnt / jrou te-ex-10.3R1.9 <br>  / dev / md6 27M 27M 0B 100% / packages / mnt / jswi tch-ex-10.3R1.9 <br>  / dev / md7 21M 21M 0B 100% / packages / mnt / jweb -ex-10.3R1.9 <br>  / dev / md8 126M 10.0K 116M 0% / tmp <br>  / dev / da0s1f 123M 1.3M 112M 1% / var <br>  / dev / da0s3d 314M 146K 289M 0% / var / tmp <br>  / dev / da0s3e 55M 78K 51M 0% / config <br>  / dev / md9 118M 12M 96M 11% / var / rundb <br>  procfs 4.0K 4.0K 0B 100% / proc <br>  / var / jail / etc 123M 1.3M 112M 1% / packages / mnt / jweb -ex-10.3R1.9 / jail / var / etc <br>  / var / jail / run 123M 1.3M 112M 1% / packages / mnt / jweb -ex-10.3R1.9 / jail / var / run <br>  / var / jail / tmp 123M 1.3M 112M 1% / packages / mnt / jweb -ex-10.3R1.9 / jail / var / tmp <br>  / var / tmp 314M 146K 289M 0% / packages / mnt / jweb -ex-10.3R1.9 / jail / var / tmp / uploads <br>  devfs 1.0K 1.0K 0B 100% / packages / mnt / jweb -ex-10.3R1.9 / jail / dev <br>  {master: 0} <br></div></div><br>  Here we are interested in the device / dev / da0 and the fact of the presence of only three sections dev / da0s1X and dev / da0s3X.  Where did dev / da0s2X go? Do not ask - I did not find the answer.  Anyway, the fourth slice is not here.  If it is, it will be called <b>/ dev / da0s4d</b> . <br><br>  Another way to check for repartitioning is to issue the <b>show system storage partitions</b> command.  In case the command returns an error, an update will be required. <br>  If there is a need to update the bootloader and repartition the repository (which is recommended when any doubts are necessary), remember that this means formatting and, as a result, deleting all the information.  Accordingly, it is necessary to save all the important information, but rather the entire contents of the internal flash drive.  The process of updating the bootloader is trivial and repeats itself for JunOS: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> software <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> /var/tmp/ jloader-XXX.tgz <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> reboot</code> </pre> <br>  It is recommended that you update the bootloader and the system at the same time - this will allow the device to be rebooted only once.  With one exception.  If you upgrade your old markup system (3 partitions) to a new one (4 partitions) and at the same time update JunOS, the updated version will be written into both boot partitions (main and backup).  This may be undesirable in situations where you do not know how the updated production system behaves.  In this case, it will be necessary to update the bootloader and the system separately and to overload the devices twice.  In the lab with one EX4200, the upgrade of the loader + system took me 13 minutes, for newer / faster devices, perhaps less. <br><br>  Now back to the main topic. <br><br>  As already mentioned, I did not need to update the bootloader and I started saving (backup our everything!) All files via SFTP, text config, snepshots to internal storage, and to an external USB flash drive: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> media <span class="hljs-type"><span class="hljs-type">internal</span></span> member <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> media <span class="hljs-type"><span class="hljs-type">internal</span></span> member <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> alternate <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> media <span class="hljs-type"><span class="hljs-type">internal</span></span> member <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> media <span class="hljs-type"><span class="hljs-type">internal</span></span> member <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> alternate <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">snapshot</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> media <span class="hljs-keyword"><span class="hljs-keyword">external</span></span></code> </pre> <br>  Despite the fact that Juniper recommends the use of <i>certified</i> flash drives, almost anyone with a capacity of 2GB or less is suitable, formatted in FAT with MBR.  In the above script, the first 4 lines create a snapshot of the running OS and configuration into active and backup (slice alternate) partitions on both devices in the VC.  If there are more devices, repeat for each "member N".  Instead of member N, you can also use the key " <b>all-members</b> ", but I prefer certainty.  The snapshot itself allows you to later roll back to the old version of the system and / or boot from the backup partition, as well as an external flash drive in case of any problems. <br><br>  <b>Important!</b>  Before taking snapshots, check the currently running system version ( <b>show version</b> ) and the contents of the primary and backup sections ( <b>show system snapshot media internal</b> ) for the corresponding versions.  The hitch is that the ‚Äúrequest system snapshot media internal member N‚Äù command copies the current running (or running) version to the main partition, and the ‚Äúrequest system snapshot media internal member N slice alternate‚Äù command copies from the main partition to the backup section.  For some reason, in my main section, there was a more ancient version than in the backup one.  Geekiness and precaution here only for good. <br><br>  The last command makes a snapshot on an external flash drive and, among other things, formats it (the partition key is required) in accordance with the contents and partition table of the internal flash drive. <br><br>  Before upgrading, it is advisable to copy the new version of the system to the internal storage if you are not upgrading from an external disk / FTP / HTTP server.  Juniper recommends placing the system image in / var / temp.  I would NOT recommend doing this, because during the update process, the contents of / var are removed and in case of trouble (like mine), you will need to reload the image again.  Needless to say, this delay in case of system criticality is less than desirable.  Use the better pre-created directory in the root, and after the update, clean the storage with the help of ‚Äú <b>file delete / directory / filename</b> ‚Äù. <br><br>  Further update itself with a reboot: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> software <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> /var/tmp/jinstall-XXX.tgz <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>@switch&gt; request <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> reboot</code> </pre> <br>  The ‚Äúvalidate‚Äù key allows you to check the compatibility of the device configuration with the new version of the operating system.  For my EX4500 devices, it is performed automatically and it is not required to specify it explicitly, but for others it must be set ‚Äî better obviously, it won't be worse. <br><br>  Why actually this long post and a bunch of explanations with warnings?  After 4 minutes of rebooting and updating, I see that the interface LEDs light up only on the second device (member1).  For me, this is not bad, since all LACP links are connected to both devices and (good luck, hello!) This particular device is connected to the main Internet channel, the customers are again online.  The only non-LACP link is connected to member0 and connects the car park to the backup server.  For me, it is not critical, since all backups have been stopped. <br><br>  At this place, the happy administrator finishes his job, slurps the last of his coffee and goes home with peace of mind, smiling at the night city.  In my case, the given material is 1/3 of the whole article.  If this topic is of interest to users, I will continue it with pleasure - only interesting is next! </div><p>Source: <a href="https://habr.com/ru/post/320266/">https://habr.com/ru/post/320266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320256/index.html">The most popular words in two terabytes of code</a></li>
<li><a href="../320258/index.html">We become professional PHP developers. Part 4: Teamwork in practice</a></li>
<li><a href="../320260/index.html">Return H.264 support in Vivaldi in openSUSE Leap 42.2</a></li>
<li><a href="../320262/index.html">RIGHT kitchen</a></li>
<li><a href="../320264/index.html">We write a wrapper over the API, make a PIP packet out of it, connect Travis CI testing and look at open source licenses</a></li>
<li><a href="../320268/index.html">Generating documents in doc, excel, pdf and other formats on the server</a></li>
<li><a href="../320270/index.html">Internet intelligence in action: who is Mr./Ms. Habraman?</a></li>
<li><a href="../320278/index.html">Hard parting with Net-Tools</a></li>
<li><a href="../320280/index.html">Javascript Video Refactoring</a></li>
<li><a href="../320282/index.html">Hijacking Whatsapp accounts using the web version</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>