<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chromium: the sixth project check and 250 bugs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This text begins a series of articles devoted to the regular testing of the Chromium project with the help of the PVS-Studio static code analyzer. The...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chromium: the sixth project check and 250 bugs</h1><div class="post__text post__text-html js-mediator-article">  This text begins a series of articles devoted to the regular testing of the Chromium project with the help of the PVS-Studio static code analyzer.  The articles will look at various error patterns and offer recommendations to reduce the likelihood of their occurrence in the code.  However, before you begin, you need to write a kind of introduction that will answer a number of questions in advance, as well as provide Chromium developers with all the errors they have noticed that they can begin to correct without waiting for the end of the cycle of articles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/978/1db/52e/9781db52e24de61cf6e1700014f75fcd.png" alt="Andrey Karpov, PVS-Studio"></div><br><h2>  Prehistory </h2><br>  My name is Andrey Karpov, and I am an evangelist of static analysis in general and the static analysis tool PVS-Studio in particular.  However, the term ‚Äútechnical evangelist‚Äù is already becoming obsolete, and it is being replaced by ‚Äúdeveloper advocate‚Äù. <br><br>  I spend a lot of time writing material on improving the quality of the code and increasing the reliability of programs.  Now I have a new reason to write a few articles on this topic - checking the open <a href="https://www.chromium.org/">Chromium</a> project with the help of the PVS-Studio analyzer.  This is a big project, and in any big project live bugs of various types.  This diversity allows you to consider several interesting topics related to the causes of these bugs and ways to prevent them. <br><a name="habracut"></a><br>  It should be noted that this is not the first article dedicated to the Chromium project.  My previous publications: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  May 2011. Andrei Karpov.  <a href="https://www.viva64.com/ru/a/0074/">PVS-Studio vs Chromium</a> . </li><li>  October 2011. Andrey Karpov.  <a href="https://www.viva64.com/ru/b/0113/">PVS-Studio vs Chromium - continued</a> . </li><li>  August 2013. Andrey Karpov.  <a href="https://www.viva64.com/ru/b/0205/">The third check of the Chromium project code with the help of the PVS-Studio analyzer</a> . </li></ul><br>  As you can see, I had bad titles with interesting titles, and my strength was over.  Therefore, further the baton was picked up by my colleagues: <br><br><ul><li>  December 2013. Yevgeny Ryzhkov.  <a href="https://www.viva64.com/ru/b/0225/">How we are trying to sell PVS-Studio to Google or the next errors in Chromium</a> . </li><li>  October 2016. Philip Handelyants.  <a href="https://www.viva64.com/ru/b/0442/">Go to the record: the fifth check Chromium</a> . </li></ul><br>  By the way, while I was studying the fresh report, I could not resist and wrote a short note about one very pleasant mistake.  Since the article has already been published, I will provide here a link to it: <br><br><ul><li>  January 2017. Andrey Karpov.  <a href="https://www.viva64.com/ru/b/0550/">February 31st</a> . </li></ul><br>  Every time we checked a project, there were a large number of errors in it.  New check is no exception.  Moreover, since the PVS-Studio analyzer detects errors more and more, at first I simply did not know what to do with all of them.  Skimming through the report, I wrote out about 250 errors and thought.  Describe all 250 errors in one article?  It will be some kind of horror: long, boring and uninteresting.  Break the description is not a few articles?  It will not be better either; instead of one boring article, there will be several. <br><br>  Then I decided to break the errors found by type and consider them separately.  Moreover, I decided not only to describe the errors, but to try to suggest some methods of dealing with them besides static code analysis.  After all, it is much better not to make a mistake at all than to find it later using static / dynamic code analysis / or something else.  Even worse, if the user finds errors.  Therefore, if it is possible to improve the coding style so that the appearance of an error becomes less likely, then it is worthwhile to speculate on this topic.  This is what I will do in a series of articles. <br><br>  Before I start looking at error patterns, I need an introduction that you are reading.  For example, I need to explain why I did not find the strength to carefully study the report, why I cannot say about the percentage of false positives, and where I can read all the errors I have noticed at once. <br><br><h2>  Project Verification </h2><br>  At the very end of 2017, my colleague Svyatoslav Razmyslov downloaded the source code of the Chromium project, somehow conjured up with them and gave me a generated project for Visual Studio and a PVS-Studio report.  Unfortunately, it was impossible to work with the solution in the Visual Studio environment.  Wednesday did not survive the decision, which includes 5021 projects. <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5f4/445/507/5f444550789603bcffbeee1b8abf4642.png" alt="5021 projects in solution"></div><br>  Everything is incredibly slow, and in general the environment drops down after a while.  Therefore, I studied the report using PVS-Studio Standalone.  This, of course, is not as convenient as using Visual Studio, which I am used to, but is perfectly acceptable. <br><br>  It is necessary to understand that the Chromium project is a big project.  Not even said so.  This is a BIG PROJECT. <br><br>  The Chromium project and the libraries used in it consist of 114,201 files in C and C ++.  The number of lines of code is 30,263,757. Of these, comments make up 16%. <br><br>  Just that PVS-Studio can check a project of this size is already an achievement :). <br><br><h2>  What i found </h2><br>  While the New Year holidays were going, I looked through the report for three evenings and wrote out about 250 code fragments, which, in my opinion, require attention and editing.  I confess that I did not find the time and energy to review the report carefully.  I looked through many warnings very quickly, and some of them ignored them altogether when I was bored with some sort of error.  I will tell you more about this in the next chapter. <br><br>  It is important that I found a lot of mistakes, which is enough to write several articles.  By the time I finish publishing the last line, information about errors found in the project may be a little out of date.  But it does not matter.  My goal is to demonstrate the capabilities of the <a href="https://www.viva64.com/ru/t/0046/">static code analysis</a> methodology and share some recommendations on coding style with readers. <br><br>  So that the developers of Chromium and the libraries could correct the errors I noticed, without waiting for the end of the cycle of articles, I wrote them out in a separate file.  This should also be done for the reason that perhaps not all error messages will be included in the articles. <br><br>  Link to the file with the description of the observed defects: <a href="http://cppfiles.com/chromium.txt">chromium.txt</a> . <br><br><h2>  Why I did not master to view the report carefully? </h2><br>  I did not set up analyzer to reduce the number of false positives.  Therefore, false warnings prevented me from looking at the report, and often I missed messages of the same type without peering at them. <br><br>  Moreover, I missed code snippets, where it is not immediately clear whether there is an error or not.  There are many messages, and I am alone.  If I had begun to look closely at the code, I would have written articles only in a few months. <br><br>  Let me show you with examples why some warnings are difficult to understand, especially if this is unfamiliar code.  And in Chromium I do not know the entire code. <br><br>  So, the PVS-Studio analyzer issued a warning to one of the V8 project files: <br><br>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-570 Expression 'truncated' is always false.  objects.cc 2867 <br><br>  Is a bug found, or is this a false positive?  Try to understand yourself what is the matter.  I added the comment "// &lt;=" to where the analyzer points. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> String::StringShortPrint(StringStream* accumulator, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> show_details) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len = length(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &gt; kMaxShortPrintLength) { accumulator-&gt;Add(<span class="hljs-string"><span class="hljs-string">"&lt;Very long string[%u]&gt;"</span></span>, len); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!LooksValid()) { accumulator-&gt;Add(<span class="hljs-string"><span class="hljs-string">"&lt;Invalid String&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-function"><span class="hljs-function">StringCharacterStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stream</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> truncated = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &gt; kMaxShortPrintLength) { len = kMaxShortPrintLength; truncated = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> one_byte = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> c = stream.GetNext(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c &lt; <span class="hljs-number"><span class="hljs-number">32</span></span> || c &gt;= <span class="hljs-number"><span class="hljs-number">127</span></span>) { one_byte = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } stream.Reset(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (one_byte) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (show_details) accumulator-&gt;Add(<span class="hljs-string"><span class="hljs-string">"&lt;String[%u]: "</span></span>, length()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { accumulator-&gt;Put(<span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt;(stream.GetNext())); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (show_details) accumulator-&gt;Put(<span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Backslash indicates that the string contains control // characters and that backslashes are therefore escaped. if (show_details) accumulator-&gt;Add("&lt;String[%u]\\: ", length()); for (int i = 0; i &lt; len; i++) { uint16_t c = stream.GetNext(); if (c == '\n') { accumulator-&gt;Add("\\n"); } else if (c == '\r') { accumulator-&gt;Add("\\r"); } else if (c == '\\') { accumulator-&gt;Add("\\\\"); } else if (c &lt; 32 || c &gt; 126) { accumulator-&gt;Add("\\x%02x", c); } else { accumulator-&gt;Put(static_cast&lt;char&gt;(c)); } } if (truncated) { // &lt;= accumulator-&gt;Put('.'); accumulator-&gt;Put('.'); accumulator-&gt;Put('.'); } if (show_details) accumulator-&gt;Put('&gt;'); } return; }</span></span></code> </pre> <br>  Understood?  Complicated? <br><br>  Complicated!  And that is why I alone cannot study all the warnings of the analyzer. <br><br>  For those who are too lazy to understand, I will explain the essence. <br><br>  So, the analyzer claims that the condition <i>if (truncated) is</i> always false.  Let's reduce the function, leaving the essence: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">F</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len = length(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &gt; kMaxShortPrintLength) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> truncated = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len &gt; kMaxShortPrintLength) truncated = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (truncated) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= accumulator-&gt;Put('.'); accumulator-&gt;Put('.'); accumulator-&gt;Put('.'); } }</span></span></code> </pre> <br>  The <i>truncated</i> flag must be <i>true</i> if the text is too long, that is, if the condition is satisfied <i>(len&gt; kMaxShortPrintLength)</i> .  However, if the text is too long, the function exits above. <br><br>  That is why <i>truncated is</i> always <i>false</i> and three dots at the end will not be added. <br><br>  And even now, after finding out the reason why the analyzer issues a warning, I do not know how the code should be written.  Or, really, you need to immediately exit the function, then the code that adds points is just superfluous.  Or points are needed, and the first check should be removed, which terminates the function ahead of time.  It is very, very difficult to study errors in third-party code. <br><br>  The PVS-Studio analyzer issued a lot of warnings V547.  I looked only about their 10th part.  Therefore, if you take a close look, much more errors will be found than I wrote out. <br><br>  Here is another example of why I was bored with working with these warnings. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ResourcePrefetcher::OnReadCompleted(net::URLRequest* request, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytes_read) { DCHECK_NE(net::ERR_IO_PENDING, bytes_read); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes_read &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { FinishRequest(request); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes_read &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) ReadFullResponse(request); }</code> </pre> <br>  PVS-Studio warning: V547 CWE-571 Expression 'bytes_read&gt; 0' is always true.  resource_prefetcher.cc 308 <br><br>  Unlike the previous case, everything is simple.  The analyzer is exactly right in stating that the second condition is always true. <br><br>  However, this is not an error, but a redundant code.  Should I edit such a code?  Complex issue.  This is, by the way, the reason why it is much better to write the code immediately under the supervision of the analyzer, and not to wade heroically through the warnings of one-time launches. <br><br>  If the analyzer were used regularly, then such redundant code would most likely not even get into the version control system.  The programmer would see the warning and write more gracefully.  For example: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ResourcePrefetcher::OnReadCompleted(net::URLRequest* request, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytes_read) { DCHECK_NE(net::ERR_IO_PENDING, bytes_read); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bytes_read &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) FinishRequest(request); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ReadFullResponse(request); }</code> </pre> <br>  The analyzer is silent here.  At the same time, the code has become shorter, simpler and clearer. <br><br>  In addition to the <a href="https://www.viva64.com/ru/w/v547/">V547</a> , the analyzer issued a whole mountain of <a href="https://www.viva64.com/ru/w/v560/">V560</a> messages.  This warning states that not all condition is always true or false, but some part of it. <br><br>  These messages were also boring for me to study.  This does not mean that the V560 warnings are bad.  But real serious mistakes are rare.  Mostly these warnings indicate poor quality redundant code. <br><br>  An example of a boring redundant check: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ConditionT, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ActionT&gt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;DeclarativeRule&lt;ConditionT, ActionT&gt;&gt; DeclarativeRule&lt;ConditionT, ActionT&gt;::Create(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> bad_message = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= std::unique_ptr&lt;ActionSet&gt; actions = ActionSet::Create( browser_context, extension, rule-&gt;actions, error, &amp;bad_message); // &lt;= if (bad_message) { // &lt;= *error = "An action of a rule set had an invalid " "structure that should have been caught " "by the JSON validator."; return std::move(error_result); } if (!error-&gt;empty() || bad_message) // &lt;= return std::move(error_result); .... }</span></span></code> </pre> <br>  PVS-Studio warning: V560 CWE-570 A part of conditional expression is always false: bad_message.  declarative_rule.h 472 <br><br>  Condition: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!error-&gt;empty() || bad_message)</code> </pre> <br>  can be simplified to: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!error-&gt;empty())</code> </pre> <br>  There is also an option to rewrite the code like this: <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bad_message) { *error = <span class="hljs-string"><span class="hljs-string">"An action of a rule set had an invalid "</span></span> <span class="hljs-string"><span class="hljs-string">"structure that should have been caught "</span></span> <span class="hljs-string"><span class="hljs-string">"by the JSON validator."</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!error-&gt;empty() || bad_message) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::move(error_result);</code> </pre> <br>  I hope I could explain why I did not study the report carefully.  This is a lot of time consuming work. <br><br><h2>  The percentage of false positives </h2><br>  I can not say what the percentage of false positives.  First of all, I couldn‚Äôt even see the log to the end and don‚Äôt know the exact number of errors detected by PVS-Studio.  Secondly, it makes no sense to talk about the percentage of false positives without first setting the analyzer. <br><br>  If you configure the PVS-Studio analyzer, you can expect 10-15% of false positives.  An example of such a setting is described in the article " <a href="https://www.viva64.com/ru/b/0523/">Characteristics of the PVS-Studio analyzer on the example of EFL Core Libraries, 10-15% of false positives</a> ." <br><br>  Of course, it is possible to perform a similar setup for Chromium, but it is irrational to do this only in order to demonstrate some numbers in the article.  This is a big job that we are ready to do, but for a fee.  Google may well attract our team to configure the analyzer and, at the same time, to edit all the errors found.  Yes, consider this a <a href="https://www.viva64.com/ru/b/0500/">hint</a> . <br><br>  Customization, clearly, is possible and will give a good result.  For example, about HALF of all false positives is associated with the use of the DCHECK macro in the code. <br><br>  This is what this macro looks like: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LAZY_STREAM(stream, condition) \ !(condition) ? (void) 0 : ::logging::LogMessageVoidify() &amp; (stream) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DCHECK(condition) \ LAZY_STREAM(LOG_STREAM(DCHECK), !ANALYZER_ASSUME_TRUE(condition))\ &lt;&lt; </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Check failed: "</span></span></span><span class="hljs-meta"> #condition </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">". "</span></span></span></span></code> </pre> <br>  From the point of view of the PVS-Studio analyzer, this is just some kind of condition check and a set of actions, after which the execution of the rest of the code continues. <br><br>  As a result, the analyzer generates false warnings, for example, for such a code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Value::Equals(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Value* other) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { DCHECK(other); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == *other; }</code> </pre> <br>  PVS-Studio reports: <a href="https://www.viva64.com/ru/w/v1004/">V1004</a> CWE-476 The 'other' pointer was used unsafely after it was verified against nullptr.  Check lines: 621, 622. values.cc 622 <br><br>  From the point of view of the analyzer, the <i>other</i> pointer is checked for <i>nullptr</i> equality.  But regardless of whether the <i>other is a</i> null pointer or not, its dereference will occur next.  The analyzer considers similar actions suspicious. <br><br>  The <i>DCHECK</i> macro is a type of <i>assert</i> macro.  But if the analyzer knows about <i>assert</i> , then he does not understand what <i>DCHECK</i> is.  To better explain what is happening, I will write pseudocode: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T* ptr)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ptr) LogMessage(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> == *ptr; }</code> </pre> <br>  This is how the PVS-Studio analyzer sees the code.  First, the pointer is checked for equality <i>nullptr</i> .  If the pointer is null, then the <i>LogMessage</i> function is <i>called</i> .  In this case, the function is not marked as not returning control.  So, regardless of whether the <i>ptr is a</i> null pointer or not, the function will continue to be executed. <br><br>  Further the pointer is dereferenced.  But there was a test, where he was checked for equality to zero!  Therefore, the pointer may be null and the analyzer signals a problem in the code.  This is how the analyzer generates a lot of absolutely correct, but useless messages. <br><br>  By the way, such a macro implementation is confusing not only PVS-Studio.  Therefore, for the analyzer built into Visual Studio, a special ‚Äúbackup‚Äù was made: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(_PREFAST_) &amp;&amp; defined(OS_WIN) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// See comments on the previous use of __analysis_assume. #define DCHECK(condition) \ __analysis_assume(!!(condition)), \ LAZY_STREAM(LOG_STREAM(DCHECK), false) \ &lt;&lt; "Check failed: " #condition ". " #define DPCHECK(condition) \ __analysis_assume(!!(condition)), \ LAZY_STREAM(PLOG_STREAM(DCHECK), false) \ &lt;&lt; "Check failed: " #condition ". " #else // !(defined(_PREFAST_) &amp;&amp; defined(OS_WIN))</span></span></span></span></code> </pre> <br>  If you make a similar backup for the PVS-Studio analyzer, the picture with false positives will change dramatically.  In my opinion, half of the false positives immediately disappear.  Yes, exactly half.  The thing is that the <i>DCHECK</i> macro <i>is</i> used a huge number of times. <br><br><h2>  Other publications </h2><br>  This introductory article ends, and here I will gradually post links to other articles.  Thanks for attention. <br><br><ol><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/347594/">Beautiful Chromium and gnarled memset</a> . </li><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/347668/">Break and fallthrough operator</a> . </li><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/347746/">Chromium: memory leaks</a> . </li><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/347826/">Chromium: typos</a> . </li><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/347938/">Chromium: using invalid data</a> . </li><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/348098/">Why it is important to check that the malloc function returned</a> . </li><li>  <a href="https://habrahabr.ru/company/pvs-studio/blog/348134/">Chromium: other errors</a> . </li></ol><br><br><div style="text-align:center;"> <a href="https://www.viva64.com/en/b/0552/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Andrey Karpov.  <a href="https://www.viva64.com/en/b/0552/">Chromium: About the Sixth Check of the Project</a> . </div><p>Source: <a href="https://habr.com/ru/post/347536/">https://habr.com/ru/post/347536/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347524/index.html">Major advances in natural language processing in 2017</a></li>
<li><a href="../347526/index.html">Telegram-bot for Redmine. How to simplify the life of yourself and people</a></li>
<li><a href="../347528/index.html">NLog extension for error monitoring</a></li>
<li><a href="../347530/index.html">Can a JavaScript construct (a == 1 && a == 2 && a == 3) be true?</a></li>
<li><a href="../347534/index.html">All the pain of p2p development</a></li>
<li><a href="../347538/index.html">MODx Revo workflow. Workflow organization, version control and deployment</a></li>
<li><a href="../347540/index.html">Legal status of cryptocurrency - the survey is conducted by the bot of the University Innopolis</a></li>
<li><a href="../347542/index.html">Implementing fork () without MMU</a></li>
<li><a href="../347544/index.html">Measurements as a way to openness</a></li>
<li><a href="../347546/index.html">Fintech Digest: Amazon Go generates a sea of ‚Äã‚Äãtransactions, and biometrics will penetrate all Mastercard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>