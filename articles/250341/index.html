<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>External hardware driver for 1C on the example of the Maria-301MTM fiscal recorder</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When implementing projects on 1C, one often comes across various devices and their interfaces. As long as devices exist on ancient RS232 there will be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>External hardware driver for 1C on the example of the Maria-301MTM fiscal recorder</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/files/c54/4b6/a6d/c544b6a6d6494f4f95b2bdaf3f4e7d99.png" alt="image"><br>  When implementing projects on 1C, one often comes across various devices and their interfaces.  As long as devices exist on ancient RS232 there will be a need for external components of this kind.  As a rule, there is documentation with the device, which often contains a system of commands and a driver that is distributed ‚Äúas is‚Äù.  Very often, the drivers "as they are" leave us to expect better.  I propose to plunge into system programming a little and solve this question for myself once and for all. <br><br>  An excellent <a href="http://habrahabr.ru/post/191014/">article</a> contains an example and a sufficient description of what is what, what is where to change.  The example is compiled.  For a quick start, a great article.  A similar example is freely distributed by 1C and is lying in a heap of rubbish on an <a href="http://its.1c.ru/db/metodtorg">ITS disk</a> .  Many times flashed in the eyes but it was laid on the far shelf with the label "must-examine." <br><a name="habracut"></a><br>  For simplicity, the external component hereinafter will be called the driver. <br><br>  <b>1. Refusal of OLE32 in favor of the Native API.</b> <br>  Heavy memories of registering OLE32 components, and the horror of registering them under Windows 7, prompted the consideration that the driver should support the Native API.  Registering such an external component looks like: <br><pre><code class="1c hljs"><span class="hljs-built_in"><span class="hljs-built_in"></span></span>(, <span class="hljs-string"><span class="hljs-string">"prn"</span></span>, <span class="hljs-class"><span class="hljs-class"></span></span>.Native);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.prn.Maria2"</span></span>);</code> </pre> <br>  In this case, no action of the regsvr32 type.  And as far as I know, OLE32 has long been non-flagship technology Microsoft. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>2. Storing the driver itself as part of processing or configuration.</b> <br>  The driver file is inserted into the 1C layout as binary data and, if necessary, we unpack it into the user's temporary directory. <br><pre> <code class="1c hljs"> = <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>);  = <span class="hljs-built_in"><span class="hljs-built_in"></span></span>() + <span class="hljs-string"><span class="hljs-string">"AddInNewMaria.dll"</span></span>; .(); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(, <span class="hljs-string"><span class="hljs-string">"prn"</span></span>, <span class="hljs-class"><span class="hljs-class"></span></span>.Native);  = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.prn.Maria2"</span></span>);</code> </pre><br><br>  <b>3. Implementation of the driver interface.</b>  <b>Moving the command logic to the 1C side.</b> <br>  Initially, when writing a driver, the ideology of existing drivers was used.  DemoComp.Make up (MultiRaz). <br><pre> <code class="1c hljs">.NullCheck(); .CancelCheck();</code> </pre><br>  In essence, the driver was repeated, of course, without restrictions imposed by the manufacturer.  But this heredity was painful and pernicious.  Every six months there is a need to add some commands, change existing ones. <br>  A universal <a href="https://github.com/tarasii/1c_rs232">RS232 port driver for 1C</a> was written.  It was tested with a Huawei-1550 usb modem and with Maria.  For this driver, you need to rewrite the service processing for 1C. <br>  After the next "improvement", the idea of ‚Äã‚Äãbringing the logic of commands to the 1C side was born.  The driver deals only with the implementation of the transport protocol.  System programmers rejoice.  Now the driver command looks like: <br><pre> <code class="1c hljs">.(<span class="hljs-string"><span class="hljs-string">"NULL"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  </span></span></code> </pre><br>  And yes, to the delight of each programmer, 1C Native API gives the opportunity to call functions in Russian (Russian function aliases). <br><br>  4. Record exchange protocol. <br>  To write to the file maria.log in the directory of temporary files of user commands and reactions to them, you must: <br><pre> <code class="1c hljs"> = <span class="hljs-keyword"><span class="hljs-keyword"></span></span>(<span class="hljs-string"><span class="hljs-string">"AddIn.prn.Maria2"</span></span>); .();</code> </pre><br>  The time and the type of event are written in the file: c - command;  and - the answer;  u is a compound;  t is the number of cycles to get a response;  e is an error. <br><pre> <code class="tex hljs">[20150210205009]t: 1 8 [20150210205009]u:READY  [20150210205009]c:SYNC  [20150210205009]t: 1 29 [20150210205009]a:WAIT SYNC DONE READY  [20150210205009]c:CNAL  [20150210205009]t: 1 141 [20150210205009]a:WAIT CNAL2013120510200020150210200500000000000000000000000000000000000000000000000000000000000000000000000020131205800000uDONE READY  [20150210205009]c:UPAS1111111111' ¬¶“ê  [20150210205009]t: 1 22 [20150210205009]a:WAIT DONE READY  [20150210205009]c:NREP  [20150210205012]t: 18 52 [20150210205012]a:WAIT NREP5100 PRN SOFTREGIST DONE READY  [20150210205012]e:35</code> </pre><br><br>  Here is the minimum set necessary to "earn".  Now a little about the future: <br><br>  <b>5. Other devices of this class.</b> <br>  As planned, it is not difficult to replace the transport protocol of Mary with a protocol, for example, X-a.  It would be possible to talk about the driver family.  The skeleton of the basic necessary functions is ready. <br><br>  <b>6. External events.</b> <br>  In the procedures for implementing the transport protocol, it is necessary to switch to threads, and to signal the completion of the command to an external event.  I want to do it this way, but a little something is missing: time or knowledge, or both.  And the rock ‚Äúalready works like this‚Äù, ‚Äúdon't touch‚Äù works, cools down the heat of the rush a little. <br><br>  <b>7. Collaboration.</b> <br>  The plans are to write a simple web service that would accept commands, organize a queue of commands and redirect them to the device.  Service processing in this case will look similar, the teams will not change.  Only the object initialization will change. <br><br>  <a href="https://github.com/tarasii/Maria301dllfor1C">Link to the project on github</a> <br>  The project consists of a Visual Studio project, demonstration of commands on 1C (in the managed application module) and processing service for 1C. </div><p>Source: <a href="https://habr.com/ru/post/250341/">https://habr.com/ru/post/250341/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250331/index.html">Non-standard top security news: January</a></li>
<li><a href="../250333/index.html">Digest of good educational programs for IT-specialists and sympathizers: in Moscow and online</a></li>
<li><a href="../250335/index.html">How does ABAP Secure Storage work in SAP?</a></li>
<li><a href="../250337/index.html">We are forbidden to even talk about cryptocurrency?</a></li>
<li><a href="../250339/index.html">TLS hacking with cash prize</a></li>
<li><a href="../250343/index.html">PSR-7 in examples</a></li>
<li><a href="../250345/index.html">Pack the cluster in a box!</a></li>
<li><a href="../250347/index.html">Password cracking on Mac with Arduino and OpenCV</a></li>
<li><a href="../250349/index.html">The results of the Olympiad on programming among schoolchildren</a></li>
<li><a href="../250353/index.html">Webinars on new features RAD Studio XE7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>