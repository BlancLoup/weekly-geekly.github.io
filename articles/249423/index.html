<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Find typos in ** kwargs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As the project expands, in which I now take an active part, I began to increasingly encounter similar typos in the function argument names, as in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Find typos in ** kwargs</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/110/457/1c0/1104571c08334409b96849bd1515e06a.png" align="right" width="400">  As the project expands, in which I now take an active part, I began to increasingly encounter similar typos in the function argument names, as in the picture on the right.  Debugging was especially costly for such errors in the class constructor, when, with a long chain of inheritance, the incorrect parameter of the base class was passed, or not transmitted at all.  Redesigning interfaces to special user structures like namedtuple instead of ** kwargs had several problems: <br><br><ul><li>  Worsened user interaction.  You need to pass a specially constructed object to the function.  It is not clear what to do with optional arguments. </li><li>  Complicated the development.  When inheriting classes, the corresponding argument structures must be inherited.  With namedtuple, it won't work, you need to write your own tricky class.  A bunch of implementation work. </li><li>  And most importantly, it still did not completely save from typos in the names. </li></ul><br>  The solution, which I finally came to, cannot protect 100% of all possible cases, however, in those required 80% (in my project, 100%) it does an excellent job.  In short, it consists in analyzing the source (byte) code of the function, building a matrix of distances between the found "real" names and those transmitted from the outside and printing warnings according to specified criteria.  <a href="https://github.com/vmarkovtsev/kwarg_misprints_detection">Sources</a> <br><a name="habracut"></a><br><h4>  Tdd </h4><br>  So, first set the task accurately.  The following example should print 5 ‚Äúsuspicious‚Äù warnings: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(arg1, arg2=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, **kwargs)</span></span></span><span class="hljs-function">:</span></span> kwa1 = kwargs[<span class="hljs-string"><span class="hljs-string">"foo"</span></span>] kwa2 = kwargs.get(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) kwa3 = kwargs.get(<span class="hljs-string"><span class="hljs-string">"baz"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arg1 + arg2 + kwa1 + kwa2 + kwa3 res = foo(<span class="hljs-number"><span class="hljs-number">0</span></span>, arg3=<span class="hljs-number"><span class="hljs-number">100</span></span>, foo=<span class="hljs-number"><span class="hljs-number">10</span></span>, fo=<span class="hljs-number"><span class="hljs-number">2</span></span>, bard=<span class="hljs-number"><span class="hljs-number">3</span></span>, bas=<span class="hljs-number"><span class="hljs-number">4</span></span>, last=<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br><ol><li>  Instead of arg2 passed arg3 </li><li>  Instead of bar or baz passed bas </li><li>  Instead of the bar passed bard </li><li>  Besides foo passed fo </li><li>  last generally superfluous </li></ol><br>  Similarly, in the example with classes and inheritance, there should be the same warnings plus one more (instead of boo, bog was passed): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, arg1, arg2=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self.kwa0 = arg2 self.kwa1 = kwargs[<span class="hljs-string"><span class="hljs-string">"foo"</span></span>] self.kwa2 = kwargs.get(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>) self.kwa3 = kwargs.get(<span class="hljs-string"><span class="hljs-string">"baz"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bar</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Foo)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, arg1, arg2=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super(Bar, self).__init__(arg1, arg2, **kwargs) self.kwa4 = kwargs.get(<span class="hljs-string"><span class="hljs-string">"boo"</span></span>) bar = Bar(<span class="hljs-number"><span class="hljs-number">0</span></span>, arg3=<span class="hljs-number"><span class="hljs-number">100</span></span>, foo=<span class="hljs-number"><span class="hljs-number">10</span></span>, fo=<span class="hljs-number"><span class="hljs-number">2</span></span>, bard=<span class="hljs-number"><span class="hljs-number">3</span></span>, bas=<span class="hljs-number"><span class="hljs-number">4</span></span>, last=<span class="hljs-number"><span class="hljs-number">5</span></span>, bog=<span class="hljs-number"><span class="hljs-number">6</span></span>)</code> </pre><br><h4>  Task plan </h4><br><ul><li>  For the first example with a function, we will make a smart decorator, for the second with classes, we will make a metaclass.  They must share all the internal complex logic and in fact do not differ in any way.  Therefore, we first make an internal micro API and on it we are already doing the <s>userspace</s> user API.  The decorator called detect_misprints, and the metaclass KeywordArgsMisprintsDetector (heavy Java / C # legacy, aha). </li><li>  The idea of ‚Äã‚Äãthe solution was in analyzing the bytecode and finding the distance matrix.  These are independent steps, so the micro API will consist of two corresponding functions.  I called them get_kwarg_names and check_misprints. </li><li>  To analyze the code, use the standard <a href="https://docs.python.org/3/library/inspect.html">inspect</a> and <a href="https://docs.python.org/3/library/dis.html">dis</a> , to calculate the distance between the lines - <a href="https://github.com/gfairchild/pyxDamerauLevenshtein">pyxDamerauLevenshtein</a> .  The requirements of the project were compatibility with two and three, as well as PyPy.  As you can see, dependencies <s>raspberries do not spoil</s> compatible with these requirements. </li></ul><br><h4>  get_kwarg_names (extracting names from code) </h4><br>  There should be a footcloth code, but I'd rather give you a <a href="https://github.com/vmarkovtsev/kwarg_misprints_detection/blob/master/kwarg_misprints_detection.py">link</a> to it.  A function takes as input a function <s>that takes as input a function that ...</s> and must return the set of named arguments found.  I am not particularly commentary, so briefly go through the main points. <br>  The first thing to do is to find out if the function has any ** kwargs.  If not, return the void.  Next, we specify the name of the "double star", because ** kwargs is a generally accepted agreement and nothing more.  Then the logic, as often happens in the portable version of the code, splits, but not as usual on the branches for two and for three, and &lt;3.4 and&gt; =.  The fact is that the imputed support for disassembling (along with the total refactoring of dis) appeared precisely in 3.4.  Before that, as strange as it is, without third-party modules one could only print pythonium bytecode in stdout (sic!).  The <a href="https://docs.python.org/3/library/dis.html">dis.get_instructions ()</a> function returns a generator of instances of all bytecode instructions of the object being analyzed.  In general, as far as I understand, the only reliable description of the bytecode is the <a href="">header of its opcodes</a> , which, of course, is sad, because the deployment of specific instructions to opcodes had to be determined experimentally. <br>  We will match two patterns: var = kwargs ["key"] and kwargs.get ("key" [, default]). <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dis <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dis &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(**kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> kwargs[<span class="hljs-string"><span class="hljs-string">"key"</span></span>] &gt;&gt;&gt; dis(foo) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> LOAD_FAST <span class="hljs-number"><span class="hljs-number">0</span></span> (kwargs) <span class="hljs-number"><span class="hljs-number">3</span></span> LOAD_CONST <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-string"><span class="hljs-string">'key'</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span> BINARY_SUBSCR <span class="hljs-number"><span class="hljs-number">7</span></span> RETURN_VALUE &gt;&gt;&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(**kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> kwargs.get(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;&gt;&gt; dis(foo) <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> LOAD_FAST <span class="hljs-number"><span class="hljs-number">0</span></span> (kwargs) <span class="hljs-number"><span class="hljs-number">3</span></span> LOAD_ATTR <span class="hljs-number"><span class="hljs-number">0</span></span> (get) <span class="hljs-number"><span class="hljs-number">6</span></span> LOAD_CONST <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-string"><span class="hljs-string">'key'</span></span>) <span class="hljs-number"><span class="hljs-number">9</span></span> LOAD_CONST <span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-number"><span class="hljs-number">12</span></span> CALL_FUNCTION <span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span> positional, <span class="hljs-number"><span class="hljs-number">0</span></span> keyword pair) <span class="hljs-number"><span class="hljs-number">15</span></span> RETURN_VALUE</code> </pre><br>  As you can see, in the first case it is a combination of LOAD_FAST + LOAD_CONST, in the second LOAD_FAST + LOAD_ATTR + LOAD_CONST.  Instead of ‚Äúkwargs‚Äù in the instruction argument, one should look for the name of the ‚Äúdouble star‚Äù found at the beginning.  I refer to well-versed people for a detailed description of bytecode, well, we will be getting things done, that is, move on. <br>  And then we have an ugly workaround for old versions of Python on regular expressions.  With the help of inspect.getsourcelines () we get a list of the source lines of the function, and we draw on each precompiled regular.  This method is even worse than bytecode analysis, for example, expressions consisting of several lines or several expressions with a semicolon are not defined in the current form.  Well, that's what he does and workaround so as not to strain too much ... However, this part can be objectively improved, I want a pull request :) <br><br><h4>  check_misprints (distance matrix) </h4><br>  <a href="https://github.com/vmarkovtsev/kwarg_misprints_detection/blob/master/kwarg_misprints_detection.py">Code</a>  At the input we get the result of the previous stage, the named arguments passed, the mysterious tolerance and the function to make warnings.  For each argument passed, you need to find the editing distance to each "real", i.e.  which found in the analysis of baytkod.  In fact, there is no need to consider stupidly the entire matrix as a whole, if you have already found the perfect match, you can not continue.  And, of course, the matrix is ‚Äã‚Äãsymmetric, and, therefore, you can only calculate its half.  I think you can still somehow optimize, but with a typical number of kwarg-s less than 30, n <sup>2</sup> will come down.  We will calculate the <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B0%25D1%2581%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%2594%25D0%25B0%25D0%25BC%25D0%25B5%25D1%2580%25D0%25B0%25D1%2583_%25E2%2580%2594_%25D0%259B%25D0%25B5%25D0%25B2%25D0%25B5%25D0%25BD%25D1%2588%25D1%2582%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25B0">distance of Damerau-Levenshteyn</a> as widely known, popular and understandable to the author :) In Habr√©, for example, they wrote about him.  Several packages are written for it under Python, I chose PyxDamerauLevenshtein for portability of Cython, on which it is written and for optimal linear memory consumption. <br>  Then the matter of technology: if for the argument there was not a single even remotely similar standard, we declare its categorical uselessness.  If there are several matches with a distance of less than tolerance - declare our vague suspicions. <br><br><h4>  detect_misprints </h4><br>  <a href="https://github.com/vmarkovtsev/kwarg_misprints_detection/blob/master/kwarg_misprints_detection.py">A classic decorator</a> , we pre-calculate the ‚Äúreal‚Äù names of the named arguments (sorry for tautology), and at each call, we pull check_misprints. <br><br><h4>  KeywordArgsMisprintsDetector </h4><br>  <a href="https://github.com/vmarkovtsev/kwarg_misprints_detection/blob/master/kwarg_misprints_detection.py">Our metaclass</a> will intercept the moment the class type is created (__init__, in which once in the lifetime, the real names of the daes will be computed) and the instantiation of the class instance (__call__ that pulls check_misprints).  The only point is that the class has <a href="http://habrahabr.ru/post/62203/">mro</a> and base classes, in the constructors of which, perhaps, ** kwargs are also used.  So in __init __- e we have to run through all base classes and add the names of each argument to the common set. <br><br><h4>  How to use </h4><br>  Simply add the decorator described above to the function or the metaclass to the class. <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@detect_misprints def foo(**kwargs): ... @six.add_metaclass(KeywordArgsMisprintsDetector) class Foo(object): def __init__(self, **kwargs): ...</span></span></code> </pre><br><h4>  Summary </h4><br>  I considered one of the ways to deal with typos in names ** kwargs, and in my case he solved all the problems and met all the requirements.  First, we analyzed the bytecode of a function or just the source code on older versions of Python, and then we built a matrix of distances between the names that are used in the function and those transferred by the user.  The distance was calculated according to Damerau-Levenshtein, and at the end, the warning was written in two cases of errors - when the argument is ‚Äúcompletely left‚Äù and when it looks like one of the ‚Äúreal‚Äù ones. <br>  The source code from the article <a href="https://github.com/vmarkovtsev/kwarg_misprints_detection">is posted on GitHub</a> .  I will be glad to fixes and improvements.  I also want to know my opinion, whether this creation should be spread on PyPi. </div><p>Source: <a href="https://habr.com/ru/post/249423/">https://habr.com/ru/post/249423/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249413/index.html">Non-von Neumann computer based on combinatorial logic</a></li>
<li><a href="../249415/index.html">Overview of the most interesting materials on data analysis and machine learning ‚Ññ33 (January 26 - February 1, 2015)</a></li>
<li><a href="../249417/index.html">Breeze Server - we delimit access to objects using attributes</a></li>
<li><a href="../249419/index.html">Methods for modifying machine code: "selection" vs. "Genetic Engineering"</a></li>
<li><a href="../249421/index.html">Robot on RaspberryPi, Arduino and RaspiCam + OpenCV. Part 1 Review</a></li>
<li><a href="../249425/index.html">Pundle - bundler for python</a></li>
<li><a href="../249427/index.html">New invariant of a natural number. Theorem and proof</a></li>
<li><a href="../249429/index.html">On the existence of periodic solutions in the Lorentz system</a></li>
<li><a href="../249431/index.html">Divide by zero is the norm. Part 2</a></li>
<li><a href="../249433/index.html">The study of the site blocking mechanism "Rostelecom" and ways to circumvent it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>