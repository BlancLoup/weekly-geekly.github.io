<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic removal of hung processes in MS SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 


 Often there are situations when some application for some reason holds a connection to the database for a long time. It seems to be a tri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic removal of hung processes in MS SQL Server</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br><p>  Often there are situations when some application for some reason holds a connection to the database for a long time.  It seems to be a trifle, but if such software makes several connections or, even worse, there are several such applications, it is better to deal with this somehow. </p><br><p>  This article is not a guide.  In it, I just wanted to show possible solutions to this problem.  I would be glad if they propose alternative solutions. </p><br><a name="habracut"></a><br><h3>  Decision </h3><br><p>  1) Create a stored procedure that closes all connections or all connections of a specific user to the specified database: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[KillConnect] @databasename <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), <span class="hljs-comment"><span class="hljs-comment">-- @loginname nvarchar(255)=NULL -- AS BEGIN /*          */ SET NOCOUNT ON; SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; if(@databasename is null) begin ;THROW 50000, '   !', 0; end else begin declare @dbid int=db_id(@databasename); if(@dbid is NULL) begin ;THROW 50000, '    !', 0; end else if @dbid &lt;= 4 begin ;THROW 50000, '     !', 0; end else begin declare @query nvarchar(max); set @query = ''; select @query=coalesce(@query,',' ) +'kill ' +convert(varchar, spid) +'; ' from master..sysprocesses where dbid=db_id(@databasename) and spid&lt;&gt;@@SPID and (loginame=@loginname or @loginname is null); if len(@query) &gt; 0 begin begin try exec(@query); end try begin catch end catch end end end END GO</span></span></code> </pre> </div></div><br><p>  It is not needed in the decision.  This stored procedure helps to manually disconnect all connections to the database or to a specific user for further database manipulations. </p><br><p>  2) Create a stored procedure to remove all hung processes: </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [__] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[KillFullOldConnect] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,       . !   master, tempdb, model  msdb    . ,  distribution       . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> UNCOMMITTED; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>,<span class="hljs-string"><span class="hljs-string">','</span></span> ) +<span class="hljs-string"><span class="hljs-string">'kill '</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">convert</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, spid) +<span class="hljs-string"><span class="hljs-string">'; '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> master..sysprocesses <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dbid&gt;<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> [last_batch]&lt;<span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>,<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">getdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [last_batch] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> try exec(@<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> try <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> catch <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> catch <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> </div></div><br><p>  This stored procedure deletes all those connections that were last made more than a day ago.  Also, this stored procedure does not affect the main system databases (master, tempdb, model, and msdb).  Nothing terrible will happen, because if access is requested and the connection is disconnected, then a new connection will be created for this application with the requesting user. </p><br><p>  And now the stored procedure from item 2 is enough to run once a day in the task of the Agent: </p><br><pre> <code class="sql hljs">exec [__].[srv].[KillFullOldConnect];</code> </pre> <br><p>  It is better, of course, to impose this call on a try-catch block in order to handle possible exception calls. </p><br><h3>  Result </h3><br><p>  This article has reviewed an example of the implementation of stored procedures for closing a connection to a database (all or a particular user) and completing hung processes.  An example of the automatic daily launch of the task of terminating hung processes was also considered.  This reduces the number of dead connections to the server.  Removing all connections to the database allows you to change some properties for it, as well as immediately kill the process that creates a problem. </p><br><h3>  Sources: </h3><br><p>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms179881.aspx">Sysprocesses</a> <br>  <a href="https://msdn.microsoft.com/ru-ru/library/ms173730(v%3Dsql.110).aspx">Kill</a> <br>  ¬ª <a href="https://msdn.microsoft.com/ru-ru/library/ms186274(v%3Dsql.110).aspx">Db_id</a> <br>  " <a href="https://msdn.microsoft.com/ru-ru/library/ms189535(v%3Dsql.110).aspx">@@ SPID</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/314632/">https://habr.com/ru/post/314632/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314620/index.html">Product Design Digest October 2016</a></li>
<li><a href="../314622/index.html">Setting up email notifications in MS SQL Server</a></li>
<li><a href="../314624/index.html">EF Core: Setting the name of the generated models in Scaffolding</a></li>
<li><a href="../314628/index.html">Auto-collection of data on completed tasks in MS SQL Server</a></li>
<li><a href="../314630/index.html">Auto-collection of data about changes in database schemas in MS SQL Server</a></li>
<li><a href="../314642/index.html">Remote work: 50 shades of freedom</a></li>
<li><a href="../314644/index.html">Is DevOps afraid of modern QA?</a></li>
<li><a href="../314650/index.html">Experience preparing for the exam on the status of RHCVA (Red Hat Certified Virtualizaion Administrator)</a></li>
<li><a href="../314652/index.html">Paul Graham: Define "property"</a></li>
<li><a href="../314654/index.html">In the twentieth time about the interview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>