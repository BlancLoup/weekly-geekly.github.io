<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We connect a wireless radiation dosimeter to the ‚ÄúPeople's monitoring‚Äù service via Raspberry PI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 In this article I will explain how to connect the AtomTag dosimeter via the Bluetooth module Bluegiga BLED112 to the Raspberry PI in or...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We connect a wireless radiation dosimeter to the ‚ÄúPeople's monitoring‚Äù service via Raspberry PI</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  In this article I will explain how to connect the AtomTag dosimeter via the Bluetooth module Bluegiga BLED112 to the Raspberry PI in order to transfer the measurement results to the ‚Äú <a href="http://narodmon.ru/">People Monitoring</a> ‚Äù service. <br><br>  AtomTag is a Bluetooth Low Energy dosimeter for a smartphone and tablet with a Geiger SBM-20 counter.  The device will transmit to the server: dose rate, statistical error and battery charge.  At the end of the article we will see how dosimeter readings are related to weather phenomena. <br><a name="habracut"></a><br><blockquote>  People's monitoring (narodmon.ru) is a SaaS geoinformation service for displaying on the world map and control (on PCs, smartphones and other gadgets) sensor readings of its participants (temperature, humidity, atmospheric pressure, wind speed and direction, radiation, power consumption and many others) as well as private and city webcams for public or private (private) viewing. </blockquote><br><h3>  Generic Attribute Profile (GATT) </h3><br>  AtomTag dosimeter supports GATT profile.  Bluetooth terminology, a <b>profile</b> is a set of features or capabilities available for a particular Bluetooth device. <br><br>  The GATT profile defines a hierarchical data storage structure.  The structure is shown in the figure: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/269/598/39a/26959839a12b4b558b6dc0874a8654bc.png"><br><br>  <b>A service</b> is a container that contains several attributes called characteristics.  All services have unique identifiers UUID and HANDLE.  For example, the dosimeter has 2 services: <br><br>  <b>1.</b> Service for the user, which contains characteristics for reading measurement results and writing user settings (audio alarm settings). <br><br>  <b>2. A</b> service that contains characteristics for storing factory settings: calibration coefficients, device name, etc. <br><br>  <b>Characteristic</b> - consists of: <br><br>  <b>1.</b> Values ‚Äã‚Äã(usually no more than 20 bytes). <br><br>  <b>2.</b> Descriptor - this describes the purpose of the characteristic, the type of stored data, and the settings of the characteristic. <br><br>  <b>3.</b> Unique UUID and HANDLE. <br>  The data we are interested in: the number of registered pulses and the charge of the battery are stored in the characteristics. <br><br><h3>  BLED112 </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6c1/1c4/31b/6c11c431bcdf48d89c39ed280d75d598.jpg" width="240"></div><br>  The module is a USB-CDC device, which is defined in the system as / dev / ttyACM0 and does not require installation of any drivers on Raspbian Jessie Lite with kernel version 4.4.  Data exchange with the module is also performed as with a serial port.  The exchange protocol is binary.  We will not write the protocol parser ourselves, since  This module has quite a lot of commands and will take the C language SDK from the manufacturer.  The link to the SDK will be at the end of the article. <br><br><h3>  Raspberry PI Software </h3><br>  We will need the following files from the SDK: <br><br>  <b>1.</b> cmd_defs.c, cmd_defs.h <br>  <b>2.</b> apitypes.h <br>  <b>3.</b> commands.c <br>  <b>4.</b> uart.c, uart.c <br><br>  The API is callback-based.  In the commands.c file, the stub implementations are declared for unused callbacks.  The SDK defines 2 types of messages that may come from the module: the event and the result of the operation.  In our program, we will receive data from the dosimeter using alerts that are sent by the dosimeter every 2 seconds when the measurement characteristic changes.  As a result, once in 2 seconds an event from the module will come and the corresponding callback will be called. <br><br>  Let's analyze the connection and data exchange algorithm with the dosimeter: <br><br>  <b>1.</b> Opens port <code>/dev/ttyACM0</code> <br><br>  <b>2.</b> Restart the Bluetooth module using the function <code>api ble_cmd_system_reset();</code> <br><br>  <b>3.</b> Connect to the device by its address using <code>ble_cmd_gap_connect_direct()</code> <br><br>  <b>4. We</b> request the list of device services and ranges of values ‚Äã‚Äãin which the HANDLs of the characteristics in these services are <code>ble_cmd_attclient_read_by_group_type()</code> <br><br>  <b>5.</b> After the <code>ble_evt_attclient_procedure_completed</code> event, <code>ble_evt_attclient_procedure_completed</code> request the feature list with <code>ble_cmd_attclient_find_information().</code> <br><br>  <b>6.</b> In the <code>ble_evt_attclient_find_information_found</code> event, <code>ble_evt_attclient_find_information_found</code> remember the HANDLs of the measurement characteristic and the Client Characteristic Configuration Descriptor (CCCD). <br><br>  <b>7.</b> In the <code>ble_evt_attclient_procedure_completed</code> event, <code>ble_evt_attclient_procedure_completed</code> alerts.  In the previous paragraph, we learned the HANDLE of the CCCD descriptor and can read or write it.  To enable alerts, you need to set the "notifications enabled" flag in the CCCD descriptor using the <code>ble_cmd_attclient_attribute_write()</code> function.  After disconnecting from the device, the value of this descriptor will be reset. <br><br>  <b>8.</b> Now, when changing the values ‚Äã‚Äãof the device characteristics, the event <code>ble_evt_attclient_attribute_value(const struct ble_msg_attclient_attribute_value_evt_t *msg)</code> will be <code>ble_evt_attclient_attribute_value(const struct ble_msg_attclient_attribute_value_evt_t *msg)</code> .  You can distinguish one characteristic from another by parameter: <br> <code>msg-&gt;atthandle. <br></code> <br>  Define the structure of the values ‚Äã‚Äãof the measuring characteristics: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed__</span></span></span><span class="hljs-class">)){</span></span> uint8 status_flags; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dose; <span class="hljs-comment"><span class="hljs-comment">//     float doserate_search; //     uint16 pulses_last2sec; //-       2  uint8 battery; //     0  100 uint8 temperature; //   } atomtag_measurement_t; atomtag_measurement_t measurement_char;</span></span></code> </pre> <br>  Since the order of bytes in the value of the measuring characteristic is little endian, it is enough to copy all these bytes into the packed structure: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>((uint8 *)&amp;measurement_char, msg-&gt;value.data, msg-&gt;value.len);</code> </pre> <br>  The dose rate will be calculated in the time interval of 6 minutes.  We will not send testimony to the server narodmon.ru no more than once every 6 minutes.  In addition to the dose rate, we will send the battery charge and statistical error.  All calculations take place in the <code>ble_evt_attclient_attribute_value()</code> <code>main.c.</code> in <code>main.c.</code> <br><br>  The readings are sent to port 8283 narodmon.ru via the tcp protocol.  The response from the server is not verified.  The text protocol: <br><br><pre> <code class="hljs mel">#<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>\n #R1#<span class="hljs-number"><span class="hljs-number">10.5</span></span>#err = <span class="hljs-number"><span class="hljs-number">10</span></span>%, batt = <span class="hljs-number"><span class="hljs-number">100</span></span>%\n ##</code> </pre> <br>  First comes the MAC address of the device (6 bytes).  The source MAC address is hammered for example, do not forget to change it!  Further, where 10.5 is the dose rate in ŒºR / h, err is the statistical error <br>  Compiled all this with gcc: <br><br><pre> <code class="hljs swift">gcc -std=gnu99 -lm main.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> cmd_def.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> commands.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> uart.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> web.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> -o narodmon-bin</code> </pre> <br>  In order for the program to start automatically after the OS is loaded, I added the following lines before exit 0 to the rc.local file: <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> / ./home/pi/narodmon/narodmon-bin /dev/ttyACM0 <span class="hljs-number"><span class="hljs-number">5</span></span>c:<span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>e:da:e8:<span class="hljs-number"><span class="hljs-number">9</span></span>c</code> </pre> <br>  5c: 31: 3e: da: e8: 9c - the address of the Bluetooth device, which you can find out if you run this program with the scan parameter: <br><br><pre> <code class="hljs">./narodmon-bin /dev/ttyACM0 scan</code> </pre> <br><h3>  results </h3><br>  After a couple of days of device operation, interesting things appeared on the charts.  Here you can see how the dose rate changed during the snowfall.  November 11 at ~ 17: 00‚Äì18: 00 o'clock the freezing rain stopped and it began to snow.  As the thickness of the snow cover increases, the average dose rate decreases.  The dosimeter is installed at a height of 2 meters from the ground. <br><br>  The reduction in dose rate is due to the fact that the snow layer partially shields the natural gamma radiation at the surface of the earth.  Also, the snow layer blocks the access of radon gas to the surface, the decay products of which can be detected with a conventional dosimeter. <br><br>  Now we can estimate the thickness of the snow :) In those days, about 8-10 centimeters of snow fell.  In the world, aerogamming is practiced to assess the thickness of snow in areas where there are hydroelectric power plants, in order to understand what floods to expect in spring.  Only there are used gamma spectrometers with scintillation detectors because of their greater sensitivity. <br><br>  A similar picture is observed on the other dosimeters of the service, national monitoring, although not all of them give data so often and it is not clear which dose rate calculation algorithms are used there. <br><br>  The program can be improved by adding a buffer to which dosimeter readings will be saved during the absence of an Internet connection.  The People‚Äôs Monitoring API allows you to send readings ‚Äúin hindsight‚Äù.  It is also worth connecting a raspberry pi to a bespereboinik.  Despite the simplicity of the design managed to get uptime about thirty days.  A dosimeter on a national monitoring map <a href="http://narodmon.ru/1935">can be found here.</a>  Please do not kick - I'm new to linux. <br><br><img src="https://habrastorage.org/files/a25/70d/311/a2570d3115da46f29626a7154f8e404e.png"><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/02e/f5c/4cc/02ef5c4ccf3947b591801fb3da3f0be7.png" height="400"></div><br><h3>  Links </h3><br>  1. <a href="http://youratom.com/">AtomTag dosimeter</a> <br>  2. <a href="https://www.silabs.com/support/pages/document-library.aspx%3Fp%3DWireless%2520-%2520Bluetooth%26f%3DBluetooth%2520Smart%2520Modules%26pn%3DBLED112">Bluegiga BLED112 SDK and Documentation</a> <br>  3. <a href="http://narodmon.ru/">Service national monitoring</a> <br>  4. <a href="https://www.bluetooth.com/specifications/gatt">Bluetooth LE, specifications</a> <br>  5. <a href="">Source Code</a> <a href=""><br></a>  <a href="">Raspberry PI software</a> <br>  6. <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.ghelius.narodmon">Application for Android service "People's Monitoring"</a> </div><p>Source: <a href="https://habr.com/ru/post/399839/">https://habr.com/ru/post/399839/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../399829/index.html">The history of Konami: from jukeboxes to the largest holding with anime, games and arcade machines</a></li>
<li><a href="../399831/index.html">Peace atom breaks ice: our atomic icebreaking fleet</a></li>
<li><a href="../399833/index.html">Integrating Honeywell security system (Ademco) VISTA 10 with home automation Fibaro</a></li>
<li><a href="../399835/index.html">Boston Dynamics suggests using SpotMini to deliver your robot.</a></li>
<li><a href="../399837/index.html">QEMU Advent Calendar - an easy way to get familiar with unusual operating systems.</a></li>
<li><a href="../399841/index.html">Galaxy Note 7 battery explodes due to aggressive design</a></li>
<li><a href="../399843/index.html">Lectures on bioinformatics</a></li>
<li><a href="../399845/index.html">Mr. Robot killed Hollywood hackers</a></li>
<li><a href="../399847/index.html">Biology of human behavior. Lecture # 2. [Robert Sapolsky, 2010. Stanford]</a></li>
<li><a href="../399849/index.html">Accident of Progress MC-04 - journalism and versions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>