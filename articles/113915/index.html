<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cloud: Cloning disks VS installation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the questions that arise when creating a service (in this case it does not matter, cloud or VDS) is how to create client machines. 

 Most of o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cloud: Cloning disks VS installation</h1><div class="post__text post__text-html js-mediator-article">  One of the questions that arise when creating a service (in this case it does not matter, cloud or VDS) is how to create client machines. <br><br>  Most of our competitors use image cloning, which was once installed and configured by the system administrator.  We use a clean installation from scratch every machine. <br><img src="https://habrastorage.org/getpro/habr/post_images/7e3/1dc/82e/7e31dc82eda44145add91d19a4021c48.png"><br><br>  Below I will try to explain what caused this decision, what both approaches have pros and cons. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  How it all began... </h1>  When the cloud had just acquired the first features, the task of automating the creation of virtual machines arose.  Of course, the first decision lying on the surface was ‚Äútake and bend‚Äù.  Fortunately, all the business there is one team (xe vm-clone).  Next was the need to correct the network settings, the host name and root password.  All work - half a day.  Well, two days with flea fishing. <br><br>  Made?  Made.  Fortunately, even beta testers did not see this version. <br><br><a name="habracut"></a><br>  After analyzing all the negative factors of disk cloning, we still came to the idea of ‚Äã‚Äã"installation".  This process was, to put it mildly, thorny, and it took me about a month and a half, during which I had to very deeply study the specifics of each Linux distribution. <br><br>  The result is that the existing template system allows us to quite simply change the settings of the created machines, and the whole process is not tied to a kind of mystical ‚Äúmaster copy‚Äù, sacred and insanely important. <br><br>  What is a ‚Äúclean install‚Äù?  This is when a virtual machine with an empty disk is created, a special kernel is launched with a special initrd, inside of which is an installer (netinst).  This installer is given a file with answers to questions (each distribution has its own). <br><br>  Actually, what is the difference between cloning a disk of an already installed OS and a full installation (this, of course, is not about the process, but about the result)? <br><br><ol><li>  Unique ssh-keys.  Yes, every ssh server has a private key, which must be unique on each server.  This key (in debian / ubuntu) is generated at installation (and not at the first launch).  And if two client virtual machines have the same private key, it will be a huge security hole, because the server of one client can impersonate the server of another.  Exactly also applies to ssl-certificates and their private keys in Apache and other services that use openssl. </li><li>  When installing SQL server into debian / ubuntu, a special account is created in the database with a randomly generated password so that dpkg can update the databases.  The password for this account must be unique between the virtual machines.  If it is the same, it means that your ‚Äúneighbor in the cloud‚Äù knows the admin password from your sql.  Nicely?  Not really. </li><li>  Date the files were created.  During cloning, you will find that the image creation date refers to the time when the cloud administrator created it.  A part of the files (if the administrator rolls updates) has a completely different date.  Deadly?  Not.  Unpleasant?  Yes. </li><li>  Log files contain extra information - extraneous logins in the authorization log, the installation log in general is full of nonsense of unknown years of origin. </li><li>  The uuids of all possible types (including the file system UUID) are repeated from disk to disk, which makes the word ‚Äúunique‚Äù in the UUID meaningless </li></ol><br>  Of course, all this can be changed and corrected.  If you know about it.  And if you do not know?  Realize the post-fact that there was a hole on several thousand virtual machines due to the fact that someone forgot about another unique identifier in one of the subsystems (in udev, in device-mapper, somewhere else, what are we forgot to think)?  In order to avoid these errors, you need to examine every distribution through.  Each.  And Debian, and Susi, and Centos, and Ubuntu (although Ubuntu, although a fork of Debian, but amassed a very decent amount of differences);  and if one more distribution kit is added? <br><br>  The level of responsibility when cloning increases incredibly.  And disproportionate benefits. <br><br>  But, in fact, the true motivation for using the installation instead of cloning was the ideological purity of the method.  Probably, this may seem strange to someone, but in many matters I want to do not just ‚Äúmake it work‚Äù, but follow the ideology laid down in the architecture.  If distribution authors assume that their distribution will be installed, then it is <em>correct</em> if it is installed. <br><br>  However, a clean installation also has some goodies for users. <br><br>  For example, CentOS users will find in / root the anaconda-ks.cfg file with the settings with which the machine was installed, as well as install.log and install.log.syslog with installation logs.  These files refer specifically to the machine where they are located, and not to any once-delivered machine.  Exactly the same way, users of Debian / Ubuntu will find their own logs in the / var / log / install directory.  About the correct dates for the files I have already written above. <br><br>  To lie, that there are no minuses in the "full installation" compared to cloning a disk, I will not.  They are.  But they all relate only to the time of installation and do not affect the future life of the machine. <br><br>  I will list them: <br><ol><li>  Installation is slower than cloning, especially in situations of small system disks. </li><li>  The installation is more capricious - if the caching proxy ‚Äúhiccups‚Äù at least once, the installation will ‚Äústick‚Äù, in some cases fatal (the installation will hang). </li><li>  It is much more difficult to make changes to the installation; debugging these changes requires the installation procedure to be launched each time. </li></ol><br>  As you can see, none of these drawbacks concern the life of the machine after the installation is completed, all the problems are either the torment of the installation itself or problems in planning and deployment.  Thus, once having overcome the problem, we get the most pure systems that correspond to the idea of ‚Äã‚Äãthe creators of the distribution. <br><br>  However, I do not want to curse competitors frantically.  The variant with cloning is quite viable, and with due diligence it will make the machines quite similar to ‚Äúfreshly installed‚Äù ones.  Perhaps the only question for me is "how similar" ... <br><br><h1>  How it works? </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/5a7/6bd/7a3/5a76bd7a3fe6919dd340ea54c5fe9e00.png" align="left">  In the database (the very SCAPI, about which I have not yet told) there is a class of objects of the template.  Template stores a bunch of options for creating a machine - limits on the minimum / maximum memory, disk;  text description, link to icons - in short, everything that is shown to the user when creating the machine (example on the left).  In addition, the most important thing is stored there: the text autoinstall_script.  Each template has its own script, although for practical purposes it is generated from administrative files using a single file for 32-bit and 64-bit versions of the same OS.  This is done by a bunch of variable substitutions, since  The actual text of the 32-bit and 64-bit versions is very different (not just the package names). <br><br>  So, when the user clicks on the ‚Äúinstall‚Äù button, the script sends to the scapi a series of commands (vm-create, vif-create, vdi-create, vbd-create, etc.) that ‚Äúcreate‚Äù the machine.  After that, run the main command - vm-install.  This command takes the parameters required for the installation (such as the host name), takes a script from the database that matches the machine template (the template is transmitted at the time of vm-create) and starts the installation process.  As I wrote above, the ‚Äúinstallation process‚Äù literally means the following: a special kernel, a special initrd, and a bundle of parameters that are passed through the PV-args to the paravirtualized kernel. <br><br>  Inside the initrd each system has its own installer, which wants its own format.  Immediately, as soon as the virtual machine starts up with the kernel / initrd for installation, its settings change to ‚Äúworking‚Äù, with the usual for this distribution kernel and initrd to boot.  (By the way, which kernel to use for loading, also stores the template in itself). <br><br>  There are three installation methods among mainstream distros: preseed, kickstart and autoyast. <br><br>  <b>Preseed</b> is a debian achievement, also used in Ubuntu.  It contains answers to questions that packages can ask through deb mechanisms.  Unfortunately, the answers to these questions are not always described in the documentation - sometimes you have to look inside the deb / udeb files (udeb is such a small deb that stores installer fragments).  It must be said, although debian and ubuntu are very close, the set of answers they have differs significantly enough to be perceived as different operating systems. <br><br>  The main advantage of preseed, the ability to transfer any answers to questions both in the form of a file and in the form of kernel arguments, which allows the ‚Äúcommon‚Äù parameters for machines to be transferred to a static file, and everything that is unique to the machine (name, password, IP address) ) pass it through PV-args.  By the way, Ubuntu preseed handles the installer from debian (the same red-blue in text mode), so no beautiful gui (which desktop users see when installing) is not there. <br><br>  <b>Kickstart</b> - the invention of Red Hat, along with the rest of the features of RHEL was completely transferred to CentOS.  In terms of capabilities, it is somewhat inferior to preseed, which is why we had to invent a whole system of dynamic generation of kickstart with protection from loading by unauthorized machines (it will be very unpleasant if someone downloads your initial password, right?).  Another CentOS piquancy is that its netinstall image does not support Xen, and it has to be patched (replaced by kudzu) before running. <br><br>  <b>Autoyast</b> is an extension of Yast, the configuration system Suse (and OpenSuse, respectively), on the one hand, allows you to do a lot (more precisely, within the framework of the Yast concept, everything), on the other hand, it does not support normal PV-args in exactly the same way.  Plus, autoyast is written in the vivid XML, which is why the size of autoyast.xml is about 5 times bigger than the kickstart and preseed with a much smaller amount of useful information. <br><br>  It is necessary to tell separately about the specifics of installing CentOS.  Because of their excessive adherence to immutability, immediately after installing CentOS, it‚Äôs as ... as a centos.  That is, yum update gives as much as 80+ MB updates on a freshly installed system.  In order not to leave users with ancient systems, yum update had to be included in the% post section for kickstart, which, by the way, explains why centos is put longer than any other system. </div><p>Source: <a href="https://habr.com/ru/post/113915/">https://habr.com/ru/post/113915/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113906/index.html">Fulview Or Fulview Notes: About the Benefits and Harm of the Complete BGP Table</a></li>
<li><a href="../113910/index.html">Connecting the mobile version of the site</a></li>
<li><a href="../113911/index.html">The emergence of trends: the role of traditional media and social media</a></li>
<li><a href="../113913/index.html">First steps for pauershelshikov</a></li>
<li><a href="../113914/index.html">JMeter stress test recipe</a></li>
<li><a href="../113917/index.html">Input device evolution</a></li>
<li><a href="../113918/index.html">End of copyright</a></li>
<li><a href="../113920/index.html">Yulia Tymoshenko started Twitter and scribbles directly from the prosecutor's office</a></li>
<li><a href="../113921/index.html">The best twitter bot has signed 21% of users from the sample</a></li>
<li><a href="../113923/index.html">Android World on MWC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>