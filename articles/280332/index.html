<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Device Guard in Windows 10. Code Integrity Policy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The author of the article is Andrey Kaptelin, a member of the IT community. 
 Device Guard is a set of software and hardware protection technologies a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Device Guard in Windows 10. Code Integrity Policy</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>The author of the article is Andrey Kaptelin, a member of the IT community.</i> </blockquote><br>  Device Guard is a set of software and hardware protection technologies available for devices with Windows 10. The article is devoted to one of the components of Device Guard - the Code Integrity Policy (CI).  Details of the configuration and application of CI can be found <a href="https://channel9.msdn.com/Series/Windows-10-device-protection-with-Device-Guard/01">here</a> . <br><br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://channel9.msdn.com/Series/Windows-10-device-protection-with-Device-Guard/01/player&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgCS4weeKDa0z6bDRPwoFl8V3W7pQ" width="960" height="540"></iframe><br><a name="habracut"></a><br><br><h1>  Purpose of Device Guard </h1><br>  In the modern world, cyber threats develop very quickly.  Protection technologies are no longer keeping pace with the development of malware, both in their number and in the expanding range of attacks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Viruses from fun for singles developed into organized cybercrime.  Automation and low cost of complex attacks leaves no chance even for small companies to go unnoticed. <br><br><img src="https://habrastorage.org/files/ecc/9c0/151/ecc9c0151bdb46a2b0c01c20f54dd79a.png"><br><br>  The classic solution is based on three basic conditions: installed updates, updated antivirus, and lack of administrative privileges.  This is a long-established approach.  However, a program that is completely legal from the point of view of an antivirus can perform undesirable actions and not exploit software vulnerabilities.  This view of security puts any program under suspicion.  One can no longer rely on the list of anti-virus signatures, and analyzing the actions of all programs is rather difficult. <br><br>  New threats require new security solutions, and in Windows 10 they already exist.  One solution is to run only approved software.  This approach has been successfully tested on Windows and Apple mobile platforms.  Absolutely all of the software in them is checked and has a digital signature, on the basis of which the device allows its launch.  On Windows, this feature is provided by a code integrity checking mechanism - Code Integrity (CI). <br><br><img src="https://habrastorage.org/files/1be/912/0be/1be9120beba248ef97e4e445521e57d5.png"><br><br>  Already at the startup stage of the computer, you can control the launch of software signed with trusted certificates.  Further, having a list of your software, you can prevent the launch of something else, and the security problem is solved.  The list of trusted certificates used to sign executable files is a policy file that guides the operating system. <br><br>  But the world of software on Windows is very diverse, and not all programs have digital signatures, and many will never get them.  For this, the Code Integrity mechanism can use directories signed by your certificate ‚Äî lists of program files and their hash codes. <br><br>  As a result, to use the new mechanism, you need to create a policy containing a list of trusted certificates and hash codes of unsigned files and, if necessary, supplement it with directory files of allowed software. <br><br>  The easiest use of Device Guard will be for new or existing jobs with a fixed list of software.  It is enough to form a code integrity policy and activate the functionality; after that, nothing else can run on these computers. <br><br>  There is also the possibility of creating policies based on several possible workplace options and merging them into a single policy, which is subsequently assigned to all workplaces. <br><br>  For advanced users who choose and install programs themselves, an audit mode is sufficient.  The log of running applications will be useful in the future to determine the necessary and unnecessary programs. <br><br>  Note that Device Guard with Code Integrity and Virtualization Based Security (VBS) mechanisms is available only in the Windows 10 Enterprise edition. <br><br><h1>  Configure Code Integrity Policy </h1><br>  Configuring Device Guard in User Mode Code Integrity is closest to the usual tasks of restricting software launch. <br>  In order to create a Code Integrity policy on a reference computer, you will need to create a shadow copy of the disk and run the file cmdlet.  In this case, the shadow copy allows the scanning process to access all files, including those opened at the time of the scan. <br><br><pre><code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#Create</span></span> a <span class="hljs-type"><span class="hljs-type">ShadowCopy</span></span> to avoid locks <span class="hljs-string"><span class="hljs-string">$s</span></span>1 = (gwmi -<span class="hljs-type"><span class="hljs-type">List</span></span> <span class="hljs-type"><span class="hljs-type">Win32_ShadowCopy</span></span>).<span class="hljs-type"><span class="hljs-type">Create</span></span>(<span class="hljs-comment"><span class="hljs-comment">"C:\"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"ClientAccessible"</span></span>) <span class="hljs-string"><span class="hljs-string">$s</span></span>2 = gwmi <span class="hljs-type"><span class="hljs-type">Win32_ShadowCopy</span></span> | ? { <span class="hljs-string"><span class="hljs-string">$_</span></span>.<span class="hljs-type"><span class="hljs-type">ID</span></span> -eq <span class="hljs-string"><span class="hljs-string">$s</span></span>1.<span class="hljs-type"><span class="hljs-type">ShadowID</span></span> } <span class="hljs-string"><span class="hljs-string">$d</span></span> = <span class="hljs-string"><span class="hljs-string">$s</span></span>2.<span class="hljs-type"><span class="hljs-type">DeviceObject</span></span> + <span class="hljs-comment"><span class="hljs-comment">"\"</span></span> cmd /c mklink /d <span class="hljs-type"><span class="hljs-type">C</span></span>:\scpy <span class="hljs-comment"><span class="hljs-comment">"$d"</span></span></code> </pre> <br>  <b>You</b> can scan the resulting disk snapshot mounted to the <b>C: \ scpy</b> folder with the following cmdlet: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-CIPolicy -<span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> PcaCertificate -Fallback Hash -FilePath C:\BasePolicy.xml -ScanPath C:\scpy -UserPEs</code> </pre> <br><br>  This command will create a list of signatures (certificates) found on the reference computer, and count the hash codes of the unsigned executable files.  The result will be an XML file containing the following parameters: <br><br><pre> <code class="hljs pgsql">&lt;<span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span>&gt;&lt;<span class="hljs-keyword"><span class="hljs-keyword">Option</span></span>&gt;Enabled:Audit Mode&lt;/<span class="hljs-keyword"><span class="hljs-keyword">Option</span></span>&gt;&lt;/<span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span>&gt;</code> </pre> <br>  An option that includes the operation of the Code Integrity module in audit mode, in which all non-compliant executable policies are written to the audit log. <br><br><pre> <code class="hljs pgsql">&lt;Signer <span class="hljs-type"><span class="hljs-type">Name</span></span>="Microsoft Code Signing PCA" ID="ID_SIGNER_S_231"&gt;&lt;CertRoot <span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>=" 4E80BE107C860DE896384B3EFF50504DC2D76AC7151DF3102A4450637A032146" <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>="TBS"/&gt;&lt;/Signer&gt;</code> </pre> <br>  An example of a detected certificate.  All executable files signed by it will be executed without restrictions. <br><br><pre> <code class="hljs tex">&lt;Allow Hash=" 88A87238099A3B4BB392C82589CA099DC70629D6EA32CF79F9071011C5994CA2" FriendlyName="<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">\</span></span></span></span>?<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GLOBALROOT</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Device</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HarddiskVolume</span></span></span></span>4<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Distr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">npp</span></span></span></span>.6.8.3.Installer.exe Hash Page Sha256" ID="ID_ALLOW_A_8_1"/&gt;</code> </pre> <br>  An example of a detected file without a digital signature.  If the hash code matches, this file will be launched. <br><br>  The resulting XML file must be compiled into a binary format and placed in the system folder <b>C: \ Windows \ System32 \ CodeIntegrity \</b> . <br><br><pre> <code class="hljs tex">ConvertFrom-CIPolicy C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BasePolicy</span></span></span></span>.xml C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SIPolicy</span></span></span></span>.bin cp C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SIPolicy</span></span></span></span>.bin c:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">System</span></span></span></span>32<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeIntegrity</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SIPolicy</span></span></span></span>.p7b</code> </pre><br>  After the computer restarts, the Code Integrity mechanism will start working in audit mode.  After checking the launch and operation of all necessary programs, you can supplement the policy with the data collected by the audit by executing the following command. <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">New</span></span>-CIPolicy -<span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> PcaCertificate -Fallback Hash C:\AuditPolicy.xml -Audit</code> </pre> <br>  The <i>-Audit switch</i> indicates that you need to create a policy based on entries in the audit log. <br>  The <b>AuditPolicy.xml</b> file is similar in structure to the <b>BasePolicy.xml</b> file that was previously created. <br>  To combine the results of the initial scan and the information gathered in the audit mode, there is a command to combine policies. <br><br><pre> <code class="hljs pgsql">Merge-CIPolicy ‚ÄìOutputFilePath C:\Final.xml ‚ÄìPolicyPaths C:\ BasePolicy.xml,C:\AuditPolicy.xml</code> </pre> <br>  To enable policy enforcement, disable audit mode in the resulting file. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-RuleOption -<span class="hljs-keyword"><span class="hljs-keyword">Option</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> -FilePath C:\Final.xml -<span class="hljs-keyword"><span class="hljs-keyword">Delete</span></span></code> </pre> <br>  As a result, the <i>Enabled: Audit Mode</i> entry is deleted from the XML file, and such a policy will block all unaccounted software. <br><br>  Next, we compile the XML file into a binary format by running the command again. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ConvertFrom-CIPolicy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Final</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.xml</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">SIPolicy</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.bin</span></span></code> </pre> <br>  You can extend the policy to target computers either by copying the SIPolicy.bin file in a convenient way, or by using the Windows 10 group policy in <b>Computer Configuration \ Administrative Templates \ System \ Device Guard</b> . <br><br><img src="https://habrastorage.org/files/285/6b4/917/2856b491779741eab84083029011d2cb.png"><br><br><br><h1>  Creating a catalog file </h1><br>  Code Integrity policy is a monolithic list of permitted software, which is not always convenient.  To use new or updated programs, if they cannot be verified with an electronic signature, you can create a file directory. <br><br>  For example, let's take the <b>7zip</b> program, for which we will create a catalog file containing both distribution data and all executable files after installing the distribution. <br><br>  To do this, run the <b>PackageInspector</b> monitoring utility (included in Windows 10 Enterprise) on the station without the active Device Guard, specifying the drive letter for monitoring and the program distribution file to start as parameters. <br><br><pre> <code class="hljs pgsql">.\PackageInspector.exe <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> C: -<span class="hljs-type"><span class="hljs-type">path</span></span> c:\Distr\<span class="hljs-number"><span class="hljs-number">7</span></span>z1508-x64.exe</code> </pre> <br><br>  After the installation of 7zip is complete, we check its launch and operation and stop monitoring with the command <br><br><pre> <code class="hljs css">.\<span class="hljs-selector-tag"><span class="hljs-selector-tag">PackageInspector</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-name</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">C</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Distr</span></span>\7<span class="hljs-selector-tag"><span class="hljs-selector-tag">zip</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cdfpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">c</span></span>:\<span class="hljs-selector-tag"><span class="hljs-selector-tag">Distr</span></span>\7<span class="hljs-selector-tag"><span class="hljs-selector-tag">zip</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cdf</span></span></code> </pre> <br><br>  The <b>7zip.cdf</b> file will show all the monitored executables. <br>  The <b>7zip.cat</b> file contains compiled information for Device Guard. <br><br>  To make the created directory file trusted for Device Guard, we will sign it with our digital signature. <br><br>  If the administrator already has an imported certificate with a Code Sign assignment, you can use it to sign directly from PowerShell, specifying the SHA256 hashing algorithm required for Device Guard. <br><br><pre> <code class="hljs tex">Get-ChildItem cert:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentUser</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">My</span></span></span></span> -codesign Set-AuthenticodeSignature -HashAlgorithm SHA256 7zip-osnova.cat @(Get-ChildItem cert:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentUser</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">My</span></span></span></span> -codesign)[0]</code> </pre><br>  The certificate must be issued by a trusted certificate authority whose root certificate was imported to the reference computer before creating the policy. <br><br>  Next, you need to place the generated and signed directory file on the computers you need by copying to the directory storage along the way <br>  <b>C: \ Windows \ System32 \ CatRoot \ {F750E6C3-38EE-11D1-8 anad-00C04FC295EE}</b> <br><br>  Unlike a policy, directory files are applied immediately and without rebooting.  Now the installation and operation of 7zip on the computer is allowed. <br><br>  More detailed documentation is available on TechNet at: <br>  <a href="https://technet.microsoft.com/ru-ru/library/mt463091(v%3Dvs.85).aspx">https://technet.microsoft.com/ru-ru/library/mt463091(v=vs.85).aspx</a> </div><p>Source: <a href="https://habr.com/ru/post/280332/">https://habr.com/ru/post/280332/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280318/index.html">Creating your own editing mode in the Unreal Engine</a></li>
<li><a href="../280322/index.html">Kernel tracing with ftrace</a></li>
<li><a href="../280326/index.html">ALM Robot, or moving to a new version of ALM is just</a></li>
<li><a href="../280328/index.html">Sort the queue without using additional resources</a></li>
<li><a href="../280330/index.html">Belgian security forces used WhatsApp because of the attacks</a></li>
<li><a href="../280334/index.html">As one programmer Jocly shoe</a></li>
<li><a href="../280336/index.html">IBM has released a new generation of storage - Storwize v5000 Gen2</a></li>
<li><a href="../280338/index.html">Juniper Networks Routing, Switching and Security Solutions and Updates</a></li>
<li><a href="../280340/index.html">Investigating the performance issues of calling ClassLoader.getResourceAsStream</a></li>
<li><a href="../280344/index.html">Rules for working with Tasks API. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>