<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expression parsing, bytecode-way</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Did you have to disassemble the expression ? To draw a graph of the function on the line entered by the user? 

 Agree, the occupation brings more hea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expression parsing, bytecode-way</h1><div class="post__text post__text-html js-mediator-article">  Did you have to <a href="http://algolist.manual.ru/syntax/parsear.php">disassemble the expression</a> ?  To draw a graph of the function on the line entered by the user? <br><br>  Agree, the occupation brings more headaches than the joy of the result.  Perhaps you are familiar with the <a href="http://www.antlr.org/">antlr</a> or <a href="https://javacc.dev.java.net/">javacc libraries</a> , then you will get <a href="https://javacc.dev.java.net/">rid of a</a> little blood.  But acquire the tail of ugly generated classes, which as soon as possible hide from prying eyes in the farthest package. <br><br>  Having written <a href="http://habrahabr.ru/blogs/java/69552/">yesterday about cglib</a> , I noticed in the documentation a chapter on bytecode modification.  And by itself, the question arises, is it possible at runtime to force the class to perform, what it really wants, and not what the class wants? <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I honestly took up the study of documentation and quickly went to the popular bym-code editor <a href="http://asm.ow2.org/">asm</a> .  However, to my disappointment, modifying the byte-code can only be quite good knowing and understanding it.  More precisely, this means that if you need to return the result of executing ‚Äúx * x + x / 2‚Äù, you must compile this expression in the statement. <br><br>  Not wanting to write a compiler, I still formulated a request for google and found what <a href="http://www.javaranch.com/journal/200711/Journal200711.jsp">I was looking for.</a> <br><br>  To my luck, a similar compiler is already implemented in another <a href="http://www.csg.is.titech.ac.jp/~chiba/javassist/">javassist</a> bytecode editor.  By the way, javassist is more documented, however in the open-source community there is an opinion that cglib is much faster.  In our case, the speed of creating a class is not as important as the speed of its methods.  So, what needs to be done: <br><br><blockquote><code><a href="http://s-c.me/3120/s"></a> <a href="http://s-c.me/3120/h"></a> <font color="black">Copy Source | Copy HTML <font color="#0000ff">public interface</font> <font color="#2b91af">Evaluator</font> { <font color="#0000ff">public double</font> eval( <font color="#0000ff">double</font> x); }</font></code> <ol> <li> <code><font color="black"><a href="http://s-c.me/3120/s"></a> <a href="http://s-c.me/3120/h"></a> Copy Source | Copy HTML <font color="#0000ff">public interface</font> <font color="#2b91af">Evaluator</font> { <font color="#0000ff">public double</font> eval( <font color="#0000ff">double</font> x); }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3120/s"></a> <a href="http://s-c.me/3120/h"></a> Copy Source | Copy HTML <font color="#0000ff">public interface</font> <font color="#2b91af">Evaluator</font> { <font color="#0000ff">public double</font> eval( <font color="#0000ff">double</font> x); }</font></code> </li> <li> <code><font color="black"><a href="http://s-c.me/3120/s"></a> <a href="http://s-c.me/3120/h"></a> Copy Source | Copy HTML <font color="#0000ff">public interface</font> <font color="#2b91af">Evaluator</font> { <font color="#0000ff">public double</font> eval( <font color="#0000ff">double</font> x); }</font></code> </li> </ol></blockquote><br><br>  Class creation: <br><br><blockquote> <code><a href="http://s-c.me/3121/s"></a> <a href="http://s-c.me/3121/h"></a> <font color="black">Copy Source | Copy HTML</font></code> <ol> <li>  ClassPool pool = ClassPool.getDefault (); </li><li></li><li>  <font color="#2b91af">CtClass</font> evalClass = pool.makeClass ( <font color="#A31515">"Formula"</font> ); </li><li>  evalClass.setInterfaces ( </li><li>  <font color="#0000ff">new</font> <font color="#2b91af">CtClass</font> [] { </li><li>  pool.makeClass ( <font color="#A31515">"com.micro.bench.Evaluator"</font> ) </li><li>  }); </li><li></li><li>  <font color="#2b91af">String</font> expession = <font color="#A31515">"x * x + x / 2"</font> ; </li><li></li><li>  evalClass.addMethod ( </li><li>  CtNewMethod.make ( </li><li>  <font color="#A31515">"public double eval (double x) {return ("</font> + expession + <font color="#A31515">");}"</font> , </li><li>  evalClass)); </li><li></li><li>  Class clazz = evalClass.toClass (); </li><li>  runtime = (Evaluator) clazz.newInstance (); </li></ol></blockquote><br><br>  Everything!  In our hands, a class object that implements the Evaluator interface, which will return x * x + x / 2 to us <br><br>  Well, now it would not be bad to compare performance.  Thanks to <a href="https://habrahabr.ru/users/theshade/" class="user_link">TheShade</a> for the <a href="http://habrahabr.ru/blogs/java/69552/">comment</a> , I modified Timer a bit and used it for testing.  A test result showing that both methods run at the same time: <br><br><pre>      total |  amount |  last |  last 5 |  last 10 |  avg |  dev |  operation
    6856.00 |  20.00 |  351.00 |  343.00 |  341.00 |  342.80 |  1.24 |  .. runtime calc
    6874.00 |  20.00 |  337.00 |  343.00 |  344.00 |  343.70 |  1.03 |  .. compile-time calc
</pre><br><br><ul><li>  total - total ms </li><li>  amount - number of launches </li><li>  last - last ms </li><li>  last 5 - average over the last 5 start ms </li><li>  last 10 - average over the last 10 ms runs </li><li>  avg - average generally ms </li><li>  dev deviation </li></ul><br>  <a href="http://pastebin.com/f266161bd">Class Evaluation.java - Comparison of two methods</a> <br>  <a href="http://pastebin.com/f43da6916">Class Timer.java - Measuring speed and statistics</a> </div><p>Source: <a href="https://habr.com/ru/post/69728/">https://habr.com/ru/post/69728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../69717/index.html">on domain certification</a></li>
<li><a href="../69719/index.html">Codes for the professional program RIW-2009</a></li>
<li><a href="../69724/index.html">PHPConf 2009 - Program Completely Formed</a></li>
<li><a href="../69725/index.html">MegaFon starts selling 3G netbooks</a></li>
<li><a href="../69726/index.html">ABC WEB-developer</a></li>
<li><a href="../69731/index.html">PRS-505 disassembly</a></li>
<li><a href="../69733/index.html">Startup</a></li>
<li><a href="../69734/index.html">Karma indicator</a></li>
<li><a href="../69736/index.html">Music with intelligence</a></li>
<li><a href="../69737/index.html">Player Bmorn BM-888B - who prevented to put WiFi?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>