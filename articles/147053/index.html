<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MongoDB: Range Query Performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you traveled around the territory of MongoDB indices, you may have heard the principle: If your queries contain sorting, then add the sorted field ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MongoDB: Range Query Performance</h1><div class="post__text post__text-html js-mediator-article">  If you traveled around the territory of MongoDB indices, you may have heard the principle: <i>If your queries contain sorting, then add the sorted field to the end of the index that is used in these queries.</i> <br><br>  In many cases, when queries contain equality conditions like {‚Äúname‚Äù: ‚ÄúCharlie‚Äù}, the principle above is very useful.  But what about him can be said with the following example: <br><br><pre><code class="hljs swift">: db.drivers.<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>({<span class="hljs-string"><span class="hljs-string">"country"</span></span>: {<span class="hljs-string"><span class="hljs-string">"$in"</span></span>: [<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"G"</span></span>]}).<span class="hljs-built_in"><span class="hljs-built_in">sort</span></span>({<span class="hljs-string"><span class="hljs-string">"carsOwned"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}) : {<span class="hljs-string"><span class="hljs-string">"country"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"carsOwned"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}</code> </pre> <br>  This bundle is not effective, although the principle is respected.  Because there is a trap into which this principle can lead you. <br>  Below we consider the reasons for the emergence of this trap and by the end of the article you will have a new rule that will help you with indexing. <br><a name="habracut"></a><br>  Let's recall the basics from the MongoDB documentation: <br>  * "Indices early" <br>  Indexes deserve consideration at the beginning of the design.  Historical, efficiency at the data access level was passed on to the database administrators, this created an optimization layer after the design. <br>  With document-oriented databases, it is possible to avoid this. <br>  * "Indices often" <br>  Indexed queries work better by several orders of magnitude, even on small data.  While a query without a index can take 10 seconds, the same query can take 0 milliseconds with the corresponding index. <br>  * "Indices completely" <br>  Queries use indices from left to right.  An index can be used only if the query uses all fields in the index without gaps. <br>  * "Sort Index" <br>  If your query will contain a sort, then add the sorted field to your index. <br>  * "Teams" <br>  .explain () will show which index is used for this query. <br>  .ensureIndex () creates indexes. <br>  .getIndexes () and .getIndexKeys () will show which indexes you have. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now back to our question.  Based on the basics of indexing, for the following query: <br><pre> <code class="hljs swift">db.collection.<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>({<span class="hljs-string"><span class="hljs-string">"country"</span></span>: <span class="hljs-string"><span class="hljs-string">"A"</span></span>}).<span class="hljs-built_in"><span class="hljs-built_in">sort</span></span>({<span class="hljs-string"><span class="hljs-string">"carsOwned"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br>  We need to create this index: <br><pre> <code class="hljs objectivec">db.collection.ensureIndex({<span class="hljs-string"><span class="hljs-string">"country"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"carsOwned"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br>  What if most conditions in a condition use range selection instead of comparison?  Like this: <br><pre> <code class="hljs swift">db.collection.<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>({<span class="hljs-string"><span class="hljs-string">"country"</span></span>: {<span class="hljs-string"><span class="hljs-string">"$in"</span></span>: [<span class="hljs-string"><span class="hljs-string">"A"</span></span>, <span class="hljs-string"><span class="hljs-string">"G"</span></span>]}}).<span class="hljs-built_in"><span class="hljs-built_in">sort</span></span>({<span class="hljs-string"><span class="hljs-string">"carsOwned"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>})</code> </pre> <br>  Here we used the $ in operator, but besides it, there are also such as: $ gt, $ lt, etc. <br>  If you use such a query, you will see that it is not effective, while you remember the basics - you need to run .explain () and see which index is used and how. <br>  As a result of executing .explain (), you will see {scanAndOrder: true}, which means MongoDB performs sorting operations, and this is an expensive operation since  MongoDB sorts documents in memory.  Therefore, you should avoid large data sets because  it is slow and resource intensive. <br><br>  Don't forget why scanAndOrder is slow, why does MongoDB sort the result even though we already have an index with sorting?  The answer is simple: we do not have a suitable index. <br><br>  Why?  The reason is simple, the point is in the index structure we created.  For the example above, documents having {‚Äúcountry‚Äù: ‚ÄúA‚Äù} and documents having {‚Äúcountry‚Äù: ‚ÄúG‚Äù} are sorted in the indicator by {‚ÄúcarsOwned‚Äù: 1}, <br>  but they are sorted independently of each other.  They are not sorted together!  Consider the chart below: <br><br><img src="https://habrastorage.org/storage2/da8/025/97c/da802597c38b2b62a9a18b08fa2265ae.png"><br><br>  The left diagram shows the procedure for crawling documents by the index that we created.  After all documents are found, they will need to be sorted. <br>  In the right diagram, the alternative index {‚ÄúcarsOwned‚Äù: 1, ‚Äúcountry‚Äù: 1}.  In this case, the documents found will be already in sorted form. <br>  This subtle point of efficiency led to the following rules when indexing: <br><br>  <b>The order of the fields should be:</b> <br>  1. First, the fields that are selected by exact values. <br>  2. Next, the fields for which will go sorting. <br>  3. And at the end of the field for the range filter. <br><br>  <i>Ending</i> <br>  Is there a compromise?  Yes.  The request will be visited by several index nodes, which is technical, because  traversing the sorted part will occur before filtering. <br>  Thus, the new rule is a pure approximation for many queries, but do not forget that the complexity of your data can lead to different results. <br><br>  I hope this guide will help you.  Good luck. </div><p>Source: <a href="https://habr.com/ru/post/147053/">https://habr.com/ru/post/147053/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147046/index.html">AWS CloudWatch: Custom Metrics</a></li>
<li><a href="../147047/index.html">A set of converters for Livestreet (from CMS Cogear, DLE and WordPress)</a></li>
<li><a href="../147048/index.html">European court allows selling ‚Äúused programs‚Äù</a></li>
<li><a href="../147051/index.html">Resurrection ADOM</a></li>
<li><a href="../147052/index.html">Did CERN discover the Higgs boson? (UPD)</a></li>
<li><a href="../147055/index.html">Continuous Testing in .NET</a></li>
<li><a href="../147056/index.html">#SumIT #Habr #Beer (07/06/2012)</a></li>
<li><a href="../147058/index.html">Chasing the idea</a></li>
<li><a href="../147059/index.html">Samsung Galaxy S3 - disassembly</a></li>
<li><a href="../147060/index.html">Software licenses in a nutshell</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>