<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Entity Framework: improve performance when saving data in the database</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When adding / changing a large number of records (10¬≥ and higher), the performance of the Entity Framework leaves much to be desired. The reason for t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Entity Framework: improve performance when saving data in the database</h1><div class="post__text post__text-html js-mediator-article">  When adding / changing a large number of records (10¬≥ and higher), the performance of the Entity Framework leaves much to be desired.  The reason for this is both the architectural features of the framework itself and the non-optimal generated SQL.  Looking ahead - saving data to bypass the context reduces execution time by orders of magnitude. <br><br>  The content of the article: <br>  1. Insert / Update using standard Entity Framework <br>  2. Finding a solution to the problem <br>  3. Entity Framework Integration and SqlBulkCopy <br>  4. Advanced insert using MERGE <br>  5. Performance Comparison <br>  6. Conclusions <br><a name="habracut"></a><br><br><h3>  1. Insert / Update using standard Entity Framework </h3><br>  Let's start with Insert.  The standard way to add new records to the database is to add it to the context and then save it: <br><pre><code class="cs hljs">context.Orders.Add(order); context.SaveChanges();</code> </pre> <br>  Each call to the <i>Add</i> method results in an expensive, in terms of execution, call to the internal algorithm <a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">DetectChanges</a> .  This algorithm scans all entities in the context and compares the current value of each property with the original value stored in the context, updates the connections between the entities, etc.  A known way to improve performance, which is relevant until the release of EF 6, is <a href="https://msdn.microsoft.com/en-us/data/jj556205.aspx">disabling DetectChanges</a> at the time of adding entities to the context: <br><pre> <code class="cs hljs"> context.Configuration.AutoDetectChangesEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; orders.ForEach(order =&gt; context.Orders.Add(order)); context.Configuration.AutoDetectChangesEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; context.SaveChanges();</code> </pre><br>  It is also recommended not to keep tens of thousands of objects in context and to save data in blocks, keeping the context and creating a new every N objects, for example, like <a href="http://weblog.west-wind.com/posts/2013/Dec/22/Entity-Framework-and-slow-bulk-INSERTs">this</a> .  Finally, an optimized <i>AddRange</i> method appeared in EF 6, raising performance to the level of the <i>Add + AutoDetectChangesEnabled bundle</i> : <br><pre> <code class="cs hljs"> context.Orders.AddRange(orders); context.SaveChanges();</code> </pre><br>  Unfortunately, the listed approaches do not solve the main problem, namely: when saving data in the database, <b>a separate INSERT request is generated for each new record!</b> <br><div class="spoiler">  <b class="spoiler_title">SQL</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Order</span></span>]([<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>], [<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>], [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (@<span class="hljs-number"><span class="hljs-number">0</span></span>, @<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)</code> </pre><br></div></div><br>  With Update, the situation is similar.  The following code: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> orders = context.Orders.ToList(); <span class="hljs-comment"><span class="hljs-comment">//..    context.SaveChanges();</span></span></code> </pre><br>  will lead to the execution of a separate SQL query for each modified object: <br><div class="spoiler">  <b class="spoiler_title">SQL</b> <div class="spoiler_text"><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> [dbo].[<span class="hljs-keyword"><span class="hljs-keyword">Order</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>] = @<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = @<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br></div></div><br>  In the simplest cases, <a href="https://github.com/loresoft/EntityFramework.Extended">EntityFramework.Extended</a> can help: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//update all tasks with status of 1 to status of 2 context.Tasks.Update( t =&gt; t.StatusId == 1, t2 =&gt; new Task { StatusId = 2 });</span></span></code> </pre><br>  This code will bypass the context and generate 1 SQL query.  For more information about EF speed and how to work with this library <a href="http://habrahabr.ru/post/164483/">, see</a> <a href="https://habrahabr.ru/users/tp7/" class="user_link">tp7</a> .  Obviously, the solution is not universal and is suitable only for writing to all target lines of the same value. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  2. Finding a solution to the problem </h3><br>  Strongly disgusted with writing ‚Äúbikes‚Äù, I first of all looked for best-practices for multiple insertion using EF.  It would seem that a typical task - but a suitable solution ‚Äúout of the box‚Äù could not be found.  At the same time, SQL Server offers a number of quick data insertion techniques, such as the <a href="https://msdn.microsoft.com/ru-ru/library/ms162802.aspx">bcp utility</a> and the <a href="https://msdn.microsoft.com/ru-ru/library/system.data.sqlclient.sqlbulkcopy(v%3Dvs.110).aspx">SqlBulkCopy</a> class.  The latter will be discussed below. <br><br>  <i>System.Data.SqlClient.SqlBulkCopy</i> is an ADO.NET class for writing large amounts of data to SQL Server tables.  <i>DataRow []</i> , <i>DataTable</i> , or <i>IDataReader</i> implementation can be used as a data source. <br>  What can: <br><ul><li>  Send data to the server block by block with transaction support; </li><li>  Perform mapping of columns from <i>DataTable</i> to database table; </li><li>  Ignore constraints, foreign keys when inserting (optional). </li></ul><br>  Minuses: <br><ul><li>  Atomicity of the insert (optional); </li><li>  The impossibility of continuing work after the exception; </li><li>  Weak error handling capabilities. </li></ul><br>  More information about the class can be found in the <a href="http://habrahabr.ru/post/137038/">article</a> <a href="https://habrahabr.ru/users/jeanlouis/" class="user_link">JeanLouis</a> , and here we look at our immediate problem - namely the lack of integration of <i>SqlBulkCopy</i> and EF.  There is no established approach to solving this problem, but there are several projects of varying degrees of suitability, such as: <br><br>  <a href="https://efbulkinsert.codeplex.com/">EntityFramework.BulkInsert</a> <br>  It turned out to be inoperative.  While studying the Issues, I came across a <a href="https://efbulkinsert.codeplex.com/workitem/1318">discussion</a> with the participation of ... the notorious Julie Lerman, describing a problem similar to mine and unanswered by the authors of the project. <br><br>  <a href="https://github.com/MikaelEliasson/EntityFramework.Utilities">EntityFramework.Utilities</a> <br>  Live project, active community.  No support for Database First, but promise to add. <br><br>  <a href="http://zzzprojects.com/entity-framework-extensions/">Entity Framework Extensions</a> <br>  $ 300 <br><br><h3>  3. Entity Framework Integration and SqlBulkCopy </h3><br>  Let's try to do everything yourself.  In the simplest case, inserting data from a collection of objects using <i>SqlBulkCopy</i> looks like this: <br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//entities -   EntityFramework using (IDataReader reader = entities.GetDataReader()) using (SqlConnection connection = new SqlConnection(connectionString)) using (SqlBulkCopy bcp = new SqlBulkCopy(connection)) { connection.Open(); bcp.DestinationTableName = "[Order]"; bcp.ColumnMappings.Add("Date", "Date"); bcp.ColumnMappings.Add("Number", "Number"); bcp.ColumnMappings.Add("Text", "Text"); bcp.WriteToServer(reader); }</span></span></code> </pre><br>  The task itself is to implement an <i>IDataReader</i> based on a collection of objects that is trivial, so I will limit myself to the <a href="http://www.csvreader.com/posts/generic_list_datareader.php">link</a> and go on to describing how to handle errors when pasting using <i>SqlBulkCopy</i> .  By default, data is inserted in its own transaction.  When an exception occurs, a <i>SqlException is</i> thrown and a rollback occurs, i.e.  data in the database will not be recorded at all.  And the ‚Äúnative‚Äù error messages of this class can only be called uninformative.  For example, what might contain <i>SqlException.AdditionalInformation</i> : <br><br><blockquote>  The given value of the type String from the data source cannot be converted. </blockquote><br>  or: <br><blockquote>  SqlDateTime overflow.  Must be between 1/1/1753 12:00:00 AM and 12/31/9999 11:59:59 PM. </blockquote><br><br>  Unfortunately, <i>SqlBulkCopy</i> often does not provide information that uniquely identifies the string / entity that caused the error.  Another unpleasant feature is that when you try to insert a duplicate record on the primary key, <i>SqlBulkCopy will</i> throw an exception and complete the work without providing an opportunity to handle the situation and continue execution. <br><br>  <b>Mapping</b> <br>  In the case of correctly generated entities and databases, the checks for the type conformity, or the length of the field in the table, are irrelevant.  It is more useful to deal with column mapping performed through the <i><a href="https://msdn.microsoft.com/ru-ru/library/system.data.sqlclient.sqlbulkcopy.columnmappings(v%3Dvs.110).aspx">SqlBulkCopy.ColumnMappings</a></i> property: <br><blockquote>  If the data source and the target table have the same number of columns and the source position of each source column in the data source corresponds to the source position of the corresponding target column, the ColumnMappings collection is not required.  However, if the number of columns or their order is different, it is necessary to use ColumnMappings to ensure the correct copying of data between columns. </blockquote><br>  For EF In 99% of cases, you will need to set the <i>ColumnMappings</i> explicitly (due to navigation properties and any additional properties).  Navigation properties can be eliminated with the help of Reflection: <br><div class="spoiler">  <b class="spoiler_title">Get property names for mapping</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> columns = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Order).GetProperties() .Where(property =&gt; property.PropertyType.IsValueType || property.PropertyType.Name.ToLower() == <span class="hljs-string"><span class="hljs-string">"string"</span></span>) .Select(property =&gt; property.Name) .ToList();</code> </pre><br></div></div><br>  Such code will fit for the POCO class without additional properties, otherwise you will have to switch to ‚Äúmanual control‚Äù.  Getting the table schema is also quite simple: <br><div class="spoiler">  <b class="spoiler_title">We read the table schema</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> List&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetColumns</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SqlConnection connection</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] restrictions = { <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;TableName&gt;"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> columns = connection.GetSchema(<span class="hljs-string"><span class="hljs-string">"Columns"</span></span>, restrictions) .AsEnumerable() .Select(s =&gt; s.Field&lt;String&gt;(<span class="hljs-string"><span class="hljs-string">"Column_Name"</span></span>)) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> columns; }</code> </pre><br></div></div><br>  This makes it possible to manually perform mapping between the source class and the target table. <br><br>  <b>Using the SqlBulkCopy.BatchSize property and the SqlBulkCopyOptions class</b> <br><br>  <i>SqlBulkCopy.BatchSize</i> : <br><table><tbody><tr><td>  Batchsize </td><td>  The number of lines in each batch.  At the end of each packet, the number of lines contained in it is sent to the server. </td></tr></tbody></table><br>  <i>SqlBulkCopyOptions</i> - enumeration: <br><table><tbody><tr><th>  Member name </th><th>  Description </th></tr><tr><td>  CheckConstraints </td><td>  Check constraints when inserting data.  By default, restrictions are not checked. </td></tr><tr><td>  Default </td><td>  Use default values ‚Äã‚Äãfor all parameters. </td></tr><tr><td>  Firetriggers </td><td>  When this setting is specified, the server triggers insert triggers for rows inserted into the database. </td></tr><tr><td>  KeepIdentity </td><td>  Save source identification values.  When this setting is not specified, identification values ‚Äã‚Äãare assigned by the target table. </td></tr><tr><td>  Keepnulls </td><td>  Store NULL values ‚Äã‚Äãin the target table regardless of the default settings.  When this setting is not specified, null values, where possible, are replaced with default values. </td></tr><tr><td>  Table lock </td><td>  Get a bulk update lock for the entire duration of a bulk copy operation.  When this setting is not specified, row lock is used. </td></tr><tr><td>  UseInternalTransaction </td><td>  When this setting is specified, each bulk copy operation is performed in a transaction.  If you specify this setting and provide the constructor with a SqlTransaction object, an ArgumentException will be thrown. </td></tr></tbody></table><br>  We can optionally enable the check of triggers and constraints on the database side (disabled by default).  When specifying <i>BatchSize</i> and <i>UseInternalTransaction</i> , the data will be sent to the server in blocks in separate transactions.  Thus, all successful blocks until the first erroneous one will be stored in the database. <br><br><h3>  4. Advanced insert using MERGE </h3><br>  <i>SqlBulkCopy</i> can only add records to the table, and does not provide any functionality for modifying existing records.  Nevertheless, we can speed up the execution of Update operations!  How?  Insert the data into a temporary empty table, and then synchronize the tables using the <a href="https://msdn.microsoft.com/ru-ru/library/bb510625.aspx">MERGE statement</a> , which debuted in SQL Server 2008: <br><blockquote>  MERGE (Transact-SQL) <br>  Performs insert, update, or delete operations on the target table based on the results of the connection to the source table.  For example, you can synchronize two tables by inserting, updating, or deleting rows in one table based on differences found in another table. <br></blockquote><br>  Using MERGE, it is easy and simple to implement various duplication processing logic: update data in the target table, or ignore or even delete matching records.  Thus, we can save data from the collection of EF objects to the database using the following algorithm: <br><ol><li>  create / clear a temporary table that is completely identical to the target table; </li><li>  insert data using SqlBulkCopy into a temporary table; </li><li>  using MERGE, add records from the temporary table to the target. </li></ol><br>  Steps 1 and 3 will be discussed in more detail. <br><br>  <b>Temporary table</b> <br>  It is necessary to create a table in the database, completely repeating the table schema for inserting data.  Making manual copies is the worst possible option, since all further work on comparison and synchronization of table diagrams will also fall on your shoulders.  It is safer to copy the scheme programmatically and immediately before pasting.  For example, using <a href="http://www.mssqltips.com/sqlservertip/1826/getting-started-with-sql-server-management-objects-smo/">SQL Server Management Objects (SMO)</a> : <br><pre> <code class="cs hljs"> Server server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Server(); <span class="hljs-comment"><span class="hljs-comment">//SQL auth server.ConnectionContext.LoginSecure = false; server.ConnectionContext.Login = "login"; server.ConnectionContext.Password = "password"; server.ConnectionContext.ServerInstance = "server"; Database database = server.Databases["database name"]; Table table = database.Tables["Order"]; ScriptingOptions options = new ScriptingOptions(); options.Default = true; options.DriAll = true; StringCollection script = table.Script(options);</span></span></code> </pre><br><br>  It is worth paying attention to the <a href="https://msdn.microsoft.com/ru-ru/library/microsoft.sqlserver.management.smo.scriptingoptions.aspx">ScriptingOptions</a> class, which contains several dozens of parameters for fine-tuning the generated SQL.  The resulting <i>StringCollection</i> will be expanded into a <i>String</i> .  Unfortunately, I did not find a better solution than to replace the source table name in the script with the name of a temporary a la <i>String.Replace (‚ÄúOrder‚Äù, ‚ÄúOrder_TEMP‚Äù)</i> .  I would be grateful for the hint of a beautiful solution to create a copy of the table within the same database.  Run the finished script in any convenient way.  A copy of the table is created! <br><br><div class="spoiler">  <b class="spoiler_title">The nuances of using SMO in .NET 4+</b> <div class="spoiler_text">  It should be noted that the call to <i>Database.ExecuteNonQuery</i> in .NET 4+ throws an exception of the form: <br><br><blockquote>  Mixed mode assembly version v2.0.50727 of this version has been built up for the version. <br></blockquote><br><br>  Associated with the fact that the wonderful SMO library is only available under .NET 2 Runtime.  Fortunately, there is a <a href="http://stackoverflow.com/questions/6425707/mixed-mode-assembly-is-built-against-version-v2-0-50727-of-the-runtime">workaround</a> : <br><pre> <code class="cs hljs"> &lt;startup useLegacyV2RuntimeActivationPolicy=<span class="hljs-string"><span class="hljs-string">"true"</span></span>&gt; ... &lt;/startup&gt;</code> </pre><br>  Another option is to use <i>Database.ExecuteWithResults</i> . <br></div></div><br><br>  <b>Copying data from a temporary table to a target</b> <br>  It remains to execute the MERGE statement on the SQL Server side, comparing the contents of the temporary and target tables and performing an update or insertion (if necessary).  For example, for the [Order] table, the code might look like this: <br><img src="https://habrastorage.org/files/35b/5a0/73c/35b5a073c69a4c16867435e2f1529df0.png" alt="table schema"><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Order</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Target] <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> [Order_TEMP] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Source</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Target.Id = Source.Id <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> Target.Date = Source.Date, Target.Number = Source.Number, Target.Text = Source.Text <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (Source.Date, Source.Number, Source.Text);</code> </pre><br>  This SQL query compares records from the [Order_TEMP] temporary table with records from the [Order] target table, and performs Update if a record is found with a similar value in the Id field, or Insert if no such record is found.  Run the code in any convenient way, and you're done!  Do not forget to clean / delete the temporary table to taste. <br><br><h3>  5. Performance Comparison </h3><br>  Runtime: Visual Studio 2013, Entity Framework 6.1.1 (Database First), SQL Server 2012. For testing, the [Order] table was used (the table schema is shown above).  Measurements of the time of execution were carried out for the approaches to storing data in the database considered in the article, the results are presented below (the time is given in seconds): <br><br><h4>  Insert </h4><br><table><tbody><tr><th rowspan="2">  The way to commit changes in the database </th><th colspan="3">  Number of records </th></tr><tr><td>  <b>1000</b> </td><td>  <b>10,000</b> </td><td>  <b>100,000</b> </td></tr><tr><td>  Add + SaveChanges </td><td>  7.3 </td><td>  101 </td><td>  6344 </td></tr><tr><td>  Add + (AutoDetectChangesEnabled = false) + SaveChanges </td><td>  6.5 </td><td>  64 </td><td>  801 </td></tr><tr><td>  Add + separate context + SaveChanges </td><td>  8.4 </td><td>  77 </td><td>  953 </td></tr><tr><td>  AddRange + SaveChanges </td><td>  7.2 </td><td>  64 </td><td>  711 </td></tr><tr><td>  SqlBulkCopy </td><td>  0.01 </td><td>  0.07 </td><td>  0.42 </td></tr></tbody></table><br>  Wow!  If you use the <i>Add</i> method to add to the context and <i>SaveChanges</i> to save, saving 100,000 records to the database will take almost 2 hours!  While <i>SqlBulkCopy</i> spends less than a second on the same task! <br><br><h4>  Update </h4><br><table><tbody><tr><th rowspan="2">  The way to commit changes in the database </th><th colspan="3">  Number of records </th></tr><tr><td>  <b>1000</b> </td><td>  <b>10,000</b> </td><td>  <b>100,000</b> </td></tr><tr><td>  SaveChanges </td><td>  6.2 </td><td>  60 </td><td>  590 </td></tr><tr><td>  SqlBulkCopy + MERGE </td><td>  0.04 </td><td>  0.2 </td><td>  1.5 </td></tr></tbody></table><br>  Again <i>SqlBulkCopy</i> out of competition.  The source code of the test application is available on <a href="https://github.com/aidforwork/PaperSource.EF.SqlBulkCopy">GitHub</a> . <br><br><h3>  findings </h3><br>  In the case of working with a context containing a large number of objects (10¬≥ and above), abandoning the Entity Framework infrastructure (adding to context + saving context) and switching to SqlBulkCopy for writing to the database can provide a performance increase tens or even hundreds of times.  However, in my opinion, using a bunch of EF + SqlBulkCopy everywhere is a clear sign that something is wrong with the architecture of your application.  The approach considered in the article should be considered as a simple means to accelerate the performance in narrow places of an already written system, if changing the architecture / technology is difficult for some reason.  Any developer using the Entity Framework should know the strengths and weaknesses of this tool.  Successes! <br><br><div class="spoiler">  <b class="spoiler_title">Additional links</b> <div class="spoiler_text">  <b>EntityFramework: Add, AddRange</b> <br>  <a href="http://blog.oneunicorn.com/2012/03/10/secrets-of-detectchanges-part-1-what-does-detectchanges-do/">Secrets of DetectChanges</a> <br>  <a href="http://msdn.microsoft.com/en-us/data/hh949853.aspx">Performance Considerations for Entity Framework 4, 5, and 6</a> <br>  <a href="http://www.elevenwinds.com/entity-framework-performance">Entity Framework Performance</a> <br>  <a href="http://weblog.west-wind.com/posts/2013/Dec/22/Entity-Framework-and-slow-bulk-INSERTs">Entity Framework and slow bulk INSERTs</a> <br>  <a href="http://habrahabr.ru/post/164483/">Another look at the Entity Framework: performance and pitfalls</a> <br><br>  <b>SqlBulkCopy</b> <br>  <a href="http://habrahabr.ru/post/137038/">SqlBulkCopy - reloading big data without a crash or how to ride a wild horse</a> <br>  <a href="http://www.4guysfromrolla.com/articles/102109-1.aspx">Using SqlBulkCopy To Perform Efficient Bulk SQL Operations</a> <br><br>  <b>SqlBulkCopy + data reader</b> <br>  <a href="http://www.csvreader.com/posts/generic_list_datareader.php">Creating a Generic List DataReader for SqlBulkCopy</a> <br>  <a href="http://elegantcode.com/2012/01/26/sqlbulkcopy-for-generic-listt-useful-for-entity-framework-nhibernate/">SqlBulkCopy for Generic List &lt;T&gt;</a> <br><br>  <b>SqlBulkCopy + MERGE</b> <br>  <a href="http://www.jarloo.com/c-bulk-upsert-to-sql-server-tutorial/">C # Bulk Upsert to SQL Server Tutorial</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/251397/">https://habr.com/ru/post/251397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251383/index.html">Istanbul got its own domain name</a></li>
<li><a href="../251385/index.html">Startup PromoAppiliates Promotional Codes</a></li>
<li><a href="../251391/index.html">JPoint 2015: review of applications from speakers</a></li>
<li><a href="../251393/index.html">Go compiler rewritten to Go</a></li>
<li><a href="../251395/index.html">A simple solution for load balancing in a printer pool.</a></li>
<li><a href="../251399/index.html">New in PHDays: protection of supercomputers, security of iOS applications and sale of exploits</a></li>
<li><a href="../251401/index.html">Dagaz: Kicks to common sense (part 3)</a></li>
<li><a href="../251403/index.html">WEB Server based on ENC28j60 + Arduino - it can't be easier</a></li>
<li><a href="../251407/index.html">How to create a subdomain in VestaCP</a></li>
<li><a href="../251409/index.html">How to set up a LibGDX project with Gradle, Google Play Services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>