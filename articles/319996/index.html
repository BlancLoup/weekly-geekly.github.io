<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OdataToEntity is an easy way to create .Net Core OData services</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When .Net Core came out, the old OData ASP.NET Web API version was incompatible with the new platform. This fatal flaw allowed me to create my own imp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OdataToEntity is an easy way to create .Net Core OData services</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/8c0/013/5f5/8c00135f5bdf4677b579bd886ddc3d1f.png"></div><br><p>  When .Net Core came out, the old OData ASP.NET Web API version was incompatible with the new platform.  This fatal flaw allowed me to create my own implementation of OData on the .Net Core platform.  As a result of the creative rethinking of the previous implementation, it came to be understood that she suffered from an over-complicated design with a large number of unnecessary abstractions.  The idea was to create an easy-to-use library that requires minimal coding.  I present to you OdataToEntity, a library for creating OData services without writing code, you <strong>only</strong> need a data access context. <a name="habracut"></a>  As a result, to simplify the design of api, it was decided not to use interfaces in the code, and the library has full test coverage.  To reduce external dependencies, the library is decoupled from HTTP, which allows you to implement OData on top of any transport.  This engineering marvel is built under Framework 4.6.1 or .Net Core 2.0 and uses Microsoft.OData.Core 7.4.  The following data contexts are supported: </p><br><ol><li>  Entity Framework 6.2 </li><li>  Entity Framework Core 2.0 </li><li>  Linq2Db </li></ol><br><p>  <strong>How it works</strong> </p><br><p>  The main idea of ‚Äã‚Äãthe project is to translate OData requests into an expression tree, which is then transmitted to the corresponding data access adapter. </p><br><p>  To isolate the library from various ORM APIs, the OdataToEntity.Db.OeDataAdapter abstract class "data access adapter" is used.  Each context implements its descendant from this class (Ef6: OeEf6DataAdapter, EfCore: OeEfCoreDataAdapter, Linq2Db: OeLinq2DbDataAdapter). </p><br><p>  The data model is based on the OData Entity Data Model (EDM) description model of the data provided by your service.  The EDM model is required by the ODataLib library to parse the query string.  If user entities are tagged with attributes (System.ComponentModel.DataAnnotations), then the model can be built in a universal way suitable for all data providers. </p><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderContext your DbContext var dataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(); //Build OData Edm Model EdmModel edmModel = dataAdapter.BuildEdmModel();</span></span></code> </pre> <br><p>  If the Entity Framework context is used and the Fluent API is used to describe the entities (without using attributes): <br>  Entity Framework Core </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderContext your DbContext var dataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(); //Build OData Edm Model EdmModel edmModel = dataAdapter.BuildEdmModelFromEfCoreModel();</span></span></code> </pre> <br><p>  Entity Framework 6 </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderEf6Context your DbContext var dataAdapter = new OeEf6DataAdapter&lt;OrderEf6Context&gt;(); //Build OData Edm Model EdmModel edmModel = dataAdapter.BuildEdmModelFromEf6Model();</span></span></code> </pre> <br><p>  Create a model from multiple data contexts </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create referenced data adapter var refDataAdapter = new OeEfCoreDataAdapter&lt;Model.Order2Context&gt;(); //Build referenced Edm Model EdmModel refModel = refDataAdapter.BuildEdmModel(); //Create root data adapter var rootDataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(); //Build root Edm Model EdmModel rootModel = rootDataAdapter.BuildEdmModel(refModel);</span></span></code> </pre> <br><p>  The library can be used to read and edit data. <br>  In read mode, the OData request is submitted to the library, it is parsed with the help of Microsoft.OData.Core (ODataLib) into the ODataLib representation, which is translated into the usual expression tree.  The query is parameterized (i.e., the replacement of constant expressions with variables) and then transferred to the data access adapter.  The adapter translates the general expression tree into a more specific, applicable in this data context.  Creates a context that makes a query to the database, and the resulting entities are serialized in an OData JSON format. <br>  In the edit mode, the entities of the model serialized in the OData JSON format are served as input to the library.  Using ODataLib, it is deserialized into the essence of the data model, which are added to the data access context and stored in the database.  Fields computed on the database side are returned to the client.  Supported "batch change set" - batch add, delete, change entities.  Editing tables describing tree data structures (self-referencing table).  For Linq2Db, a data context similar to the DbContext Entity Framework was implemented, allowing you to edit the object graph. </p><br><p>  Supported query types </p><br><ol><li>  $ apply (filter, groupby, aggregate (average, count, virtual property $ count, countdistinct, max, min, sum)) </li><li>  $ count </li><li>  $ filter </li><li>  $ orderby </li><li>  $ select </li><li>  $ skip </li><li>  $ top </li><li>  $ compute </li><li>  $ skiptoken </li><li>  lamda any </li><li>  lambda all </li></ol><br><p>  Supported Features </p><br><ol><li>  cast </li><li>  ceiling </li><li>  concat </li><li>  contains </li><li>  day </li><li>  endswith </li><li>  floor </li><li>  fractionalseconds </li><li>  hour </li><li>  indexof </li><li>  length </li><li>  minute </li><li>  month </li><li>  round </li><li>  second </li><li>  startswith </li><li>  substring </li><li>  tolower </li><li>  toupper </li><li>  trim </li><li>  year </li></ol><br><p>  <strong>Usage example</strong> </p><br><p>  The following data model is used in tests and examples. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Category</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ICollection&lt;Category&gt; Children { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Category Parent { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? ParentId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Customer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Address { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [InverseProperty(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Order.AltCustomer))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ICollection&lt;Order&gt; AltOrders { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Key, Column(Order = <span class="hljs-number"><span class="hljs-number">0</span></span>), Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Country { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Key, Column(Order = <span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [InverseProperty(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Order.Customer))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ICollection&lt;Order&gt; Orders { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Sex? Sex { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { [ForeignKey(<span class="hljs-string"><span class="hljs-string">"AltCustomerCountry,AltCustomerId"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Customer AltCustomer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String AltCustomerCountry { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? AltCustomerId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [ForeignKey(<span class="hljs-string"><span class="hljs-string">"CustomerCountry,CustomerId"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Customer Customer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String CustomerCountry { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CustomerId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTimeOffset? Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DatabaseGenerated(DatabaseGeneratedOption.Identity)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ICollection&lt;OrderItem&gt; Items { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OrderStatus Status { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderItem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? Count { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DatabaseGenerated(DatabaseGeneratedOption.Identity)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Order Order { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Decimal? Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Required] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String Product { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OrderStatus { Unknown, Processing, Shipped, Delivering, Cancelled } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Sex { Male, Female } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Category&gt; Categories { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Customer&gt; Customers { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Order&gt; Orders { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;OrderItem&gt; OrderItems { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Description(<span class="hljs-string"><span class="hljs-string">"dbo.GetOrders"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;Order&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOrders</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">? id, String name, OrderStatus? status</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResetDb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); }</code> </pre> <br><p>  An example of executing an OData request consists of only five lines: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderContext your DbContext var dataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(); //Create query parser var parser = new OeParser(new Uri("http://dummy"), dataAdapter, dataAdapter.BuildEdmModel()); //Query var uri = new Uri("http://dummy/Orders?$select=Name"); //The result of the query var response = new MemoryStream(); //Execute query await parser.ExecuteGetAsync(uri, OeRequestHeaders.JsonDefault, response, CancellationToken.None);</span></span></code> </pre> <br><p>  An example of saving new entities in the database also consists of five lines: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> batch = <span class="hljs-string"><span class="hljs-string">@" --batch_6263d2a1-1ddc-4b02-a1c1-7031cfa93691 Content-Type: multipart/mixed; boundary=changeset_e9a0e344-4133-4677-9be8-1d0006e40bb6 --changeset_e9a0e344-4133-4677-9be8-1d0006e40bb6 Content-Type: application/http Content-Transfer-Encoding: binary Content-ID: 1 POST http://dummy/Customers HTTP/1.1 OData-Version: 4.0 OData-MaxVersion: 4.0 Content-Type: application/json;odata.metadata=minimal Accept: application/json;odata.metadata=minimal Accept-Charset: UTF-8 User-Agent: Microsoft ADO.NET Data Services {""@odata.type"":""#OdataToEntity.Test.Model.Customer"",""Address"":""Moscow"",""Id"":1,""Name"":""Ivan"",""Sex@odata.type"":""#OdataToEntity.Test.Model.Sex"",""Sex"":""Male""} --changeset_e9a0e344-4133-4677-9be8-1d0006e40bb6-- --batch_6263d2a1-1ddc-4b02-a1c1-7031cfa93691-- "</span></span>; <span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderContext your DbContext var dataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(); //Create query parser var parser = new OeParser(new Uri("http://dummy"), dataAdapter, dataAdapter.BuildEdmModel()); //Serialized entities in JSON UTF8 format var request = new MemoryStream(System.Text.Encoding.UTF8.GetBytes(batch)); //The result of the query var response = new MemoryStream(); //Execute query await parser.ExecuteBatchAsync(request, response, CancellationToken.None);</span></span></code> </pre> <br><p>  An example of the stored procedure </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderContext your DbContext var dataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(); //Create query parser var parser = new OeParser(new Uri("http://dummy"), dataAdapter, dataAdapter.BuildEdmModel()); //The result of the stored procedure var response = new MemoryStream(); //Execute sored procedure await parser.ExecuteGetAsync(new Uri("http://dummy/GetOrders(name='Order 1',id=1,status=null)"), OeRequestHeaders.JsonDefault, response, CancellationToken.None);</span></span></code> </pre> <br><p>  To set a procedure name other than the method name in c #, you can use the attribute </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Description(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"dbo.GetOrders"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;Order&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOrders</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">? id, String name, OrderStatus? status</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException();</code> </pre> <br><p>  Other examples can be found in the <em>test</em> folder. </p><br><p>  <strong>Paginated data sampling</strong> <br>  <a href="http://docs.oasis-open.org/odata/odata/v4.0/os/part1-protocol/odata-v4.0-os-part1-protocol.html">Server-Driven Paging</a> allows you to get a partial set of data whose size is set using the <em>OeRequestHeaders.SetMaxPageSize</em> method <em>(int maxPageSize)</em> .  The server returns the data and a link to the next part in the @ odata.nextLink annotation, where the beginning of the next part of the data is recorded with the $ skiptoken tag.  If the query returns data where in the sort the column participates allowing for NULL values ‚Äã‚Äãin the database (the Required attribute is not specified), you must set the <em>OeDataAdapter.IsDatabaseNullHighestValue</em> property for SQLite, MySql, Sql Server to false, for PostgreSql, Oracle to true. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderContext your DbContext var dataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(Model.OrderContext.CreateOptions()) { IsDatabaseNullHighestValue = true //PostgreSql }; //Create query parser var parser = new OeParser(new Uri("http://dummy"), dataAdapter, dataAdapter.BuildEdmModel()); //Query var uri = new Uri("http://dummy/Orders?$select=Name&amp;$orderby=Date"); //Set max page size OeRequestHeaders requestHeaders = OeRequestHeaders.JsonDefault.SetMaxPageSize(10); //The result of the query var response = new MemoryStream(); //Execute query await parser.ExecuteGetAsync(uri, requestHeaders, response, CancellationToken.None);</span></span></code> </pre> <br><p>  If you want to get links, rather than real one-to-many navigation properties data, you must call the <em>OeRequestHeaders.SetNavigationNextLink (true)</em> method. </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Query var uri = new Uri("http://dummy/Orders?$expand=Items"); //Set max page size, to-many navigation properties OeRequestHeaders requestHeaders = OeRequestHeaders.JsonDefault.SetMaxPageSize(10).SetNavigationNextLink(true); //The result of the query var response = new MemoryStream(); //Execute query await parser.ExecuteGetAsync(uri, requestHeaders, response, CancellationToken.None);</span></span></code> </pre> <br><p>  <strong>Entity Framework Core features</strong> <br>  For the Entity Framework Core provider, there is the ability to cache queries, which in existing tests allows us to raise the sample rate up to two times.  The cache key is a parsed OData query with remote constant values, and the value is the delegate that accepts the data context and returns the result of the query.  This allows you to exclude the stage of building the data query itself (IQueryable).  To use this feature, use the <em>OeEfCoreDataAdapter</em> constructor <em>(DbContextOptions options, Db.OeQueryCache queryCache)</em> . <br>  To use the DbContext object pool ( <em>DbContextPool</em> ), create an instance of <em>OeEfCoreDataAdapter</em> via the constructor with the <em>DbContextOptions</em> parameter </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Create adapter data access, where OrderContext your DbContext var dataAdapter = new OeEfCoreDataAdapter&lt;Model.OrderContext&gt;(Model.OrderContext.CreateOptions());</span></span></code> </pre> <br><p>  <strong>Source code structure</strong> <br>  The source code is divided into two parts: in the <em>source</em> folder, the library itself and assemblies of access to various data sources, in the <em>test</em> folder, tests and code samples. <br>  Solution files in the <em>sln</em> folder. <br>  The library itself is located in the <em>source / OdataEntity project</em> . <br>  Adapter to the context of the Entity Framework 6.2 <em>source / OdataToEntity.Ef6</em> . <br>  Adapter to context Entity Framework Core <em>source / OdataToEntity.EfCore</em> . <br>  Adapter to context Linq2Db <em>source / OdataToEntity.Linq2Db</em> . <br>  Routing and base controller classes for Asp .Net Core Mvc <em>source / OdataToEntity.AspNetCore</em> </p><br><p>  Tests: <br>  Entity Framework Core in-memory database <em>test / OdataToEntity.Test</em> <br>  Entity Framework Core Sql Server <em>test / OdataToEntity.Test.EfCore.SqlServer</em> <br>  Entity Framework Core PostgreSql <em>test / OdataToEntity.Test.EfCore.PostgreSql</em> <br>  Entity Framework 6 Sql Server <em>test / OdataToEntity.Test.Ef6.SqlServer</em> <br>  Linq2Db Sql Server <em>test / OdataToEntity.Test.Linq2Db</em> </p><br><p>  Examples of requests can be viewed in <a href="">tests.</a> </p><br><div class="spoiler">  <b class="spoiler_title">Test OData requests</b> <div class="spoiler_text"><p>  OrderItems? $ Apply = filter (Order / Status eq OdataToEntity.Test.Model.OrderStatus'Processing ') <br>  Orders? $ Apply = filter (Status eq OdataToEntity.Test.Model.OrderStatus'Unknown ') / groupby ((Name), aggregate (Id with countdistinct as cnt)) <br>  OrderItems? $ Apply = groupby ((Product)) <br>  OrderItems? $ Apply = groupby ((OrderId, Order / Status), aggregate (Price with average as avg, Product with countdistinct as dcnt, Price with max ast maxus, price with min as min, max with sum as sum, $ count as cnt)) <br>  OrderItems? $ Apply = groupby ((OrderId), aggregate (Price with sum as sum)) / filter (OrderId eq 2 and sum ge 4) <br>  OrderItems? $ Apply = groupby ((OrderId), aggregate (Price with sum as sum)) &amp; $ filter = OrderId eq 2 <br>  OrderItems? $ Apply = groupby ((OrderId, Order / Name)) / filter (OrderId eq 1 and Order / Name eq 'Order 1') <br>  OrderItems? $ Apply = groupby ((OrderId), aggregate (Price mul Count as sum)) <br>  OrderItems? $ Apply = groupby ((OrderId, Order / Name)) &amp; $ orderby = OrderId desc, Order / Name <br>  OrderItems? $ Apply = groupby ((OrderId, Order / Name)) &amp; $ orderby = OrderId desc, Order / Name &amp; $ skip = 1 &amp; $ top = 1 <br>  OrderItems? $ Apply = groupby ((OrderId)) &amp; $ orderby = OrderId &amp; $ skip = 1 <br>  OrderItems? $ Apply = groupby ((OrderId)) &amp; $ top = 1 <br>  OrderItems? $ Apply = groupby ((OrderId), aggregate (substring (Product, 0, 10) with countdistinct as dcnt, $ count as cnt)) / filter (dcnt ne cnt) <br>  Orders / $ count <br>  Orders? $ Expand = Customer, Items &amp; $ orderby = Id <br>  Orders? $ Expand = AltCustomer, Customer, Items &amp; $ select = AltCustomerCountry, AltCustomerId, CustomerCountry, CustomerId, Date, Id, Name, Status &amp; $ orderby = Id <br>  Customers? $ Expand = AltOrders ($ expand = Items ($ filter = contains (Product, 'unknown'))), Orders ($ expand = Items ($ filter = contains (Product, 'unknown'))) <br>  Customers? $ Expand = AltOrders ($ expand = Items), Orders ($ expand = Items) <br>  OrderItems? $ Expand = Order ($ expand = AltCustomer, Customer) &amp; $ orderby = Id <br>  Customers? $ Expand = Orders ($ expand = Items ($ orderby = Id desc)) <br>  Customers? $ Orderby = Id &amp; $ skip = 1 &amp; $ top = 3 &amp; $ expand = AltOrders ($ expand = Items ($ top = 1)), Orders ($ expand = Items ($ top = 1)) <br>  Customers? $ Expand = Orders ($ filter = Status eq OdataToEntity.Test.Model.OrderStatus'Processing ') <br>  Customers? $ Expand = AltOrders, Orders <br>  Customers? $ Expand = Orders ($ select = AltCustomerCountry, AltCustomerId, CustomerCountry, CustomerId, Date, Id, Name, Status) <br>  Orders? $ Expand = * &amp; $ orderby = Id <br>  Orders? $ Filter = Items / all (d: d / Price ge 2.1) <br>  Orders? $ Filter = Items / any (d: d / count gt 2) <br>  Orders? $ Filter = Status eq OdataToEntity.Test.Model.OrderStatus'Unknown '&amp; $ apply = groupby ((Name), aggregate (Id with countdistinct as cnt)) <br>  Orders? $ Filter = Items / $ count gt 2 <br>  Orders? $ Filter = Date ge 2016-07-04T19: 10: 10.8237573% 2B03: 00 <br>  Orders? $ Filter = year (Date) eq 2016 and month (Date) gt 3 and day (Date) lt 20 <br>  Orders? $ Filter = Date eq null <br>  OrderItems? $ Filter = Price gt 2 <br>  OrderItems? $ Filter = Price eq null <br>  Customers? $ Filter = Sex eq OdataToEntity.Test.Model.Sex'Female ' <br>  Customers? $ Filter = Sex eq null <br>  Customers? $ Filter = Sex ne null and Address ne null <br>  Customers? $ Filter = Sex eq null and Address ne null <br>  Customers? $ Filter = Sex eq null and Address eq null <br>  OrderItems? $ Filter = Count ge 2 <br>  OrderItems? $ Filter = Count eq null <br>  OrderItems? $ Filter = Order / Customer / Name eq 'Ivan' <br>  Customers? $ Filter = Address eq 'Tula' <br>  Customers? $ Filter = concat (concat (Name, 'hello'), 'world') eq 'Ivan hello world' <br>  Customers? $ Filter = contains (Name, 'sh') <br>  Customers? $ Filter = endswith (Name, 'asha') <br>  Customers? $ Filter = length (Name) eq 5 <br>  Customers? $ Filter = indexof (Name, 'asha') eq 1 <br>  Customers? $ Filter = startswith (Name, 'S') <br>  Customers? $ Filter = substring (Name, 1, 1) eq substring (Name, 4) <br>  Customers? $ Filter = tolower (Name) eq 'sasha' <br>  Customers? $ Filter = toupper (Name) eq 'SASHA' <br>  Customers? $ Filter = trim (concat (Name, '')) eq trim (Name) <br>  Customers (Country = 'RU', Id = 1) <br>  Orders (1)? $ Expand = Customer, Items <br>  Orders (1) / Items? $ Filter = Count ge 2 <br>  OrderItems (1) / Order / Customer <br>  OrderItems (1) / Order? $ Apply = groupby ((CustomerId), aggregate (Status with min as min)) <br>  Orders (1) / Items? $ Orderby = Count, Price <br>  OrderItems? $ Orderby = Id desc, Count desc, Price desc <br>  OrderItems? $ Orderby = Order / Customer / Sex desc, Order / Customer / Name, Id desc <br>  Orders? $ Filter = AltCustomerId eq 3 and CustomerId eq 4 and ((year (Date) eq 2016 and month (Date) gt 11 and day (Date) lt 20) or Date eq null) and contains (Name, 'unknown') and Status eq OdataToEntity.Test.Model.OrderStatus'Unknown ' <br>  &amp; $ expand = Items ($ filter = (Count eq 0 or Count eq null) and (Price eq 0 or Price eq null) and (contains (Product, 'unknown') or contains (Product, 'null')) and OrderId gt -1 and Id ne 1) <br>  Orders? $ Select = AltCustomer, AltCustomerId, Customer, CustomerId, Date, Id, Items, Name, Status &amp; $ orderby = Id <br>  Orders? $ Select = Name <br>  Customers <br>  Customers? $ Orderby = Id &amp; $ top = 3 &amp; $ skip = 2 <br>  Orders? $ Expand = Items &amp; $ count = true &amp; $ top = 1 <br>  OrderItems? $ Filter = OrderId eq 1 &amp; $ count = true &amp; $ top = 1 </p></div></div><br><p>  Examples; <br>  HTTP service <em>test / OdataToEntityCore.Asp / OdataToEntity.Test.AspServer</em> <br>  HTTP Mvc service <em>test / OdataToEntityCore.Asp / OdataToEntity.Test.AspMvcServer</em> <br>  Microsoft.OData.Client client for the HTTP <em>test / OdataToEntityCore.Asp / OdataToEntity.Test.AspClient service</em> <br>  Microsoft.OData.Client client and WCF server <em>source / OdataToEntity.Test.Wcf</em> </p><br><p>  An example of a Wcf service contract that works with Microsoft.OData.Client </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ServiceContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IOdataWcf</span></span> { [OperationContract] <span class="hljs-function"><span class="hljs-function">Task&lt;Stream&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String query, String acceptHeader</span></span></span><span class="hljs-function">)</span></span>; [OperationContract] <span class="hljs-function"><span class="hljs-function">Task&lt;OdataWcfPostResponse&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OdataWcfPostRequest request</span></span></span><span class="hljs-function">)</span></span>; } [MessageContract] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OdataWcfPostRequest</span></span> { [MessageHeader] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String ContentType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [MessageBodyMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Stream RequestStream { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } [MessageContract] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OdataWcfPostResponse</span></span> { [MessageBodyMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Stream ResponseStream { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br><p>  SQL Server Database Creation Script for <em>test \ OdataToEntity.Test.EfCore.SqlServer \ script.sql</em> tests <br>  PostgreSql database creation script for <em>test \ OdataToEntity.Test.EfCore.PostgreSql \ script.sql</em> tests </p><br><p>  ‚Üí <a href="https://github.com/voronov-maxim/OdataToEntity">Source Code</a> <br>  ‚Üí <a href="https://www.nuget.org/profiles/maxim_voronov">Nuget packages</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/319996/">https://habr.com/ru/post/319996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319984/index.html">Is your service RESTful? All you need / need to know about web services and REST</a></li>
<li><a href="../319986/index.html">Windows 10 Creators Update: Increased Security and Advanced IT Tools</a></li>
<li><a href="../319988/index.html">Lessons of the year to combat information security breaches</a></li>
<li><a href="../319990/index.html">Optimization of mechanics and graphics in the game of the genre "simulator" on iOS</a></li>
<li><a href="../319994/index.html">From the life of parallelist</a></li>
<li><a href="../319998/index.html">Containers and virtualization: faster, more efficient, more reliable</a></li>
<li><a href="../320000/index.html">A fresh selection of resources for a mobile application marketer: books and blogs</a></li>
<li><a href="../320002/index.html">Linux-2017: the most promising distributions</a></li>
<li><a href="../320006/index.html">ESP8266 + PCA9685 + LUA</a></li>
<li><a href="../320010/index.html">A brief overview of the innovations in Laravel 5.4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>