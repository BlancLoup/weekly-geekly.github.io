<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create a module "New Mail" for Magento (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Table of contents 


1. Create a new mail module for Magento (Part 1), where we add a new delivery method to Magento 
2. We create the ‚ÄúNew Mail‚Äù modu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create a module "New Mail" for Magento (Part 1)</h1><div class="post__text post__text-html js-mediator-article"><h4>  Table of contents </h4><br><ol><li>  <b>Create a new mail module for Magento (Part 1), where we add a new delivery method to Magento</b> </li><li>  <a href="http://habrahabr.ru/post/162313/">We create the ‚ÄúNew Mail‚Äù module for Magento (part 2)</a> , where we teach Magento to store and synchronize the warehouse base with New Mail </li></ol><br><br>  Not one person has already asked me to write a module for the most popular cargo carrier of Ukraine, ‚ÄúNew Mail‚Äù.  This is not the case for one hour, so the hands did not reach.  But recently I thought that if an idea is needed, then why not do something useful for the community, namely: <br>  1. free module "New mail" open source for Magento; <br>  2. article in several parts with a detailed description of the process. <br><br>  The article is aimed at beginners in Magento, but, perhaps, it will be interesting and experienced developers.  All sources can be found on GitHub: <a href="https://github.com/alexkuk/Ak_NovaPoshta/">github.com/alexkuk/Ak_NovaPoshta</a> , they are supplemented in the course of development. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, let's start with the problem statement.  The module should perform the following functions: <br>  1. add a new delivery method to Magento; <br>  2. method settings should allow you to specify different shipping costs for different total weight of the package (as in the Table Rates delivery method); <br>  3. store and synchronize the warehouse base with New Mail; <br>  4. output the New Mail warehouses in a convenient way for selection at the Shipping Method step of placing the order, by default, display only the warehouses in the user's city; <br>  5. Add the ability to track the parcel to the user panel. <a name="habracut"></a><br><br>  Recently, the New Mail API also allows you to create and print TTH, but, with your permission, I will leave this functionality for later.  In addition, regarding clause 2, the API also provides the means to calculate shipping costs.  For now, I prefer a simpler and more stable option that will allow the store owner to independently determine the cost of delivery depending on the total weight of the order.  This is due to the fact that the seller is not always able to accurately determine the weight of each product, and the shipping cost set through the API may not work for the seller‚Äôs benefit.  Leave the cost calculation through the API for later. <br><br><h4>  Add a new delivery method </h4><br>  So, create a new module and add a new delivery method.  I will work with Magento CE 1.7.0.2.  The module is called Ak_NovaPoshta.  A lot of articles have already been written about the module structure in Magento, so I‚Äôll omit this moment. <br><br>  It should be noted that Magento operates with two entities, when we talk about the delivery method, it is the shipping carrier and shipping methods (shipping methods provided by the carrier).  In our case, the carrier is New Mail, we will use the warehouses of New Mail as methods. <br><br>  To add a carrier, you need to do three things: <br>  1. add our carrier's configuration fields to the system.xml module; <br><br>  2. add the default settings values, as well as a link to the carrier model class, in the module config.xml: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">default</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">carriers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">novaposhta</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  -,        --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">active</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">active</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ,      ,    shipping address    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sallowspecific</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sallowspecific</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">specificcountry</span></span></span><span class="hljs-tag">&gt;</span></span>UA<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">specificcountry</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">model</span></span></span><span class="hljs-tag">&gt;</span></span>novaposhta/carrier_novaPoshta<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">model</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">specificerrmsg</span></span></span><span class="hljs-tag">&gt;</span></span>       .   ,      ,    -.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">specificerrmsg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">novaposhta</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">carriers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">default</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  3. Add a class model for our carrier. <br>  The carrier model class is inherited from Mage_Shipping_Model_Carrier_Abstract and implements Mage_Shipping_Model_Carrier_Interface.  Mage_Shipping_Model_Carrier_Abstract has already defined some useful methods, such as the getConfigData ($ field) method for retrieving configuration values.  In our class, we define the main collectRates method (Mage_Shipping_Model_Rate_Request $ request), which will return the available delivery methods: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collectRates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Mage_Shipping_Model_Rate_Request $request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getConfigFlag(<span class="hljs-string"><span class="hljs-string">'active'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $result Mage_Shipping_Model_Rate_Result */</span></span> $result = Mage::getModel(<span class="hljs-string"><span class="hljs-string">'shipping/rate_result'</span></span>); $shippingPrice = <span class="hljs-number"><span class="hljs-number">1.00</span></span>; <span class="hljs-comment"><span class="hljs-comment">// dummy price $warehouseId = 1; // dummy warehouse ID $warehouseName = ' ‚Ññ1'; // dummy warehouse name /** @var $method Mage_Shipping_Model_Rate_Result_Method */ $method = Mage::getModel('shipping/rate_result_method'); $method-&gt;setCarrier($this-&gt;_code) -&gt;setCarrierTitle($this-&gt;getConfigData('name')) -&gt;setMethod('warehouse_' . $warehouseId) -&gt;setMethodTitle($warehouseName) -&gt;setPrice($shippingPrice) -&gt;setCost($shippingPrice); $result-&gt;append($method); return $result; }</span></span></code> </pre><br>  While we have not implemented warehouse synchronization, we will use one delivery method for an example - Warehouse No. 1.  Inside the collectRates () method, create an instance of Mage_Shipping_Model_Rate_Result, and use the Mage_Shipping_Model_Rate_Result :: append () method to add instances of Mage_Shipping_Model_Rate_Result_Method to it. <br><br>  Finally, we rewrite the parent method isTrackingAvailable: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isTrackingAvailable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre><br>  At this stage, our delivery method can already be used, but, as you can see, the cost of delivery will always be 1.00. <br><br><h4>  Add shipping cost configuration </h4><br>  The next step is to add a configuration option for linking the total order weight and shipping cost.  In the end, I want to get this form: <br><br><img src="https://habrastorage.org/storage2/fe0/967/3f3/fe09673f33506b33ea3765ae2816f8de.jpg"><br><br>  To do this, add the weight_price field in the system.xml of our module: <br><pre> <code class="xml hljs">‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">weight_price</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">translate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span>Shipping price<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">label</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frontend_model</span></span></span><span class="hljs-tag">&gt;</span></span>novaposhta/config_field_weightPrice<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frontend_model</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">backend_model</span></span></span><span class="hljs-tag">&gt;</span></span>adminhtml/system_config_backend_serialized_array<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">backend_model</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sort_order</span></span></span><span class="hljs-tag">&gt;</span></span>110<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sort_order</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">show_in_default</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">show_in_default</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">show_in_website</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">show_in_website</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">show_in_store</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">show_in_store</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">weight_price</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶</code> </pre><br>  A backend model is a model that converts a field value before saving to the base.  In this case, we will use the finished model Mage_Adminhtml_Model_System_Config_Backend_Serialized_Array.  The frontend model is not a model at all, but a unit responsible for the field representation.  We will add our Ak_NovaPoshta_Block_Config_Field_WeightPrice block: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ak_NovaPoshta_Block_Config_Field_WeightPrice</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mage_Adminhtml_Block_System_Config_Form_Field_Array_Abstract</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addColumn(<span class="hljs-string"><span class="hljs-string">'weight'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; Mage::helper(<span class="hljs-string"><span class="hljs-string">'novaposhta'</span></span>)-&gt;__(<span class="hljs-string"><span class="hljs-string">'Weight upper limit'</span></span>), <span class="hljs-string"><span class="hljs-string">'style'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'width:120px'</span></span>, )); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addColumn(<span class="hljs-string"><span class="hljs-string">'price'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'label'</span></span> =&gt; Mage::helper(<span class="hljs-string"><span class="hljs-string">'novaposhta'</span></span>)-&gt;__(<span class="hljs-string"><span class="hljs-string">'Price'</span></span>), <span class="hljs-string"><span class="hljs-string">'style'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'width:120px'</span></span>, )); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_addAfter = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_addButtonLabel = Mage::helper(<span class="hljs-string"><span class="hljs-string">'novaposhta'</span></span>)-&gt;__(<span class="hljs-string"><span class="hljs-string">'Add rate'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::__construct(); } }</code> </pre><br>  As you can see, the abstract Mage_Adminhtml_Block_System_Config_Form_Field_Array_Abstract does all the work for us, we just have to set up the columns and buttons. <br><br>  The configuration field is ready, now let's move on to its use, namely, to find the delivery cost of the order.  To do this, add the following methods to the carrier class: <br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getWeightPriceMap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $weightPriceMap = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getConfigData(<span class="hljs-string"><span class="hljs-string">'weight_price'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($weightPriceMap)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unserialize($weightPriceMap); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $packageWeight * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> float */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getDeliveryPriceByWeight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($packageWeight)</span></span></span><span class="hljs-function"> </span></span>{ $weightPriceMap = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getWeightPriceMap(); $resultingPrice = <span class="hljs-number"><span class="hljs-number">0.00</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($weightPriceMap)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $resultingPrice; } $minimumWeight = <span class="hljs-number"><span class="hljs-number">1000000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($weightPriceMap <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $weightPrice) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($packageWeight &lt;= $weightPrice[<span class="hljs-string"><span class="hljs-string">'weight'</span></span>] &amp;&amp; $weightPrice[<span class="hljs-string"><span class="hljs-string">'weight'</span></span>] &lt;= $minimumWeight) { $minimumWeight = $weightPrice[<span class="hljs-string"><span class="hljs-string">'weight'</span></span>]; $resultingPrice = $weightPrice[<span class="hljs-string"><span class="hljs-string">'price'</span></span>]; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $resultingPrice; }</code> </pre><br>  and in the collectRates method we replace <br><pre> <code class="php hljs">$shippingPrice = <span class="hljs-number"><span class="hljs-number">1.00</span></span></code> </pre> <br>  on more real <br><pre> <code class="php hljs">$shippingPrice = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getDeliveryPriceByWeight($request-&gt;getPackageWeight());</code> </pre> <br><br>  Is done <br><br><img src="http://habrastorage.org/storage2/495/8de/3d0/4958de3d011351df6ef00ab39f061bd6.jpg"><br><br>  In the next part, I will synchronize the warehouse base with the New Mail API.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/157647/">https://habr.com/ru/post/157647/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157633/index.html">MIPS sold its patents, and then Imagination was purchased.</a></li>
<li><a href="../157635/index.html">THQ lost half its capitalization</a></li>
<li><a href="../157639/index.html">Calendar for ITshnikov: introduction</a></li>
<li><a href="../157641/index.html">Mobile services, blobs and Windows 8. Store data in the cloud</a></li>
<li><a href="../157645/index.html">Linux Steam: closed beta testing has begun</a></li>
<li><a href="../157649/index.html">InterSystems recruits interns</a></li>
<li><a href="../157651/index.html">Google increases the energy efficiency of the Chrome browser in a number of scenarios up to 25%</a></li>
<li><a href="../157655/index.html">Handspring Visor Edge or Short adaptation course for time travelers</a></li>
<li><a href="../157657/index.html">ShuttlePRO v2 controller from Contour Design: Overview, appointment and first impressions of use</a></li>
<li><a href="../157661/index.html">Return small graphics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>