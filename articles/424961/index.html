<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MTA-STS for Postfix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MTA-STS is the proposed RFC8461 standard, which came out of draft status and was officially published on September 26, 2018. This standard offers a di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MTA-STS for Postfix</h1><div class="post__text post__text-html js-mediator-article">  MTA-STS is the proposed <a href="https://tools.ietf.org/html/rfc8461">RFC8461</a> standard, which came out of draft status and was officially published on September 26, 2018.  This standard offers a discovery mechanism to use full TLS between mail servers, with data encryption and server authentication.  That is, this standard almost completely protects against interference with mail traffic between servers. <br><br>  Simply, the essence of the standard is as follows: <br><br><ol><li>  The mail services that support it publish the policy (1 TXT record and 1 HTTPS resource for each domain). </li><li>  Mail services when sending mail to other domains detect the policy of the recipient domain. </li><li>  Mail services connect to the recipient domain's mail server, applying the restrictions to the TLS set by the detected policy, if one is found. </li></ol><br>  There are some good articles ( <a href="https://www.hardenize.com/blog/mta-sts">for example</a> ) about the standard itself and what it is for, comparing MTA-STS with other similar initiatives, and even showing how to create and publish a policy.  But finding how to move beyond the first step was not so easy. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Start over </h3><br>  Before implementing the MTA-STS, it is necessary to put in order certificates of the mail server.  Otherwise, mail servers that take into account your STS policy will reject the connection to your server.  The following conditions must be met: <br><br><ul><li>  The server certificate is issued by a generally accepted certification authority (Let's Encrypt valid). </li><li>  The chain of certificates sent by the server includes all the necessary certificates of intermediate certification authorities. </li><li>  The certificate has a Subject Alternative Name field with the DNS name of your MX server. </li></ul><br>  You can check the configured server with the certificate with the following command: <br><br><pre><code class="bash hljs">[ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(LANG=C openssl s_client -connect MX.EXAMPLE.COM:25 -starttls smtp -verify_hostname MX.EXAMPLE.COM &lt; /dev/null 2&gt;&amp;1 | fgrep 'error')</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> ] &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OK || <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> FAIL</code> </pre> <br>  where MX.EXAMPLE.COM is the domain name of your MX server.  For full compliance with the standard, it is desirable to verify that the desired domain name is present not only in the Common Name of the certificate, but at least in the Subject Alternative Name. <br><br><h3>  Policy publication </h3><br>  In order to designate your domain as supporting a secure connection with it, you need to publish the MTA-STS policy.  To do this, you must perform the following simple steps in the order indicated (examples are given for the example.com domain). <br><br>  1. Place at <br><br><pre>  https://mta-sts.example.com/.well-known/mta-sts.txt </pre><br>  text file: <br><br><pre> version: STSv1
 mode: enforce
 mx: mail.example.com
 mx: * .example.net
 mx: backupmx.example.com
 max_age: 604800
</pre><br>  The file must be given with Content-Type: text / plain.  Redirects are not allowed.  Line breaks must be either LF or CRLF.  Blank lines are not allowed.  The last line may be terminated by a newline, or it may not be completed by it - both options are allowed.  Empty space in front of the colon and at the beginning of the line is not allowed.  Empty space after a colon is allowed in any quantity.  Empty space (spaces, tabs, etc.) at the end of each line is ignored. <br><br>  Field Values: <br><br>  <b>version</b> : format version.  Should always be equal to "STSv1". <br>  <b>mode</b> : policy mode.  The options are: none, testing, enforce.  The enforce mode corresponds to the normal operation of the standard - to require the correct certificate and persistent TLS connection when connecting to the server.  Testing mode requires you to try to use a secure connection, but in case of an error, send mail in any case with the administrator notification through the TLSRPT mechanism.  The none mode corresponds to this state of affairs, as if the policy had not been published at all.  This mode is useful for properly disabling the policy. <br>  <b>mx</b> : one or more fields containing the names of all allowed MX servers in the domain.  As you can see from the example, templates are allowed, but only as a lower level domain. <br>  <b>max_age</b> : time in seconds for which the policy can be cached and for which senders can continue to use it if the policy is no longer available.  Because of this standard property, shutting down an STS is faster when publishing a new policy with the none mode. <br><br>  2. Create a TXT record _mta-sts.example.com with the contents of the form: <br><br><pre>  v = STSv1;  id = 20160831085700Z; </pre><br>  Whitespace around a semicolon can be arbitrarily arranged in any quantity.  In other places, whitespace characters are not allowed.  The last semicolon may or may not be present. <br><br>  Field Values: <br><br>  <b>v</b> : format version.  It must always be the first field, it must always be equal to STSv1. <br>  <b>id</b> : the unique identifier for the published policy.  May be a string of 1-32 characters in length consisting of letters of both registers and numbers.  Changing the id value is a signal to senders that the policy has been updated.  Therefore, updating the policy should be done first by publishing a new policy file, and then changing the id in the TXT record. <br><br>  From now on, mail servers that support MTA-STS will send mail to your domain only through a secure connection with certificate authentication.  This is where most of the manuals end, but the most interesting thing ahead is to get your own server to comply with the MTA-STS policy when sending mail. <br><br><h3>  The most interesting </h3><br>  The main difficulty is that this standard is not supported by mail servers, including Postfix.  However, this unpleasant trifle should not stop us. <br><br>  The search for a solution led me to the <a href="http://postfix.1071664.n5.nabble.com/MTA-STS-when-td95086.html">postfix-users</a> mailing list archive with a discussion of the timing of the implementation of this standard.  In one of the messages, Witts Venema, the author of Postfix, points to the preferred direction for implementing this functionality - use an external server to search for TLS policies.  It is proposed to use the following configuration directive: <br><br><pre>  smtp_policy_maps = socketmap: inet: host: port: name </pre><br>  I implemented such a server to get the MTA-STS policy. <br><br>  ‚Üí <a href="https://github.com/Snawoot/postfix-mta-sts-resolver">Source Code</a> <br>  ‚Üí <a href="https://pypi.org/project/postfix-mta-sts-resolver/">Package in PyPI</a> <br><br>  The application lacks some of the features that RFC8461 prescribes, such as: proactive policy retrieval, reports, and restricting the frequency of policy requests.  However, the main function ‚Äî TLS policy discovery and caching ‚Äî it performs. <br><br>  The application requires Python 3.5.3+.  Installation and configuration of this daemon can be done through the following steps. <br><br><h4>  Package installation </h4><br>  It is enough to execute the command: <br><br><pre> <code class="bash hljs">pip3 install postfix-mta-sts-resolver</code> </pre> <br>  An alternative installation method <a href="">is</a> written <a href="">here</a> . <br><br><h4>  Creating a configuration file </h4><br>  If you are satisfied with the default settings, then the command <br><br><pre> <code class="bash hljs">touch /etc/postfix/mta-sts-daemon.yml</code> </pre> <br>  Otherwise, the configuration can be taken from the <a href="https://github.com/Snawoot/postfix-mta-sts-resolver/blob/master/mta-sts-daemon.yml.example">example</a> and tailor it to fit your needs. <br><br>  The most important parameter, in my opinion, is the strict_testing parameter.  If it is set to true (the default is false), then the application will return the secure policy even for domains with a policy in testing mode.  This behavior is against the standard, but it is advisable for practical reasons: if the domain owner has published an STS policy even in test mode, then he is certainly ready for it.  That is, then today, mail to gmail.com will be sent over a secure connection. <br><br><h4>  Startup organization </h4><br>  In the case of systemd, it suffices to place a <a href="https://gist.github.com/Snawoot/eaf4bea48ae70f112e609493181c4845">simple unit file</a> in /etc/systemd/system/mta-sts-daemon.service <br><br>  After that, it remains to re-read the systemd configuration, enable the auto-start daemon and run it: <br><br><pre> <code class="bash hljs">systemctl daemon-reload systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> mta-sts-daemon.service systemctl start mta-sts-daemon.service</code> </pre> <br><h4>  Health check </h4><br>  Assuming that the default port is used, the command <br><br><pre> <code class="bash hljs">/usr/sbin/postmap -q dismail.de socketmap:inet:127.0.0.1:8461:postfix</code> </pre> <br>  should withdraw <br><br><pre>  secure match = mx1.dismail.de </pre><br><h4>  Connect to Postfix </h4><br>  Add a line to main.cf: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">smtp_policy_maps</span></span> = socketmap:inet:<span class="hljs-number"><span class="hljs-number">127.0.0.1:8461</span></span>:postfix</code> </pre> <br>  Reload Postfix: <br><br><pre> <code class="bash hljs">systemctl reload postfix.service</code> </pre> <br>  If everything is done correctly, then for STS connections in the /var/log/mail.info log instead of <br><br><pre>  Trusted TLS connection established </pre><br>  records will start to appear <br><br><pre>  Verified TLS connection established </pre><br><br><h3>  Conclusion </h3><br>  If you have reached this place, it most likely means: <br><br><ul><li>  You have read the article without a single picture. </li><li>  From day to day, the likelihood of intercepting your domain‚Äôs mail will fall as other mail services implement the new standard. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/424961/">https://habr.com/ru/post/424961/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424947/index.html">Gesture Recognition with APDS-9960</a></li>
<li><a href="../424949/index.html">PHP Digest 140 (September 17 - 30, 2018)</a></li>
<li><a href="../424951/index.html">Hooray! It was not paranoia</a></li>
<li><a href="../424955/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ332 (September 24 - 30, 2018)</a></li>
<li><a href="../424957/index.html">Generate images from text using AttnGAN</a></li>
<li><a href="../424963/index.html">Zuckerberg Finance: Building Tools for Science Together</a></li>
<li><a href="../424965/index.html">Develop React applications using ReasonReact</a></li>
<li><a href="../424967/index.html">Closures in javascript for beginners</a></li>
<li><a href="../424969/index.html">Node.js Part 9 Guide: Working with the File System</a></li>
<li><a href="../424971/index.html">Habrokast "Sunset Manually" # 1. We are trying to set up an environment for developing toys under Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>