<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploying your MTProxy Telegram with statistics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúI inherited this mess, 
 starting with unscrupulous Zello; LinkedIn 
 and ending with "all the rest" on the Telegram platform 
 in my world. 

 And t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploying your MTProxy Telegram with statistics</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/mt/um/z5/mtumz5i6g-lt6sqsxj338ewhnim.jpeg"><br><blockquote>  ‚ÄúI inherited this mess, <br>  starting with unscrupulous Zello;  LinkedIn <br>  and ending with "all the rest" on the Telegram platform <br>  in my world. <br><br>  And then hiccuping <br>  the official hastily and loudly added: <br>  but I will put order (here in IT) ‚Äú <br>  <i>(...)</i> . </blockquote><br>  Durov rightly believes that authoritarian states should be afraid of him, cipherpunk, and Roskomnadzor and golden shields with their DPI filters do not really bother him. ‚Äù <br>  <i>(Political technique)</i> <br><br>  My technical policy is simpler, here I can write down my thoughts on nonchalant blocking in Runet, but I believe that the progressive citizens of Modern Russian and Habr‚Äôs users felt the unprofessionalism of the current government in their shoes, so I will limit myself to the only phrase: our technical policy is <s>‚ÄúDigital Resistance‚Äù .</s>  ‚ÄúProviding relatives and friends with a stable communication channel.‚Äù <br><a name="habracut"></a><br><h2>  Deploy MTProto proxy Telegram </h2><br><ul><li>  The technical level of complexity is ‚Äúeasy‚Äù if, for example, you follow this cheat sheet. </li><li>  The level of reliability is ‚Äúabove average‚Äù: the docker image works stably, you do not need to restart it every day, as developers wrote in their official Telegram documentation, but the container probably contains some vulnerabilities. </li><li>  Resistance / anxiety level - <s>10 Igilovites weave their conspiracy</s> ‚Äúrelatives use it‚Äù, the ban hasn‚Äôt flown from the ILV even once for all the time (since spring). </li><li>  The level of trust is ‚Äúpublic baby distrust‚Äù, the problem is on the client side (some friends are suspicious of my MtprotoProxy). </li><li>  Testosterone level - "did not become higher." </li><li>  Financial costs - "0‚ÇΩ". </li><li>  Financial reward - "does not depend on citizen Durov."  Promotion - the possibility of imposing advertising. </li></ul><br>  We will raise our TelegramProxy at the "free / personal" capacities of Amazon-ec2: t2.micro.  I used <a href="https://aws.amazon.com/marketplace/pp/Kali-Linux-Kali-Linux/B01M26MMTT">this</a> car. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Okay, deployed your free server, go to the official <a href="https://hub.docker.com/r/telegrammessenger/proxy/">dockerhub</a> website and download the docker container. <br><br>  No need to search for any image, file, or magic button - ‚Äúthey are not there,‚Äù all the magic is done in the CLI: <br><br><pre><code class="bash hljs">$ docker pull telegrammessenger/proxy <span class="hljs-comment"><span class="hljs-comment"># .</span></span></code> </pre> <br>  But before ‚Äúthis‚Äù, install docker for the CLI: <br><br><pre> <code class="bash hljs">sudo apt-get install docker.io docker</code> </pre> <br>  Further, in the official documentation of MtprotoProxyTelegram we are offered to do something like this, we do: <br><br><pre> <code class="bash hljs">$ sudo su &amp;&amp; docker run -d -p443:443 --name=mtproto-proxy --restart=always -v proxy-config:/data telegrammessenger/proxy:latest <span class="hljs-comment"><span class="hljs-comment">#   ¬´mtproto-proxy¬ª.</span></span></code> </pre><br>  After this command, a HEX line will appear in the terminal output, but it is not interesting to us. <br><br>  We write in the CLI: <br><br><pre> <code class="bash hljs">$ docker logs mtproto-proxy</code> </pre> <br>  And we get the necessary data: <br><br><img src="https://habrastorage.org/webt/dv/5s/9e/dv5s9ee_16xvfhfc7iqwuvubwd8.png"><br>  In the output of this log we are shown (covered up): <br><br>  A) our server ip (external server ip); <br>  B) and a random secret - a random string in HEX. <br><br>  Before registering our MtproProxy, you need to configure the main firewall over iptables (no matter how you redirect traffic to this VPC, it will be naughty, since the most important firewall in Amazon-EC2 is in the web interface and has a higher priority over iptables ) <br><br>  We go into the "Amazon-EC2 <a href="https%253A%252F%252Fconsole.aws.amazon.com%252Fconsole%252Fhome%253Fstate%253DhashArgs%252523%2526isauthcode%253Dtrue%26client_id%3Darn%253Aaws%253Aiam%253A%253A015428540659%253Auser%252Fhomepage%26forceMobileApp%3D0">console</a> " in the Security Group and open the incoming 443 port (logical <a href="https://ru.wikipedia.org/wiki/HTTPS">traffic</a> masking for the first time). <br><br><img src="https://habrastorage.org/webt/0s/x-/mx/0sx-mxh6ecykdrz0a-esnplbv4m.png"><br><br>  We take our ip and secret data from the log and go to the Telegram messenger, find the official MTProxy Admin Bot (@MTProxybot) and register our MtproProxy: run the command [/ newproxy] and enter [our_ip: 443], and then our [secret / HEX]. <br><br>  If you mess up when entering data, the bot will be angry and send you to ... <br><br>  If you fill in two lines without errors, you will receive approval and a working link to your current MtprotoProxyTelegram, which you can share with anyone. <br><br><img src="https://habrastorage.org/webt/bm/ao/iu/bmaoiumjos8_xfnmjrmtzvubi08.png"><br><br>  Also through this bot you can add your sponsor channel (but not chat), where you will impose your views on users who have connected to your server, but you can not "spam" and not disturb your potential customers without showing the channel in the pinned messenger list. <br><br>  Just a few words about the bot, there you can request statistics, but "also a donut."  Apparently ‚Äústatistics‚Äù is available when ‚Äúcrowd of parasites‚Äù is behind you <s>Makhachkala</s> . <br><br><h2>  Monitoring </h2><br>  And how many users can we connect to our server?  And anyway, who / what is there?  What?  And how many? <br><br>  We look at the official documentation ... Yeah, here we go: <br><br><pre> <code class="bash hljs">$ curl http://localhost:2398/stats    $ docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> mtproto-proxy curl http://localhost:2398/stats <span class="hljs-comment"><span class="hljs-comment">#       CLI.</span></span></code> </pre> <br>  ‚ÄúKeep your pocket wider‚Äù For the proposed commands, we will always get a similar error: <br><br>  ‚Äú <b>Curl: (7) Failed to connect to localhost port 2398: Connection refused</b> ‚Äù <br><br>  Our proxy will work.  But!  Bagel, not statistics, we get. <br><br>  You can do things for the red-eyed: check <br><br><pre> <code class="bash hljs">$ netstat -an | grep 2398 ...</code> </pre> <br>  At first I thought that this was another jamb for the Telegram developers (and I still think so), then I found a temporary good solution: to polish the Docker-container with a file. <br><br>  Later infa caught my eye: <br><br><div class="spoiler">  <b class="spoiler_title">about the state dances of Roskomnadzor around the "statistics".</b> <div class="spoiler_text"><blockquote>  ‚ÄúWe blocked part of the public proxies on our servers using the firehol project databases.  This project monitors lists with public proxies and makes databases with them. <br><br>  From this moment (that is, almost two days already) not a single IP address of our Russian proxy has been blocked. <br><br>  3. We tell how to make proxies almost invulnerable to Roskomnadzor and share the script for blocking public proxies. <br><br>  - Update the docker-container (or daemon) of MTProto proxy to the latest version: the ILV calculates old versions using the statistics port, which is bound at 0.0.0.0 and uniquely identified itself for the entire Internet.  Better, open the ports you need using iptables, and close the rest (remember that in the case of the docker container, you should use the FORWARD rule). <br><br>  - Roskomnadzor has long learned to dump traffic: they see calls inside the HTTP and SOCKS5 proxies, and they also see the old version of obfuscation MTProto proxy. <br><br>  When clients of some providers who have such dumps installed contact Telegram through such proxies, the ILV sees such calls and immediately blocks these proxies.  The same goes for MTProto proxy with old obfuscation. <br><br>  Solution: hand out to clients who connect to the proxy, secret only with dd at the beginning (you do not need to specify additional letters dd in the settings of the mtproto proxy itself).  This will include a version of obfuscation that dumps cannot detect. <br><br>  And no HTTP or SOCKS5 proxies. <br><br>  - An adjustment by means of which each owner of a telegram proxy who regularly bans ILV can completely (or almost completely) stop blocking (and at the same time make sure that ILV is lying). <br><br>  A script that bans public proxies and a small manual for it. " </blockquote><br>  ‚Üí <a href="https://t.me/unkn0wnerror/1154">Source</a> <br></div></div><br>  Our proxy is pro-Western, I didn‚Äôt encounter any problems / locks for spring and cool summer days, it didn‚Äôt attract creative tasks either, so I didn‚Äôt deal with the loss of tempo and did not add the dd * prefix to the key. <br><br>  The manual ‚Äúreceiving statistics / monitoring‚Äù according to the official instructions of MtprotoProxyTelegram is non-working / outdated, you will have to repair the docker image. <br><br>  Fix it. <br><br>  The container is still running: <br><br><pre> <code class="bash hljs">$ docker stop mtproto-proxy <span class="hljs-comment"><span class="hljs-comment">#   docker-        </span></span></code> </pre><br><pre> <code class="bash hljs">$ docker run --net=host --name=mtproto-proxy2 -d -p443:443 -v proxy-config:/data -e SECRET=___hex telegrammessenger/proxy:latest</code> </pre><br>  Check the statistics: <br><br><pre> <code class="bash hljs">$ curl http://localhost:2398/stats</code> </pre> <br>  <b>curl: (7) Failed to connect to 0.0.0.0 port 2398: Connection refused</b> <br>  Statistics are still unavailable.! .. <br><br>  We find out the identifier of the docker container: <br><br><pre> <code class="bash hljs">$ docker ps</code> </pre> <br>  CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES <br>  f423c209cfdc telegrammessenger / proxy: latest "/ bin / sh -c '/ bin / ba ..." About an hour ago Up About a minute 0.0.0.0-00-0043-&gt;443/tcp mtproto-proxy2 <br><br>  We go with our charter inside the docker container: <br><br><pre> <code class="bash hljs">$ sudo docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it f423c209cfdc /bin/bash $ apt-get update $ apt-get install nano $ nano -$ run.sh</code> </pre><br>  And in the very last line of the ‚Äúrun.sh‚Äù script, add the missing flag: <br><blockquote>  " <b>--Http-stats</b> " <br>  "Exec / usr / local / bin / mtproto-proxy -p 2398 -H 443 -M" $ WORKERS "-C 60000 --aes-pwd / etc / telegram / hello-explorers-how-are-you-doing -u root $ CONFIG --allow-skip-d h --nat-info "$ INTERNAL_IP: $ IP" $ SECRET_CMD $ TAG_CMD ¬ª </blockquote><br>  Add "--http-stats", something like this should work: <br><br><pre> <code class="bash hljs">¬´<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/mtproto-proxy -p 2398 --http-stats -H 443 -M <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WORKERS</span></span></span><span class="hljs-string">"</span></span> -C 60000 --aes-pwd /etc/telegram/hello-explorers-how-are-you-doing -u root <span class="hljs-variable"><span class="hljs-variable">$CONFIG</span></span> --allow-skip<span class="hljs-_"><span class="hljs-_">-d</span></span> h --nat-info <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$INTERNAL_IP</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$IP</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$SECRET_CMD</span></span> <span class="hljs-variable"><span class="hljs-variable">$TAG_CMD</span></span>¬ª</code> </pre><br>  Ctrl + o / Ctrl + x / Ctrl + d (save / exit nano / exit container). <br><br>  We restart our docker container: <br><br><pre> <code class="bash hljs">$ docker restart mtproto-proxy2</code> </pre> <br>  Everything, now on command: <br><br><pre> <code class="bash hljs">$ curl http://localhost:2398/stats <span class="hljs-comment"><span class="hljs-comment">#  </span></span></code> </pre> <br><img src="https://habrastorage.org/webt/om/8i/op/om8iopyma3srr8mzy_lqmramt80.png"><br>  In statistics, there is a lot of ‚Äúgarbage‚Äù (on the screen 1/3 of its part), create alias: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias telega='curl localhost:2398/stats | grep -e total_special -e load_average_total'"</span></span> &gt;&gt; .bashrc &amp;&amp; bash</code> </pre> <br>  We get what polished the docker container for: the number of connections and the load: <br><br><pre> <code class="bash hljs">$ telega</code> </pre> <br><img src="https://habrastorage.org/webt/10/lj/r2/10ljr21sournprsdrqhjtbm9eb0.png"><br>  <u>Docker container is working, statistics are spinning.</u> <br><br><h2>  Resources spent </h2><br>  <s>No matter how cool you are, Stuart Redman even you leave a mark on go on your underpants</s> .  A working Docker image leaves a rather big mark. <br><br>  It does not make sense to describe the advantages and disadvantages of docker images; a docker container is a mini-virtual machine that consumes resources less than a ‚Äúreal‚Äù virtual machine, such as VirtualBox, but consumes it. <br><br>  1) Launched with or without docker image statistics, two clients frolic or ten - resources are disposed of ~ the same way: 75% of the total CPU t2.micro performance. <br><br>  2) We look at monitoring the VPC server: <br><br><img src="https://habrastorage.org/webt/ar/zm/cy/arzmcynn4h3s8d_odcuo1ubshla.png"><br><br>  From the graph of resource utilization on VPC, we see that the docker container constantly consumes ~ 7.5% of the total max.  CPU performance and on May 28 I was stopped intentionally / temporarily <i>(Note - OpenVPN &amp; pptp are also running on the server).</i> <br><br>  Why is 10% of the constant CPU load the limit for this server? <br><br>  Because there are restrictions on the part of Amazon EC2 and they are calculated in loans: <br><br><img src="https://habrastorage.org/webt/iq/cb/zy/iqcbzydrf99mavkegpjbcabh5ea.png"><br><br>  1 CPU credit = 1 CPU working with 100% load for one minute, and we have 6 credits (that is, at peak 100% CPU utilization is possible within 6 minutes, and then the CPU power will decrease).  Other combinations: for example, 1 CPU credit = 1 CPU working with a 50% load for two minutes (that is, we can use a CPU with a 50% load for 12 minutes), or, for example, a constant 10% - CPU load during the whole time and etc. <br><br><h4>  findings </h4><br><ul><li>  <s>We are part of Digital Resistance.</s>  Provided their ‚Äúdads and moms‚Äù with a reliable communication channel. </li><li>  If you have MtprotoProxyTelegram and OpenVPN deployed on the server, but no more, there will be no delays / pings / failures, but if you are constantly experimenting with your t2 / micro, then wait for communication brakes. </li><li>  My overseas ping is ~ 100-250ms, there are no delays in voice communication. </li><li>  Financial costs for all ‚Äúthis‚Äù (including VPC resources) = 0‚ÇΩ. </li></ul><br>  <i>Reprint of his article.</i> <br><br>  <i>UPD: Thanks to some habrayuzers for useful comments, it is really possible (statistics supported?), There are better analogues to the official docker-image of Mtproto proxy Telegram.</i> </div><p>Source: <a href="https://habr.com/ru/post/461837/">https://habr.com/ru/post/461837/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461823/index.html">Enhanced Four Rules for Software Design</a></li>
<li><a href="../461827/index.html">Hybrid PHP / Go Application Development Using RoadRunner</a></li>
<li><a href="../46183/index.html">Domain .tel: Internet Phone Directory</a></li>
<li><a href="../461831/index.html">StealthWatch: Deployment and Customization. Part 2</a></li>
<li><a href="../461833/index.html">Do not get lost in three pines: an egocentric representation of the environment</a></li>
<li><a href="../461845/index.html">Investments on the stock exchange as a way to preserve finances: 3 working methods</a></li>
<li><a href="../461849/index.html">PVS-Studio glanced at Red Dead Redemption engine - Bullet</a></li>
<li><a href="../461855/index.html">Salaries in IT in the first half of 2019: according to the salary calculator My Circle</a></li>
<li><a href="../461859/index.html">You don't know anything about food tech</a></li>
<li><a href="../461861/index.html">Office 365 Cloud Services: Check Point CloudGuard SaaS Testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>