<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ansible: testing playbooks (part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think any system administrator who uses Ansible to manage his zoo servers wondered about checking the correctness of the description of the configur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">ğŸ”</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">ğŸ“œ</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">â¬†ï¸</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">â¬‡ï¸</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ansible: testing playbooks (part 1)</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/70f/307/920/70f307920e014fca8bc019fc8df7719b.jpg"></div><br><br>  I think any system administrator who uses Ansible to manage his zoo servers wondered about checking the correctness of the description of the configuration of their servers.  How not to be afraid to make changes to server configurations? <br>  In a series of articles on DevOps, we will talk about this. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Several conditions under which we will perform configuration testing: <br><br>  1. All configuration is stored in git-repository. <br>  2. Jenkins (CI-service) periodically polls the repository with our roles / playbooks for any changes. <br>  3. When changes appear, Jenkins launches the configuration build and covers it with tests.  Tests consist of two stages: <br>  3.1 Test-kitchen takes the updated code from the repository, launches a completely fresh docker-container, floods the updated playbooks from the repository and launches the ansible locally in the docker-container. <br>  3.2 If the first stage was successful, the serverspec is started in the docker-container and checks whether the new configuration correctly stood up. <br>  4. If in the test-kitchen all the tests were successful, then Jenkins initiates the filling of a new configuration. <br><br>  Of course, you can run each playbook / role in Vagrant (good, there is such a cool thing as <a href="https://www.vagrantup.com/docs/provisioning/ansible.html">provisioning</a> ), to check that the configuration is as expected, but every time to test a new or modified configuration, it is a dubious pleasure to perform so many manual actions.  What for?  After all, you can automate everything.  To do this, we come to such wonderful tools as <a href="http://kitchen.ci/">Test-kitchen</a> , <a href="http://serverspec.org/">Serverspec</a> and, of course, <a href="https://www.docker.com/">Docker</a> . <br><br>  Let's first consider how we test the code in the Test-kitchen using the example of a pair of spherical roles in a vacuum. <br><br><h2>  Ansible. </h2><br><br>  Ansible I collected the latest, most recent of the sources.  I prefer to collect by hand.  (for whom laziness - you can use <a href="https://github.com/neillturner/omnibus-ansible">Omnibus-ansible</a> ) <br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">git</span></span> clone git://github.com/ansible/ansible.git --recursive cd ./ansible</code> </pre> <br><br>  We compile and install a deb package (weâ€™ll be testing Debian CDs). <br><pre> <code class="hljs matlab">make deb dpkg -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> deb-build/unstable/ansible_2<span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">-0.</span></span>git201604031531.d358a22.devel~unstable_all.deb</code> </pre><br><br>  Ansible rose, check: <br><pre> <code class="hljs javascript">ansible --version ansible <span class="hljs-number"><span class="hljs-number">2.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> config file = <span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>ansible/ansible.cfg configured <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> search path = Default w/o overrides</code> </pre><br><br>  Fine!  So it's time to get down to business. <br><br>  Now we need to create a git repository. <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> /srv/ansible &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /srv/ansible git init <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> base &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> base #     </code> </pre><br><br>  The repository architecture is approximately as follows: <br><pre> <code class="hljs css">â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">ansible</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cfg</span></span> â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">inventory</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">group_vars</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">hosts</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ini</span></span> â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">host_vars</span></span> â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">logs</span></span> â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">roles</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">common</span></span> â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">defaults</span></span> â”‚ â”‚ â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">files</span></span> â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">handlers</span></span> â”‚ â”‚ â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">tasks</span></span> â”‚ â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">install_packages</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”‚ â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">templates</span></span> â”‚ â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">vars</span></span> â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">defaults</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">files</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">handlers</span></span> â”‚ â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">tasks</span></span> â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">configure</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">install</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”‚ â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">templates</span></span> â”‚ â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.conf</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.j2</span></span> â”‚ â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">vars</span></span> â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">site</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span> â”œâ”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">Vagrantfile</span></span> â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">vars</span></span> â””â”€â”€ <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.yml</span></span></code> </pre><br><br>  We will not change the default configuration file; we will only make our own changes to the project configuration file. <br><br>  ansible.cfg: <br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">defaults</span></span>] roles_path = ./roles/ <span class="hljs-meta"><span class="hljs-meta">#    retry_files_enabled = False #  retry-      become = yes #    sudo log_path = ./logs/ansible.log #  inventory = ./inventory/ #   inventory-.</span></span></code> </pre><br><br>  Next, we need an inventory file, where we need to specify a list of hosts with which we will work. <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> inventory <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> invetory <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> host_vars <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> group_vars</code> </pre><br><br>  Invetory file: <br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ansible_connection=<span class="hljs-keyword"><span class="hljs-keyword">local</span></span></code> </pre><br><br>  Here are all the hosts that will be managed by ansible. <br>  <i>host_vars</i> is the folder where variables will be stored, which may differ from the base values â€‹â€‹in the role. <br>  Example: in ansible the jinja2 template engine can be useful when working with files and configs. <br>  We have a template <i>resolv.conf templates / resolv.conf.j2</i> : <br><pre> <code class="hljs django"><span class="xml"><span class="xml">nameserver </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ nameserver }}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br><br>  The default variable file ( <i>roles / common / defaults / main.yml</i> ) states: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">nameserver</span></span>: 8<span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span></code> </pre><br><br>  But on host <i>1.1.2.2</i> we need to flood the <i>resolv.conf</i> with a different <i>nameserver</i> value. <br>  We turn it through <i>host_vars / 1.1.2.2.yml</i> : <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">nameserver</span></span>: 8<span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span></code> </pre><br><br>  In this case, when executing a playbook, a standard <i>resolv.conf</i> (with a value of <i>8.8.8.8</i> ) will be flooded onto all hosts, and with a value of <i>8.8.4.4</i> on a host <i>1.1.2.2</i> . <br>  Read more about this in the <a href="https://docs.ansible.com/ansible/intro_inventory.html">Ansible documentation.</a> <br><br><h3>  common-role </h3><br><br>  This is the role that performs standard tasks that must be performed on all hosts.  Installing any packages, for example, the establishment of users, etc. <br>  I described the structure a bit higher.  Let's go over the details. <br><br>  Role structure: <br><pre> <code class="hljs axapta">./roles/<span class="hljs-keyword"><span class="hljs-keyword">common</span></span>/ â”œâ”€â”€ defaults â”‚ â””â”€â”€ main.yml â”œâ”€â”€ files â”œâ”€â”€ handlers â”‚ â””â”€â”€ main.yml â”œâ”€â”€ tasks â”‚ â”œâ”€â”€ install_packages.yml â”‚ â””â”€â”€ main.yml â”œâ”€â”€ templates â””â”€â”€ vars</code> </pre><br><br>  In the <i>roles / common / defaults / main.yml file</i> , the default variables are specified. <br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- deb_packages: - curl - fail2ban - git - vim rh_packages: - curl - epel-release - git - vim</span></span></code> </pre><br><br>  The <i>files</i> folder contains files that should be copied to a remote host. <br>  The <i>tasks</i> folder lists all the tasks that must be performed when assigning a role to a host. <br><pre> <code class="hljs axapta">roles/<span class="hljs-keyword"><span class="hljs-keyword">common</span></span>/tasks/ â”œâ”€â”€ install_packages.yml â”œâ”€â”€ main.yml</code> </pre><br><br>  <i>roles / common / tasks / install_packages.yml</i> <br><pre> <code class="hljs perl">--- - name: installing Debian/Ubuntu pkgs apt: pkg={{ item }} update_cache=yes with_items: <span class="hljs-string"><span class="hljs-string">"{{deb_packages}}"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: (ansible_os_family == <span class="hljs-string"><span class="hljs-string">"Debian"</span></span>) - name: install RHEL/CentOS packages yum: pkg={{ item }} with_items: <span class="hljs-string"><span class="hljs-string">"{{rh_packages}}"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: (ansible_os_family == <span class="hljs-string"><span class="hljs-string">"RedHat"</span></span>)</code> </pre><br><br>  Here, the <i>with_items</i> and <i>when</i> cycles are used.  If the distribution package is of the Debian family, packages from the <i>deb_packages</i> list will be installed using the <a href="https://docs.ansible.com/ansible/apt_module.html">apt</a> module.  If the distribution is a RedHat family, packages from the <i>rh_packages</i> list will be installed using the <a href="https://docs.ansible.com/ansible/yum_module.html">yum</a> module. <br><br>  <i>roles / common / tasks / main.yml</i> <br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- - include: install_packages.yml</span></span></code> </pre><br><br>  (Yes, I really love decomposing roles to separate files with my tasks). <br><br>  The <i>main.yml</i> file simply includes yaml files, where all tasks described in the <i>tasks</i> folder are described. <br><br>  In the <i>templates</i> folder there are templates in <a href="http://jinja.pocoo.org/docs/dev/templates/">Jinja2</a> format (the example with resolv.conf was considered above). <br><br>  The <i>handlers</i> folder lists actions that can be performed after performing any tasks.  Example: we have a piece of task: <br><pre> <code class="hljs pgsql">- <span class="hljs-type"><span class="hljs-type">name</span></span>: installing Debian packages apt: pkg=fail2ban update_cache=yes <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: (ansible_os_family == "Debian") <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> fail2ban</code> </pre><br><br>  and <i>roles / common / handlers / main.yml handler</i> : <br><pre> <code class="hljs delphi">--- - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> restart fail2ban service: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=fail2ban state=restarted</code> </pre><br><br>  In this case, after performing the apt task: <i>pkg = fail2ban update_cache = yes</i> , the <i>restart fail2ban</i> handler task will start.  In other words, fail2ban will restart as soon as it is installed.  Otherwise, if fail2ban is already installed in our system, then the notification and launch of the handler will be ignored) <br><br>  In the <i>vars</i> folder, <i>you</i> can specify variables that should be used by default. <br>  <i>/vars/common.yml</i> <br><pre> <code class="hljs mel">--- deb_packages: - curl - fail2ban - vim - git - htop - atop - <span class="hljs-keyword"><span class="hljs-keyword">python</span></span>-pycurl - sudo rh_packages: - curl - epel-release - vim - git - fail2ban - htop - atop - <span class="hljs-keyword"><span class="hljs-keyword">python</span></span>-pycurl - sudo</code> </pre><br><br><h2>  Test-kitchen + serverspec. </h2><br><br>  Resources used: <br><br>  <a href="http://serverspec.org/resource_types.html">serverspec.org/resource_types.html</a> <br><br>  <a href="https://github.com/test-kitchen/test-kitchen">github.com/test-kitchen/test-kitchen</a> <br>  <a href="https://github.com/portertech/kitchen-docker">github.com/portertech/kitchen-docker</a> <br>  <a href="https://github.com/neillturner/kitchen-verifier-serverspec">github.com/neillturner/kitchen-verifier-serverspec</a> <br>  <a href="https://github.com/neillturner/kitchen-ansible">github.com/neillturner/kitchen-ansible</a> <br>  <a href="https://github.com/neillturner/omnibus-ansible">github.com/neillturner/omnibus-ansible</a> <br><br>  Test-kitchen is a tool for integration testing.  It prepares the environment for testing, allows you to quickly launch the container / virtual machine and test the playbook / role. <br>  Able to work with vagrant.  but we will use docker as a provider. <br>  Installed as a gem, you can use <i>gem install test-kitchen</i> , but I prefer to use the bundler.  To do this, you need to create a Gemfile in the project folder and register all the gems and their versions in it. <br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">source</span></span> <span class="hljs-string"><span class="hljs-string">'https://rubygems.org'</span></span> gem <span class="hljs-string"><span class="hljs-string">'net-ssh'</span></span>,<span class="hljs-string"><span class="hljs-string">'~&gt; 2.9'</span></span> gem <span class="hljs-string"><span class="hljs-string">'serverspec'</span></span> gem <span class="hljs-string"><span class="hljs-string">'test-kitchen'</span></span> gem <span class="hljs-string"><span class="hljs-string">'kitchen-docker'</span></span> gem <span class="hljs-string"><span class="hljs-string">'kitchen-ansible'</span></span> gem <span class="hljs-string"><span class="hljs-string">'kitchen-verifier-serverspec'</span></span></code> </pre><br><br>  It is very important to specify the version of the net-ssh heme, since with the newer version test-kitchen will probably not work. <br>  Now you need to run <i>bundle install</i> and wait until all the gems with dependencies are installed. <br>  In the folder with the project do kitchen init.  A <i>.kitchen.yml</i> file will appear in the folder, which should be approximated as follows: <br><pre> <code class="hljs bash">--- driver: name: docker provisioner: name: ansible_playbook hosts: localhost require_chef_for_busser: <span class="hljs-literal"><span class="hljs-literal">false</span></span> require_ansible_omnibus: <span class="hljs-literal"><span class="hljs-literal">true</span></span> use_sudo: <span class="hljs-literal"><span class="hljs-literal">true</span></span> platforms: - name: ubuntu-14.04 driver_config: image: vbatuev/ubuntu-rvm - name: debian-8 driver_config: image: vbatuev/debian-rvm verifier: name: serverspec additional_serverspec_command: <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/.rvm/scripts/rvm suites: - name: Common provisioner: name: ansible_playbook playbook: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/integration/default.yml verifier: patterns: - roles/common/spec/common_spec.rb</code> </pre><br><br>  At this stage, I had difficulty running the serverspec in the container, so I had to apply a small workaround. <br>  All images are compiled by me and uploaded to <a href="https://hub.docker.com/r/vbatuev/">dockerhub</a> , in each image, the kitchen user is started, from which tests are run, and rvm is installed with the ruby â€‹â€‹2.3 version. <br>  The <i>additional_serverspec_command</i> parameter indicates that we will use rvm.  This is a way in which dances with a tambourine around ruby â€‹â€‹versions in standard repositories, gem dependencies, and rspec launch are not needed.  Otherwise, with the launch of serverspec tests will have to sweat. <br>  The fact is that kitchen-verifier-serverspec is still quite damp.  While writing an article, I had to send several bug reports and PR to the author. <br><br>  In the <i>suites</i> section, we specify a playbook with a role that will be checked. <br>  <i>playbook: test / integration / default.yml</i> <br><pre> <code class="hljs pgsql"><span class="hljs-comment"><span class="hljs-comment">--- - hosts: localhost sudo: yes roles: - common</span></span></code> </pre><br><br>  and patterns for test serverspec. <br><pre> <code class="hljs axapta"> verifier: patterns: - roles/<span class="hljs-keyword"><span class="hljs-keyword">common</span></span>/spec/common_spec.rb</code> </pre><br><br>  What the test looks like: <br>  <i>common_spec.rb</i> <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'/tmp/kitchen/roles/common/spec/spec_helper.rb'</span></span> describe package( <span class="hljs-string"><span class="hljs-string">'curl'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it { should be_installed } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  It is also very important to specify in the header <i>require</i> exactly this way.  Otherwise, he will not find and will not work. <br><br>  <i>spec_helper.rb</i> <br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'serverspec'</span></span> set <span class="hljs-symbol"><span class="hljs-symbol">:backend</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:exec</span></span></code> </pre><br><br>  A complete list of what serverspec can check is listed <a href="http://serverspec.org/resource_types.html">here</a> . <br><br>  Commands: <br><br>  <i>kitchen test</i> - runs all stages of the test. <br>  <i>kitchen converge</i> - launches a playbook in a container. <br>  <i>kitchen verify</i> - starts the serverspec. <br><br>  The results should be something like this: <br><br>  When performing a playbook: <br><pre> <code class="hljs markdown"> Going to invoke ansible-playbook with: ANSIBLE<span class="hljs-emphasis"><span class="hljs-emphasis">_ROLES_</span></span>PATH=/tmp/kitchen/roles sudo -Es ansible-playbook -i /tmp/kitchen/hosts -c local -M /tmp/kitchen/modules /tmp/kitchen/default.yml [WARNING]: log file at ./logs/ansible.log is not writeable and we cannot create it, aborting [DEPRECATION WARNING]: Instead of sudo/sudo<span class="hljs-emphasis"><span class="hljs-emphasis">_user, use become/become_</span></span>user and make sure become<span class="hljs-emphasis"><span class="hljs-emphasis">_method is 'sudo' (default). This feature will be removed in a future release. Deprecation warnings can be disabled by setting deprecation_</span></span>warnings=False in ansible.cfg. PLAY <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> TASK [setup] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">** ok: [localhost] TASK [common : include] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** included: /tmp/kitchen/roles/common/tasks/install_packages.yml for localhost TASK [common : install {{ item }} pkgs] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*** changed: [localhost] =&gt; (item=[u'curl', u'fail2ban', u'git', u'vim']) TASK [common : install {{ item }} packages] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** skipping: [localhost] =&gt; (item=[]) TASK [common : include] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** included: /tmp/kitchen/roles/common/tasks/create_users.yml for localhost TASK [common : Create admin users] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*** TASK [common : include] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** included: /tmp/kitchen/roles/common/tasks/delete_users.yml for localhost TASK [common : Delete users] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** ok: [localhost] =&gt; (item={u'name': u'testuser'}) RUNNING HANDLER [common : start fail2ban] **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [localhost] PLAY RECAP *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">***</span></span> localhost : ok=7 changed=2 unreachable=0 failed=0 Finished converging <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Common-ubuntu-1404</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> (3m58.17s).</code> </pre><br><br>  When starting serverspec: <br><pre> <code class="hljs vhdl"> Running Serverspec <span class="hljs-keyword"><span class="hljs-keyword">Package</span></span> <span class="hljs-string"><span class="hljs-string">"curl"</span></span> should be installed <span class="hljs-keyword"><span class="hljs-keyword">Package</span></span> <span class="hljs-string"><span class="hljs-string">"vim"</span></span> should be installed <span class="hljs-keyword"><span class="hljs-keyword">Package</span></span> <span class="hljs-string"><span class="hljs-string">"fail2ban"</span></span> should be installed <span class="hljs-keyword"><span class="hljs-keyword">Package</span></span> <span class="hljs-string"><span class="hljs-string">"git"</span></span> should be installed Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.12682</span></span> seconds (files took <span class="hljs-number"><span class="hljs-number">0.40257</span></span> seconds <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> load) <span class="hljs-number"><span class="hljs-number">4</span></span> examples, <span class="hljs-number"><span class="hljs-number">0</span></span> failures Finished verifying &lt;Common-ubuntu-<span class="hljs-number"><span class="hljs-number">1404</span></span>&gt; (<span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">93</span></span>s).</code> </pre><br><br>  If everything went well, it means that we have just prepared the first stage for testing playbooks and ansible roles.  In the next part, we will look at how to add even more automation to test Ansible infrastructure code using such a great tool as Jenkins. <br><br>  How do you check your playbooks? <br><br>  Author: DevOps admin <a href="https://southbridge.ru/">Southbridge</a> - Victor Batuev. </div><p>Source: <a href="https://habr.com/ru/post/303762/">https://habr.com/ru/post/303762/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303750/index.html">Methodical notes on the selection of informative features (feature selection)</a></li>
<li><a href="../303752/index.html">Emsisoft experts found another JavaScript extortionist</a></li>
<li><a href="../303754/index.html">Alan Kay, the creator of the PLO, about the development of Lisp and PLO</a></li>
<li><a href="../303756/index.html">How we tested the Russian speedtest</a></li>
<li><a href="../303760/index.html">7 rules for writing world-class technical documentation</a></li>
<li><a href="../303768/index.html">Database backup via SQL VDI</a></li>
<li><a href="../303770/index.html">A bit about the performance of Cisco network equipment</a></li>
<li><a href="../303772/index.html">Super Mario World Method: Add-ons and Extensions</a></li>
<li><a href="../303774/index.html">BitrixFramework: take everything into our own hands</a></li>
<li><a href="../303776/index.html">Vice-president of new products Mail.ru Group Yuri Gursky - about their own projects: Maps.me, MSQRD and Prisma</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>