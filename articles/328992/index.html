<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We clean the tails of Microsoft Exchange Server 2016 using Powershell</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Working for six months with Microsoft Exchange Server 2016 in a company where more than 500 employees use corporate email, I was faced with the proble...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We clean the tails of Microsoft Exchange Server 2016 using Powershell</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/738/398/aef/738398aefbb77784110faea770c9d5e3.png" alt="image"><br><br>  Working for six months with Microsoft Exchange Server 2016 in a company where more than 500 employees use corporate email, I was faced with the problem of fully deleting information about users disabled in <b>Active Directory</b> . <br><a name="habracut"></a><br>  Tasks that we want to automate after disabling user account in AD: <br><br><ul><li>  Export all letters from the main and archive mailbox to a .pst file; </li><li>  Complete mailbox blocking after exporting letters; </li><li>  Clearing all mailing lists from dead users (not automatically cleared); </li><li>  Update <b>Global Address List</b> and <b>Offline Address Book</b> so that active users do not see disconnected. </li></ul><br>  Feeling utter dislike for manual work, it was decided to maximally automate all these tasks using <b>PowerShell</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Training: </h2><br>  Connecting the Exchange Management PowerShell library: <br><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Add-PSSnapin</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Microsoft</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Exchange</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Management</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PowerShell</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.SnapIn</span></span>;</code> </pre> <br>  We get a list of all users disabled in <b>Active Directory</b> and exclude some service records: <br><br><pre> <code class="hljs perl">$DisableUsers = get-user -Filter {(UserAccountControl -eq <span class="hljs-string"><span class="hljs-string">'AccountDisabled, NormalAccount'</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (RecipientType -eq <span class="hljs-string"><span class="hljs-string">'UserMailbox'</span></span>)} | ? {($_.SamAccountName -<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'krbtgt'</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($_.SamAccountName -<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'SM_2013a5b0c2bd4ca2a'</span></span>) -<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ($_.SamAccountName -<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> <span class="hljs-string"><span class="hljs-string">'testvc'</span></span>)}</code> </pre><br>  We declare variables: <br><br><pre> <code class="hljs smalltalk">#        . <span class="hljs-string"><span class="hljs-string">$B</span></span>atchName = <span class="hljs-string"><span class="hljs-string">'MassRequest'</span></span> #     <span class="hljs-string"><span class="hljs-string">$C</span></span>Mounth = (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Date</span></span>).month <span class="hljs-string"><span class="hljs-string">$C</span></span>Year = (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Date</span></span>).year <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentDate = <span class="hljs-comment"><span class="hljs-comment">"$CYear.$CMounth"</span></span> #      . <span class="hljs-string"><span class="hljs-string">$M</span></span>ainDir = <span class="hljs-comment"><span class="hljs-comment">"\\% %"</span></span> <span class="hljs-string"><span class="hljs-string">$E</span></span>xportPath = <span class="hljs-string"><span class="hljs-string">$M</span></span>ainDir + <span class="hljs-string"><span class="hljs-string">$C</span></span>urrentDate + <span class="hljs-comment"><span class="hljs-comment">"\"</span></span></code> </pre><br><h2>  Treatment: </h2><br>  To make it easier to find the .pst archive of the dismissed user, it was decided to create a folder of the Year.Mescent type.  So, all dismissed users in April 2017 will fall into the folder 2017.4, dismissed in May into the folder 2017.5 and so on. <br><br><pre> <code class="hljs mel"># ,     .,  ,  . <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((Test-Path $ExportPath -PathType Container) -eq $false){ New-Item -Path $MainDir -Name $CurrentDate -ItemType <span class="hljs-string"><span class="hljs-string">"directory"</span></span> }</code> </pre><br>  In the cycle of disabled users, we unload their mail into the .pst file from the main and archive mailboxes and save it in the Year.Month folder. <br><br>  Using the <b>-BatchName</b> parameter, <b>we</b> combine requests under one name, to be able to track the status of the entire upload at once, rather than each request separately. <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($User in $DisableUsers){ $PrimaryPath = $ExportPath + $User.SamAccountName + <span class="hljs-string"><span class="hljs-string">".pst"</span></span> $ArhivePath = $ExportPath + $User.SamAccountName + <span class="hljs-string"><span class="hljs-string">"_Archive.pst"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-MailboxExportRequest -Mailbox $User.SamAccountName -BatchName $BatchName -FilePath $PrimaryPath <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-MailboxExportRequest -Mailbox $User.SamAccountName -BatchName $BatchName -FilePath $ArhivePath -IsArchive }</code> </pre><br>  We are waiting for the script to finish.  It is necessary to wait, because  then we translate the boxes into <b>Disable</b> status and want to be sure that the mail unloading is over. <br><br><pre> <code class="hljs mel"># ,     $i=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((Get-MailboxExportRequest -BatchName $BatchName | Where {($_.Status -eq ‚ÄúQueued‚Äù) -or ($_.Status -eq ‚ÄúInProgress‚Äù)})) { sleep <span class="hljs-number"><span class="hljs-number">60</span></span> Write-Host <span class="hljs-string"><span class="hljs-string">"  $i .  .."</span></span> $i=$i+<span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre><br>  After the export is completed, we delete all requests that received the status <b>Completed.</b> <br><br><pre> <code class="hljs pgsql">#       <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-MailboxExportRequest -Status Completed | Remove-MailboxExportRequest -Confirm:$<span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre><br>  The first part is done, we begin to clean the mailing lists.  First we get an array of all the lists: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">#    .     . $DistribList = Get-DistributionGroup</span></span></code> </pre><br>  In the cycle we go over all mailing lists and delete the disabled users: <br><br><pre> <code class="hljs mel">#         foreach($List <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $DistribList){ foreach($User <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $DisableUsers){ Remove-DistributionGroupMember -Identity $List -Member $User -Confirm:$false -ErrorAction Ignore } }</code> </pre><br>  The penultimate stage: disable mailboxes.  E-mail disappears from the user's account in AD, and the mailbox itself is deleted.  Now it can only be restored for some time using standard Exchange tools. <br><br><pre> <code class="hljs mel">#    ,        foreach($User <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $DisableUsers){ Disable-Mailbox -Identity $User.SamAccountName -Archive -Confirm:$false Disable-Mailbox -Identity $User.SamAccountName -Confirm:$false }</code> </pre><br>  We update GAL and OAB so that users can see the changes as quickly as possible. <br><br><pre> <code class="hljs pgsql">#  <span class="hljs-keyword"><span class="hljs-keyword">Global</span></span> Adress List,        <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-GlobalAddressList | <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span>-GlobalAddressList <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-OfflineAddressBook | <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span>-OfflineAddressBook <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-AddressList | <span class="hljs-keyword"><span class="hljs-keyword">Update</span></span>-AddressList</code> </pre><br><h2>  A small comment: </h2><br>  In our company, we attached this processing to a custom button in 1C.  The personnel department in the employee profile assigns him the status ‚ÄúFired‚Äù and the script starts working. <br><br>  Thus, it is almost impossible to see disconnected users in the address book, and a dismissed employee immediately loses access to mail.  (If you only turn off accounting in <b>Active Directory</b> , then an employee can still go into the mail, which is unacceptable under our corporate policy). <br><br>  I hope someone script will be useful.  Thank! </div><p>Source: <a href="https://habr.com/ru/post/328992/">https://habr.com/ru/post/328992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328980/index.html">When you need a corporate app store</a></li>
<li><a href="../328984/index.html">Open broadcast DotNext 2017 Piter: Jon Skeet, Sasha Goldshtein and Andrey Akinshin live</a></li>
<li><a href="../328986/index.html">Breaking words into elements of the periodic table</a></li>
<li><a href="../328988/index.html">How to choose a reliable data center provider: seven success factors</a></li>
<li><a href="../328990/index.html">Tours in exploratory testing. Personal translation from D. Whittaker's book "Software Research Testing"</a></li>
<li><a href="../328994/index.html">Tale of two printers, or how we drove the Ricoh printers</a></li>
<li><a href="../328996/index.html">Marketing research. How to check the business idea for a week, spending a penny?</a></li>
<li><a href="../328998/index.html">Why constant traffic filtering is a necessity</a></li>
<li><a href="../329000/index.html">Test analysis in mobile development</a></li>
<li><a href="../329002/index.html">AsyncDisplayKit 2.0 (Texture) Tutorial: Getting Started</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>