<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM32F103C8T6 - we make an oscilloscope. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The third part ( first and second ) is about how I am doing an oscilloscope from a debugging board with a price of less than $ 3. Demo video of work: ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM32F103C8T6 - we make an oscilloscope. Part 3</h1><div class="post__text post__text-html js-mediator-article">  The third part ( <a href="https://habr.com/post/384723/">first</a> and <a href="https://habr.com/post/385385/">second</a> ) is about how I am doing an oscilloscope from a debugging board with a price of less than $ 3.  Demo video of work: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/Rh4XskDlWW4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  And the description of some key features under the cut. <br><br><a name="habracut"></a><br><br><h2>  Analog part </h2><br>  Almost everything as described in the <a href="https://habr.com/post/264150/">second part</a> , except for the source of bipolar power.  OU consume a significant current (about 10 mA) and it did not succeed as they did not try to obtain acceptable results by the schemes of voltage multiplier on diodes and capacitors.  Therefore, for a positive voltage, I installed such a module based on MT3608: <br><img src="https://habrastorage.org/files/a57/4ce/365/a574ce3651e04e83bccd2b49c60f38a2.jpg"><br>  configured for 10 V output voltage.  And the negative voltage is obtained by inverting the positive with the help of LT1054. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  About code size </h2><br>  In the <a href="https://habr.com/post/263210/">first part</a> I wrote that a lot of memory is consumed.  Now I have come to the point that the program does not fit into the memory and studied this issue in more detail. <br><br>  CooCox CoIDE displays information about the size of the program as follows: <br><pre><code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">text</span></span> data bss <span class="hljs-type"><span class="hljs-type">dec</span></span> hex filename <span class="hljs-number"><span class="hljs-number">60224</span></span> <span class="hljs-number"><span class="hljs-number">2500</span></span> <span class="hljs-number"><span class="hljs-number">10540</span></span> <span class="hljs-number"><span class="hljs-number">73264</span></span> <span class="hljs-number"><span class="hljs-number">11e30</span></span> projectName.elf</code> </pre> <br>  Where <br><ul><li>  text - the size of the segment with the code, interrupt vectors and constants read-only; </li><li>  data - the size of the segment with variables initialized by non-zero; </li><li>  bss - the size of the segment with uninitialized and zero-initialized variables. </li></ul><br><br>  The whole program takes: <br><ul><li>  flash - text + data + 10..50 bytes </li><li>  RAM - data + bss + 10..50 bytes </li></ul><br><br>  Now look at what memory is wasted.  Making a new project and compiling: <br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">text</span></span> data bss <span class="hljs-type"><span class="hljs-type">dec</span></span> hex filename <span class="hljs-number"><span class="hljs-number">364</span></span> <span class="hljs-number"><span class="hljs-number">1080</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">1476</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>c4 test-size.elf</code> </pre><br>  To use macros of type GPIO_BSRR_BS9, you must include the file stm32f10x.h. <br>  To connect the stm32f10x.h file, add the component STM32F10x_MD_STDLIB in the repositories, which pulls cmsis_core behind it.  As a result, for a program writing one value to a register, we get: <br><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">text</span></span> data bss <span class="hljs-type"><span class="hljs-type">dec</span></span> hex filename <span class="hljs-number"><span class="hljs-number">1316</span></span> <span class="hljs-number"><span class="hljs-number">1104</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">2452</span></span> <span class="hljs-number"><span class="hljs-number">994</span></span> test-size.elf</code> </pre><br>  Further I am interested in functions like sprintf and sscanf.  To use them you need to define some functions like _sbrk and possibly some others.  I took the finished file (there is an archive with the project).  Add 1 sscanf call and get: <br><div class="spoiler">  <b class="spoiler_title">Try to guess how much before you watch!</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"> <span class="hljs-type"><span class="hljs-type">text</span></span> data bss <span class="hljs-type"><span class="hljs-type">dec</span></span> hex filename <span class="hljs-number"><span class="hljs-number">39312</span></span> <span class="hljs-number"><span class="hljs-number">2264</span></span> <span class="hljs-number"><span class="hljs-number">96</span></span> <span class="hljs-number"><span class="hljs-number">41672</span></span> a2c8 test-size.elf</code> </pre><br>  41 kb flash!  More than half of what is in the controller! <br>  In the working firmware, when using printf, adding sscanf increases flash consumption by 13.2 KB.  As a result, sscanf refused, and the PC team began to parse the less resource-intensive method. <br>  Failure to printf saves another 8.3 KB. <br></div></div><br><br><h2>  Modes of operation </h2><br>  Implemented 3 modes by the principle of operation: continuous, batch and logical, and 3 by the number of channels: 1, 2 and 4 channels. <br>  MK has 9 analog inputs, but I can not imagine when I may need more than 4 channels. <br><br><h3>  Continuous </h3><br>  Everything is simple: in the main MK cycle, we read the ADC data and transfer them to a PC, where we can build a continuous schedule.  The disadvantage is the speed limit from the channel MK -&gt; PC.  To get around it implemented another 2 modes. <br><br><h3>  Batch </h3><br>  In this mode, the MC first collects data, then transfers it to the PC in a pack.  Optionally it can be overclocked.  About overclocking wrote in detail in the previous parts. <br><br>  In this mode, synchronization is possible.  And you can analyze the signal before the condition.  To implement this functionality, we had to change the DMA operation mode to a ring one, use the interrupt of filling half of the buffer, and use a buffer containing 2 times more data than in the transmitted packet. <br><br>  Unlike <a href="https://habr.com/post/278198/">the</a> <a href="https://habr.com/users/baghear/" class="user_link">baghear</a> <a href="https://habr.com/post/278198/">project</a> , I have a software trigger.  The advantages of this solution: <br><ul><li>  Less parts, which means less price and easier installation; </li><li>  The ability to implement more complex triggers in the future, and not just ‚Äúthe signal in the A channel has become more X‚Äù. </li></ul><br><br>  In single-channel mode, both ADCs in turn convert the value of one channel. <br>  In a two-channel channel, each ADC converts its channel by starting simultaneously with another. <br>  In 4-channel - each ADC has 2 channels, which it converts.  The start of both ADCs is simultaneous. <br>  Obviously, the speed of the channel conversion frequency is inversely proportional to the number of channels. <br><br><h3>  Logic analyzer </h3><br>  The fastest mode.  Approximately 20 MSPS per channel.  The fastest code for this mode looks like this: <br><pre> <code class="hljs rust"><span class="hljs-built_in"><span class="hljs-built_in">u32</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; dataBuffer.<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>[i] = GPIOA-&gt;IDR; dataBuffer.<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>[++i] = GPIOA-&gt;IDR; dataBuffer.<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>[++i] = GPIOA-&gt;IDR; dataBuffer.<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>[++i] = GPIOA-&gt;IDR; dataBuffer.<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>[++i] = GPIOA-&gt;IDR; dataBuffer.<span class="hljs-built_in"><span class="hljs-built_in">u8</span></span>[++i] = GPIOA-&gt;IDR;</code> </pre><br>  and so on for the entire buffer. <br>  The value of the variable i in this case is calculated at the compilation stage and as a result from dataBuffer.u8 [++ i] = GPIOA-&gt; IDR;  It turns out only 2 operations - load data into the register from the port and save the data into memory at a pre-calculated address.  No cycles of such performance was achieved. <br><br><h2>  PC software </h2><br>  The main, in my opinion, change - the transition to OpenGL.  With him, drawing graphics has become easier (for me it turned out to be unexpected, but everything is really simple and brief there!), They are drawn faster and are much more beautiful than they were before. <br><br><h2>  Total </h2><br>  The project is not completed, there are glitches, there is a lot more to finish, but some breakthroughs are not foreseen.  For faster systems, you need another hardware, for example, a separate ADC + FPGA + memory - and this will be much more expensive and more difficult to mount. <br><br>  <a href="https://habr.com/post/278198/">After reading the</a> comments on the <a href="https://habr.com/post/278198/">article "The history of one oscilloscope on stm32" I</a> immediately answer some questions: <br><ul><li>  I am not going to fasten the display because: <br><ul><li>  It costs money, but the computer is there. </li><li>  The quality will be worse than on a large PC screen. </li><li>  Creating and modifying a user interface in C # is easier than soldering and soldering. </li></ul><br></li><li>  I do not plan to bring it a commercial product and sell it. </li><li>  Made for 2 goals: master the MK and make yourself a digital oscilloscope. </li></ul><br><br>  <a href="">Archive with the project</a> <br>  If anyone has any questions, but they are not registered here, write to the email: adefikux at gmail dot com. </div><p>Source: <a href="https://habr.com/ru/post/372453/">https://habr.com/ru/post/372453/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../372435/index.html">Scientists from Moscow State University have shown: complex calculations on personnel with efficiency not inferior to a supercomputer are possible.</a></li>
<li><a href="../372439/index.html">What does Brexit mean for the European FINTECH and IT market?</a></li>
<li><a href="../372441/index.html">Errors novice sales managers</a></li>
<li><a href="../372443/index.html">What genes give superpowers</a></li>
<li><a href="../372451/index.html">Ask Ethan # 69: Does the universe run away from us?</a></li>
<li><a href="../372455/index.html">Another success of the project ‚ÄúAttack on SORM‚Äù: the national provider received a license</a></li>
<li><a href="../372459/index.html">T-50: the most high-tech aircraft in Russia</a></li>
<li><a href="../372461/index.html">Why interrupted sleep is a great time for creative work.</a></li>
<li><a href="../372463/index.html">Wind river rocket is strong</a></li>
<li><a href="../372465/index.html">Current Week Abductions: Patchwork APT Group, another Mac backdoor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>