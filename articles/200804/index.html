<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We do motion detection, or OpenCV - it‚Äôs just</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is necessary to justify the name of the company - to do at least something related to the video. According to the previous topic, we can understand...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We do motion detection, or OpenCV - it‚Äôs just</h1><div class="post__text post__text-html js-mediator-article">  It is necessary to justify the name of the company - to do at least something related to the video.  According to the <a href="http://habrahabr.ru/company/avi/blog/199230/">previous</a> topic, we can understand that we are not only doing the <a href="http://habrahabr.ru/company/avi/blog/194438/">kettle</a> , but also sawing ‚Äúsmart lighting‚Äù for a smart home.  This week I was busy picking up <a href="http://ru.wikipedia.org/wiki/OpenCV">OpenCV</a> - a set of algorithms and libraries for working with computer vision.  Search for objects on the images, recognition of characters and all that jazz. <br><img src="https://habrastorage.org/getpro/habr/post_images/f6a/148/9c0/f6a1489c01042a2cc0a16ce35507b34e.jpg"><br>  In fact, doing something in it is not such a difficult task, even for a non-programmer.  So I'll tell you how. <br><a name="habracut"></a><br>  Immediately I say: the article can meet the most terrible bydlokod, which can scare you or deprive you of sleep until the end of life. <br><img src="https://habrastorage.org/getpro/habr/post_images/686/835/986/686835986d269e49d01aadd7220c052b.png"><br>  If you are not afraid yet - then welcome further. <br><br><h4>  Introduction <br></h4>  Actually, what was the idea.  I wanted to completely get rid of the manual inclusion of light.  We have an apartment, and there are people who move along it.  People need light.  All other objects in the apartment do not need light.  Objects do not move, but people move (if a person does not move - he either died or sleeps. The dead and the sleeping also do not need light).  Accordingly, it is necessary to cover only those places in the apartment, where there is some movement.  Movement stopped - you can turn off the light in half an hour. <br>  How to determine the movement? <br><br><h4>  About sensors <br></h4>  Here you can define such detectors: <br><img src="https://habrastorage.org/getpro/habr/post_images/f8b/145/c88/f8b145c88f04f60755a23033746dbc8c.jpg"><br>  They call it PIR - Passive Infrared Sensor.  Or not passive, but pyroelectric.  In short, it is based on, in fact, a single pixel of the imager - the same cell that issues a signal if the far infrared hits it. <br><img src="https://habrastorage.org/getpro/habr/post_images/8a0/859/e4c/8a0859e4cf4d3c6aa556c7d5fb58a29e.jpg"><br>  A simple scheme after it gives a pulse only if the signal changes dramatically - so it will not beep to the hot kettle, but there will be a moving warm object. <br>  Such detectors are installed in 99% of the alarms, and you think them all, saw them - these are the things that hang from the ceiling: <br><img src="https://habrastorage.org/getpro/habr/post_images/f8a/f8b/ea1/f8af8bea112a1a192d39bb1f31897818.jpg"><br>  Still the same things, but with strapping are more difficult to stand in contactless thermometers - those that measure the temperature in a couple of seconds on the forehead or in the ear. <br><img src="https://habrastorage.org/getpro/habr/post_images/215/321/915/215321915f0410df13fa91ba290dcf13.jpg"><br>  And in the pyrometers, the same thermometers, but with a large range: <br><img src="https://habrastorage.org/getpro/habr/post_images/a59/fc7/ec1/a59fc7ec173e15357b95ab02e5e04194.jpg"><br>  Although I was distracted.  Such sensors, of course, a good thing.  But they have a minus - it shows the movement in the whole volume of observation, without specifying where it happened - close, far.  And I have a big room.  And I want to turn on the light only in the part where the person works.  It was possible, of course, to put 5 such sensors, but I abandoned this idea - if you can get by with one camera for about the same amount, why put a bunch of sensors? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, I wanted to scratch OpenCV, not without it, yes.  So I found a camera in the bins, picked up a single-board ( <a href="http://chipster.ru/catalog/cubie/2183.html">CubieBoard2</a> on the A20) and drove off. <br><br><h4>  Installation <br></h4>  Naturally, to use OpenCV, you must first install.  In most modern systems (I‚Äôm talking about * nix), it is installed using a single command like apt-get install opencv.  But we'll go the easy way, right?  Yes, and for example in the system for single-board, which I use it is not. <br>  A comprehensive installation guide can be found <a href="http://robocraft.ru/blog/computervision/435.html">here</a> , so I will not dwell on it in great detail. <br>  We put cmake and GTK (here I‚Äôve put it with a clear conscience apt-get install cmake libgtk2.0-dev). <br>  Go to the <a href="http://opencv.org/downloads.html">offsite</a> and download the latest version.  But if we go to <a href="http://sourceforge.net/projects/opencvlibrary/">SourceForge</a> using the link from the manual for Robocraft, then we will download not the latest version (2.4.6.1), but 2.4.6, in which image reception from the camera via v4l2 does not work completely unexpectedly.  I did not know this, so for 4 days I tried to make this version work.  If only they wrote somewhere. <br>  Further - standard: <pre><code class="bash hljs">tar -xjf OpenCV-*.tar.bz2 &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> OpenCV-* &amp;&amp; cmake -D CMAKE_BUILD_TYPE=RELEASE -D CMAKE_INSTALL_PREFIX=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> ./ &amp;&amp; make &amp;&amp; make install</code> </pre> <br>  You can collect examples that come with: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> samples/c/ &amp;&amp; chmod +x build_all.sh &amp;&amp; ./build_all.sh</code> </pre><br>  Actually, most of my code is taken from an example called motempl - this is exactly the program that implements the functionality of motion detection in a frame.  It looks like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/97e/f06/b10/97ef06b100a11fe7e38c0b424b995064.png"><br><br><h4>  Dopilka <br></h4>  It works, but how to apply it to turn on the light?  It shows movement on the screen, but we need to know about this controller, which controls the lighting.  And it is desirable that he learn not the coordinates of the point, but the place where the light should be turned on. <br><br>  For a start, let's understand a little how this thing works.  To show the video from the camera in the window, much is not required: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cv.h&gt; #include &lt;highgui.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; int main(int argc, char* argv[]) { CvCapture* capture = cvCaptureFromCAM(0);//   CvCapture(   ,      ),   capture.       cvCaptureFromCAM, 0    ,        . IplImage* image = cvQueryFrame( capture ); //    ( image)        cvNamedWindow("image window", 1); //    image window for(;;) //    { image = cvQueryFrame( capture ); //         image cvShowImage("image window", image);//   (image window)   ,       cvWaitKey(10); // 10   .    ,      .   ,  -,    ,   . } }</span></span></span></span></code> </pre><br>  You can copy this program into the test.c file and compile it like this: <br><pre> <code class="bash hljs">gcc -ggdb `pkg-config --cflags opencv` -o `basename test.c .c` test.c `pkg-config --libs opencv`</code> </pre>  Again, to be honest, I do not quite understand what this team is doing.  Well collects.  Why exactly? <br><br>  It starts up and shows you the video from the camera.  But you can't even get out of it - the program is stuck in an endless loop and only Ctrl + C interrupts its meaningless life.  Add a button handler: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = cvWaitKey(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         . if (c == 113 || c == 81) //,   . 113  81 -    "q" -     . { cvReleaseCapture( &amp;capture ); //      . cvDestroyWindow("capture"); //  ,    ! return 0; //  . }</span></span></code> </pre><br><br>  And the FPS counter: <br><br><pre> <code class="cpp hljs">CvFont font; <span class="hljs-comment"><span class="hljs-comment">//  "" cvInitFont(&amp;font, CV_FONT_HERSHEY_COMPLEX_SMALL, 1.0, 1.0, 1,1,8); //   -  , ,  struct timeval tv0; //-   . int fps=0; int fps_sec=0; char fps_text[2]; int now_sec=0;//  ... gettimeofday(&amp;tv0,0); //   now_sec=tv0.tv_sec; //    if (fps_sec == now_sec) //,      ,      { fps++; // ,     (    ,   .) } else { fps_sec=now_sec; //  ,    snprintf(fps_text,254,"%d",fps); //    FPS fps=0; //   } cvPutText(image, fps_text, cvPoint(5, 20), &amp;font, CV_RGB(255,255,255));//   (image)     520,  ,  ,    , ,     .</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Full text of the program</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"opencv2/video/tracking.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"opencv2/highgui/highgui.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"opencv2/imgproc/imgproc_c.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;time.h&gt; #include &lt;stdio.h&gt; #include &lt;ctype.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;string.h&gt; #include &lt;errno.h&gt; int main(int argc, char** argv) { IplImage* image = 0; CvCapture* capture = 0; struct timeval tv0; int fps=0; int fps_sec=0; int now_sec=0; char fps_text[2]; CvFont font; cvInitFont(&amp;font, CV_FONT_HERSHEY_COMPLEX_SMALL, 1.0, 1.0, 1,1,8); capture = cvCaptureFromCAM(0); cvNamedWindow( "Motion", 1 ); for(;;) { IplImage* image = cvQueryFrame( capture ); gettimeofday(&amp;tv0,0); now_sec=tv0.tv_sec; if (fps_sec == now_sec) { fps++; } else { fps_sec=now_sec; snprintf(fps_text,254,"%d",fps); fps=0; } cvPutText(image, fps_text, cvPoint(5, 20), &amp;font, CV_RGB(255,255,255)); cvShowImage( "Motion", image ); if( cvWaitKey(10) &gt;= 0 ) break; } cvReleaseCapture( &amp;capture ); cvReleaseImage(&amp;image); cvDestroyWindow( "Motion" ); return 0; }</span></span></span></span></code> </pre> </div></div><br><br>  Now we have a program that shows video from the camera.  We need to somehow indicate to her those parts of the screen in which we need to define movement.  Do not pens them in pixels to set. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dig_key=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-comment"><span class="hljs-comment">//,    int region_coordinates[10][4]; // ,     . ... char c = cvWaitKey(20); //         . if (c &lt;=57 &amp;&amp; c&gt;= 48) //,       { dig_key=c-48; //key "0123456789" // ,      . } cvSetMouseCallback( "Motion", myMouseCallback, (void*) image); //,      myMouseCallback  ,      Motion    image if (region_coordinates[dig_key][0] != 0 &amp;&amp; region_coordinates[dig_key][1] != 0 &amp;&amp; region_coordinates[dig_key][2] == 0 &amp;&amp; region_coordinates[dig_key][3] == 0) // .        -     . cvRectangle(image, cvPoint(region_coordinates[dig_key][0],region_coordinates[dig_key][1]), cvPoint(region_coordinates[dig_key][0]+1,region_coordinates[dig_key][1]+1), CV_RGB(0,0,255), 2, CV_AA, 0 ); if (region_coordinates[dig_key][0] != 0 &amp;&amp; region_coordinates[dig_key][1] != 0 &amp;&amp; region_coordinates[dig_key][2] != 0 &amp;&amp; region_coordinates[dig_key][3] != 0) //       -   . cvRectangle(image, cvPoint(region_coordinates[dig_key][0],region_coordinates[dig_key][1]), cvPoint(region_coordinates[dig_key][2],region_coordinates[dig_key][3]), CV_RGB(0,0,255), 2, CV_AA, 0 ); void myMouseCallback( int event, int x, int y, int flags, void* param) //       ,    { IplImage* img = (IplImage*) param; // . ,       switch( event ){ //      case CV_EVENT_MOUSEMOVE: break; //     .  , ,      : printf("%dx %d\n", x, y); case CV_EVENT_LBUTTONDOWN: //     if (region_coordinates[dig_key][0] != 0 &amp;&amp; region_coordinates[dig_key][1] != 0 &amp;&amp; region_coordinates[dig_key][2] == 0 &amp;&amp; region_coordinates[dig_key][3] == 0) //   (    -      ),       -       { region_coordinates[dig_key][2]=x; //dig_key - ,    .      . region_coordinates[dig_key][3]=y; } if (region_coordinates[dig_key][0] == 0 &amp;&amp; region_coordinates[dig_key][1] == 0)//   (     ),      . { region_coordinates[dig_key][0]=x; region_coordinates[dig_key][1]=y; } break; } }</span></span></code> </pre><br><br>  Here's how it works: <br><img src="https://habrastorage.org/getpro/habr/post_images/a56/9fe/791/a569fe7915e2f3b6f0c495c63969f900.gif"><br>  Regions are switched by number buttons. <br><div class="spoiler">  <b class="spoiler_title">Full text of the program</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"opencv2/video/tracking.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"opencv2/highgui/highgui.hpp"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"opencv2/imgproc/imgproc_c.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;time.h&gt; #include &lt;stdio.h&gt; #include &lt;ctype.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;string.h&gt; #include &lt;errno.h&gt; int dig_key=0; int region_coordinates[10][4]; void myMouseCallback( int event, int x, int y, int flags, void* param) { IplImage* img = (IplImage*) param; switch( event ){ case CV_EVENT_MOUSEMOVE: //printf("%dx %d\n", x, y); break; case CV_EVENT_LBUTTONDOWN: //printf("%dx %d\n", region_coordinates[dig_key][0], region_coordinates[dig_key][1]); if (region_coordinates[dig_key][0] != 0 &amp;&amp; region_coordinates[dig_key][1] != 0 &amp;&amp; region_coordinates[dig_key][2] == 0 &amp;&amp; region_coordinates[dig_key][3] == 0) { region_coordinates[dig_key][2]=x; region_coordinates[dig_key][3]=y; } if (region_coordinates[dig_key][0] == 0 &amp;&amp; region_coordinates[dig_key][1] == 0) { region_coordinates[dig_key][0]=x; region_coordinates[dig_key][1]=y; } break; case CV_EVENT_RBUTTONDOWN: break; case CV_EVENT_LBUTTONUP: break; } } int main(int argc, char** argv) { IplImage* image = 0; CvCapture* capture = 0; struct timeval tv0; int fps=0; int fps_sec=0; int now_sec=0; char fps_text[2]; CvFont font; cvInitFont(&amp;font, CV_FONT_HERSHEY_COMPLEX_SMALL, 1.0, 1.0, 1,1,8); capture = cvCaptureFromCAM(0); cvNamedWindow( "Motion", 1 ); for(;;) { IplImage* image = cvQueryFrame( capture ); gettimeofday(&amp;tv0,0); now_sec=tv0.tv_sec; if (fps_sec == now_sec) { fps++; } else { fps_sec=now_sec; snprintf(fps_text,254,"%d",fps); fps=0; } cvSetMouseCallback( "Motion", myMouseCallback, (void*) image); if (region_coordinates[dig_key][0] != 0 &amp;&amp; region_coordinates[dig_key][1] != 0 &amp;&amp; region_coordinates[dig_key][2] == 0 &amp;&amp; region_coordinates[dig_key][3] == 0) cvRectangle(image, cvPoint(region_coordinates[dig_key][0],region_coordinates[dig_key][1]), cvPoint(region_coordinates[dig_key][0]+1,region_coordinates[dig_key][1]+1), CV_RGB(0,0,255), 2, CV_AA, 0 ); if (region_coordinates[dig_key][0] != 0 &amp;&amp; region_coordinates[dig_key][1] != 0 &amp;&amp; region_coordinates[dig_key][2] != 0 &amp;&amp; region_coordinates[dig_key][3] != 0) cvRectangle(image, cvPoint(region_coordinates[dig_key][0],region_coordinates[dig_key][1]), cvPoint(region_coordinates[dig_key][2],region_coordinates[dig_key][3]), CV_RGB(0,0,255), 2, CV_AA, 0 ); cvPutText(image, fps_text, cvPoint(5, 20), &amp;font, CV_RGB(255,255,255)); cvShowImage( "Motion", image ); char c = cvWaitKey(20); if (c &lt;=57 &amp;&amp; c&gt;= 48) { dig_key=c-48; //key "0123456789" } } cvReleaseCapture( &amp;capture ); cvReleaseImage(&amp;image); cvDestroyWindow( "Motion" ); return 0; }</span></span></span></span></code> </pre></div></div><br><br>  But we will not, every time we start the program, set monitoring regions manually?  Let's save to file. <br><br><pre> <code class="cpp hljs">FILE *settings_file; FILE* fd = fopen(<span class="hljs-string"><span class="hljs-string">"regions.bin"</span></span>, <span class="hljs-string"><span class="hljs-string">"rb"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// . "rb" -    if (fd == NULL) { printf("Error opening file for reading\n"); //    FILE* fd = fopen("regions.bin", "wb"); //  if (fd == NULL) { printf("Error opening file for writing\n"); } else { fwrite(region_coordinates, 1, sizeof(region_coordinates), fd); //  -     fclose(fd); //  printf("File created, please restart program\n"); } return 0; } size_t result = fread(region_coordinates, 1, sizeof(region_coordinates), fd); //  if (result != sizeof(region_coordinates)) //        printf("Error size file\n"); //  fclose(fd); //  FILE* fd = fopen("regions.bin", "wb"); // . "wb" -    if (fd == NULL) //    printf("Error opening file for writing\n"); // fwrite(region_coordinates, 1, sizeof(region_coordinates), fd); //    fclose(fd); // </span></span></code> </pre><br>  We bind these functions, for example, on the w and r buttons, and when pressed, we save and open the array. <br><br>  There is only a small amount left - actually, the definition in which region the movement occurred.  We transfer our achievements to the motempl.s source, and find where we can go. <br>  Here is the function that draws circles at the location of motion detection: <br><pre> <code class="cpp hljs">cvCircle( dst, center, cvRound(magnitude*<span class="hljs-number"><span class="hljs-number">1.2</span></span>), color, <span class="hljs-number"><span class="hljs-number">3</span></span>, CV_AA, <span class="hljs-number"><span class="hljs-number">0</span></span> );</code> </pre> <br><br>  And the coordinates of the center are determined like this: <br><pre> <code class="cpp hljs">center = cvPoint( (comp_rect.x + comp_rect.width/<span class="hljs-number"><span class="hljs-number">2</span></span>), (comp_rect.y + comp_rect.height/<span class="hljs-number"><span class="hljs-number">2</span></span>) );</code> </pre> <br><br>  We paste our code into this piece: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i_mass; <span class="hljs-comment"><span class="hljs-comment">//   for (i_mass = 0; i_mass &lt;= 9; i_mass++) //     ,       . { if( comp_rect.x + comp_rect.width/2 &lt;= region_coordinates[i_mass][2] &amp;&amp; comp_rect.x + comp_rect.width/2 &gt;= region_coordinates[i_mass][0] &amp;&amp; comp_rect.y + comp_rect.height/2 &lt;= region_coordinates[i_mass][3] &amp;&amp; comp_rect.y + comp_rect.height/2 &gt;= region_coordinates[i_mass][1] ) //,   ,      -. { cvRectangle(dst, cvPoint(region_coordinates[i_mass][0],region_coordinates[i_mass][1]), cvPoint(region_coordinates[i_mass][2],region_coordinates[i_mass][3]), CV_RGB(0,0,255), 2, CV_AA, 0 ); //    ,      , ,     . printf("Detect motion in region %d\n",i_mass); //       } }</span></span></code> </pre><br><br>  Works: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/WTfVk9aEdv8%3Ffeature%3Doembed&amp;xid=25657,15700022,15700186,15700191,15700253,15700256&amp;usg=ALkJrhjjTKTpJVnA5FBdRWFl48fLqpxKPw" frameborder="0" allowfullscreen=""></iframe><br><br>  It remains a little: send the output not to the console, but to the UART, connect to any MK relays that will control the light.  The program detects movement in the region, sends the region number to the controller, and the latter lights the lamp assigned to it.  But about this - in the next series. <br><br>  I put the project source on github, and I will not mind if someone finds time to correct errors and improve the program: <br>  <a href="https://github.com/vvzvlad/motion-sensor-opencv">github.com/vvzvlad/motion-sensor-opencv</a> <br><br>  I remind you, if you do not want to miss the epic with a kettle and want to see all the new posts of our company, you can subscribe to <img src="https://habrastorage.org/getpro/habr/post_images/ce4/0f1/d16/ce40f1d1668436a03738295da0147749.png" alt="image">  <a href="http://habrahabr.ru/company/avi/">on the company page</a> (button "subscribe") <br>  And yes, I again wrote a post at 5 am, so I will accept error messages.  But - in a personal. </div><p>Source: <a href="https://habr.com/ru/post/200804/">https://habr.com/ru/post/200804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../200788/index.html">The robot has always always won in the "stone-scissors-paper"</a></li>
<li><a href="../200790/index.html">Morphane: prefixes, roots, suffixes ...</a></li>
<li><a href="../200792/index.html">Derby.js templates for templates</a></li>
<li><a href="../200794/index.html">Crime and punishment - problems at the intersection of sciences</a></li>
<li><a href="../200798/index.html">Fighting abundance: usability filtering forms</a></li>
<li><a href="../200806/index.html">Gray codes and enumeration tasks</a></li>
<li><a href="../200808/index.html">Father made a prosthetic arm for his son on a 3D printer</a></li>
<li><a href="../200812/index.html">OAuth.io</a></li>
<li><a href="../200814/index.html">Beautiful cities - beautiful map</a></li>
<li><a href="../200816/index.html">WD has released a 6 TB hard drive with helium instead of air</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>