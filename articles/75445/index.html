<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP module is still simple. Part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While nerezus is writing an article about embedding PHP, I will try to continue his story about writing extensions. Far from everything will be told, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP module is still simple. Part two</h1><div class="post__text post__text-html js-mediator-article">  While <a href="https://habrahabr.ru/users/nerezus/" class="user_link">nerezus is</a> writing an article about embedding PHP, I will try to continue his story about writing extensions.  Far from everything will be told, since I believe that the complexity should be gradually increased, otherwise the material will be difficult to understand and not at all nutritious.  In this regard, I still will not tell this time how to replace the operators in the class, who wants, can read the source code of <a href="http://cvs.php.net/viewvc.cgi/pecl/operator/">the Operator module</a> from Sarah Golemon - the main author of any information on the development of PHP extensions. <br>  Since I am developing exclusively in Linux, we will write without any tricky addons to Visual Studio, with pens, from scratch :) And what, it is better to understand right away, and then simplify your work. <br><a name="habracut"></a><br>  First we need to write two files: <b>config.m4</b> and <b>Makefile</b> .  The first is needed to build our extension, and the second ... so that this very assembly does not spoil our source directory :) <br><br><h4>  1. config.m4 </h4><br>  So let's get started.  The files for the assembly are not very interesting to write, so I‚Äôll just give them and tell you what's what.  <a href="http://paste.ubuntu.com/320348/">Here is a general view of</a> our config. <br>  Lines beginning with ‚Äúdnl‚Äù are comments. <br>  The first two lines add the --enable-mystring option for the build.  So we can put our module in the folder / ext / source of pkhp and choose to build pkhp with it or without it. <br>  If you comment out lines 1-2 and uncomment 3-4, then we get the option --with-mystring, which you can optionally specify the path.  What for?  For all the strings remaining in the file :) If we go to use some specific library (I indicated the libraries mylib1 and mylib2 in the example), then we will be able to pass the path to it during the configuration.  Actually, in lines 12-29, we are trying to find and connect these libraries. <br>  Further pay attention to line 9. It adds in our config the variable &lt;MODULE_NAME&gt; _SHARED_LIBADD, where the libraries are added for linking.  Generally get used to the fact that m4 requires strict, not arbitrary variable names.  This is Sparta. <br>  In lines 33-35, we add the most common libraries to the link - no need to search for them. <br>  Well, in line 36 - we indicate from which files our extension should be collected. <br>  Line 32 additionally indicates that we are writing our module not in C, but in C ++ (in writing the module, the difference is small, but if you connect plus libraries or plus code, you will need it). <br>  Since this time we do not connect anything, we will <a href="http://paste.ubuntu.com/320359/">shorten</a> our config considerably.  Only 10 lines - nothing superfluous. <br><br><h4>  2. Makefile </h4><br>  Makefiles, I think, every self-respecting programmer at least once in his life wrote yes, so no explanation should be required.  So <a href="http://paste.ubuntu.com/320362/">take and use</a> .  I note that the `php-config --extension-dir` command gives us the directory where the PHP extensions are stored, and the <b>__build</b> directory is the one in which we will collect everything. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  3. Create a mystring.h file </h4><br>  What do we need now?  As with any decent C / C ++ program, the header file and the code file.  Let's start with the headline.  Again, we will have a <a href="http://paste.ubuntu.com/320825/">simple</a> file, less than 40 lines.  Let's go over it. <br>  With lines 4-5 we will declare the name and version of our extension.  It is necessary for the sole purpose - to bring this valuable information later in the info about the module. <br>  Line 7 gives us the class name.  Of course, writing ‚Äúmystring‚Äù is shorter than PHP_MYSTRING_CLASS_NAME, but at any moment you can change the name of the class in one single place.  For example, rename a class to ‚ÄúMystring‚Äù - with a capital letter, as befits decent people. <br>  Lines 9-11 include the config.h file that is generated during the build process - we will not write it ourselves. <br>  Next we include standard headers and declare functions.  Let's stop here in more detail.  The <b>PHP_MINIT_FUNCTION</b> and <b>PHP_MSHUTDOWN_FUNCTION</b> functions are functions that are executed during the loading and unloading of a module.  In addition to them, there are <b>* _GINIT_ *</b> and <b>* _GSHUTDOWN_ *</b> - functions for global start / unload of PHP, and <b>* _RINIT_ *</b> and <b>* _RSHUTDOWN_ *</b> - when the module is activated / deactivated.  The <b>PHP_MINFO_FUNCTION</b> function is a function that is executed when <b>phpinfo () is</b> called; it will generate us information about the module. <br>  Next, we will declare several methods - remember, in the first part you declared them using the <b>PHP_FUNCTION</b> macro and were they global?  Here we do essentially the same thing, only the macro takes two parameters ‚Äî the class and the name of its method. <br>  Well, at the end of the 35th line we will declare our module. <br>  We don‚Äôt need anything else in the header file - go to the code. <br><br><h4>  4. Write the module code - mystring.cc </h4><br>  Here, the code is more complicated.  Unfortunately, it was not possible to place it directly in the article - Habr protested - so I put all the code <a href="http://paste.ubuntu.com/321607/">here</a> right away, here we will only look at its contents. <br><br><h5>  Lines 1-27 </h5><br>  So far everything is simple - we declare our future class, and we declare our module.  Please note - we have specified its name, version, and <b>MINIT</b> , <b>MSHUTDOWN,</b> and <b>MINFO functions</b> .  We do not declare global functions this time, we do not need <b>RINIT</b> or <b>RSHUTDOWN</b> either, everything else can be considered default. <br><br><h5>  Lines 29-49 </h5><br>  Now we have substituted a macro saying PHP that our module can be compiled as an extension, and not just as part of PHP.  Then they declared a set of class functions.  For each function, 4 parameters are specified: class name, function name, pointer to <b>arg_info</b> structure <b>,</b> and access parameters.  I have never seen a <b>clear</b> description of the <b>arg_info</b> structure, so we will pass <b>NULL</b> in the old manner, and check the parameters already in the function itself. <br>  The basic access parameters are, of course, <b>ZEND_ACC_PUBLIC</b> , <b>ZEND_ACC_PROTECTED</b> and <b>ZEND_ACC_PRIVATE</b> .  In addition, you can specify <b>ZEND_ACC_STATIC</b> or <b>ZEND_ACC_ALLOW_STATIC</b> (this method can be used both as static and as usual).  For constructors, destructors, and the <b>clone</b> operator (declared in PHP as a function of <b>__clone</b> ), you must specify the flags <b>ZEND_ACC_CTOR</b> , <b>ZEND_ACC_DTOR</b> and <b>ZEND_ACC_CLONE, respectively</b> . <br>  However, you can see the full list in the header files, on my machine it is the file <i>/usr/include/php5/Zend/zend_compile.h</i> <br>  Please note that after each method described using <b>PHP_ME ()</b> <u>you do not need</u> to put a comma.  And at the end there should always be an array of three <b>NULLs</b> . <br>  In the meantime, we are going on. <br><br><h5>  Lines 51-76 </h5><br>  Identified three previously announced methods - loading, unloading and information about the module.  Of all three, only one is of interest to us: loading the module.  First we need to register our declared class. <br>  Then we create a property in the registered class, for which we pass a pointer to the registered class, the name of the property, the length of this name (more on this line later), the default value and, again, access parameters.  In the end, we must write the magic word <b>TSRMLS_CC</b> .  This word must be mentioned specifically.  To work inside the function with the current state of PHP - to know where we are now, to have information about classes, etc.  etc., it is necessary to transmit this information.  To do this, when you declare a function, you must write the macro <b>TSRMLS_DC</b> at the end, and when you call it, <b>TSRMLS_CC</b> .  A comma before a macro in both cases is <u>not necessary</u> . <br>  Now back to the length of the property name.  Information about the declaration of properties in different sources is very scarce and contradictory.  Thus, in the manual of the same Sarah Golemon it is mentioned that if a property is declared as private, it should have a name like <b>\ 0</b> class_name <b>\ 0</b> property_name, for which PHP has <b>zend_mangle_property_name ()</b> method that constructs such a name for the protected and private properties.  In practice, it turned out that if you use <b>zend_mangle_property_name</b> , PHP swears dirty when accessing a property, while in the aforementioned call everything is fine.  Keep in mind if you read the literature on the topic. <br><br><h5>  Lines 78-106 </h5><br>  Let's now define the standard class methods.  Let's go point by point. <br>  The <b>getThis ()</b> function returns a pointer to an object of the class from which we called the method.  For the constructor and destructor, we check this pointer - we don‚Äôt want someone to call these methods statically.  Then in the constructor, we simply change the already declared ‚Äústr‚Äù property to show you this function.  To do this, we pass the type of the object (class), a pointer to the object itself, the name and length of the property name, as well as a new value.  Please note that we use <b>* _stringl ()</b> , and not <b>* _string ()</b> function - it also requires you to pass the length of the new value.  In principle, it is used in cases where the character <b>'\ 0'</b> can be present in a string, or when we want to write only the first N characters from a string, but because it works a little faster than the <b>* _string ()</b> option, we We use it and in such a trivial situation, we do not mind the extra parameter to specify. <br>  Similarly, we use the macro <b>RETURN_STRINGL</b> in the function of casting a class to a string.  Pay attention to the last parameter "1" - it means that we want to transfer not the object itself, but its copy.  Who knows what, then they will want to do with our line. <br><br><h5>  Lines 108-133 </h5><br>  Let's describe the method of adding a string. <br>  First of all, we check whether the string was passed to us as a parameter ‚Äî this has already been considered in the first part. <br>  Then we read the string already stored there from our object.  Note that although we created the property as a <b>string</b> , the pointer returned to us on <b>zval</b> .  The thing is that absolutely all data types in php are represented by the <b>zval</b> type.  If you are interested in how it works, see the file <i>/usr/include/php5/Zend/zend.h</i> for a definition of <b>struct _zval_struct</b> and <b>union _zvalue_value</b> . <br>  Finally, we allocate memory for the new line and copy the source line and the ‚Äúadditive‚Äù there.  Then we use the familiar method <b>zend_update_property_stringl ()</b> and write the new value.  Instead of <b>malloc</b> , <b>calloc</b> and <b>free</b> in PHP, it is common to use Zend's analogs <b>emalloc</b> , <b>ecalloc</b> and <b>efree</b> . <br>  Done, the new value is where it should be, you can return <b>NULL</b> .  Homework: guess how to return the object itself, so that you can make chains of the form <b>$ a-&gt; append ("a") -&gt; append ("b")</b> ... <br><br><h5>  Lines 135-148 </h5><br>  Well, finally, we implement the compare method.  In it, we will not implement the present comparison (the devil knows why I decided to call the method this way), but we will output our string ‚Äî it should at least appear somewhere ‚Äî and show a little bit of magic. <br>  To begin with, we read and output our string str.  The syntax of the <b>zend_printf ()</b> function, as you can see, is absolutely identical to the standard <b>printf ()</b> .  But then ... what is it?  Yes, we easily and naturally took and executed a piece of PHP-code.  As parameters, we pass a line of code, a pointer to a variable, where to put the result of the execution, as well as the name of our script.  In order not to invent anything, I simply wrote myvardump. <br><br><h4>  Results </h4><br>  Type ` <b>make all install`</b> .  Now enter: <b>php -r '$ s = new mystring ();</b>  <b>echo $ s. "\ n";</b>  <b>$ s-&gt; append ("Thank you!");</b>  <b>$ s-&gt; compare (); '</b>  looking at the output: <br><blockquote><code>mystring <br> upchk ! <br> object(mystring)#1 (1) { <br> ["str:private"]=&gt; <br> string(21) "upchk !" <br> }</code> </blockquote> <br>  The first line is what we derived our class, converted to a string (see <b>__toString ()</b> ).  The second - output the already modified string str.  And the remaining three lines are the result of our <b>zend_eval_string</b> - class dump.  We observe our created private property - everything is fair. <br><br><h4>  What's next? </h4><br>  Firstly, in the framework of self-promotion I recommend to check out only the extension I recently wrote: <br>  <b>svn checkout <a href="http://dingo-php.googlecode.com/svn/trunk/">http://dingo-php.googlecode.com/svn/trunk/</a> dingo-php</b> <br>  For most users, the extension itself will be completely uninteresting from the point of view of practical application, but in it you can see: <br>  - How to make several classes in one extension that can be turned on and off when compiling <br>  - how to wrap and use third-party libraries <br>  - well, a little bit of real code <br>  In addition, I recommend the book by Sarah Golemon: <br>  &gt;&gt; <i>Sara Golemon "Extending and Embedding PHP"</i> <br>  In Russia, it costs some mad amount of tenge, but with a certain effort on the Internet you can find an electronic version. <br>  The book is a bit outdated, but it is there that you can find out why you need RINIT / RSHUTDOWN, how to hang your handlers on events happening with classes, how to create streams, work with ini-config, and create with objects much more. <br><br>  Ps For those who are too lazy to copy-paste for experimentation, I posted an archive with a module ready for compilation: <a href="http://narod.ru/disk/15177450000/mystring.tar.gz.html">narod.ru/disk/15177450000/mystring.tar.gz.html</a> </div><p>Source: <a href="https://habr.com/ru/post/75445/">https://habr.com/ru/post/75445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../75434/index.html">Clash of the Titans</a></li>
<li><a href="../75438/index.html">Systematization of the process of graphic design</a></li>
<li><a href="../75439/index.html">Too Late, Windows 7 - Parody OneRepublic - Apologize</a></li>
<li><a href="../75442/index.html">Thirst for profit. Part 2. Boxing by correspondence</a></li>
<li><a href="../75443/index.html">Thirst for profit. Part 1. Attack of the Clones</a></li>
<li><a href="../75446/index.html">Why not contact the public, or Oda to Alexei Rogachkov</a></li>
<li><a href="../75448/index.html">Google Translate Changes</a></li>
<li><a href="../75449/index.html">Google Translate Changes</a></li>
<li><a href="../75450/index.html">Open seminars - New technologies for education</a></li>
<li><a href="../75451/index.html">Place for D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>