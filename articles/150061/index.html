<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Printing Yandex.Maps under API 2.x with labels and clusters</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone knows that typing API 2.x kernel-card with labels and clusters just won't work. Until now, the map is not built on the canvas, but on the div...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Printing Yandex.Maps under API 2.x with labels and clusters</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/1a7/295/ab7/1a7295ab7692245fb755c99c774a5577.jpg" align="right">  Everyone knows that typing API 2.x kernel-card with labels and clusters just won't work.  Until now, the map is not built on the canvas, but on the divas with the substrate (background-image).  And kanvas favorite browser does not help. <br>  The task was to quickly make a printable version of the map.  The number of tags - more than 600 + clusters "out of the box." <br>  Working option under the cut <br><a name="habracut"></a><br>  we initialize the map as usual - we take the zoom and the center from the link <br><pre><code class="javascript hljs">ymaps.ready(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mapTypes = [<span class="hljs-string"><span class="hljs-string">'yandex#map'</span></span>, <span class="hljs-string"><span class="hljs-string">'yandex#satellite'</span></span>, <span class="hljs-string"><span class="hljs-string">'yandex#hybrid'</span></span>, <span class="hljs-string"><span class="hljs-string">'yandex#publicMap'</span></span>, <span class="hljs-string"><span class="hljs-string">'yandex#publicMapHybrid'</span></span>], map = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ymaps.Map($(<span class="hljs-string"><span class="hljs-string">'#map'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], { <span class="hljs-attr"><span class="hljs-attr">center</span></span>:[ <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(<span class="xml"><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span><span class="xml"><span class="php">= $request_lat</span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">), parseFloat(</span><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span><span class="xml"><span class="php">= $request_lng</span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">)], zoom:parseInt(</span><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span><span class="xml"><span class="php">= $request_zoom</span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">), type: mapTypes[</span><span class="php"><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">&lt;?</span></span></span></span><span class="xml"><span class="php">= $request_mtype ? $request_mtype : </span></span><span class="hljs-number"><span class="xml"><span class="php"><span class="hljs-number">0</span></span></span></span><span class="hljs-meta"><span class="xml"><span class="php"><span class="hljs-meta">?&gt;</span></span></span></span></span><span class="xml">] });</span></span></code> </pre> <br>  do printer-friendly layout for the label <br>  here I must say that the printer-friendly - this means that we do not use the background-image, but do a bunch of divs with images. <br>  My tag icon consists of 2 parts - pictures and the background.  both in sprite.  therefore such a frantic style.  I bring it inline for clarity <br><pre> <code class="javascript hljs"> ymaps.layout.storage.add(<span class="hljs-string"><span class="hljs-string">'voina#icon'</span></span>, ymaps.templateLayoutFactory.createClass( <span class="hljs-string"><span class="hljs-string">'&lt;div style="position: absolute; width: 28px; height: 36px; overflow: hidden;z-index: 0; "&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;div style="position:absolute;width:20px;height:20px;overflow:hidden;top:4px;left:4px"&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;img src="/img/new_buttons_21.png" style="position:absolute;left:$[properties.iconOffset]px;"&gt;&lt;/div&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;img src="/img/buttons7.gif" style="position: absolute; left: -264px; top: -70px; "&gt;&lt;/div&gt;'</span></span> ));</code> </pre><br>  the same with the cluster icon.  I did not bother with different sizes of cluster icons for a different number of points inside - it was quickly necessary) <br><pre> <code class="javascript hljs"> ymaps.layout.storage.add(<span class="hljs-string"><span class="hljs-string">'voina#cluster'</span></span>, ymaps.templateLayoutFactory.createClass( <span class="hljs-string"><span class="hljs-string">'&lt;div style="position: absolute; margin: -26px 0 0 -26px; width: 58px; height: 58px; overflow: hidden;z-index: 0; "&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;div style="z-index:800;position: absolute; width: 58px; height: 58px; text-align: center; font-size: 13px; line-height: 58px;"&gt;$[properties.geoObjects.length]&lt;/div&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;img src="/img/cluster_big.png" style="position: absolute;"&gt;&lt;/div&gt;'</span></span>));</code> </pre><br>  here we get the container of the leyer card substrate itself <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $container = map.panes.get(<span class="hljs-string"><span class="hljs-string">'layers'</span></span>).getElement(),</code> </pre><br>  since the card types are different for statics, we make matches and we get the center of the card <br><pre> <code class="javascript hljs"> stMapTypes = {<span class="hljs-string"><span class="hljs-string">'yandex#map'</span></span> : <span class="hljs-string"><span class="hljs-string">'map'</span></span>, <span class="hljs-string"><span class="hljs-string">'yandex#satellite'</span></span> : <span class="hljs-string"><span class="hljs-string">'sat'</span></span>, <span class="hljs-string"><span class="hljs-string">'yandex#hybrid'</span></span> : <span class="hljs-string"><span class="hljs-string">'sat,ski'</span></span>, <span class="hljs-string"><span class="hljs-string">'yandex#publicMap'</span></span> : <span class="hljs-string"><span class="hljs-string">'pmap'</span></span>}, center = map.getCenter(),</code> </pre><br>  size is an ambush.  static gives a maximum of 650 to 450. also did not bother - let it be the maximum <br>  A div with a map also needs to be done no more than these sizes. <br>  in a good way, if you make a div with a map of a large size, you need another approach - through the layer. <br><pre> <code class="javascript hljs"> size = [<span class="hljs-number"><span class="hljs-number">650</span></span>, <span class="hljs-number"><span class="hljs-number">450</span></span>],</code> </pre><br>  we form a link for statics <br><pre> <code class="javascript hljs"> mapUrl = <span class="hljs-string"><span class="hljs-string">'http://static-maps.yandex.ru/1.x/?ll='</span></span>+center[<span class="hljs-number"><span class="hljs-number">1</span></span>]+<span class="hljs-string"><span class="hljs-string">','</span></span>+center[<span class="hljs-number"><span class="hljs-number">0</span></span>]+ <span class="hljs-string"><span class="hljs-string">'&amp;z='</span></span>+map.getZoom()+<span class="hljs-string"><span class="hljs-string">'&amp;l='</span></span>+stMapTypes[map.getType()]+ <span class="hljs-string"><span class="hljs-string">'&amp;size='</span></span>+size[<span class="hljs-number"><span class="hljs-number">0</span></span>]+<span class="hljs-string"><span class="hljs-string">','</span></span>+size[<span class="hljs-number"><span class="hljs-number">1</span></span>];</code> </pre><br>  here the magic begins <br>  do a div with absolute positioning and place it in the middle, since the pane binding will be to the center of the viewport.  in fact, you had to call map.panes.get ('layers'). getViewport () and read the center.  but when loading the pane lies in the middle, and we will not let the map move <br><pre> <code class="javascript hljs"> $(<span class="hljs-string"><span class="hljs-string">'&lt;div&gt;&lt;/div&gt;'</span></span>).css({ <span class="hljs-attr"><span class="hljs-attr">position</span></span>: <span class="hljs-string"><span class="hljs-string">'absolute'</span></span>, <span class="hljs-attr"><span class="hljs-attr">left</span></span>: -<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(size[<span class="hljs-number"><span class="hljs-number">0</span></span>] / <span class="hljs-number"><span class="hljs-number">2</span></span>)+<span class="hljs-string"><span class="hljs-string">'px'</span></span>, <span class="hljs-attr"><span class="hljs-attr">top</span></span>: -<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(size[<span class="hljs-number"><span class="hljs-number">1</span></span>] / <span class="hljs-number"><span class="hljs-number">2</span></span>)+<span class="hljs-string"><span class="hljs-string">'px'</span></span>, <span class="hljs-attr"><span class="hljs-attr">zIndex</span></span>: <span class="hljs-number"><span class="hljs-number">800</span></span>}).</code> </pre><br>  we insert inside img with a statics <br><pre> <code class="javascript hljs"> wrapInner($(<span class="hljs-string"><span class="hljs-string">'&lt;img&gt;'</span></span>).attr({<span class="hljs-string"><span class="hljs-string">'src'</span></span>:mapUrl, <span class="hljs-attr"><span class="hljs-attr">width</span></span>: size[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-attr"><span class="hljs-attr">height</span></span>: size[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-attr"><span class="hljs-attr">border</span></span>: <span class="hljs-string"><span class="hljs-string">'0'</span></span>})).</code> </pre><br>  and paste into the leier container over the other elements <br><pre> <code class="javascript hljs"> prependTo($container);</code> </pre><br>  good feature - disables all card events.  now neither move nor wonder <br><pre> <code class="javascript hljs"> map.events.removeAll();</code> </pre><br>  here I add my markers to the map.  they are in the variable window.data <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> len = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.data.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (len) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, markers = [ ], properties, latLng; i &lt; len; i++) { latLng = [<span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.data[i][<span class="hljs-number"><span class="hljs-number">1</span></span>]), <span class="hljs-built_in"><span class="hljs-built_in">parseFloat</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.data[i][<span class="hljs-number"><span class="hljs-number">2</span></span>])]; markers.push( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ymaps.Placemark(latLng, { <span class="hljs-attr"><span class="hljs-attr">iconOffset</span></span>: -<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.data[i][<span class="hljs-number"><span class="hljs-number">5</span></span>] * <span class="hljs-number"><span class="hljs-number">20</span></span> - <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">iconLayout</span></span>:<span class="hljs-string"><span class="hljs-string">'voina#icon'</span></span>, <span class="hljs-attr"><span class="hljs-attr">iconOffset</span></span>: [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-attr"><span class="hljs-attr">openBalloonOnClick</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> })); }</code> </pre><br>  now clusterer  What is a margin - I do not remember, but it was on a normal map <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clusterer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ymaps.Clusterer({<span class="hljs-attr"><span class="hljs-attr">margin</span></span>: [<span class="hljs-number"><span class="hljs-number">20</span></span>]});</code> </pre><br>  for icons of clusters we set the layout <br><pre> <code class="javascript hljs"> clusterer.options.set(<span class="hljs-string"><span class="hljs-string">'clusterIconLayout'</span></span>, <span class="hljs-string"><span class="hljs-string">'voina#cluster'</span></span>);</code> </pre><br>  I didn‚Äôt want to write this function, but I couldn‚Äôt open the clusters in another way <br><pre> <code class="javascript hljs"> clusterer.createCluster = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">center, geoObjects</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cluster = ymaps.Clusterer.prototype.createCluster.call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, center, geoObjects); <span class="hljs-comment"><span class="hljs-comment">//          cluster.events.add('click', function(e) { e.stopImmediatePropagation(); e.preventDefault(); return false; }); return cluster; };</span></span></code> </pre><br>  add markers to the clusterer <br><pre> <code class="javascript hljs"> clusterer.add(markers);</code> </pre><br>  just in case the clusterer is also muffled <br><pre> <code class="javascript hljs"> clusterer.events.removeAll();</code> </pre><br>  we add clusterer on the card <br><pre> <code class="javascript hljs"> map.geoObjects.add(clusterer); } });</code> </pre><br><br>  TA-dah!!!  everything works and prints (if the browser sustains that number of dom objects) <br>  only one bug - two copyrights.  when deleting from the map or even hiding mistakes.  for uh okay <br><br><img src="http://habrastorage.org/storage2/ea7/df9/046/ea7df9046692edbe99424c925b133c39.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      you can see <a href="http://www.pomnivoinu.ru/printmap1.php%3Flong%3D37.557621002197266%26lat%3D55.82977259963096%26zoom%3D3%26mtype%3D0">here</a> </div><p>Source: <a href="https://habr.com/ru/post/150061/">https://habr.com/ru/post/150061/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150054/index.html">jQuery UI Datepicker: add custom navigation elements by year</a></li>
<li><a href="../150055/index.html">Nikon released the camera running Android</a></li>
<li><a href="../150056/index.html">"Unbiased" universal algorithmic intelligence</a></li>
<li><a href="../150059/index.html">PDFsharp and MigraDoc Foundation (Basics)</a></li>
<li><a href="../150060/index.html">Sell ‚Äã‚Äãyourself</a></li>
<li><a href="../150062/index.html">War and peace with the Office of "K"</a></li>
<li><a href="../150063/index.html">Grouping serial posts close in time</a></li>
<li><a href="../150064/index.html">The insides of the QML engine. Part 1: Downloading Files</a></li>
<li><a href="../150065/index.html">23 reasons not to believe in bullshit about working in large companies</a></li>
<li><a href="../150066/index.html">Major Steam Community Update</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>