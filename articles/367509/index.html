<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How are Z-Wave devices made?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will explain how Z-Wave devices are created. From the point of view of circuit engineering and programming, the development of a Z-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How are Z-Wave devices made?</h1><div class="post__text post__text-html js-mediator-article">  In this article we will explain how Z-Wave devices are created.  From the point of view of circuit engineering and programming, the development of a Z-Wave device is not much different from the development of a device based on an Arduino, AVR or PIC.  However, there are some nuances in Z-Wave.  About them something will be discussed under the cut. <br><img src="https://habrastorage.org/files/1ab/caf/8ff/1abcaf8ff36e4d41bb14198f17b95582.png" width="500"><br><a name="habracut"></a><br>  I <a href="http://geektimes.ru/post/257684/">already wrote</a> about the Z-Wave protocol.  Therefore, I will not describe in detail the details of the protocol, but walk along the hardware platform.  We will only talk about the last 5th generation of chips and modules that were introduced more than two years ago. <br><br><h4>  Iron </h4><br>  So, from an iron point of view, the chips and Z-Wave modules are the upgraded 8051 core. The chip is made in SoC format, with the following peripherals: <br><ul><li>  128 KB of flash memory for your code </li><li>  16 KB of RAM (XRAM) and 256 bytes (IRAM), where SFR registers are mapped, </li><li>  256 bytes of NVR (crystal calibration data and lock bit are also stored there), </li><li>  30 GPIO, </li><li>  2 UART, </li><li>  2 SPI (Master and Master / Slave), </li><li>  1 USB (Serial only), </li><li>  4 ADC 12/8 bits, </li><li>  1 scanner with 88 keys (with the ability to scan in deep sleep mode), </li><li>  1 <abbr title="Semistor Controller (TRIode for Alternating Current)">TRIAC controller</abbr> oscillator with <abbr title="Zero Cross Detector">ZEROX detector</abbr> , </li><li>  5 PWM with 16 bit resolution </li><li>  4 IR controllers and 1 IR decoder for training, </li><li>  bootloader (enabled by pin RESET or from code by writing to the corresponding SFR register) for flashing by SPI or UART, as well as the ability to reprogram yourself (rewriting flash memory is used for <abbr title="Over-the-air / by air">OTA</abbr> flashing), </li><li>  Built-in crypto accelerator for 128-bit AES encryption, </li><li>  power monitor (to assess battery charge). </li></ul><br>  The power of the chip is 2.3‚Äì3.6 V. The consumption is about 15 mA in operation mode, 35 mA in receive mode and up to 45 mA in transmit mode.  There is also a deep sleep mode with a consumption of 1 ŒºA (awakening from INT1) and <abbr title="Wake up timer">WUT</abbr> (+0.7 ŒºA). <br><br>  Obviously, many functions and legs intersect and are not available at the same time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Such an abundance of functions in a single chip can significantly reduce the cost of the device being created, since  does not require the use of additional microcontrollers.  For example, a dimmer, door lock, keychain on batteries, a composite sensor (temperature / humidity / alarm / ...) can be made directly on a Z-Wave microcontroller with a corresponding trim. <br><br>  But most importantly, a radio transceiver is built into the chip.  However, access to it is carried out only through the library Sigma Designs (about this below).  Because a lot about him is unknown.  We just say that <br><ul><li>  sensitivity at the operating frequency of Z-Wave is -104dBm, </li><li>  5dBm output power </li><li>  working range is 850‚Äì940 MHz.  (We are sure that it is more, but the description of the RF part is completely absent, therefore there is no available information about other uses of the radio transceiver. Obviously, this is a typical <abbr title="Software defined radio">SDR</abbr> chip, and Sigma Designs did not invent the bicycle here). </li></ul><br>  The minimum ‚Äúbinding‚Äù for Z-Wave requires only quartz (included in the modules), antenna matching, several capacitors to stabilize the power supply, and a RESET leg lift.  Most Z-Wave devices still require a minimum of 16K of EEPROM (128KB is required for an OTA firmware upgrade). <br><br><h5>  Suppliers </h5><br>  The chips are manufactured only by Sigma Designs and are licensed by the Japanese Mitsumi.  At the moment, the 5th generation of chips is already being produced.  A very important aspect in the development of Z-Wave is backward compatibility.  And not only at the software level, but also in terms of the form factor and characteristics of the chips.  In the line of new modules have pin-to-pin compatible with all previous generations.  This allows you to quickly upgrade the devices that are already being manufactured without changing the diagrams and re-routing the boards. <br><br><h5>  Available chip options </h5><br>  Z-Wave chips are available in two versions: <br><table><tbody><tr><td width="192"><div style="text-align:center;"><img src="https://habrastorage.org/files/241/bb3/17a/241bb317a2a9445a8a2a37ee260af91b.png" width="50"></div></td><td>  <a href="http://z-wave.sigmadesigns.com/docs/brochures/SD3502_br.pdf">SD3502</a> , 48-QFN 7x7 mm, </td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/42b/bd4/52b/42bbd452bddb4bbb93690c156a62be9c.png" width="36"></div></td><td>  <a href="http://z-wave.sigmadesigns.com/docs/brochures/SD3503_br.pdf">SD3503</a> , 32-QFN 5x5 mm (trimmed version compared to SD3502). </td></tr></tbody></table><br>  The following SiP modules are also available, including quartz and minimum strapping for chip operation: <br><table><tbody><tr><td width="192"><div style="text-align:center;"><img src="https://habrastorage.org/files/8ad/4e7/f28/8ad4e7f280c442ee93ae437b86a9f328.png" width="57"></div></td><td>  <a href="http://z-wave.sigmadesigns.com/docs/brochures/ZM5101_br.pdf">ZM5101</a> , 56-QFN 8x8 mm, compatible with ZM4101 ( <sup>4th</sup> generation), </td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/9cc/f17/81b/9ccf1781b53842adaa1bde51684fa5db.png" width="97"></div></td><td>  <a href="http://z-wave.sigmadesigns.com/docs/brochures/ZM5202_br.pdf">ZM5202</a> , PCB 12.5x13.6 mm, based on SD3502, compatible with ZM3102 (3 of <sup>its</sup> generation), </td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/c3b/4d7/f7d/c3b4d7f7dbc94618b3e1aa6a5b9a11f3.png" width="192"></div></td><td>  <a href="http://z-wave.sigmadesigns.com/docs/brochures/ZM5304_br.pdf">ZM5304</a> , PCB 27x15.2 mm, based on SD3503, includes EEPROM memory, SAW filter, spiral antenna and protective screen (designed for ‚Äúmodems‚Äù, i.e. for Z-Wave controllers), </td></tr></tbody></table><br><br>  And a series from Mitsumi: <br><table><tbody><tr><td width="192"><div style="text-align:center;"><img src="https://habrastorage.org/files/0cb/f63/76c/0cbf6376ce96417db7e50acccbc29d93.png" width="100"></div></td><td>  <a href="http://www.mitsumi.co.jp/latest/Catalog/pdf/commun_wml_c84_e.pdf">WML-C84</a> , 56-QFN 8x8 mm, full analog ZM5101, </td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/305/773/8ad/3057738ad87f48a9b7d90641178257c1.png" width="100"></div></td><td>  WML-C85, 56-QFN 8x8 mm, compared to C84, has an integrated SAW filter, </td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/8e2/6d1/03c/8e26d103c73040da934a377b7a4fbab3.png" width="85"></div></td><td>  WML-C86, 56-QFN 15x15 mm, integrated SAW filter and EEPROM, increased TX power and RX sensitivity, protective screen, </td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/files/8e2/6d1/03c/8e26d103c73040da934a377b7a4fbab3.png" width="85"></div></td><td>  WML-C87, 56-QFN 15x15 mm, built-in SAW filter and EEPROM, increased sensitivity RX, protective screen. </td></tr></tbody></table><br><br>  Different module variations have different legs and functions ‚Äúcut off‚Äù.  Above, the available functions of the "full" version were indicated, i.e.  SD3502 as well as ZM5101 and WML-C84 / C85. <br><br>  Modules with an integrated SAW filter come in three versions depending on the region (ie, the frequency range): <abbr title="Europe">EU</abbr> / <abbr title="Russia">RU</abbr> / <abbr title="China">CN</abbr> / <abbr title="Malaysia">MY</abbr> / <abbr title="UAE">UAE</abbr> / <abbr title="India">IN</abbr> , <abbr title="USA">US</abbr> / <abbr title="Israel">IL</abbr> and <abbr title="Australia and New Zealand">ANZ</abbr> / <abbr title="Brazil">BR</abbr> / <abbr title="Japan">JP</abbr> / <abbr title="Taiwan">TW</abbr> / <abbr title="Hong Kong">HK</abbr> / <abbr title="Korea">KR</abbr> . <br><br>  Many of these modules can be purchased even on DigiKey.  However, Sigma Designs sells chips <a href="http://z-wave.sigmadesigns.com/volume">only on a large volume</a> by special arrangement. <br><br>  By the way, some manufacturers make their own modules.  For example, <a href="http://philio-tech.com/products/MD003%26006%26008.pdf">Philio Tech makes</a> MD003 (similar to ZM5304 based on SD3503, but without an antenna), MD006 (based on SD3503) and MD008 (something between the ZM5101 and ZM5202 based on SD3502).  On <abbr title="picture to attract attention">KDPV</abbr> device Philio PST-02 based on MD008. <br><br><h5>  Devkit </h5><br>  Sigma Designs also offers a developer kit.  This includes: <br><ul><li>  a set of chips of different form factors, including on developer boards, which are installed directly on the programmer (very convenient for prototyping), </li><li>  programmer (Z-Wave chips are programmed by a special programmer - there is a choice on the market: this one from Sigma Designs, more suitable for production <a href="http://z-wave.me/index.php%3Fid%3D42">from us, Z-Wave.Me</a> and completely <a href="http://www.equinox-tech.com/products/details.asp%3FID%3D1733">industrial from Equinox</a> ), </li><li>  sniffer (for wiretapping the ether - just a necessary thing when debugging devices), </li><li>  USB stick for central controller, </li><li>  several sensors and performers </li><li>  Windows software for the programmer, sniffer, controller, as well as all sorts of auxiliary utilities, </li><li>  Z-Wave SDK to create firmware for Z-Wave chips (see below), </li><li>  all sorts of wires and power supplies. </li></ul><br>  The whale comes in two parts: common to all and regional (depending on the frequency adopted in your region). <br><img src="https://habrastorage.org/files/ba5/c94/d74/ba5c94d74c11483ab0abef425fb25389.jpg" width="400"><img src="https://habrastorage.org/files/550/d1e/889/550d1e889e2d48649bcc40f99c48afc9.jpg" width="400"><br><br>  The cost of a whale is from $ 1,500 to $ 3,500, depending on the number of developer boards and programmers and the presence or absence of sensors / performers. <br><br><h5>  Legal side </h5><br>  Patents, licenses and <abbr title="Non Disclosure Agreement / Non-Disclosure Agreement">NDA</abbr> do not allow the use of chips and Z-Wave modules for purposes other than Z-Wave.  Also, Z-Wave devices cannot be made on a Z-Wave chip (remember, two OSI levels have a patented functionality, which makes it impossible to create a full-fledged Z-Wave stack without the permission of Sigma Designs).  This allows Sigma Designs to include the cost of a license (that is, a fee for the development of the protocol, software, utilities, marketing) immediately into the cost of chips and modules. <br><br>  In order to name your Z-Wave device compatible, you need to get certified (see below). <br><br>  By the way, according to the license agreement, on each Z-Wave device (usually on the back side; the exception is too compact devices) and the packaging should have the Z-Wave logo.  This contributes to the promotion of Z-Wave as a technology brand. <br><img src="https://habrastorage.org/files/75f/cea/7b8/75fcea7b8d4e44e08a15a8c526372e74.jpg"><br><br><h5>  Typical layout </h5><br>  Let's return to the gland.  A typical wiring diagram of the ZM5101 is as follows: <br><img src="https://habrastorage.org/files/f6b/314/7d4/f6b3147d420a49cab1db84905f6f5855.png"><br><br>  In the role of NVM performs SPI EEPROM or FLASH memory at least 16 KB.  It is necessary to store data about network nodes, routes, and more.  It is possible to create devices without an external EEPROM (in this case, a block of flash memory is used for memory, which reduces the space for the code).  EEPROM takes one SPI and one foot for <abbr title="Chip select">CS</abbr> .  The SPI legs can easily be used as a GPIO or for connecting another SPI Slave, while CS is raised to 3.3 V. The Z-Wave chip is programmed through the same SPI when the RESET is pulled down.  This is exactly what a CS brace is needed for (the ZM5101 becomes an SPI Slave, and the second Slave is clearly not needed here). <br><br>  We will not describe here the part related to antenna and coordination, since this is a topic for a separate scientific work. <br><br>  All other legs can be used to implement the functionality of the device. <br><br>  Suppose we want to create a complex device: 3 relays (through the Darlington assembly ULN2003, as the current limit of 20 mA from the foot of the ZM5101 is not enough for an electromagnetic relay, and this will allow the relay to be powered from 5 V or 12 V), one sensor of dry contacts, a sensor illumination (photoresistor) and a beautifully flashing three-color LED.  All this can be immediately connected to the Z-Wave chip: <br><ul><li>  We will put 3 inputs of the relay on GPIO, for example, P2.0, P2.1, P2.5 (legs P2.2 ‚Äì P2.4 occupies an EEPROM connected via SPI) </li><li>  the dry contact sensor is connected to INT0 (P1.0), INT1 (P1.1), or any other GPIO leg, if simple polling is planned, but not an ISR processor, </li><li>  The illumination sensor in the divider is connected to ADC0, it is also P3.4 (the second arm must be selected so that all possible values ‚Äã‚Äãare placed in the range of 0‚Äì3.3V), </li><li>  Our three-color LED will be connected to PWM0‚Äì2 (P0.4 ‚Äì P0.6), which will allow you to smoothly change colors in the mode of New Year's garland. </li></ul><br><br> <a href=""><img src="https://habrastorage.org/files/76a/fd2/1ba/76afd21ba5524dae9b383b80b34520d5.png" width="100%"></a> <br><br>  Notice, we still have a bunch of (18) legs!  For comparison, <sup>her</sup> 3 generation of Z-Wave chips and modules (ZM3202) did not allow even such a modest set of peripherals to be connected. <br><br><h4>  Firmware </h4><br>  GPIO legs in Z-Wave chips, as in the other 8051, are combined into ports of 8 pieces each.  One SFR is responsible for the mode (in / out), the other allows you to enable pull-up for mode in, the third to read / write values.  Timer, UART, SPI and other functions are also similar to other 8051: TMOD / THx / TLx, UARTCON / UARTBUF / UARTSTAT, SPIxCON / SPIxDATA / SPISTAT, ... There are so many different registers that in the 5th generation of chips I had to enter the SFRPAGE register to switch between SFR mapping pages on IRAM.  The size of 128KB flash memory also required the use of memory banks, which significantly complicates the translated code, filling it with many transitions from bank to bank via COMMON BANK. <br><br>  In theory, any compiler, for example, <a href="http://sdcc.sourceforge.net/">SDCC</a> (under the GNU / GPL), could be used to work with the Z-Wave chip.  But alas, there is no documentation for all these ports, registers, internal memory mapping, etc.  Instead, Sigma Designs chose another way: to deliver a pre-compiled library in binary form (and in fact a set of libraries for different classes of devices: for controllers, for sensors / performers, for gateways).  These libraries, compiled for a very specific version of Keil, provide developers with a convenient API for working with hardware (in fact, wrappers for accessing SFR), and for more complex operations with the Z-Wave network: sending commands to other nodes, maintaining the network Z-Wave, route updates and more.  This library implements the following levels of the Z-Wave protocol: PHY (directly encoding and decoding at the desired frequency, transmission channel selection, <abbr title="Listen Before Talk">LBT</abbr> ), MAC (error control, addressing within sight), transport (confirmation, replay) and network (routing, relaying, updating routes, searching for new routes, inclusion into the network, removal from the network). <br><br>  It is Sigma Designs that deals with compatibility at this level, ensuring protocol development and continuity.  The advantages of this approach include the guaranteed compatibility between Z-Wave devices and the simplicity of work at the ‚Äútop‚Äù level, the disadvantages are the low speed of reaction to errors found. <br><br>  To interact with the Z-Wave network, the <strike>user</strike> remains with the developer only simple functions for interacting with other nodes.  However, the standard requires tight compatibility and at the levels above: session, representative and applied.  These levels are already at the mercy of end device developers.  The library allows node A to send a command to node B. In this case, the command must have a strictly defined format described by the Z-Wave protocol in the <abbr title="Command classes - functional blocks defined by the protocol">Command Classes</abbr> Specification section (about 900 pages of text).  This will allow node B to properly parse the command and perform the appropriate action with the periphery. <br><br>  Z-Wave libraries are made in a ‚Äúcallback‚Äù format.  The starting point (main) is in the library, and control to the user is transferred only at certain moments: <br><ul><li>  at the start (two entry points - immediately after the start of the chip to initialize the hardware and later, when the library was initialized and you can already use some of its functions - the analog setup () in Arduino, </li><li>  when the library is not busy (receiving / sending data, sending packets to other network nodes, responding to controller requests) - here you can poll buttons, measure the value on the ADC, etc.  - analog loop () in Arduino, </li><li>  when the command is received (where we are the recipient, the CRC agreed and the sender from our network). </li></ul><br>  In all functions that require time and working "asynchronously", you can also transfer a callback.  For example, when calling the package sending function, you can specify a handler that will receive the sending status (delivered, not delivered, and error code).  The timers subsystem is similarly implemented (besides the exact ones based on TIMER1 and GPT): you can run up to 5 software timers that work in 10 ms increments (TIMER0 cannot be used, it is used by the library for internal needs and software timers).  All this facilitates the work of programmers manufacturer of the end device. <br><br>  Together with the Z-Wave libraries, a huge number of structures and constants predetermined in the header files are also supplied that correspond to the standard, which greatly simplifies development.  Sigma Designs also supplies two dozen examples that implement simple devices, for example, a relay or a binary sensor or a door lock, with the minimum functionality necessary for operation and certification of <abbr title="Stricter version of the Z-Wave protocol (compared to the usual Z-Wave, only the application layer is refined)">Z-Wave Plus</abbr> .  It's funny, but more than half of Z-Wave devices manufactured in the Middle Kingdom are based on these examples without a single modified line, except for the ManufacturerId, ProductId, ProductTypeId identifiers (we are talking about the manufacturer‚Äôs identifiers, series and models; for certification they must be unique, so if if not this requirement, they would not differ at all;) <br><br>  The combination of all the headers, libraries and sample code is Z-Wave SDK or ZDK.  ZDK is distributed under the NDA.  Usually, NDA is signed when you purchase DevKit. <br><br>  As mentioned earlier, in order to develop our own device, we will need <a href="http://www.keil.com/dd/chip/7310.htm">Keil C51</a> .  It costs about 2600 Euro.  But this is not all waste, we are waiting for another stage. <br><br><h5>  Team Classes and NIFs </h5><br>  In addition to programming the logic of working with peripherals, you must declare a list of supported classes of commands for the device being created in <abbr title="Node Information Frame">NIF</abbr> , as well as implement the declared classes of commands (for more details about command classes, <a href="http://geektimes.ru/post/257684/">see this article</a> ).  In fact, it comes down to writing code that processes all possible commands of all supported classes. <br><br>  For example, for the Switch Binary class (ID 0x25), you must process the Set command (25 01) by turning on the relay or LED or something else, the Get command (25 02), responding to it with the Report command (25 03 xx), where xx = 00 or FF, depending on the current state of the relay, light bulb or whatever you have there. <br><br>  For our example of a ‚Äúcomplex‚Äù device, it will look something like this. <br><div class="spoiler">  <b class="spoiler_title">Pseudocode handler</b> <div class="spoiler_text">  NIF will contain 0x25 (SwitchBinary), 0x26 (SwitchMultilevel), 0x30 (SensorBinary), 0x31 (SensorMultilevel), 0x60 (MultiChannel) and a dozen other service classes needed only for service tasks and settings. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (pCmd[<span class="hljs-number"><span class="hljs-number">0</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> COMMAND_CLASS_MULTI_CHANNEL: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (pCmd[<span class="hljs-number"><span class="hljs-number">1</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MULTI_CHANNEL_CMD_ENCAP: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (pCmd[<span class="hljs-number"><span class="hljs-number">4</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> COMMAND_CLASS_MULTI_SWITCH_BINARY: <span class="hljs-comment"><span class="hljs-comment">//    if (pCmd[3] == 1) { switch(pCmd[5]) { case SWITCH_BINARY_SET: pin_set(P2_0, pCmd[6] ? 1 : 0); break; case SWITCH_BINARY_GET: //  :  ;  ,  ;  ;  ; ; ...  SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SWITCH_BINARY, SWITCH_BINARY_REPORT, pin_get(P2_0)); break; } } if (pCmd[3] == 2) { switch(pCmd[5]) { case SWITCH_BINARY_SET: pin_set(P2_1, pCmd[6] ? 1 : 0); break; case SWITCH_BINARY_GET: SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SWITCH_BINARY, SWITCH_BINARY_REPORT, pin_get(P2_1)); break; } } if (pCmd[3] == 3) { switch(pCmd[5]) { case SWITCH_BINARY_SET: pin_set(P2_5, pCmd[6] ? 1 : 0); break; case SWITCH_BINARY_GET: SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SWITCH_BINARY, SWITCH_BINARY_REPORT, pin_get(P2_5)); break; } } break; case COMMAND_CLASS_MULTI_SENSOR_BINARY: if (pCmd[3] == 4) { switch(pCmd[5]) { case SENSOR_BINARY_GET: SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SENSOR_BINARY, SENSOR_BINARY_REPORT, SENSOR_BINARY_TYPE_GENERAL_PURPOSE /*    */, pin_get(P1_0)); break; } } case COMMAND_CLASS_MULTI_SENSOR_MULTILEVEL: if (pCmd[3] == 5) { switch(pCmd[5]) { case SENSOR_MULTILEVEL_GET: SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SENSOR_MULTILEVEL, SENSOR_MULTILEVEL_REPORT, SENSOR_MULTILEVEL_TYPE_LUMINESENCE /*  */, 0 /*   % */, analog_get(P3_4)); break; } } case COMMAND_CLASS_MULTI_SWITCH_MULTILEVEL: if (pCmd[3] == 6) { switch(pCmd[5]) { case SWITCH_MULTILEVEL_SET: pwm_set(P0_4, pCmd[6] &gt; 99? 99 : pCmd[6]); break; case SWITCH_MULTILEVEL_GET: SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SWITCH_MULTILEVEL, SWITCH_MULTILEVEL_REPORT, pwm_current(P0_4)); break; } } case COMMAND_CLASS_MULTI_SWITCH_MULTILEVEL: if (pCmd[3] == 7) { switch(pCmd[5]) { case SWITCH_MULTILEVEL_SET: pwm_set(P0_5, pCmd[6] &gt; 99? 99 : pCmd[6]); break; case SWITCH_MULTILEVEL_GET: SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SWITCH_MULTILEVEL, SWITCH_MULTILEVEL_REPORT, pwm_current(P0_5)); break; } } case COMMAND_CLASS_MULTI_SWITCH_MULTILEVEL: if (pCmd[3] == 8) { switch(pCmd[5]) { case SWITCH_MULTILEVEL_SET: pwm_set(P0_6, pCmd[6] &gt; 99? 99 : pCmd[6]); break; case SWITCH_MULTILEVEL_GET: SendMultiChannelReport(srcNodeId, pCmd[2], pCmd[3], COMMAND_CLASS_MULTI_SWITCH_MULTILEVEL, SWITCH_MULTILEVEL_REPORT, pwm_current(P0_6)); break; } } break; } } }</span></span></code> </pre> <br>  As you can see, we processed 8 channels of different types here. <br><br>  (This is a very simplified code for understanding, but the basic idea is preserved. Of course, we are not writing this way - we just decided not to scare you and NDA once again not to break. Details <a href="https://github.com/yepher/RaZBerry/">here</a> .) </div></div><br>  Obviously, all devices must process these commands more or less equally.  3 years ago we pretty well template our code, creating a common code base for our devices.  Many of our devices differ only in a single .h file.  More complex have a couple of sishnikov for specials.  functional.  With the release of the 5th generation of chips, Sigma Designs has done something similar, so the code for the examples is easy to adapt to fit your needs. <br><br><h4>  Certification </h4><br>  After you have invented a device, made a prototype, wrote firmware for it, you need to certify your device.  The certification process is required to verify that your device complies with the Z-Wave protocol. It consists of two parts: Technical Certification (verification of the device itself) and Market Certification, which also verifies the documentation (mentioning the key Z-Wave terms), the presence and correctness of using the Z-Wave logo or Z-Wave Plus. <br><br>  Z-Wave certification is carried out by one of three certificate authorities: Pepper One in Germany, BuLogics in the USA or at Sigma Designs itself.  Before certification, it is required to undergo the certification process independently (self-certification), which allows you to immediately detect and eliminate many errors, as well as reduce the likelihood of file certification.  To do this, there is a special <abbr title="Compliance Test Tool">CTT</abbr> utility available to the full members of the Z-Wave Alliance.  She is used by certifiers.  There is also a certification form (depending on the device in it from 100 to 300 points), on which you need to describe the device.  According to this form will be certified.  For all items there is a detailed description of how it is tested and what is expected from the device.  It is worth noting that the whole process is fairly transparent - it is clear in advance what they will check and how (if all the docks are read in advance;) <br><br>  Certification is a laborious and laborious process.  Certification also costs money: depending on the complexity of the device from $ 3,000 to $ 5,500.  It's all about how the exams in the traffic police: allowed some reasonable number of fail'ov that need to be eliminated within a month (the so-called ad-hoc period).  If there are more files or could not be fixed, then re-certification with a new payment will be required.  This is a good incentive to test your devices well.  Personally, we zafaililis only once, but he strongly knocked out our pride. <br><br>  Significant changes in device functionality or behavior on the Z-Wave network require re-certification (re-certification costs half the price).  Often one device without change is sold in different versions and colors.  In this case, you only need to repeat the Market Certification (for free). <br><br>  Again, using the example of our ‚Äúcomplex‚Äù device, CTT will see that we in the SwitchMultilevel class do not process the StartLevelChange and StopLevelChange commands necessary for dimming.  If we do not fix it, then our device will not pass certification.  (We just did not want to increase so a terrible piece of handler code). <br><br>  Also note that certification (and CTT) are available only to full members of the Z-Wave Allianas (Full or Principal Member, but not the Affiliate Member).  This is another <a href="http://z-wavealliance.org/z-wave-oems-developers/">$ 4,000 per year</a> . <br><br><h4>  Debugging </h4><br>  Immediately, I note that there is no JTAG or other debugging tools in the Z-Wave chip!  This makes the life of the developers terrible and unbearable.  Therefore, often complex code is tested and debugged first on any chip of the 8051 family from, for example, Silicon Labs, which did not skimp on a normal JTAG or C2, conveniently integrated into the built-in debugger in Keil.  We also test parts of the code by compiling it on Linux with gcc and running various tests (for example, we are testing our packet queue engine for sending to devices).  This makes it impossible to catch overflows typical of the microcontroller's architecture itself (for example, getting out of a small stack, lack of registers for recursive or simply deeply nested function calls) or debugging the code associated with SFR or hardware of the chip, but basic ‚Äúplatform-independent‚Äù problems easy to catch.  Often, you have to pick the ASM code ( <a href="http://www.brouhaha.com/~eric/software/d52/">d52 is</a> our everything!), And also use the convenient tools of Keil itself with map files. <br><br>  Otherwise, you have to settle for debugging via I2C, SPI or UART (which works for simple problems when stack or memory corruption does not occur from distant pieces of code). <br><br>  A separate exercise is to create battery-powered devices ‚Äî to reduce power consumption, you need to write high-quality code that takes into account long operation time (ADC, radio, access to EEPROM) and the location of variables (256 bytes of XRAM are powered even in deep sleep mode, allowing Wake up does not read a slow EEPROM, but quickly make a decision and go to sleep further). <br><br><h4>  Sophisticated devices </h4><br>  When creating more complex devices that require a lot of legs, it is necessary to use several chips communicating via UART, SPI or I2C.  In this case, part of the functionality of working with the periphery (or all) goes to the second chip.  Very convenient is the use of more advanced in terms of the capabilities of the periphery and power consumption Atmel (with reduced frequency) or Cortex.  Such an approach allows using the Z-Wave chip only as a ‚Äúmodem‚Äù. <br><br><h5>  Z-Wave Serial API </h5><br>  A special case of this approach is the use of a Z-Wave chip in conjunction with another CPU with a full-fledged OS (for example, a PC or Raspberry Pi).  In order not to push manufacturers to reinvent the wheel, Sigma Designs proposed its own standard for exchanging data between the CPU and the Z-Wave UART chip, which is called the Z-Wave Serial API.  In this case, the firmware implements UART data exchange, displaying almost 1: 1 all commands available to the developer on the Serial API commands from the CPU, and returning the values ‚Äã‚Äãand callback via commands to the CPU.  An example of such firmware is available in the ZDK and is available to all developers. <img src="https://habrastorage.org/files/753/cab/80d/753cab80d6334b91997f55956ca40394.png" width="400" align="left">  This approach made it possible to create a ‚Äúmarket‚Äù of Z-Wave USB sticks separately from the ‚Äúmarket‚Äù of software for them: many manufacturers offer interchangeable sticks, while software manufacturers create software that works with any stick.  This kind of software called Z-Wave PC Controller is included in ZDK (available in sursu). <br><br>  In addition, this approach contributes to the spread of technology: the manufacturer of a TV set-top box or router, having created a solution based on a third-party Z-Wave USB stick, with increasing sales may decide to order a PCB lot with an installed Z-Wave module, thereby cheapening the solution.  In this case, the ZM5304 module is most often used (ZDK has a firmware for it that implements the Serial API). <br><br>  However, some companies that produce both hardware and software (we treat them with our UZB sticks, RaZberry expansion cards and our Z-Way software) prefer to ‚Äútie‚Äù software to sticks, since in this case there is less support (we, for example, , we eliminate many problems of the Sigma Designs code and supplement it with our extensions) and it is easier to collect money for software (the cost is already included in the stick).  Others (for example, Merten) generally created their own data exchange format different from the Z-Wave Serial API. <br><br><h4>  Training and support </h4><br>  For each region are assigned several <abbr title="Field application engineer">FAEs</abbr> from Sigma Designs.  They help new manufacturers get started with Z-Wave, accept bug reports and help with controversial situations during the certification process. <br><br>  Z-Wave Alliance is also actively involved in the life of manufacturers, offering not only testing utilities and training materials.  Several times a year in different parts of the world, the Alliance gathers developers at the UnPlug Fest conference to share experiences and test their devices with other participants.  FAE Sigma Designs also participate in these events.  UnPlug Fest is always accompanied by a two-day training for new developers. <br><br>  The Z-Wave Alliance also organizes the Interoperability Lab in New Jersey, USA, where you can test your devices for compatibility as well as in a special radio lab. <br><br>  In addition, the Alliance has Z-Wave protocol development working groups.  All developers can offer their ideas and influence the functionality of the next versions of all classes of commands and the protocol as a whole. <br><br>  More information is available on the <a href="http://www.z-wavealliance.org/">Z-Wave Alliance</a> website. <br><br><h4>  A little more about money </h4><br>  Let us return to the issue of economics and calculate what it will cost us per device.  I will do it very roughly and assessed - do not judge strictly.  Detailed financial analysis is not the purpose of this article.  For evaluation, I even put ‚Ç¨ = $ (yes brokers will forgive me). <br><br>  Imagine that we are going to release 5,000 devices of some type.  The unit price will consist of <abbr title="Bill Of Material / Cost of materials and components">BOM</abbr> and development costs. <br><br><img src="https://habrastorage.org/files/848/5b2/6bf/8485b26bfeec4ada84930921d67fd675.jpg" width="400" align="right">  Let us forget about our ‚Äúcomplex‚Äù device and talk about, for example, a simple key fob (on the left, the board of our key fob in the 5th generation, on the right in 3 <sup>plots</sup> ).  A rough calculation shows that the components (except for the Z-Wave chip) and the PCB with the assembly cost about 7 bucks (talking about the small-scale production of our party, and not about a million Chinese keyfobs).  The ZM5202 module costs 5 more (analogs cost about 2 bucks, i.e., about 3 went for the Z-Wave license).  Another body for 1 bucks (so help Alibaba!).  Total 13. <br><br>  Now let's calculate the cost of developing the firmware: 2600 (Keil) + 2500 (DevKit / ZDK) + 4000 (Alliance membership for a year) + 3500 (certification) ‚âà 2.5 bucks per device.  And with the production of several models, the first three items will be distributed over all types of devices, i.e.  the price will fall significantly. <br><br>  Also worth considering the work of programmers.  In our experience, on the first device they will ‚Äúdevour‚Äù at least 10 person ‚Äì months, or even more.  That for the first device will result in 2-4 bucks (for subsequent devices it will be 2-3 times less due to the accumulation of experience). <br><br>  Thus, your first 5000 (very simple) devices will cost you 19.5 bucks.  Add VAT, transportation, duties (for imports), certification, margin for yourself and channel partners, minimal marketing, and we get <s>three ends for</s> about 60 bucks.  With experience and growth in production, this figure will be closer to 15 bucks, i.e.  closer to 45 in retail.  This is the retail price of the device here.  This is the question of how much it costs, and why. <br><br>  Also note that the first experienced certified sample will cost at least 20 000 bucks.  Less well, in no way newcomers fail. <br><br>  Can I make it cheaper on a proprietary protocol and some kind of chip from TI or Silicon Labs?  Not a fact, if we are not talking about a collective farm on our knees, but about a serial device with good support.  Yes, Z-Wave is 20% ‚Äì30% more expensive, but it is often justified. <br><br><h4>  Moral of this fable </h4><br>  As you can see, the process of creating your own devices based on the Z-Wave protocol does not hide any mysteries and is completely accessible to any IT company familiar with microcontrollers.  Thanks to the SoC format, many devices can be made on a Z-Wave chip and a small number of additional components.  Yes, you have to read about 2000 pages of specification and go through certification. <br><br>  Is it worth it to get into all this, and why do you need Z-Wave?  If you want to create only a controlled light bulb and a motion sensor, and even cheaper, then Z-Wave will be a burden to you.  But if you want to create complete components of a smart home, then you better ‚Äúfit‚Äù into an existing well-developed protocol, such as Z-Wave.  After all, few companies in the market are able to independently produce a line of 30‚Äì50 devices for various purposes: from keyfobs and relays to thermostats and door locks.  Having joined the popular protocol, you can increase sales of your device by fitting it into the existing ecosystem of smart home devices. <br><br><h4>  Somehow difficult for a simple geek ... </h4><br>  You are a geek, not willing to pay a lot of money and study the insides of Z-Wave in such detail?  But the finished device does not suit you?  Then as advertising we will tell about one our new device.  Meet the Z-Uno! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/411/4a5/0b9/4114a50b96ac43f799c7c8bbdfeed878.png" width="200"></div><br><br>  About Z-Uno we will write a separate article (link from the future: <a href="http://geektimes.ru/post/268980/">geektimes.ru/post/268980</a> ).  In short, this is a small motherboard based on the ZM5101.  We have brought out almost all the legs of this module for you.  This device has a special firmware that allows you to load custom code written in the Arduino IDE environment in the usual for ‚ÄúArduinschikov‚Äù language.  We have supplemented the ‚Äúsyntax‚Äù of the Arduino with our macros, which allow us to describe the Z-Wave functions of the device (up to 10 functions) and determine what to send for each function.  Thus, Z-Uno is an Arduino clone (with some reservations, this is not Atmel, but 8051) with built-in support for Z-Wave.  Wait for the next article or read on <a href="http://z-uno.z-wave.me/">z-uno.z-wave.me</a> . </div><p>Source: <a href="https://habr.com/ru/post/367509/">https://habr.com/ru/post/367509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../367499/index.html">Sex quantification through mobile apps</a></li>
<li><a href="../367501/index.html">We are updating! Windows 10 Mobile - Build 10149</a></li>
<li><a href="../367503/index.html">Smart rifle wins professional sniper</a></li>
<li><a href="../367505/index.html">Nintendo NES for $ 500: games from childhood on 1080x720 screens</a></li>
<li><a href="../367507/index.html">Another successful space launch. The history of the project "VEGA" (Vettore Europeo di Generazione Avanzata)</a></li>
<li><a href="../367511/index.html">Listening to music at home</a></li>
<li><a href="../367513/index.html">We talk about vinyl: Myths, opinions and current situation</a></li>
<li><a href="../367515/index.html">Brain of rats in a dream makes plans and chooses ways to achieve goals</a></li>
<li><a href="../367519/index.html">Primitive prediction in the INS</a></li>
<li><a href="../367521/index.html">Mark Zuckerberg: for my house I will create an AI like Jarvis from Iron Man</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>