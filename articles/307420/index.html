<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bot-teller at pywinauto, or GUI automation for payment gateway</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I work in a small Israeli startup, our product is a platform for ordering food from restaurants, cafes and shops. Unlike dozens of similar services, w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bot-teller at pywinauto, or GUI automation for payment gateway</h1><div class="post__text post__text-html js-mediator-article">  I work in a small Israeli startup, our product is a platform for ordering food from restaurants, cafes and shops.  Unlike dozens of similar services, we are monopolists in the US student market.  We process about hundreds of thousands of orders per day at peak and one of the production gateways is built on GUI automation for a Win32 application using the <a href="http://pywinauto.github.io/">pywinauto</a> library. <br><a name="habracut"></a><br>  First, why do we work only in universities?  Many ideas often look good only in perspective.  For example, the same idea of ‚Äã‚Äãfood delivery.  It seems to be great to write an application so that you can order from any restaurant, not to bathe with payment, etc.  Everyone who tries to implement this idea stumbles upon the so-called Chicken or the egg problem.  While there are few restaurants in the annex, it is meaningless;  in the meantime, there are few users; restaurants do not rush to integrate the new application into their workflow.  Usually at this moment everything dies.  This situation is not unique to the food ordering application. <br><br>  The solution to this problem is usually a kind of hybrid model, when, in addition to the future benefits of socialization, there is a benefit for each individual user.  For example, Waze.  Now this is an application that knows about all traffic jams, accidents and police on the road, but they started as a free GPS application, which was useful for everyone.  There are other solutions, about one of them I will tell on our example. <br><br>  Resting on this problem, the same fate awaited us.  We rather unsuccessfully tried to break through to the San Francisco market, which is full of such decisions, and before we die quietly, we decided to try another idea.  It consisted in not trying to negotiate with all the restaurants, but only with a certain platform that has leverage on local businesses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The choice fell on universities.  Offering a percentage of income and service for students, we were an excellent offer for the university, problems of local restaurants related to the integration of the application into their business process, they were not interested, for them we were a direct and indirect benefit.  They required a business on campus to work with our application.  We integrated into all the restaurants on the campus - for students, our application became very convenient: you can order lunch during lectures and not wait for your order at recess.  We instantly capture most of the campus, and the viral effect is very large.  When a person lonely waits in a queue, and people come alongside, take their ready order and immediately leave, most often our application is downloaded right on the spot. <br><br>  At some point we had a problem.  The fact is that in America it is very difficult to get a credit card, and most students do not have it.  On the other hand, student IDs are issued in the form of plastic cards with a magnetic stripe and are a payment tool inside the campus.  The university charges them with some sort of scholarship.  These funds are more structured: there are separate parts that can be spent freely, but there are funds only for food.  And these cards are only accepted on campus. <br><br>  We, as a company that works with students, of course wanted to serve these cards.  But not everything is so simple.  The company that produces these cards is not a bank.  The student card service market is almost monopolized and divided between three companies into hundreds of universities across America. <br><br>  One of these companies tried to launch a service similar to ours, and, losing the competition, ‚Äúoffended‚Äù in the best traditions of sandy grounds and refused to conduct any cooperation with us.  The fact is that under an agreement with a university, a business that has the right to accept payment via student cards, the issuing company must provide a terminal with a desktop application where you can enter the student card number and withdraw money.  It is very convenient for all kiosks and sausages.  But it is not necessary to provide the API for mass service under the contract, and they did not want to open it.  I had to work with what is.  As a result, we found a rather unusual solution for a payment gateway, which in the first few months of its existence is quite successfully operating in 6 universities: tens of thousands of transactions were carried out for hundreds of thousands of dollars, and in the next academic year this solution will be scaled to several dozen American universities with a turnover funds in tens of millions of dollars. <br><br><h3>  How it works? </h3><br>  About our decision.  I must say that it was very important for us to find a solution that is absolutely legal.  For example, Reverse Enginering is illegal; it can also be problematic to sniff traffic and simulate the frontend of this POS terminal, but it is absolutely legal to automate clicks on the desktop application.  On campus, we are allocated a Windows virtual machine with a desktop cash register installed.  The Flask + Tornado bundle is also installed there.  When a user makes an order from a phone, a request comes to the virtual machine with all the necessary parameters: amount, student card number, etc.  Next, using <a href="http://pywinauto.github.io/">pywinauto,</a> we enter the amount, card number, all the necessary parameters (there is quite a complicated logic in terms of discounts, free lunches in a certain part of the day, etc.).  We carry out a transaction, check the result and return the response to the server.  It took about 20 seconds to process one transaction, but in the end it was reduced to 3. <br><br>  When profiling, some features of the library were found. <br><br>  Calls to Application (). Connect () for connecting to an application have many different parameters and, for example, identifying an application or a window by class_name works 20 times faster than it does by title_re (a regular window title expression). <br><br>  The second unexpected point was that if the window had not yet opened, the call to Connect () takes a lot of time (up to a few seconds) before throwing an exception.  It should not be called without being sure that the window is already open, it is better to find a heuristic model that will allow you to understand that the call will be successful.  In my case, when opening a new window, the form of the main application stopped being 'active', this could be caught by calling form.WaitNot ('active'), after returning which you can safely call Connect (). <br><br>  Another of the problems we encountered: automation via the Win32 API does not work without an open user session on the machine.  This is a common problem for all such tools.  For example, the ClickInput and TypeKeys methods do not work in the <a href="http://pywinauto.github.io/">pywinauto</a> library if the session is locked or the RDP connection is minimized.  This was my first acquaintance with automating the GUI and Win32 API, so the solution to the problem could be very long.  Fortunately, the library has a wonderful maintainer <a href="https://habr.com/users/vasily-v-ryabov/" class="user_link">vasily-v-ryabov</a> .  I express my deep gratitude to him for the detailed consultations. <br><br>  We found a solution to all problems, mainly many issues were solved with alternative challenges.  For example, when a non-standard tab switching widget was encountered in an application that did not respond to any standard call, a solution was found by analyzing Windows Messages in Spy ++ and sending the same messages using the PostMessage method in <a href="http://pywinauto.github.io/">pywinauto</a> . <br><br>  The library is actively developing and, as practice has shown, is stable enough even to use it in production for the implementation of a payment gateway.  Almost all the problems associated with reduced functionality in the absence of the session will be solved in the next release (0.6.0), which is preparing to be released this year (the UIA branch on the github).  For example, the send_chars method will allow you to successfully transfer almost any combination of characters to an inactive or even a minimized window.  And most importantly, in the UIA branch there is support for Microsoft UI Automation technology (for WinForms, WPF, StoreApps, Qt and browsers), but this is a topic for a separate article. <br><br>  If it seemed to you that the implementation of a payment gateway by automating the GUI is not the top of surrealism, then I can add that one of the universities in Texas has very strict restrictions on access to the internal network, so the deployment, debug and upgrade module that processes payments of tens of thousands People go on Skype - "Now write git fetch" - and stuff like that.  By the way uptime we have&gt; 99.6%.  Thank you <a href="http://pywinauto.github.io/">pywinauto</a> ). </div><p>Source: <a href="https://habr.com/ru/post/307420/">https://habr.com/ru/post/307420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307408/index.html">How trading on a stock exchange actually works: A simple algorithm (part 2)</a></li>
<li><a href="../307410/index.html">How to improve email addresses</a></li>
<li><a href="../307412/index.html">Features of file systems that we encountered while developing the Mail.Ru Cloud synchronization mechanism</a></li>
<li><a href="../307414/index.html">Keyboard layout in Q4OS</a></li>
<li><a href="../307416/index.html">RailsClub 2016: October 22 in Moscow will be the creator of Ruby Yukihiro Matsumoto and not only</a></li>
<li><a href="../307422/index.html">Machine Learning for Tennis Prediction: Part 2</a></li>
<li><a href="../307424/index.html">Cat-and-mouse game: how anti-spam was created in Mail.Ru Mail and what does Tarantool have to do with it</a></li>
<li><a href="../307426/index.html">Moving to the cloud: how modern companies use the benefits of IP telephony</a></li>
<li><a href="../307428/index.html">Creating levels using the Super Mario World method</a></li>
<li><a href="../307430/index.html">ProjectSauron: cyber spyware hacking into encrypted communication channels of state organizations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>