<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating custom UIActivity for publishing photos and text on the social network VKontakte</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While working on the next version of the application, the task arose of making the publication of photos on the social network VKontakte through the s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating custom UIActivity for publishing photos and text on the social network VKontakte</h1><div class="post__text post__text-html js-mediator-article">  While working on the next version of the application, the task arose of making the publication of photos on the social network VKontakte through the standard <a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIActivityViewController_Class/Reference/Reference.html">UIActivityViewController</a> controller. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f1/498/b82/4f1498b82c2db1f88585e3a7130d8fac.jpg" alt="image"></div><br>  A web search gave the following results: <br><ol><li>  <a href="https://github.com/shu223/UIActivityCollection">No finished implementation found</a> </li><li>  There is an <a href="https://vk.com/dev/ios_sdk">official sdk VKontakte</a> : contains authorization mechanisms, work with pictures, but does not have a ready-made class for loading via <a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIActivityViewController_Class/Reference/Reference.html">UIActivityViewController</a> </li><li>  Apple documentation for creating custom <a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIActivity_Class/Reference/Reference.html">UIActivity</a> </li></ol><br><br><a name="habracut"></a><br><h3>  Preparing to use VK SDK </h3><br>  Before you start working with the VK SDK, you need to create a <a href="https://vk.com/dev/standalone">Standalone</a> application on <b><a href="https://vk.com/editapp%3Fact%3Dcreate">the application creation page</a></b> .  Save the <b>application ID</b> and fill in the "App Bundle for iOS". <br>  To set up authorization through VK App, you need to configure the URL protocol of the application: <br><ul><li>  Open the project settings, select the "Info" section. </li><li>  In the ‚ÄúURL Types‚Äù section, click on +. </li><li>  Enter vk + <b>APP_ID</b> (for example, <i>vk1234567</i> ) in the ‚ÄúIndentifier‚Äù and ‚ÄúURL Schemes‚Äù fields. </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><h3>  Work with SDK </h3><br>  You must initialize the SDK when you start the application method <br><blockquote>  [VKSdk initialize: delegate andAppId: APP_ID]; </blockquote><br>  For authorization, you can use the method: <br><blockquote>  [VKSdk authorize: scope]; </blockquote><br>  If successful, the delegate will be called <br><blockquote>  - (void) vkSdkDidReceiveNewToken: (VKAccessToken *) newToken; </blockquote><br>  In case of an error (for example, the user denied authorization) <br><blockquote>  - (void) vkSdkUserDeniedAccess: (VKError *) authorizationError; </blockquote><br><br><h3>  UIActivity for VK </h3><br>  Following the Apple documentation, we create a UIActivity inheritor: <br><br><pre><code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> @interface VKontakteActivity : UIActivity - (id)initWithParent:(UIViewController*)parent; @end</span></span></code> </pre> <br>  The auxiliary controller <strong>parent is</strong> needed for captcha input, output of messages, etc. <br><br>  Next, override the methods for displaying the UIActivity element (type, name and icon) <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)activityType { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">@"VKActivityTypeVKontakte"</span></span>; } - (<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)activityTitle { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">@""</span></span>; } - (<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *)activityImage { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> imageNamed:<span class="hljs-string"><span class="hljs-string">@"vk_activity"</span></span>]; }</code> </pre><br><br>  Check if our class supports sharing of activityItems passed to it: <br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canPerformWithActivityItems:(<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)activityItems { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">UIActivityItemProvider</span></span> *item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> activityItems) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([item isKindOfClass:[<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([item isKindOfClass:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br><br>  Remember the activity supported by us: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)prepareWithActivityItems:(<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)activityItems { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> activityItems) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([item isKindOfClass:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.string = item; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([item isKindOfClass:[<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.image = item; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([item isKindOfClass:[<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.URL = item; } } }</code> </pre><br><br>  When choosing our UIActivity directly, we check whether the user is authorized: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)performActivity{ [VKSdk initializeWithDelegate:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> andAppId:<span class="hljs-string"><span class="hljs-string">@"3974615"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([VKSdk wakeUpSession]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> postToWall]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ [VKSdk authorize:@[VK_PER_WALL, VK_PER_PHOTOS]]; } }</code> </pre><br><br>  With successful authorization publish the post. <br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)postToWall{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> begin]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.image) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> uploadPhoto]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> uploadText]; } } <span class="hljs-comment"><span class="hljs-comment">//    -(void)uploadText{ [self postParameters:@{ VK_API_FRIENDS_ONLY : @(0), VK_API_OWNER_ID : [VKSdk getAccessToken].userId, VK_API_MESSAGE : self.string}]; } //    -(void)postParameters:(NSDictionary *)params{ VKRequest *post = [[VKApi wall] post:params]; [post executeWithResultBlock: ^(VKResponse *response) { NSNumber * postId = response.json[@"post_id"]; [[UIApplication sharedApplication] openURL:[NSURL URLWithString:[NSString stringWithFormat:@"http://vk.com/wall%@_%@", [VKSdk getAccessToken].userId, postId]]]; [self end]; } errorBlock: ^(NSError *error) { NSLog(@"Error: %@", error); [self end]; }]; }</span></span></code> </pre><br><br>  Moreover, if the post contains a picture, then pre-upload it to the server. <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)uploadPhoto { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *userId = [VKSdk getAccessToken].userId; <span class="hljs-comment"><span class="hljs-comment">//     VKRequest *request = [VKApi uploadWallPhotoRequest:self.image parameters:[VKImageParameters jpegImageWithQuality:1.f] userId:[userId integerValue] groupId:0]; [request executeWithResultBlock: ^(VKResponse *response) { VKPhoto *photoInfo = [(VKPhotoArray*)response.parsedModel objectAtIndex:0]; NSString *photoAttachment = [NSString stringWithFormat:@"photo%@_%@", photoInfo.owner_id, photoInfo.id]; //    [self postParameters:@{ VK_API_ATTACHMENTS : photoAttachment, VK_API_FRIENDS_ONLY : @(0), VK_API_OWNER_ID : userId, VK_API_MESSAGE : [NSString stringWithFormat:@"%@ %@",self.string, [self.URL absoluteString]]}]; } errorBlock: ^(NSError *error) { NSLog(@"Error: %@", error); [self end]; }]; }</span></span></code> </pre><br><br>  Example of publishing a photo using VKontakteActivity: <br><pre> <code class="objectivec hljs"> <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *items = @[[<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> imageNamed:<span class="hljs-string"><span class="hljs-string">@"example.jpg"</span></span>], <span class="hljs-string"><span class="hljs-string">@"Example"</span></span> , [<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> URLWithString:<span class="hljs-string"><span class="hljs-string">@"https://www.youtube.com/watch?v=S59fDUZIuKY"</span></span>]]; VKontakteActivity *vkontakteActivity = [[VKontakteActivity alloc] initWithParent:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">UIActivityViewController</span></span> *activityViewController = [[<span class="hljs-built_in"><span class="hljs-built_in">UIActivityViewController</span></span> alloc] initWithActivityItems:items applicationActivities:@[vkontakteActivity]]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> presentViewController:activityViewController animated:<span class="hljs-literal"><span class="hljs-literal">YES</span></span> completion:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>];</code> </pre><br><br>  The source code of the project can be downloaded <strong><a href="https://github.com/denivip/VKActivity">here</a> .</strong> </div><p>Source: <a href="https://habr.com/ru/post/214637/">https://habr.com/ru/post/214637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214623/index.html">Planning technical work with the service HostTracker</a></li>
<li><a href="../214627/index.html">Video reports from the conference LoveQA. First part</a></li>
<li><a href="../214629/index.html">"126 key issues in working with colleagues, management and customers" or "How we made the formula of working with people"</a></li>
<li><a href="../214631/index.html">Apple CarPlay Application Design</a></li>
<li><a href="../214635/index.html">Recognition from a non-standard microphone</a></li>
<li><a href="../214639/index.html">Online compiler for ASP.Net MVC</a></li>
<li><a href="../214643/index.html">Aggregates of multidimensional OLAP cubes in RAM</a></li>
<li><a href="../214645/index.html">Magento Enterprise: What is Full Page Cache and why is it needed?</a></li>
<li><a href="../214647/index.html">PHP and various types of NoSQL</a></li>
<li><a href="../214649/index.html">Up! Plus 2. Overview: unpacking, calibration, analysis and first print</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>