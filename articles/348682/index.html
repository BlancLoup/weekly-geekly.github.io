<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploy your Java environment with Ansible</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Follow me, follow me, reader, and I will take you to the fascinating world of automating the deployment of environments on servers running Linux from ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploy your Java environment with Ansible</h1><div class="post__text post__text-html js-mediator-article"><p>  Follow me, follow me, reader, and I will take you to the fascinating world of automating the deployment of environments on servers running Linux from the RHEL family. </p><br><p>  One of our java-projects has grown, has become quite an adult and now occupies 4 circuits: </p><br><p>  Dev - contour for the development team, <br>  Qa - contour for the testing team, <br>  Stage - a contour for demonstrating new features to the customer, <br>  Production - combat circuit. </p><br><p>  Each contour contains two identical servers with an identical set of environmental components for our application: </p><br><p>  Oracle linux - operating system <br>  jdk is a set of Java applications, <br>  haproxy - proxy server <br>  nginx is a web server for statics, <br>  mysql - subd. </p><br><p>  The operational team had a reasonable question: how to set up environmental management on eight servers and maintain an optimistic attitude to life. </p><br><p>  After a brief comparison of configuration management systems, Ansible was selected.  The simplicity, flexibility, and lack of agents on the managed servers played in his favor. </p><br><p><img src="https://habrastorage.org/webt/nh/pk/c0/nhpkc0fdvu0mvclwj2okhsomowq.jpeg"></p><a name="habracut"></a><br><p>  Now let's talk a little about the architecture of the Ansible roles for the project. </p><br><p>  For installation and initial setup of each component of the environment a separate role is written.  Subsequent customization of the settings of each component of the environment is also highlighted in an additional role.  This allowed us to avoid duplication of common standard roles for other projects. </p><br><p>  A playbook with a sequence of executable roles for connecting a new node to the loop looks like this: </p><br><pre><code class="hljs pgsql">- hosts: - project_group <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: username become: yes gather_facts: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> roles: - rhel_install_new_server - rhel_install_java - rhel_install_haproxy - rhel_install_nginx - rhel_install_mysql</code> </pre> <br><p>  And now we will tell about each role in more detail. </p><br><h3 id="rol-rhel_install_new_server">  Rhel_install_new_server role </h3><br><p>  Performs general configuration of the operating system and installation of system utilities. </p><br><p>  The roles / rhel_install_new_server / tasks / main.yml file </p><br><pre> <code class="hljs dos">--- # tasks file <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rhel_install_new_server #     : - name: yum update yum: name: "*" state: latest update_cache: yes #  EPEL repository: - name: install EPEL repository yum: name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-<span class="hljs-number"><span class="hljs-number">7</span></span>.noarch.rpm state: present update_cache: yes #   .      tools_packages: - name: install tools yum: name: '{{ item.name }}' state: present update_cache: yes with_items: '{{ tools_packages }}' #       : - name: <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> autoload <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> default interface lineinfile: <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>: "/etc/sysconfig/network-scripts/ifcfg-{{ansible_default_ipv4.interface}}" regexp: '^ONBOOT=' line: 'ONBOOT="yes"' #  IPv6    : - name: disable IPv6 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eth0 <span class="hljs-built_in"><span class="hljs-built_in">replace</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>: "/etc/sysconfig/network-scripts/ifcfg-{{ansible_default_ipv4.interface}}" regexp: '^(IPV6.*=).*$' <span class="hljs-built_in"><span class="hljs-built_in">replace</span></span>: '\<span class="hljs-number"><span class="hljs-number">1</span></span>"no"' #  IPv6: - name: disable IPv6 blockinfile: <span class="hljs-built_in"><span class="hljs-built_in">path</span></span>: /etc/sysctl.d/disableipv6.conf create: yes marker: no block: | <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv6.conf.all.disable_ipv6 = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.ipv6.conf.default.disable_ipv6 = <span class="hljs-number"><span class="hljs-number">1</span></span> #  SELinux: - name: disable SELinux selinux: state: disabled #   firewall: - name: disable firewall systemd: name: firewalld enabled: no state: stopped ignore_errors: yes #   .      timezone: - name: <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> timezone to UTC timezone: name: '{{ timezone }}' #     : - name: <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> synchronize <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cron cron: name: "<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> synchronize <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> by ansible" minute: <span class="hljs-number"><span class="hljs-number">1</span></span> job: "/usr/sbin/ntpdate -u pool.ntp.org &gt;/dev/null <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span>" #   : - name: Remove old kernels shell: "rpm -q kernel | grep -v `uname -r` | grep -v `/sbin/grubby --default-kernel | sed -r 's#^/boot/vmlinuz-##'` | xargs rpm -e || true"</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">The file with variables roles / rhel_install_new_server / vars / main.yml</b> <div class="spoiler_text"><pre> <code class="hljs delphi">--- # vars <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rhel_install_new_server tools_packages: - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: vim - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: mc - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: less - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: sysstat - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: iotop - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: strace - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: traceroute - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: screen - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: rsync - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: curl - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: python - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: wget - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: zlib - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: unzip - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: bind-utils - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: ntp - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: ntpdate - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: telnet - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: nmap - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: tcpdump - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: logrotate - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: net-tools - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: bash-completion - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: yum-utils - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: mtr timezone: UTC</code> </pre></div></div><br><h3 id="rol-rhel_install_java--ustanovka-java">  Rhel_install_java role - install java </h3><br><p>  Our project uses the jdk package version 8u60.  Additionally, we previously downloaded and placed in the roles / rhel_install_java / files / folder the JCE files: US_export_policy.jar and local_policy.jar. </p><br><div class="spoiler">  <b class="spoiler_title">File with variables roles / rhel_install_java / vars / main.yml</b> <div class="spoiler_text"><pre> <code class="hljs mel">--- # vars <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> roles/rhel_install_java java_dst_path: <span class="hljs-string"><span class="hljs-string">"/opt/dst/java"</span></span> download_url: <span class="hljs-string"><span class="hljs-string">"http://download.oracle.com/otn/java/jdk/8u60-b27/jdk-8u60-linux-x64.rpm"</span></span> java_cookie: <span class="hljs-string"><span class="hljs-string">"Cookie:' gpw_e24=http%3A%2F%2Fwww.oracle.com%2F; oraclelicense=accept-securebackup-cookie'"</span></span></code> </pre> </div></div><br><p>  The roles / rhel_install_java / tasks / main.yml file </p><br><pre> <code class="hljs mel">--- # tasks <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> roles/rhel_install_java #    : - name: java | create java dst directory <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: path: <span class="hljs-string"><span class="hljs-string">"{{ java_dst_path }}"</span></span> state: directory recurse: yes owner: root <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: root mode: <span class="hljs-number"><span class="hljs-number">0755</span></span> #   jdk: - name: java | download java get_url: url: <span class="hljs-string"><span class="hljs-string">"{{ download_url }}"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"{{ java_dst_path }}"</span></span> tmp_dest: <span class="hljs-string"><span class="hljs-string">"{{ java_dst_path }}"</span></span> headers: <span class="hljs-string"><span class="hljs-string">"{{ java_cookie }}"</span></span> validate_certs: no owner: root <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: root mode: <span class="hljs-number"><span class="hljs-number">0744</span></span> force: yes ignore_errors: True #   jdk         : - name: java | register java rpm find: paths: <span class="hljs-string"><span class="hljs-string">"{{ java_dst_path }}"</span></span> patterns: <span class="hljs-string"><span class="hljs-string">"*.rpm"</span></span> register: java_rpm #   : - debug: msg={{ java_rpm.files<span class="hljs-number"><span class="hljs-number">.0</span></span>.path }} #   : - name: java | install java rpm yum: name: <span class="hljs-string"><span class="hljs-string">"{{ java_rpm.files.0.path }}"</span></span> state: present #  Java Cryptography Extension: - name: java | copy JCE copy: src: files/{{ item }} dest: /usr/java/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/jre/lib/security/ owner: root <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>: root mode: <span class="hljs-number"><span class="hljs-number">0644</span></span> backup: yes with_items: - US_export_policy.jar - local_policy.jar</code> </pre><br><h3 id="rol-rhel_install_haproxy---ustanovka-haproxy">  Rhel_install_haproxy role ‚Äî haproxy installation </h3><br><p>  The roles / rhel_install_haproxy / tasks / main.yml file </p><br><pre> <code class="hljs mel">--- # tasks <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> install_haproxy #    haproxy: - name: install the latest version of haproxy yum: name: haproxy state: latest #   rsyslog.conf: - name: backup rsyslog.conf copy: src: /etc/rsyslog.conf dest: /etc/rsyslog.conf_orig force: no remote_src: true #  udp  rsyslog: - name: <span class="hljs-keyword"><span class="hljs-keyword">format</span></span> rsyslog | set UDP options blockinfile: path: /etc/rsyslog.conf block: | $ModLoad imudp $UDPServerAddress <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> $UDPServerRun <span class="hljs-number"><span class="hljs-number">514</span></span> state: present insertafter: <span class="hljs-string"><span class="hljs-string">'^#\$UDPServerRun.*$'</span></span> notify: - restart rsyslog #    haproxy  rsyslog: - name: create rsyslog <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> haproxy blockinfile: path: /etc/rsyslog.d/haproxy.conf content: | <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $programname == <span class="hljs-string"><span class="hljs-string">'haproxy'</span></span> and $syslogseverity &lt;= <span class="hljs-string"><span class="hljs-string">'4'</span></span> then /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/haproxy/haproxy.out <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $programname == <span class="hljs-string"><span class="hljs-string">'haproxy'</span></span> and $syslogseverity &gt; <span class="hljs-string"><span class="hljs-string">'4'</span></span> then /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/haproxy/haproxy.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> &amp; stop state: present create: yes notify: - restart rsyslog #     logrotate: - name: backup logrotate <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> haproxy copy: src: /etc/logrotate.d/haproxy dest: /etc/logrotate.d/haproxy_orig force: no remote_src: true #     logrotate  haproxy: - name: copy logrotate <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> haproxy copy: src: files/logrotate_haproxy dest: /etc/logrotate.d/haproxy force: yes #      : - name: enable and start haproxy systemd: name: haproxy daemon_reload: yes enabled: yes state: started</code> </pre><br><p>  Rhel_install_haproxy / handlers / main.yml file </p><br><pre> <code class="hljs delphi">--- # handlers <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> install_haproxy - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: restart rsyslog systemd: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: rsyslog state: restarted - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: reload haproxy systemd: haproxy: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> state: reloaded</code> </pre> <br><h3 id="rol-rhel_install_nginx---ustanovka-nginx">  Role rhel_install_nginx - install nginx </h3><br><p>  File rhel_install_nginx / tasks / main.yml </p><br><pre> <code class="hljs objectivec">--- <span class="hljs-meta"><span class="hljs-meta"># tasks file for roles/rhel_install_nginx #    nginx: - name: add nginx repo yum_repository: name: nginx description: nginx official repo state: present baseurl: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"http://nginx.org/packages/rhel/{{ansible_distribution_major_version}}/{{ansible_userspace_architecture}}/"</span></span></span><span class="hljs-meta"> gpgkey: http://nginx.org/keys/nginx_signing.key gpgcheck: yes enabled: yes #  nginx: - name: install nginx yum: name: nginx state: present update_cache: yes #   : - name: create folders file: path: '/etc/nginx/{{ item }}' state: directory mode: 0755 with_items: - conf-available - sites-available - sites-enabled #  sites-enabled   nginx: - name: enable sites-enabled dir lineinfile: dest: /etc/nginx/nginx.conf state: present insertafter: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"(.*)include /etc/nginx/(.*)"</span></span></span><span class="hljs-meta"> line: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" include /etc/nginx/sites-enabled/*.conf;"</span></span></span><span class="hljs-meta"> #    default.conf: - name: stat /etc/nginx/conf.d/default.conf stat: path=/etc/nginx/conf.d/default.conf register: defaultconf_stat #  ,  : - name: Move default.conf command: mv /etc/nginx/conf.d/default.conf /etc/nginx/sites-available/default.conf when: defaultconf_stat.stat.exists #      : - name: enable and started nginx systemd: name: nginx.service enabled: yes state: started</span></span></code> </pre> <br><h3 id="rol-rhel_install_mysql--ustanovka-mysql">  Rhel_install_mysql role - installing mysql </h3><br><p>  Here it was necessary to suffer with primary authorization in mysql. </p><br><p>  The roles / rhel_install_mysql / vars / main.yml file </p><br><pre> <code class="hljs mel">--- # vars <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> roles/rhel_install_mysql mysql_repo_rpm: https:<span class="hljs-comment"><span class="hljs-comment">//dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm mysql_packets: - mysql-community-server - mysql-community-common - MySQL-python mysql_log: /var/log/mysqld.log</span></span></code> </pre> <br><p>  The roles / rhel_install_mysql / handlers / main.yml file </p><br><pre> <code class="hljs delphi">--- # handlers <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> roles/rhel_install_percona_mysql - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: restarted mysql systemd: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: mysqld state: restarted</code> </pre><br><p>  The roles / rhel_install_mysql / templates / root.cnf.j2 file </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">client</span></span>] user=root password={{ mysql_root_password }}</code> </pre><br><p>  The roles / rhel_install_mysql / tasks / main.yml file </p><br><pre> <code class="hljs kotlin">-- - # tasks file <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> roles/rhel_install_mysql #   yum: - name: install mysql repo yum: name: <span class="hljs-string"><span class="hljs-string">"{{ mysql_repo_rpm }}"</span></span> state: installed #   mysql: - name: install mysql yum: name: <span class="hljs-string"><span class="hljs-string">"{{ mysql_packets }}"</span></span> state: installed #  mysql     : - name: enable mysql systemd: daemon_reload: yes name: mysqld.service enabled: yes state: started #    mysql      ,        .        mysql_root_temp_password. - name: take <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> root password from mysql log file shell: &gt; awk -F<span class="hljs-string"><span class="hljs-string">': '</span></span> <span class="hljs-string"><span class="hljs-string">'$0 ~ "temporary password"{print $2}'</span></span> {{ mysql_log }} | tail -<span class="hljs-number"><span class="hljs-number">1</span></span> register: mysql_root_temp_password # ,      : - name: check mysql_root_temp_password debug: msg={{ mysql_root_temp_password.stdout }} <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: mysql_root_temp_password <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> defined #        : - name: Set temp root pass <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> root password set_fact: mysql_root_password: <span class="hljs-string"><span class="hljs-string">"{{ mysql_root_temp_password.stdout }}"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: mysql_root_temp_password <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> defined #      : - name: Copy the root credentials <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> .my.cnf file template: src: root.cnf.j2 dest: <span class="hljs-string"><span class="hljs-string">"~/.my.cnf"</span></span> mode: <span class="hljs-number"><span class="hljs-number">0600</span></span> # ,     : - name: register password expire shell: mysql --defaults-file=~/.my.cnf -e <span class="hljs-string"><span class="hljs-string">"SELECT NOW();"</span></span> register: password_expired ignore_errors: True - name: check password_expired debug: msg={{ password_expired.stdout }} <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: password_expired <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> defined # -       localhost: - name: ALTER USER <span class="hljs-symbol"><span class="hljs-symbol">root@</span></span>localhost shell: mysql --defaults-file=~/.my.cnf --connect-expired-password -e <span class="hljs-string"><span class="hljs-string">"ALTER USER root@localhost IDENTIFIED BY '{{ mysql_root_password }}';"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: password_expired.stdout.find(<span class="hljs-string"><span class="hljs-string">"expired"</span></span>) != -<span class="hljs-number"><span class="hljs-number">1</span></span> #        : - name: Update MySQL root password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> all root accounts mysql_user: name: root host: <span class="hljs-string"><span class="hljs-string">"{{ item }}"</span></span> password: <span class="hljs-string"><span class="hljs-string">"{{ mysql_root_password }}"</span></span> state: present priv: <span class="hljs-string"><span class="hljs-string">"*.*:ALL,GRANT"</span></span> with_items: - <span class="hljs-string"><span class="hljs-string">"{{ ansible_hostname }}"</span></span> - <span class="hljs-number"><span class="hljs-number">127.0</span></span>.0.1 - ::<span class="hljs-number"><span class="hljs-number">1</span></span> - localhost <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: mysql_root_temp_password <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> defined #   : - name: Ensure Anonymous user(s) are not <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the database mysql_user: name: <span class="hljs-string"><span class="hljs-string">''</span></span> host: <span class="hljs-string"><span class="hljs-string">"{{ item }}"</span></span> state: absent with_items: - localhost - <span class="hljs-string"><span class="hljs-string">"{{ ansible_hostname }}"</span></span> #    : - name: Remove the test database mysql_db: name: test state: absent</code> </pre><br><p>  At this stage, we received a ‚Äúclean‚Äù environment, the settings of which need to be customized for our project.  We do this with the additional project_configuration role. </p><br><h3 id="rol-project_configuration--kastomizaciya-okruzheniya">  The role of the project_configuration - customization environment </h3><br><p>  Before performing the role, check that all necessary components are installed in the system. </p><br><p>  File roles / project_configuration / tasks / main.yml </p><br><pre> <code class="hljs pgsql">######### <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> java - <span class="hljs-type"><span class="hljs-type">name</span></span>: register installed java shell: java -<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> args: warn: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> register: java_present failed_when: java_present.rc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> changed_when: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> tags: check_installed - <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>: msg: "{{ java_present.rc }}" tags: check_installed - fail: msg="Please install java first" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: java_present.rc == <span class="hljs-number"><span class="hljs-number">1</span></span> tags: check_installed ######### <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> haproxy - <span class="hljs-type"><span class="hljs-type">name</span></span>: register installed haproxy shell: rpm -q haproxy args: warn: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> register: haproxy_present failed_when: haproxy_present.rc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> changed_when: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> tags: check_installed - <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>: msg: "{{ haproxy_present.rc }}" tags: check_installed - fail: msg="Please install haproxy first" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: haproxy_present.rc == <span class="hljs-number"><span class="hljs-number">1</span></span> tags: check_installed - <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>: tasks/project_haproxy.yml <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: haproxy_present.rc == <span class="hljs-number"><span class="hljs-number">0</span></span> tags: check_installed ######### <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> nginx - <span class="hljs-type"><span class="hljs-type">name</span></span>: register installed nginx shell: rpm -q nginx args: warn: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> register: nginx_present failed_when: nginx_present.rc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> changed_when: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> tags: check_installed - <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>: msg: "{{ nginx_present.rc }}" tags: check_installed - fail: msg="Please install nginx first" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: nginx_present.rc == <span class="hljs-number"><span class="hljs-number">1</span></span> tags: check_installed - <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>: tasks/project_nginx.yml <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: nginx_present.rc == <span class="hljs-number"><span class="hljs-number">0</span></span> tags: check_installed ######### <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> mysql - <span class="hljs-type"><span class="hljs-type">name</span></span>: register installed mysql shell: rpm -q mysql57-community-<span class="hljs-keyword"><span class="hljs-keyword">release</span></span> args: warn: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> register: mysql_present failed_when: mysql_present.rc &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> changed_when: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> tags: check_installed - <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>: msg: "{{ mysql_present.rc }}" tags: check_installed - fail: msg="Please install mysql first" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: mysql_present.rc == <span class="hljs-number"><span class="hljs-number">1</span></span> tags: check_installed - <span class="hljs-keyword"><span class="hljs-keyword">include</span></span>: tasks/project_mysql.yml <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: mysql_present.rc == <span class="hljs-number"><span class="hljs-number">0</span></span> tags: check_installed</code> </pre> <br><p>  If checks are successful, the following files are connected: <br>  tasks / project_haproxy.yml <br>  tasks / project_nginx.yml <br>  tasks / project_mysql.yml </p><br><p>  In them we prescribe the installation of configuration files using templates, the installation of ssl certificates, the establishment of the necessary system users, the creation of databases, etc. </p><br><p>  As a result: after all the manipulations, we got a working environment for our application.  Now you can start the application deployment procedure, but this is a completely different story, which we will share in the next article. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348682/">https://habr.com/ru/post/348682/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348672/index.html">Blockchain on Go. Part 1: Prototype</a></li>
<li><a href="../348674/index.html">When work is your second family</a></li>
<li><a href="../348676/index.html">Cluster of Puppets: Amazon ECS Experience with iFunny</a></li>
<li><a href="../348678/index.html">IT events digest for February and March</a></li>
<li><a href="../348680/index.html">Learning to intercept unprocessed messages or an example of how SObjectizer is cluttered with new features ...</a></li>
<li><a href="../348684/index.html">BLE400 board and development for nRF51822</a></li>
<li><a href="../348686/index.html">Journal of the work with the network. Part 1</a></li>
<li><a href="../348688/index.html">Run a full-fledged cluster on Kubernetes from scratch on Ubuntu 16.04</a></li>
<li><a href="../348690/index.html">Five problems and trends in information security: what to expect in 2018</a></li>
<li><a href="../348692/index.html">Wireless network protection: WIPS. Part 1: Mojo AirTight</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>