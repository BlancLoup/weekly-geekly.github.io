<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mail server gateway</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, lucky enough to change jobs. Got to the company, which, in principle, deserves a separate article for a number of reasons and, perhap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mail server gateway</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, lucky enough to change jobs.  Got to the company, which, in principle, deserves a separate article for a number of reasons and, perhaps, will appear here later.  If it‚Äôs very brief on the structure of our department: it is not forbidden to do something other than your main activity, so my eyes fell on our mail server, which causes a lot of trouble. <br><br>  The company has remote affiliate branches evenly distributed throughout Western Europe using a single mail server.  Unfortunately, the budget of the IT department is not very large, and there are quite a lot of users (about 700 email accounts).  It was used, and is now used for Exchange 2010 mail with the latest updates and more or less customized spam filtering rules, but somehow it didn‚Äôt work with the antivirus.  The purchased solution refused to work normally, inflating the queue of incoming correspondence to indecent sizes and hanging tightly all mail.  (Yes, I know that all best practice speaks of the need for both the edge server and the backup server separately, but what happened at that time was.) <br><br>  We take the initiative in their hands.  Much to his surprise, it was not possible to find a detailed manual for solving such a problem, so there was an idea to share our trials and errors in the runet. <br><a name="habracut"></a><br>  From what was eventually tested and tested: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://www.zentyal.org/">Zentyal</a> , <a href="https://sourceforge.net/projects/assp/">ASSP</a> and <a href="http://www.xeams.com/">Xeams</a> . <br><br><div class="spoiler">  <b class="spoiler_title">I will not describe them in detail, but a few words should be said</b> <div class="spoiler_text">  Let's start in order.  Zentyal was dropped quickly enough, because the goal was not to change the entire Active Directory infrastructure and move to an open-source solution, and indeed, it‚Äôs rather a kind of combine from everything that is possible.  It seems to me that it would be great for SMB with up to 50 users. <br><br>  Let us turn to our second candidate.  Anti-Spam SMTP Proxy.  There is a whole set for proxying mail traffic, i.e.  and Bayesian spam filtering, and penalty points, black / white lists, and ClamAV and a whole lot more.  There is only one drawback: usability.  Those.  The ASSP web interface is a hell-wrapped configs that I personally find it easier to edit via the console.  This thing stayed with us for about 2 months in production, and then one of the admins changed something in the configs and wrap everything ... In general, we caught a .locky a couple of times and last time there was no actual backup, so the person left vacation, and when it came it was too late.  This made us revise our backup policy, but more about that another time.  Unfortunately, we don‚Äôt have a separate Linux administrator, because  almost all the infrastructure on Microsoft, so picking monstrous rewards through the web interface for admins was a real torture. <br></div></div><br><br>  After boosted and sampled several more products, I opted for Xeams.  Yes, unfortunately, this is <a href="http://www.xeams.com/xeamsopensource.htm"><b>not</b> OpenSource</a> , but a closed product, however, it is very friendly to those administrators who do not have much experience with Linux &amp; Dovecot &amp; Postfix &amp; etc bundles.  In addition, it is cross-platform, so there will be no problems even for those with linkus on you. <br><br>  It can work in three modes: <br>  <b>Stand alone server</b> - yes, xeams know how to be and just a mail server.  How good I can not say, because this function interested me last. <br>  <b>Spam firewall</b> - in this mode, xeams only accepts all mail traffic to itself and further distributes it to corporate mail servers. <br>  <b>Hybrid mode</b> - Hybrid mode.  Combines the other two, I recommend to put it, because it will not be able to fully filter spam without skipping outgoing traffic through itself. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/14c/633/9cc/14c6339ccc8d6ba545dde73b338a06b8.jpg" alt="Since we already had a mail server, we used the SMTP-Proxy option"><br>  <i>Since we already had a mail server, we used the SMTP-Proxy option</i> <br><br>  Installation was made on a clean machine with Ubuntu 14.04.  The only thing that needed to be delivered was Java, which, in fact, runs the Xeams engine. <br><br><pre><code class="bash hljs">sudo apt-get update &amp;&amp; upgrade sudo apt-get install libc6-i386 sudo update-alternatives --config java sudo apt-get install default-jre java -version</code> </pre> <br>  Xeams uses ClamAV, however, recommends putting it on a separate machine, but in the process of using it on one machine, no problems were noticed.  If you need to reconfigure the ClamAV settings later, this can also be done without problems. <br><br><pre> <code class="bash hljs">sudo apt-get install clamav-daemon</code> </pre><br><br>  We download archive with the installer <a href="http://www.xeams.com/XeamsDownload.htm">from here</a> .  We unpack, give rights and execute. <br><pre> <code class="bash hljs">wget http://www.xeams.com/files/XeamsLinux64.tar tar -xf ./XeamsLinux64.tar chmod +x ./Install.sh ./Install.sh</code> </pre><br><br>  If everything went well, the Web Interface will be available on port 5272. <br><br>  The main page contains reports, graphs and basic parameters of resource consumption.  We gave the car 8GB of RAM, the peak load several times reached 6, so these figures are quite justified. <br><br><img src="https://habrastorage.org/files/ef0/4ec/02d/ef04ec02dd88455990caa1bfba43bb70.PNG"><br><br>  Go to the setting itself.  On the Firewall, we wrap all traffic on port 25 on our Xeams IP on port 2525. This is done because Xeams not only receives, but also sends mail through it, so that incoming traffic comes to port 2525 and outgoing traffic to port 25. <br><br>  In general, setting up Xeams is simple and quite convenient.  To which moments all the same, I would like to draw attention: <br><br><div class="spoiler">  <b class="spoiler_title">Server Configuration&gt; Server Configuration&gt; Basic</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e46/513/7ab/e465137ab305436b87060262fb051f66.PNG"><br><br>  Specify the port for http / https web access. <br>  DNS, if specified in the settings of the machine itself, you can not specify <br>  And an address for daily reports. <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Server Configuration&gt; Server Configuration&gt; Advanced</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/fdc/90e/5f2/fdc90e5f20b249b098c7e9d595d352c6.PNG"><br><br>  On the Advanced tab, you must specify HELO (as a rule, you can simply copy from the settings of your existing mail server) in order not to get into SpamList yourself. <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Server Configuration&gt; SMTP Configuration&gt; Relaying</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/95d/228/4b5/95d2284b5d5d4177aa79ba3f174b43f9.PNG"><br><br>  Use only Closing relay and list the addresses and hosts from which you can send mail without authentication. <br>  From the Exchange side, it looks like this, where the smtp-relay address is filled in <br><br><img src="https://habrastorage.org/files/553/076/0a5/5530760a5f70477dbfdbebf5ceadcf6e.PNG"><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Server Configuration&gt; SMTP Proxy Server Configuration</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e99/c30/06c/e99c3006c11449dca03574e71d7c0a62.PNG"><br><br>  Everything is simple here, we specify the ports to which the mail is received, we indicate the forwarding address and port.  In our case, this is the address of the corporate Exchange. <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Greylisting</b> <div class="spoiler_text">  Separately, I would like to say about &lt;a <br><img src="https://habrastorage.org/files/2ec/30a/eae/2ec30aeae2ae4930b3842b00387b84ac.PNG"><br>  href = " <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25B5%25D1%2580%25D1%258B%25D0%25B9_%25D1%2581%25D0%25BF%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BA">en.wikipedia.org/wiki/%D0%A1%D0%B5%D1%80%D1%8B%D0%B9_%D1%81%D0%BF%D0%B8%D1%81% BE% D0% BA</a> ¬ª&gt; Greylisting </div></div>  .  I strongly recommend that you register there all the domains of the public mail and the white list, because the delay of the letter by 10 hours due to incorrect settings on the side of the sending mail server is, alas, not uncommon. <br><br><br><div class="spoiler">  <b class="spoiler_title">Server Configuration&gt; Active Directory Integration</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/6ce/54c/239/6ce54c23980c46bf857666ed2941641a.PNG"><br><br>  If you have raised Active Directory, then it can easily be integrated into Xeams.  What for?  At least so that users do not torture you at first, that they do not receive mail.  A user can easily log in and check his mailbox, view his spam and register his black / whitelist: <br><br><img src="https://habrastorage.org/files/712/fc7/4c1/712fc74c1d5b4c289aa0eb1925a82bbc.PNG"><br><br>  In addition, it provides the ability to use SMTP only to authenticated users.  In general, convenient. <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Clamav</b> <div class="spoiler_text">  If you, just like I installed ClamAV on the same server as Xeams, then the setup page will look something like this: <br><br><img src="https://habrastorage.org/files/2a3/28d/268/2a328d268d124a1d96096c77897413ee.PNG"><br><br>  Below I will talk about some of the nuances of its use. <br></div></div><br><br>  <b>Spamfilters</b> <br><br>  Xeams has a rather large set of spam filters: <br><br>  <a href="https://ru.wikipedia.org/wiki/DNSBL">Real-time Black-hole servers (RBL)</a> .  Each list can have its own significance points, on the basis of which, Xeams determines the reliability of the letter. <br><br>  Adaptive filters use <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B0%25D0%25B9%25D0%25B5%25D1%2581%25D0%25BE%25D0%25B2%25D1%2581%25D0%25BA%25D0%25B0%25D1%258F_%25D1%2584%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_%25D1%2581%25D0%25BF%25D0%25B0%25D0%25BC%25D0%25B0">Bayesian Analysis</a> , which copes well with the functions assigned to it.  There were concerns that it would work poorly, due to the large number of correspondence languages ‚Äã‚Äã(Russian, German, English, Spanish, Italian, Polish, Greek), however, the percentage of false positives is rather low. <br><br>  <b>Auto Learn Sender</b> .  Great thing, it is because of him that we pass all outgoing email traffic through Xeams, which analyzes the addresses of the recipients and takes them into account when making the final assessment of the reliability of the letter. <br><br>  The rest of the filters are standard and I do not think that they should be described in this article, which has already turned out to be bloated. <br><br>  Now I would like to give a few words to the not quite obvious nuances: <br>  After several days of use, we changed the default filter settings and glasses configuration: <br><br><div class="spoiler">  <b class="spoiler_title">Graduation of letters on points</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/9cc/f16/fb0/9ccf16fb050445c6a28cbb5f822ae210.PNG"></div></div><br>  and Bayesian Score raised to 115. <br>  The most common false triggering was the problem of correct encoding, since, nevertheless, Xeams is sharpened in English, decided to disable this setting. <br><br>  By default, ClamAV does NOT check for macro attachments in Ofiice documents, i.e.  newfangled .locky can safely pass <br>  You can fix it with one line: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'ScanOLE2 true'</span></span> &gt;&gt; /etc/clamav/clamd.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">If anyone is interested, here is the config that we use now.</b> <div class="spoiler_text"><pre> <code class="bash hljs">cat /etc/clamav/clamd.conf <span class="hljs-comment"><span class="hljs-comment">#Automatically Generated by clamav-base postinst #To reconfigure clamd run #dpkg-reconfigure clamav-base #Please read /usr/share/doc/clamav-base/README.Debian.gz for details TCPSocket 3310 # TemporaryDirectory is not set to its default /tmp here to make overriding # the default with environment variables TMPDIR/TMP/TEMP possible User clamav AllowSupplementaryGroups true ScanMail true ScanArchive true ArchiveBlockEncrypted false MaxDirectoryRecursion 15 FollowDirectorySymlinks false FollowFileSymlinks false ReadTimeout 180 MaxThreads 12 MaxConnectionQueueLength 15 LogSyslog true LogRotate true LogFacility LOG_LOCAL6 LogClean false LogVerbose false PidFile /var/run/clamav/clamd.pid DatabaseDirectory /var/lib/clamav SelfCheck 3600 Foreground false Debug false ScanPE true MaxEmbeddedPE 10M ScanOLE2 true ScanPDF true ScanHTML true MaxHTMLNormalize 10M MaxHTMLNoTags 2M MaxScriptNormalize 5M MaxZipTypeRcg 1M ScanSWF true DetectBrokenExecutables false ExitOnOOM false LeaveTemporaryFiles false AlgorithmicDetection true ScanELF true IdleTimeout 30 PhishingSignatures true PhishingScanURLs true PhishingAlwaysBlockSSLMismatch false PhishingAlwaysBlockCloak false PartitionIntersection false DetectPUA false ScanPartialMessages false HeuristicScanPrecedence false StructuredDataDetection false CommandReadTimeout 5 SendBufTimeout 200 MaxQueue 100 ExtendedDetectionInfo true OLE2BlockMacros false ScanOnAccess false AllowAllMatchScan true ForceToDisk false DisableCertCheck false DisableCache false MaxScanSize 100M MaxFileSize 25M MaxRecursion 10 MaxFiles 10000 MaxPartitions 50 MaxIconsPE 100 StatsEnabled false StatsPEDisabled true StatsHostID auto StatsTimeout 10 StreamMaxLength 25M LogFile /var/log/clamav/clamav.log LogTime true LogFileUnlock false LogFileMaxSize 0 Bytecode true BytecodeSecurity TrustSigned BytecodeTimeout 60000 OfficialDatabaseOnly false CrossFilesystems true OnAccessMaxFileSize 25M</span></span></code> </pre><br></div></div><br><br>  In general, two weeks after using and analyzing spam, possible spam, we can say that 98% of spam really does not pass. <br><br>  I will be glad to suggestions, comments and criticism in the comments. </div><p>Source: <a href="https://habr.com/ru/post/305746/">https://habr.com/ru/post/305746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305730/index.html">Analysis of obfuscated virus detection by mobile antivirus applications on the Android platform</a></li>
<li><a href="../305736/index.html">How we test interaction with Facebook</a></li>
<li><a href="../305738/index.html">What is big data, part 1</a></li>
<li><a href="../305740/index.html">Lepton Free Format Compresses JPEG Files by 22% Lossless</a></li>
<li><a href="../305742/index.html">Top performances by the WGDF</a></li>
<li><a href="../305748/index.html">Trust Principle in HTTPS</a></li>
<li><a href="../305750/index.html">F library for functional programming in Python</a></li>
<li><a href="../305752/index.html">Release of the integration platform Ensemble 2016.1</a></li>
<li><a href="../305754/index.html">Security Week 28: Pok√©mon Privacy, Critical Online Infrastructure, Post-Quantum Cryptography in Chrome</a></li>
<li><a href="../305756/index.html">Path to React</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>