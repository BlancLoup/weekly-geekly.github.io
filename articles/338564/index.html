<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Your own Python cover server for Internet radio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am a perfectionist who loves order in everything. Most of all I am pleased when things work exactly as they should work (in my, of course, understan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Your own Python cover server for Internet radio</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/ed6/ac4/c4f/ed6ac4c4fb3b4c4eb34788da1c1a59fb.jpg" alt="image"></div><br>  I am a perfectionist who loves order in everything.  Most of all I am pleased when things work exactly as they should work (in my, of course, understanding).  And I have long had my own personal Internet radio based on IceCast-KH + LiquidSoap.  And for many years I wasn‚Äôt allowed to sleep in peace the fact that streaming broadcasting servers do not know how to give the covers (artwork) of the tracks being played in the stream.  And not only in the stream - they can not do it at all.  I went to IceCast-KH (fork from IceCast2) only because of one of its uber-features - he can give mp3-tags inside the flv stream (this is needed to display the executable track when playing online on the site via a flash player).  And now it's time to close the last question - the release of the covers of the tracks being played - and calm down.  Since there were no ready-made solutions, I didn‚Äôt think of anything better than writing my own cover server for .mp3 files.  How?  Welcome under cat. <br><a name="habracut"></a><br><h3>  Prehistory </h3><br>  I usually listen to the radio in the car, on a 2-din tape recorder based on Android 4.4 KitKat (and at home on a tablet under the same Android).  To listen, after a long and thoughtful search of existing programs, XiiaLive was chosen, mainly because it knows how to use custom radio stations (such a banal, seemingly feature, but not supported by most streaming radio players - here‚Äôs the ShoutCast / Uber Stations catalog - choose and listen what they give), as well as for the fact that he can pump up and display the covers of the tracks being played.  Yes, of course, not all, but can.  The music played, the covers were partially shown and for some time the inner perfectionist calmed down, but as it turned out, not for long. <br><br>  After a while, an extremely unpleasant application bug related to incorrect processing of Unicode emerged - if the track name and artist were not in Latin, the album cover was displayed incorrectly.  Not only that - always the same.  And I will tell you even more - for some reason this has always been Nyusha.  This is what I could not tolerate. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/333/48e/0d2/33348e0d25aa466c8b12e936fbd9f7aa.jpg" alt="image"></div>  <i>Screenshot illustrating how XiiaLive encroached on the holy.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It would be possible to wait until the developers fix this <a href="http://support.xiialive.com/topics/1734-russian-titles-album-art/">bug</a> , but sensibly judging that they hardly have covers for everything that is in rotation exactly at my station (they definitely won't have covers for Ishome, Interior Disposition, tmtnsft and more than MŒ£ $ ‚Ä† ŒõMN Œ£KC√òNŒõ ‚Ä†), it seemed more correct to write my api for the covers.  Which will be able to work precisely on the local database of music files and, if possible, without being tied to a specific broadcast server. <br><br><h3>  Investigate the issue </h3><br>  It was not possible to find a description of the standard protocol for the return of the covers (I assume that there is no single standard at all), so I decided to go from the opposite - to see how this is done for big guys, in particular for the same XiiaLive.  Armed with <a href="https://play.google.com/store/apps/details%3Fid%3Dapp.greyshirts.sslcapture">Packet Capture</a> on Android, we catch packages and see where the application goes and why: <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /songart.php?partner_token=<span class="hljs-number"><span class="hljs-number">7144969234</span></span>&amp;title=Umbrella&amp;artist=The+Baseballs&amp;res=hi HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent: Dalvik/<span class="hljs-number"><span class="hljs-number">1.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> (Linux; U; Android <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; QuadCore-R16 Build/KVT49L) Host: api.dar.fm <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: Keep-Alive Accept-<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>: gzip HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>: Apache/<span class="hljs-number"><span class="hljs-number">2.2</span></span><span class="hljs-number"><span class="hljs-number">.15</span></span> (CentOS) X-Powered-<span class="hljs-keyword"><span class="hljs-keyword">By</span></span>: PHP/<span class="hljs-number"><span class="hljs-number">5.3</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-Cookie: PHPSESSID=u5sgs13h1315k9184nvvutaf33; expires=Fri, <span class="hljs-number"><span class="hljs-number">03</span></span>-Aug<span class="hljs-number"><span class="hljs-number">-2018</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> GMT; <span class="hljs-type"><span class="hljs-type">path</span></span>=/; <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span>=.dar.fm Expires: Thu, <span class="hljs-number"><span class="hljs-number">19</span></span> Nov <span class="hljs-number"><span class="hljs-number">1981</span></span> <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> GMT <span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span>-Control: no-store, no-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>, must-revalidate, post-check=<span class="hljs-number"><span class="hljs-number">0</span></span>, pre-<span class="hljs-keyword"><span class="hljs-keyword">check</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> Pragma: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> X-Train: wreck="mofas16" Content-Type: application/xml; charset=UTF<span class="hljs-number"><span class="hljs-number">-8</span></span> Content-Length: <span class="hljs-number"><span class="hljs-number">57</span></span> Accept-Ranges: bytes <span class="hljs-type"><span class="hljs-type">Date</span></span>: Thu, <span class="hljs-number"><span class="hljs-number">03</span></span> Aug <span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span> GMT Via: <span class="hljs-number"><span class="hljs-number">1.1</span></span> varnish Age: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: keep-alive X-Served-<span class="hljs-keyword"><span class="hljs-keyword">By</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>-ams4143-AMS X-<span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span>: MISS X-<span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span>-Hits: <span class="hljs-number"><span class="hljs-number">0</span></span> X-Timer: S1501785548<span class="hljs-number"><span class="hljs-number">.973935</span></span>,VS0,VE390</code> </pre> <br>  It turned out that a normal GET request with four variables is being sent: <br><br><ul><li>  partner_token - authorization token, when requested without it, or with the wrong token - 403 is returned. </li><li>  title - track title </li><li>  artist - artist name </li><li>  res - the desired resolution of the image.  A simple search gave the following set of issued permissions (square covers, so the resolution is described by one number): <br>  * hi - 1080 px <br>  * low - 250 px <br>  * in all other cases - 400 px <br></li></ul><br>  In response to a request, the application expects the following xml in response: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">songs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">song</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arturl</span></span></span><span class="hljs-tag">&gt;</span></span>http://coverartarchive.org/release/c8b16143-e87e-440d-bbb2-5c96615bed2b/2098621288-500.jpg <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">arturl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artist</span></span></span><span class="hljs-tag">&gt;</span></span>The Baseballs<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artist</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Tik Tok<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">album</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">album</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span>1080<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">song</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">songs</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  And the next request, the application is expected to go to the statics server behind the picture.  If the ‚ÄúArtist‚Äù + ‚ÄúTrack Name‚Äù combination didn‚Äôt find anything, then an empty xml is returned: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">songs</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">songs</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h3>  Design </h3><br>  Okay, the input and output parameters of the black box are defined, it remains to build the logic of its work.  And most importantly - decide where we will get the cover for the requested track. <br><br>  To make a separate database of cover images, somehow link it with the tracks, keep it up to date - I'm lazy.  Yes, and you should not multiply entities, create any extra bases and links, because the ID3v2 mp3 tags format supports storing covers in mp3 files for many years, so we‚Äôll go inside the file behind the cover (if it‚Äôs there, of course, there is).  And if the file is not found (or there is no cover in it), then instead of an empty xml, we'd rather give one of the default covers for the radio station, so that the user does not look in the empty square. <br><br>  In general, I prefer to script everything and do less work with my hands.  For example, how now adding a file to the rotation looks like: threw the file via ftp / scp into the inbox directory and forgot.  A minute later, the maintenance script arrived, found the file, renamed it as needed, and put it in the radio station directory.  And once every 10 minutes, LiquidSoap will reread the directory, find a new file and add it to the playlist.  A request for a cover will come - the script will find the file and extract the cover from it. <br><br><blockquote>  A good system administrator even automatically Sysadmin Day. <br>  By cron </blockquote><br>  The truth in the process of implementation and testing of the logic is somewhat complicated.  After all, there is often still a cover.jpg in the album catalog (for performers who are present in rotation in whole albums).  And there are still numerous performers from SoundCloud / PromoDJ and simply from vk who rarely collect tracks into albums, or even care about the issue of the cover for the track.  For these artists (there are not so many of them), we will create a separate directory on the static server with default covers by the artist‚Äôs name. <br><br>  Last question: how to find the corresponding requested tags file on the disk, given that at the time of the start of the search, we only have the name of the artist and the name of the track?  You can store information somewhere in the database using the keys ‚Äúartist, track -&gt; file on disk‚Äù, you can go through the files, look at them by comparing the mp3 tags with the query (but this is a long time), but you can simply follow the principle of not multiplying the entities store files on disk with names like "% artist% -% title% .mp3".  I have done just that.  Once for this, I used the best, in my opinion, for these purposes, the program <a href="https://www.xdlab.ru/">TagScanner</a> from Sergey Serkov, and then switched to a python script that automatically renames files in the desired format. <br><br>  The final logic of the work was as follows: <br><br><ul><li>  Received a GET request. </li><li>  If the request is empty (does not contain GET parameters) - returns empty XML </li><li>  If authorization by tokens is enabled (non-zero tokens list in the configuration file), the incoming token is checked.  If the token is invalid - 401 Unauthorized. </li><li>  If the request contains the variables artist and title, a search is performed in the local directory of mp3 files: </li><li>  If the file is not found, empty XML is returned. </li><li>  If the file is found, the sequence is as follows: </li><li>  Check if there is a ready-made cover for this file in the cover catalog?  If there is - give a link to it. </li><li>  If there is a cover in the file, we extract it to the catalog with covers, give the link. </li><li>  If in the catalog with the .mp3 file there is an album cover (file cover.jpg) - transfer it to the album cover catalog, give a link to it. </li><li>  If the catalog of artists has a cover with the name `artist` - we give a link to it. </li><li>  If nothing is found at all, we give a random picture from the catalog of default covers of the radio station. </li></ul><br>  And now, when the logic of work is defined, it remains only to formulate it in the form of functions. <br><br><h3>  Code </h3><br>  To extract covers from mp3 files, use the mutagen module.  The function that extracts covers from mp3 files and writes them in .jpg: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mutagen.mp3 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extract_cover</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(local_file, covers_dir, cover_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Extracts cover art from mp3 file :param local_file: file name (with path) :param covers_dir: path to store cover art files :param cover_name: name for extracted cover art file :rtype: bool :return: False - file not found or contains no cover art True - all ok, cover extracted """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: tags = mutagen.mp3.Open(local_file) data = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tags: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> i.startswith(<span class="hljs-string"><span class="hljs-string">"APIC"</span></span>): data = tags[i].data <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(covers_dir + cover_name, <span class="hljs-string"><span class="hljs-string">"w"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cover: cover.write(data) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: logging.error(<span class="hljs-string"><span class="hljs-string">'extract_cover: File \"%s\" not found in %s'</span></span>, local_file, covers_dir) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br>  If there is a cover in the file and we have successfully extracted it - we make a resize for the required dimensions while preserving the proportions of the picture (for standard square covers are not always in the file).  Python Imaging Library (PIL), which is also capable of antialias: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resize_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(image_file, new_size)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Resizes image keeping aspect ratio :param image_file: file name (with full path) :param new_size: new file max size :rtype bool :return: False - resize unsuccessful or file not found True - otherwise """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: img = Image.open(image_file) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> max(img.size) != new_size: k = float(new_size) / float(max(img.size)) new_img = img.resize(tuple([int(k * x) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> img.size]), Image.ANTIALIAS) img.close() new_img.save(image_file) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre> <br>  Despite the fact that almost all modern programs are able to customize the size of the cover to fit the screen size, I would highly recommend doing it yourself, on the server side. <br><br><blockquote>  In my practice, there was a case when a half of a 15 megabyte .mp3 file (7.62 mb) was occupied by a 3508x3508 cover with a non-standard color profile.  This file tightly hung TagScanner program, which I use to edit tags.  I do not know how much this file would be sent via 3G connection, and what would happen with Android when I tried to adjust it to the screen size. </blockquote><br>  Since XiiaLive has no settings for selecting the cover server, it was necessary to change the address of api.dar.fm to which it refers to its own.  On Android, it's simple: <br><br><pre> <code class="bash hljs">/etc/hosts &lt;my_api_ip&gt; api.dar.fm</code> </pre> <br>  And we explain to Nginx that all incoming requests, regardless of where they came from or what they want, are served by our script.  At the same time, we are raising a virtual host for statics, from where pictures will be given.  Of course, you can do everything within a single host, but still it is better to <s>fly</s> api separately, and <s>burgers</s> static - separately. <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> fcgiwrap_factory { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> unix:/run/fcgiwrap.socket; <span class="hljs-attribute"><span class="hljs-attribute">keepalive</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> api.&lt;yourserver&gt; api.dar.fm; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/wwws/&lt;yourserver&gt;/api; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx/api.access.log main; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/api.<span class="hljs-literal"><span class="hljs-literal">error</span></span>.log; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> <span class="hljs-variable"><span class="hljs-variable">$uri</span></span> /api.py?<span class="hljs-variable"><span class="hljs-variable">$args</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ api.py</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> fcgiwrap_factory; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/nginx/fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; } } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> static.&lt;yourserver&gt; root /var/wwws/&lt;yourserver&gt;/static; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx/static.access.log main; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/static.<span class="hljs-literal"><span class="hljs-literal">error</span></span>.log; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { } }</code> </pre><br>  After fixing bugs and finishing thin spots, everything worked.  Music plays, pictures are extracted from mp3 files and added to the host directory with statics for upload via the web.  In theory, after a while, all the covers will move from the depths of mp3 files to the static directory, but, firstly, the process of extracting the cover takes an average of 100 ms, and secondly, the place on the hosting is not rubber, so the pictures will that time is deleted by the simplest one-liner on the bash, which hangs itself in the crown and deletes files that were accessed more than a week ago: <br><br><pre> <code class="bash hljs">find /var/wwws/&lt;yourserver&gt;/static/covers/ -maxdepth 1 -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -iname <span class="hljs-string"><span class="hljs-string">'*.jpg'</span></span> -atime +7 -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> rm {} \;</code> </pre> <br>  Of course, for this to work, noatime should not be installed on the music section. <br><br><img src="https://habrastorage.org/web/be0/c6a/baa/be0c6abaadb14c44a141ca81d10e0450.jpg" alt="image"><br>  <i>Well, it all worked, as it should work.</i> <br><br><h3>  Revision </h3><br>  A week later, I analyzed the server logs and found something interesting: right after launch, the application sends a request of the form: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /songart.php?partner_token=<span class="hljs-number"><span class="hljs-number">7144969234</span></span>&amp;res=hi HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span>" 200 334 "-" "Dalvik/<span class="hljs-number"><span class="hljs-number">1.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> (Linux; U; Android <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; QuadCore-R16 Build/KVT49L)</code> </pre> <br>  And only some time later: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /songart.php?partner_token=<span class="hljs-number"><span class="hljs-number">7144969234</span></span>&amp;title=Summer+Nights&amp;artist=John+Travolta+<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>+Olivia+Newton-John&amp;res=hi HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span>" 200 334 "-" "Dalvik/<span class="hljs-number"><span class="hljs-number">1.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> (Linux; U; Android <span class="hljs-number"><span class="hljs-number">4.4</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; QuadCore-R16 Build/KVT49L)</code> </pre> <br>  Accordingly, there is no cover on the screen between these two requests, darkness and despondency. <br><br>  Disorder. <br><br>  The reason is clear: the application has not yet managed to extract tags from the stream and does not know what is playing, why not help it?  Add the first item to another condition in the logic of the program: <br><br><ul><li>  If a GET request comes with an authorization token, but without specifying the artist and track name, give the picture for the currently playing track.  If there is a variable stream - from the requested stream of broadcasting, otherwise - from the one that we consider the main one. </li></ul><br>  But where to get the name of the current track?  Do not get the same server logs.  It is very successful that Icecast can give the state of the mounted points in XML or JSON format.  JSON for Python is more native, so we will use it.  Since  in Icecast-KH, there are no such statistics out of the box, we will use the xsl file from the article by the respected <a href="https://habrahabr.ru/post/145694/">namikiri</a> , which is insensitively modified by me: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/XSL/Transform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">omit-xml-declaration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">doctype-public</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-//W3C//DTD XHTML 1.0 Strict//EN"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">doctype-system</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">indent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"no"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">encoding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">media-type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/json; charset=utf-8"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:strip-space</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">elements</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">match</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/icestats"</span></span></span><span class="hljs-tag">&gt;</span></span> { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:for-each</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"source"</span></span></span><span class="hljs-tag">&gt;</span></span> "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@mount"</span></span></span><span class="hljs-tag">/&gt;</span></span>": { "name" : "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"server_name"</span></span></span><span class="hljs-tag">/&gt;</span></span>", "listeners" : "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"listeners"</span></span></span><span class="hljs-tag">/&gt;</span></span>", "listener_peak" : "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"listener_peak"</span></span></span><span class="hljs-tag">/&gt;</span></span>", "description" : "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"server_description"</span></span></span><span class="hljs-tag">/&gt;</span></span>", "title" : "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"title"</span></span></span><span class="hljs-tag">/&gt;</span></span>", "genre" : "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"genre"</span></span></span><span class="hljs-tag">/&gt;</span></span>", "url" : "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:value-of</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"server_url"</span></span></span><span class="hljs-tag">/&gt;</span></span>" } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">test</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"position() != last()"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:text</span></span></span><span class="hljs-tag">&gt;</span></span>,<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:text</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:if</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:for-each</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:template</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">xsl:stylesheet</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  We put the file in the Icecast-kh web directory (on Ubuntu, the default is / usr / local / share / icecast / web /), and when accessing via http, we get something like this in reply: <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"/256"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Radio /256kbps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"listener_peak"</span></span> : <span class="hljs-string"><span class="hljs-string">"5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"mp3, 265kbit"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">"The Kelly Family - Fell In Love With An Alien"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"genre"</span></span> : <span class="hljs-string"><span class="hljs-string">"Various"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"/128"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Radio /128kbps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"listener_peak"</span></span> : <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"mp3, 128kbit"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">"The Kelly Family - Fell In Love With An Alien"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"genre"</span></span> : <span class="hljs-string"><span class="hljs-string">"Various"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"/64"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span> : <span class="hljs-string"><span class="hljs-string">"Radio /64kbps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"listener_peak"</span></span> : <span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span> : <span class="hljs-string"><span class="hljs-string">"mp3, 64kbit"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"title"</span></span> : <span class="hljs-string"><span class="hljs-string">"The Kelly Family - Fell In Love With An Alien"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"genre"</span></span> : <span class="hljs-string"><span class="hljs-string">"Various"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span> } }</code> </pre> <br>  As you can see, the radio has three mount points (in fact, some more) broadcasting the same stream, but with different quality.  Well, then everything is quite simple: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_now_playing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stats_url, stats_stream)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Retruns current playing song - artist and title :param stats_url: url points to icecast stats url (JSON format) :param stats_stream: main stream to get info :return: string "Artist - Title" """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: stats = json.loads(urllib2.urlopen(stats_url).read()) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: logging.error(<span class="hljs-string"><span class="hljs-string">'get_current_song: Can not open stats url \"%s\"'</span></span>, stats_url) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> stats_stream <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> stats: logging.error(<span class="hljs-string"><span class="hljs-string">'get_current_song: Can not find stream \"%s\" in stats data'</span></span>, stats_stream) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stats[stats_stream][<span class="hljs-string"><span class="hljs-string">'title'</span></span>].encode(<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>)</code> </pre> <br>  The function walks to the specified statistics address, and returns the artist and the title of the current composition from the desired stream.  The stream comes or in request, or default (from adjustments) undertakes. <br><br><h3>  Web </h3><br>  Now it's time to go to the site.  For online playback, I have long since used a free flash player from uppod in minimalist settings that looks into the / flv stream and displays the track being played when playing.  It looks like this: <br><br><img src="https://habrastorage.org/web/743/8ac/07f/7438ac07f5aa47d98eb8ce1bfd369387.jpg" alt="image"><br><br>  And to display the current track, when the player is minimized or inactive, I, like many others confronted with this problem, until recently used a pad in the form of a .php script on the server that went to Icecast for statistics and returned a string with the name of the track being played.  It‚Äôs time to get rid of intermediate steps, and I would like to show the covers on the site during online playback, since I now know how to give them away. <br><br>  The problem is solved in two steps: <br><br>  Add a custom header to the Nginx configuration for api that allows access to it via jQuery from another host: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Access-Control-Allow-Origin *;</code> </pre> <br>  And put in the body of the web page of the radio station such a script: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now_playing = <span class="hljs-string"><span class="hljs-string">''</span></span>; setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ jQuery.ajax( { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"http://api.&lt;yoursite&gt;/?partner_token=&lt;token&gt;&amp;stream=/&lt;stream&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">dataType</span></span>: <span class="hljs-string"><span class="hljs-string">"xml"</span></span>, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: xmlParser }) }, <span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xmlParser</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xml</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parsedXml = jQuery(xml); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> title = parsedXml.find(<span class="hljs-string"><span class="hljs-string">'title'</span></span>).text(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> artist = parsedXml.find(<span class="hljs-string"><span class="hljs-string">'artist'</span></span>).text(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arturl = parsedXml.find(<span class="hljs-string"><span class="hljs-string">'arturl'</span></span>).text(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> song = artist.concat(<span class="hljs-string"><span class="hljs-string">" ‚Äî "</span></span>).concat(title); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (now_playing !== song) { jQuery(<span class="hljs-string"><span class="hljs-string">'div.now_playing'</span></span>).html(song); jQuery(<span class="hljs-string"><span class="hljs-string">'div.cover_art'</span></span>).html(arturl); now_playing = song; } };</code> </pre> <br>  As you can see, once every five seconds, the script goes to the same place as the application, authorizes there, gets the .xml file and takes the played track and the link to the cover from it.  And if they have changed since the last check, then they are written in the necessary divs of the radio station‚Äôs web page for display.  Immediately I ask the gentlemen of the front-end developers not to swear at the possible clumsiness of the script - jQuery I see the first (well, well - the second), once in a lifetime.  The script may be unsightly, but it works great. <br><br><img src="https://habrastorage.org/webt/59/ca/61/59ca61dbc29b1416090768.jpeg" alt="image"><br>  <i>Under the player, another div has been added in which the covers dynamically change.</i> <br><br><h3>  Conclusion </h3><br>  At this all the tasks are solved.  Radio broadcasts as many years before, but now also displays the covers of the tracks being played and does it correctly.  The little perfectionist inside my head is sleeping, snoring contentedly and not distracting from work. <br><br>  I understand that the topic described is rather narrow-specific, and may be interesting to a small circle of people, but I think that my experience will still be useful to someone.  So the full texts of all the above code, plus examples of Nginx settings and a description of the installation, are available on <a href="https://github.com/adel-s/radio">GitHub</a> . <br><br>  All music! </div><p>Source: <a href="https://habr.com/ru/post/338564/">https://habr.com/ru/post/338564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338554/index.html">Visualization of election results in Moscow on a map in Jupyter Notebook</a></li>
<li><a href="../338556/index.html">Go: 10 years and grow further</a></li>
<li><a href="../338558/index.html">Reactive applications with Model-View-Intent. Part 2: View and Intent</a></li>
<li><a href="../338560/index.html">Who, how and why is going to regulate Big Data in Russia?</a></li>
<li><a href="../338562/index.html">20 years to Yandex. Lecture by Ilya Segalovich - the person who invented this word</a></li>
<li><a href="../338568/index.html">Creating the Google Maps API Maps Component with VueJs2</a></li>
<li><a href="../338572/index.html">Eggs Datacenter: how Emercoin allowed to implement the idea of ‚Äã‚Äãa distributed data center on the blockchain</a></li>
<li><a href="../338576/index.html">Facebook Messenger bug or feature - Poll</a></li>
<li><a href="../338578/index.html">Networks for the harshest. Part thirteen. MPLS Traffic Engineering</a></li>
<li><a href="../338580/index.html">How on animeshniki cryptocurrency mined</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>