<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Free Wi-Fi with a little twist</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article tells about a small project of a free Wi-Fi network, about the main technical problems and solutions. The goal is to simply tell about a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Free Wi-Fi with a little twist</h1><div class="post__text post__text-html js-mediator-article">  This article tells about a small project of a free Wi-Fi network, about the main technical problems and solutions.  The goal is to simply tell about a fairly original project. <br><br>  A little less than a year ago, my management decided to deploy a free Wi-Fi network for visitors on the organization‚Äôs territory.  Everything would be simple and prosaic if it were not for one interesting condition: before the user gets on the Internet, he should look at the information page, with our ‚Äúadvertisement‚Äù. <br><br>  After a brief analysis, we came to the conclusion that this can only be done with a separate gateway server, most likely on Linux.  A brief statement of work with a general description of the task distributed to companies involved in developing / implementing solutions at least close to this showed that when ordering an external solution, the cost of the project would skyrocket. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After much thought and fantasy on the topic: how to implement it (with immersion in the depths of the protocols, and dozens of erotic fantasies, how to replace packets, headers, etc.) a simple and logical solution was found. <br><a name="habracut"></a><br><h4>  Brilliant - just </h4><br><br>  Brief working principle: <br><ol><li>  A user connecting to the network gets an ip-address using a regular dhcp-server.  In the settings, our server is specified as the default gateway. </li><li> The server has the following default iptables rule set: <br><br> <code>[root@wifi ~]# iptables -L -t nat <br> Chain PREROUTING (policy ACCEPT) <br> target prot opt source destination <br> REDIRECT tcp -- anywhere !192.168.143.1 <br> DROP udp -- anywhere !192.168.143.1 udp dpt:!domain <br></code> <br>  Due to this, all requests (except for DNS packets) from the user are redirected to the local server. </li><li>  When a user first attempts to load any web page, he gets to the local nginx server where the html page containing the string is displayed to him: <br> <code>&lt;?php <br> $run = "ts /usr/share/nginx/html/script.sh {$_SERVER['REMOTE_ADDR']}"; <br> exec($run); <br> ?&gt; <br></code> <br></li><li>  And here begins the most interesting!  This page starts the script lying on the server (passing it the client's ip-address as the launch parameter): <br><br> <code>#!/bin/sh <br> LOG_FILE=/var/log/script_log <br> { <br> date | tr "\n" " " <br> echo -n '|IP:' <br> echo -n $1 <br> echo -n '|MAC:' <br> /sbin/arp $1 -n | grep $1 | tr -s ' ' | cut -d ' ' -f 3 | tr "\n" " " <br> mac=`/sbin/arp $1 -n | grep $1 | tr -s ' ' | cut -d ' ' -f 3 | tr "\n" " "` <br> if ( sudo /sbin/iptables -n -L -t nat --line-numbers | grep $1 &gt; /dev/null ) <br> then <br> echo '|Rule exists!!' <br> else <br> echo -n '|Add rule ' <br> sudo /sbin/iptables -t nat --insert PREROUTING -s $1 -j ACCEPT <br> echo -n '|Creat shedule:' <br> echo "sudo /sbin/iptables -t nat -D PREROUTING -s $1 -j ACCEPT " | at -m now + 45 minutes <br> sudo /usr/bin/python /usr/share/nginx/html/stat.py ${mac} <br> fi <br> } &gt;&gt; $LOG_FILE 2&gt;&amp;1 <br></code> <br><br>  Which makes two basic actions: adds a rule to iptables, and creates a deferred task in at. <br><br>  Rule: <br><br> <code>sudo /sbin/iptables -t nat --insert PREROUTING -s $1 -j ACCEPT</code> <br> <br>  It is placed in the PREROUTING chain to the first position, thereby being placed BEFORE the redirect rules.  As a result, the user with this address gets full access to the Internet. <br><br>  The second main action, creating a rule at at: <br> <code>echo "sudo /sbin/iptables -t nat -D PREROUTING -s $1 -j ACCEPT " | at -m now + 45</code> <br> <br>  In essence, it limits the user's session to 45 minutes, after which the rule will be deleted and the user will again be redirected. <br></li></ol><br><br>  The scheme was implemented, tested, and proved its viability. <br><br>  This would probably be worth finishing the story, but for ‚ÄúA little less than a year‚Äù, work was done to finalize the project, eliminate small jambs and add fairly original features. <br><br><h4>  Mentality </h4><br><br>  The first problem that arose was ‚Äúabusers‚Äù.  It was noticed that some particularly eager to freebies of a person use the network for an excessively long time.  To identify these, it was decided to keep statistics.  The main problem is that all billing systems (or simple modules for keeping statistics) consider the login or ip address to be the basic element.  In our case, the first is simply not there, but it is impossible to be attached to the second, since  ip-addresses are not static.  The necessary statistics was based on the mac- address.  After much research, no suitable solutions were found.  Therefore, it was decided to <s>invent another bike</s> to write his own.  Since it is essentially necessary and sufficient, it was necessary to count the number of sessions held by the mac-address by writing a simple script in python (unfortunately my knowledge of bash could not pull out this task): <br><br> <code>import sys <br> file = open('/var/log/stat.file','r') <br> line = file.readlines() <br> line2 = '' <br> i = 0 <br> while len(line) &gt; i : <br> line2 = str(line[i]) <br> line2 = line2.rstrip() <br> line2 = line2.split() <br> if line2[0] == str(sys.argv[1]) : <br> line2[1] = str(int(line2[1])+1 ) <br> del line[i] <br> line.insert(i,line2[0]+' '+line2[1]+'\n') <br> break <br> i = i + 1 <br> else : <br> line.append(str(sys.argv[1])+' '+'1'+'\n') <br> ########### <br> file.close() <br> file = open('/var/log/stat.file','w') <br> file.writelines(line) <br> file.close() <br></code> <br><br>  Which was called from the main script.  A section for this file with a weekly period has been added to logrotate.  And in two weeks I would receive a list of "regular customers" whose mac-addresses were blacklisted on the switch installed in front of the server. <br><br><h4>  Bicycles will not pass! </h4><br><br>  The following problem was more original: when simultaneously running several scripts, one of them produced an iptables error (something from the ‚Äúiptables: Unknown error 4294967295‚Äù series) without being executed.  If it was a script to create a rule, then nothing terrible happened - the user simply updated the page and the script that was re-run was working without errors (of course, if he didn‚Äôt hit the simultaneous launch again, judging by the logs, once one poor thing was not very lucky and he was 5 times hit the simultaneous launch). <br>  If the problem of deleting a rule took off with such an error, then the ip-address remained on the lists, and the user could sit on the Internet indefinitely and with impunity. <br><br>  The first temporary solution came in the form of a simple bash-script that compares the list of addresses in iptables and the task pool at: <br><br> <code>#!/bin/bash <br> LOG_FILE=/var/log/script_log <br> { <br> echo -n "Checking rules: " <br> date | tr "\n" " " <br> ar_ip=(`sudo iptables -L -t nat -n | grep ACCEPT | grep -v policy | cut -d ' ' -f 10 | tr '\n' ' '`) <br> ar_at=(`grep 168.143. /var/spool/at/* | cut -d ' ' -f 9 | tr '\n' ' '`) <br> count=${#ar_ip[@]} <br> for ((i=0; i &lt;= count ; i++ )) <br> do <br> for h in "${ar_at[@]}" <br> do <br> if [[ ${ar_ip[$i]} == $h ]] <br> then <br> unset ar_ip[$i] <br> continue 2 <br> fi <br> done <br> done <br> echo -n "|Delete rules: " <br> for i in ${!ar_ip[*]} <br> do <br> sudo /sbin/iptables -t nat -D PREROUTING -s ${ar_ip[$i]} -j ACCEPT <br> echo -n ${ar_ip[$i]} " " <br> done <br> echo "|Checking done" <br> } &gt;&gt; $LOG_FILE 2&gt;&amp;1 <br></code> <br><br>  The script was placed in /etc/cron.hourly, and regularly removed the consequences of iptables errors. In principle, the solution was sufficient, but ‚Äúthere is no limit to perfection‚Äù and I began to surf the endless expanses in search of a better solution.  And it was found.  On one of the ‚Äúcozy‚Äù linux forums, one of the mastodons pointed me towards this project. <br><br><br><br>  In essence, this project is a small development for running bash scripts, putting them into a pool and performing in a strict sequence, one by one. <br>  The script launch line on the web page has been modified to <br><br> <code>ts /usr/share/nginx/html/script.sh {$_SERVER['REMOTE_ADDR']}</code> <br> <br>  And iptables errors disappeared. <br><br><h4>  Problem three, or how I helped the open-source community </h4><br><br>  When the project was already working for about half a year, and people had already learned enough about it, another serious problem appeared: access points (Lynksys wap54g) began to spontaneously turn off / hang / reboot.  Naturally the first thing that came to mind is to look at the logs.  As it turned out, Lynksys are not in vain attributed to the "home" segment, because housewives read logs to nothing.  The only thing that was contained in the logs is when a mac-address is connected.  In addition, the log format was unique and the usual syslog server did not understand it.  As always, Lynksys offered some kind of suspicious utility containing something magical in its name, supposedly capable of setting up your home network in an instant and instantly.  After a brief study of the utility, it was concluded that it was unsuitable, and the long journey across the endless expanses began again.  <s>Somewhere in the endless steppes.</s> On sf.net, a small project bent in 2009 was found (http://sourceforge.net/projects/wap54g-log/) which understood the format of the logs of points and was able to add them to a file.  ‚ÄúAnd we don‚Äôt need more!‚Äù ¬© <br><br>  It turned out that early rejoiced.  The log entry was: <br><br> <code>May 20 12:04:42 /usr/local/bin/wap54g-log[17544] Wireless PC connected 00:26:C7:61:BB:26</code> <br> <br>  And it was impossible to understand which of the points the client connected to.  And consequently, to make a conclusion about the load, as one and the most possible causes of unworthy behavior of points. <br>  And then I had to remember S. As it turned out, not to recall, but to study anew, because  what was written in the second year at the institute in Visual Studio only remotely resembled the code of this small utility. <br><br>  After a thoughtful reading, the structure of theiraddr was found, referring to the sockaddr _in type (the standard for unix socket type) which contains another in_addr structure which contains a single s_addr variable of the in_addr_t type.  ‚ÄúEgg in a duck, duck in a hare, hare in shock‚Äù ¬©.  The most fun was the comment "The fact that such a structure is used, and not just a variable of type in_addr_t, has developed historically." <br><br>  Going deeper and deeper, the library &lt;arpa / inet.h&gt; (Oh, God! Ghost arpa!) Was found containing functions for working with these structures.  By converting the function inet_ntoa (strcu) and putting it all into the output of the utility, it turned out something like this: <br><br> <code>May 20 12:23:38 192.168.143.114 /usr/local/bin/wap54g-log[17544] Wireless PC connected 00:26:C7:61:BB:26</code> <br> <br>  The key difference is the availability of the address point.  Those.  Now you can judge the distribution of load points. <br>  As it turned out intuition / logic / 5th point, I did not let me down.  And after small observations, it turned out that the Wap54g does not even support 30 simultaneously connected users. <br><br>  This problem has yet to be resolved.  So far, there are no options other than replacing points with something more ‚Äúindustrial‚Äù.  The management decides what to do, and a letter was sent to the developer of the utility with thanks and suggestions for improvement. <br><br>  There were also smaller problems: nginx produced 404 pages, if the address from which the redirect occurred, contained the name of the page and a get request in the address bar.  It was solved in one line in the virtual server configuration ‚Äúrewrite ^ / (. *) /Index.php last;‚Äù.  But you should not talk about such trifles here.  they are all banal and everyday. <br><br><h4>  Instead of conclusion </h4><br><br>  The final decision on writing this article was confirmed after reading a couple of articles "How to become a system administrator - a guide for beginners."  I do not consider myself to be any kind of guru, I soberly understand that I am a system administrator of the middling linux-orientation.  This article shows only a small part of the amount of knowledge that is necessary for everyday work.  Just html, bash, python, and a little knowledge of C. Well, as a mandatory base: knowledge of the theory (all of IT, from networks to programming), and the OS (utilities, system applications) with which you basically have to work.  I think this will be a good addition. </div><p>Source: <a href="https://habr.com/ru/post/119695/">https://habr.com/ru/post/119695/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119689/index.html">We pay mobile via Bitcoin</a></li>
<li><a href="../119691/index.html">The developers have created a compact system of a pulse oximeter and a mobile phone to quickly obtain patient vital signs.</a></li>
<li><a href="../119692/index.html">Distributed computing on JavaScript: Today</a></li>
<li><a href="../119693/index.html">Build open-source libraries on Android NDK</a></li>
<li><a href="../119694/index.html">Typed Arrays</a></li>
<li><a href="../119696/index.html">Likester. Facebook Trends</a></li>
<li><a href="../119697/index.html">Creating a simple 3D application with ShiVa3D</a></li>
<li><a href="../119699/index.html">Tron lightcycle: Tron style PC modding</a></li>
<li><a href="../119700/index.html">LW cryptography: ciphers for RFID systems</a></li>
<li><a href="../119703/index.html">MongoDB features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>