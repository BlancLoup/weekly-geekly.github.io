<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[SC] We work with the scanner</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For the past few years, my colleagues and I have been trying to make less paper in the office. Employees work with digital documents faster and with b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[SC] We work with the scanner</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/172/6bf/530/1726bf53071049c696f50f9229b6a91f.jpg"></div><br>  For the past few years, my colleagues and I have been trying to make less paper in the office.  Employees work with digital documents faster and with better quality - and the dust is several times smaller. <br><br>  To fully switch to digital documents, you first need to scan paper documents.  We use the <i>.NET Framework</i> to develop desktop scanner applications.  Out of the box, he does not provide the means to work with scanners.  Since <i>.NET</i> is friendly with <i>COM</i> , you can use the <i>WIA</i> component <i>(Windows Imaging Architecture)</i> . <br><a name="habracut"></a><br>  For easy work with <i>WIA,</i> I wrote a class that formed the basis of many scanning applications.  I want to share our experience with scanners using the example of the <i>Scanner</i> class. <br><br>  It is used in several very useful applications of our bank.  For example, all applications and contracts of bank customers are digitized by applications using the <i>Scanner</i> class. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/afa/ec9/797/afaec97974564349bb7cd1da7e425430.jpg"></div><br>  so: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/886/e90/05c/886e9005c79f45bb8a111edc3c3ba7bb.jpg"></div><br><h3>  Not everything is simple ingenious. </h3><br>  To start working with a scanner from a developed application, you must first select it, then configure it, and then you can scan.  Therefore, the <i>public</i> class interface can be limited to two methods - <i>Configuration</i> and <i>Scan</i> . <br><br>  <i>Configuration</i> will display the standard scanner setup dialog.  <i>Scan</i> will scan the document and return a <i>MemoryStream</i> with a picture. <br><br><h3>  Now in detail ... </h3><br>  We will work with the scanner through <i>WIA</i> .  To do this, we connect the <i>Microsoft Windows Image Acquisition Library v2.0</i> component to the <i>COM</i> project, the implementation of which is located in the file <i>C: \ Windows \ System32 \ wiaaut.dll</i> . <br><br>  It‚Äôs customary to set up the scanner once and to have an already configured scanner at the next application load.  We will need functions to configure the scanner and to save and restore the configuration.  Create a <i>Scanner</i> class and add <i>using WIA</i> at the beginning of the file.  When creating an object of the <i>Scanner</i> class, we try to load the settings from the config.  If it does not work out, we suggest setting up the scanner manually. <br><br>  Usually one program works with one scanner, so a singleton could be made.  In my case there may be several scanners at the same time. <br>  Here is what our constructor will look like: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scanner</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LoadConfig(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { MessageBox.Show(<span class="hljs-string"><span class="hljs-string">" ,    "</span></span>); Configuration(); } }</code> </pre> <br>  What does the <i>MessageBox</i> do here?  In most cases, scanning applications involve a <i>GUI</i> .  To display information, it is quite possible to show the message via <i>MessageBox</i> , the more we will configure the scanner through the standard <i>WIA</i> dialog. <br><br>  Let's start with the scanner settings.  The scanner will be configured by the <i>Configuration ()</i> function, which can be called at any convenient time, for example, by pressing the "Scanner Setup" button in the program. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commonDialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommonDialogClass(); _scanDevice = commonDialog.ShowSelectDevice(WiaDeviceType.ScannerDeviceType, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_scanDevice == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = commonDialog.ShowSelectItems(_scanDevice); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items.Count &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; _scannerItem = items[<span class="hljs-number"><span class="hljs-number">1</span></span>]; SaveProp(_scanDevice.Properties, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _defaultDeviceProp); SaveConfig(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { MessageBox.Show(e.Message, <span class="hljs-string"><span class="hljs-string">"   "</span></span>); } }</code> </pre><br>  The scanner has many parameters, some of which must be calculated from the others, therefore, in order not to complicate things, we used the standard WIA-dialog <i>CommonDialogClass</i> for setting.  First, we suggest that the user of the program select the <i>ShowSelectDevice</i> scanner <i>(WiaDeviceType. ScannerDeviceType, true)</i> .  The dialog will return a <i>Device</i> object or <i>null</i> if no device is selected. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1d2/982/0d1/1d29820d17ce4ccd86c980bb5837be40.jpg"></div><br>  Then we set up the resulting <i>ShowSelectItems</i> device <i>(_scanDevice)</i> .  In the settings you can set the <i>DPI</i> , paper size, color mode and other parameters. <br><br>  The main drawback of this configuration window is that in order to confirm instead of the logical <i>OK</i> , you will have to click on the ‚ÄúScan‚Äù button, although in our case scanning will not be launched. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/50b/1f8/2af/50b1f82af7324480846568871ec76c57.jpg"></div><br>  After successful setup, save the configuration to a file by calling <i>SaveConfig ()</i> . <br><br>  <i>WIA</i> does not provide any save / restore settings.  I had to do this part on my own.  There was nothing complicated here, the settings are presented as a list of <i>IProperty</i> , which <i>Device</i> and <i>Item have</i> . <br><br>  To save, we chose a readable text format in which the name of the parameters, identifiers and values ‚Äã‚Äãare separated by a semicolon, and the settings for <i>Device</i> and <i>Item are</i> separated by the headers <i>[device]</i> and <i>[item]</i> . <br><br><div class="spoiler">  <b class="spoiler_title">Config example</b> <div class="spoiler_text"> <code>[device] <br> DeviceID;{6BDD1FC6-810F-11D0-BEC7-08002BE2092F}\0003 <br> Item Name;4098;Root <br> Full Item Name;4099;0003\Root <br> Item Flags;4101;76 <br> Unique Device ID;2;{6BDD1FC6-810F-11D0-BEC7-08002BE2092F}\0003 <br> Manufacturer;3;FUJITSU <br> Description;4;fi-6140dj <br> Type;5;65537 <br> Port;6;\\.\Usbscan0 <br> Name;7;fi-6140dj #2 <br> Server;8;local <br> Remote Device ID;9; <br> UI Class ID;10;{C2A237CB-9CEF-4fd6-B989-E82E1DB0F0C9} <br> Hardware Configuration;11;0 <br> BaudRate;12; <br> STI Generic Capabilities;13;51 <br> WIA Version;14;2.0 <br> Driver Version;15;2.1.4.3 <br> PnP ID String;16;\\?\usb#vid_04c5&amp;pid_114d#8&amp;184ab430&amp;0&amp;2#{6bdd1fc6-810f-11d0-bec7-08002be2092f} <br> STI Driver Version;17;2 <br> Horizontal Bed Size;3074;8500 <br> Vertical Bed Size;3075;11692 <br> Access Rights;4102;3 <br> Horizontal Optical Resolution;3090;600 <br> Vertical Optical Resolution;3091;600 <br> Firmware Version;1026;0500 <br> Max Scan Time;3095;180000 <br> Preview;3100;0 <br> Show preview control;3103;1 <br> Horizontal Sheet Feed Size;3076;8500 <br> Vertical Sheet Feed Size;3077;14000 <br> Document Handling Capabilities;3086;21 <br> Document Handling Status;3087;5 <br> Document Handling Select;3088;1 <br> Pages;3096;1 <br> Sheet Feeder Registration;3078;1 <br> Horizontal Bed Registration;3079;0 <br> Vertical Bed Registration;3080;0 <br> Document Handling Option;38914;0 <br> [item] <br> ItemID;0003\Root\Top <br> Item Name;4098;Top <br> Full Item Name;4099;0003\Root\Top <br> Item Flags;4101;67 <br> Color Profile Name;4120;sRGB Color Space Profile.icm <br> Horizontal Resolution;6147;200 <br> Vertical Resolution;6148;200 <br> Horizontal Extent;6151;1653 <br> Vertical Extent;6152;2338 <br> Horizontal Start Position;6149;23 <br> Vertical Start Position;6150;0 <br> Data Type;4103;2 <br> Bits Per Pixel;4104;8 <br> Brightness;6154;0 <br> Contrast;6155;0 <br> Current Intent;6146;0 <br> Pixels Per Line;4112;1653 <br> Number of Lines;4114;2338 <br> Preferred Format;4105;{B96B3CAA-0728-11D3-9D7B-0000F81EF32E} <br> Item Size;4116;3872792 <br> Threshold;6159;128 <br> Format;4106;{B96B3CAA-0728-11D3-9D7B-0000F81EF32E} <br> Media Type;4108;128 <br> Channels Per Pixel;4109;1 <br> Bits Per Channel;4110;8 <br> Planar;4111;0 <br> Bytes Per Line;4113;1656 <br> Buffer Size;4118;65535 <br> Access Rights;4102;3 <br> Compression;4107;0 <br> Photometric Interpretation;6153;0 <br> Lamp Warm up Time;6161;180000 <br> 3100;3100;0 <br></code> <br></div></div><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); settings.Add(<span class="hljs-string"><span class="hljs-string">"[device]"</span></span>); settings.Add(String.Format(<span class="hljs-string"><span class="hljs-string">"DeviceID;{0}"</span></span>, _scanDevice.DeviceID)); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (IProperty property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _scanDevice.Properties) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propstring = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{1}{0}{2}{0}{3}"</span></span>, <span class="hljs-string"><span class="hljs-string">";"</span></span>, property.Name, property.PropertyID, property.get_Value()); settings.Add(propstring); } settings.Add(<span class="hljs-string"><span class="hljs-string">"[item]"</span></span>); settings.Add(String.Format(<span class="hljs-string"><span class="hljs-string">"ItemID;{0}"</span></span>, _scannerItem.ItemID)); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (IProperty property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _scannerItem.Properties) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propstring = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{1}{0}{2}{0}{3}"</span></span>, <span class="hljs-string"><span class="hljs-string">";"</span></span>, property.Name, property.PropertyID, property.get_Value()); settings.Add(propstring); } File.WriteAllLines(Config, settings.ToArray()); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> loadMode {undef, device, item}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> settings = File.ReadAllLines(Config); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mode = loadMode.undef; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> setting <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> settings) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setting.StartsWith(<span class="hljs-string"><span class="hljs-string">"[device]"</span></span>)) { mode = loadMode.device; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setting.StartsWith(<span class="hljs-string"><span class="hljs-string">"[item]"</span></span>)) { mode = loadMode.item; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setting.StartsWith(<span class="hljs-string"><span class="hljs-string">"DeviceID"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deviceid = setting.Split(<span class="hljs-string"><span class="hljs-string">';'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> devMngr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeviceManagerClass(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (IDeviceInfo deviceInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> devMngr.DeviceInfos) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deviceInfo.DeviceID == deviceid) { _scanDevice = deviceInfo.Connect(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_scanDevice == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"    "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } _scannerItem = _scanDevice.Items[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setting.StartsWith(<span class="hljs-string"><span class="hljs-string">"ItemID"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> itemid = setting.Split(<span class="hljs-string"><span class="hljs-string">';'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sett = setting.Split(<span class="hljs-string"><span class="hljs-string">';'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (mode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> loadMode.device: SetProp(_scanDevice.Properties, sett[<span class="hljs-number"><span class="hljs-number">1</span></span>], sett[<span class="hljs-number"><span class="hljs-number">2</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> loadMode.item: SetProp(_scannerItem.Properties, sett[<span class="hljs-number"><span class="hljs-number">1</span></span>], sett[<span class="hljs-number"><span class="hljs-number">2</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } SaveProp(_scanDevice.Properties, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _defaultDeviceProp); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetProp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProperties prop, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> property, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { prop[property].set_Value(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-comment"><span class="hljs-comment">//       return; } }</span></span></code> </pre><br>  The scanning procedure is trivial.  It returns either a <i>MemoryStream</i> with a picture, or <i>null</i> if the scan failed. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MemoryStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MemScan</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = _scannerItem.Transfer(FormatID.wiaFormatJPEG); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wiaImage = (ImageFile)result; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imageBytes = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[])wiaImage.FileData.get_BinaryData(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ms = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(imageBytes)) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bitmap = Bitmap.FromStream(ms)) { bitmap.Save(stream, ImageFormat.Jpeg); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stream; }</code> </pre><br>  In my opinion, when scanning, it is more convenient to draw your progress bar, so we hide the standard progress.  For scanning without progress display, the <i>Transfer</i> method is used. <br><br><h3>  Duplex / Simplex </h3><br>  Many long-distance scanners support the double-page scan mode, which can be selected through the settings dialog. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/03d/9ca/e19/03d9cae19b594e0a831e88068dc47157.jpg"></div><br>  However, in the standard dialog, you can forget to set the <i>Duplex</i> mode, so it is useful to be able to forcefully turn on the <i>Duplex</i> mode and return to the original settings. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDuplexMode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isDuplex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// WIA property ID constants const string wiaDpsDocumentHandlingSelect = "3088"; const string wiaDpsPages = "3096"; // WIA_DPS_DOCUMENT_HANDLING_SELECT flags const int feeder = 0x001; const int duplex = 0x004; if (_scanDevice == null) return; if (isDuplex) { SetProp(_scanDevice.Properties, wiaDpsDocumentHandlingSelect, (duplex | feeder)); SetProp(_scanDevice.Properties, wiaDpsPages, 1); } else { try { SetProp(_scanDevice.Properties, wiaDpsDocumentHandlingSelect, _defaultDeviceProp[wiaDpsDocumentHandlingSelect]); SetProp(_scanDevice.Properties, wiaDpsPages, _defaultDeviceProp[wiaDpsPages]); } catch (Exception e) { MessageBox.Show(String.Format("   :{0}{1}", Environment.NewLine, e.Message)); } } }</span></span></code> </pre><br>  To scan in double-page mode, you need to call <i>MemScan ()</i> for the first and second pages.  The first call will scan the sheet and return the image of the first page, the second call will return the scan of the second page.  When working with feeder scanners, it is convenient to scan in a loop while <i>MemScan ()</i> returns! = <i>Null</i> - this often means that the scanner is out of paper.  You can not think in which mode the scanner works - the documents will be scanned in any case.  If you run a scan in a loop for the cracker scanner, the scanning process will not stop while the scanner is connected to an outlet; this nuance should be taken into account when developing software. <br><br><div class="spoiler">  <b class="spoiler_title">Full class source code for working with a scanner</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Drawing; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Drawing.Imaging; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Forms; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> WIA; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Scanning</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Scanner</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Config = <span class="hljs-string"><span class="hljs-string">"scanner.cfg"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Device _scanDevice; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Item _scannerItem; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Random _rnd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; _defaultDeviceProp; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsVirtual; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Scanner</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LoadConfig(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { MessageBox.Show(<span class="hljs-string"><span class="hljs-string">" ,    "</span></span>); Configuration(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commonDialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommonDialogClass(); _scanDevice = commonDialog.ShowSelectDevice(WiaDeviceType.ScannerDeviceType, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_scanDevice == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = commonDialog.ShowSelectItems(_scanDevice); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items.Count &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; _scannerItem = items[<span class="hljs-number"><span class="hljs-number">1</span></span>]; SaveProp(_scanDevice.Properties, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _defaultDeviceProp); SaveConfig(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { MessageBox.Show(e.Message, <span class="hljs-string"><span class="hljs-string">"   "</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveProp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">WIA.Properties props, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Dictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; dic</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dic == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) dic = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Property property <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> props) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propId = property.PropertyID.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propValue = property.get_Value(); dic[propId] = propValue; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDuplexMode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isDuplex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// WIA property ID constants const string wiaDpsDocumentHandlingSelect = "3088"; const string wiaDpsPages = "3096"; // WIA_DPS_DOCUMENT_HANDLING_SELECT flags const int feeder = 0x001; const int duplex = 0x004; if (_scanDevice == null) return; if (isDuplex) { SetProp(_scanDevice.Properties, wiaDpsDocumentHandlingSelect, (duplex | feeder)); SetProp(_scanDevice.Properties, wiaDpsPages, 1); } else { try { SetProp(_scanDevice.Properties, wiaDpsDocumentHandlingSelect, _defaultDeviceProp[wiaDpsDocumentHandlingSelect]); SetProp(_scanDevice.Properties, wiaDpsPages, _defaultDeviceProp[wiaDpsPages]); } catch (Exception e) { MessageBox.Show(String.Format("   :{0}{1}", Environment.NewLine, e.Message)); } } } public MemoryStream MemScan() { if ((_scannerItem == null) &amp;&amp; (!IsVirtual)) { MessageBox.Show("  ,   !", "Info"); //return null; IsVirtual = true; } var stream = new MemoryStream(); if (IsVirtual) { if (_rnd.Next(3) == 0) { return null; } var btm = GetVirtualScan(); btm.Save(stream, ImageFormat.Jpeg); return stream; } try { var result = _scannerItem.Transfer(FormatID.wiaFormatJPEG); var wiaImage = (ImageFile)result; var imageBytes = (byte[])wiaImage.FileData.get_BinaryData(); using (var ms = new MemoryStream(imageBytes)) { using (var bitmap = Bitmap.FromStream(ms)) { bitmap.Save(stream, ImageFormat.Jpeg); } } } catch (Exception) { return null; } return stream; } private Bitmap GetVirtualScan() { const int imgSize = 777; var defBtm = new Bitmap(imgSize, imgSize); var g = Graphics.FromImage(defBtm); var r = new Random(); g.FillRectangle(new SolidBrush(Color.FromArgb(r.Next(0, 50), r.Next(0, 50), r.Next(0, 50))), 0, 0, imgSize, imgSize); // bg for (int i = 0; i &lt; r.Next(1000, 3000); i++) { var den = r.Next(200, 255); var br = new SolidBrush(Color.FromArgb(den, den, den)); den -= 100; var pr = new Pen(Color.FromArgb(den, den, den), 1); var size = r.Next(1, 8); var x = r.Next(0, imgSize - size); var y = r.Next(0, imgSize - size); g.FillEllipse(br, x, y, size, size); g.DrawEllipse(pr, x, y, size, size); } g.DrawString(" ", new Font(FontFamily.GenericSerif, 25), Brushes.Aqua, new RectangleF(0, 0, imgSize, imgSize)); g.Flush(); return defBtm; } private void SaveConfig() { var settings = new List&lt;string&gt;(); settings.Add("[device]"); settings.Add(String.Format("DeviceID;{0}", _scanDevice.DeviceID)); foreach (IProperty property in _scanDevice.Properties) { var propstring = string.Format("{1}{0}{2}{0}{3}", ";", property.Name, property.PropertyID, property.get_Value()); settings.Add(propstring); } settings.Add("[item]"); settings.Add(String.Format("ItemID;{0}", _scannerItem.ItemID)); foreach (IProperty property in _scannerItem.Properties) { var propstring = string.Format("{1}{0}{2}{0}{3}", ";", property.Name, property.PropertyID, property.get_Value()); settings.Add(propstring); } File.WriteAllLines(Config, settings.ToArray()); } private enum loadMode {undef, device, item}; private void LoadConfig() { var settings = File.ReadAllLines(Config); var mode = loadMode.undef; foreach (var setting in settings) { if (setting.StartsWith("[device]")) { mode = loadMode.device; continue; } if (setting.StartsWith("[item]")) { mode = loadMode.item; continue; } if (setting.StartsWith("DeviceID")) { var deviceid = setting.Split(';')[1]; var devMngr = new DeviceManagerClass(); foreach (IDeviceInfo deviceInfo in devMngr.DeviceInfos) { if (deviceInfo.DeviceID == deviceid) { _scanDevice = deviceInfo.Connect(); break; } } if (_scanDevice == null) { MessageBox.Show("    "); return; } _scannerItem = _scanDevice.Items[1]; continue; } if (setting.StartsWith("ItemID")) { var itemid = setting.Split(';')[1]; continue; } var sett = setting.Split(';'); switch (mode) { case loadMode.device: SetProp(_scanDevice.Properties, sett[1], sett[2]); break; case loadMode.item: SetProp(_scannerItem.Properties, sett[1], sett[2]); break; } } SaveProp(_scanDevice.Properties, ref _defaultDeviceProp); } private static void SetProp(IProperties prop, object property, object value) { try { prop[property].set_Value(value); } catch (Exception) { return; } } } }</span></span></code> </pre><br></div></div><br>  Of course, <i>Scanner</i> cannot be called a full-fledged tool for working with a scanner, but it is a turnkey solution for working with various types of scanners.  This example illustrates the principle of working with <i>WIA</i> from under.  <i>NET</i> , and may be the basis for the construction of scanning programs. <br><br>  And so we scan the orders of the HR department;) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e50/efe/3eb/e50efe3eb013455a83881ac6bbd86ed0.jpg"></div><br>  Thank you for your attention, until we meet again at Habr√©! </div><p>Source: <a href="https://habr.com/ru/post/310562/">https://habr.com/ru/post/310562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310552/index.html">8 Tips for Using Skype for Business</a></li>
<li><a href="../310554/index.html">Work in IPFS with a human face</a></li>
<li><a href="../310556/index.html">Hackathon as a source of life improvement in the company</a></li>
<li><a href="../310558/index.html">Why burnout depletes productivity (and how to deal with it)</a></li>
<li><a href="../310560/index.html">What is special about DBMS for in-memory data?</a></li>
<li><a href="../310564/index.html">About HPE Synergy. Part III - D3940 Disk Storage and SAS Switches</a></li>
<li><a href="../310566/index.html">Entertaining math command line</a></li>
<li><a href="../310568/index.html">Selection and planning of the web studio team at the start</a></li>
<li><a href="../310570/index.html">Correct polyhedra. Part 1.1 The Schl√§fli Symbol</a></li>
<li><a href="../310572/index.html">We add numbers on Rust</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>