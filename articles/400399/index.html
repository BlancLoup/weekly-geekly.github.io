<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I intercom Vizit connected to mqtt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time to everyone. The first of January, there is nothing to do, so I decided to roll an article on Giktayms. In connection with the move to anoth...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I intercom Vizit connected to mqtt</h1><div class="post__text post__text-html js-mediator-article">  Good time to everyone.  The first of January, there is nothing to do, so I decided to roll an article on Giktayms.  In connection with the move to another apartment there was such an option as an intercom.  Everything would be fine, but running and opening the door to everyone who came was very annoying, and since phones, tablets, computers are always within walking distance, only reach out, it was decided to connect this benefit to the already running iobroker automation system.  Below I will describe what happened with this. <br><br>  Assembled in haste from what was <s>lying under my feet</s> was available. As a result, the whole thing looks like this. <br><br><img src="https://habrastorage.org/files/a31/8a3/3b5/a318a33b56da408086106ba528319dcc.jpg" alt="image"><br><a name="habracut"></a><br>  Since I already have a wonderful iobroker automation system, it was decided to connect to it in order to be able to centrally control and configure <s>changes in behavior</s> in a single interface.  It is time to choose how the hardware and the total system will communicate.  What just did not occur to me as an exchange protocol from 1wire emulation to get requests, the mqtt protocol eventually won as the most convenient in my vision of the situation, and the exchange between the piece of iron and iobroker is implemented. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On the tablet, it looks like a tab with the display of the current camera and control <br><br><img src="https://habrastorage.org/files/6f2/ffb/91d/6f2ffb91d749472aa2189ebc29215160.jpg" alt="image"><br><br>  Part one is iron.  It consists of arduino uno, ethernet shields, and a small matching circuit with the intercom line.  The scheme itself: <br><br><img src="https://habrastorage.org/files/e4e/3ff/0d8/e4e3ff0d8d2e43e88d8a640cf6fabdd3.png" alt="image"><br><br>  Everything is simple, the incoming call is monitored by the incoming call, and upon admission it simply presses the arduino's zero leg.  Opening the door is implemented on the relay in the normal state is always closed, when a command from iobroker is received (a button is pressed in the interface, automatically according to the condition in the script, a command from the telegrams arrived) breaks the line for 7.5 seconds, while the vizit takes it as a command to open and starts the guest . <br><br>  Additionally, on the optocounter vo2, the TV automatically switches to AV mode for display from the doorphone camera. <br><br>  Part two is software, which is also essentially divided into two.  The first is a sketch that is stitched in arduino and implements the exchange via the mqtt protocol with the iobroker system. <br><br><pre><code class="hljs lua">#include &lt;SPI.h&gt; #include &lt;Ethernet.h&gt; #include &lt;PubSubClient.h&gt; int flag = <span class="hljs-number"><span class="hljs-number">0</span></span>; #define ring1_pin <span class="hljs-number"><span class="hljs-number">0</span></span> //   <span class="hljs-number"><span class="hljs-number">1</span></span> #define open1_pin <span class="hljs-number"><span class="hljs-number">2</span></span> //  <span class="hljs-number"><span class="hljs-number">1</span></span> #define open2_pin <span class="hljs-number"><span class="hljs-number">3</span></span> //  <span class="hljs-number"><span class="hljs-number">2</span></span> #define mon1_pin <span class="hljs-number"><span class="hljs-number">5</span></span> //    #define ID_CONNECT <span class="hljs-string"><span class="hljs-string">"DoorbellControll"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> mac[] = { <span class="hljs-number"><span class="hljs-number">0xDE</span></span>, <span class="hljs-number"><span class="hljs-number">0xED</span></span>, <span class="hljs-number"><span class="hljs-number">0xBA</span></span>, <span class="hljs-number"><span class="hljs-number">0xFE</span></span>, <span class="hljs-number"><span class="hljs-number">0xFE</span></span>, <span class="hljs-number"><span class="hljs-number">0xED</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> server[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-number"><span class="hljs-number">170</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ip[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>, <span class="hljs-number"><span class="hljs-number">168</span></span>, <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span> }; EthernetClient ethClient; PubSubClient client(server, <span class="hljs-number"><span class="hljs-number">1883</span></span>, callback, ethClient); void callback(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* topic, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>* payload, unsigned int length) { payload[length] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; String strTopic = String(topic); String strPayload = String((<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>*)payload); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/open1"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"false"</span></span>) { digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"true"</span></span>) { digitalWrite(<span class="hljs-number"><span class="hljs-number">2</span></span>, LOW); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/open2"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"false"</span></span>) digitalWrite(<span class="hljs-number"><span class="hljs-number">3</span></span>, LOW); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"true"</span></span>) digitalWrite(<span class="hljs-number"><span class="hljs-number">3</span></span>, HIGH); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strTopic == <span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/mon1"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"false"</span></span>) digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, LOW); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strPayload == <span class="hljs-string"><span class="hljs-string">"true"</span></span>) digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, HIGH); } } void reconnect() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!client.connected()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(ID_CONNECT)) { client.subscribe(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/#"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); } } } void setup() { pinMode(ring1_pin, INPUT); pinMode(open1_pin, OUTPUT); digitalWrite(open1_pin, HIGH); pinMode(open2_pin, OUTPUT); digitalWrite(open2_pin, LOW); pinMode(mon1_pin, OUTPUT); digitalWrite(mon1_pin, LOW); Ethernet.begin(mac, ip); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.connect(<span class="hljs-string"><span class="hljs-string">"DoorbellControll"</span></span>)) { client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/open1"</span></span>, <span class="hljs-string"><span class="hljs-string">"false"</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/open2"</span></span>, <span class="hljs-string"><span class="hljs-string">"false"</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/mon1"</span></span>, <span class="hljs-string"><span class="hljs-string">"false"</span></span>); client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/ring1"</span></span>, <span class="hljs-string"><span class="hljs-string">"false"</span></span>); client.subscribe(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/#"</span></span>); } } void loop() { client.loop(); //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(ring1_pin) == LOW &amp;&amp; flag == <span class="hljs-number"><span class="hljs-number">0</span></span>) { client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/ring1"</span></span>, <span class="hljs-string"><span class="hljs-string">"true"</span></span>); flag = <span class="hljs-number"><span class="hljs-number">1</span></span>;//  flag   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(ring1_pin) == HIGH &amp;&amp; flag == <span class="hljs-number"><span class="hljs-number">1</span></span>) { client.publish(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/ring1"</span></span>, <span class="hljs-string"><span class="hljs-string">"false"</span></span>); flag = <span class="hljs-number"><span class="hljs-number">0</span></span>; //  flag } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.connected()) { reconnect(); client.subscribe(<span class="hljs-string"><span class="hljs-string">"myhome/DoorbellControll/#"</span></span>); } }</code> </pre> <br>  And the second is a js script to implement user interaction: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//************       ******************** createState('doorbellcontroll.rings', 'false'); createState('doorbellcontroll.visopen', 'false'); //   vis on("mqtt.0.myhome.DoorbellControll.ring1", function (obj){ if (obj.newState.val == "true" || obj.newState.val === true) { setState('javascript.0.doorbellcontroll.rings', true); setTimeout(function() { }, 60000); } }); //********      ,        **************** on("javascript.0.doorbellcontroll.rings", function (obj){ if (obj.newState.val == "true" || obj.newState.val === true) { setState('sayit.0.tts.text', '  '); //     sendTo('telegram.0', '  '); //    setState('mqtt.0.myhome.DoorbellControll.mon1', true); //     setState("vis.0.control.command", '{"instance": "FFFFFFFF", "command": "changeView", "data": "Camers"}'); //    "" //***********  30      ******************** setTimeout(function () { setState('mqtt.0.myhome.DoorbellControll.mon1', false); //     setState("vis.0.control.command", '{"instance": "FFFFFFFF", "command": "changeView", "data": "StartView"}'); //    "Home" setState('javascript.0.doorbellcontroll.rings', false); }, 30000); } }); //*******************   ""  Vis************** on("javascript.0.doorbellcontroll.visopen", function (obj){ if (obj.newState.val == "true" || obj.newState.val === true) { setState('mqtt.0.myhome.DoorbellControll.open1', true); //   toLog('   . ', true, 'orange'); //   setTimeout(function () { setState('mqtt.0.myhome.DoorbellControll.open1', false); setState('javascript.0.doorbellcontroll.visopen', false); //    }, 7500); } });</span></span></code> </pre> <br>  The iobroker system is displayed as objects with which you can interact. <br><br><img src="https://habrastorage.org/files/dfe/8fd/c78/dfe8fdc78e0e4018bfe6712083b339d6.png" alt="image"><br><br>  In this narrative to what brings <s>laziness</s> craving to simplify his routine actions has come to a logical conclusion. </div><p>Source: <a href="https://habr.com/ru/post/400399/">https://habr.com/ru/post/400399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../400389/index.html">ITER in 2016</a></li>
<li><a href="../400391/index.html">10 best gifts for a Sony fan</a></li>
<li><a href="../400393/index.html">JeVois: Open-Source Quad-Core Computer Vision Platform</a></li>
<li><a href="../400395/index.html">Police want to interrogate Alex from the Amazon Echo column on the murder case</a></li>
<li><a href="../400397/index.html">Astronautics 2016 on Geektimes, part 3</a></li>
<li><a href="../400401/index.html">Not unhelpful resistance: Fostex TR headphone ruler</a></li>
<li><a href="../400405/index.html">Smuggling from China - marriage and darkness for Russians</a></li>
<li><a href="../400407/index.html">New CES 2017: ThinkPad X1, Razer Three-Screen Laptop, 6-inch Ockel Desktop and New Smartphones</a></li>
<li><a href="../400409/index.html">Personal computer "Electronics MK-85"</a></li>
<li><a href="../400411/index.html">Ask Ethan: Can two planets exist in the same orbit?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>