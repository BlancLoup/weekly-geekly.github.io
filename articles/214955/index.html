<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Boat for DirectX-arcade. Part number 1: make contact</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction  Everyone, playing, at least once thought: ‚ÄúI wish I could write a program that would play for me!‚Äù. But usually this thought, and the th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Boat for DirectX-arcade. Part number 1: make contact</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><img align="right" src="https://habrastorage.org/getpro/habr/post_images/afd/1f2/55d/afd1f255d4b5c2daffc9fae15837a2ce.jpg" alt="image">  Everyone, playing, at least once thought: ‚ÄúI wish I could write a program that would play for me!‚Äù.  But usually this thought, and the thought remains so ... Constantly something interferes with: ignorance of where to start, fear of the task being too heavy, whispering from the left shoulder ‚Äúand why is that?  who needs it to make the program play with the program? ‚Äùetc. <br><br>  In this series of articles I am going to show that, firstly: ‚Äúthe devil is not so terrible as he is painted,‚Äù and secondly: I am going to answer the question later: ‚Äúwhy is this necessary?‚Äù. <br><br>  Now we start with a simple one.  Since establishing the relationship between the game and the player program (bot).  The widely known game Zuma is taken as an experimental rabbit. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Any interaction consists of two processes: sending data to ‚Äúthem‚Äù and receiving data from ‚Äúthem‚Äù.  In Zuma, all control is done with a mouse, and the game gives out feedback using an image.  Accordingly, the first thing you need to learn how to programmatically emulate the behavior of the mouse and get the image from the game. <br><br>  The main purpose of this article is to get a program that automatically enters the gameplay over and over again, does something there, and when the game over-e starts it all over again.  Further, this framework will evolve in the direction that the bot farther and lasts longer in the game before the game over. <br><br><hr>  Solved auxiliary subtasks: <i>mouse emulation, mouse redirection to a virtual machine, image capture.</i> <hr><br><a name="habracut"></a><br><h4>  Retreat </h4>  When developing the code for this cycle of articles, an approach is used: to get results as quickly as possible in a minimum of effort.  This approach allows you to maintain motivation at a high level, and does not give up at the sight of the impossibility of the task.  Because of this: <br>  - first, many irrelevant (from the point of view of the current result) moments will quickly go over, leaving ‚Äúcrutches and supports‚Äù in the code.  And only at the next iterations these moments will be dealt with separately, and the ‚Äúcrutches‚Äù will be replaced with a full code. <br>  - secondly, the code style is more ‚Äúhacker‚Äù than the classic C #.  In the code there will be a lot of lambd, anonymous data, tricks, copyright arbitrariness and the complete absence of comments. <br><br><h4>  Mouse emulation </h4>  Windows supports 2 standard methods for mouse emulation using 4 different WinApi functions. <br><br>  <b>The first way is</b> to send your window messages ( <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms645616(v%3Dvs.85).aspx">WM_MOUSEMOVE</a> , <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms645607(v%3Dvs.85).aspx">WM_LBUTTONDOWN</a> , etc.) to the program using the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644950(v%3Dvs.85).aspx">SendMessage</a> or <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644944(v%3Dvs.85).aspx">PostMessage</a> functions. <br><br>  For DirectX-games (as in our case) this method is not suitable, because such mouse polling programs use DirectInput, which polls the mouse directly, ignoring windows messages. <br><br>  <b>The second way</b> : direct emulation of the behavior of the mouse using the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms646260(v%3Dvs.85).aspx">mouse_event</a> or <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms646310(v%3Dvs.85).aspx">SendInput functions</a> .  This method is suitable for any program, including full-screen DirectX-games.  The mouse_event function is simpler, but it is considered obsolete, SendInput is more modern, but more cumbersome.  Let's stop on mouse_event. <br><br>  WinApi functions from C # are called using <a href="http://en.wikipedia.org/wiki/Platform_Invocation_Services">PInvoke</a> technology.  The PInvoke description for most common WinApi functions can be found at <a href="http://pinvoke.net/">PInvoke.net</a> .  The mouse_event function is no <a href="http://www.pinvoke.net/default.aspx/user32/mouse_event.html">exception</a> . <br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user32.dll"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouse_event</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwFlags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dy, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwData, UIntPtr dwExtraInfo</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br><br><h5>  Mouse coordinates </h5>  The mouse_event function has a specific feature: the mouse coordinates are set in mickey, and not in pixels.  The recalculation of mickey to pixels (and vice versa) depends on the resolution of the main monitor used.  (0,0) corresponds to the upper left corner of the monitor, and (65535, 65535) to the lower right, which gives the formula for converting mickey to pixels and back: <code>mickey_point = pixel_point * (65536, 65536) / screen_size</code> and <code>pixel_point = mickey_point * screen_size / (65536, 65536)</code> . <br><br><h5>  Basic operations </h5>  Summarizing all of the above, we get the following operations to control the mouse. <br>  Move the mouse to a point (x, y): <br><pre> <code class="cs hljs"> mouse_event(MouseEventFlags.MOVE | MouseEventFlags.ABSOLUTE, x * <span class="hljs-number"><span class="hljs-number">65536</span></span> / screen_width, y * <span class="hljs-number"><span class="hljs-number">65536</span></span> / screen_height);</code> </pre><br>  Left click: <br><pre> <code class="cs hljs"> mouse_event((MouseEventFlags.LEFTDOWN), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); mouse_event((MouseEventFlags.LEFTUP), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>  Right-click: <br><pre> <code class="cs hljs"> mouse_event((MouseEventFlags.RIGHTDOWN), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); mouse_event((MouseEventFlags.RIGHTUP), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><br><h5>  Problem: input exclusivity </h5>  When emulating a mouse through the mouse_event function, there is a serious inconvenience: the mouse_event simulates a mouse for the entire OS at once, and not for an individual application.  From this it follows that while the bot is running and playing, then other work behind the computer is impossible: debugging the bot, actively viewing the state of the bot, reading the Internet, etc.  But there is a way: a virtual machine! <br><br><h4>  Transferring the game to a virtual machine </h4>  Moving the game to the virtual machine solves the following problems: <br>  - first, it simplifies interaction with games that do not support windowed mode and work only in full-screen mode, <br>  - secondly, mouse input is replaced only on the virtual machine, and on the main machine continues to work in normal mode, allowing the computer user to go about their business. <br><br>  Bot, in contrast to the game itself, more convenient to run on the main machine.  This allows you to restart the bot directly from Visual Studio, debug it in the same place, there is where to display the internal state of the bot, etc. <br><br>  Deploying a virtual machine (in this case, <a href="https://www.virtualbox.org/wiki/Downloads">Oracle VirtualBox was used</a> ), installing the guest OS and transferring the game is done on a regular basis with the exception of one thing: the bot needs to be able to establish a network connection between the host OS and the guest OS.  This is done in a variety of ways.  One way to get a specific port from the guest OS to the host using VirtualBox.  Another way is to configure the Bridged Adapter mode, then the virtual machine for the entire network will look like a normal computer, and the guest OS will receive its ip-address via dhcp from the router.  Access from the host OS to the guest OS will occur at this address.  <i>(the author, in this case, used the variant with bridged adapter)</i> <br><br><h5>  Proxy </h5><img align="right" src="https://habrastorage.org/getpro/habr/post_images/565/a00/521/565a0052132161bb22cf5b63fe55374c.png" alt="image">  To control the mouse on the guest OS, we will write a proxy, which is a simple console tcp-server.  Its full code is small and presented under the cat.  To simplify the code and reduce dependencies, the proxy is written on a bare socket without using remoting, wcf, etc. <br><div class="spoiler">  <b class="spoiler_title">Proxy code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net.Sockets; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.InteropServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">InputProxy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> socket = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp); socket.Bind(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Net.IPEndPoint(System.Net.IPAddress.Any, <span class="hljs-number"><span class="hljs-number">7001</span></span>)); socket.Listen(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = socket.Accept(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"connected.."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> thread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Threading.Thread(() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clientReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NetworkStream(client)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.Poll(<span class="hljs-number"><span class="hljs-number">1</span></span>, SelectMode.SelectRead) &amp;&amp; client.Available == <span class="hljs-number"><span class="hljs-number">0</span></span>) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"disconnected.."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.Available &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgSize = clientReader.ReadInt32(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = clientReader.ReadBytes(msgSize); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.MemoryStream(message)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msgKind = messageReader.ReadInt32(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"message: kind:{0}, len:{1}"</span></span>, msgKind, message.Length); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msgKind) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flags = messageReader.ReadUInt32(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = messageReader.ReadInt32(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = messageReader.ReadInt32(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = messageReader.ReadUInt32(); mouse_event(flags, x, y, data, UIntPtr.Zero); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exc) { Console.WriteLine(exc); } }) { IsBackground = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }; thread.Start(); } } [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mouse_event</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwFlags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dy, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwData, UIntPtr dwExtraInfo</span></span></span><span class="hljs-function">)</span></span>; } }</code> </pre><br></div></div><br>  For a proxy to work, it‚Äôs enough to copy it to a virtual machine and launch it.  The proxy waits for messages on port 7001 and displays a log of its work on the console.  To shut down the proxy, just close the console window. <br><br><h5>  Customer </h5>  Connecting to a proxy is even easier than the code of the proxy itself. <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Net.Sockets.TcpClient(vm_host, <span class="hljs-number"><span class="hljs-number">7001</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clientStream = client.GetStream(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> clientWriter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.BinaryWriter(clientStream); Action&lt;MouseEventFlags, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; mouse_event = (flags, x, y) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageStream = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.MemoryStream(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageWriter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.IO.BinaryWriter(messageStream); messageWriter.Write(<span class="hljs-number"><span class="hljs-number">0</span></span>); messageWriter.Write((<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>)flags); messageWriter.Write(x); messageWriter.Write(y); messageWriter.Write(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = messageStream.ToArray(); clientWriter.Write(message.Length); clientWriter.Write(message); clientStream.Flush(); };</code> </pre><br><br><h4>  Image capture </h4>  The image is most easily captured directly from the screen.  In the .net there is a ready-made function <a href="http://msdn.microsoft.com/en-us/library/system.drawing.graphics.copyfromscreen(v%3Dvs.110).aspx">Graphics.CopyFromScreen</a> for this.  On this method and dwell. <br>  First, I want to get a Bitmap at the output, not Graphics - this is solved with the help of an auxiliary function: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetScreenImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Rectangle rect</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bmp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bitmap(rect.Width, rect.Height, PixelFormat.Format32bppArgb); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Graphics graphics = Graphics.FromImage(bmp)) { graphics.CopyFromScreen(rect.Left, rect.Top, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, rect.Size, CopyPixelOperation.SourceCopy); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bmp; }</code> </pre><br>  Secondly, you need to know what part of the screen you need to capture.  You can, of course, always capture the same part of the screen, and place the game with your hands in this part of the screen, but this is <s>not sporty</s> not convenient.  Moreover, the automation of this process is done with minimal effort.  This will again help us WinApi and PInvoke, and more specifically two functions: <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms633499(v%3Dvs.85).aspx">FindWindow</a> and <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms633519(v%3Dvs.85).aspx">GetWindowRect</a> .  FindWindow allows to get the window handle by the window title, and GetWindowRect by the handle returns the position and size of the window on the screen. <br>  Pinvoke-description of both functions is on pinvoke.net site: <a href="http://www.pinvoke.net/default.aspx/user32.findwindow">FindWindow</a> and <a href="http://www.pinvoke.net/default.aspx/user32/GetWindowRect.html">GetWindowRect</a> . <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user32.dll"</span></span></span><span class="hljs-meta">, SetLastError = true)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> IntPtr </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lpClassName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lpWindowName</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"user32.dll"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>: MarshalAs(UnmanagedType.Bool)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWindowRect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IntPtr hwnd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> RECT lpRect</span></span></span><span class="hljs-function">)</span></span>; [StructLayout(LayoutKind.Sequential)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RECT { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Left; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Top; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Right; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Bottom; }</code> </pre><br>  And the image capture code of the virtual machine window is obtained as follows: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vm_left = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vm_right = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vm_top = <span class="hljs-number"><span class="hljs-number">50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vm_bottom = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vm_title = <span class="hljs-string"><span class="hljs-string">"Windows81 [Running] - Oracle VM VirtualBox"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handle = FindWindow(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, vm_title); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handle == IntPtr.Zero) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"  "</span></span>); RECT rect; GetWindowRect(handle, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> rect); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gameScreenRect = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Drawing.Rectangle(rect.Left + vm_left, rect.Top + vm_top, rect.Right - rect.Left - vm_right - vm_left, rect.Bottom - rect.Top - vm_bottom - vm_top); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gameBmp = GetScreenImage(gameScreenRect);</code> </pre><br><br><h5>  Weakness </h5>  A significant disadvantage of this approach is that the window being captured is, firstly: it must be located entirely on the screen, and secondly, it must be placed on top of all other windows.  This inconvenience is leveled with the help of two (or more) monitors :), then the virtual machine window is located on the auxiliary monitor, without disturbing anyone, remaining on top of the other windows.  Also, this problem is completely solved with the help of the previously reviewed method: transfer of a function (screen capture) inside a virtual machine.  To do this, simply add the corresponding function to InputProxy. <br><br><h4>  Looping gameplay </h4>  Finally, we proceed directly to solving the task set for today: looping the gameplay - all the necessary subtasks have been solved.  Zuma gameplay revolves around three windows: main, mission, and action.  The main window contains the main menu, allowing you to select the type of game, the mission window offers you to select a mission, and the game process itself takes place in the action window. <br>  The bot determines the current window in the easiest way: by the color value at several key points.  Points are selected manually: by the method of "scrutinizing". <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> screenChecks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Name = <span class="hljs-string"><span class="hljs-string">"main"</span></span>, Points = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CheckPoint(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>, <span class="hljs-number"><span class="hljs-number">0xff554a22</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CheckPoint(<span class="hljs-number"><span class="hljs-number">65</span></span>, <span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-number"><span class="hljs-number">0xfff44c41</span></span>) } }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Name = <span class="hljs-string"><span class="hljs-string">"mission"</span></span>, Points = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CheckPoint(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">190</span></span>, <span class="hljs-number"><span class="hljs-number">0xffb5d0c7</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CheckPoint(<span class="hljs-number"><span class="hljs-number">65</span></span>, <span class="hljs-number"><span class="hljs-number">400</span></span>, <span class="hljs-number"><span class="hljs-number">0xffad7630</span></span>) } }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Name = <span class="hljs-string"><span class="hljs-string">"action"</span></span>, Points = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CheckPoint(<span class="hljs-number"><span class="hljs-number">950</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0xff72554b</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CheckPoint(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">0xff462b1d</span></span>), } }, }; Func&lt;Bitmap, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; check = image =&gt; screenChecks.Where(_check =&gt; image.Check(_check.Points)).Select(_check =&gt; _check.Name).FirstOrDefault();</code> </pre><br>  The main bot cycle: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startButtonPoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(<span class="hljs-number"><span class="hljs-number">950</span></span>, <span class="hljs-number"><span class="hljs-number">430</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startMissionPoint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(<span class="hljs-number"><span class="hljs-number">600</span></span>, <span class="hljs-number"><span class="hljs-number">750</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (; ; ) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bmp = GetScreenImage(gameScreenRect); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> screenName = check(bmp); Console.Write(screenName + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>(<span class="hljs-string"><span class="hljs-string">'\x8'</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (screenName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"main"</span></span>: mouse_event(MouseEventFlags.MOVE | MouseEventFlags.ABSOLUTE, startButtonPoint.X * <span class="hljs-number"><span class="hljs-number">65536</span></span> / game_width, startButtonPoint.Y * <span class="hljs-number"><span class="hljs-number">65536</span></span> / game_height); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">400</span></span>); mouse_event(MouseEventFlags.LEFTDOWN, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">150</span></span>); mouse_event(MouseEventFlags.LEFTUP, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">400</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"mission"</span></span>: mouse_event(MouseEventFlags.MOVE | MouseEventFlags.ABSOLUTE, startMissionPoint.X * <span class="hljs-number"><span class="hljs-number">65536</span></span> / game_width, startMissionPoint.Y * <span class="hljs-number"><span class="hljs-number">65536</span></span> / game_height); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>); mouse_event(MouseEventFlags.LEFTDOWN, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">150</span></span>); mouse_event(MouseEventFlags.LEFTUP, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"action"</span></span>: mouse_event(MouseEventFlags.LEFTDOWN, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">150</span></span>); mouse_event(MouseEventFlags.LEFTUP, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); System.Threading.Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>: bmp.Save(<span class="hljs-string"><span class="hljs-string">"unknown.bmp"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exc) { Console.WriteLine(exc); } }</code> </pre><br>  In the game phase, the bot constantly clicks, releasing the balls at one point.  On such a simple (or rather stupid) tactic, a bot in the first mission gains 1000-2000 points, and sometimes it even fully picks up a Zuma strip. <br><br><img align="right" src="https://habrastorage.org/getpro/habr/post_images/3ab/2d4/c04/3ab2d4c0474dd66837157f34225c7c0c.jpg"><br><br><h4>  Summary </h4>  The goal has been accomplished: the bot frame has been written - the game process is fixated. <br>  The following goals: connect OpenCV, recognize the position and color of the balls. <br><br><h5>  Ps </h5><br>  Image to attract attention.  <i>(Orange shows areas that the next version of the bot recognized as balls)</i> <br><br><hr>  <a href="http://habrahabr.ru/post/214955/">Boat for DirectX-arcade.</a>  <a href="http://habrahabr.ru/post/214955/">Part number 1: make contact</a> <br>  <a href="http://habrahabr.ru/post/216757/">Boat for the arcade.</a>  <a href="http://habrahabr.ru/post/216757/">Part number 2: connect OpenCv</a> <hr></div><p>Source: <a href="https://habr.com/ru/post/214955/">https://habr.com/ru/post/214955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214943/index.html">Elementary OS: get paid to fix bugs</a></li>
<li><a href="../214945/index.html">Comparison of services for autocompletion of addresses in the form</a></li>
<li><a href="../214949/index.html">GitHub launched Developer Program</a></li>
<li><a href="../214951/index.html">Implementing BFS Algorithm on GPU</a></li>
<li><a href="../214953/index.html">Microsoft NCSI in service or as we were looking for a forgotten netbook</a></li>
<li><a href="../214959/index.html">Photobank Getty Images has opened free access to 35 million photos</a></li>
<li><a href="../214961/index.html">Satoshi Nakamoto - "I am not Dorian Nakamoto"</a></li>
<li><a href="../214963/index.html">IML TODO</a></li>
<li><a href="../214965/index.html">Cloudwash: a washing machine with Wi-Fi from the creators of Little Printer</a></li>
<li><a href="../214967/index.html">Useful Open Source and how we taught Zxing to speak another language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>