<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Data mining in R</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is a translation of three parts of the Data acquisition in R series from my English-language blog . The original series is conceived in four...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Data mining in R</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  This post is a translation of three parts of the Data acquisition in R series from <a href="https://ikashnitsky.github.io/">my English-language blog</a> .  The original series is conceived in four parts, three of which formed the basis of this post: <a href="https://ikashnitsky.github.io/2017/data-acquisition-one/">Use of prepared data sets</a> ;  <a href="https://ikashnitsky.github.io/2017/data-acquisition-two">Access to popular statistical databases</a> ;  <a href="https://ikashnitsky.github.io/2017/data-acquisition-three">Demographic data</a> ;  <a href="https://ikashnitsky.github.io/2017/data-acquisition-three">Demographic data</a> .  The final part that has not yet been written will deal with the use of spatial data. </blockquote><br><img src="https://habrastorage.org/webt/v5/01/9z/v5019zvwovk0yldh1irmc81b7uy.jpeg" width="70%" align="left"><br><p><br clear="left"></p><br><p>  R sharpened by reproducible results.  There are many excellent solutions that ensure the <a href="https://cran.r-project.org/web/packages/checkpoint/vignettes/checkpoint.html">compatibility of system versions and packages</a> that help <a href="https://bookdown.org/yihui/bookdown/">apply the principles of literate programming</a> ... I want to show how you can easily and efficiently find / download / extract data using R itself and documenting each step, which ensures complete reproducibility of the entire process.  Of course, I don‚Äôt set myself the task of listing all possible data sources and focusing mainly on demographic data.  If your interests lie outside the scope of population statistics, it is worth looking in the direction of the magnificent <a href="https://github.com/ropensci/opendata">Open Data Task View</a> project. </p><br><p>  To illustrate the use of each of the sources of information, I give an example of visualization of the data.  Each code sample is designed as a separate unit ‚Äî copy and reproduce.  Of course, you first need to install the required packages.  All code lies entirely <a href="https://gist.github.com/ikashnitsky/7c11a138e22b27d0e2db18bd9fd2035f">here</a> . </p><a name="habracut"></a><br><h1 id="vstroennye-nabory-dannyh">  Embedded datasets </h1><br><p> Many packages include small convenient data sets to illustrate the methods.  Actually, the core of R includes the <code>datasets</code> package, which contains a large number of small, diverse, sometimes very famous, datasets.  A detailed list of illustrative datasets embedded in various packages is provided <a href="https://vincentarelbundock.github.io/Rdatasets/datasets.html">on Vincent Arel-Bundock website</a> . </p><br><p>  A nice feature of embedded datasets is that they are "always with you."  Unique training dataset names can be used as easily as any objects from the Global Environment.  Let's take a look at the charming tiny dataset of <code>swiss</code> - Swiss Fertility and Socioeconomic Indicators (1888) Data.  Below I will show the differences in the birth rate between the cantons of Switzerland depending on the proportion of the rural population and the prevalence of the Catholic faith. </p><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">library</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tidyverse)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">swiss</span></span></span><span class="hljs-function"> %&gt;% </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ggplot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aes(x = Agriculture, y = Fertility, color = Catholic &gt; </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">50</span></span></span></span><span class="hljs-function"><span class="hljs-params">))</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">geom_point</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stat_ellipse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">theme_minimal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_family = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mono"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/hl/h1/ij/hlh1ijybqyk1c_7gvpjl0swcg5g.png" alt="fig1"></a> </p><br><h1 id="gapminder">  Gapminder </h1><br><p>  Some packages are specifically designed to make certain data sets easily accessible to users of R. A good example of such a package is <code>gapminder</code> , which contains an illustrative sample of <a href="http://www.gapminder.org/">Hapan</a> <a href="https://twitter.com/HansRosling">Rosling's</a> <a href="http://www.gapminder.org/">Gapminder</a> project data. </p><br><pre> <code class="hljs kotlin">library(tidyverse) library(gapminder) gapminder %&gt;% ggplot(aes(x = year, y = lifeExp, color = continent))+ geom_jitter(size = <span class="hljs-number"><span class="hljs-number">1</span></span>, alpha = .<span class="hljs-number"><span class="hljs-number">2</span></span>, width = .<span class="hljs-number"><span class="hljs-number">75</span></span>)+ stat_summary(geom = <span class="hljs-string"><span class="hljs-string">"path"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function">.y = mean, size = 1)+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">theme_minimal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_family = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mono"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/ed/n3/5d/edn35duegf-tbl1fhze3mmort5w.png" alt="fig2"></a> </p><br><h1 id="dobyvaem-dataset-po-url">  Dataset by URL </h1><br><p>  If a data set is stored somewhere online and has a direct link to download, it can be easily read in R, just by specifying a reference.  For example, let's take the famous <code>Galton</code> dataset on the growth of fathers and children from the <code>HistData</code> package.  Just take the data for a direct link from <a href="https://vincentarelbundock.github.io/Rdatasets/datasets.html">Vincent Arel-Bundock's list.</a> </p><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">library</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tidyverse)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">galton</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_csv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"https://raw.githubusercontent.com/vincentarelbundock/Rdatasets/master/csv/HistData/Galton.csv"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">galton</span></span></span><span class="hljs-function"> %&gt;% </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ggplot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aes(x = father, y = height))</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">geom_point</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(alpha = .</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stat_smooth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(method = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"lm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">theme_minimal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_family = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mono"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/yi/4_/cu/yi4_cun8dqed6qmo_9amjmzj6zu.png" alt="fig3"></a> </p><br><h1 id="skachivaem-i-raspakovyvaem-arhiv">  Download and unpack the archive </h1><br><p>  Very often, data sets are archived before being released to the Internet.  Reading the archive immediately fails, but the solution in R is quite simple.  The process logic is very simple: first we create a directory where we will unpack the data;  then download the archive to a temporary file;  Finally, unpack the archive into a previously created directory.  For example, I download <a href="https://catalog.data.gov/dataset/historical-new-york-city-crime-data-ad47e">Historical New York City Crime Data</a> , a set of data on crimes committed in New York, which was kindly provided by the State of New York and stored in the data data repository data.gov. </p><br><pre> <code class="hljs pgsql">library(tidyverse) library(readxl) # <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> a directory <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the unzipped data ifelse(!dir.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>("unzipped"), dir.<span class="hljs-keyword"><span class="hljs-keyword">create</span></span>("unzipped"), "Directory already exists") # specify the URL <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the archive url_zip &lt;- "http://www.nyc.gov/html/nypd/downloads/zip/analysis_and_planning/citywide_historical_crime_data_archive.zip" # storing the archive <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> file f &lt;- tempfile() download.file(url_zip, destfile = f) unzip(f, exdir = "unzipped/.")</code> </pre> <br><p>  Sometimes the downloaded archive is weighty enough, and we would not want to download it again each time, playing the code.  In this case, it makes sense to save the original archive, rather than use a temporary file. </p><br><pre> <code class="hljs mel"># <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> we want to keep the .zip <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> path_unzip &lt;- <span class="hljs-string"><span class="hljs-string">"unzipped/data_archive.zip"</span></span> ifelse(!<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>(path_unzip), download.<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>(url_zip, path_unzip, mode=<span class="hljs-string"><span class="hljs-string">"wb"</span></span>), <span class="hljs-string"><span class="hljs-string">'file alredy exists'</span></span>) unzip(path_unzip, exdir = <span class="hljs-string"><span class="hljs-string">"unzipped/."</span></span>)</code> </pre><br><p>  Finally, let's import and visualize the downloaded and unzipped data. </p><br><pre> <code class="hljs pgsql">murder &lt;- read_xls("unzipped/Web Data 2010-2011/Seven Major Felony Offenses 2000 - 2011.xls", sheet = <span class="hljs-number"><span class="hljs-number">1</span></span>, range = "A5:M13") %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(OFFENSE %&gt;% substr(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>) == "MURDER") %&gt;% gather("year", "value", <span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>) %&gt;% mutate(year = year %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.numeric()) murder %&gt;% ggplot(aes(year, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>))+ geom_point()+ stat_smooth(<span class="hljs-keyword"><span class="hljs-keyword">method</span></span> = "lm")+ theme_minimal(base_family = "mono")+ labs(title = "Murders in New York")</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/vb/pv/li/vbpvlidhn_xijw1dflgv_md6nqq.png" alt="fig4"></a> </p><br><h1 id="figshare">  Figshare </h1><br><p>  In the academic world, the issue of reproducibility is becoming ever more acute.  Therefore, more and more often openly published data sets become true companions of scientific articles.  There are many specialized repositories for such data sets.  One of the most widely used is Figshare.  For him, there is a wrapper for R - <code>rfigshare</code> .  For example, I download my own <a href="">set of data about the growth of hockey players</a> , which I collected for writing <a href="https://habrahabr.ru/post/301340/">one of the previous posts on Habr√©</a> .  Please note that the first time you use the <code>rfigshare</code> package, you will be asked to enter the login and password from Figshare to access the API - a special web page will open in the browser. </p><br><p>  There is a special function <code>fs_search</code> , but, in my experience, it is easier to find in the browser the data we are interested in and copy the unique identifier, by which we download it to R. The <code>fs_download</code> function turns the id into a direct link to download the file. </p><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">library</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tidyverse)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">library</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rfigshare)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">url</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fs_download</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(article_id = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"3394735"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hockey</span></span></span><span class="hljs-function"> &lt;- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_csv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hockey</span></span></span><span class="hljs-function"> %&gt;% </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ggplot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(aes(x = year, y = height))</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">geom_jitter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(size = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">, color = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"#35978f"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, alpha = .</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">, width = .</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">25</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stat_smooth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(method = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"lm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, size = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ylab</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"height, cm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xlab</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"year of competition"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale_x_continuous</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(breaks = seq(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2005</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2015</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">), labels = seq(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2005</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2015</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5</span></span></span></span><span class="hljs-function"><span class="hljs-params">))</span></span></span><span class="hljs-function">+ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">theme_minimal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_family = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mono"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/gq/y_/u-/gqy_u-susmv8lpr9zs4yzgwzzrs.png" alt="fig5"></a> </p><br><h1 id="eurostat">  Eurostat </h1><br><p>  Eurostat publishes an unbelievable amount of statistics on European countries and their regions.  Of course, there is a special package <code>eurostat</code> for all this wealth.  Unfortunately, the built-in <code>search_eurostat</code> function <code>search_eurostat</code> not do well with the task of searching for relevant datasets.  For example, on request <code>life expectancy</code> we get only two options, while in reality there should be several dozens of datasets.  Therefore, the most convenient solution looks like this: go to <a href="http://ec.europa.eu/eurostat/data/database">the Eurostat website</a> , find the data we are interested in, copy only its code and, finally, download it using the <code>eurostat</code> package.  Please note that all Eurostat regional statistics are in a <a href="http://ec.europa.eu/eurostat/web/regions/data/database">separate database</a> . </p><br><p>  I am now downloading data on life expectancy in European countries, the <code>demo_mlexpec</code> code is <code>demo_mlexpec</code> . </p><br><pre> <code class="hljs lisp">library(<span class="hljs-name"><span class="hljs-name">tidyverse</span></span>) library(<span class="hljs-name"><span class="hljs-name">lubridate</span></span>) library(<span class="hljs-name"><span class="hljs-name">eurostat</span></span>) # download the selected dataset e0 &lt;- get_eurostat(<span class="hljs-string"><span class="hljs-string">"demo_mlexpec"</span></span>)</code> </pre> <br><p>  Downloading may take some time, depending on the amount of dataset.  In our case, we have a medium-sized set of 400K observations.  If for some reason it is impossible to download datasets automatically (I have never had one), you can manually download it from a separate Eurostat website <a href="http://ec.europa.eu/eurostat/estat-navtree-portlet-prod/BulkDownloadListing">Bulk Download Service</a> . </p><br><p>  Let's look at the residual life expectancy at the age of 65 years in some selected European countries, separately for men and women.  The age of 65 is the most common traditional retirement age.  Look at the residual life expectancy for this age in the dynamics is very interesting in light of the talk about the reforms of the retirement age.  From the downloaded data, we select only estimates of residual life expectancy at the age of 65, then we filter only estimates separately for men and women, finally, we leave only a few countries: Germany, France, Italy, Russia, Spain and the UK. </p><br><pre> <code class="hljs mel">e0 %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(! sex == <span class="hljs-string"><span class="hljs-string">"T"</span></span>, age == <span class="hljs-string"><span class="hljs-string">"Y65"</span></span>, geo %in% c(<span class="hljs-string"><span class="hljs-string">"DE"</span></span>, <span class="hljs-string"><span class="hljs-string">"FR"</span></span>, <span class="hljs-string"><span class="hljs-string">"IT"</span></span>, <span class="hljs-string"><span class="hljs-string">"RU"</span></span>, <span class="hljs-string"><span class="hljs-string">"ES"</span></span>, <span class="hljs-string"><span class="hljs-string">"UK"</span></span>)) %&gt;% ggplot(aes(x = time %&gt;% year(), y = values, <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> = sex))+ geom_path()+ facet_wrap(~ geo, ncol = <span class="hljs-number"><span class="hljs-number">3</span></span>)+ labs(y = <span class="hljs-string"><span class="hljs-string">"Life expectancy at age 65"</span></span>, x = NULL)+ theme_minimal(base_family = <span class="hljs-string"><span class="hljs-string">"mono"</span></span>)</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/zk/ji/vl/zkjivlpcbunfmnbdnyjhty9memy.png" alt="fig6"></a> </p><br><h1 id="world-bank">  World Bank </h1><br><p>  There are several packages that provide access to World Bank data from R. Probably the most finished one is pretty fresh <a href="https://cran.r-project.org/web/packages/wbstats/README.html"><code>wbstats</code></a> .  Its <code>wbsearch</code> function really does an excellent job with finding the relevant datasets.  For example, <code>wbsearch("fertility")</code> gives an explanatory list of 339 indicators in the form of a convenient table. </p><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(tidyverse) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(wbstats) # search <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a dataset <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> interest wbsearch(<span class="hljs-string"><span class="hljs-string">"fertility"</span></span>) %&gt;% head</code> </pre> <br><table><thead><tr><th></th><th>  indicatorID </th><th>  indicator </th></tr></thead><tbody><tr><td>  2479 </td><td>  SP.DYN.WFRT.Q5 </td><td>  Total wanted fertility rate (births per woman): Q5 (highest) </td></tr><tr><td>  2480 </td><td>  SP.DYN.WFRT.Q4 </td><td>  Total wanted fertility rate (births per woman): Q4 </td></tr><tr><td>  2481 </td><td>  SP.DYN.WFRT.Q3 </td><td>  Total wanted fertility rate (births per woman): Q3 </td></tr><tr><td>  2482 </td><td>  SP.DYN.WFRT.Q2 </td><td>  Total wanted fertility rate (births per woman): Q2 </td></tr><tr><td>  2483 </td><td>  SP.DYN.WFRT.Q1 </td><td>  Total wanted fertility rate (births per woman): Q1 (lowest) </td></tr><tr><td>  2484 </td><td>  SP.DYN.WFRT </td><td>  Wanted fertility rate (births per woman) </td></tr></tbody></table><br><p>  Let's look at the indicator <code>Lifetime risk of maternal death (%)</code> (code <code>SH.MMR.RISK.ZS</code> ) - the risk of death for a woman throughout her life associated with the birth of children.  The World Bank provides data by country, as well as several different groupings of countries.  One of the notable options for grouping is the separation according to the principle of completeness of the Demographic Transition.  Below I show the selected indicator for (1) countries that have already completed the CAP, (2) countries that have not yet completed the CAP, and (3) the world as a whole. </p><br><pre> <code class="hljs mel"># fetch the selected dataset df_wb &lt;- wb(indicator = <span class="hljs-string"><span class="hljs-string">"SH.MMR.RISK.ZS"</span></span>, startdate = <span class="hljs-number"><span class="hljs-number">2000</span></span>, enddate = <span class="hljs-number"><span class="hljs-number">2015</span></span>) # have look at the data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> one year df_wb %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">date</span></span> == <span class="hljs-number"><span class="hljs-number">2015</span></span>) %&gt;% View df_wb %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(iso2c %in% c(<span class="hljs-string"><span class="hljs-string">"V4"</span></span>, <span class="hljs-string"><span class="hljs-string">"V1"</span></span>, <span class="hljs-string"><span class="hljs-string">"1W"</span></span>)) %&gt;% ggplot(aes(x = <span class="hljs-keyword"><span class="hljs-keyword">date</span></span> %&gt;% as.numeric(), y = value, <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> = country))+ geom_path(<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ scale_color_brewer(NULL, palette = <span class="hljs-string"><span class="hljs-string">"Dark2"</span></span>)+ labs(x = NULL, y = NULL, title = <span class="hljs-string"><span class="hljs-string">"Lifetime risk of maternal death (%)"</span></span>)+ theme_minimal(base_family = <span class="hljs-string"><span class="hljs-string">"mono"</span></span>)+ theme(<span class="hljs-keyword"><span class="hljs-keyword">panel</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">grid</span></span>.minor = element_blank(), legend.position = c(<span class="hljs-number"><span class="hljs-number">.8</span></span>, <span class="hljs-number"><span class="hljs-number">.9</span></span>))</code> </pre><br><p> <a href=""><img src="https://habrastorage.org/webt/lt/g9/jd/ltg9jd9y-u3jritriywdy18no3u.png" alt="fig7"></a> </p><br><h1 id="oecd">  OECD </h1><br><p>  The Organization for Economic Cooperation and Development (OECD) publishes a lot of data on the economic and demographic development of member countries.  The <code>OECD</code> package greatly simplifies the use of this data in R. The <code>search_dataset</code> function <code>search_dataset</code> good job of finding the necessary data by keywords, and <code>get_dataset</code> loads the selected data.  In the following example, I download data on the duration of unemployment periods and display this data for the male population of EU16, EU28 and the United States using the heatmap visualization method. </p><br><pre> <code class="hljs pgsql">library(tidyverse) library(viridis) library(OECD) # <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> keyword search_dataset("unemployment") %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">View</span></span> # download the selected dataset df_oecd &lt;- get_dataset("AVD_DUR") # turn variable names <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> lowercase names(df_oecd) &lt;- names(df_oecd) %&gt;% tolower() df_oecd %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(country %<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>% c("EU16", "EU28", "USA"), sex == "MEN", ! age == "1524") %&gt;% ggplot(aes(obstime, age, fill = obsvalue))+ geom_tile()+ scale_fill_viridis("Months", <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> = "B")+ scale_x_discrete(breaks = seq(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">2015</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>) %&gt;% paste)+ facet_wrap(~ country, ncol = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ labs(x = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, y = "Age groups", title = "Average duration of unemployment in months, males")+ theme_minimal(base_family = "mono")</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/tm/ur/hr/tmurhrwje2dbvwvgpgaom9npoqe.png" alt="fig8"></a> </p><br><h1 id="wid">  Wid </h1><br><p>  <a href="http://wid.world/wid-world/">The World Wealth and Income Database</a> is a harmonized series of data on inequality in income and wealth.  The database developers took care of creating a special R package, which is currently available only on <a href="https://github.com/WIDworld/wid-r-tool">github</a> . </p><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(tidyverse) #install.packages(<span class="hljs-string"><span class="hljs-string">"devtools"</span></span>) devtools::install_github(<span class="hljs-string"><span class="hljs-string">"WIDworld/wid-r-tool"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(wid)</code> </pre> <br><p>  The function for downloading data is <code>download_wid()</code> .  In order to correctly specify the arguments for downloading data, you will have to dig into the package documentation a bit and understand the rather complex variable coding system. </p><br><pre> <code class="hljs">?wid_series_type ?wid_concepts</code> </pre> <br><p>  The given example is adapted from a <a href="https://github.com/WIDworld/wid-r-tool/raw/master/inst/doc/wid-demo.pdf">package vignette</a> .  It displays the share of wealth owned by the richest 1% and 10% of the population in France and the UK. </p><br><pre> <code class="hljs pgsql">df_wid &lt;- download_wid( indicators = "shweal", # Shares <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> personal wealth areas = c("FR", "GB"), # <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> France an Italy perc = c("p90p100", "p99p100") # Top <span class="hljs-number"><span class="hljs-number">1</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> top <span class="hljs-number"><span class="hljs-number">10</span></span>% ) df_wid %&gt;% ggplot(aes(x = year, y = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, color = country)) + geom_path()+ labs(title = "Top 1% and top 10% personal wealth shares in France and Great Britain", y = "top share")+ facet_wrap(~ percentile)+ theme_minimal(base_family = "mono")</code> </pre><br><p> <a href=""><img src="https://habrastorage.org/webt/j7/ky/2f/j7ky2frztcuk4ezrqnfw7z5kvrq.png" alt="fig9"></a> </p><br><h1 id="human-mortality-database">  Human mortality database </h1><br><p>  When it comes to checking the big questions about the laws of the dynamics of human populations, there is no more reliable source of information than the <a href="http://www.mortality.org/">Human Mortality Database</a> .  This database is developed and maintained by demographers who apply state-of-the-art methodology to harmonize source data.  <a href="http://www.mortality.org/Public/Docs/MethodsProtocol.pdf">The HMD Method Protocol</a> is a masterpiece of demographic data methodology.  The downside is that baseline data of sufficiently high quality are available only for a relatively small number of countries.  To familiarize myself with user-accessible data, I heartily recommend the [Human Mortality Database Explorer] [exp], created by <a href="https://twitter.com/jschoeley">Jonas Sch√∂ley</a> . </p><br><p>  Thanks to <a href="https://twitter.com/timriffe1">Tim Riffe</a> , we have the <code>HMDHFDplus</code> package, which allows you to load HMD data directly into R with just a few lines of code.  Please note that you will need a free <a href="http://www.mortality.org/">mortality.org</a> account to access the data.  As the name suggests, the package also allows you to download data from the equally beautiful <a href="http://www.humanfertility.org/">Human Fertility Database</a> . </p><br><p>  The example below is taken from my <a href="https://ikashnitsky.github.io/2017/hmd-all-sex-ratio/">previous post</a> and has been updated a little.  It seems to me that it illustrates well the power of automatic data download to R. Easily and naturally I download one-year age structures for all HMD countries for all available years, separately for women and men.  When playing this code, it is worth remembering that several tens of megabytes of data will be downloaded.  Next, I will calculate and map the sex ratio at all ages for all countries in 2012.  Sex ratios reflect two key demographic patterns: 1) more boys are always born;  2) male mortality is higher than female mortality at all ages.  Except for a few <a href="https://ikashnitsky.github.io/dem-digest/archive/2017/06/27/shi/">well-studied examples, the</a> sex ratio at birth is 105-106 boys per 100 girls.  Thus, significant differences in age profiles of the sex ratio reflect primarily gender differences in mortality. </p><br><pre> <code class="hljs mel"># load required packages library(HMDHFDplus) library(tidyverse) library(purrr) # <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> function to list the available countries country &lt;- getHMDcountries() # remove optional populations opt_pop &lt;- c(<span class="hljs-string"><span class="hljs-string">"FRACNP"</span></span>, <span class="hljs-string"><span class="hljs-string">"DEUTE"</span></span>, <span class="hljs-string"><span class="hljs-string">"DEUTW"</span></span>, <span class="hljs-string"><span class="hljs-string">"GBRCENW"</span></span>, <span class="hljs-string"><span class="hljs-string">"GBR_NP"</span></span>) country &lt;- country[!country %in% opt_pop] # temporary function to download HMD data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a simgle county (<span class="hljs-keyword"><span class="hljs-keyword">dot</span></span> = input) tempf_get_hmd &lt;- . %&gt;% readHMDweb(<span class="hljs-string"><span class="hljs-string">"Exposures_1x1"</span></span>, ik_user_hmd, ik_pass_hmd) # download the data iteratively <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> all countries using purrr::map() exposures &lt;- country %&gt;% map(tempf_get_hmd) # data transformation to apply to each county dataframe tempf_trans_data &lt;- . %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(Year, Age, Female, Male) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(Year %in% <span class="hljs-number"><span class="hljs-number">2012</span></span>) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(-Year) %&gt;% transmute(age = Age, ratio = Male / Female * <span class="hljs-number"><span class="hljs-number">100</span></span>) # perform transformation df_hmd &lt;- exposures %&gt;% map(tempf_trans_data) %&gt;% bind_rows(.id = <span class="hljs-string"><span class="hljs-string">"country"</span></span>) # summarize all ages older than <span class="hljs-number"><span class="hljs-number">90</span></span> (too jerky) df_hmd_90 &lt;- df_hmd %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(age %in% <span class="hljs-number"><span class="hljs-number">90</span></span>:<span class="hljs-number"><span class="hljs-number">110</span></span>) %&gt;% group_by(country) %&gt;% summarise(ratio = ratio %&gt;% mean(na.rm = T)) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">ungroup</span></span>() %&gt;% transmute(country, age = <span class="hljs-number"><span class="hljs-number">90</span></span>, ratio) # insert summarized <span class="hljs-number"><span class="hljs-number">90</span></span>+ df_hmd_fin &lt;- bind_rows(df_hmd %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(!age %in% <span class="hljs-number"><span class="hljs-number">90</span></span>:<span class="hljs-number"><span class="hljs-number">110</span></span>), df_hmd_90) # finaly - plot df_hmd_fin %&gt;% ggplot(aes(age, ratio, <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> = country, <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = country))+ geom_hline(yintercept = <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> = <span class="hljs-string"><span class="hljs-string">"grey50"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ geom_line(<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>)+ scale_y_continuous(limits = c(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>), expand = c(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), breaks = seq(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>))+ scale_x_continuous(limits = c(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>), expand = c(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), breaks = seq(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>))+ facet_wrap(~country, ncol = <span class="hljs-number"><span class="hljs-number">6</span></span>)+ theme_minimal(base_family = <span class="hljs-string"><span class="hljs-string">"mono"</span></span>, base_size = <span class="hljs-number"><span class="hljs-number">15</span></span>)+ theme(legend.position = <span class="hljs-string"><span class="hljs-string">"none"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">panel</span></span>.border = element_rect(<span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">.5</span></span>, fill = NA, <span class="hljs-keyword"><span class="hljs-keyword">color</span></span> = <span class="hljs-string"><span class="hljs-string">"grey50"</span></span>))+ labs(x = <span class="hljs-string"><span class="hljs-string">"Age"</span></span>, y = <span class="hljs-string"><span class="hljs-string">"Sex ratio, males per 100 females"</span></span>, title = <span class="hljs-string"><span class="hljs-string">"Sex ratio in all countries from Human Mortality Database"</span></span>, subtitle = <span class="hljs-string"><span class="hljs-string">"HMD 2012, via HMDHFDplus by @timriffe1"</span></span>, caption = <span class="hljs-string"><span class="hljs-string">"ikashnitsky.github.io"</span></span>)</code> </pre><br><p> <a href=""><img src="https://habrastorage.org/webt/qr/gs/ze/qrgszedql67hxhjf2hkeat2zhfm.png" alt="fig10"></a> </p><br><h1 id="united-nations-world-population-prospects">  United Nations World Population Prospects </h1><br><p>  The UN Population Department publishes high-quality estimates and population projections for all countries of the world.  Calculations are updated every 2-3 years and are published in the public domain as an interactive report <a href="https://esa.un.org/unpd/wpp/">World Population Prospects</a> .  These reports contain very general descriptive analysis and, of course, rich data.  The data is available in R in special packages that have names like <code>wpp20xx</code> .  To date, data is available for releases of 2008, 2010, 2012, 2015, and 2017.  Here I will give an example of using <code>wpp2015</code> data, taken from <a href="https://ikashnitsky.github.io/2017/global-male-life-expectancy-convergence/">my previous post</a> . </p><br><p>  Using the ridgeplot visualization type, which received viral popularity this summer (under the previous, <a href="http://serialmentor.com/blog/2017/9/15/goodbye-joyplots">now rejected</a> , <code>ggjoy</code> ) this summer thanks to the brilliant <code>ggridges</code> <a href="https://twitter.com/ClausWilke">Claus Wilke</a> package, I will show an impressive convergence of life expectancy at birth for men in the world since 1950. </p><br><pre> <code class="hljs pgsql">library(wpp2015) library(tidyverse) library(ggridges) library(viridis) # <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> the UN country names data(UNlocations) countries &lt;- UNlocations %&gt;% pull(<span class="hljs-type"><span class="hljs-type">name</span></span>) %&gt;% paste # data <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> male life expectancy at birth data(e0M) e0M %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>(country %<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>% countries) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(-last.observed) %&gt;% gather(period, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span>) %&gt;% ggplot(aes(x = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, y = period %&gt;% fct_rev()))+ geom_density_ridges(aes(fill = period))+ scale_fill_viridis(discrete = T, <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> = "B", direction = <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> = <span class="hljs-number"><span class="hljs-number">.1</span></span>, end = <span class="hljs-number"><span class="hljs-number">.9</span></span>)+ labs(x = "Male life expectancy at birth", y = "Period", title = "Global convergence in male life expectancy at birth since 1950", subtitle = "UNPD World Population Prospects 2015 Revision, via wpp2015", caption = "ikashnitsky.github.io")+ theme_minimal(base_family = "mono")+ theme(legend.position = "none")</code> </pre><br><p> <a href=""><img src="https://habrastorage.org/webt/tb/hv/id/tbhvid6d8oopnz506vspsfoscfq.png" alt="fig11"></a> </p><br><h1 id="european-social-survey-ess">  European Social Survey (ESS) </h1><br><p>  <a href="http://www.europeansocialsurvey.org/about/">The European Social Survey</a> publishes uniquely detailed data on European values, representative at country level and comparable across countries.  Every two years, another wave of surveys is conducted in each of the participating countries.  Data is available after <a href="http://www.europeansocialsurvey.org/user/new">free registration</a> .  Datasets are distributed in finished form for analysis using SAS, SPSS, or STATA.  Thanks to <a href="https://twitter.com/cimentadaj">Jorge Cimentada,</a> we now have the opportunity to get this data in ready form and in R using the <code>ess</code> package.  I will show how respondents assessed their level of trust in local police in all countries that participated in the latest survey wave. </p><br><pre> <code class="hljs mel">library(ess) library(tidyverse) # <span class="hljs-keyword"><span class="hljs-keyword">help</span></span> gunction to see the available countries show_countries() # check the available rounds <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> a selected country show_country_rounds(<span class="hljs-string"><span class="hljs-string">"Netherlands"</span></span>) # get the full dataset of the last (<span class="hljs-number"><span class="hljs-number">8</span></span>) round df_ess &lt;- ess_rounds(<span class="hljs-number"><span class="hljs-number">8</span></span>, your_email = ik_email) # <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> a variable and calculate mean value df_ess_select &lt;- df_ess %&gt;% bind_rows() %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(idno, cntry, trstplc) %&gt;% group_by(cntry) %&gt;% mutate(avg = trstplc %&gt;% mean(na.rm = T)) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">ungroup</span></span>() %&gt;% mutate(cntry = cntry %&gt;% as_factor() %&gt;% fct_reorder(avg)) df_ess_select %&gt;% ggplot(aes(trstplc, fill = avg))+ geom_histogram()+ scale_x_continuous(limits = c(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>), breaks = seq(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>))+ scale_fill_gradient(<span class="hljs-string"><span class="hljs-string">"Average\ntrust\nscore"</span></span>, low = <span class="hljs-string"><span class="hljs-string">"black"</span></span>, high = <span class="hljs-string"><span class="hljs-string">"aquamarine"</span></span>)+ facet_wrap(~cntry, ncol = <span class="hljs-number"><span class="hljs-number">6</span></span>)+ theme_minimal(base_family = <span class="hljs-string"><span class="hljs-string">"mono"</span></span>)+ labs(x = <span class="hljs-string"><span class="hljs-string">"Trust score [0 -- 10]"</span></span>, y = <span class="hljs-string"><span class="hljs-string">"# of respondents"</span></span>, title = <span class="hljs-string"><span class="hljs-string">"Trust in police"</span></span>, subtitle = <span class="hljs-string"><span class="hljs-string">"ESS wave 8 2017, via ess by @cimentadaj"</span></span>, caption = <span class="hljs-string"><span class="hljs-string">"ikashnitsky.github.io"</span></span>)</code> </pre><br><p> <a href=""><img src="https://habrastorage.org/webt/pu/j8/oy/puj8oyqu-rcaotn5nq2wwvklg3w.png" alt="fig12"></a> </p><br><h1 id="american-community-survey-and-census">  American Community Survey and Census </h1><br><p>  Immediately, several packages provide access to US census data and regular household sample surveys (American Community Survey).  Probably the most beautiful implementation created recently by <a href="https://twitter.com/kyle_e_walker">Kyle Walker</a> - <code>tidycensus</code> .  The Kill-feature of this package is the ability to download spatial data along with statistical data.  Spatial data is downloaded as simple features, a revolutionary approach to geodata in R, recently introduced in the <code>sf</code> <a href="https://twitter.com/edzerpebesma">Edzer Pebesma package</a> .  This approach will accelerate the processing of a few dozen times, while simplifying the code to impossibility.  But the details - in the final post of the series.  Please note that in order to render simple features we need to install the development version of the <code>ggplot2</code> package. </p><br><p>  The map below shows the median age of the population in the census trails of the city of Chicago according to ACS data for 2015.  To extract this data using <code>tidycensus</code> will first need to get an API key, which can be easily done when registering <a href="https://api.census.gov/data/key_signup.html">here</a> . </p><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(tidycensus) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(tidyverse) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(viridis) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(janitor) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(sf) # <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> geom_sf we need the latest development version <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ggplot2 devtools::install_github(<span class="hljs-string"><span class="hljs-string">"tidyverse/ggplot2"</span></span>, <span class="hljs-string"><span class="hljs-string">"develop"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">library</span></span>(ggplot2) # you need a personal API key, available free at # https://api.census.gov/data/key_signup.html # normally, this key <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be stored <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> .Renviron # see state <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> county codes <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> names fips_codes %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">View</span></span> # the available variables load_variables(year = <span class="hljs-number"><span class="hljs-number">2015</span></span>, dataset = <span class="hljs-string"><span class="hljs-string">"acs5"</span></span>) %&gt;% <span class="hljs-keyword"><span class="hljs-keyword">View</span></span> # data <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> median age <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> population <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Chicago df_acs &lt;- get_acs( geography = <span class="hljs-string"><span class="hljs-string">"tract"</span></span>, county = <span class="hljs-string"><span class="hljs-string">"Cook County"</span></span>, state = <span class="hljs-string"><span class="hljs-string">"IL"</span></span>, variables = <span class="hljs-string"><span class="hljs-string">"B01002_001E"</span></span>, year = <span class="hljs-number"><span class="hljs-number">2015</span></span>, key = ik_api_acs, geometry = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> ) %&gt;% clean_names() # <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> the data df_acs %&gt;% ggplot()+ geom_sf(aes(fill = estimate %&gt;% cut(breaks = seq(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>))), color = NA)+ scale_fill_viridis_d(<span class="hljs-string"><span class="hljs-string">"Median age"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> = .<span class="hljs-number"><span class="hljs-number">4</span></span>)+ coord_sf(datum = NA)+ theme_void(base_family = <span class="hljs-string"><span class="hljs-string">"mono"</span></span>)+ theme(legend.position = c(.<span class="hljs-number"><span class="hljs-number">15</span></span>, .<span class="hljs-number"><span class="hljs-number">15</span></span>))+ labs(title = <span class="hljs-string"><span class="hljs-string">"Median age of population in Chicago\nby census tracts\n"</span></span>, subtitle = <span class="hljs-string"><span class="hljs-string">"ACS 2015, via tidycensus by @kyle_e_walker"</span></span>, caption = <span class="hljs-string"><span class="hljs-string">"ikashnitsky.github.io"</span></span>, x = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, y = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>)</code> </pre> <br><p> <a href=""><img src="https://habrastorage.org/webt/yn/nj/td/ynnjtdwaulcvcqagyrvehc-ynda.png" alt="fig13"></a> </p><br><hr><br><h1 id="priyatnyh-vam-puteshestviy-v-mir-otkrytyh-dannyh-s-r">  Enjoy your journey to the world of open data with R! </h1></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/345664/">https://habr.com/ru/post/345664/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345654/index.html">Happy semi-final stories about the automation of test schemes</a></li>
<li><a href="../345656/index.html">We try q-learning to taste, the story in three parts</a></li>
<li><a href="../345658/index.html">Why does it seem to me that students are learning OOP wrong</a></li>
<li><a href="../345660/index.html">Magic CharSequence</a></li>
<li><a href="../345662/index.html">How to replace HR-a with a robot?</a></li>
<li><a href="../345666/index.html">My first job</a></li>
<li><a href="../345668/index.html">A bit about IT in New Zealand</a></li>
<li><a href="../345670/index.html">JetBrains CLion for microcontrollers</a></li>
<li><a href="../345672/index.html">Search under the hood Chapter 1. Network spider</a></li>
<li><a href="../345674/index.html">Product Design Digest, December 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>