<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Traefik as Ingress Controller for K8S</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It's no secret that K8S has a great community and generally good documentation. In it you can easily find the answer to many questions. But like any o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Traefik as Ingress Controller for K8S</h1><div class="post__text post__text-html js-mediator-article"><p>  It's no secret that K8S has a great community and generally good documentation.  In it you can easily find the answer to many questions.  But like any other documentation, it cannot cover absolutely everything.  In this article I will try to provide detailed instructions on how to deploy and configure <a href="https://traefik.io/">Traefik</a> for use as an Ingress controller. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a67/33f/efa/a6733fefa71e9bcd0ff99b50c779abf6.png" alt="image"></p><a name="habracut"></a><br><h3 id="chto-takoe-ingress">  What is Ingress? </h3><br><p> Ingress is an API object that manages outbound access to services in a cluster, mainly via HTTP / HTTPS.  In order for the Ingress resource to work, you need an Ingress controller.  If you are using GCE, the Ingress controller is already deployed to the wizard.  However, if you have loaded the cluster yourself, for example from <code>kops</code> to AWS, you need to deploy the Ingress controller yourself.  On minikube, this is solved by including the Ingress add-in. </p><br><h3 id="ingress-kontrollery">  Ingress controllers </h3><br><p>  The role of the Ingress Controller can be performed by NGINX Ingress Controller, Kong, Octavia Ingress Controller, etc. In this article, we will look at tools like Traefik and see how you can use it as an Ingress Controller for services in a cluster. </p><br><h3 id="zachem">  What for? </h3><br><p>  Why use the Ingress controller if you can provide access to each service through <code>NodePort</code> or <code>LoadBalancer</code> ?  In short, it allows you to get one central point for proxying all traffic.  That is, using the Ingress controller, you only need one LoadBalancer for Traefik and nothing else.  This bundle will resolve all traffic. </p><br><h3 id="traefik-komponenty">  Traefik components </h3><br><p>  Traefik announced support for Kubernetes Ingress in version 1.4.  However, the recently released Traefik 1.7 has a <code>publishedService,</code> option that can update the <code>status</code> field in Ingress, which was not the case in previous versions.  Below is a list of components that will be required for work. </p><br><p>  <strong>Create:</strong> </p><br><ul><li>  namespace </li><li>  service account </li><li>  TLS secret </li><li>  cluster role </li><li>  cluster role binding </li><li>  configmap </li><li>  deployment </li><li>  service for http and https </li><li>  service for Traefik dashboard </li><li>  Ingress </li></ul><br><p>  <strong>Namespace</strong> </p><br><p>  Create a namespace: </p><br><pre> <code class="hljs cs">kubectl create <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">traefik</span></span></code> </pre> <br><p>  <strong>Tls secret</strong> </p><br><p>  <em>(note. Trans. - in the example below, the author for some reason duplicates the same config, the actual config, see the README-file, presented at the link below)</em> </p><br><p>  First create a certificate: </p><br><pre> <code class="hljs objectivec">openssl req -x509 -nodes -days <span class="hljs-number"><span class="hljs-number">365</span></span> -newkey rsa:<span class="hljs-number"><span class="hljs-number">2048</span></span> -keyout ./tls.key -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> ./tls.crt -subj <span class="hljs-string"><span class="hljs-string">"/CN=*.example.com"</span></span></code> </pre> <br><p>  Create a TLS certificate: </p><br><pre> <code class="hljs objectivec">openssl req -x509 -nodes -days <span class="hljs-number"><span class="hljs-number">365</span></span> -newkey rsa:<span class="hljs-number"><span class="hljs-number">2048</span></span> -keyout ./tls.key -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> ./tls.crt -subj <span class="hljs-string"><span class="hljs-string">"/CN=*.example.com"</span></span></code> </pre> <br><p>  Create Secret: </p><br><pre> <code class="hljs pgsql">kubectl <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> secret tls traefik-ui-tls-cert <span class="hljs-comment"><span class="hljs-comment">--key ./tls.key --cert ./tls.crt</span></span></code> </pre> <br><p>  For convenience, I made a README file with these commands and uploaded it to <a href="">my GitHub</a> . </p><br><p>  <strong>ConfigMap</strong> </p><br><pre> <code class="hljs kotlin">--- apiVersion: v1 kind: ConfigMap metadata: name: traefik-configmap namespace: traefik <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: traefik.toml: | defaultEntryPoints = [<span class="hljs-string"><span class="hljs-string">"http"</span></span>,<span class="hljs-string"><span class="hljs-string">"https"</span></span>] [entryPoints] [entryPoints.http] address = <span class="hljs-string"><span class="hljs-string">":80"</span></span> [entryPoints.https] address = <span class="hljs-string"><span class="hljs-string">":443"</span></span> [entryPoints.https.tls] [[entryPoints.https.tls.certificates]] CertFile = <span class="hljs-string"><span class="hljs-string">"/ssl/tls.crt"</span></span> KeyFile = <span class="hljs-string"><span class="hljs-string">"/ssl/tls.key"</span></span> [entryPoints.traefik] address = <span class="hljs-string"><span class="hljs-string">":8080"</span></span> [entryPoints.traefik.auth.basic] users = [<span class="hljs-string"><span class="hljs-string">"admin:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$apr1</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$zjjGWKW4</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$W2JIcu4m26WzOzzESDF0W</span></span></span><span class="hljs-string">/"</span></span>] [kubernetes] [kubernetes.ingressEndpoint] publishedService = <span class="hljs-string"><span class="hljs-string">"traefik/traefik"</span></span> [ping] entryPoint = <span class="hljs-string"><span class="hljs-string">"http"</span></span> [api] entryPoint = <span class="hljs-string"><span class="hljs-string">"traefik"</span></span></code> </pre> <br><p>  By default, the EntryPoints are ports <code>80</code> and <code>443</code> . </p><br><p>  EntryPoint <code>http</code> listens <code>:80</code> and has no additional rules </p><br><p>  EntryPoint <code>https</code> listens to <code>:443</code> and contains a rule for connecting TLS certificates. </p><br><p>  EntryPoint <code>traefik</code> listens <code>:8080</code> and uses basic-authentication.  The username is <code>admin</code> , the password is <code>admin</code> . </p><br><p>  Determining the corresponding endpoint Ingress in Kubernetes is done by setting the <code>publishService</code> and must consist of the <code>namespace</code> value and the <code>service</code> name for Traefik.  In this case, it is <code>traefik / traefik</code> . </p><br><p>  <code>ping</code> or health checks will use entryPoint <code>http</code> . </p><br><p>  <code>api</code> or dashboard / ui will use the entryPoint <code>traefik</code> . </p><br><p>  Please note that you can define additional entryPoints with an indication of the port.  This port can proxy traffic to any port, instead of dynamic ports and <code>NodePort</code> . </p><br><p>  <strong>ClusterRole</strong> </p><br><p>  The service account for Traefik must have permission to update the <code>Ingress status</code> field.  This is an important parameter, and it is not yet presented in the <a href="https://docs.traefik.io/user-guide/kubernetes/">official documentation of Traefik</a> : </p><br><pre> <code class="hljs swift">--- kind: <span class="hljs-type"><span class="hljs-type">ClusterRole</span></span> apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: traefik-ingress-controller rules: - apiGroups: - <span class="hljs-string"><span class="hljs-string">""</span></span> resources: - services - endpoints - secrets verbs: - <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> - list - watch - apiGroups: - extensions resources: - ingresses verbs: - <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> - list - watch - apiGroups: - extensions resources: - ingresses/status verbs: - update</code> </pre> <br><p>  The last 6 lines are very important for correct operation. </p><br><p>  <strong>Deployment</strong> </p><br><p>  Deployment is pretty simple and straightforward.  Let's take a quick look at the main blocks: </p><br><pre> <code class="hljs pgsql">volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: traefik-ui-tls-cert secret: secretName: traefik-ui-tls-cert - <span class="hljs-type"><span class="hljs-type">name</span></span>: traefik-configmap configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: traefik-configmap</code> </pre> <br><p>  Define <code>volumes</code> for ConfigMap and Secret, which can then be used in <code>volumeMounts</code> . </p><br><pre> <code class="hljs pgsql">volumeMounts: - mountPath: "/ssl" <span class="hljs-type"><span class="hljs-type">name</span></span>: "traefik-ui-tls-cert" - mountPath: "/config" <span class="hljs-type"><span class="hljs-type">name</span></span>: "traefik-configmap"</code> </pre> <br><p>  A health check is performed on port 80, as defined in the ConfigMap. </p><br><p>  Open the ports for all entryPoints specified in the configuration file: </p><br><pre> <code class="hljs pgsql">ports: - <span class="hljs-type"><span class="hljs-type">name</span></span>: http containerPort: <span class="hljs-number"><span class="hljs-number">80</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: https containerPort: <span class="hljs-number"><span class="hljs-number">443</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: dashboard containerPort: <span class="hljs-number"><span class="hljs-number">8080</span></span></code> </pre> <br><p>  I remind you that some examples and documentation on the Internet are outdated, so do not miss the <code>args</code> section, which is necessary for Traefik to work: </p><br><pre> <code class="hljs pgsql">args: - <span class="hljs-comment"><span class="hljs-comment">--logLevel=INFO - --configfile=/config/traefik.toml</span></span></code> </pre> <br><p>  Do not pass additional flags and arguments, such as -api, -ping, or -kubernetes, because this will override the settings specified in the config file. </p><br><p>  <strong>Service</strong> </p><br><p>  The first of the services defines Loadbalancer for entryPoints <code>http</code> and <code>https</code> .  If you look at the Security Group (Ingress) for LoadBalancer, you will see ports 80 and 443 are open there. K8s will create LoadBalancer and connect to the nodes that Traefik is running on.  If you want to create an internal ELB, like me, you need to define annotations: </p><br><pre> <code class="hljs delphi">--- kind: Service apiVersion: v1 metadata: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: traefik namespace: traefik annotations: <span class="hljs-comment"><span class="hljs-comment">{}</span></span> # service.beta.kubernetes.io/aws-load-balancer-internal: <span class="hljs-number"><span class="hljs-number">0.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> spec: selector: k8s-app: traefik-ingress ports: - protocol: TCP port: <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: http - protocol: TCP port: <span class="hljs-number"><span class="hljs-number">443</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: https <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: LoadBalancer</code> </pre> <br><p>  <strong>Service (for Dashboard)</strong> </p><br><p>  Now the fun part!  Since Dashboard uses basic authentication, I needed <code>https</code> .  To use SSL, we need to redirect traffic to the port <code>:8080</code> , on which the Dashboard runs.  As you can see, it is very simple.  All the magic happens in Ingress. </p><br><pre> <code class="hljs delphi">--- kind: Service apiVersion: v1 metadata: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: traefik-dashboard namespace: traefik spec: selector: k8s-app: traefik-ingress ports: - port: <span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: dashboard</code> </pre> <br><p>  <strong>Ingress (for Dashboard)</strong> </p><br><p>  The magic lies in the fact that proxying protected traffic to the Dashboard is done through Traefik itself.  Traefik in Ingress is <a href="https://docs.traefik.io/configuration/backends/kubernetes/">managed</a> using <a href="https://docs.traefik.io/configuration/backends/kubernetes/">Traefik annotations</a> : </p><br><pre> <code class="hljs swift">--- apiVersion: extensions/v1beta1 kind: <span class="hljs-type"><span class="hljs-type">Ingress</span></span> metadata: name: traefik-dashboard-ingress namespace: traefik annotations: kubernetes.io/ingress.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: traefik traefik.ingress.kubernetes.io/frontend-entry-points: http,https traefik.ingress.kubernetes.io/redirect-entry-point: https traefik.ingress.kubernetes.io/redirect-permanent: <span class="hljs-string"><span class="hljs-string">"true"</span></span> spec: rules: - host: traefik-ui.example.com http: paths: - path: / backend: serviceName: traefik-dashboard servicePort: <span class="hljs-number"><span class="hljs-number">8080</span></span></code> </pre> <br><p>  It took only 4 simple and understandable annotations. </p><br><p>  Of course, to be fully operational, you need to create a <code>traefik-ui.example.com</code> DNS record that points to your ELB. </p><br><p>  Would it be great if this (automatic translation of the DNS records) was done automatically?  Not a problem, I will write about the automatic creation of DNS-records in the next article. </p><br><p>  <strong>Links</strong> </p><br><p>  Ready deployment.yaml file can be downloaded in my <a href="https://github.com/dusansusic/kubernetes-traefik">Github repository</a> .  If during the setup process you have any difficulties, do not hesitate to ask. </p><br><h3 id="naputstvie-ot-perevodchika">  Parting words from the translator </h3><br><p>  Read other articles on our blog: </p><br><p>  <a href="https://habr.com/company/nixys/blog/426543/">Stateful backups in Kubernetes</a> </p><br><p>  <a href="https://habr.com/company/nixys/blog/424717/">Backup a large number of heterogeneous web-projects</a> </p><br><p>  <a href="https://habr.com/company/nixys/blog/347526/">Telegram-bot for Redmine.</a>  <a href="https://habr.com/company/nixys/blog/347526/">How to simplify the life of yourself and people</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/427655/">https://habr.com/ru/post/427655/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427643/index.html">Russian telecom operators have begun testing NB-IoT SIM cards for the Internet of Things</a></li>
<li><a href="../427645/index.html">Review of presentations of the sixth industrial cyber security conference (Sochi, 09.19.09.2018)</a></li>
<li><a href="../427647/index.html">Tesla (TSLA) report for the 3rd quarter of 2018</a></li>
<li><a href="../427649/index.html">Cooking Matrix at home</a></li>
<li><a href="../427653/index.html">Share and Conquer: Layout Layout Then and Now</a></li>
<li><a href="../427657/index.html">Using the Animation Inspector in Chrome Developer Tools</a></li>
<li><a href="../427661/index.html">Sportiduino - the system of electronic mark for sports, part 3</a></li>
<li><a href="../427663/index.html">Frog bears and crab</a></li>
<li><a href="../427665/index.html">The best smart scales (according to Wareable)</a></li>
<li><a href="../427669/index.html">KNX home control: lighting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>