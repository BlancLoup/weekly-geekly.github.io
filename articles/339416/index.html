<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android and sound: how to do it right</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses the architecture and API for building music-playing applications. We will write a simple application that will play a small pre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android and sound: how to do it right</h1><div class="post__text post__text-html js-mediator-article"><p>  <em>This article discusses the architecture and API for building music-playing applications.</em>  <em>We will write a simple application that will play a small predetermined playlist, but ‚Äúin an adult way‚Äù - using officially recommended practices.</em>  <em>We will use MediaSession and MediaController to organize a single access point to the media player, and MediaBrowserService to support Android Auto.</em>  <em>And also we will stipulate a number of steps which are obligatory if we do not want to cause hatred of the user.</em> </p><a name="habracut"></a><br><p>  In the first approximation, the task looks simple: in the activity we create the MediaPlayer, when you click the Play button, we start playback, and Stop - we stop it.  Everything works fine until the user exits the activity.  The obvious solution would be to transfer MediaPlayer to the service.  However, now we have questions of organizing access to the player from the UI.  We will have to implement a binded service, come up with an API for it that would allow us to control the player and receive events from it.  But this is only half the battle: no one except us knows the service API, respectively, our activity will be the only means of control.  The user will have to go into the application and click Pause if he wants to call.  Ideally, we need a unified way to tell Android that our application is a player, it can be controlled, and that we are currently playing such and such a track from such and such an album.  So that the system on its part helps us with UI.  Lollipop (API 21) introduced such a mechanism in the form of MediaSession and MediaController classes.  A little later in the support library appeared their twins MediaSessionCompat and MediaControllerCompat. </p><br><p>  It should be immediately noted that the MediaSession is not related to sound reproduction, it is only about managing the player and its metadata. </p><br><p>  <strong>Media session</strong> </p><br><p>  So, we create an instance of <a href="https://developer.android.com/reference/android/media/session/MediaSession.html">MediaSession</a> in the service, fill it with information about our player, its status and give <a href="https://developer.android.com/reference/android/media/session/MediaSession.Callback.html">MediaSession.Callback</a> , which defines the methods onPlay, onPause, onStop, onSkipToNext and others.  In these methods we put the control code MediaPlayer (in the example we will use <a href="https://developer.android.com/guide/topics/media/exoplayer.html">ExoPlayer</a> ).  Our goal is that the events from the hardware buttons, and from the lock window, and from the clock under Android Wear cause these methods. </p><br><p>  Fully working code is available on <a href="https://github.com/SergeyVinyar/AndroidAudioExample/tree/master">GitHub</a> (master branch).  The articles are only recycled excerpts from it. </p><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//   // ...  final MediaMetadataCompat.Builder metadataBuilder = new MediaMetadataCompat.Builder(); // ...  //    ,     . // ,     ACTION_PAUSE, //       onPause. // ACTION_PLAY_PAUSE ,     //   Android Wear! final PlaybackStateCompat.Builder stateBuilder = new PlaybackStateCompat.Builder() .setActions( PlaybackStateCompat.ACTION_PLAY | PlaybackStateCompat.ACTION_STOP | PlaybackStateCompat.ACTION_PAUSE | PlaybackStateCompat.ACTION_PLAY_PAUSE | PlaybackStateCompat.ACTION_SKIP_TO_NEXT | PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS); MediaSessionCompat mediaSession; @Override public void onCreate() { super.onCreate(); // "PlayerService" -  tag   mediaSession = new MediaSessionCompat(this, "PlayerService"); // FLAG_HANDLES_MEDIA_BUTTONS -       // (, ) // FLAG_HANDLES_TRANSPORT_CONTROLS -      //    mediaSession.setFlags( MediaSessionCompat.FLAG_HANDLES_MEDIA_BUTTONS | MediaSessionCompat.FLAG_HANDLES_TRANSPORT_CONTROLS); //    mediaSession.setCallback(mediaSessionCallback); Context appContext = getApplicationContext() //  activity,   ,   //     Intent activityIntent = new Intent(appContext, MainActivity.class); mediaSession.setSessionActivity( PendingIntent.getActivity(appContext, 0, activityIntent, 0)); } @Override public void onDestroy() { super.onDestroy(); //    mediaSession.release(); } MediaSessionCompat.Callback mediaSessionCallback = new MediaSessionCompat.Callback() { @Override public void onPlay() { MusicRepository.Track track = musicRepository.getCurrent(); //     MediaMetadataCompat metadata = metadataBuilder .putBitmap(MediaMetadataCompat.METADATA_KEY_ART, BitmapFactory.decodeResource(getResources(), track.getBitmapResId())); .putString(MediaMetadataCompat.METADATA_KEY_TITLE, track.getTitle()); .putString(MediaMetadataCompat.METADATA_KEY_ALBUM, track.getArtist()); .putString(MediaMetadataCompat.METADATA_KEY_ARTIST, track.getArtist()); .putLong(MediaMetadataCompat.METADATA_KEY_DURATION, track.getDuration()) .build(); mediaSession.setMetadata(metadata); // ,         //        mediaSession.setActive(true); //    mediaSession.setPlaybackState( stateBuilder.setState(PlaybackStateCompat.STATE_PLAYING, PlaybackStateCompat.PLAYBACK_POSITION_UNKNOWN, 1).build()); //  URL -  ExoPlayer prepareToPlay(track.getUri()); //   exoPlayer.setPlayWhenReady(true); } @Override public void onPause() { //   exoPlayer.setPlayWhenReady(false); //    mediaSession.setPlaybackState( stateBuilder.setState(PlaybackStateCompat.STATE_PAUSED, PlaybackStateCompat.PLAYBACK_POSITION_UNKNOWN, 1).build()); } @Override public void onStop() { //   exoPlayer.setPlayWhenReady(false); // ,    "" ,    mediaSession.setActive(false); //    mediaSession.setPlaybackState( stateBuilder.setState(PlaybackStateCompat.STATE_STOPPED, PlaybackStateCompat.PLAYBACK_POSITION_UNKNOWN, 1).build()); } }</span></span></code> </pre> <br><p>  A token is required for external access to the MediaSession.  To do this, teach the service to give it. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IBinder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PlayerServiceBinder(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerServiceBinder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Binder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MediaSessionCompat.<span class="hljs-function"><span class="hljs-function">Token </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMediaSessionToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mediaSession.getSessionToken(); } }</code> </pre> <br><p>  and write in the manifest </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".service.PlayerService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <strong>MediaController</strong> </p><br><p>  Now let's implement the activity with control buttons.  We create an instance of <a href="https://developer.android.com/reference/android/widget/MediaController.html">MediaController</a> and pass to the constructor the token received from the service. </p><br><p>  MediaController provides both play, pause, stop player control methods, and onPlaybackStateChanged (PlaybackState state) and onMetadataChanged (MediaMetadata metadata) callbacks.  Multiple MediaControllers can connect to the same MediaSession, so you can easily ensure the consistency of button states in all windows. </p><br><pre> <code class="java hljs">PlayerService.PlayerServiceBinder playerServiceBinder; MediaControllerCompat mediaController; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_main); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Button playButton = (Button) findViewById(R.id.play); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Button pauseButton = (Button) findViewById(R.id.pause); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Button stopButton = (Button) findViewById(R.id.stop); bindService(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, PlayerService.class), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceConnection() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ComponentName name, IBinder service)</span></span></span><span class="hljs-function"> </span></span>{ playerServiceBinder = (PlayerService.PlayerServiceBinder) service; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mediaController = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaControllerCompat( MainActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, playerServiceBinder.getMediaSessionToken()); mediaController.registerCallback( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaControllerCompat.Callback() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPlaybackStateChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PlaybackStateCompat state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> playing = state.getState() == PlaybackStateCompat.STATE_PLAYING; playButton.setEnabled(!playing); pauseButton.setEnabled(playing); stopButton.setEnabled(playing); } } ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RemoteException e) { mediaController = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceDisconnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ComponentName name)</span></span></span><span class="hljs-function"> </span></span>{ playerServiceBinder = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; mediaController = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }, BIND_AUTO_CREATE); playButton.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mediaController != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) mediaController.getTransportControls().play(); } }); pauseButton.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mediaController != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) mediaController.getTransportControls().pause(); } }); stopButton.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mediaController != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) mediaController.getTransportControls().stop(); } }); }</code> </pre> <br><p>  Our activity is working, but the idea was originally, so that you could also manage from the blocking window.  And here we come to an important point: API 21 completely redesigned the blocking window, now there are displayed notifications and player control buttons must be done through notifications.  We will come back to this later, let's look at the old lock window for now. </p><br><p>  As soon as we call mediaSession.setActive (true), the system magically joins MediaSession without any tokens and shows control buttons against the background of the image from the metadata. </p><br><p>  However, for historical reasons, the events on the press of buttons come not directly to the MediaSession, but in the form of broadcasts.  Accordingly, we still need to subscribe to these broadcasts and transfer them to the MediaSession. </p><br><p>  <strong>MediaButtonReceiver</strong> </p><br><p>  For this, Android developers kindly offer us to use MediaButtonReceiver, a ready-made receiver. </p><br><p>  Add it to the manifest </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.support.v4.media.session.MediaButtonReceiver"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.MEDIA_BUTTON"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  When receiving an event, MediaButtonReceiver looks for a service in the application, which also accepts "android.intent.action.MEDIA_BUTTON" and redirects it there.  Therefore, we will add a similar content filter to the service. </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".service.PlayerService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.MEDIA_BUTTON"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  If a suitable service is not found or there are several of them, IllegalStateException will be thrown. </p><br><p>  Now add to the service </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startId)</span></span></span><span class="hljs-function"> </span></span>{ MediaButtonReceiver.handleIntent(mediaSession, intent); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onStartCommand(intent, flags, startId); }</code> </pre> <br><p>  The handleIntent method analyzes the button codes from the intent and calls the corresponding callbacks in the mediaSession.  It turned out a little dancing with a tambourine, but almost without writing code. </p><br><p>  On systems with API&gt; = 21, the system does not use broadcasts to send button press events and instead directly calls MediaSession.  However, if our MediaSession is inactive (setActive (false)), it will be awakened by Broadcast.  And in order for this mechanism to work, you need to inform the MediaSession which receiver to send broadcasts to. <br>  Add to onCreate service </p><br><pre> <code class="java hljs">Intent mediaButtonIntent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent( Intent.ACTION_MEDIA_BUTTON, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, appContext, MediaButtonReceiver.class); mediaSession.setMediaButtonReceiver( PendingIntent.getBroadcast(appContext, <span class="hljs-number"><span class="hljs-number">0</span></span>, mediaButtonIntent, <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br><p>  On systems with an API &lt;21, the setMediaButtonReceiver method does nothing. </p><br><p>  OK well.  We start, go to the blocking window and ... there is nothing.  Because we forgot an important point, without which nothing works, - getting audiofocus. </p><br><p>  <strong>Audiofocus</strong> </p><br><p>  There is always the possibility that several applications will want to simultaneously play the sound.  Or received an incoming call and urgently need to stop the music.  In order to solve these problems, the <a href="https://developer.android.com/reference/android/media/AudioManager.html">AudioManager</a> system service included the ability to request audio focus.  Audiofocus is the right to play the sound and is issued only to one application at a time.  If the application is denied the provision of audiofocus or was taken away later, the sound should be stopped.  As a rule, focus is always provided, that is, when an application is pressed to play, all other applications are silent.  An exception happens only during an active telephone conversation.  Technically, no one forces us to receive focus, but we do not want to annoy the user?  Well, plus the blocking window ignores applications without audiofocus. <br>  Focus must be requested in onPlay () and released in onStop (). </p><br><p>  Get AudioManager in onCreate </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); audioManager = (AudioManager) getSystemService(Context.AUDIO_SERVICE); ... }</code> </pre> <br><p>  We request focus on onPlay </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPlay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> audioFocusResult = audioManager.requestAudioFocus( audioFocusChangeListener, AudioManager.STREAM_MUSIC, AudioManager.AUDIOFOCUS_GAIN); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (audioFocusResult != AudioManager.AUDIOFOCUS_REQUEST_GRANTED) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       setActive! mediaSession.setActive(true); ... }</span></span></code> </pre> <br><p>  And free in onStop </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... audioManager.abandonAudioFocus(audioFocusChangeListener); ... }</code> </pre> <br><p>  When requesting focus, we gave a callback. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AudioManager.OnAudioFocusChangeListener audioFocusChangeListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AudioManager.OnAudioFocusChangeListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAudioFocusChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusChange)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (focusChange) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> AudioManager.AUDIOFOCUS_GAIN: <span class="hljs-comment"><span class="hljs-comment">//  . // ,        . //  ,    //    . mediaSessionCallback.onPlay(); break; case AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK: //  ,   -   //  "". // ,       // " 50   ". //        , //    . //      , //    ,     . mediaSessionCallback.onPause(); break; default: //   . mediaSessionCallback.onPause(); break; } } };</span></span></code> </pre> <br><p>  That's it, now the lockout window on systems with API &lt;21 is working. </p><br><div class="spoiler">  <b class="spoiler_title">So it looks</b> <div class="spoiler_text"><p>  Android 4.4 <br><img src="https://habrastorage.org/webt/59/d7/74/59d77483b52cd276955901.png" alt="Android 4.4"></p><br><p>  MIUI 8 (based on Android 6, that is, theoretically, the lock window should not display our track, but here the customization of MIUI already affects). <br><img src="https://habrastorage.org/webt/59/d7/74/59d774af754d9709185222.png" alt="MIUI 8"></p></div></div><br><p>  <strong>Notifications</strong> </p><br><p>  However, as previously mentioned, starting from API 21, the blocking window learned how to display notifications.  And on this happy occasion, the above mechanism was cut out.  So now let's still form notifications.  This is not only a requirement of modern systems, but simply convenient, since the user does not have to turn the screen off and on just to pause.  At the same time apply this notification to transfer the service in the foreground-mode. </p><br><p>  We do not have to draw custom notification, since Android provides a special style for players - <a href="https://developer.android.com/reference/android/app/Notification.MediaStyle.html">Notification.MediaStyle</a> . </p><br><p>  Add to the service two methods </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refreshNotificationAndForegroundStatus</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> playbackState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (playbackState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PlaybackStateCompat.STATE_PLAYING: { startForeground(NOTIFICATION_ID, getNotification(playbackState)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PlaybackStateCompat.STATE_PAUSED: { <span class="hljs-comment"><span class="hljs-comment">//      foreground,   , //    play  NotificationManagerCompat.from(PlayerService.this) .notify(NOTIFICATION_ID, getNotification(playbackState)); stopForeground(false); break; } default: { // ,    stopForeground(true); break; } } } Notification getNotification(int playbackState) { // MediaStyleHelper    . //    Ian Lake / Android Framework Developer at Google //   : https://gist.github.com/ianhanniballake/47617ec3488e0257325c NotificationCompat.Builder builder = MediaStyleHelper.from(this, mediaSession); //   // ...   builder.addAction( new NotificationCompat.Action( android.R.drawable.ic_media_previous, getString(R.string.previous), MediaButtonReceiver.buildMediaButtonPendingIntent( this, PlaybackStateCompat.ACTION_SKIP_TO_PREVIOUS))); // ...play/pause if (playbackState == PlaybackStateCompat.STATE_PLAYING) builder.addAction( new NotificationCompat.Action( android.R.drawable.ic_media_pause, getString(R.string.pause), MediaButtonReceiver.buildMediaButtonPendingIntent( this, PlaybackStateCompat.ACTION_PLAY_PAUSE))); else builder.addAction( new NotificationCompat.Action( android.R.drawable.ic_media_play, getString(R.string.play), MediaButtonReceiver.buildMediaButtonPendingIntent( this, PlaybackStateCompat.ACTION_PLAY_PAUSE))); // ...   builder.addAction( new NotificationCompat.Action(android.R.drawable.ic_media_next, getString(R.string.next), MediaButtonReceiver.buildMediaButtonPendingIntent( this, PlaybackStateCompat.ACTION_SKIP_TO_NEXT))); builder.setStyle(new NotificationCompat.MediaStyle() //     Action    . //     play/pause. .setShowActionsInCompactView(1) //        . //    ,   API &lt; 21 -    //      foreground- //    stopForeground(false). //    . //  API &gt;= 21   ,    . .setShowCancelButton(true) // ,         .setCancelButtonIntent( MediaButtonReceiver.buildMediaButtonPendingIntent( this, PlaybackStateCompat.ACTION_STOP)) //  .    Android Wear.    , //   Android Wear  ,      .setMediaSession(mediaSession.getSessionToken())); builder.setSmallIcon(R.mipmap.ic_launcher); builder.setColor(ContextCompat.getColor(this, R.color.colorPrimaryDark)); //     .        builder.setShowWhen(false); //  .        Android Wear //      . builder.setPriority(NotificationCompat.PRIORITY_HIGH); //         builder.setOnlyAlertOnce(true); return builder.build(); }</span></span></code> </pre> <br><p>  And add the refreshNotificationAndForegroundStatus (int playbackState) call to all MediaSession callbacks. </p><br><div class="spoiler">  <b class="spoiler_title">So it looks</b> <div class="spoiler_text"><p>  Android 4.4 <br><img src="https://habrastorage.org/webt/59/d7/75/59d77579bf5ff155498317.png" alt="Android 4.4"></p><br><p>  Android 7.1.1 <br><img src="https://habrastorage.org/webt/59/d7/75/59d77579a53a9105032127.png" alt="Android 7.1.1"></p><br><p>  Android Wear <br><img src="https://habrastorage.org/webt/59/d7/75/59d77579a5997523718599.png" alt="Android Wear"></p></div></div><br><p>  <strong>Started service</strong> </p><br><p>  In principle, we already have everything working, but there is an ambush: our activity starts the service through binding.  Accordingly, after the activity has disengaged from the service, it will be destroyed and the music will stop.  Therefore, we need to add to onPlay </p><br><pre> <code class="java hljs">startService(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(getApplicationContext(), PlayerService.class));</code> </pre> <br><p>  No processing in onStartCommand is necessary, our goal is not to let the system kill the service after onUnbind. </p><br><p>  And in onStop add </p><br><pre> <code class="java hljs">stopSelf();</code> </pre> <br><p>  In case clients are attached to the service, stopSelf does nothing, it just cocks the flag that after onUnbind the service can be destroyed.  So it is completely safe. </p><br><p>  <strong>ACTION_AUDIO_BECOMING_NOISY</strong> </p><br><p>  We continue to polish the service.  Suppose a user listens to music on headphones and pulls them out.  If this situation is not specially treated, the sound will switch to the speaker of the phone and everyone around will hear it.  It would be good in this case to pause. <br>  For this Android has a special Broadcast AudioManager.ACTION_AUDIO_BECOMING_NOISY. <br>  Add to onPlay </p><br><pre> <code class="java hljs">registerReceiver( becomingNoisyReceiver, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(AudioManager.ACTION_AUDIO_BECOMING_NOISY));</code> </pre> <br><p>  In onPause and onStop </p><br><pre> <code class="java hljs">unregisterReceiver(becomingNoisyReceiver);</code> </pre> <br><p>  And in fact the events pause </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BroadcastReceiver becomingNoisyReceiver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BroadcastReceiver() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AudioManager.ACTION_AUDIO_BECOMING_NOISY.equals(intent.getAction())) { mediaSessionCallback.onPause(); } } };</code> </pre> <br><p>  <strong>Android Auto</strong> </p><br><p>  Starting from API 21, it became possible to integrate a phone with a screen in a car.  To do this, you need to install the <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.google.android.projection.gearhead%26hl%3Dru">Android Auto</a> application and connect the phone to a compatible car.  Large controls will be displayed on the car‚Äôs screen to control navigation, messages and music.  Let's offer Android Auto our application as a music provider. </p><br><p>  If you don‚Äôt have a compatible car at hand, you will sometimes agree that you can simply launch the application and the screen of the phone itself will work as a car. </p><br><p>  The source code is posted on <a href="https://github.com/SergeyVinyar/AndroidAudioExample/tree/MediaBrowserService">GitHub</a> (MediaBrowserService branch). </p><br><p>  First of all, you need to specify in the manifest that our application is compatible with Android Auto. <br>  Add to manifest </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.android.gms.car.application"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:resource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@xml/automotive_app_desc"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><p>  Here, automotive_app_desc is the link to the automotive_app_desc.xml file that you need to create in the xml folder </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">automotiveApp</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"media"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">automotiveApp</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <a href="https://developer.android.com/reference/android/service/media/MediaBrowserService.html">Let's</a> transform our service to <a href="https://developer.android.com/reference/android/service/media/MediaBrowserService.html">MediaBrowserService</a> .  His task, in addition to everything previously done, is to give the token to Android Auto and provide playlists. </p><br><p>  Let's correct service declaration in the manifest </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".service.PlayerService"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tools:ignore</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExportedService"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.media.browse.MediaBrowserService"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.intent.action.MEDIA_BUTTON"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  First, now our service is exported, since it will be connected to it outside. </p><br><p>  And, secondly, the intent filter android.media.browse.MediaBrowserService is added. </p><br><p>  Change parent class to MediaBrowserServiceCompat. </p><br><p>  Since now the service should give different IBinder depending on the intensity, we fix onBind </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IBinder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SERVICE_INTERFACE.equals(intent.getAction())) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onBind(intent); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PlayerServiceBinder(); }</code> </pre> <br><p>  Implement two abstract methods that return playlists. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BrowserRoot </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onGetRoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@NonNull String clientPackageName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientUid, @Nullable Bundle rootHints)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    rootId -    "Root". //  RootId ,     //  onLoadChildren  parentId. //    ,     clientPackageName  //    ,    ,   //  . //         , //   return null; return new BrowserRoot("Root", null); } @Override public void onLoadChildren(@NonNull String parentId, @NonNull Result&lt;List&lt;MediaBrowserCompat.MediaItem&gt;&gt; result) { //  .    FLAG_PLAYABLE //  FLAG_BROWSABLE. //  FLAG_PLAYABLE    , //  FLAG_BROWSABLE    ,   //    ,   onLoadChildren  parentId //  browsable-. //        , //     . ArrayList&lt;MediaBrowserCompat.MediaItem&gt; data = new ArrayList&lt;&gt;(musicRepository.getTrackCount()); MediaDescriptionCompat.Builder descriptionBuilder = new MediaDescriptionCompat.Builder(); for (int i = 0; i &lt; musicRepository.getTrackCount() - 1; i++) { MusicRepository.Track track = musicRepository.getTrackByIndex(i); MediaDescriptionCompat description = descriptionBuilder .setDescription(track.getArtist()) .setTitle(track.getTitle()) .setSubtitle(track.getArtist()) //     Uri //.setIconBitmap(...) .setIconUri(new Uri.Builder() .scheme(ContentResolver.SCHEME_ANDROID_RESOURCE) .authority(getResources() .getResourcePackageName(track.getBitmapResId())) .appendPath(getResources() .getResourceTypeName(track.getBitmapResId())) .appendPath(getResources() .getResourceEntryName(track.getBitmapResId())) .build()) .setMediaId(Integer.toString(i)) .build(); data.add(new MediaBrowserCompat.MediaItem(description, FLAG_PLAYABLE)); } result.sendResult(data); }</span></span></code> </pre> <br><p>  And finally, we are implementing a new callback MediaSession </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPlayFromMediaId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String mediaId, Bundle extras)</span></span></span><span class="hljs-function"> </span></span>{ playTrack(musicRepository.getTrackByIndex(Integer.parseInt(mediaId))); }</code> </pre> <br><p>  Here mediaId is the one that we gave to setMediaId in onLoadChildren. </p><br><div class="spoiler">  <b class="spoiler_title">So it looks</b> <div class="spoiler_text"><p>  Playlist <br><img src="https://habrastorage.org/webt/59/d7/76/59d77642dde51153070997.png" alt="Playlist"></p><br><p>  Track <br><img src="https://habrastorage.org/webt/59/d7/76/59d77642e32a1433388337.png" alt="Track"></p></div></div><br><p>  <strong>UPDATE</strong> from 10/27/2017: GitHub example transferred to targetSdkVersion = 26.  From the changes relevant to the topic of the article, the following should be noted: </p><br><ul><li>  android.support.v7.app.NotificationCompat.MediaStyle is now deprecated.  Instead, use android.support.v4.media.app.NotificationCompat.MediaStyle.  Accordingly, it is no longer necessary to use android.support.v7.app.NotificationCompat, now you can use android.support.v4.app.NotificationCompat </li><li>  The AudioManager.requestAudioFocus method (OnAudioFocusChangeListener l, int streamType, int durationHint) is now also deprecated.  Instead, use AudioManager.requestAudioFocus (AudioFocusRequest focusRequest).  AudioFocusRequest is a new class added with API 26, so do not forget to check at the API level. <br>  Creating an AudioFocusRequest is as follows. <br><pre> <code class="java hljs">AudioAttributes audioAttributes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AudioAttributes.Builder() <span class="hljs-comment"><span class="hljs-comment">//     // (      ) .setUsage(AudioAttributes.USAGE_MEDIA) // ...   (     ) .setContentType(AudioAttributes.CONTENT_TYPE_MUSIC) .build(); audioFocusRequest = new AudioFocusRequest.Builder(AudioManager.AUDIOFOCUS_GAIN) .setOnAudioFocusChangeListener(audioFocusChangeListener) //     ,    //  true -         // (,   ) .setAcceptsDelayedFocusGain(false) //        .setWillPauseWhenDucked(true) .setAudioAttributes(audioAttributes) .build();</span></span></code> </pre> <br><p>  Now we request the focus. <br></p><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) { audioFocusResult = audioManager.requestAudioFocus(audioFocusRequest); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { audioFocusResult = audioManager.requestAudioFocus( audioFocusChangeListener, AudioManager.STREAM_MUSIC, AudioManager.AUDIOFOCUS_GAIN); }</code> </pre> <br><p>  and free <br></p><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) { audioManager.abandonAudioFocusRequest(audioFocusRequest); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { audioManager.abandonAudioFocus(audioFocusChangeListener); }</code> </pre> <br><br><p>  Of course, it is not necessary to make all the above changes, the old methods did not stop working. </p><br><p>  <em>So we got to the end.</em>  <em>In general, this topic is quite confusing.</em>  <em>Plus, the differences in implementations at different API levels and from different manufacturers.</em>  <em>I really hope that I did not miss anything.</em> <em>    ,    ,      .</em> </p><br><p> <em>     <a href="https://www.youtube.com/watch%3Fv%3DXQwe30cZffg"></a> Ian Lake.   2015 ,   .</em> </p><br><p>  <em>Hooray!</em> </p></li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/339416/">https://habr.com/ru/post/339416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339406/index.html">C / C ++ code optimization</a></li>
<li><a href="../339408/index.html">Integration in Mars IS Service Service Desk Royal Canin</a></li>
<li><a href="../339410/index.html">Virtualization and Security</a></li>
<li><a href="../339412/index.html">What taxes you need to pay when displaying revenue from applications in Apple iTunes</a></li>
<li><a href="../339414/index.html">Promises in ES6: Patterns and Anti-Patterns</a></li>
<li><a href="../339418/index.html">DevOops 2017: report review</a></li>
<li><a href="../339420/index.html">Django ORM - slow? Optimize (hardcore)</a></li>
<li><a href="../339422/index.html">The 3 main processes that the CRM system must automate. Automate the conversion process. Part 2</a></li>
<li><a href="../339424/index.html">Aytreking: available solutions and their features</a></li>
<li><a href="../339426/index.html">Monads for Go-programmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>