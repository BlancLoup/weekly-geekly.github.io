<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Nginx as a collector in a difficult caching case</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often we do not cache the output only because of the fact that among the data that can be easily and painlessly cached, there is frequently changing i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Nginx as a collector in a difficult caching case</h1><div class="post__text post__text-html js-mediator-article">  Often we do not cache the output only because of the fact that among the data that can be easily and painlessly cached, there is frequently changing information (associated, as a rule, with a specific user). <br><a name="habracut"></a>  There are several solutions to this problem, but there are significantly few good ones. <br><h4>  Solutions </h4><br>  There are several solutions to this problem. <br>  1. Cache samples only. <br>  This can and should be done, but still extra movements are performed, such as parsing the URL, initiating models and outputting data to the template.  All this increases the entropy and leads to the premature destruction of the universe. <br>  2. Collect data using javascript. <br>  From my point of view, this practice is vicious, as it leads to data loss for clients that do not support javascript.  Exclamations that decent customers keep javascript enabled, I reject with anger, because in the world there are mobile browsers, reading rooms for the blind and just hard-working robots.  This solution is applicable (and even desirable) solely for displaying various "informers", without which you can easily do. <br>  Thus, we must collect the data on the server, and in the easiest way possible.  In this case, the well-deserved nginx server and the unfairly forgotten ssi technology are being used. <br><br>  Immediately, I‚Äôll make a reservation that the great discovery did not belong to me, but was born in the depths of a respected company mail.ru, whose specialists shared it on the Highload past. <br>  However, their decision was, in my opinion, too cumbersome and somewhat different in ideology.  In fact, there nginx was used as a template engine with support for loops, conditional jumps and other trinkets, which seem to be a bit redundant for a ‚Äúsmall light frontend‚Äù.  In addition, despite the joyful assurances of the authors, the project in the public domain did not appear, and writing such magnificence was not in my plans. <br><br><h4>  Idea </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The point is to separate well-cached data and data that is cached poorly or not cached at all, the latter, as a rule, are tied to the user. <br>  For example, there is a list of communities, next to each, depending on whether the user has entered there (and whether he is authorized at all), the ‚Äúenter‚Äù button or the ‚Äúleave‚Äù button are displayed. <br><br>  As a result, we create a cache in which a ready-made html page is stored, containing the necessary data and ssi instructions for outputting variables, with non-cached data.  A ‚Äúbackend‚Äù file is also created that generates these variables. <br><br>  1. Run the cache at the normalized URL, if there is already a cache with the normalized URL, redirect to it, if not, create a fake cache that refreshes the page with some delay ‚Äî that is,  ‚ÄúLochim‚Äù page. <br>  /communities/new/1.html - first page of the list of communities sorted by creation time <br>  2. We make a sample of well cached data. <br>  In our case, the newest 10 communities. <br>  3. Generate and ‚Äúmemorize‚Äù the code for sampling noncacheable data. <br>  Those.  In which communities of the selected is the current user. <br>  4. Display the list.  The point is that at the level of the template instructions, we have the opportunity to specify the code sections that are created in the backend.  Thus, the code is ‚Äúremembered‚Äù and supplemented with the generation code of the ssi variables, and po: ssi is replaced with the ssi instruction. <br>  It looks something like this (the bicycle construction template engine is used, the hidden meaning of its creation is described here: <a href="http://cloud.habrahabr.ru/blog/22445/">cloud.habrahabr.ru/blog/22445</a> ): <br><br> <code><a href="https://habr.com/community/%257B%24id%257D/"></a> <a href="https://habr.com/community/%257B%24id%257D/leave"></a> <a href="https://habr.com/community/%257B%24id%257D/join"></a> <br> {$Title} <br> <br> &lt;? <br> if (auth::is_logged_id()){ <br> if (isset($memberof['{$id}'])&amp;&amp;$memberof['{$id}']){ <br> ?&gt; &lt;? <br> } <br> else { <br> ?&gt; &lt;? <br> } <br> } <br> ?&gt; <br> <br> <br> <br></code> <br><br>  5. Save the result of the script execution in the html file, and the code ‚Äútied to the user‚Äù in the backend file.  Add the ssi include virtual instruction to the file cache, which connects the backend file. <br><br>  Thus, when retrieving data from the cache, the following happens: <br><br>  1. nginx receives the request and finds the page in the cache. <br>  2. Executes the include virtual instruction (it is important here not to forget to set the wait parameter), by which it connects the generated backend file.  There, the current user and his membership in the communities displayed on this page is determined, the html code for the ‚Äúenter‚Äù and ‚Äúleave‚Äù buttons is created, which is written into the corresponding ssi variables. <br>  3. Variables are output in the appropriate places of the templates, as a result of which we get the required page. <br><br><h4>  Cache urgency </h4><br><br>  The relevance of the cache is maintained by ‚Äúsampling names‚Äù, i.e.  Each sample is an object that has one or more names, usually a table name and / or a table name and key. <br>  For example, a sample of communities from the ‚Äúcommunities‚Äù table with the theme ‚Äúsport‚Äù is named communities_sport.  Selection names are set at the model level, and at the model level, the cache can be reset during UPDATE / DELETE / CREATE. <br><br>  As a result, when saving the cache, we save the page links with the names of all the samples taken, and when we change, we delete all the pages with the same name. </div><p>Source: <a href="https://habr.com/ru/post/36632/">https://habr.com/ru/post/36632/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../366311/index.html">Pebble Time - new Pebble smart watches with color E-Paper display</a></li>
<li><a href="../366313/index.html">‚ÄúLaser can help diagnose cancer‚Äù, or How does a laser fluorescence hyperspectral microscope work?</a></li>
<li><a href="../366315/index.html">Spanish physicists made a magnetic "wormhole"</a></li>
<li><a href="../366317/index.html">The US regulator allowed 23andMe to conduct a genetic test for Bloom syndrome directly to the consumer</a></li>
<li><a href="../366319/index.html">Stonehenge can build one person</a></li>
<li><a href="../366321/index.html">In which hotels and restaurants you can meet a robot worker</a></li>
<li><a href="../366323/index.html">‚ÄúBattle of Robot-mower‚Äù We invite you to participate in the contest 04.06.2016</a></li>
<li><a href="../366325/index.html">For the first time created a magnetic "wormhole"</a></li>
<li><a href="../366327/index.html">Suitcase with an electric scooter will help to catch the plane</a></li>
<li><a href="../366329/index.html">Coffee grounds suitable for storing methane</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>