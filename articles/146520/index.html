<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Architecture plus1.wapstart.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, community! 

 Initially, I planned to write an article in the form of a summary of a report on devconf . Then I realized that the forty-five...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Architecture plus1.wapstart.ru</h1><div class="post__text post__text-html js-mediator-article"><h2>  Good day, community! </h2><br><br>  Initially, I planned to write an article in the form of a summary of a <a href="http://devconf.ru/offers/3">report</a> on <a href="http://devconf.ru/">devconf</a> .  Then I realized that the forty-five-minute speech was difficult to put into an article on Habr√©, while leaving its size sane.  Therefore, the article discusses the architecture <a href="https://plus1.wapstart.ru/">plus1.wapstart.ru</a> , and slides from the conference can be viewed <a href="http://www.slideshare.net/megadovg/e-kokovikhin-devconf-2012">here</a> . <br><br>  <a href="https://plus1.wapstart.ru/">Plus1.wapstart.ru</a> is an advertising network for the mobile Internet.  Our ‚Äúecosystem‚Äù is advertisers, owners of sites (sites and applications) and audience of users. <br>  Site owners want to monetize their audience as simply and efficiently as possible, advertisers want to invest money efficiently, advertising should not be annoying consumers, but at the most they should be satisfied with it. <br>  Task plus1.wapstart.ru - meeting the needs of these groups.  For us, their desires mean that we have to work as fast as possible, not allow a minute of dayout and, of course, monitor the quality and appearance of advertising. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some numbers: <br><ul><li>  Peak load&gt; 10 <sup>3</sup> dynamic requests per second. </li><li>  On the day we show more than ~ 10 <sup>7</sup> ads. </li><li>  The total number of banners and sites is measured in four-digit numbers. </li><li>  The average return time of the banner does not exceed 90ms. </li></ul><br><br>  If you're wondering how it all works - welcome under the cut! <br><br><a name="habracut"></a><br><h2>  Iron </h2><br><img src="https://habrastorage.org/storage2/fb5/005/c45/fb5005c45bcd3a36a9b7cade9fac02ec.png"><br><br><h2>  BY </h2><br>  We strive for uniformity: <br><ul><li>  Fronts - <a href="http://www.freebsd.org/ru/">freebsd</a> , <a href="http://nginx.ru/">nginx</a> . </li><li>  Farm (application server) - <a href="http://www.debian.org/index.ru.html">Debian GNU / Linux</a> , php 5.3 <a href="http://fi2.php.net/manual/en/install.fpm.php">fpm</a> , <a href="https://github.com/onPHP/onphp-framework">onphp framework</a> , <a href="http://memcached.org/">memcached</a> , its demons (we will tell about them in the next report). </li><li>  Database servers - Debian GNU / Linux, <a href="http://www.postgresql.org/">Postgres</a> 9.0, replication out of the box. </li><li>  Serving servers - Debian GNU / Linux, <a href="http://www.zabbix.com/ru/">zabbix</a> , <a href="http://pinba.org/wiki/Main_Page">pinba</a> . </li></ul><br><h2>  How do we select a banner </h2><br><img src="https://habrastorage.org/storage2/ae0/9ed/49f/ae09ed49f79a359526177c5b1e5eea6e.png"><br><br>  The main rule - if something can be counted in advance, it must be considered in advance. <br><br><img src="https://habrastorage.org/storage2/d9e/692/927/d9e692927a4a10b34832fd0aa3f376fc.png"><br><br>  The process itself looks like this: <br><ul><li>  We parse the request (http) to display the banner.  From fast storage <br>  we get the characteristics of this request: we define the operator by ip <br>  address, model and operating system of the phone by user-agent and others <br>  headlines. </li><li>  For each characteristic of the request, we get a list of banners, <br>  suitable for this request. </li><li>  Intersect lists. </li><li>  The resulting set of banners is checked by additional <br>  "Checkers".  This is because some checks can be done <br>  only at runtime, because  they are tied to a specific request. <br>  For example, it makes no sense to show the banner to the user, if he already <br>  I saw 10 times and did not click on it. </li></ul><br><h2>  How do we count statistics </h2><br><img src="https://habrastorage.org/storage2/96e/bc1/173/96ebc1173d0bf6af588fd8b1c338c419.png"><br><br>  We must always be ready for growth.  Processes should be laid in such a way that they can be easily parallelized. <br><br>  It works like this: <br><ul><li>  Each server writes statistical events (the fact of the show, the fact of the click, etc.) to a file in serialized form. </li><li>  The file name contains a timestamp. </li><li>  The file handler groups the records from the file, ‚Äúcollapsing‚Äù homogeneous events into one record, writes the resulting set into a temporary table in the database and archives the file. </li><li>  The temporary table contains a timestamp in the name.  After its aggregation into watch tables, it is deleted (drop). </li><li>  Daily tables are constructed from hour tables, and monthly tables are constructed from day tables.  The data in each type of table has a certain storage age. </li></ul><br><h2>  Monitoring </h2><br><img src="https://habrastorage.org/storage2/c4c/faf/a25/c4cfafa251c80d893321292f72d6fc43.png"><br><br>  Now we use zabbix as the main monitoring service.  I can not say that it is fast, but on our set of triggers and servers it works quite well.  Not only iron indicators (io, cpu, la) and application indicators (return time, logging process) are monitored, but also business metrics (trade secret :). <br>  To collect real-time application statistics, we use pinba (I already <a href="http://habrahabr.ru/post/129042/">wrote</a> about it :)). <br>  The most critical triggers come to us by sms. <br><br><h2>  Errors </h2><br>  Errors happen to all.  Naturally, developers should be aware of errors, and it is desirable to learn about them before the user learns about them.  We use <a href="http://ru.wikipedia.org/wiki/Syslog">syslog</a> to collect errors, good php <br>  knows how to log there.  Data from syslog is aggregated on the server and once every N minutes is sent to the mailing list.  This allows you to quickly catch problems. <br><br>  On this, perhaps, you can finish.  The dialogue can be continued in the comments.  Our team will be happy to answer your questions. <br><br>  <strong>ps.</strong>  We share our experience with the community - <a href="https://github.com/Wapstart">https://github.com/Wapstart</a> <br>  <strong>pps.</strong>  About <a href="http://www.slideshare.net/klestoff/ss-13308183">how</a> we "cheat" our applications will be a separate post. </div><p>Source: <a href="https://habr.com/ru/post/146520/">https://habr.com/ru/post/146520/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146512/index.html">Microsoft buys Yammer for $ 1.2 billion</a></li>
<li><a href="../146513/index.html">Americans have created a sensitive "skin" for the robot</a></li>
<li><a href="../146516/index.html">Facebook generated email addresses to all users</a></li>
<li><a href="../146517/index.html">Beeline turned on traffic filtering</a></li>
<li><a href="../146518/index.html">Windows 8. Contract "search" in detail</a></li>
<li><a href="../146521/index.html">How to reanimate your PHP project using symfony2 components</a></li>
<li><a href="../146522/index.html">Google's advertising budget exceeded $ 2 billion</a></li>
<li><a href="../146523/index.html">High-resolution Bing cards will show Europe and the United States by the end of the year.</a></li>
<li><a href="../146524/index.html">TechRadar leaked user personal data</a></li>
<li><a href="../146525/index.html">Modernization of the protected General Dynamics (Itronix) XR-1 (IX270) laptop</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>