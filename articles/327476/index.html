<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we learned to upgrade Tenzor's 5,000 servers.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nowadays, in every decent organization that develops serious software, it is customary to share the ways in which its projects were created and develo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we learned to upgrade Tenzor's 5,000 servers.</h1><div class="post__text post__text-html js-mediator-article">  Nowadays, in every decent organization that develops serious software, it is customary to share the ways in which its projects were created and developed.  We consider this to be an excellent trend and are ready to tell our version of the development of one of the internal projects of the SBIS company.  He influences in the most serious way all her other products, and he is affectionately called ‚ÄúHottabych‚Äù, for he does the magic! <br><br>  Every 100 seconds, he updates any application in combat or in a test environment.  We only have about 200 applications in production, and more than 1000 on test stands. The number of virtual servers on which each application is deployed is from two to several hundred.  So, in order ... <br><br><img src="https://habrastorage.org/files/1d1/41f/8e9/1d141f8e98784cab8fcbd78782c89bcf.jpg" width="600"><a name="habracut"></a><br><h2>  Before the Big Bang </h2><br>  Online SBIS was released recently - in 2010.  Before that, we were like all decent applications - desktop.  First, they lived under DOS, then under the Windows console, then they became a full-fledged Windows application, well, just like people.  The client data was either stored in the Pervasive DBMS or in a database of its own manufacture with the mysterious name Muzzle.  Then the clients themselves were engaged in updating their VLSI.  The most difficult in updating was conversion of base.  For this operation, a special utility <b>Jinnee was used</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Jinnee was a good girl.  He took a new description of the base structure from the distribution, automatically calculated the difference between the old and the new structure and rolled it onto the base.  It was possible to intervene in the conversion process with the help of the converter mechanism.  The necessary converter worked only for the version for which it was written.  The ideas embodied then in Jinnee were so good that they have survived to this day, like Jinnee himself.  We could not find its analogues in the software industry, and therefore we proudly consider it unique. <br><br><h3>  Big bang is about to start </h3><br>  Suddenly, <b>in 2010,</b> SBIS became a web service under IIS and changed data stores to PostgreSQL.  Of course, it became easier for customers to do this - they didn‚Äôt have a headache about the update, and we still didn‚Äôt realize what we‚Äôve gotten into and updated our web service in the old fashioned way, as we did with the desktop application.  All the same handles launched Jinnee, teaching him to convert PostgreSQL.  And somehow it didn‚Äôt bother, the service was practically the same, the base was one, there were not many online clients.  All efforts at that moment were aimed at improving PostgreSQL conversion using Jinnee. <br><br>  But soon the web-services began to multiply, and the number of clients rapidly grew to 300 thousand. It was necessary to update already a dozen of services located on fifty servers.  Manually doing this is unbearable, and updates took place at night at the weekend.  Then, even during the update, clients could not work, getting a parking page with the text "Sorry, the application is temporarily unavailable, technical work is in progress, the expected unlock time is 6:00." <br><br>  There are three problems: <br><br><ol><li>  eliminate manual work during the upgrade, and thus speed up the work itself and reduce errors due to the human factor; </li><li>  minimize customer downtime during the upgrade; </li><li>  give sleep to the teams. </li></ol><br>  Here you need to tell a little about our client data storage architecture, so that the rest of it becomes clear. <br><br>  We store customer data in Postgres databases.  1.5 thousand clients are usually attached to one base.  Inside the database, each client data is stored in a separate scheme. <br><br>  This unusual storage method gives us the following buns: <br><br><ol><li>  you can convert data from one client independently of another; </li><li>  you can easily transfer the customer data from one base to another; </li><li>  The client will never be able to see other people's data. </li></ol><br>  When the client executes the request, it first gets to the dispatcher.  Dispatcher plays the role of balancer and router, it is implemented on the basis of nginx.  Having calculated the client's route, he throws it onto one of the servers of the business logic of the group in which the client‚Äôs base is located.  Business logic, if necessary, already refers to the necessary database, addressing the client‚Äôs schema inside the database.  And it's all. <br><br><img src="https://habrastorage.org/files/d03/dc9/763/d03dc9763d1a41feaf9da92c1eb74601.png" height="600"><br><br><h2>  Big bang starts </h2><br>  <b>By the end of autumn 2012,</b> we conceived a new service to implement the update ‚Äúwith a human face‚Äù.  We formed a team of three people, and, having prayed, set about ... <br><br>  The update system architecture was formed immediately from the following components: <br><br><ul><li>  update management service; </li><li>  Meta-information service and configuration of cloud services; </li><li>  dispatcher; </li><li>  update agents; </li><li>  application distribution repository. </li></ul><br>  The managing service was named <b>Hottabych</b> , it was also an allusion to the Jinnee utility, which could convert databases. <br><br>  We had a service of meta-information and configuration of cloud services from the very beginning and functioned well, we call it <b>"Cloud Management"</b> .  For the needs of the update, its task is to provide information where robots, web services are topologically located and what their settings are.  It is he who commands the dispatchers to issue parking pages about the unavailability of services.  The use of dispatchers was originally conceived as simple balancers of http requests, but then their functions became significantly wider. <br><br>  Update Agents (Hottabych agents) are services on service hosts that are designed to execute commands to update them. <br><br>  Distribution repository - the name speaks for itself.  Distributions also existed at this point, there was only storage. <br><br>  Interact this was something like this: <br><br><ol><li>  Hottabych receives a command to update the application to the desired version; </li><li>  Contact the cloud management service for the service topology; </li><li>  Downloads the distribution kit of the required version to the shared disk; </li><li>  Divides all server services in half - one part will be updated while the second will work; </li><li>  Sends commands to agents of the first part of servers for an update, indicating where the distribution kit is located; </li><li>  Agents download the distribution package to themselves, unpack it and change the old version to a new one. </li><li>  Then the managing service does the same for the rest of the servers; </li><li>  When all agents have reported the end of the work, the managing service goes into a state of waiting for confirmation of the update, because it can be rolled back. </li></ol><br>  It remained to develop the service itself with the interface, the update agents, and organize the distribution repository with the layout there. <br><br><h3>  The first child .. </h3><br>  At the first iteration, we only needed an update without data conversion.  The distribution repository decided to do on SVN - here are fools! <br><br>  Structurally, the storage organization was hierarchical: <br><br><pre><code class="1c hljs"> - <span class="hljs-string"><span class="hljs-string">|-  - |-   +     |-  - |-   +    </span></span></code> </pre> <br>  Hottabych decided to write on its own VLSI platform.  This is exactly what we knew how to do, there was no doubt.  There were doubts with the update agent, but in the end they also began to do it on the VLSI platform (this is C ++).  A tough condition was set for the agents - they should report to Hottabych regularly and as informatively as possible about their work. <br><br><img src="https://habrastorage.org/files/3c1/f19/9df/3c1f199df1f14210879c12e57f453176.png" width="180" align="left">  The update was divided into three main phases: <br><br>  1. Preparation phase - during it, distribution files are delivered to application hosts, various preparatory actions are made that do not disrupt the operation of services. <br>  2. The update phase - in fact, an update is performed on it, here the work of the service can sometimes be suspended. <br>  3. Confirmation phase - minor update tasks are completed here, unnecessary files are cleaned, etc.  Services at this moment are already working. <br><br>  The whole process is controlled from the front end by the person in charge, and it can always be paused, continued or rolled back.  For each update node in the frontend, you can see what state it is in, what is happening on it, what is happening, or maybe everything‚Ä¶ <br><br><img src="https://habrastorage.org/files/36c/e94/4f4/36ce944f4e854e2da2918848ba6a336e.png"><br><br><h3>  Big bang took place </h3><img src="https://habrastorage.org/files/d41/791/e94/d41791e941c246f9895b9fae85cfe457.jpg" width="250" align="right"><br>  Finally, <b>in the spring of 2013</b> we were able to carry out the <b>first update</b> in a combat environment, then the second, the third, and everyone liked it so much that, to the joys of it, they started updating during the day during working hours.  We called this type of update ‚Äúeasy‚Äù because it passed without any problems for everyone - both for us and for customers.  It was a breakthrough! <br><br clear="all"><h3>  The universe is expanding </h3><br>  After the first successes, we got the <b>first problem</b> .  On test benches, distributions were loaded into the storage so often and up to 1.5 GB in size, that SVN cracked at the seams.  Of course, it was not suitable for storing large binary files, and we quickly went into the storage of distributions on a linux server.  It was also a so-so decision, since it was necessary to keep the ball on the linux-disk from the windows-servers, but it became much better. <br><img src="https://habrastorage.org/files/07b/0c0/943/07b0c09434bf4845aba3a6f947c64df1.png" width="250" align="left"><br>  Ahead of waiting for the update of services with database conversions.  In this iteration, Jinnee, who was able to convert the database, was delivered by the agent to one of the servers being updated.  The agent started it, commanding which database to convert. <br><br>  When converting databases, unfortunately, working with them is difficult.  The work of the service must be suspended.  However, customers in the frontend should not be intimidated, and for them at this moment there will be a parking page.  It usually reports what is happening now, what new features will be after the update, and after the end of the parking page is removed. <br><br>  <b>In the summer of 2013,</b> we also rolled out this update option into working use.  And everything would be nice, but we have some services that work not with one base, but with many, for example with a hundred.  And when all this heap of databases started to be simultaneously converted, a decent load arrived at the data center storage.  I had to do the conversion is not so aggressive, and not all at once.  So, at the moment we will never convert all customers at once: one group of customers is usually converted, in a few days the other. <br><br><h3>  And again on the conversion of databases </h3><br>  Client bases were converted for a long time - several hours.  It did not suit us at all.  We are able to convert the data of one client in the database regardless of the data of another.  Then the client instead of hours of inactivity can get a suspension of work from several seconds to several minutes.  And you need to be very unhappy to run into these seconds.  With this approach, some of the clients during the update will live in the database on the old version of the data and be serviced by the old logic, and the other part on the new version of the data and be served by the new logic.  The client being updated should just wait. <br><br>  We stopped at the next decision.  Pre- <b>frontier</b> dispatchers are transferred to the <b>‚Äúclient update‚Äù</b> mode.  This means that for each request from the client, they turn to Redis for information about the state of the client: updated, not updated or still updated. <img src="https://habrastorage.org/files/1ff/14d/061/1ff14d0611364a60866aa76acb125c41.jpg" width="350" align="right">  Hottabych lays out the information there when he decides to update the client.  If the client is not updated, the dispatcher casts a request for a pool of non-updated servers;  if updated, then on the pool of updated servers;  and if updated, gives the client a parking page. <br><br>  This option we rolled out in the "production" <b>at the end of 2014</b> .  He got accustomed so that he became almost the main version of the conversion.  Of course, not all of our databases can be converted like this, but not all of our databases are converted for so long. <br><br>  We now have more than 1 million customers, and they are located on more than 650 bases.  And conversions are quite unnoticed. <br><br><h3>  And Linux came ... </h3><br>  Years of operation of services under IIS, led us to a sustainable idea - we do not need IIS, and neither did Windows, because, in fact, we did not use the Microsoft technology stack.  And under Linux, there is less server overhead, a C ++ code is better optimized, more choice of server hardware, for example, IBM Power, etc. <br><br><img src="https://habrastorage.org/files/f64/798/607/f647986072c947f19016664426cc4f86.png" width="200" align="left">  And <b>in 2015</b> came a major event.  The team developing the core of our services set the stage <b>for the migration to Linux</b> , and the migration began.  We used this to refuse SSH when upgrading services to Linux and ported Hottabych agent to it. <br><br>  Here our other team also made a breakthrough and developed an analogue of Google Drive - <b>SBIS Disc</b> .  We took advantage of this.  They refused to store distributions on a dedicated Linux server, began to store them in VLSI Disk.  The process of downloading the distribution has greatly simplified and accelerated.  Now, every agent Hottabych on a team directly from the VLSI Disk cheerfully downloaded the desired distribution kit.  We breathed freer, and the system administrators breathed too, but not as freely as we. <br><br><h3>  And back to the database conversion </h3><br>  <b>Simple customer</b> we minimized and that's great.  But still, how to <b>remove</b> it altogether?  Often the conversion can be carried out without stopping the base at all.  For example, adding an index or some field.  We called this conversion "easy."  But the question is, how do you know if you can perform a ‚Äúlight‚Äù conversion?  The same Jinnee Wizard gives us the answer.  A new distribution kit and a candidate database for conversion is submitted to it, it analyzes the expected changes on them and gives recommendations on what conversion to carry out. <br><br>  Alas, situations are inevitable when you need to convert the base with a stop.  However, many databases mainly work on reading, and if the conversion is expected for a short time, then you can wrap all the read requests at the replica of the database at the time of the conversion, and after the conversion is finished, switch to the master.  Requests to change data in this case will be rejected with an error.  It turned out that this option was very suitable.  Some critical services are now always converted in this mode, continuing to respond to most requests. <br><br><h3>  About patches </h3><br>  Often, an error is detected in the operation of the service and you need to fix it as soon as possible.  Editing is usually small - one file, and the assembly of a new distribution can be quite long, and there is no need for that.  We called this type of update a <b>‚Äúpatch‚Äù</b> .  The corrected file is transferred to Hottabych, it replaces it in the existing distribution, raising its version, and rolls it onto the service.  Everything happens very quickly. <br><br><h3>  Ordering unordered </h3><br>  Very often there is no need to update the service code and the data structure of its databases.  You just need to change the data once.  Previously, this was done by scripts and transferred to data center administrators for execution.  Those they started with pens and eyes watched the work.  Scripts multiplied, on the day they could arrive from 10 to 20. Many had to be performed on several hundred bases.  Signs of growing mess there. <br><br>  As a result, we stopped at this decision.  The developer implements the script logic in the form of a normal request code executed on the service.  So he gets all the internal infrastructure of the service.  Hottabych delivers the code of the service request and calls it, tracking the execution at each of the service databases.  The data center administrator can only press a button in the Hottabych interface; he takes over the rest of the logic.  Now it is the most popular type of update. <br><br><h2>  After the big bang </h2><img src="https://habrastorage.org/files/455/561/9db/4555619db5f44af98c7b0e8a42d92314.png" width="200" align="right"><br>  Hottabych continues to evolve, the transition to Linux has opened up new possibilities for us, the containerization of our services is next.  We also plan to ensure that customers, even with aggressive conversion, do not get any downtime.  Due to the network of Hottabych agents deployed to our data center servers, we received additional benefits that we did not immediately count on.  For example, agents Hottabych now not only update, but also perform a reload of service processes on demand, configuration tasks, some monitoring. <br><br>  Now Hottabych is included in the ‚Äúfarm‚Äù of about 5 thousand servers, and he copes well with this.  The number of databases that are periodically converted ~ 2 thousand. All this is updated with a minimum of downtime for more than 1 million customers for a long time. <br><br>  <b>Author: Alexey Terentyev</b> </div><p>Source: <a href="https://habr.com/ru/post/327476/">https://habr.com/ru/post/327476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327466/index.html">Several lines of JS code to call from browser to mobile phone</a></li>
<li><a href="../327468/index.html">Consensus Algorithms: Proof of Share and Proof of Work</a></li>
<li><a href="../327470/index.html">DevExtreme: now on GitHub and with a free license</a></li>
<li><a href="../327472/index.html">Vivaldi 1.9 - plant not transplant</a></li>
<li><a href="../327474/index.html">We write the URL, we get a free icon</a></li>
<li><a href="../327480/index.html">Java and isomorphic React</a></li>
<li><a href="../327482/index.html">How do i write code</a></li>
<li><a href="../327484/index.html">My upgrade byndyusoft.Infrastructure | DDD + CQRS + WebApi</a></li>
<li><a href="../327486/index.html">Paparazzo. Powerful, stylish, your own. Part II</a></li>
<li><a href="../327488/index.html">What is the Cyber-Kill Chain and why should it be taken into account in the protection strategy?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>