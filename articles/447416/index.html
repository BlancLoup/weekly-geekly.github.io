<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP Enchanting arrangement of points above quotes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Regarding PHP micro-optimizations by replacing double quotes with single quotes, there are so many broken copies that it is quite problematic to make ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP Enchanting arrangement of points above quotes</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habr.com/ru/company/alfa/blog/447416/"><img align="right" src="https://habrastorage.org/webt/d1/tk/_m/d1tk_mf7oricg12qjka8tx0yzce.jpeg"></a> <br>  Regarding PHP micro-optimizations by replacing double quotes with single quotes, there are so many broken copies that it is quite problematic to make a fresh stream.  But I'll try. <br><br>  In this article there will be only one benchmark, where without it, and the main emphasis is placed on the analysis of how it is arranged inside. <br><a name="habracut"></a><br><h3>  Disclaimer </h3><br><ol><li>  Everything described below is, for the most part, saving on nanoseconds, and in practice it will not give anything but time lost on such a micro-optimization.  This is especially true of ‚Äúoptimizations‚Äù of compile time. </li><li>  I will cut the code and output to the maximum, leaving only the essence. </li><li>  When writing this article I used PHP 7.2. </li></ol><br><h3>  Necessary introductory </h3><br>  The string in double quotes <b>at the compilation stage is</b> handled a little differently than the string in single quotes. <br><br>  Single quotes will be resolved like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="php hljs">statement -&gt; expr -&gt; scalar -&gt; dereferencable_scalar -&gt; T_CONSTANT_ENCAPSED_STRING</code> </pre> <br>  Double so: <br><br><pre> <code class="php hljs">statement -&gt; expr -&gt; scalar -&gt; <span class="hljs-string"><span class="hljs-string">'"'</span></span> encaps_list <span class="hljs-string"><span class="hljs-string">'"'</span></span> -&gt;        ,  ,    </code> </pre> <br>  In the articles on PHP micro-optimizations, there is often advice not to use <b>print</b> , since it is slower than <b>echo</b> .  Let's see how they understand. <br><br>  Parsing <b>echo</b> : <br><br><pre> <code class="php hljs">statement -&gt; T_ECHO echo_expr_list -&gt; echo_expr_list -&gt;  echo_expr -&gt; expr</code> </pre> <br>  Parsing <b>print</b> : <br><br><pre> <code class="php hljs">statement -&gt; expr -&gt; T_PRINT expr -&gt; expr ( )</code> </pre> <br>  Those.  In general, yes, <b>echo is</b> detected a step earlier and this step, it should be noted, is rather heavy. <br><br>  So that in the course of the article once again do not focus attention, we‚Äôll keep in mind that at the compilation stage, double quotes are lost by single quotes, and <b>print</b> loses <b>echo</b> .  Also let's not forget that it is, in the worst case, about nanoseconds. <br><br>  Well, so as not to get up twice.  Here are the diff functions compiling <b>print</b> and <b>echo</b> : <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">1</span></span> - <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zend_compile_print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(znode *result, zend_ast *ast)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* {{{ */</span></span></span><span class="hljs-function"> 1 + </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zend_compile_echo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(zend_ast *ast)</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">/* {{{ */</span></span></span><span class="hljs-function"> 2 2 </span></span>{ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> zend_op *opline; <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> zend_ast *expr_ast = ast-&gt;child[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> znode expr_node; <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> zend_compile_expr(&amp;expr_node, expr_ast); <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> opline = zend_emit_op(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ZEND_ECHO, &amp;expr_node, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-number"><span class="hljs-number">10</span></span> - opline-&gt;extended_value = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-number"><span class="hljs-number">11</span></span> - <span class="hljs-number"><span class="hljs-number">12</span></span> - result-&gt;op_type = IS_CONST; <span class="hljs-number"><span class="hljs-number">13</span></span> - ZVAL_LONG(&amp;result-&gt;u.constant, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-number"><span class="hljs-number">10</span></span> + opline-&gt;extended_value = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> }</code> </pre> <br>  Well, you understand - they are identical in functionality, but <b>print</b> additionally returns a constant equal to 1. I think on this topic with <b>print</b> you can close and forget about it forever. <br><br><h3>  Simple string, no frills </h3><br>  Strings <code>echo 'Some string';</code>  and <code>echo "Some string";</code>  will be split almost identically into 2 (disklimer p2) tokens. <br><br><pre> <code class="php hljs">T_ECHO: <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> T_ENCAPSED_AND_WHITESPACE/T_CONSTANT_ENCAPSED_STRING: <span class="hljs-string"><span class="hljs-string">"Some string"</span></span></code> </pre> <br>  And for single quotes, there will always be T_CONSTANT_ENCAPSED_STRING, and for double quotes, it will always be as.  If there is a space in the string, then T_ENCAPSED_AND_WHITESPACE. <br><br>  Opcodes will be simple to ugliness and absolutely identical: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ----------------------------------------------------------- 4 0 E &gt; ECHO 'Some string'</span></span></code> </pre> <br><br><h4>  findings </h4><br>  If you want to save a couple of processor cycles at compile time, then, for constant strings, use single quotes. <br><br><h3>  Dynamic string </h3><br>  There are 4 options. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Hello $name! Have a nice day!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Hello '</span></span>.$name.<span class="hljs-string"><span class="hljs-string">'! Have a nice day!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Hello '</span></span>, $name, <span class="hljs-string"><span class="hljs-string">'! Have a nice day!'</span></span>; printf (<span class="hljs-string"><span class="hljs-string">'Hello %s! Have a nice day!'</span></span>, $name);</code> </pre> <br>  For the first option: <br><br><pre> <code class="php hljs">T_ECHO: <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> T_ENCAPSED_AND_WHITESPACE: Hello T_VARIABLE: $name T_ENCAPSED_AND_WHITESPACE: ! Have a nice day!</code> </pre> <br>  For the second (for the third as well, but instead of points there will be commas): <br><br><pre> <code class="php hljs">T_ECHO: <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> T_CONSTANT_ENCAPSED_STRING: <span class="hljs-string"><span class="hljs-string">'Hello '</span></span> string: . T_VARIABLE: $name string: . T_CONSTANT_ENCAPSED_STRING: <span class="hljs-string"><span class="hljs-string">'! Have a nice day!'</span></span></code> </pre> <br>  For the fourth: <br><br><pre> <code class="php hljs">T_STRING: printf T_CONSTANT_ENCAPSED_STRING: <span class="hljs-string"><span class="hljs-string">'Hello %s! Have a nice day!'</span></span> string: , T_VARIABLE: $name</code> </pre> <br>  But with opcodes everything will be much more interesting. <br><br>  The first: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Hello $name! Have a nice day!"</span></span>; line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ----------------------------------------------------------- 3 0 E &gt; ASSIGN !0, 'Vasya' 4 1 ROPE_INIT 3 ~3 'Hello+' 2 ROPE_ADD 1 ~3 ~3, !0 3 ROPE_END 2 ~2 ~3, '%21+Have+a+nice+day%21' 4 ECHO ~2</span></span></code> </pre> <br>  Second: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Hello '</span></span>.$name.<span class="hljs-string"><span class="hljs-string">'! Have a nice day!'</span></span>; line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ----------------------------------------------------------- 3 0 E &gt; ASSIGN !0, 'Vasya' 4 1 CONCAT ~2 'Hello+', !0 2 CONCAT ~3 ~2, '%21+Have+a+nice+day%21' 3 ECHO ~3</span></span></code> </pre> <br>  Third: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Hello '</span></span>, $name, <span class="hljs-string"><span class="hljs-string">'! Have a nice day!'</span></span>; line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ----------------------------------------------------------- 3 0 E &gt; ASSIGN !0, 'Vasya' 4 1 ECHO 'Hello+' 2 ECHO !0 3 ECHO '%21+Have+a+nice+day%21'</span></span></code> </pre> <br>  Fourth: <br><br><pre> <code class="php hljs">printf (<span class="hljs-string"><span class="hljs-string">'Hello %s! Have a nice day!'</span></span>, $name); line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ----------------------------------------------------------- 3 0 E &gt; ASSIGN !0, 'Vasya' 4 1 INIT_FCALL 'printf' 2 SEND_VAL 'Hello+%25s%21+Have+a+nice+day%21' 3 SEND_VAR !0 4 DO_ICALL</span></span></code> </pre> <br>  Common sense dictates that the option with `printf` will lose in speed to the first three (especially since at the end there is the same ECHO), so we‚Äôll leave it for tasks where you need formatting and we‚Äôll not recall any more in this article. <br><br>  It would seem that the third option is the fastest - to print successively three lines without concatenations, strange ROPEs, and creating additional variables.  But not everything is so simple.  The printing function in PHP is of course not Rocket Science, but also by no means a banal C-shny <b>fputs</b> .  Who <b>cares</b> - the ball is unraveled starting with <b>php_output_write</b> in the file <b>main / output.c</b> . <br><br>  CONCAT.  Everything is simple - we convert, if necessary, the arguments into strings and create a new <b>zend_string</b> using fast <b>memcpy</b> .  The only drawback is that with a long chain of concatenations for each operation, new lines will be created by moving the same baytik from place to place. <br><br>  But with ROPE_INIT, ROPE_ADD and ROPE_END everything is much more interesting.  We follow hands: <br><br><ol><li>  <b>ROPE_INIT (ext = 3, return = ~ 3, operands = 'Hello +')</b> <br>  Allocate the ‚Äúrope‚Äù of three slots (ext), put the string 'Hello +' (operands) in slot 0 and return the temporary variable ~ 3 (return) containing the ‚Äúrope‚Äù. </li><li>  <b>ROPE_ADD (ext = 1, return = ~ 3, operands = ~ 3,! 0)</b> <br>  We put in the slot 1 (ext) ‚Äúrope‚Äù ~ 3 (operands) the string 'Vasya' obtained from the variable! 0 (operands) and return the ‚Äúrope‚Äù ~ 3 (return). </li><li>  <b>ROPE_END (ext = 2, return = ~ 2, operands = ~ 3, '% 21 + Have + a + nice + day% 21')</b> <br>  We place the line '% 21 + Have + a + nice + day% 21' (operands) in slot 2 (ext), then create a zend_string of the required size and copy all the ‚Äúrope‚Äù slots into it with the same <b>memcpy</b> . </li></ol><br>  We should also note that in the case of constants and temporary variables, references to the data will be placed in the slots, and there will be no extra copying. <br><br>  In my opinion, quite elegant.  :) <br><br>  Let's celebrate.  Let's take <b>zend_vm_execute.h</b> file as source data ( <b>imkho</b> it will be fair) for 71 thousand lines and print it in different ways in 100 passes, dropping the minimum and maximum (each measurement started 10 times, choosing the most common option): <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $file = explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, file_get_contents(<span class="hljs-string"><span class="hljs-string">"C:\projects\C\php-src\Zend\zend_vm_execute.h"</span></span>)); $out = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($c = <span class="hljs-number"><span class="hljs-number">0</span></span>; $c &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>; $c++) { $start = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); ob_start(); $i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($file <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $line) { $i++; <span class="hljs-comment"><span class="hljs-comment">// echo 'line: ', $i, 'text: ', $line; // echo 'line: ' . $i . 'text: ' . $line; // echo "line: $i text: $line"; // printf('line: %d text: %s', $i, $line); } ob_end_clean(); $out[] = (microtime(true) - $start); } $min = min($out); $max = max($out); echo (array_sum($out) - $min - $max) / 98;</span></span></code> </pre> <br><table><tbody><tr><th>  What we measure </th><th>  Average time in seconds </th></tr><tr><td>  "Rope" </td><td>  0.0129 </td></tr><tr><td>  Multiple echo </td><td>  0.0135 </td></tr><tr><td>  Concatenation </td><td>  0.0158 </td></tr><tr><td>  <b>printf</b> , for completeness </td><td>  0.0245 </td></tr></tbody></table><br><h4>  findings </h4><br><ol><li>  For strings with simple substitution, suddenly, double quotes are more optimal than single quotes with concatenation.  And the longer the lines are used - the greater the gain. </li><li>  Arguments separated by commas ... There are many nuances.  Measurement is faster than concatenation and slower than the ‚Äúrope‚Äù, but too many ‚Äúvariables‚Äù associated with I / O. </li></ol><br><h3>  Conclusion </h3><br>  It is difficult for me to think of a situation when there may be a need for such micro-optimizations.  When choosing one or another approach, it is more reasonable to be guided by other principles - for example, readability of the code or the coding style adopted by your company. <br><br>  As for me personally, I don‚Äôt like the approach with concatenations because of the arched view, although in some cases it can be justified. <br><br>  <b>PS</b> If this kind of analysis is interesting - let me know - there is a lot more there, far from always unambiguous and obvious: an array of VS objects, foreach VS while VS for, your option ... :) <br><br><h3>  A small explanation of the reading of comments </h3><br>  HEREDOC syntax and ‚Äúcomplex strings‚Äù (where the variables in curly brackets are inside) are the same strings in double quotes and are compiled in exactly the same way. <br><br>  PHP jumble with HTML like this: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $name = <span class="hljs-string"><span class="hljs-string">'Vasya'</span></span>;<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>Hello <span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>=$name<span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>! Have a nice day!</code> </pre><br>  It's just 3 <b>echo</b> in a row. </div><p>Source: <a href="https://habr.com/ru/post/447416/">https://habr.com/ru/post/447416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447406/index.html">How to work with ViewPager2</a></li>
<li><a href="../447408/index.html">Independent study of English from Elementary to Intermediate: useful resources and motivation</a></li>
<li><a href="../447410/index.html">Provincial fire or the birth of a nation</a></li>
<li><a href="../447412/index.html">Message monitoring in RabbitMQ</a></li>
<li><a href="../447414/index.html">ML.NET 1.0 RC is released. What's new?</a></li>
<li><a href="../447418/index.html">Bitcoin process. How is the payment page in B2BinPay</a></li>
<li><a href="../447420/index.html">Jumping from the stratosphere</a></li>
<li><a href="../447422/index.html">Interesting video viewing experience: instead of VR - glasses with mirrors Ximmerse Visor-X</a></li>
<li><a href="../447424/index.html">Reaktive - a multiplatform library for reactive Kotlin</a></li>
<li><a href="../447426/index.html">How, to whom and why go to consulting? Personal experience on the example of Big Data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>