<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we flew away and returned with difficulty: a detailed report on our participation in the KROK flying robot competition</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On September 3, 2012, after reading the news about the competitions of flying robots on the Habrahabr website, we understood that it was waiting! By t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we flew away and returned with difficulty: a detailed report on our participation in the KROK flying robot competition</h1><div class="post__text post__text-html js-mediator-article">  <b>On September 3, 2012, after reading the news about the competitions of flying robots on the Habrahabr website, we understood that it was waiting!</b>  By that time, we had already thought for a few months that it was time to translate our many years of interest in robotics into a professional track, and we were looking for an excuse for this. <br><br>  Therefore, questions about participation did not arise - discussions began.  Immediately decided to use a ready-made drone, focusing on the software.  At first glance, the conditions seemed simple, so there were no illusions that we could win, there were many teams, only one prize.  We decided that we would use only the camera, thus demonstrating our competence in the field of computer vision. <br><br>  Looking ahead, I want to separately note the high level of organization of competitions.  This has never happened in Russia.  We are glad that we took part in this event and we are glad that we could win. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Why camera? </h2><br>  Almost all the sensors lie: the lidar of the roads, does not see the volume and at the same time becomes blind in clear weather, the sonars interfere with each other and catch incomprehensible reflections, the IR rangefinders and Kinect work only at close distances. <br><br>  Flying on sensors is possible only for narrow, one might say, laboratory tasks.  In addition, almost all existing sensors have limitations on the radius of action. <br>  The camera in this regard is universal.  In terms of weight and power consumption, it is comparable to sonars, in terms of speed - with lidars.  For distance and resolution, the cameras have no competitors.  Virtually all wildlife uses optics, and why should we not dwell on this decision.  Of course, effective algorithms are needed to work with the camera, but that‚Äôs what we are doing in our professional interests. <br><br><h2>  Born to crawl </h2><br>  At first, in preparation for the competitions, there was practically no free time - all team members worked in different places.  Met for discussions or in a cafe, or at someone's home.  Since we already had experience with ground robots, we decided to train on them.  <a href="http://www.pololu.com/catalog/product/2151">Pololu 3Pi</a> was <a href="http://www.pololu.com/catalog/product/2151">equipped with</a> a camera, a communication module, black adhesive tape was stuck on the paper (later black paper strips were glued) in the form of a polygon layout, small copies of the markers were printed and they began to write algorithms. <br><br><img src="https://habrastorage.org/storage3/3a4/be8/d85/3a4be8d85ae9e9c9df200c7419a6c24f.jpg" alt="image"><br><img src="https://habrastorage.org/storage3/c8d/6c4/9d1/c8d6c49d18f8747630176d8d8f61a6a8.jpg" alt="image"><br><img src="https://habrastorage.org/storage3/089/d9e/f3d/089d9ef3d5cee350c567a4bf5eec29b3.jpg" alt="image"><br><br><h2>  Three of the casket </h2><br>  So imperceptibly crept the time of passage of the first checkpoint.  Under the terms of the competition, we had to send a video presentation of the team.  They decided to make a video on the background of the <a href="http://stsl.ru/">Holy Trinity St. Sergius Lavra</a> - the main attraction of Sergiev Posad.  Gathered in the morning, before work (we still worked in different places).  Temperature: -20.  Flourishing.  Drifts.  With the third double <a href="http://youtu.be/rAjCYgzF1-s">shot something</a> .  We looked at them - they laughed, but they didn‚Äôt take them back - they decided to make the others happy too. <br><br>  What was our joy when we received a letter from the organizers of the competition, even if it contained only one line: ‚ÄúYour materials are accepted!‚Äù. <br><br>  At this control point, the organizers laid out videos as they were received, and we were in the first and second ten.  Apparently, the other participants of the competition liked our simple plot - a couple of teams in their videos obviously parodied us. <br><br>  After seeing everything - and this is more than 8 hours!  - videos of other participants, we came to the conclusion that many are not aware of the complexity of the task and do not have an understanding of what and how they will do.  The following control points confirmed this - out of 237 participants who passed KT-1, 204 remained after KT-2 (to pass it, it was necessary to simply send confirmation that the participant continues to participate in the competition), and after the third - only 72 (here it was necessary show the current and automatically controlled drone). <br><br>  Experiments with a ground robot proved that it was possible in principle to carry out a mission only around the camera, but it was necessary to proceed to the flights. <br><br><h2>  How amazing the world is </h2><br>  At this stage, we already had a Parrot Ar.Drone 2.0 quadrocopter and managed to fly it a bit.  The next step we had to do directly to carry out the flight task.  It was obvious that if we did not recognize the crosses (take-off and landing markers), there would be nothing to do at the competitions. <br><br>  Choosing C # as the main development language and armed with a <a href="https://github.com/Ruslan-B">ready-to-use library of interaction with Ar.Drone</a> (written by our compatriot Ruslan Balanuhin), we started developing an automatic control system. <br><br>  At the first stage, we set ourselves the task of simply hanging over the cross.  That is, the drone had to take off, define a cross on the lower chamber and hover above its center, counteracting the air currents that carry it to the side. <br>  We have ordered smaller copies of markers from advertisers (1 m in diameter).  They put one cross in the center of the room 4x4 m. And then the first insights began: <br><ul><li>  It turns out that there are a lot of crosses around us! </li><li>  It turns out that black and white are relative concepts! </li><li>  It turns out that the standard line selection algorithms for OpenCV find lines even where we could not have imagined! </li><li>  It turns out that the camera comes with broken frames! </li></ul><br>  All this was like a cold water tub for us ... <br><br>  Refusing to select lines at this stage, we began to recognize the crosses along the contour.  After a couple of weeks of ‚Äúdancing with tambourines,‚Äù we achieved recognition accuracy of 70-80% at any time of the day and in any light, thereby completing the task - the drone took off and hung over the cross.  Already at this stage, we realized that you can not trust one recognition - it is necessary to average the result of several recognitions. <br><br><img src="https://habrastorage.org/storage3/dcd/895/4b9/dcd8954b9bcb068f3f35c34c68565d57.png" alt="image"><br>  <i>In this picture, the red circle is the center of the cross, and the yellow is the projection of the center of the drone.</i> <br><br><h2>  Carrot for drone </h2><br>  At this time (one month before the third control point) we were invited to take part in the Spring Competition of Robots, organized by the St. Petersburg <a href="http://239.ru/">Physics and Mathematics Lyceum No. 239</a> .  One of the disciplines on them was the competition of flying robots under the <a href="http://239.ru/userfiles/file/Rules_Air_Race_v1_0.pdf">rules of the RobotChallenge "Air Race"</a> . <br>  Such a good chance to get additional flight experience and communicate with other pilots, we could not miss.  But there was no time for preparation, I had to improvise. <br><br>  The goal of the competition is to fly as many correct eights as possible in 10 minutes.  According to the regulations, a dotted line was drawn on the floor as a navigation aid.  After some thought, we decided to use our experience of hovering over the cross.  Only instead of the coordinates of the center of the cross, transfer the upper visible point of the dotted line to the drone control module.  As a result, the drone, like a mule for a carrot, tried to hang over this point, and we slipped the next one. <br><br>  We had only four hours of time for debugging at the real training ground on the eve of the competition, but the decision was not only elegant, but also fruitful - we flew five laps, receiving a prize for second place. <br>  At these competitions, we were waited by another surprise - communication problems.  Of the 10 minutes allotted for the attempt, we spent more than half of the time on establishing communication with the drone - he lost it during the flight, went astray.  I had to stop him and start the job again.  In the process of communicating with other participants, it turned out that this is the standard problem of Parrot drones. <br><br>  The video shot at these competitions, we used for the passage of CT-3. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/mJl1K1yj_RI%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700255&amp;usg=ALkJrhiCbe7cSIcF0jh3PBCiJvTVZ6tbcw" frameborder="0" allowfullscreen=""></iframe><br><br><h2>  Filter, and everything will turn out </h2><br>  Returning home, we proceeded to the next stage - the flight between the markers.  After the St. Petersburg competition, it became clear that it was necessary to fly as much as possible to real distances in actual conditions. <br>  We agreed to use the school gym for the summer holidays.  They printed life-sized crosses and were again surprised - it is impossible to identify a large cross by the lower chamber, it‚Äôs just not visible in its entirety in the lower chamber. <br><br>  Once again, I had to change the concept - we returned to the definition of crosses along the lines.  The algorithm was as follows - first we get all the lines, then we begin to combine the torn ones and filter them by contrast, location (we don‚Äôt need crosses on the ceiling and walls), cutting off all unnecessary.  After that we find the crosshairs and we are already trying to figure out from them whether this looks like real markers.  That is, we filter, we filter and once again we filter.  This is terribly gluttonous in terms of resources, but it is reliable enough. <br><br>  Source Image: <br><img src="https://habrastorage.org/storage3/3c9/1fc/441/3c91fc4412e13b4427399696925505cd.png" alt="image"><br><br>  Found lines: <br><img src="https://habrastorage.org/storage3/877/bb4/b1a/877bb4b1aae6579c920fd287a0cab298.png" alt="image"><br><br>  Contrast Filter: <br><img src="https://habrastorage.org/storage3/930/b70/b75/930b70b759df0c84317675997e2a120f.png" alt="image"><br><br>  Combine torn lines: <br><img src="https://habrastorage.org/storage3/7a3/382/66a/7a338266a3a32a1a165dcd6a080ccf54.png" alt="image"><br><br>  All intersections: <br><img src="https://habrastorage.org/storage3/309/21c/5a9/30921c5a9e91ca99137725eba6067369.png" alt="image"><br><br>  The filter does not look like a cross: <br><img src="https://habrastorage.org/storage3/c84/89e/a7f/c8489ea7facac8ca5089d1dc550259cd.png" alt="image"><br><br>  Result: <br><img src="https://habrastorage.org/storage3/5c4/4fa/4d8/5c44fa4d84345b4ef4a3bd3d3e1651f3.png" alt="image"><br><br><h2>  Take mail, telephone, telegraph </h2><br>  It's time for the last checkpoint.  Under the terms of the competition, we had to go through it at the organizer's training ground. <br>  On the test flight, we signed up among the first.  On arrival at CROC, another surprise awaited us - a wind was added to the communication problems.  Our drone tritely blown away, but at that time we did not have an algorithm for counteracting wind gusts.  As a result, out of twenty attempts we managed to complete the CT-4 task only three times.  Thanks to the organizers that they gave us this attempt.  We passed KT-4 first. <br><br>  In an attempt to set up an anti-wind algorithm, we once again ran into a communication problem.  Conducting tests on the street in windy weather, we almost broke our drone, losing touch with him. <br>  We had to do something.  As we already knew, bad communication is a common problem with Parrot drones.  Therefore, we used the method of its solution already found before us - the installation of an external antenna.  The external antenna and the router allowed us to consider the question of communication closed.  As it turned out later, many teams faced this problem only at competitions. <br><br>  Three weeks before the final, the organizers finally approved the training ground.  All participants were given the opportunity to visit him twice to adjust the algorithms. <br><br><h2>  Blanket for shish kebab </h2><br>  After the first visit to the already completed test site, we had the feeling that we would not complete the task.  We had three problems: <br><ol><li>  Definition of the corridor.  The dividing partition was organized using building blocks that interfered with our wall detection algorithm. </li><li>  Landing in the wind.  We carried out the landing operation, it can be said, with closed eyes: we find a cross, heal it, and we land (we fly two or three meters and sit down).  However, any gust of wind blows us away from the site. </li><li>  Take off and turn in the wind.  We also did this operation ‚Äúon the machine‚Äù - as a result, we could be thrown to the wall by the wind (for some reason, we thought that it was forbidden to touch the walls). </li></ol><br>  Attempting to fly through the maze on the manual control of the chamber led to a collision with a wall and crash.  The second attempt led to the same result. <br>  All that we did on our first visit was to shoot the landfill at different times - when the sun was behind the clouds and did not give extra shadows, and vice versa - with bright sun and contrasting shadows. <br><br>  For the rest of the week, we refined the definition of the corridor using the ‚Äú <a href="http://en.wikipedia.org/wiki/Vanishing_point">vanishing point</a> ‚Äù approach. <br>  Arriving for the second time, three days before the competition, we were able to automatically fly the corridor in one direction, but the problem of landing and take-off remained unresolved. <br><br>  We had two days left.  It was not clear how to repeat the gusting wind conditions in order to find out if we won it? <br>  As a way to fight the wind, we used active resistance to external influences during landing - trying to keep the angles of heel, pitch and yaw.  And they decided to take off the propeller - at the same time gaining height and turning. <br>  Debugged in the gym, creating gusts of wind with a sheet of fiberboard.  It all looked pretty ridiculous. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/6mGH8HnTHtc%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700255&amp;usg=ALkJrhi5jiHqaJ5B0XrfQyq53pRVF7tucA" frameborder="0" allowfullscreen=""></iframe><br><br><h2>  I drink to the bottom ... </h2><br>  On August 23, at 21:30, returning from the gym, we raised glasses for having adequately passed all stages of the competition - now we knew that we would complete the task.  More precisely, we have a good chance to fulfill it - His Majesty Chance has not been canceled. <br>  We learned to fly in the corridor without colliding with the walls.  We recognized crosses well in any weather.  Both crosses (I think the participants will understand me).  Communication and wind problems have also been resolved. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/xR04u_BdkTQ%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700255&amp;usg=ALkJrhhZqhG2wJeS_9enFDVDYkQ0QJn8pg" frameborder="0" allowfullscreen=""></iframe><br><br>  The only thing that we did not have time is the automatic choice of the direction of the route.  To determine turns, we used the right / left hand rule, which was switched after each landing.  And it almost played a cruel joke with us. <br><br><h2>  Hedgehog in the fog </h2><br>  Having rested against the wall of the obstacles on the way back while performing the flight, we turned around according to the rule of the right hand and flew to the already visited marker.  After landing, we switched to the left hand.  Having reached the last turn, they turned around again and flew back again.  And only after the third landing, the rule of the right hand turned on again, and we returned safely. <br>  We understood that 6 minutes and 45 seconds, obtained by us in the first attempt, is a losing time - it is enough for someone to just complete the task.  In this case, the rule of the right / left hand, we could not cancel, and there was a chance that the drone again get off and start circling.  Then at the second attempt we decided to ‚Äúfly all the money‚Äù and raised the speed of the drone one and a half times.  But, unfortunately, they forgot to change the speed reduction parameter, depending on the distance to the obstacle, and did not manage to brake in time, finally stopping against the wall. <br><br>  It was really unexpected for us that no one else could go the distance.  For a day and a half, we waited for someone to fly faster than us (the organizer's drone had the best time, but they participated in the competition off-set), and we can already relax and rest, sincerely wishing other participants to succeed.  But luck was capricious, and this time it was on our side. <br><br>  Below is a flight record from the drone.  The recognition speed was uneven, so the time on the video does not coincide with reality. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/jWDcy073kRQ%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253,15700255&amp;usg=ALkJrhjuAUqgtTo6sJ4Mz-gMJ80PUomfrQ" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/193304/">https://habr.com/ru/post/193304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193286/index.html">Three practices of web design for the upcoming iOS7</a></li>
<li><a href="../193292/index.html">Receiving a 3D object for 1 photo</a></li>
<li><a href="../193294/index.html">The future of the gaming industry with hi-res 3D scans of people and Oculus Rift</a></li>
<li><a href="../193300/index.html">Shade: long shadows of a trendy flat design on CSS</a></li>
<li><a href="../193302/index.html">Phonebloks - modular smartphone</a></li>
<li><a href="../193306/index.html">NORD data center on Korovinsky highway</a></li>
<li><a href="../193308/index.html">Challenge for $ 500. How a startup programmer was looking for</a></li>
<li><a href="../193310/index.html">Klipsch KMC 3 Wireless Bluetooth Audio System Overview</a></li>
<li><a href="../193312/index.html">PrioVR - another piece of a set of "avoiding reality"</a></li>
<li><a href="../193314/index.html">Drive Market: shopping and driving</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>