<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>classic TCP server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My first TCP Server was created a couple of years ago. The basis for the creation was the book by R. Stevenson "Unix - Professional Programming." Ther...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>classic TCP server</h1><div class="post__text post__text-html js-mediator-article">  My first TCP Server was created a couple of years ago.  The basis for the creation was the book by R. Stevenson "Unix - Professional Programming." There are several approaches to the creation of TCP servers.  In this post I want to talk about the classic TCP server. <br><br><a name="habracut"></a><br><br>  When building a classic TCP Server, three components can be distinguished: <br><ul><li>  demonization of the process </li><li>  work with sockets </li><li>  creating a child process and handling its completion </li></ul><br>  When working with sockets, you must: <br><ul><li>  create socket descriptor </li><li>  assign an address to a socket </li><li>  accept connection request </li><li>  establish a connection </li><li>  accept / send data </li></ul><br>  Consider the code, see the comments: <br> <code>1 struct sockaddr_in addr; <br> 2 struct sockaddr_un local; <br> 3 <br> 4 int err,len; <br> 5 <br> 6 //    <br> 7 if( -1 == ( ls = socket( AF_INET, SOCK_STREAM, IPPROTO_TCP ) )) { <br> 8 perror( "Socket can not created!\n"); <br> 9 return ; <br> 10 } <br> 11 <br> 12 //    SO_REUSEADDR <br> 13 //      . bind() <br> 14 setsockopt( ls, SOL_SOCKET, SO_REUSEADDR, &amp;rc, sizeof(rc) ); <br> 15 memset( &amp;addr , 0, sizeof(addr) ); <br> 16 <br> 17 //      <br> 18 addr.sin_family = AF_INET; <br> 19 addr.sin_port = htons (port); <br> 20 addr.sin_addr.s_addr = INADDR_ANY ; <br> 21 <br> 22 //       <br> 23 if ( err = bind( ls, (struct sockaddr*) &amp;addr, sizeof(addr) ) &lt; 0 ) { <br> 24 close(ls); <br> 25 perror( "bind error!\n%s ", gai_strerror(err) ); <br> 26 return ; <br> 27 } <br> 28 <br> 29 <br> 30 //    <br> 31 if ( listen( ls, 25) &lt; 0) { ; <br> 32 close(ls); <br> 33 perror( "listen error!\n"); <br> 34 return ; <br> 35 } <br> 36 <br> 37 //   <br> 38 pid_t pid = Demonize(); <br> 39 <br> 40 if ( pid==-1 ) { <br> 41 close(ls); <br> 42 perror( "demonize error!\n"); <br> 43 return; <br> 44 } <br> 45 <br> 46 //      <br> 47 while (true) { <br> 48 //  ,   <br> 49 rc = accept( ls, NULL, NULL ); <br> 50 //    <br> 51 pid = fork(); <br> 52 <br> 53 if ( pid &lt; 0) syslog( LOG_ERR, " fork abort" ); <br> 54 if (pid == 0 ) { //   <br> 55 close( ls ); //     <br> 56 <br> 57 process(rc); //  , <br> 58 //      <br> 59 close(rc); <br> 60 return; <br> 61 } else { <br> 62 //   <br> 63 close( rc ); //    <br> 64 } <br> 65 <br> 66 } // end while <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And now some explanations: <br><br>  Create a listening socket descriptor. Lines 7-10: <br><br>  #include &lt;sys / socket.h&gt; <br>  int socket (int domain, int type, int protocol); <br><br>  domain constant: <br>  AF_INET - IP Socket <br>  AF_UNIX - UNIX socket <br><br>  constant type: <br>  SOCK_STREAM - persistent connection socket <br>  SOCK_DGRAM - datagram socket <br><br>  int protocol constant: <br>  IPPROTO_TCP - protocol type <br><br>  The socket function returns the descriptor number of the listening socket.  If the result is less than 0, then the system error. <br><br>  Lines 12-28 Assign an address to a socket. <br><br>  #include &lt;sys / socket.h&gt; <br>  int setsockopt (int socket, int level, int option_name, const void * option_value, socklen_t option_len); <br>  sets the socket option: <br>  SO_REUSEADDR reuse of local addresses for bind () function <br>  If the result of the operation is less than 0, then the system error. <br><br>  Lines 18-20 set the listening address and port in the sockaddr_in structure <br>  addr.sin_family = AF_INET;  // domain type INET <br>  addr.sin_port = htons (port);  // assign the port <br>  addr.sin_addr.s_addr = INADDR_ANY;  // any incoming address <br><br>  The bind function associates an address with a nameless socket: <br>  #include &lt;sys / socket.h&gt; <br>  int bind (int socket, const struct sockaddr * address, socklen_t address_len); <br>  int socket - socket descriptor <br>  address - the address of the sockaddr structure with <br>  address_len - the size of the sockaddr structure <br>  If the result of the operation is less than 0, then the system error. <br><br>  We start to listen to a socket of the Line 31-35.  Using the listen function, the server declares its desire to accept connection requests: <br><br>  #include &lt;sys / socket.h&gt; <br>  int listen (int socket, int backlog); <br>  int socket - socket descriptor <br>  int backlog - the maximum length of the queue of pending connection requests <br>  If the result of the operation is less than 0, then the system error. <br><br>  Line 38-44, demonizing the process.  More details in the cl.  an article on demons processes. <br><br>  Lines 47-66, processing the connection <br><br>  Line 49, The accept function accepts a request and converts it to a connection. <br>  #include &lt;sys / socket.h&gt; <br>  int accept (int socket, struct sockaddr * restrict address, socklen_t * rest address address_len); <br>  int socket - the descriptor of the listening socket, it is not connected to the connection and remains to listen to subsequent connections, <br>  address - a pointer to the socket address structure, in which the client address will be stored at the end <br>  address_len is the size of the buffer for placing the address structure, if address and address_len are NULL, then we are not interested in the client‚Äôs address. <br>  The accept function returns a socket descriptor associated with the connection, or -1 in case of failure. <br><br>  We can handle the connection and accept the following, but as a rule, the connections are processed for a long time and the server cannot wait; therefore, after the connection is established, the child process is generated in line 51 with the fork command.  Next, in the parent process, close the connection descriptor, and in the child process, close the listening socket descriptor and call the user-defined function that will handle our connection. <br>  The connection is processed using the read / write commands: <br>  write to socket: write (rc, buff, len) <br>  read from socket: read (rc, buff, len) <br>  rc - connection descriptor <br>  buff - read / write buffer <br>  len is long. <br>  At the end of the connection processing, the rc socket descriptor must be closed: close (rc). <br><br>  What is not included and will be separately described in other articles: description of the fork command, signal processing, demonization of the process. </div><p>Source: <a href="https://habr.com/ru/post/70796/">https://habr.com/ru/post/70796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70790/index.html">Visiting Turbomilk</a></li>
<li><a href="../70792/index.html">PHP & AMQP (Continued) Installing php-rabbit</a></li>
<li><a href="../70793/index.html">Use the Observer pattern to create a process execution indicator in Javascript</a></li>
<li><a href="../70794/index.html">Algorithm: we get rid of passwords for different resources - we use a mailbox</a></li>
<li><a href="../70795/index.html">Not another XSS filter</a></li>
<li><a href="../70800/index.html">Create an application - "Drum Set"</a></li>
<li><a href="../70801/index.html">UPD: Cisco and 2 providers</a></li>
<li><a href="../70803/index.html">Explore view.yml features</a></li>
<li><a href="../70804/index.html">Just add water: Myna</a></li>
<li><a href="../70805/index.html">Interesting facts about the songs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>