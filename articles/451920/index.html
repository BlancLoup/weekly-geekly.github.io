<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization of mail storage in the Zimbra Collaboration Suite</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In one of our previous articles on infrastructure planning when deploying to the Zimbra Collabortion Suite enterprise, it was said that the main limit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization of mail storage in the Zimbra Collaboration Suite</h1><div class="post__text post__text-html js-mediator-article">  In one of our <a href="https://habr.com/ru/company/zimbra/blog/448148/">previous articles</a> on infrastructure planning when deploying to the Zimbra Collabortion Suite enterprise, it was said that the main limitation with the operation of this solution is the I / O speed of disk devices in mail storages.  And indeed, at the time when several hundred employees of the enterprise simultaneously access the same mail storage, the width of the channel for recording and reading information from hard disks may not be enough for responsive service.  And if for small Zimbra installations this does not become a particular problem, then in the case of large enterprises and SaaS providers all this can lead to unresponsive e-mail and, as a result, a decrease in employee efficiency, as well as a violation of the SLA.  That is why, when designing and operating large-scale Zimbra installations, special attention should be paid to optimizing the performance of hard disks in mail storage.  Let's look at two cases and try to figure out which methods to optimize the load on disk storage can be applied in each of them. <br><br><img src="https://habrastorage.org/web/524/a74/d9d/524a74d9dc834ae581c7893fc079c693.png" alt="image"><a name="habracut"></a><br><br>  <b>1. Optimization in the design of large-scale installation Zimbra</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the design stage of a high-loaded Zimbra installation, its administrator will have to choose which storage system to use.  In order to decide on this issue, you should be aware that the main load on hard drives is created by the MariaDB DBMS that is part of the Zimbra Collaboration Suite, the Apache Lucene search system, and the BLOB storage.  That is why for the operation of these software products under high loads, you must use high-speed and reliable equipment. <br><br>  Under normal conditions, Zimbra can be installed both on RAID from hard drives and on storage connected via the NFS protocol.  In cases of very small installations, you can install Zimbra on a regular SATA disk.  However, in the conditions of large installations, all these technologies demonstrate various shortcomings in the form of reduced write speed or low reliability, which is unacceptable neither for large enterprises, nor, especially, for SaaS providers. <br><br>  That is why in the conditions of large-scale infrastructures Zimbra would be best to use SAN.  It is she who is currently capable of providing the greatest throughput for storage devices and at the same time, due to the possibility of connecting a large amount of cache, its use practically carries no significant risks to the enterprise.  A good idea would be to use NVRAM, which is used in many SANs to speed up work during recording.  But it is better to disable caching of the recorded data on the disks themselves, since it can lead to irreparable damage to the media and data loss in the event of power problems. <br><br>  With regard to the choice of the file system, the optimal choice would be to use standard for Linux Ext3 / Ext4.  The main nuance associated with the file system is that it should be mounted with the <b>-noatime option</b> .  This option will disable the function of fixing the time of the last access to files, which means that it will greatly reduce the load on reading and writing.  In general, when creating an ext3 or ext4 file system for Zimbra, use the following <b>mke2fs</b> utility parameters: <br><br><blockquote>  <b>-j</b> - To create a journal file system Create a file system with an ext3 / ext4 journal. <br>  <b>-L TITLE</b> - To create a volume name, then use it in / etc / fstab <br>  <b>-O dir_index</b> - To use a hashed search tree to speed up the search for files in large directories <br>  <b>-m 2</b> - To reserve 2% of the volume in large file systems under the root directory <br>  <b>-J size = 400</b> - To create a large log <br>  <b>-b 4096</b> - To determine block size in bytes <br>  <b>-i 10240</b> - For a message store, this parameter should correspond to the average message size.  You should be attentive to this parameter, since subsequently its value cannot be changed. </blockquote><br>  In addition, it is recommended to enable <b>dirsync</b> for blob storage, Lucene search meta data storage and MTA queue storage.  This should be done for the reason that Zimbra usually uses the <b>fsync</b> utility to ensure that the data blob is written to disk.  However, when a Zimbra mail repository or MTA creates new files during message delivery, it becomes necessary to write changes to the disk in the appropriate folders.  That is why even in the case when the file is already written to disk using <b>fsync</b> , the record of its addition to the directory may not have time to write to the disk and as a result may be lost due to a sudden server failure.  By using <b>dirsync,</b> these problems can be avoided. <br><br>  <b>2. Optimization with running Zimbra infrastructure</b> <br><br>  It often happens that after several years of operation Zimbra the number of its users increases significantly and the work of the service becomes less and less responsive every day.  The way out of this situation is obvious: you just need to add new servers to the infrastructure so that the service works again as quickly as before.  Meanwhile, it is far from always possible to immediately add new servers to the infrastructure in order to increase its speed.  Often, IT managers have a long time to coordinate the acquisition of new servers with the accounting department or security department, in addition, suppliers often fail, who can bring a new server late or not deliver what they need. <br><br>  Of course, the best thing is to build your Zimbra infrastructure with a margin to always have a margin for its expansion and not to depend on anyone, but if the error has already been made, the IT manager can only smooth out its consequences as much as possible.  For example, an IT manager can achieve small productivity gains by using a temporary shutdown of Linux system services, which, when running, regularly access hard drives and, as a result, can adversely affect the speed of Zimbra.  So, for a while you can turn off: <br><br><blockquote>  <b>autofs, netfs</b> - Remote File System Discovery Services <br>  <b>cups</b> - Print Service <br>  <b>xinetd, vsftpd</b> - Built-in * NIX services that you probably won't need <br>  <b>portmap, rpcsvcgssd, rpcgssd, rpcidmapd</b> - Remote procedure call services that are commonly used in conjunction with network file systems <br>  <b>dovecot, cyrus-imapd, sendmail, exim, postfix, ldap</b> - Duplicates of the main utilities that make up the Zimbra Collaboration Suite <br>  <b>slocate / updatedb</b> - Since Zimbra stores each message in a separate file, the updatedb service starts every day, it can cause problems, and therefore you can do it manually during the lowest load on the servers </blockquote><br>  Saving system resources as a result of disabling these services will not be very significant, but even this can be very useful in conditions close to force majeure.  After the new server is added to the Zimbra infrastructure, it is recommended to re-enable previously disabled services. <br><br>  You can also optimize the work of Zimbra due to the removal of the syslog service on a separate server so that it does not load the mail storage hard drives during operation.  For these purposes, almost any computer is suitable, up to the cheap Raspberry Pi single-board device. </div><p>Source: <a href="https://habr.com/ru/post/451920/">https://habr.com/ru/post/451920/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451908/index.html">The history of computers: night at the Yandex Museum</a></li>
<li><a href="../451912/index.html">MuseNet Deep Neural Network Writes Music</a></li>
<li><a href="../451916/index.html">Asynchronous PHP and the story of one bike</a></li>
<li><a href="../451918/index.html">On the issue of TI</a></li>
<li><a href="../45192/index.html">Ltsp. We connect Flash-carriers for clients</a></li>
<li><a href="../451922/index.html">Fixed point arithmetic in C ++</a></li>
<li><a href="../451926/index.html">About live-code after 130 streams</a></li>
<li><a href="../451930/index.html">Automation of staircase lighting</a></li>
<li><a href="../451932/index.html">PHDays 9: Welcome to the secure development section</a></li>
<li><a href="../451934/index.html">Alexander Lamden: ‚ÄúAny piece of iron has a character‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>