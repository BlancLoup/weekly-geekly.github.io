<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The system of separation of access rights in the web application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will go with you a full cycle of ideas, database design, writing PHP-code, and the final optimization. I will try to tell everythi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The system of separation of access rights in the web application</h1><div class="post__text post__text-html js-mediator-article">  In this article, we will go with you a full cycle of ideas, database design, writing PHP-code, and the final optimization.  I will try to tell everything as easy as possible.  I will use PHP and Mysql for examples.  At the same time I will train beginners :). <br><br>  In this article I will touch on the questions: <br>  1. The idea of ‚Äã‚ÄãACL <br>  2. Designing the database <br>  3. Normalization of DB <br>  4. Code refactoring <br>  5. Optimization of working code <br><br>  The article is a response to the <a href="http://habrahabr.ru/blogs/about_cms/51231/">binary distribution of access rights in the CMS</a> .  While the author is writing the practical part, I want to provide my version, which I have been using for a long time. <br>  What I am about to tell is similar to an <a href="http://ru.wikipedia.org/wiki/ACL">ACL</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><h3>  Simplified description of the idea </h3><br>  Access rights belong to all objects to which you want to apply them. <br>  If we consider an example of a simple news page (which we will write here), then the access rights should have: <br>  1) The main news page - global access rights, meaning ‚Äúcreating new news‚Äù, ‚Äúmoderating news‚Äù, ‚Äúviewing the page itself‚Äù. <br>  2) Each news - the ability to "edit news by the author" or "do not leave comments." <br><br>  The access rights system consists of: <br>  <strong>{Group} + {Actions}</strong> or <strong>{Group} - {Actions}</strong> <br><br>  <strong>Group</strong> is a set of names that are: <br>  1) The rights of a particular user (for example, 'User1', 'User2' ...).  For example, it is used for private messages to which this user has access or to allow editing of only his messages on the site. <br>  2) Groups of private pages (or groups of users) to which it is necessary to give rights to certain actions.  (for example, administrators, supermoderators, etc.) <br>  3) Additional properties.  (For example, the flag - mode switch) <br><br>  <strong>Action</strong> - a set of actions that users with the existing {Group} can do.  In our news system you can use: <br>  N - add new topic <br>  D - delete topic <br>  E - edit topic <br>  V - see the topic <br>  C - leave a comment <br>  B - delete comment <br><br>  <strong>¬±</strong> means to give the user with such rights or not to give (priority) access to the action.  For example: Users + VC, Users-C = Users + V. <br><br>  Now consider an example of permissions for a simple news site: <br>  MainNewsPage object: <br>  Users + VC, Moderator + NEDB, Admin + NEDB <br>  NewsMessage object: <br>  User1 + ED (in principle, it is not necessary if only moderators can add) <br>  Users-C (can be used if you do not want to leave comments) <br>  NewsComment object: <br>  User2 + B (and here it is necessary, since any user can leave a comment, but not everyone can delete them) <br><br><h3>  Simplify the system to understand the idea of ‚Äã‚Äãa computer </h3><br>  To begin with, we will define Databases, for work with the rights of objects. <br><br>  Since we have a list of several rights, we can start with the following database: <br>  <strong>RightsID</strong> - rights list identifier. <br>  <strong>Group</strong> - the name of the group. <br>  <strong>Sign</strong> is a group sign. <br>  <strong>Action</strong> - the name of the action. <br><br>  Example1 (rights for MainNewsPage): <br><table><tbody><tr><th>  ID </th><th>  Rightsid </th><th>  Group </th><th>  Sign </th><th>  Action </th></tr><tr><td>  one </td><td>  100 </td><td>  Users </td><td>  + </td><td>  V </td></tr><tr><td>  2 </td><td>  100 </td><td>  Users </td><td>  + </td><td>  C </td></tr><tr><td>  3 </td><td>  100 </td><td>  Moderator </td><td>  + </td><td>  N </td></tr><tr><td>  four </td><td>  100 </td><td>  Moderator </td><td>  + </td><td>  E </td></tr><tr><td>  five </td><td>  100 </td><td>  Moderator </td><td>  + </td><td>  D </td></tr><tr><td>  6 </td><td>  100 </td><td>  Moderator </td><td>  + </td><td>  B </td></tr><tr><td>  7 </td><td>  100 </td><td>  Admin </td><td>  + </td><td>  N </td></tr><tr><td>  eight </td><td>  100 </td><td>  Admin </td><td>  + </td><td>  E </td></tr><tr><td>  9 </td><td>  100 </td><td>  Admin </td><td>  + </td><td>  D </td></tr><tr><td>  ten </td><td>  100 </td><td>  Admin </td><td>  + </td><td>  B </td></tr></tbody></table><br>  Example2 (rights for NewsMessage): <br><table><tbody><tr><th>  ID </th><th>  Rightsid </th><th>  Group </th><th>  Sign </th><th>  Action </th></tr><tr><td>  eleven </td><td>  101 </td><td>  User1 </td><td>  + </td><td>  D </td></tr><tr><td>  12 </td><td>  101 </td><td>  User1 </td><td>  + </td><td>  E </td></tr><tr><td>  13 </td><td>  101 </td><td>  Users </td><td>  - </td><td>  C </td></tr></tbody></table><br>  Now, if we request <font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` WHERE` RightsID` = 100</font> , then we get all the rights that belong to the object we need. <br><br><h3>  Normalization of tables.  Add user rights. </h3><br>  The user who will view our page must have the rights that he owns.  Based on them, we can know whether the user has the right to action. <br>  For example: User2, Users, Moderator. <br><br>  To do this, we define the table of rights: <br>  <strong>RightsID</strong> - user rights list identifier. <br>  <strong>Group</strong> - the name of the group in which the user is a member. <br><br>  Example: <br><table><tbody><tr><th>  ID </th><th>  Rightsid </th><th>  Group </th></tr><tr><td>  one </td><td>  ten </td><td>  User1 </td></tr><tr><td>  2 </td><td>  ten </td><td>  Users </td></tr><tr><td>  3 </td><td>  ten </td><td>  Moderator </td></tr></tbody></table>  Now we will bring both our tables to <a href="http://habrahabr.ru/blogs/development/45707/">normal form</a> .  ( <a href="http://ru.wikipedia.org/wiki/%25D0%259D%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0">wiki</a> ) <br><br>  As a result, ID keys will be eliminated, and we will get 3 tables: <br>  <strong><i>rights_action</i></strong> - object rights <br>  <strong>RightsID: integer (pk)</strong> - identifier of the list of rights. <br>  <strong>GroupID: integer (pk)</strong> - group name. <br>  <strong>Sign: tinyint (1)</strong> is a group sign. <br>  <strong>Action: enum (pk)</strong> - the name of the action. <br>  <strong><i>rights_group</i></strong> - user rights <br>  <strong>RightsID: integer (pk)</strong> - user rights list identifier. <br>  <strong>GroupID: integer (pk)</strong> - identifier of the group in which the user is a member. <br>  <strong><i>rights_names</i></strong> - group names <br>  <strong>GroupID: integer (pk)</strong> - group identifier. <br>  <strong>name</strong> - the name of the group. <br><br>  We replaced the primary key 'ID' with other keys, which in some cases consist of several table fields. <br>  The group sign is now 0 (+) or 1 (-), because it will be easier for us to access them. <br>  The GroupID identifier directly points to the name in rights_names. <br>  In fact, the table of <strong><i>rights_names</i></strong> is in our case an appendix that will not be used to identify the rights to the necessary action.  This table now serves only for the ‚ÄúHumanization‚Äù of the results. <br><br>  An example of what we got: <br><table><tbody><tr><th colspan="4">  rights_name </th></tr><tr><th>  GroupID </th><th>  name </th></tr><tr><td>  ten </td><td>  Users </td></tr><tr><td>  eleven </td><td>  Moderator </td></tr><tr><td>  12 </td><td>  Admin </td></tr><tr><td>  1001 </td><td>  User1 </td></tr><tr><td>  1002 </td><td>  User2 </td></tr><tr><td>  1003 </td><td>  User3 </td></tr><tr><th colspan="4">  rights_group </th></tr><tr><th>  Rightsid </th><th>  GroupID </th></tr><tr><td>  one </td><td>  1001 </td></tr><tr><td>  one </td><td>  ten </td></tr><tr><td>  one </td><td>  eleven </td></tr><tr><th colspan="4">  rights_action </th></tr><tr><th>  Rightsid </th><th>  GroupID </th><th>  Sign </th><th>  Action </th></tr><tr><td>  100 </td><td>  ten </td><td>  0 </td><td>  message_view </td></tr><tr><td>  100 </td><td>  ten </td><td>  0 </td><td>  comment_create </td></tr><tr><td>  100 </td><td>  eleven </td><td>  0 </td><td>  message_create </td></tr><tr><td>  100 </td><td>  eleven </td><td>  0 </td><td>  message_edit </td></tr><tr><td>  100 </td><td>  eleven </td><td>  0 </td><td>  message_delete </td></tr><tr><td>  100 </td><td>  eleven </td><td>  0 </td><td>  comment_delete </td></tr><tr><td>  100 </td><td>  12 </td><td>  0 </td><td>  message_create </td></tr><tr><td>  100 </td><td>  12 </td><td>  0 </td><td>  message_edit </td></tr><tr><td>  100 </td><td>  12 </td><td>  0 </td><td>  message_delete </td></tr><tr><td>  100 </td><td>  12 </td><td>  0 </td><td>  comment_delete </td></tr><tr><td>  101 </td><td>  1001 </td><td>  0 </td><td>  message_edit </td></tr><tr><td>  101 </td><td>  1001 </td><td>  0 </td><td>  message_delete </td></tr><tr><td>  101 </td><td>  ten </td><td>  one </td><td>  comment_create </td></tr></tbody></table>  It became less obvious - for a man.  A computer that operates on numbers has made it much easier to handle tables. <br>  Now we can add rights to any object in the table for any action.  Actions are now recorded in a table in the form of ENUM ('action' field), which simplifies the understanding and development of projects.  The action itself is as a string and can be called anything. <br><br>  `rights_group` should be tied to users and speaks about the rights that the user has. <br>  `rights_action` should be tied to objects and say with what rights, what actions the user can perform. <br><br>  For example (for our news site): <br><table><tbody><tr><th colspan="5">  news_page (main news page options) </th></tr><tr><th>  PageID </th><th>  Rightsid </th><th>  Name </th></tr><tr><td>  one </td><td>  100 </td><td>  News page </td></tr><tr><th colspan="5">  news_message (messages on the news page) </th></tr><tr><th>  MsgID </th><th>  PageID </th><th>  Rightsid </th><th>  Header </th><th>  Message </th></tr><tr><td>  one </td><td>  one </td><td>  101 </td><td>  Hooray, we are on the main !!! </td><td>  But this is only the beginning, then when we get closer to the administration of Habr ... </td></tr><tr><td>  2 </td><td>  one </td><td>  101 </td><td>  Last week's news </td><td>  Despite our slender procession on the main, it seems the plans have broken off ... </td></tr></tbody></table><br><h3>  Development of the library of work with access rights </h3><br>  And now we will look at what is needed in order to put these tables together and produce a sample of the results we need. <br><br>  The algorithm of our actions when checking the possibility of action: <br>  1) We take from the database a sample of rights for the necessary object (s).  (100: Users + VC, Moderator + NEDB, Admin + NEDB) <br>  2) Select the action we need.  (V: Users + V) <br>  3) Compare user access rights and our sample.  (Users, User1 &lt;=&gt; Users +) <br>  4) If there are no results, then return false. <br>  5) If there are results, but consist of cons, we return false.  Otherwise, return true. <br><br>  Another point worth noting: access rights from the parent (news pages) go to the child (in this case, to the message).  That is, if you specify on the page + 'message_view', then all messages will automatically be with such rights (read).  This circumstance we will use and check in paragraph 1 of our algorithm. <br><br>  Let's proceed to the implementation: <br>  In fact, we do not need PHP right now to make the right sample.  We will do everything on mysql. <br>  <strong>Paragraph 1.</strong> <br>  In our case, it is necessary to read the `rightsID` data from several objects and then select it from our table. <br>  Several objects, because we will have the rights to the page and the rights to individual messages on the page.  The rights of both will complement each other.  (child add parent) <br>  For example, the rights of the message on the page: <br>  <font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` WHERE` RightsID` = 100 <font color="#0000ff">or</font> `RightsID` = 101</font> , where <br>  100 - page ID <br>  101 - ID of the message rights on the page <br>  In order to make it easier to communicate in PHP, we slightly optimize the syntax: <br>  <font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` WHERE` RightsID` <font color="#0000ff">IN</font> (100, 101)</font> <br><br>  <strong>Point 2.</strong> <br>  With the choice of the action we need, everything is also simple: <br>  <font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` WHERE` action` = <font color="#008000">'message_view'</font></font> <font color="black"><br><br></font>  <font color="black"><strong>Point 3.</strong></font> <font color="black"><br></font>  <font color="black">And here it is necessary to combine several SELECTs.</font>  <font color="black">First, we select the user's access rights, and then compare them with the ones we need.</font>  <font color="black">If you combine these actions into one, you get:</font> <font color="black"><br></font>  <font color="black"><font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` WHERE` GroupID` <font color="#0000ff">IN</font> ( <font color="#0000ff">SELECT</font> `GroupID` FROM` rights_group` <font color="#0000ff">WHERE</font> `RightsID` = 1)</font></font> <font color="black"><br><br></font>  <font color="black"><strong>Item 1-3.</strong></font> <font color="black"><br></font>  <font color="black">Now all together in one complex query:</font> <font color="black"><br></font> <blockquote>  <font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` WHERE` RightsID` <font color="#0000ff">IN</font> (100, 101) <font color="#0000ff">AND</font> `action` = <font color="#008000">'message_view'</font> AND` GroupID` <font color="#0000ff">IN</font> ( <font color="#0000ff">SELECT</font> `GroupID` FROM` rights_group` <font color="#0000ff">WHERE</font> `RightsID` = 1)</font> </blockquote>  This example takes user rights # 1, rights of objects # 100 and # 101, the action 'view messages' (message_view) and gives the result (signs + and -). <br><br>  <strong>Item 1-5.</strong> <br>  Insert this into the PHP implementation and at the same time add the check: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">function</font> check( <font color="#008000">/*array(int,int,...)*/</font> $obj_rights, <font color="#008000">/*integer*/</font> $user_rightsID, <font color="#008000">/*string*/</font> $action){ <br> $result = mysql_query( <font color="#A31515">"SELECT * FROM `rights_action` WHERE `RightsID` IN ("</font> . implode( <font color="#A31515">","</font> ,$obj_rights) . <font color="#A31515">") AND `action`= '$action' AND `GroupID` IN (SELECT `GroupID` FROM `rights_group` WHERE `RightsID` = $user_rightsID)"</font> ); <br> <br> <font color="#0000ff">if</font> (!$result) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <br> $tmp=array(); <br> <font color="#0000ff">while</font> ($t = mysql_fetch_assoc($result)){ <br> <font color="#008000">//     (Users, User1, Moderator) </font> <br> <font color="#008000">// + (0)  - (1) ( ).</font> <br> <font color="#0000ff">if</font> (!isset($tmp[$t[ <font color="#A31515">'groupID'</font> ]])) <br> $tmp[$t[ <font color="#A31515">'groupID'</font> ]] = $t[ <font color="#A31515">'sign'</font> ]; <br> <font color="#0000ff">else</font> <br> $tmp[$t[ <font color="#A31515">'groupID'</font> ]] |= $t[ <font color="#A31515">'sign'</font> ]; <br> } <br> mysql_free_result($result); <br> <br> <font color="#0000ff">if</font> ($tmp) <br> <font color="#008000">//  +    ,  true.  false.</font> <br> <font color="#0000ff">return</font> (array_search(0, $tmp) !== FALSE); <br> <br> <font color="#008000">//     $tmp == false</font> <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  This is only the beginning, the first step. <br><br><h3>  Create a class working with access rights </h3><br>  What do we need? <br>  Develop an example of working with our class. <br>  1) First, you must specify the rights of the user, with the rights of which we need to work.  And the class itself must be tied to a specific user. <br>  2) Adding objects to the class of child-rights with the addition of properties. <br>  3) Check access for various actions (action). <br><br>  Comments and thoughts: <br>  User rights can be specified when creating a class in __construct. <br>  When adding new properties so that the properties in the class are not lost, it will be necessary to make a new class (clone the old one with the added properties). <br><br>  Let's try to implement it all: <br><blockquote> <code><font color="black"><font color="#0000ff">class</font> Rights{ <br> <font color="#0000ff">private</font> $usrID; <font color="#008000">//User rights ID</font> <br> <br> <font color="#0000ff">function</font> __construct($user_rightsID){ <br> $ <font color="#0000ff">this</font> -&gt;usrID=$user_rightsID; <br> } <br> }</font></code> </blockquote>  Now you can use the structure: <blockquote> <code><font color="black">$UserRights = <font color="#0000ff">new</font> Rights($CurrentUser-&gt;rightsID);</font></code> </blockquote>  and use $ UserRights in the future program. <br><br>  Consider adding the right object to check: <blockquote> <code><font color="black"><font color="#0000ff">class</font> Rights{ <br> <font color="#0000ff">private</font> $group=array(); <font color="#008000">//    </font> <br> <br> <font color="#0000ff">function</font> include_right($grp){ <br> $clone=clone $ <font color="#0000ff">this</font> ; <font color="#008000">//   ,  </font> <br> $clone-&gt;group[]=$grp; <font color="#008000">//  </font> <br> <font color="#0000ff">return</font> $clone; <br> } <br> <br> <font color="#008000">//... constructor</font> <br> }</font></code> </blockquote>  Let me remind you that we do not need to spoil the object, because we will add to it (parent) rights from different messages (child). <br><br>  Now we will rewrite our <strong>check</strong> function by entering it into the class, and see what happens: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> Rights{ <br> <font color="#0000ff">private</font> $usrID; <font color="#008000">//User rights ID</font> <br> <font color="#0000ff">private</font> $group=array(); <font color="#008000">//    </font> <br> <br> <font color="#0000ff">function</font> __construct($user_rightsID){ <br> $ <font color="#0000ff">this</font> -&gt;usrID=$user_rightsID; <br> } <br> <br> <font color="#0000ff">function</font> include_right($grp){ <br> $clone=clone $ <font color="#0000ff">this</font> ; <font color="#008000">//   ,  </font> <br> $clone-&gt;group[]=$grp; <font color="#008000">//  </font> <br> <font color="#0000ff">return</font> $clone; <br> } <br> <br> <font color="#0000ff">function</font> check($action){ <br> $result = mysql_query( <font color="#A31515">"SELECT * FROM `rights_action` WHERE `RightsID` IN ("</font> . implode( <font color="#A31515">","</font> ,$ <font color="#0000ff">this</font> -&gt;group) . <font color="#A31515">") AND `action`= '$action' AND `GroupID` IN (SELECT `GroupID` FROM `rights_group` WHERE `RightsID` = "</font> . $ <font color="#0000ff">this</font> -&gt;usrID . <font color="#A31515">")"</font> ); <br> <br> <font color="#0000ff">if</font> (!$result) <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> <br> $tmp=array(); <br> <font color="#0000ff">while</font> ($t = mysql_fetch_assoc($result)){ <br> <font color="#008000">//     (Users, User1, Moderator) </font> <br> <font color="#008000">// + (0)  - (1) ( ).</font> <br> <font color="#0000ff">if</font> (!isset($tmp[$t[ <font color="#A31515">'groupID'</font> ]])) <br> $tmp[$t[ <font color="#A31515">'groupID'</font> ]] = $t[ <font color="#A31515">'sign'</font> ]; <br> <font color="#0000ff">else</font> <br> $tmp[$t[ <font color="#A31515">'groupID'</font> ]] |= $t[ <font color="#A31515">'sign'</font> ]; <br> } <br> mysql_free_result($result); <br> <br> <font color="#0000ff">if</font> ($tmp) <br> <font color="#008000">//  +    ,  true.  false.</font> <br> <font color="#0000ff">return</font> (array_search(0, $tmp) !== FALSE); <br> <br> <font color="#008000">//     $tmp == false</font> <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote>  What we have done with you now (redone the function into a class, making it easier to use and more versatile) is called <a href="http://habrahabr.ru/blogs/refactoring/45589/">Refactoring</a> .  ( <a href="http://ru.wikipedia.org/wiki/%25D0%25A0%25D0%25B5%25D1%2584%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BE%25D1%2580%25D0%25B8%25D0%25BD%25D0%25B3">wiki</a> ) <br><br>  Now this class can be used like this: <blockquote> <code><font color="black"><font color="#008000">//  </font> <br> $UserRights = <font color="#0000ff">new</font> Rights($CurrentUser-&gt;rightsID); <br> <br> <font color="#008000">//  ,      .</font> <br> $PageRights = $UserRights-&gt;include_right($MainPage-&gt;rightsID); <br> <br> <font color="#008000">//,     ?</font> <br> <font color="#0000ff">if</font> ($PageRights-&gt;check( <font color="#A31515">'messages_view'</font> )){ <br> <font color="#008000">//, .     ?</font> <br> <br> <font color="#008000">//    </font> <br> <font color="#0000ff">foreach</font> ($MainPage-&gt;Messages <font color="#0000ff">as</font> $msg){ <br> <font color="#008000">//    (parent),    (child)</font> <br> $MsgRights = $PageRights-&gt;include_right($msg-&gt;rightsID); <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">if</font> ($MsgRights-&gt;check( <font color="#A31515">'messages_view'</font> )){ <br> <font color="#008000">//   ,      ?</font> <br> <font color="#0000ff">if</font> ($MsgRights-&gt;check( <font color="#A31515">'messages_edit'</font> )) <br> $msg-&gt;editable_flag = 1; <br> <font color="#008000">//  ?</font> <br> <font color="#0000ff">if</font> ($MsgRights-&gt;check( <font color="#A31515">'messages_delete'</font> )) <br> $msg-&gt;delete_flag = 1; <br> <br> DrawMessage($msg); <br> } <br> } <br> }</font></code> </blockquote>  where <strong>$ currentUser</strong> is the structure of the user who views the page. <br>  <strong>$ MainPage</strong> - the structure of the page that the user is watching. <br>  <strong>$ MainPage-&gt; Messages</strong> - an array of messages that are displayed on the page. <br>  Structures, previously, were read from the database. <br><br><h3>  Optimization </h3><br>  We are pleased with the quality and functionality of the library, but the question of performance arises. <br><br>  The first thing that catches your eye is that with each check with a new 'action', a non-frail SQL query occurs.  Let's try to fix it. <br><br>  First, let's see what does not change from request to request and optimize it. <br><blockquote>  <font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` WHERE` RightsID` <font color="#0000ff">IN</font> (.implode (",", $ this-&gt; <font color="#0000ff">group</font> ).) <font color="#0000ff">AND</font> `action` = <font color="#A31515">'$ action'</font> <font color="#0000ff">AND</font> `GroupID` <font color="#0000ff">IN</font> (SELECT` GroupID` <font color="#0000ff">FROM</font> `rights_group` <font color="#0000ff">WHERE</font> `RightsID` =. $ This-&gt; usrID.)</font> </blockquote><br>  First, every time a <font color="black"><font color="#0000ff">SELECT</font> `GroupID` FROM` rights_group` <font color="#0000ff">WHERE</font> `RightsID` = ...</font> query occurs.  Let's start with it. <br>  When declaring UserRights, we will run this query once, and the result will already be inserted into our SQL query. <br><blockquote> <code><font color="black"><font color="#0000ff">function</font> __construct($grp){ <br> $result=mysql_query( <font color="#A31515">"SELECT `group_rights`.groupID FROM `group_rights` WHERE `group_rights`.rightsID=$grp"</font> ); <br> <br> $ <font color="#0000ff">this</font> -&gt;usrID=array(); <br> <font color="#0000ff">while</font> ($t=mysql_fetch_assoc($result)){ <br> $ <font color="#0000ff">this</font> -&gt;usrID[]=$t[ <font color="#A31515">'groupID'</font> ]; <br> } <br> mysql_free_result($result); <br> <br> $ <font color="#0000ff">this</font> -&gt;usrID=implode( <font color="#A31515">","</font> ,$ <font color="#0000ff">this</font> -&gt;usrID); <br> } <br></font></code> </blockquote>  Now in $ this-&gt; usrID there is a ready-made string that can be directly inserted into the query instead of the whole SELECTa. <br><br>  It has already become easier, but all the same, a search is performed on the entire database every request.  How can we get rid of it?  Most likely, create a preliminary result that depends only on the action - because the selection of `RightsID` and` GroupID` remains unchanged. <br><br>  When a group of objects is added, we read all the results from the database into the array, which will depend only on the values ‚Äã‚Äãof the 'action'. <br><blockquote> <code><font color="black"><font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> `rights_action` <font color="#0000ff">WHERE</font> `RightsID` <font color="#0000ff">IN</font> (...) <font color="#0000ff">AND</font> `GroupID` <font color="#0000ff">IN</font> (...)</font></code> </blockquote> <br>  Further, already search for each 'action' in the array, we are looking for the necessary element.  At the same time, there are no more queries to the database - until the next object with new rights. <br><br>  As a result of optimization, our class will look like this: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">class</font> Rights{ <br> <font color="#0000ff">private</font> $group= <font color="#A31515">""</font> ; <br> <font color="#0000ff">private</font> $usrID=array(); <br> <font color="#0000ff">private</font> $temptable= <font color="#A31515">""</font> ; <br> <br> <font color="#0000ff">function</font> include_right($grp){ <br> $clone=clone $ <font color="#0000ff">this</font> ; <br> $clone-&gt;group[]=$grp; <br> <br> $result=mysql_query( <font color="#A31515">"SELECT * FROM `action_rights` WHERE `action_rights`.groupID IN ({$this-&gt;usrID}) AND `action_rights`.rightsID IN ("</font> .implode( <font color="#A31515">","</font> ,$clone-&gt;group). <font color="#A31515">")"</font> ); <br> $tmp=array(); <br> <font color="#0000ff">while</font> ($t=mysql_fetch_assoc($result)){ <br> $tmp[]=$t; <br> } <br> mysql_free_result($result); <br> <br> $clone-&gt;temptable=$tmp; <br> <br> <font color="#0000ff">return</font> $clone; <br> } <br> <br> <font color="#0000ff">function</font> check($action){ <br> $tmp=array(); <br> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;temptable <font color="#0000ff">as</font> $t){ <br> <font color="#0000ff">if</font> ($t[ <font color="#A31515">'action'</font> ]==$action){ <br> <font color="#0000ff">if</font> (!isset($tmp[$t[ <font color="#A31515">'groupID'</font> ]])) <br> $tmp[$t[ <font color="#A31515">'groupID'</font> ]]=$t[ <font color="#A31515">'sign'</font> ]; <br> <font color="#0000ff">else</font> <br> $tmp[$t[ <font color="#A31515">'groupID'</font> ]]|=$t[ <font color="#A31515">'sign'</font> ]; <br> } <br> } <br> <br> <font color="#0000ff">if</font> ($tmp){ <br> <font color="#0000ff">return</font> (array_search(0,$tmp)!==FALSE); <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> <br> <font color="#0000ff">function</font> __construct($grp){ <br> $result=mysql_query( <font color="#A31515">"SELECT `group_rights`.groupID FROM `group_rights` WHERE `group_rights`.rightsID=$grp"</font> ); <br> <br> $ <font color="#0000ff">this</font> -&gt;usrID=array(); <br> <font color="#0000ff">while</font> ($t=mysql_fetch_assoc($result)){ <br> $ <font color="#0000ff">this</font> -&gt;usrID[]=$t[ <font color="#A31515">'groupID'</font> ]; <br> } <br> mysql_free_result($result); <br> <br> $ <font color="#0000ff">this</font> -&gt;usrID=implode( <font color="#A31515">","</font> ,$ <font color="#0000ff">this</font> -&gt;usrID); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><h4>  Is it even faster? </h4><br>  Yes you can. <br>  1) If we take into account, for example, empty rights groups for messages (child) that do not change our already used temporary table.  In this case, we can use it without creating it again.  And for verification, we need to add just one more SELECT count (*) FROM `action_rights` WHERE` GroupID` = ..., which will go through the index and return the result. <br><br>  2) Correctly arrange the indexes in the `action_rights` and` group_rights` tables. <br>  <i>I'm not sure here.</i>  <i>I hope the experts will correct me.</i>  <i>Personally made PK - 'rightsID', 'action', 'groupID', INDEX - 'groupID', 'rightsID'</i> <br><br>  3) After creating the Temporary Table, add an index to it by 'action': <font color="black"><font color="#0000ff">ALTER</font> <font color="#0000ff">TABLE</font> `{$ this-&gt; temptable}` <font color="#0000ff">ADD</font> <font color="#0000ff">INDEX</font> (`action`)</font> . <br>  <i>True, I'm not sure that this method is also effective.</i>  <i>Experts, dedicate please.</i>  :) <br><br>  4) Use the cache.  But that's another story :) <br><br><h3>  Working example </h3><br>  I think that is enough code for today.  Here's how it works: <br>  <a href="http://zcn.ru/examples/rights/test.php">A working example</a> - I apologize for not visualizing. <br>  <a href="http://zcn.ru/examples/rights/">test.php (working example)</a> - my libraries that work with SQL database are used here, don't be surprised.  I'm sure you figure it out. <br>  <a href="http://zcn.ru/examples/rights/">rights.php</a> is our library. <br><br><h3>  Extensibility </h3><br>  Any new actions that you will use in your project are added to the 'action' ENUM. <br><br>  If you do not want to be tied to specific actions and add them in real time, then you should replace the 'action' ENUM with an integer and create another corresponding actionID table with action_name.  (as we did with the names of the Groups) <br><br>  <strong>Update:</strong> Continued: <a href="http://habrahabr.ru/blogs/webdev/51690/">Optimization of the system of separation of access rights in the web application</a> </div><p>Source: <a href="https://habr.com/ru/post/51327/">https://habr.com/ru/post/51327/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../51315/index.html">Overview of SSL certificates: types, choices, benefits.</a></li>
<li><a href="../51318/index.html">Translator</a></li>
<li><a href="../51319/index.html">Qt - translation difficulties</a></li>
<li><a href="../51321/index.html">SQLAlchemy rocks!</a></li>
<li><a href="../51322/index.html">Free replacement for powerful Alcohol, Nero and other virtual drive programs</a></li>
<li><a href="../51328/index.html">Introduction to jabber bots</a></li>
<li><a href="../51330/index.html">Stylization of form elements. We improve one of the solutions.</a></li>
<li><a href="../51331/index.html">Problem with loading avatars in profile settings</a></li>
<li><a href="../51332/index.html">Stencils for interface design</a></li>
<li><a href="../51333/index.html">Bulletproof HTML: 37 steps to perfect markup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>