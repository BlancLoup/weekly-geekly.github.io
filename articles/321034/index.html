<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Managing complexity in ruby ‚Äã‚Äãon rails projects. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part, I talked about controllers and routing. Now let's talk about the form. Quite often, it is required to implement forms that do no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Managing complexity in ruby ‚Äã‚Äãon rails projects. Part 3</h1><div class="post__text post__text-html js-mediator-article"><p>  In the <a href="https://habrahabr.ru/post/267233/">previous part,</a> I talked about controllers and routing.  Now let's talk about the form.  Quite often, it is required to implement forms that do not correspond to any model.  Or add a validation that only makes sense in a particular business process. </p><br><p>  I will tell about 2 types of forms: form-objects and types. </p><br><p>  Object forms are used to process and validate user input when data is needed for an operation.  For example, user login or data filtering. </p><br><p>  Types are used if you want to expand the behavior of the model.  For example, in your project, users can register both through vkontakte, and through the usual form.  Filling email is mandatory for regular users, but not for vk users.  This behavior is easily solved using types. </p><a name="habracut"></a><br><h2 id="form-objects">  Form-objects </h2><br><p>  In RoR projects, forms are rigidly tied to models.  Rendering a complex form without a model object is almost impossible and not convenient.  Therefore, form objects are extended using <a href="http://api.rubyonrails.org/classes/ActiveModel/Model.html">ActiveModel :: Model</a> .  Thus, forms are models without persistence support (they are not saved in the database).  Accordingly, we will get seamless integration with the form builder, validation, localization. </p><br><p>  For convenience, form objects also use <a href="https://github.com/solnic/virtus">gem virtus</a> .  It assumes type casting, sets default values.  For example, if a date comes from a form in a string representation, then virtus automatically converts it to a date. </p><br><pre><code class="hljs rust">#      # app/forms/base_form.rb class BaseForm include Virtus.model(strict: <span class="hljs-literal"><span class="hljs-literal">true</span></span>) include ActiveModel::Model end # app/forms/user/statistics_filter_form.rb class User::StatisticsFilterForm &lt; BaseForm attribute :start_date, ActiveSupport::TimeWithZone, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: -&gt;(*) { DateTime.current.beginning_of_month } attribute :end_date, ActiveSupport::TimeWithZone, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: -&gt;(model, _) { model.start_date.next_month } end # app/controllers/web/users/statistics_controller.rb class Web::Users::StatisticsController &lt; Web::Users::ApplicationController def show #     permits, ..     active_record  @filter_form = User::StatisticsFilterForm.new params[:user_statistics_filter_form] @statistics = UserStatisticsQuery.perform resource_user, @filter_form.start_date, @filter_form.end_date end end = simple_form_for @filter_form, method: :get, url: {} <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> |f| = f.input :start_date, <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>: :datetime_picker = f.input :end_date, <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>: :datetime_picker = f.button :submit</code> </pre> <br><p>  Consider the situation more difficult.  We have a login form with two fields: email and password.  Fields are required.  Also, if the user is not found or the password did not match, the corresponding error should be displayed. </p><br><pre> <code class="hljs pgsql"># app/forms/session_form.rb <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SessionForm &lt; BaseForm <span class="hljs-keyword"><span class="hljs-keyword">attribute</span></span> :email <span class="hljs-keyword"><span class="hljs-keyword">attribute</span></span> :<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> validates :email, email: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> validates :<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>, presence: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> #    ,         <span class="hljs-keyword"><span class="hljs-keyword">validate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> errors.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(:base, :wrong_email_or_password) unless <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.try(:authenticate, <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> ||= <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.find_by email: email <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # app/controllers/web/sessions_controller.rb <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Web::SessionsController &lt; Web::ApplicationController def <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> @session_form = SessionForm.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> @session_form = SessionForm.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> session_form_params #       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> @session_form.<span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>? sign_in @session_form.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> redirect_to root_path <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> render :<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> private def session_form_params params.require(:session_form).permit(:email, :<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  In this example, the form assumes all concerns about validating the input data, the controller does not contain unnecessary logic, and the model only verifies the password. </p><br><p>  With this approach, it is very easy to implement additional functionality: display the "remember me" checkbox, block users from the black list. </p><br><h2 id="types">  Types </h2><br><p>  If I'm not mistaken, Types came from symfony.  Type is the heir to the model, which impersonates itself as a parent and adds new functionality. </p><br><p>  Consider this task: users of the application can invite users only a rank lower than themselves.  Also, the inviter does not need to know the password of the invitee.  The list of user roles that can be assigned to a new user is determined by the policy.  In the part about ACL I will tell you more about this. </p><br><pre> <code class="hljs pgsql">module BaseType extend ActiveSupport::Concern class_methods <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> def model_name superclass.model_name <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> InviteType &lt; <span class="hljs-keyword"><span class="hljs-keyword">User</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> BaseType after_initialize :generate_password, <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>: :new_record? validates :<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>, inclusion: { <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: :available_roles } validates :inviter, presence: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> #  def <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> InvitePolicy.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(inviter, self) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def available_roles <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>.available_roles <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def available_role_options <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">role</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">options</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>{ |<span class="hljs-keyword"><span class="hljs-keyword">option</span></span>| <span class="hljs-keyword"><span class="hljs-keyword">option</span></span>.last.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>? available_roles } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> private def generate_password self.<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> = SecureRandom.urlsafe_base64(<span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  InviteType checks for the presence of the invitee, generates a password and restricts the list of available roles. </p><br><p>  I will focus more on BaseType.  It overrides the model_name method so that the type is perceived as a parent object.  You should not override the name method, since  ruby because of this blows the roof.  There is a subtlety when working with STI: you need to additionally override the method sti_name. </p><br><p>  Having object-forms and types it is convenient to transform the data coming from the form.  For example, there are 2 fields in a form: hours spent, minutes spent, and the model stores the elapsed time in seconds. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CommentType &lt; <span class="hljs-keyword"><span class="hljs-keyword">Comment</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> BaseType # <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> code def elapsed_time_hours TimeConverter.convert_to_time(elapsed_time.to_i)[:hours] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def elapsed_time_hours=(v) update_elapsed_time v.to_i, elapsed_time_minutes <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def elapsed_time_minutes TimeConverter.convert_to_time(elapsed_time.to_i)[:minutes] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> def elapsed_time_minutes=(v) update_elapsed_time elapsed_time_hours, v.to_i <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> private def update_elapsed_time(hours, minutes) self.elapsed_time = TimeConverter.convert_to_seconds(hours: hours, minutes: minutes) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  <strong>PS</strong>  The article was written over a year ago and just lay in the archive.  During this time, I shared a <a href="https://github.com/solidgem/corporate">project</a> on the basis of which this series of articles was written.  I would do some things differently; nevertheless, there are interesting and relevant decisions in it. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321034/">https://habr.com/ru/post/321034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321024/index.html">Class'y Class'y</a></li>
<li><a href="../321026/index.html">How we got smarter and learned how to open quests twice as fast</a></li>
<li><a href="../321028/index.html">A script that writes another script and configures routers</a></li>
<li><a href="../321030/index.html">Data engineer climb</a></li>
<li><a href="../321032/index.html">Using Sketchode 2 in Development: An Overview</a></li>
<li><a href="../321036/index.html">How it all began: developers remember the first games they created</a></li>
<li><a href="../321038/index.html">The history of the creation of the first game on Unity - from idea to release</a></li>
<li><a href="../321040/index.html">Russian 4Gap: distribution of 4G networks in Russia and in the world</a></li>
<li><a href="../321044/index.html">How I parsed docx using XSLT</a></li>
<li><a href="../321048/index.html">Analysis and translation of the alien language using the Wolfram Language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>