<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python inside. Process structures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Introduction 
 2. Objects. Head 
 3. Objects. Tail 
 4. Process structures 

 We continue to translate a series of articles on Python internals. If...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python inside. Process structures</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage3/8a6/3a1/033/8a63a1033dce96e114a06434e43d9b8e.png" align="right">  1. <a href="http://habrahabr.ru/post/189972/">Introduction</a> <br>  2. <a href="http://habrahabr.ru/post/189986/">Objects.</a>  <a href="http://habrahabr.ru/post/189986/">Head</a> <br>  3. <a href="http://habrahabr.ru/post/190336/">Objects.</a>  <a href="http://habrahabr.ru/post/190336/">Tail</a> <br>  4. <b>Process structures</b> <br><br>  <i>We continue to translate a series of articles on Python internals.</i>  <i>If you have ever wondered "how is it arranged?", Be sure to read.</i>  <i>The author sheds light on many interesting and important aspects of the device language.</i> <br><br>  In previous installments, we talked about the Python object system.  The topic is not exhausted yet, but let's go further. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When I think about the implementation of Python, I imagine a huge conveyor through which machine operation codes move, which then get into a giant factory, where cooling towers and tower cranes are rising everywhere - and I just get overwhelmed with the desire to get closer.  In this part we will talk about the structures of the <b>state of the interpreter</b> and the <b>state of the stream</b> ( <a href=""><code>./Python/pystate.c</code></a> ).  Now we need to lay the foundation so that it would be easier to understand how the bytecode is executed.  Very soon we will find out how the frames, namespaces and code objects are arranged.  But first, let's talk about the data structures that tie everything together.  Consider, I assume at least a superficial understanding of the structure of <a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D0%25B0">operating systems</a> and at least knowledge of such terms as <a href="http://ru.wikipedia.org/wiki/%25D0%25AF%25D0%25B4%25D1%2580%25D0%25BE_%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0%25D1%2586%25D0%25B8%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B9_%25D1%2581%25D0%25B8%25D1%2581%25D1%2582%25D0%25B5%25D0%25BC%25D1%258B">core</a> , <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D1%2586%25D0%25B5%25D1%2581%25D1%2581_(%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0)">process</a> , <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA_%25D0%25B2%25D1%258B%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">flow</a> , etc. <br><br>  In many operating systems, user code is executed in streams that live in processes (this is true for most * nix-systems and for "modern" versions of Windows).  The kernel is responsible for preparing and deleting processes and threads, as well as determining which thread on which logical CPU will be executed.  When a process calls the <code>Py_Initialize</code> function, another abstraction, the interpreter, takes the scene.  Any Python code run in the process is bound to an interpreter.  The interpreter can be thought of as the basis of all the other concepts that we will discuss.  Python supports the initialization of two (or more) interpreters in one process.  Despite the fact that this opportunity is rarely used in practice, I will take it into account.  As mentioned, the code is executed in a stream (or streams).  No exception and the virtual machine of Python (VM).  At the same time, the VM itself has support for threads, i.e.  Python has its own abstraction to represent threads.  The implementation of this abstraction relies entirely on the core mechanisms.  Thus, both the kernel and Python have an idea of ‚Äã‚Äãeach of the Python threads.  These threads are managed by the kernel and are executed as separate threads in parallel with all other threads in the system.  Well ... almost parallel. <br><br>  Until now, we did not pay attention to the elephant in our china shop. <a name="habracut"></a>  The name of the elephant is GIL ( <a href="http://docs.python.org/3/c-api/init.html">Global Interpreter Lock</a> ).  For some reason, many aspects of CPython are not safe.  This has both advantages (for example, simplified implementation and guaranteed atomicity of many Python operators), and disadvantages.  The main drawback is the need for a mechanism that prevents parallel execution of Python threads, since without such a mechanism, data corruption is possible.  GIL is a process level lock that a thread must seize if it needs to execute Python code.  This limits the number of simultaneously running Python threads on one logical CPU to one.  Python streams implement cooperative multitasking, voluntarily freeing GIL and allowing other threads to work.  This functionality is built into the execution loop, i.e.  There is no need to think specifically about this block when writing ordinary scripts and some extensions (it seems to them that they are working continuously).  Note that while the thread does not use the Python API (with many it happens), it can work in parallel with other Python threads.  A little later we will discuss GIL, and those who can not wait, can read the <a href="http://www.dabeaz.com/python/NewGIL.pdf">presentation of</a> David Beazley. <br><br>  We remember the concepts of the process (OS abstraction), interpreter (Python abstraction), and flow (both OS and Python abstraction).  Now we will do the following: we will start with a single operation and end with the whole process. <br><br>  Let's take another look at the bytecode generated by the expression <code>spam = eggs - 1</code> ( <a href="http://tech.blog.aknin.name/metablogging/tools/">what is</a> <code>diss</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span>diss(<span class="hljs-string"><span class="hljs-string">"spam = eggs - 1"</span></span>) <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> LOAD_NAME <span class="hljs-number"><span class="hljs-number">0</span></span> (eggs) <span class="hljs-number"><span class="hljs-number">3</span></span> LOAD_CONST <span class="hljs-number"><span class="hljs-number">0</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">6</span></span> BINARY_SUBTRACT <span class="hljs-number"><span class="hljs-number">7</span></span> STORE_NAME <span class="hljs-number"><span class="hljs-number">1</span></span> (spam) <span class="hljs-number"><span class="hljs-number">10</span></span> LOAD_CONST <span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) <span class="hljs-number"><span class="hljs-number">13</span></span> RETURN_VALUE &gt;&gt;&gt;</code> </pre><br>  In addition to the <code>BINARY_SUBTRACT</code> operation, which performs all the work, we see the <code>LOAD_NAME (eggs)</code> and <code>STORE_NAME (spam)</code> operations.  Obviously, to perform these operations, you need a place: you need to pull <code>eggs</code> from somewhere, and you need to remove the <code>spam</code> somewhere.  This place is referred to by the internal data structures in which the code is executed ‚Äî <b>frame objects</b> and <b>code objects</b> .  When you run the Python code, frames are actually executed (remember <a href=""><code>ceval.c</code></a> : <code>PyEval_EvalFrameEx</code> ).  Now we are confusing the concepts of frame objects and code objects, so far easier.  The difference between these structures will understand later.  Now we are most interested in the <code>f_back</code> field of the frame object.  In frame <code>n</code> this field points to frame <code>n-1</code> , i.e.  the frame that caused the current frame (the first frame in the stream indicates <code>NULL</code> ). <br><br>  The frame stack is unique for each thread and is associated with a thread-specific structure <a href=""><code>./Include.h/pystate.h</code></a> : <code>PyThreadState</code> , which contains a pointer to the current frame being executed (the most recently called frame, the top of the stack).  The <code>PyThreadState</code> structure <code>PyThreadState</code> allocated and initialized for each Python stream in the process by the <code>_PyThreadState_Prealloc</code> function right before the created thread is requested from the OS ( <a href=""><code>./Modules/_threadmodule.c</code></a> : <code>thread_PyThread_start_new_thread</code> and <code>&gt;&gt;&gt; from _thread import start_new_thread</code> ).  In the process, such threads can be created that are not controlled by the interpreter;  they do not have a <code>PyThreadState</code> structure, and they should not access the Python API.  This happens mostly in embedded applications.  But such threads can be ‚Äúpythonized‚Äù in order to be able to execute Python code in them, while creating a new <code>PyThreadState</code> structure.  In case one interpreter is running, you can use the API for such a stream migration.  If there are several interpreters, you will have to do it manually.  Finally, approximately in the same way as each frame is connected via a pointer to the previous one, the states of the threads are combined by a linked list of <code>PyThreadState *next</code> pointers. <br><br>  The list of thread structures is associated with the interpreter structure in which the threads are located.  The interpreter structure is defined in <a href=""><code>./Include.h/pystate.h</code></a> : <code>PyInterpreterState</code> .  It is created by calling the <code>Py_Initialize</code> function, which initializes the Python virtual machine in the process, or by calling the <code>Py_NewInterpreter</code> function, in which a new interpreter structure is created (if there is more than one interpreter in the process).  For better understanding, <a href="http://docs.python.org/3/c-api/init.html"><code>Py_NewInterpreter</code></a> remind you that <a href="http://docs.python.org/3/c-api/init.html"><code>Py_NewInterpreter</code></a> does not return the interpreter structure, but the <code>PyThreadState</code> structure of the newly created thread for the new interpreter.  Creating a new interpreter without a single thread in it does not make much sense, just as there is no point in processes without threads in them.  The interpreter structures in the process are related to each other in the same way as the thread structures in the interpreter. <br><br>  In general, our journey from a single operation to a whole process is completed: operations are in executing code objects (while ‚Äúnon-executing‚Äù objects lie somewhere nearby, like normal data), code objects are in executing frames that are in Python -flows, and flows in turn belong to the interpreter.  The static variable <a href=""><code>./Python/pystate.c</code></a> : <code>interp_head</code> refers to the root of this whole structure.  It indicates the structure of the first interpreter (through it all other interpreters, streams, etc. are available).  The <code>head_mutex</code> mutex protects against the damage of these structures by competing changes from different streams (I clarify that this is not a GIL, but an ordinary mutex for interpreter structures and streams).  This lock is controlled by the <code>HEAD_LOCK</code> and <code>HEAD_UNLOCK</code> .  As a rule, the <code>interp_head</code> variable <code>interp_head</code> accessed in case you need to add a new or delete an existing interpreter or stream.  If there is not one interpreter in the process, then by this variable the structure is not necessarily the interpreter in which the stream is currently executing. <br><br>  It is safer to use the variable <a href=""><code>./Python/pystate.c</code></a> : <code>_PyThreadState_Current</code> , which indicates the structure of the executable stream (with some conditions taken into account).  That is, to get to its interpreter, the code needs the structure of its stream, from which it is already possible to pull the interpreter.  To access this variable (take the current value or change it, keeping the old one) there are functions that require GIL to work.  This is important, and this is one of the problems that arise from the lack of thread safety in CPython.  The value of the <code>_PyThreadState_Current</code> variable <code>_PyThreadState_Current</code> set in the structure of a new thread during Python initialization or during the creation of a new thread.  When the Python thread first starts after the initial load, it relies on the fact that: a) it holds the GIL and b) the value of the <code>_PyThreadState_Current</code> variable <code>_PyThreadState_Current</code> correct.  At this point, the stream should not give up GIL.  First, it must save <code>_PyThreadState_Current</code> , so that the next time you capture the GIL, you can restore the desired value of the variable and continue working.  Due to this behavior, <code>_PyThreadState_Current</code> always points to the currently executing thread.  To implement this behavior, there are macros <a href="http://docs.python.org/3/c-api/init.html"><code>Py_BEGIN_ALLOW_THREADS</code></a> and <a href="http://docs.python.org/3/c-api/init.html"><code>Py_END_ALLOW_THREADS</code></a> .  You can talk for hours about GIL and the <a href="http://docs.python.org/3/c-api/init.html">API for working with it</a> , and it would be interesting to compare CPython with other implementations (for example, Jython or IronPython, in which threads run simultaneously).  But let's postpone this topic for now. <br><br>  In the diagram, I have indicated the connections between the structures of one process, in which two interpreters are running with two threads each, which refer to their frame stacks. <br><img src="https://habrastorage.org/getpro/habr/post_images/400/bea/128/400bea1283a507f8e7935c9ad78e1aaa.png" alt="image"><br><br>  Beautiful, yes?  So.  Everything was discussed, but it is still not clear what the meaning of these structures is.  What are they needed for?  What is interesting about them?  I don‚Äôt want to complicate things, so I‚Äôll only briefly tell you about some of the functions.  In the structure of the interpreter, for example, there are fields designed to work with imported modules;  pointers necessary for working with unicode;  the dynamic compiler flags field and the <a href="http://en.wikipedia.org/wiki/Time_Stamp_Counter">TSC</a> field for profiling (see the penultimate item <a href="http://docs.python.org/2/whatsnew/2.4.html">here</a> ). <br><br>  Some fields of the stream structure are associated with the details of the execution of this stream.  For example, the <code>recursion_depth</code> , <code>overflow</code> and <code>recursion_critical</code> are needed to catch too deep a recursion and throw a <code>RuntimeError</code> exception before the stack of the underlying platform overflows and the entire process crashes.  There are also fields related to profiling, tracing and exception handling and a dictionary for storing any trash. <br><br>  I think this is the end of the story about the structure of the Python process.  I hope everything is clear.  In the next posts, we will move on to real hardcore and talk about <b>frame objects</b> , <b>namespaces</b> and <b>code objects</b> .  Get ready. </div><p>Source: <a href="https://habr.com/ru/post/191032/">https://habr.com/ru/post/191032/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191014/index.html">External components in 1C 8.2</a></li>
<li><a href="../191018/index.html">Five pitfalls when using shared_ptr</a></li>
<li><a href="../191022/index.html">The concept of the Ministry of Communications and Mass Media: I want a substantive conversation</a></li>
<li><a href="../191024/index.html">Inforza - a new channel to attract customers for studios and agencies</a></li>
<li><a href="../191030/index.html">Analysis of all tasks and results of Yandex. Algorithm</a></li>
<li><a href="../191044/index.html">Rootkit Avatar and HiddenFsReader</a></li>
<li><a href="../191048/index.html">IBM Unveils New Wind and Solar Prediction System</a></li>
<li><a href="../191052/index.html">Nginx has a paid version - Nginx Plus</a></li>
<li><a href="../191054/index.html">STM32 vs Arduino</a></li>
<li><a href="../191060/index.html">Minimalistic RSS reader for the Yandex.Following service</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>