<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DoS vulnerability in Open vSwitch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spoiler: Open vSwitch versions less than 1.11 are vulnerable to a flow flow attack, which allows an attacker to interrupt the network by sending a rel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DoS vulnerability in Open vSwitch</h1><div class="post__text post__text-html js-mediator-article"> Spoiler: Open vSwitch versions less than 1.11 are vulnerable to a flow flow attack, which allows an attacker to interrupt the network by sending a relatively small packet flow to any virtual machine.  Versions 1.11 and older are not affected.  Most servers with OVS still use OVS 1.4 or 1.9 (LTS versions).  Administrators of such systems are urged to upgrade the system to a newer version of OVS. <br><br>  Lyrics: More than a year and a half has passed since the moment when I first managed to reproduce this problem.  In the OVS mailing list to the complaint, they said that ‚Äúthey will fix it in the next versions‚Äù - and have corrected it, half a year later.  However, this fix did not affect the LTS version, which means that most systems using OVS are still vulnerable.  I tried to contact Citrix several times (because it uses the most vulnerable version of OVS as part of Xen Server - at that moment it was my main product for operation), but there was no clear reaction.  Now administrators have the opportunity to eliminate the problem with a little blood, so I decided to publish a description of a very simple to reproduce and extremely confusing and diagnosing problem - the problem of ‚Äúflow congestion‚Äù, it‚Äôs also ‚Äúflow flow attack‚Äù, it‚Äôs also ‚Äúa strange unknown garbage ‚Äúfor which everything works strangely.‚Äù  I have written several times before in the comments and mailings about this problem, but I never had enough powder to fully describe the problem in Russian so that the essence of the problem was understandable to an ordinary IT person.  Correct. <br><br>  The next line <code>hping3 -i u10 virtual.machine.ip</code> violates the performance of the virtualization host running the virtual machine.  And not only the virtualization host - any system running on Open vSwitch versions less than 1.11.  I place particular emphasis on versions 1.4.3 and 1.9, because they are LTS versions and are used most often. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A more severe version of the same call, this time in violation of the rules for using the network: <code>hping3 --flood --rand-source virtual.machine.ip</code> .  The ratio of outgoing traffic (~ 10-60 Mbit / s) and the (potential) interface bandwidth of the victim (2x10G, the ratio of the attacking / attacking band in the available band is of the order of 1: 300-1: 1000) allows us to speak about the vulnerability, and not about the traditional DoS attack flood, clogging uplink channels to non-working state. <br><br>  Symptoms from the virtualization host side: unexpected delays when opening connections, increase in CPU consumption by the ovs-vswitchd process up to 100%, packet loss for new or low-activity sessions.  If OVS 1.4 is used, the ovs-vswitchd process not only eats its 100% CPU, but also starts eating up memory and does it at a speed of up to 20 megabytes per minute, until a good OOM grandfather comes to him and does not conduct an educational conversation. <br><a name="habracut"></a><br>  In contrast to the usual problems with the network, launched pings are likely to ‚Äúbreak through‚Äù, and as soon as the flow with them gets into the kernel, ping will work without the slightest criticism, but the new connections will not be established.  This makes it very difficult to diagnose the problem, because the psychological ‚Äúping is - the network is working‚Äù is very difficult to get rid of.  If we add to this that the ‚Äúbroken through‚Äù ssh session per host will continue to work just as well, then it will be extremely and extremely difficult to convince the administrator that the problem with the network on the part of the host is.  If the flood on the interface exceeds a certain threshold (~ 50-80 Mb / s), then any adequate network activity is terminated.  But the insidiousness of the described problem is that a significant degradation of the service occurs at much lower loads, under which the canonical network diagnostic tools report ‚Äúeverything is in order‚Äù. <br><br>  Taking this opportunity, I want to apologize to <a href="https://habrahabr.ru/users/si14/" class="user_link">si14</a> , who spoke about the strangeness with the network of laboratory virtual women, but could not prove their presence to me, but I ‚Äúsaw‚Äù that I was fine and it took more than a year until I finally not only I suspected something was wrong, but I was able to find an unambiguous crash test. <br><br>  In the case of XenServer, the situation with OVS is complicated by the fact that local management traffic also goes through the Open vSwitch bridge, and all bridges are served by one ovs-vswitchd process, that is, a happy administrator will not even be able to look at these symptoms - they simply will not allow ssh .  And if they let them in, then see above, about ‚Äúno problems‚Äù.  Since NAS / SAN traffic also goes through the bridge, even after the causes disappear, the virtual machines are likely to remain inoperable.  In this case, the symptoms of the problem are ‚Äúan unexpected hangup that began with lags and packet loss.‚Äù <br><br>  Description of the vulnerability from the point of view of a ‚Äúproduction manager‚Äù - any schoolchild with a 10-50 megabit channel on ADSL can put an entire farm of virtualization servers with ten-gigabit ports if at least one virtual user is ‚Äúwatching‚Äù the interface on the Internet.  And the rules / ACL inside virtuals will hardly help.  Any user of any virtual machine, even without access to the Internet, can arrange the same. <br><br><h1>  Technical description of the problem </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/36e/0d4/a75/36e0d4a750bc21203d31d71df85f0891.jpg"><br>  <em>(illustration from post <a href="http://wangcong.org/blog/archives/2131">An overview of Openvswitch implementation</a> )</em> <br>  Reason: Older versions of Open vSwitch cannot merge similar flow and when detecting an ethernet frame that looks like a new flow, they always send a frame for inspection via the netlink socket to the ovs-vswitchd process. Since the inspection process is extremely slow (due to the overwhelming speed of hash tables in the core), and ovs-vswitchd itself is single-threaded and the only one in the system, then network performance under the conditions of the emergence of many new flows is limited by the speed of the userspace application (and its circulation to the core / back via netlink).  After a short time, the existing kernel flows are replaced by new entries and displace existing ones (unless they are very active), and the chances of restoring a new flow are inversely proportional to the number of competitors ‚Äî that is, to flood.  Moreover, the number of packets in a bona fide session does not play any role - the whole session turns out to be a single flow.  For a long time this was the ‚Äúblind spot‚Äù - any burst test with a single TCP session happily reported gigabits of traffic with almost zero processor utilization. <br><br><h1>  Kernel flow versus openflow flow </h1><br>  The key is to understand the difference between kernel flow and openflow flow.  Openflow flow implies that flow is accompanied by a bitmask, more precisely, the openflow format implies an indication of the fields of interest.  At the same time for the rest of the fields implicitly implied "not important", that is, "*". <br><br>  The kernel module in older versions of Open vSwitch uses a fairly sophisticated rule-handling mechanism, which has only one drawback: it does not support masks and asterisks. <br><br>  The mechanism is as follows: the incoming ethernet frame selects all its headers, starting with L2 and ending with L4 (that is, for example, TCP port number), minus completely useless, like "window size" for TCP, or "segment number ".  All of them are packed into a binary structure, after which a hash is considered from this structure.  Then this hash is searched for in the rules hash table, and if there is a match for the rule, it is used.  If none matches, the package is sent for inspection to a more intelligent userpace program (ovs-vswitchd), which sends back a new rule for what to do with such packages.  The rules for openflow, as well as manually imposed rules via ovs-ofctl, are processed by ovs-vswitchd, and the kernel module does not know anything about them.  This is especially true of the ‚Äúnormal‚Äù rule, which means ‚Äúact like a switch‚Äù.  But even a normal drop still requires user-space inspection, because drop most often does not include all possible combinations of the incoming / outgoing port, and, therefore, from the point of view of OVS, it contains "asterisks". <br><br>  The hash table gives fantastic performance that does not depend on the number of rules (that is, 10,000 rules will be processed at about the same speed as one). <br><br>  Unfortunately, if the headers of each new package are different, then each new such package will go to the inspection in userspace.  Which is slow and sad. <br><br>  The original idea of ‚Äã‚ÄãOVS was that within the TCP session all packets would be the same and there would be one rule for the entire session.  Unfortunately, the evil ‚Äúhakkir Vasya‚Äù, by copying the line above, will be able to break this wait. <br><br>  In new versions, this problem was solved with the help of megaflow. <br><br><h1>  Megaflow </h1><br>  They appeared in the Open vSwitch since version 1.11.  Megaflow does not apply to openflow, but concerns the interaction of ovs-vswitchd and the nuclear module.  Unfortunately, the price for megaflow is quite tangible - in some cases, productivity drops by 5-20%.  Fortunately, in return, ovs-vswitchd will under almost no circumstances eat away a disproportionately large amount of resources. <br><br>  What is megaflow?  In very detail on C, it is presented <a href="http://openvswitch.org/pipermail/dev/2013-August/031162.html">here</a> .  From what I understand, the concept of ‚Äúmask‚Äù appears, the masks themselves are unique to the whole kernel datapath, and when searching you have to take them all into account, that is, the complexity of the search becomes not o (1), but o (masks).  From here it turns out some performance drop.  But against the background of unspeakable brakes and denial of service in case of a flow flood, this is good news.  And, perhaps, the only way out. <br><br>  In addition, in many installations the masks will be very small, and the drop in performance will be imperceptible.  For example, the unmanaged ‚Äúsimple switch‚Äù mode, that is, the normal, most likely, will contain a single mask. <br><br><h1>  Attack in the wild </h1><br>  With the fact that at the beginning of the article it was about ‚Äúattack on denial of service with hping / nping‚Äù, the real problem is much wider.  If for some reason there are many calls to the virtual machine from many different addresses, or simply many sessions are established, then there is no difference in terms of OVS behavior with ‚Äúattack‚Äù and ‚Äúhigh load‚Äù.  I watched this in reality when a virtual machine was used to distribute statics for some terribly popular browser game containing a bunch of small pictures.  There were a lot of players, there were many pictures, they were small.  Total - several thousand new TCP sessions per second, 300-500 bytes in size.  At the same time, a very moderate flow of 15‚Äì20 megabits was obtained.  And the worst case for old versions of OVS, since each session is a walk-in user space. <br><br>  An additional problem is the fact that netlink has a buffer, and network interfaces have a buffer, and OVS has a buffer.  Incoming packets are not just dropping, they queue up, loading the processor at 100% (yes, 100 of the 800 available).  This leads to an increase in latency in the processing of new flow.  Moreover, this latency is extremely difficult to diagnose: the lag is only on the first packet, all subsequent ones (within the created flow) are processed quickly. <br><br>  The rise of latency leads to the second part of the problem: if a packet from an existing TCP session is in the queue long enough, then the record of such a session is wiped from the kernel flow table.  And the package again goes to the inspection, to create a new kernel flow, and this even more finishes OVS to the state ‚Äúit does not breathe and does not move‚Äù. <br><br>  Note that the problem is symmetrical with respect to input / output.  It can be not only ‚Äúhakkir Vasya‚Äù outside, but also ‚Äúhakkir Vasya‚Äù inside.  A virtual machine sending out thousands of new sessions outside causes the same problems - and these problems affect everyone who is close to the hakkir.  If packets are sent to neighbors over the network, then a single virtual machine can become paralyzed or severely degrade the quality of service for a whole host of virtualization servers. <br><br>  It is clear that for a public provider such death is like.  In a previous job, I had to write a rather <a href="http://openvswitch.org/pipermail/dev/2013-April/026424.html">ugly patch</a> that cut most of the OVS functionality (since megaflow was not there yet), leaving only the minimum possible set of parameters in binary fingerprints of the frame (from which they make the hash).  Upstream is not taken, but I solved the problem.  And before the release of OVS 1.11, about half a year remained with the megaflow ... <br><br><h1>  Extent of the problem </h1><br><table><tbody><tr><td>  <b>distribution kit</b> </td><td>  <b>OVS version</b> </td><td>  <b>vulnerability</b> </td></tr><tr><td>  Debian sqeeze </td><td>  x </td><td>  no package </td></tr><tr><td>  Debian wheezy </td><td>  1.4.2 </td><td>  vulnerable version + memory leak </td></tr><tr><td>  Debian sid </td><td>  1.9.3 </td><td>  vulnerable version (here's the bleeding edge) </td></tr><tr><td>  Ubuntu 12.04 </td><td>  1.4 </td><td>  vulnerable version + memory leak </td></tr><tr><td>  Ubuntu 14.04 </td><td>  2.0 </td><td>  cheers cheers. </td></tr><tr><td>  XenServer 5.5 </td><td>  1.4.2 </td><td>  vulnerable version + memory leak </td></tr><tr><td>  XenServer 6.2 </td><td>  1.4.3 </td><td>  vulnerable version.  Until now, not even 1.9! </td></tr><tr><td>  RHEL / CentOS 5 </td><td>  x </td><td>  Package not available </td></tr><tr><td>  RedHat / CentOS 6.5 </td><td>  x </td><td>  Only kernel module, no userspace </td></tr><tr><td>  Fedora 21 </td><td>  2.1 </td><td>  the freshest! </td></tr></tbody></table><br>  (information about the version of OVS in your favorite distribution is welcome and will be added, it is desirable to indicate the version with a link to the distribution site) <br>  Since OVS is a recommended and standard bridge for openstack, with both opensource versions and many proprietary (they still use OVS for traffic to the virtual machine), we can say that most of the default OpenStack installations are subject to a problem.  A similar problem awaits the regular installation of libvirt based on OVS - as in distributions, mainly problem versions. <br><br><h1>  Conclusion </h1><br>  Update, update, update.  To the great happiness of CentOS 5 users and other connoisseurs of mammoth achievements, the OVS 1.11 nuclear module supports 2.6.18 (but not more than 3.8), so it will work on most systems.  For newer kernels, it is worth using newer versions of OVS - 2.0, or even 2.1 (just released in early May 2014).  The key potential problem is that if you don‚Äôt update the kernel module when updating OVS, it will not work (although the command line utilities will try to portray the functionality). <br><br>  The second problem: all versions in which the vulnerability is fixed are not LTS.  This means that they should be updated almost immediately, as the newer one comes out, since there is almost no support for non-LTS (and bugfixes only go to the next version). <br><br>  <b>Related Links</b> : <br><ul><li>  Wikipedia articles: <a href="http://ru.wikipedia.org/wiki/Open_vSwitch">ru: Open vSwitch</a> , <a href="http://en.wikipedia.org/wiki/Open_vSwitch">en: Open vSwitch</a> , <a href="http://ru.wikipedia.org/wiki/Openflow">ru: OpenFlow</a> , <a href="http://en.wikipedia.org/wiki/Openflow">en: OpenFlow</a> </li><li>  <a href="http://openvswitch.org/download/">Download Open vSwitch</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3DFyV4MoQ3T0I">Video on the architecture of Open vSwitch</a> </li><li>  <a href="http://git.openvswitch.org/cgi-bin/gitweb.cgi%3Fp%3Dopenvswitch%3Ba%3Dblob_plain%3Bf%3Dtutorial/Tutorial%3Bhb%3DHEAD">Manual on managing flow processing in OVS</a> </li></ul><br><br>  PS If someone decides to check ‚Äúhow it works‚Äù from the virtual machine - note that after launching it is likely that you will not press Ctrl-C.  More precisely, click, but the server will not hear you and will continue to send flooding to the interface, and even rebooting such a virtual machine will be difficult - if the control goes through the same bridge, then the command to shut down or reboot just does not reach the utilities on the host. </div><p>Source: <a href="https://habr.com/ru/post/124310/">https://habr.com/ru/post/124310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124297/index.html">Solving the time zone problem in a web application</a></li>
<li><a href="../124300/index.html">Mozilla is developing an alternative to OpenID</a></li>
<li><a href="../124302/index.html">Configure Kannel SMS Gateway</a></li>
<li><a href="../124305/index.html">Create an email newsletter that sells</a></li>
<li><a href="../124306/index.html">BitTorrent Inc will release a paid version of uTorrent</a></li>
<li><a href="../124311/index.html">The play "Developing a multiplayer online game." Part 3: Client-server interaction</a></li>
<li><a href="../124312/index.html">Amateur radio community</a></li>
<li><a href="../124313/index.html">Each hosting by audio player</a></li>
<li><a href="../124314/index.html">Do search engines make us lazier?</a></li>
<li><a href="../124315/index.html">Google Docs Viewer now supports ZIP and RAR formats.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>