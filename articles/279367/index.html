<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Investigating the speed of a method call</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Result and conclusions for those who do not like long text 

 100,000 calls, 20 test iterations, x86  100,000 calls, 20 test iterations, x64  1,000,00...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Investigating the speed of a method call</h1><div class="post__text post__text-html js-mediator-article"><h4>  Result and conclusions for those who do not like long text </h4><br><a name="top"></a><br><table><tbody><tr><th></th><th>  100,000 calls, 20 test iterations, x86 </th><th>  100,000 calls, 20 test iterations, x64 </th><th>  1,000,000 calls, 10 test iterations, x86 </th><th>  1,000,000 calls, 10 test iterations, x64 </th></tr><tr><th>  <a href="https://habr.com/ru/post/279367/">Direct call</a> </th><td><pre> Min: 1 ms
 Max: 1 ms
 Mean: 1 ms
 Median: 1 ms
 Abs: 1
</pre><br></td><td><pre> Min: 1 ms
 Max: 1 ms
 Mean: 1 ms
 Median: 1 ms
 Abs: 1
</pre><br></td><td><pre> Min: 7 ms
 Max: 8 ms
 Mean: 7.5 ms
 Median: 7.5 ms
 Abs: 1
</pre><br></td><td><pre> Min: 5 ms
 Max: 6 ms
 Mean: 5.2 ms
 Median: 5 ms
 Abs: 1
</pre><br></td></tr><tr><th>  <a href="https://habr.com/ru/post/279367/">Call through reflection</a> </th><td><pre> Min: 32 ms
 Max: 36 ms
 Mean: 32.75 ms
 Median: 32.5 ms
 Rel: 32
</pre><br></td><td><pre> Min: 35 ms
 Max: 44 ms
 Mean: 36.5 ms
 Median: 36 ms
 Rel: 36
</pre><br></td><td><pre> Min: 333 ms
 Max: 399 ms
 Mean: 345.5 ms
 Median: 338 ms
 Rel: 45
</pre><br></td><td><pre> Min: 362 ms
 Max: 385 ms
 Mean: 373.6 ms
 Median: 376 ms
 Rel: 75
</pre><br></td></tr><tr><th>  <a href="https://habr.com/ru/post/279367/">Call via delegate</a> </th><td><pre> Min: 64 ms
 Max: 71 ms
 Mean: 65.05 ms
 Median: 64,5 ms
 Rel: 64
</pre><br></td><td><pre> Min: 72 ms
 Max: 86 ms
 Mean: 75.95 ms
 Median: 75 ms
 Rel: 75
</pre><br></td><td><pre> Min: 659 ms
 Max: 730 ms
 Mean: 688.8 ms
 Median: 689,5 ms
 Rel: 92
</pre><br></td><td><pre> Min: 746 ms
 Max: 869 ms
 Mean: 773.4 ms
 Median: 765 ms
 Rel: 153
</pre><br></td></tr><tr><th>  <a href="https://habr.com/ru/post/279367/">Call via delegate with optimizations</a> </th><td><pre> Min: 16 ms
 Max: 18 ms
 Mean: 16.2 ms
 Median: 16 ms
 Rel: 16
</pre><br></td><td><pre> Min: 21 ms
 Max: 25 ms
 Mean: 22.15 ms
 Median: 22 ms
 Rel: 22
</pre><br></td><td><pre> Min: 168 ms
 Max: 187 ms
 Mean: 172.8 ms
 Median: 170,5 ms
 Rel: 22.7
</pre><br></td><td><pre> Min: 218 ms
 Max: 245 ms
 Mean: 228.8 ms
 Median: 227 ms
 Rel: 45.4
</pre><br></td></tr><tr><th>  <a href="https://habr.com/ru/post/279367/">Call via dynamic</a> </th><td><pre> Min: 11 ms
 Max: 14 ms
 Mean: 11.5 ms
 Median: 11 ms
 Rel: 11
</pre><br></td><td><pre> Min: 12 ms
 Max: 14 ms
 Mean: 12.5 ms
 Median: 12 ms
 Rel: 12
</pre><br></td><td><pre> Min: 124 ms
 Max: 147 ms
 Mean: 132.1 ms
 Median: 130 ms
 Rel: 17
</pre><br></td><td><pre> Min: 127 ms
 Max: 144 ms
 Mean: 131.5 ms
 Median: 129,5 ms
 Rel: 26
</pre><br></td></tr><tr><th>  <a href="https://habr.com/ru/post/279367/">Call via Expression</a> </th><td><pre> Min: 4 ms
 Max: 4 ms
 Mean: 4 ms
 Median: 4 ms
 Rel: 4
</pre><br></td><td><pre> Min: 4 ms
 Max: 5 ms
 Mean: 4.15 ms
 Median: 4 ms
 Rel: 4
</pre><br></td><td><pre> Min: 46 ms
 Max: 55 ms
 Mean: 50 ms
 Median: 50,5 ms
 Rel: 6.7
</pre><br></td><td><pre> Min: 47 ms
 Max: 51 ms
 Mean: 47.7 ms
 Median: 47 ms
 Rel: 9.4
</pre><br></td></tr></tbody></table><br><br>  <s>When using the .NET Framework 3.5, it is best to use a method call through a delegate with call optimization.</s>  <s>For .NET Framework 4.0+, using dynamic is a great choice.</s> <br>  UPD: new output from <a href="https://habrahabr.ru/users/mayorovp/" class="user_link">mayorovp</a> : best used <a href="https://habr.com/ru/post/279367/">Expression</a> <br><br>  UPD: and as suggested by <a href="https://habrahabr.ru/users/cdemon/" class="user_link">CdEmON</a> , such a study was <a href="https://habrahabr.ru/post/103558/">published in Habr√© earlier</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">A little offtopic, about the reasons for the study</b> <div class="spoiler_text">  We write the following code: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SampleGeneric</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Process</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Format(<span class="hljs-string"><span class="hljs-string">"{0} [{1}]"</span></span>, obj.ToString(), obj.GetType().FullName).Length; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Container</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Dictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; _instances = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Register&lt;T&gt;(SampleGeneric&lt;T&gt; instance) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">false</span></span> == _instances.ContainsKey(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T))) { _instances.Add(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T), instance); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { _instances[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)] = instance; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> SampleGeneric&lt;T&gt; Get&lt;T&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">false</span></span> == _instances.ContainsKey(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T))) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyNotFoundException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (SampleGeneric&lt;T&gt;)_instances[<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">false</span></span> == _instances.ContainsKey(type)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyNotFoundException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _instances[type]; } }</code> </pre> <br><br>  Such code is used quite often, and there is one inconvenience in it - in C # you cannot store a collection of generic types explicitly.  All the tips that I found come down to highlighting the basic non-generic class, interface, or abstract class that will be specified for storage.  Those.  we get something like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISampleGeneric</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SampleGeneric</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ISampleGeneric</span></span> <span class="hljs-comment"><span class="hljs-comment">// private static Dictionary&lt;Type, ISampleGeneric&gt; _instances = new Dictionary&lt;Type, ISampleGeneric&gt;();</span></span></code> </pre><br><br>  In my opinion, it would be convenient to add to the language the ability to write as follows: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  Type expected Dictionary&lt;Type, SampleGeneric&lt;&gt;&gt;</span></span></code> </pre><br>  Especially considering that when doing a generic type through reflection, we use a similar construction: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SampleGeneric&lt;&gt;).MakeGenericType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>))</code> </pre><br>  But back to the problem.  Now imagine that we need to get a specific instance, but we need to get it in a non-generic method.  For example, a method that accepts an object and, based on its type, must select a handler. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NonGenericMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handler = Container.Get(obj.GetType()); }</code> </pre><br><br>  We‚Äôll get the handler, but the environment will not allow writing now handler.Process (obj), and if we write, the compiler will swear at the absence of such a method. <br>  Here, too, could be from C # developers like: <br><pre> <code class="cs hljs">Container.GetInstance&lt;fromtype(obj.GetType())&gt;().Process(obj);</code> </pre><br>  , but it doesn‚Äôt exist, but the method to call is required (although given Roslyn, can there already be something similar in the new IDE?).  Ways to do this mass, from which there are several major.  they are listed in the table at the beginning of the article. <br></div></div><br><br><h4>  About code </h4><br>  Below is a call to the code given in the spoiler.  Time measurements were removed from the code, measurements were made via Stopwatch.  For analysis, I was interested in the relative execution time, not absolute, so the iron and other parameters are not important.  Tested on different PCs, the results are similar. <br>  It is also worth noting that when you call, the time for preprocessing is not taken into account, in which we get to the desired method, since  in real conditions, in highly loaded tasks, such actions are performed only once, and the result is cached, respectively, this time does not matter in the analysis. <br><br><h5>  Direct call </h5><br><a name="direct"></a><br>  Just pull the method directly.  In the table, the results of a direct call in the first row, the Abs value is always one, respectively; in the remaining rows, you can see the slowdown of calls by other methods of calling the method (in the Rel value). <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDirectCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = Container.Get&lt;DateTime&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> summ = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ITERATION_COUNT; i++) { summ += instance.Process(arg); } <span class="hljs-comment"><span class="hljs-comment">// return }</span></span></code> </pre><br><br><h5>  Call via Reflection </h5><br><a name="reflection"></a><br>  The easiest and most affordable way that you want to use first.  Took a method from the table of methods and we pull it through Invoke.  At the same time, one of the slowest ways. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestReflectionCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = Container.Get(arg.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> method = instance.GetType().GetMethod(<span class="hljs-string"><span class="hljs-string">"Process"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> summ = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ITERATION_COUNT; i++) { summ += (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)method.Invoke(instance, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { arg }); } <span class="hljs-comment"><span class="hljs-comment">// return }</span></span></code> </pre><br><br><h5>  Call via delegate and via delegate with additional optimization </h5><br><a name="delegat"></a><br>  Code to create a delegate <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Delegate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDelegate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, MethodInfo method</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodParameters = method.GetParameters(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arguments = methodParameters.Select(d =&gt; Expression.Parameter(d.ParameterType, d.Name)).ToArray(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = target == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : Expression.Constant(target); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodCall = Expression.Call(instance, method, arguments); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Lambda(methodCall, arguments).Compile(); }</code> </pre><br><br>  Accordingly, the test code becomes the following: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDelegateCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = Container.Get(arg.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hook = CreateDelegate(instance, instance.GetType().GetMethod(<span class="hljs-string"><span class="hljs-string">"Process"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> summ = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ITERATION_COUNT; i++) { summ += (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)hook.DynamicInvoke(arg); } <span class="hljs-comment"><span class="hljs-comment">// return }</span></span></code> </pre><br>  Got a slowdown compared with the Reflection method in another two times, you could throw out this method, but there is a great way to speed up the process.  Honestly, I spied it in the project <a href="https://github.com/ekonbenefits/impromptu-interface">Impromptu</a> , namely in this <a href="https://github.com/ekonbenefits/impromptu-interface/tree/master/ImpromptuInterface/src/Optimization">place</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Delegate Call Optimization Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FastDynamicInvokeDelegate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Delegate del, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">dynamic</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> tDel = del; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (args.Length) { <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> del.DynamicInvoke(args); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TargetInvocationException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ex.InnerException; } <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Optimization case 1: return tDel(args[0]); case 2: return tDel(args[0], args[1]); case 3: return tDel(args[0], args[1], args[2]); case 4: return tDel(args[0], args[1], args[2], args[3]); case 5: return tDel(args[0], args[1], args[2], args[3], args[4]); case 6: return tDel(args[0], args[1], args[2], args[3], args[4], args[5]); case 7: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6]); case 8: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7]); case 9: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8]); case 10: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9]); case 11: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9], args[10]); case 12: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9], args[10], args[11]); case 13: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9], args[10], args[11], args[12]); case 14: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9], args[10], args[11], args[12], args[13]); case 15: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9], args[10], args[11], args[12], args[13], args[14]); case 16: return tDel(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9], args[10], args[11], args[12], args[13], args[14], args[15]); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> } }</span></span></code> </pre><br></div></div><br><br>  Slightly changing the test code <br><a name="optdelegat"></a><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDelegateOptimizeCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = Container.Get(arg.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hook = CreateDelegate(instance, instance.GetType().GetMethod(<span class="hljs-string"><span class="hljs-string">"Process"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> summ = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ITERATION_COUNT; i++) { summ += (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)FastDynamicInvokeDelegate(hook, arg); } <span class="hljs-comment"><span class="hljs-comment">// return }</span></span></code> </pre><br><br>  And we get a tenfold acceleration compared to the usual delegate call.  At the moment it is the best option from the considered. <br><br><h5>  Call via dynamic </h5><br><a name="dynamic"></a><br>  And go to the main character (unless of course you support legacy projects created before .NET 4.0) <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestDynamicCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">dynamic</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = Container.Get(arg.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">dynamic</span></span> hook = CreateDelegate(instance, instance.GetType().GetMethod(<span class="hljs-string"><span class="hljs-string">"Process"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> summ = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ITERATION_COUNT; i++) { summ += hook(arg); } <span class="hljs-comment"><span class="hljs-comment">// return }</span></span></code> </pre><br><br>  All that we have done in comparison with the call through the delegate, we added the dynamic keyword, which allowed the runtime to build the delegate call through the <a href="https://en.wikipedia.org/wiki/Dynamic_Language_Runtime">DLR</a> itself during the work.  In essence, they threw checks on the type match.  And they accelerated two more times compared to the optimized call of delegates. <br><br><a name="expression"></a><br>  UPD: Added a more efficient way to call on the <a href="https://habrahabr.ru/users/mayorovp/" class="user_link">mayorovp</a> prompt.  Shows the best results in speed, and eats less memory compared to dynamic. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoker</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Invoker </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MethodInfo method</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetArg = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argsArg = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[])); Expression body = Expression.Call( method.IsStatic ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : Expression.Convert(targetArg, method.DeclaringType), method, method.GetParameters().Select((p, i) =&gt; Expression.Convert(Expression.ArrayIndex(argsArg, Expression.Constant(i)), p.ParameterType))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body.Type == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)) body = Expression.Block(body, Expression.Constant(<span class="hljs-literal"><span class="hljs-literal">null</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (body.Type.IsValueType) body = Expression.Convert(body, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Expression.Lambda&lt;Invoker&gt;(body, targetArg, argsArg).Compile(); }</code> </pre><br><br>  Test <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> TestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestExpressionCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = Container.Get(arg.GetType()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hook = CreateExpression(instance.GetType().GetMethod(<span class="hljs-string"><span class="hljs-string">"Process"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> summ = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ITERATION_COUNT; i++) { summ += (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)hook(instance, arg); } <span class="hljs-comment"><span class="hljs-comment">//return }</span></span></code> </pre><br><br>  <a href="https://github.com/ogoun/FastCallMethodsSample/tree/master">Project code</a> <br><br>  <a href="https://habr.com/ru/post/279367/">Back to results</a> </div><p>Source: <a href="https://habr.com/ru/post/279367/">https://habr.com/ru/post/279367/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279353/index.html">Shortcuts on the source page and other fixes in the Vivaldi 1.0.422.8 build</a></li>
<li><a href="../279355/index.html">March 24, QIWI will assemble Scala programmers at the ‚ÄúQIWI Scaladrom Meetup‚Äù</a></li>
<li><a href="../279357/index.html">Wix: development overlooking the sea</a></li>
<li><a href="../279359/index.html">Let's pay advertising your channel push-notifications in the amount of up to 10 thousand rubles</a></li>
<li><a href="../279361/index.html">[PF] Print PDF under .NET, raster approach</a></li>
<li><a href="../279369/index.html">AirPlay server and Time Machine backup on MTK routers (and not only)</a></li>
<li><a href="../279371/index.html">Just another bike encryption</a></li>
<li><a href="../279373/index.html">Creating a draft interface form and dialog box map in PLANTUML</a></li>
<li><a href="../279375/index.html">CodingFuture + Puppet. Part IV: Centralized Management (cftotalcontrol)</a></li>
<li><a href="../279377/index.html">Recall all: Java JET conference. September 28, 2015. Report</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>