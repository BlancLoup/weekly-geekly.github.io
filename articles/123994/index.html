<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parallelization of tests or one head is good, but two heads are better</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At some point, if you try hard and long to keep the test coverage at least 80% of the code, the run of the full test suite will take longer than it ta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parallelization of tests or one head is good, but two heads are better</h1><div class="post__text post__text-html js-mediator-article"> At some point, if you try hard and long to keep the test coverage at least 80% of the code, the run of the full test suite will take longer than it takes to take a smoke break and read new articles from the habr.  In turn, this leads to the fact that the full suite (suite) will be launched less and less.  Hudson will begin to report broken builds, and then the <a href="http://lurkmore.ru/%25D0%25A2%25D0%25B5%25D0%25BE%25D1%2580%25D0%25B8%25D1%258F_%25D1%2580%25D0%25B0%25D0%25B7%25D0%25B1%25D0%25B8%25D1%2582%25D1%258B%25D1%2585_%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BD">effect of a broken window</a> will work and a broken build will become the norm. <br><br>  You can try to run a full run before each commit.  But spending time on cinema in the form of <a href="http://cukes.info/">cucumber</a> features running across the screen, as well as exiting the <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA_(%25D0%25BF%25D1%2581%25D0%25B8%25D1%2585%25D0%25BE%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25B8%25D1%258F)">stream,</a> will reduce the effectiveness of developers at times. <br><br>  In one of our projects, in which, according to the records of <a href="http://www.redmine.org/">redmine,</a> about 400 hours of work of our team were invested, the situation with tests before parallelization looked like this (a couple of days ago): <br> <code>151 scenarios (151 passed) <br> 3997 steps (3997 passed) <br> 17m49.257s <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>18 minutes !!!</b> <br><br>  During this time, the developer can make coffee, smoke a cigarette, go to the toilet, pinch a nice colleague for the ass and have time to watch the last 3 minutes of the ‚Äúmatrix‚Äù on the screen.  If you require him to run a full run before each commit, then he will only do what to watch the ‚Äúmatrix‚Äù and <s>pinch priests to</s> drink coffee. <br><br>  But the analysis of the processor load during the run shows that only one core is involved in the work, regardless of how many of them there are.  As the proverb says, it's better to lose a day, and then fly five minutes later.  Poryskav in Google, we found gem <a href="https://github.com/grosser/parallel_tests">parallel_tests</a> .  Now we are not looking with such envy at the erlang group, which can safely parallelize their tests on a cluster of rented cloud machines in <a href="http://selectel.ru/">Selectel</a> . <br><a name="habracut"></a><br>  Heme parallel_tests compared with peers ( <a href="https://github.com/ngauthier/hydra">hydra</a> , <a href="https://github.com/jodell/testjour">testjour</a> ) is distinguished by the fact that it allows us to parallelize our integration tests on cucumber + capybara + selenium-webdriver, which, due to the abundant ayaxification of our application, cannot be performed without a real browser, in other words - running through gem <a href="https://github.com/jnicklas/capybara">capybara</a> firefox.  This actually runs several copies of firefox, to which the load is more or less evenly distributed.  htop at the same time demonstrates the full load of all cores, no matter how many they are on the machine.  And, which plays a significant role, it is very easy to adapt the application to use this gem. <br><br>  First, it is necessary to ensure the existence of several test bases, one per core in a typical case.  The heme itself sets the TEST_ENV_NUMBER environment variable at startup, so the database.yml can be entered in the test section. <br> <code>test: <br> database: xxx_test&lt;%= ENV['TEST_ENV_NUMBER'] %&gt; <br></code> <br>  Naturally, it is necessary to create bases before a run with your hands <br> <code>rake parallel:create <br></code> <br><br>  Secondly, it is necessary to ensure synchronization of database schemas during additional migrations or re-posting of old ones: <br> <code>rake parallel:prepare <br></code> <br><br>  Thirdly, it is necessary to start the run differently. <br> <code>rake parallel:features <br></code> <br>  This is for running cucumber features.  You can rspec and ordinary rail tests to drive. <br><br>  Yes, gem, of course, must be registered in the Gemfile and put <br> <code>bundle install <br></code> <br><br>  As a result, these are the results of the last assembly of the Hudson on the eight-nuclear selectk kseoncheg <br> <code>Results: <br> 17 scenarios (17 passed) <br> 347 steps (347 passed) <br> 31 scenarios (31 passed) <br> 780 steps (780 passed) <br> 8 scenarios (8 passed) <br> 149 steps (149 passed) <br> 26 scenarios (26 passed) <br> 1363 steps (1363 passed) <br> 26 scenarios (26 passed) <br> 463 steps (463 passed) <br> 17 scenarios (17 passed) <br> 331 steps (331 passed) <br> 6 scenarios (6 passed) <br> 88 steps (88 passed) <br> 19 scenarios (19 passed) <br> 410 steps (410 passed) <br> <br> Took 338.989782947 seconds <br> Finished: SUCCESS <br></code> <br><br>  Yes, we have reduced the number of steps and scenarios, because besides using parallelization, the test code has undergone some refactoring.  But 150 vs. 151 is not much less.  But in time - 5 and a half minutes, against almost 18. This is still taking into account approximately 60-70 seconds of constant costs for a fresh pull from the repository, the remigration of databases and the launch of firefoxes. <br><br>  The result is obvious, and as a result, the build in Hudson has stabilized in just one day - the last 5 commits have successfully completed a full set of tests, which I wish everyone. <br><br>  UPD: If the step_definitions solution is not found in parallel mode, the solution was found by the <a href="https://habrahabr.ru/users/alder/" class="user_link">Alder</a> habrachelovek.  Then you need to run the tests like this: <br> <code>parallel:features[2,'','--require features'] <br></code> </div><p>Source: <a href="https://habr.com/ru/post/123994/">https://habr.com/ru/post/123994/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../123987/index.html">QIWI Wallet for Windows Phone 7</a></li>
<li><a href="../123989/index.html">Google comics +</a></li>
<li><a href="../123990/index.html">Help OpenStreetMap cool your coffee</a></li>
<li><a href="../123991/index.html">JDK7 Launch - Let's celebrate together a new release of Java in St. Petersburg</a></li>
<li><a href="../123992/index.html">"Poster" has released an application for Android</a></li>
<li><a href="../123995/index.html">Future spyware analyst - you</a></li>
<li><a href="../123998/index.html">The development of the Internet: from a reduced dial-up to free WiFi</a></li>
<li><a href="../123999/index.html">Interview with Google employee Dibbon about open and free software</a></li>
<li><a href="../124002/index.html">How NOT to do a CAPTCHA test</a></li>
<li><a href="../124003/index.html">Plantronics BackBeat 903+ Overview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>