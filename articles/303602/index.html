<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience useful modification UEFI: return Thinkpad W520 legitimate support for fast memory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To begin with the background: 

 Some time ago I bought a used Lenovo Thinkpad W520 laptop on Ebay. As is known, the W-series is very powerful laptops...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience useful modification UEFI: return Thinkpad W520 legitimate support for fast memory</h1><div class="post__text post__text-html js-mediator-article">  <b>To begin with the background:</b> <br><br>  Some time ago I bought a used Lenovo Thinkpad W520 laptop on Ebay.  As is known, the W-series is very powerful laptops, glands in which will give odds to many more modern machines.  Of course, I began to equip it for myself, and, in particular, I decided to upgrade the existing memory with everything that was available, and there were a lot of available: 2 free DDR3-1600 slats from the old laptop - 4 and 8 gigabytes.  Looking at what was installed by the seller, I found that out of 3 installed slats 2 were DDR3-1600, and one was 1333. Given that the first two were 8 gigabytes each, and the last 2 gigabytes, I decided to get rid of it .  Calculating to get after the upgrade 8 + 8 + 8 + 4 = 28 gigabytes DDR3-1600 in a working laptop, I <s>filled everything with saliva and</s> quickly connected it all.  And I got 28 gigabytes ... DDR3-1333.  "What the ...", I thought, and got into Google. <br><br>  After a brief search, I found that both officially and unofficially, the W520 only supports DDR3-1333, and the owners of faster memory were wasting money on it.  I felt a little sad for all such owners, and I decided to try to get rid of this injustice, especially since the memory controller, as you know, in the processor, and installed in my Intel Core i7 2720QM model, <a href="http://ark.intel.com/ru/products/50067/Intel-Core-i7-2720QM-Processor-6M-Cache-up-to-3_30-GHz">officially supports DDR3-1600</a> . <br><a name="habracut"></a><br>  <b>And now some interesting details.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution to any complex task is to start with the collection of available information.  I was pretty lucky here, I found an <a href="http://www.thinkwiki.org/wiki/Custom_BIOS">interesting page on Thinkwiki</a> , which asserted that the modified BIOS I needed very much existed, but it was made by some cunning my compatriot named Oleh, and asked for it 1,500 rubles.  I do not mind, there is a demand - there is a proposal, but we seem to have a mustache ourselves, and we can fix and solder, and we can figure it out in the code, we will try to save one and a half kilo on ice cream. <br><br>  Actually, the task for me was almost solved, the page on Thinkwiki contains a <a href="https://www.bios-mods.com/forum/Thread-REQUEST-Lenovo-Thinkpad-W520-BIOS-1-42-whitelist-removal-8BUJ21UC%3Fpid%3D101743">link</a> to a rather well-known resource BIOS-Mods, where the patch is actually filed on a platter, you need to do this: <br><br><div class="spoiler">  <b class="spoiler_title">At offset 0x1810 replace byte order</b> <div class="spoiler_text"><code>8B 85 C8 FC FF FF 8B 48 09 66 C7 41 01 35 05 C6 85 C2 FC FF FF 0C</code> <br>  on <br> <code>66 0F 1F 44 00 00 0F 1F 00 66 0F 1F 44 00 00 0F 1F 80 00 00 00 00</code> </div> </div><br>  But when I tried to use this solution ‚Äúin the forehead‚Äù, a bummer was waiting for me - such a sequence of bytes in the firmware was not found at all, either by this offset or by some other.  I had to roll up my sleeves and dig deeper, that is, I still needed to figure out what this code does and what it needs to be fixed for. <br><br>  First of all, I will say that the sequence 66 0F 1F 44 00 00 0F 1F 00 66 0F 1F 44 00 00 0F 1F 80 00 00 00 00 does not do anything.  That is, it can just as well be replaced with the nop (0x90) sequence, as <a href="https://habrahabr.ru/users/coderush/" class="user_link">CodeRush</a> later pointed out to me, but this is what I am looking forward to.  For now, we note that this sequence <i>disables the</i> desired code, and does not change it. <br><br>  I proceeded from the fact that the patch that is described in BIOS-Mods is correct, just from a different laptop model, and in my case something will be a little wrong. <br><br>  The source code for the fix in the SandyBridgePhx.efi file is: <br><br><table><tbody><tr><th>  hex </th><th>  asm </th></tr><tr><td>  8B 95 C8 FC FF FF </td><td>  mov edx, [ebp + var_338] </td></tr><tr><td>  8B 42 09 </td><td>  mov eax, [edx + 9] </td></tr><tr><td>  66 C7 41 01 35 05 </td><td>  mov word ptr [eax + 1], 535h </td></tr><tr><td>  C6 85 C2 FC FF FF 0C </td><td>  mov [ebp + var_33E], 0Ch </td></tr></tbody></table><br>  535h here is nothing more than the clock frequency in megahertz, 1333 in decimal number system.  Since this is a typical value, I extracted SandyBridgePhx.efi from <a href="https://app.box.com/s/3e3pgcckqf41kubnzrgz">the</a> <a href="https://github.com/LongSoft/UEFITool">UEFI Tool</a> <a href="https://app.box.com/s/3e3pgcckqf41kubnzrgz">firmware</a> , took <a href="http://www.radare.org/r/">radare2</a> and looked for 535h in this file (do not forget about <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BE%25D0%25BA_%25D0%25B1%25D0%25B0%25D0%25B9%25D1%2582%25D0%25BE%25D0%25B2">little endian</a> ): <br><br>  Listing radare2 <br> <code>[0x00000000]&gt; /x 3505 <br> Searching 2 bytes in [0x0-0x2406] <br> hits: 2 <br> 0x000017d6 hit0_0 3505 <br> 0x00001839 hit0_1 3505 <br></code> <br><br>  For some reason, our 1333 megahertz meet 2 times very close.  We look, what is there is: <br><table><tbody><tr><th>  Bias </th><th>  hex </th><th>  asm </th></tr><tr><td>  0x000017c9 </td><td>  8B 85 C8 FC FF FF </td><td>  mov eax, dword [ebp - 0x338] </td></tr><tr><td>  0x000017cf </td><td>  8B 48 09 </td><td>  mov ecx, dword [eax + 9] </td></tr><tr><td>  0x000017d2 ~ </td><td>  66 C7 41 01 35 05 </td><td>  mov word [ecx + 1], 0x535 </td></tr><tr><td>  0x000017d8 </td><td>  C6 85 C2 FC FF FF 0C </td><td>  mov byte [ebp - 0x33e], 0xc </td></tr></tbody></table><br>  Tilde marked line with the desired value.  It can be seen that the code as a whole corresponds to the desired, the only thing that is different is the registers.  In general, everything seems to be simple, but there is a second value ... Going on the offset 0x00001839 and we see there exactly the same sequence of commands, 1 in 1. WTF?  What patch something?  And most importantly, why do I need to disable this code, and not change 1333 to 1600, say?  To explain this, my rudimentary knowledge of x86 assembler was not enough.  I turned for help to my friend-reverser <a href="https://habrahabr.ru/users/rumata888/" class="user_link">Rumata888</a> .  He, by virtue of the profession, has access to the normal licensed version of IDA Pro, than did not fail to take advantage. <br><br>  Literally one screenshot from IDA, which explained everything to me: <br><br><img src="https://habrastorage.org/files/385/75b/cb2/38575bcb238640bd8914ba29b3652374.png"><br><br>  42Bh, 535h, 640h and 74Bh are, as you probably already guessed, memory frequencies: 1067, 1333, 1600 and 1867 MHz, respectively.  That is, of course, the blocks that set the desired memory frequency (most likely, reading it from the SPD and the saved settings).  But then the most interesting thing happens: regardless of what we posed there, the transition at the 182Ch shift occurs.  And that same second sequence of commands is being executed, which confused me.  Ladies and gentlemen, we have the most common crutch: first we honestly analyze what kind of frequency should be set, and then we take a sledgehammer and beat 1333 MHz tightly.  Naturally, it is necessary to get rid of the crutch (which was done on BIOS-Mods), and after that everything will work. <br><br>  After the clarity came, I, in order to reinforce my confidence, asked <a href="https://habrahabr.ru/users/coderush/" class="user_link">CodeRush</a> , as the chief public expert on UEFI, to check if I did everything as it should, for which I received the already mentioned advice that everything looks fine, but it is better to throw out a sly site ( 66 0F 1F 44 00 00 0F 1F 00 66 0F 1F 44 00 00 0F 1F 80 00 00 00 00) and just hammer an unnecessary crutch with nop-s.  Well, the recommendation to <s>protect</s> yourself to make a backup, better programmer. <br><br>  Then there were difficulties, because of which the patch had to be postponed for almost a month.  At first I was waiting for a parcel with a <a href="https://habrahabr.ru/post/262731/">programmer</a> and a <a href="http://ru.aliexpress.com/item/High-quality-SOIC8-SOP8-Test-Clip-For-EEPROM-93CXX-25CXX-24CXX-in-circuit-programming-on-USB/32615695219.html">clothespin</a> for SPI-Flash firmware without soldering, then I tried to flash a modified firmware file with a programmer after backup with a programmer.  Immediately I inform you: no fig came out.  Apparently, you can only sew if there is a difference in the versions, and 1.42 over 1.42 proprietary software will not sew.  I had to do everything in the most oak way: fix the backup that was merged from the flash drive and fill it back with a programmer. <br><br>  <b>Brief instructions for self-correction of a fatal flaw.</b> <br><br>  Now the summary, for those who do not want to read my writings above, is a working way to unlock memory on the Thinkpad W520 (and other similar models, in particular the T520 and, probably, the X220 and some other models on Sandy Bridge): <br><ol><li>  We buy / look for the above-mentioned clothespin and programmer.  Naturally, the programmer can also be used by another one, in particular, the <a href="https://www.flashrom.org/RaspberryPi">very popular Raspberry Pi</a> , and the clothespin can be replaced by soldering-soldering the SPI Flash chip.  But this is up to you - suddenly you have the Grandmaster soldering skill and the soldering station is always at hand.  For those who are not friends with soldering, I highly recommend clothespins. </li><li>  We connect (or unsolder and connect) the flash drive, do not confuse the connection, the 1st wire on the clothespin is highlighted, on the chip the 1st pin is marked with a dot.  The flash drive itself is here (marked by an arrow): <br><br><img src="https://habrastorage.org/files/0b1/38d/560/0b138d560bfd444f8aaa425750808d4c.jpeg"><br><br>  <a href="https://ru.ifixit.com/Guide/Lenovo%2BThinkPad%2BW520%2BSpeaker%2BReplacement/26042">Instructions on how to get there, with pictures</a> </li><li>  We merge the flash drive backup, just in case we check that it is not empty and the size is correct, the W520 flash drive is 64 Mbit in size, i.e.  8 mebibyte <s>or megabyte if you are retrograde</s> .  It is even better to use the check function of the flasher, if there is one.  If not - can take another software? </li><li>  Open the Hex-editor backup, look for Hex-sequence of bytes. <br><div class="spoiler">  <b class="spoiler_title">Here is such</b> <div class="spoiler_text">  8B 85 C8 FC FF FF 8B 48 09 66 C7 41 01 35 05 C6 85 C2 FC FF FF 0C <br></div></div><br>  We find it in the backup 4 times.  The last two, which are closer to the end, should not be touched - they are for initializing memory in emergency mode (the SandyBridgePhxCrisis.efi file, if anyone is interested).  From the first two, as follows from the text above, we are interested in the second occurrence of this sequence.  My location on the W520 starts at offset 53A834h. </li><li>  Replace all bytes with nop (90h). </li><li>  We flash our backup back to the flash drive, check that everything was done correctly (this is where the check function is absolutely indispensable). </li><li>  We solder the flash drive back (or simply remove the clothespin), assemble the laptop, boot up, run CPU-Z, and take a screenshot like this: <br><img src="https://habrastorage.org/files/dab/ea0/2ed/dabea02ed57246c4aa3ad2822a2f8b82.png"></li><li>  PROFIT! </li></ol><br><br>  I express my gratitude to <a href="https://habrahabr.ru/users/coderush/" class="user_link">CodeRush</a> and <a href="https://habrahabr.ru/users/rumata888/" class="user_link">Rumata888</a> , this note would never <a href="https://habrahabr.ru/users/rumata888/" class="user_link">exist</a> without them, and I would have remained ignorant. <br><br>  If someone takes to follow my example, I am ready to publish ready-made recipes (what to change, at what offset) for other notebook models. <br><br>  UPD: Added the missing byte in the instructions, I apologize to all who may be affected.  Thank you <a href="https://habrahabr.ru/users/arozanov/" class="user_link">arozanov</a> for your attention. </div><p>Source: <a href="https://habr.com/ru/post/303602/">https://habr.com/ru/post/303602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303582/index.html">C--. First meeting</a></li>
<li><a href="../303584/index.html">Experience in automating server REST API testing with Jmeter</a></li>
<li><a href="../303590/index.html">Comparing D and Go performance for web</a></li>
<li><a href="../303594/index.html">Using lambda as local functions</a></li>
<li><a href="../303600/index.html">Emacs as a code editor for Python and Golang</a></li>
<li><a href="../303604/index.html">The digest of interesting events from the world of Java, and around it # 4 (06.06.2016 - 19.06.2016)</a></li>
<li><a href="../303606/index.html">DLMS / COSEM is an open protocol for data exchange with metering devices. Part 2: interface classes, metering device model</a></li>
<li><a href="../303608/index.html">typus is a local python typographer</a></li>
<li><a href="../303610/index.html">The digest of interesting materials for the mobile # 158 developer (June 14-19)</a></li>
<li><a href="../303612/index.html">ProxySQL - another mysql-proxy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>