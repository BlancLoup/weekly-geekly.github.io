<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Electronic digital signature (EDS) documents in 1C for a couple of clicks using the utility CRYPTO-PRO PDF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On one of the large projects, an unusual task arose for 1C. It was necessary to organize the mass sending and signing of documents of counterparties u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Electronic digital signature (EDS) documents in 1C for a couple of clicks using the utility CRYPTO-PRO PDF</h1><div class="post__text post__text-html js-mediator-article">  On one of the large projects, an unusual task arose for 1C.  It was necessary to organize the mass sending and signing of documents of counterparties using an electronic digital signature.  The search for information in the help system and on the 1C forums did not give the desired result.  I had to deal with cryptographic tools, electronic keys and third-party utilities.  The solution found was simple and flexible enough to be repeated in other projects, so I want to share with you. <br><a name="habracut"></a><br>  Task setting in numbers: <br>  ‚Ä¢ The customer‚Äôs enterprise employs nearly 3,000 people in more than 50 branches throughout Russia. <br>  ‚Ä¢ The customer‚Äôs enterprise uses SCP 1.3 (platform 8.2.19.76). <br>  ‚Ä¢ More than 10,000 active counterparties. <br>  ‚Ä¢ For most of the counterparties (buyers) once a month, you need to send documents electronically (bills, acts, invoices, MOUTH, etc.).  In total, about 100,000 documents. <br>  ‚Ä¢ For sending documents allocated 2 working days. <br>  ‚Ä¢ The dispatch procedure should involve a minimum number of people.  Now their number was reduced to 2 people. <br>  ‚Ä¢ Documents must be emailed as attached PDF files.  Each PDF file must be signed with EDS. <br><br>  Two words that generally represents a digital signature.  Two keys are used for signing and working with files: closed and open.  The private key is stored on your token and is used to sign or encrypt documents.  The public key should be distributed to all users who should work with the document you have signed.  This usually happens automatically when a file is signed.  Next, there is a file that we need to sign.  Using a special software from the contents of the file and your private key creates a unique character sequence, something like a checksum.  This sequence is the digital signature.  EDS is always unique to this user and this document.  The signature contains information on the date the document was signed, the signer, the checksum for the signed document, and the link or the public key file itself.  The signature can be added to the signed file or saved as a separate file.  Of course, we are interested in the first option. <br><br>  As always, the solution to the problem began by studying what is already there.  There were several cryptography modules and EDS for 1C.  But they did not fit.  As a rule, they can sign either XML files, or save the signature and public key in a separate file.  And we needed to get a signed PDF-document at the output, which can be easily and conveniently viewed using the same Adobe Acrobat Reader. <br>  The second solution was to search for so-called PDF printers ‚Äî programs that can save any document as a PDF file.  The most suitable solution turned out to be the BullZip PDF Printer (http://www.bullzip.com/products/pdf/download.php), which in the paid version has the function of signing the created documents.  The decision, in principle, came up, but there were serious bureaucratic problems with the purchase, coordination and installation of new software on the territory of the enterprise.  While the decision was being negotiated, I paid attention to the set of CRIPTO-PRO programs, which, as a rule, is supplied and works together with the EDS key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Solution one, semi-manual </h4><br>  The vast majority of EDS keys are issued in the form of eToken or Rutoken USB modules.  In my case was eToken.  Who does not know, the main difference is that eToken has a built-in hardware cryptographic co-processor.  This means that when encrypting data, the private key does not leave the token.  In our case, this difference does not matter. <br><br>  I will not consider installing USB dongle drivers.  They, as a rule, are supplied by the issuing certifying center along with the tokens themselves and the installation does not cause problems.  More tokens are usually supplied with a license for CRYPTO-PRO and the CryptoPro CSP utility.  I used the latest currently available version 3.9. <br><br>  Then everything is simple.  Launch CryptoPro CSP.  The Service tab, the View certificates button in the container, click Browse to select the token with the crypto-storage, and choose the repository we need.  Usually on one token one repository. <br><img src="https://habrastorage.org/files/526/54e/1ad/52654e1ad43d4e69a5afb205649ded94.png" alt="image"><br><br>  Click Next and get a window with information on the certificate to which the key is attached.  We are waiting for the Install button and install the certificate in the Personal store for a local user.  Usually, together with the CryptoPro CSP utility, a shortcut to the Certificates snap-in is installed in the Start menu.  We start equipment, we are convinced that everything is correctly made and the certificate was really established in the section Personal for the current user. <br><img src="https://habrastorage.org/files/ad3/2e3/c4c/ad32e3c4cf3d4ace81bda630454118d9.png" alt="image"><br><br>  Next, right click on the installed certificate, All tasks, Export.  Be sure to refuse to export the private key and save the certificate somewhere on the local computer, for example, on the desktop, in the X.509 file format (.CER) in the DER encoding.  We will need the saved certificate further to perform the signature. <br><br>  The last thing left for us is to download the CryptoPro PDF utility from <a href="http://www.cryptopro.ru/downloads">www.cryptopro.ru/downloads</a> , with which we will execute the signature of PDF files. <br><br>  The work of the utility is extremely simple.  Select the folder in which the PDF-files are located, select the folder where the signed files will be saved (if this is one and the same folder, in the advanced settings you need to check the "Overwrite files with the same name" checkbox) select the certificate from the container that we will use for signatures, enter the pin from the key and, if everything is correct, after a few seconds, signed PDF files will appear in the destination folder.  In order for an EDS to be recognized legally, by law, a time stamp must also be set, but I did not need this for the task. <br><br>  In principle, everything!  If you have a small organization and a couple dozen counterparties, then you can do nothing else at all and leave everything in manual mode.  In addition, we didn‚Äôt need 1C at all; you can create PDF documents in many ways, including from Microsoft Office. <br><br>  Long could not figure out why the signature does not pass and gives an error.  It turned out that the successful operation of the CryptoPro PDF utility should have Adobe Acrobat Pro installed on the computer (not Reader, <b>this is important!</b> ).  It is with its help that the utility modifies PDF files and adds a signature to them. <br><br>  An example of a signed file in the picture.  It looks like a regular PDF, only on the Signatures tab there was information about the subscriber.  Of the important, it is indicated who signed the documents (usually the name and the name of the organization) and that the document has not been changed since the moment of signing.  The information that the certificate is unreliable can be ignored.  It only says that Adobe and its Acrobat Reader product do not know anything about your certificate. <br><img src="https://habrastorage.org/files/12e/dcc/080/12edcc0808db41a7b177380f0fda89e4.png" alt="image"><br><br><h4>  Solution two, automatic </h4><br>  As I wrote above, in my case the manual solution did not fit.  There are a lot of counterparties, several dozens of documents are created for each month.  They all need to save to PDF, sign, send in one letter.  To solve the problem, they invented to modify and use the ‚ÄúGroup processing of directories and documents‚Äù standard for many configurations.  For the most popular configurations, this processing is either included in the configuration itself or can be found as external on the ITS disk. <br><br>  Processing is already able to print selected documents.  In the latest versions of the platform, a regular mechanism for saving print forms in the form of PDF files has appeared.  It remains to combine these two mechanisms and save the documents selected by the user to a folder on the local computer, and then launch the command line and launch the CryptoPro PDF utility to perform the signature. <br><br>  A little finalized the interface part.  Work with reference books was removed from processing.  Left in the interface 4 types of documents that need to be sent.  Changed the selection system.  Created a new information register of the EDS Settings.  For each user, it stores information on the path that CryptoPro PDF lies on the local computer, the folders for temporary storage of files, and the certificate to be signed.  We also asked to keep the pin from the key, but we did not do this for security reasons. <br><br>  So that the automation was completely complete, I had to revive the email module in 1C.  Then everything is simple.  Once a month, the operator selects the list of contractors and the types of documents to be sent, checks the result of selection, presses the Execute button, enters the PIN code from the key and waits ... In my case, the formation of a package of documents may take several hours. <br><br>  Processing groups selected documents by counterparties, then goes through a cycle for each counterparty, selects all of its documents, saves them as PDF files to disk, launches the CryptoPro PDF utility from the command line, signs the saved documents, creates an Email document with contact data from the counterparty directory , as an attachment, attaches signed documents from a folder on a disk, transfers the letter to the status to be sent and proceeds to the next counterparty.  Letters are sent by the routine task once every 10 minutes.  Processing can be left overnight.  The problems that have arisen will be processed correctly, and in the morning the user will see the log of errors and the log of sent letters. <br><br>  For convenience, I will give a piece of code that performs the signing procedure itself.  All parameters are taken from the created register information. <br><br><pre><code class="1c hljs"> = <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(, <span class="hljs-string"><span class="hljs-string">"*.pdf"</span></span>, <span class="hljs-literal"><span class="hljs-literal"></span></span>);  = .(); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span> +  + <span class="hljs-string"><span class="hljs-string">"   ."</span></span>);  =  + <span class="hljs-string"><span class="hljs-string">" sign"</span></span> + <span class="hljs-string"><span class="hljs-string">" --in-dir="""</span></span> +  + <span class="hljs-string"><span class="hljs-string">""""</span></span> + <span class="hljs-string"><span class="hljs-string">" --out-dir="""</span></span> +  + <span class="hljs-string"><span class="hljs-string">""""</span></span> + <span class="hljs-string"><span class="hljs-string">" --report-dir="""</span></span> +  + <span class="hljs-string"><span class="hljs-string">""""</span></span> + <span class="hljs-string"><span class="hljs-string">" --err-dir="""</span></span> +  + <span class="hljs-string"><span class="hljs-string">""""</span></span> + <span class="hljs-string"><span class="hljs-string">" --certificate="""</span></span> +  + <span class="hljs-string"><span class="hljs-string">""""</span></span> + <span class="hljs-string"><span class="hljs-string">" --pin="""</span></span> +  + <span class="hljs-string"><span class="hljs-string">""""</span></span> + <span class="hljs-string"><span class="hljs-string">" --overwrite-files"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-literal"><span class="hljs-literal"></span></span>);  = <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(, <span class="hljs-string"><span class="hljs-string">"*.pdf"</span></span>, <span class="hljs-literal"><span class="hljs-literal"></span></span>);  = .(); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span> +  + <span class="hljs-string"><span class="hljs-string">" ."</span></span>);</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/253681/">https://habr.com/ru/post/253681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253663/index.html">Access GoDaddy account managed to get through Photoshop</a></li>
<li><a href="../253665/index.html">Using Log4php in Magento Applications</a></li>
<li><a href="../253671/index.html">Who might need K-Meleon?</a></li>
<li><a href="../253675/index.html">A simple explanation of the movement of money in the banking system</a></li>
<li><a href="../253679/index.html">Solution Management at SEBoK</a></li>
<li><a href="../253683/index.html">How to deal with OutOfMemoryError in practice, or oh, these databases</a></li>
<li><a href="../253685/index.html">Demonstration of the program ZyXEL Wireless Optimizer</a></li>
<li><a href="../253687/index.html">CompTIA certifications for IT professionals. Part 7 of 7. CompTIA CTT + (Certified Technical Trainer)</a></li>
<li><a href="../253689/index.html">HP Software: Application Monitoring Systems</a></li>
<li><a href="../253691/index.html">Demonstration of little-known features of Windows Server 2012R2, Office 365, Microsoft Azure and a free webinar on Hyper-V</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>