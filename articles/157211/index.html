<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Indication of the subscriber's status in the queue on the phone with BLF buttons</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today the task is a little more difficult. 
 The client needs to be able to enter / exit the queue by pressing the speed dial button. Moreover, if the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Indication of the subscriber's status in the queue on the phone with BLF buttons</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/598/5f0/c47/5985f0c474729d62d675df88041bad65.jpg" align="right" alt="image">  Today the task is a little more difficult. <br>  The client needs to be able to enter / exit the queue by pressing the speed dial button.  Moreover, if the subscriber is in the queue, the button is green, if not, then blinks red.  This can be done if the IP itself supports the phone function BLF.  For the function to work, the button will need to register the number of the form * 12111 * 222, where 111 is the queue number and 222 is the subscriber number.  It was tested on the <a href="http://xtelekom.ru/sip_ip_phone/sip_ip_phone_grandstream">Grandstream GXP</a> series, the most different.  The server is Linux with Elastix, well, you can just <a href="http://xtelekom.ru/asterisk">Asterisk 1.6+</a> . <br>  One of the conditions is the lack of binding to the subscriber number.  Queue numbers are fixed, and subscribers can be any.  To monitor the state in Asterisk you need HINT and if it is not there, we will create it. <a name="habracut"></a><br>  This will require an additional script, but for now let's start with the macro in extensions.conf.  In our case, this is extensions_override_freepbx.conf, since we are dealing with Elastix. <br>  Add the input / output handler macro to the context we need: <br><pre><code class="bash hljs">[app-queue-toggle] include =&gt; app-queue-toggle-custom exten =&gt; s,1(start),Answer exten =&gt; s,n,Wait(1) exten =&gt; s,n,Macro(user-callerid,) exten =&gt; s,n,Set(QUEUESTAT=LOGGEDOUT) exten =&gt; s,n,AGI(queue_devstate.agi,getqueues,<span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>) exten =&gt; s,n,AGI(qu.php, <span class="hljs-variable"><span class="hljs-variable">${AMPUSER}</span></span>, <span class="hljs-variable"><span class="hljs-variable">${QUEUENO}</span></span>) exten =&gt; s,n,NoOp(number my <span class="hljs-variable"><span class="hljs-variable">${CALLERIDMY}</span></span>) exten =&gt; s,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${QUEUESTAT}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"LOGGEDOUT"</span></span>]?activate) exten =&gt; s,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${QUEUESTAT}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"LOGGEDIN"</span></span>]?deactivate) exten =&gt; s,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${QUEUESTAT}</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"STATIC"</span></span>]?static:end) exten =&gt; s,n(deactivate),Noop(Agent Logged out) exten =&gt; s,n,Macro(toggle-del-agent,) exten =&gt; s,n,Set(DEVICE_STATE(Custom:QueueStat<span class="hljs-variable"><span class="hljs-variable">${CALLBACKNUM}</span></span>)=RINGING) exten =&gt; s,n(<span class="hljs-built_in"><span class="hljs-built_in">logout</span></span>),Playback(agent-loggedoff) exten =&gt; s,n,Macro(hangupcall,) exten =&gt; s,n(activate),Noop(Agent Logged In) exten =&gt; s,n,Macro(toggle-add-agent,) exten =&gt; s,n,Set(DEVICE_STATE(Custom:QueueStat<span class="hljs-variable"><span class="hljs-variable">${CALLBACKNUM}</span></span>)=NOT_INUSE) exten =&gt; s,n,GotoIf($[<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${QAGENT_UNAUTHORIZED}</span></span></span><span class="hljs-string">"</span></span>=<span class="hljs-string"><span class="hljs-string">"1"</span></span>]?<span class="hljs-built_in"><span class="hljs-built_in">logout</span></span>) exten =&gt; s,n,Playback(agent-loginok) exten =&gt; s,n,SayDigits(<span class="hljs-variable"><span class="hljs-variable">${CALLBACKNUM}</span></span>) exten =&gt; s,n,Macro(hangupcall,) exten =&gt; s,n(static),Noop(User is a Static Agent) exten =&gt; s,n,Playback(agent-loginok) exten =&gt; s,n,Macro(hangupcall,)</code> </pre> <br>  And we hang it on our number, here we also add the HINTs that will be added as needed. <br><pre> <code class="bash hljs">[ext-queues] include =&gt; ext-queues-custom exten =&gt; _*12111*XXX,1,Set(QUEUENO=111) exten =&gt; _*12111*XXX,n,Goto(app-queue-toggle,s,start) <span class="hljs-comment"><span class="hljs-comment">#include /etc/asterisk/extensions_override_hints.conf</span></span></code> </pre><br>  The hints will be stored in the external /etc/asterisk/extensions_override_hints.conf file.  It will have entries of the following form: <br><pre> <code class="bash hljs">exten =&gt; *12111*222,hint,Custom:QS111222</code> </pre><br>  Even in the folder / var / lib / asterisk / agi-bin, you need to create a qu.php script that is called from the macro and adds hints: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/php &lt;?php set_time_limit(0); require('phpagi.php'); $agi = new AGI(); $number = $agi-&gt;get_variable('AMPUSER'); $queue = $agi-&gt;get_variable('QUEUENO'); $hints_file = '/etc/asterisk/extensions_override_hints.conf'; $str = 'exten =&gt; *12'.$queue['data'].'*'.$number['data'].',hint,Custom:QS'.$queue['data'].$number['data']; $strsearch = 'QS'.$queue['data'].$number['data']; $fil = file_get_contents($hints_file); if ( !preg_match('~'.$strsearch.'~ism',$fil) ) { $fp = fopen($hints_file, "a+"); fwrite($fp, $str."\r\n"); fclose($fp); $agi-&gt;verbose('Exec reload'); system('/var/lib/asterisk/agi-bin/reload.sh'); } ?&gt;</span></span></code> </pre><br>  And we also need a script, the launch of which overloads dialplan in asterisk.  After all, it is not enough to add hint, you need to ‚Äúdistort‚Äù the dialplan.  Put it here and call it reload.sh. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh /usr/sbin/asterisk -rx 'dialplan reload'</span></span></code> </pre><br>  Give it 733 rights. <br><br>  Everything, it is possible to try to press the button on phone.  When register it will not burn, but after the first click should change color to green.  Additional settings asterisk and php is not required, the work of elastix scripts also do not affect. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/157211/">https://habr.com/ru/post/157211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../157197/index.html">Simple automation of versioning and building a C / C ++ project in Ruby</a></li>
<li><a href="../157199/index.html">PDF generation on the server in Ruby</a></li>
<li><a href="../157203/index.html">The digest of interesting news and materials from the world of PHP over the past two weeks, number 3 (10/20/2012 - 11/02/2012)</a></li>
<li><a href="../157205/index.html">The effectiveness of automatic application testing</a></li>
<li><a href="../157207/index.html">Ping-flooding attack using WinPcap</a></li>
<li><a href="../157217/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ29 (October 27 - November 2, 2012)</a></li>
<li><a href="../157219/index.html">Nokia Lumia 920 and Nokia Lumia 820 went on sale</a></li>
<li><a href="../157221/index.html">IOS 6.0.1 released</a></li>
<li><a href="../157223/index.html">Apple has printed an apology newspaper to Samsung</a></li>
<li><a href="../157229/index.html">3D game with special relativity effects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>