<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Distribution of applications. Part 1: Creating a Formula for Homebrew</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction to the series 
 I recently had a problem, how to distribute one console utility? My usual tools like pip , npm and gem not suitable due t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Distribution of applications. Part 1: Creating a Formula for Homebrew</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/792/b59/278/792b592788384b8ab2d20ae097707315.jpg"><br><h1>  Introduction to the series </h1><br>  I recently had a problem, how to distribute one console utility?  My usual tools like <code>pip</code> , <code>npm</code> and <code>gem</code> not suitable due to the language of the utility itself - <code>bash</code> .  Then it became clear that you need to distribute your application, including through system package managers.  For Mac - due to the lack of built-in - there are several such package managers.  And each of them has its own characteristics and disadvantages.  And in the first part I want to elaborate on <a href="http://brew.sh/">Homebrew</a> , and how to create packages for it. <br><br>  Well, to install applications on Linux, you will need to build packages of such formats: <code>.tar.gz</code> , <code>.deb</code> and <code>.rpm</code> .  What I will discuss in the second part. <br><a name="habracut"></a><br><h2>  Terminology </h2><br>  First of all, we will agree on <a href="">terms</a> , because there are quite specific words in the world of Homebrew.  In the article I will use the original terms to look not very funny.  So: <br><br><table><thead><tr><th>  Term </th><th>  Description </th><th>  Example </th></tr></thead><tbody><tr><td>  Formula </td><td>  Package definition </td><td>  /usr/local/Library/Formula/foo.rb </td></tr><tr><td>  Keg (Keg) </td><td>  Prefix to install Formula </td><td>  /usr/local/Cellar/foo/0.1 </td></tr><tr><td>  opt prefix (prefix) </td><td>  Symlink to the active version of Keg </td><td>  / usr / local / opt / foo </td></tr><tr><td>  Cellar </td><td>  This sets all Keg </td><td>  / usr / local / Cellar </td></tr><tr><td>  Tap (Crane) </td><td>  Additional repositories with Formula or plugins </td><td>  / usr / local / Library / Taps / homebrew / homebrew-versions </td></tr><tr><td>  Bottle </td><td>  Assembled version of Keg </td><td>  qt-4.8.4.mavericks.bottle.tar.gz </td></tr></tbody></table><br><h2>  How Homebrew works </h2><br>  It is impossible to disregard the device of the instrument itself, one of its <a href="https://github.com/bfontaine">creators</a> <a href="https://www.quora.com/How-does-Homebrew-work-internally">told</a> about it perfectly: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  Homebrew is based on two things: Git and Ruby.  When you install Homebrew for the first time, it creates a copy of the official repository in <code>/usr/local</code> .  Every time you update Homebrew with the <code>brew update</code> command, <code>git pull</code> happens, and they will show you which formulas have changed.  When you install something with the <code>brew install</code> command, Homebrew downloads the archive (later the files will be taken from the cache), checks its hash and then installs.  But in fact, Formula can be much more complex: it can have dependencies, loading features: svn, ftp, and so on.  And Homebrew, when possible, provides already collected packages (automatically created by the bot). </blockquote><br><h2>  Creating your own Formula </h2><br>  Suppose you already have some release on github (and if not, <a href="https://help.github.com/articles/creating-releases/">create it</a> with the <code>git tag</code> ).  I will work on the example of my script.  Now the easiest way to create a Formula is to call the <code>brew create https://github.com/sobolevn/git-secret/archive/v0.1.0.tar.gz</code> command <code>brew create https://github.com/sobolevn/git-secret/archive/v0.1.0.tar.gz</code> : <br><br><div class="spoiler">  <b class="spoiler_title">That's what happens</b> <div class="spoiler_text"><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># Documentation: https://github.com/Homebrew/homebrew/blob/master/share/doc/homebrew/Formula-Cookbook.md # http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula # PLEASE REMOVE ALL GENERATED COMMENTS BEFORE SUBMITTING YOUR PULL REQUEST! class GitSecret &lt; Formula desc "" homepage "" url "https://github.com/sobolevn/git-secret/archive/v0.1.0.tar.gz" version "0.1.0" sha256 "107c5555c203ad3b1498e2995fa8aa81942840189316d13933fcf0947180d10b" # depends_on "cmake" =&gt; :build depends_on :x11 # if your formula requires any X11/XQuartz components def install # ENV.deparallelize # if your formula fails when building in parallel # Remove unrecognized options if warned by configure system "./configure", "--disable-debug", "--disable-dependency-tracking", "--disable-silent-rules", "--prefix=#{prefix}" # system "cmake", ".", *std_cmake_args system "make", "install" # if this fails, try separate make/make install steps end test do # `test do` will create, run in and delete a temporary directory. # # This test will fail and we won't accept that! It's enough to just replace # "false" with the main program this formula installs, but it'd be nice if you # were more thorough. Run the test with `brew test git-secret`. Options passed # to `brew install` such as `--HEAD` also need to be provided to `brew test`. # # The installed folder is not in the path, so use the entire path to any # executables being tested: `system "#{bin}/program", "do", "something"`. system "false" end end</span></span></code> </pre> <br></div></div><br>  In the future, to edit the formula, you can use the <code>brew edit</code> command. <br>  Note the main class that inherits the abstract <code>Formula</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> class.  It has several important attributes: <br><br><ul><li>  <code>desc</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> - description of your package, visible to users when they run the <code>brew info git-secret</code> command </li><li>  <code>homepage</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> - application page, may be available with the <code>brew home git-secret</code> command </li><li>  <code>url</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> - the link used to download the source of the application, it is possible to specify download strategies ( <code>:git, :svn</code> ) and other options </li><li>  <code>sha256</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> - security setting: a hash of the file that is specified by the <code>url</code> link, if someone gets access to your repository and replaces the file, then it will not be installed.  Another consequence: every time you change the assembly, you must update the hash </li></ul><br><h3>  Options </h3><br>  Sometimes it becomes necessary to add various options during installation, whether to add optional packages, what parameters to set during assembly, and so on.  In Homebrew there is an <code>option</code> for such a case.  Say, here's an example of the options from the formula <code>git.rb</code> <sup><a href="">*</a></sup> : <br><br><div class="spoiler">  <b class="spoiler_title">Sample options</b> <div class="spoiler_text"><pre> <code class="ruby hljs"> option <span class="hljs-string"><span class="hljs-string">"with-blk-sha1"</span></span>, <span class="hljs-string"><span class="hljs-string">"Compile with the block-optimized SHA1 implementation"</span></span> option <span class="hljs-string"><span class="hljs-string">"without-completions"</span></span>, <span class="hljs-string"><span class="hljs-string">"Disable bash/zsh completions from 'contrib' directory"</span></span> option <span class="hljs-string"><span class="hljs-string">"with-brewed-openssl"</span></span>, <span class="hljs-string"><span class="hljs-string">"Build with Homebrew OpenSSL instead of the system version"</span></span> option <span class="hljs-string"><span class="hljs-string">"with-brewed-curl"</span></span>, <span class="hljs-string"><span class="hljs-string">"Use Homebrew's version of cURL library"</span></span> option <span class="hljs-string"><span class="hljs-string">"with-brewed-svn"</span></span>, <span class="hljs-string"><span class="hljs-string">"Use Homebrew's version of SVN"</span></span> option <span class="hljs-string"><span class="hljs-string">"with-persistent-https"</span></span>, <span class="hljs-string"><span class="hljs-string">"Build git-remote-persistent-https from 'contrib' directory"</span></span></code> </pre> <br></div></div><br>  To access the current options from code, use the <code>build.with? "option_name"</code>  <code>build.with? "option_name"</code> or <code>build.without? "option_name"</code>  <code>build.without? "option_name"</code> . <br><br><h3>  Dependencies </h3><br>  Your application may have dependencies, for them there is a special method <code>depends_on</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> .  It is important to note that dependencies can be different <sup><a href="">*</a></sup> both according to the type of installation, and according to accessories: only the formula or the system package will fit.  There are several types of dependencies (for installation): <br><br><ul><li>  standard, needed for the application to work </li><li>  <code>:build</code> - needed only when building </li><li>  <code>:recommended</code> - set by default, adds option <code>--without-foo</code> </li><li>  <code>:optional</code> - not set by default, but automatically adds the option <code>--with-foo</code> </li></ul><br><div class="spoiler">  <b class="spoiler_title">Dependency example</b> <div class="spoiler_text"><pre> <code class="ruby hljs"> depends_on <span class="hljs-string"><span class="hljs-string">"jpeg"</span></span> depends_on <span class="hljs-string"><span class="hljs-string">"gtk+"</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:optional</span></span> depends_on <span class="hljs-string"><span class="hljs-string">"readline"</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:recommended</span></span> depends_on <span class="hljs-string"><span class="hljs-string">"boost"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"with-icu"</span></span> depends_on <span class="hljs-symbol"><span class="hljs-symbol">:x11</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:optional</span></span></code> </pre> <br></div></div><br>  For those dependencies that are <a href="">not part of Homebrew,</a> there is a special <code>resource</code> block <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> , which must be declared <code>url</code> and <code>sha256</code> . <br><br><h3>  "Pack in advance" </h3><br>  Homebrew has a wonderful bot <sup><a href="">*</a></sup> that walks by formulas and collects them in Bottles.  In order to tell him what to collect, use the special <code>bottle</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> block, where you can specify the url to download, the path to save the file, and the <code>sha256</code> parameters for different versions of Mac OS X. A full example from the documentation: <br><br><div class="spoiler">  <b class="spoiler_title">Bottomles</b> <div class="spoiler_text"><pre> <code class="ruby hljs">bottle <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> root_url <span class="hljs-string"><span class="hljs-string">"https://example.com"</span></span> prefix <span class="hljs-string"><span class="hljs-string">"/opt/homebrew"</span></span> cellar <span class="hljs-string"><span class="hljs-string">"/opt/homebrew/Cellar"</span></span> revision <span class="hljs-number"><span class="hljs-number">4</span></span> sha256 <span class="hljs-string"><span class="hljs-string">"4921af80137af9cc3d38fd17c9120da882448a090b0a8a3a19af3199b415bfca"</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:yosemite</span></span> sha256 <span class="hljs-string"><span class="hljs-string">"c71db15326ee9196cd98602e38d0b7fb2b818cdd48eede4ee8eb827d809e09ba"</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:mavericks</span></span> sha256 <span class="hljs-string"><span class="hljs-string">"85cc828a96735bdafcf29eb6291ca91bac846579bcef7308536e0c875d6c81d7"</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:mountain_lion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br></div></div><br>  And you can specify <code>bottle :unneeded</code> and the assembly will not be made.  By the way, to check the correctness of the assembly, our good bot performs the tests that we specify for the formula.  About them below. <br><br><h3>  Installing the latest version from the repository </h3><br>  Attribute <code>head</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> - allows you to add a link to the repository, so that you can install the latest version directly from the current branch (which can be defined using the parameter <code>:branch</code> ).  To install a formula this way, you need to use <code>brew install --HEAD $formula</code> . <br><br><h3>  Formula installation process </h3><br>  Here it is time to talk about the main method - <code>install</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> , which executes the commands necessary for installation.  Basically, it recycles a call to system commands using <code>Kernel#system</code> <sup><a href="http://ruby-doc.org/core-2.3.0/Kernel.html">*</a></sup> .  Here we should mention the special values ‚Äã‚Äãof variables that can be transferred to your script for its configuration, they are available by <a href="">reference</a> . <br><br><h3>  Communication with the user </h3><br>  To display messages <sup><a href="">*</a></sup> there are special features: <br><br><ul><li>  <code>ohai</code> for general information </li><li>  <code>opoo</code> for alerts </li><li>  <code>odie</code> for error messages and immediate exit </li></ul><br>  And there is also the <code>caveats</code> <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> method, which will write the user all the details about your package after a successful installation or when running the <code>brew info $formula</code> command. <br><br><h3>  Installation Testing </h3><br>  Things are easy: check whether the formula is established, whether it has gathered.  To <a href="">check the correctness of</a> work in Homebrew there is a special <code>test</code> block <sup><a href="http://www.rubydoc.info/github/Homebrew/homebrew/master/Formula">*</a></sup> .  It is executed inside the sendbox, and if it is executed, the formula is considered correctly assembled.  As the creators themselves say, they don‚Äôt mind if the <code>test</code> only checks the version.  The main thing is that the program has gathered.  But it will be better if it passes the test more impressive.  It is important to understand that it is not the functionality that is being tested, but only the assembly.  Here is <a href="">an example of a</a> test: <br><br><div class="spoiler">  <b class="spoiler_title">Sample test</b> <div class="spoiler_text"><pre> <code class="ruby hljs"> test <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> (testpath/<span class="hljs-string"><span class="hljs-string">".zshrc"</span></span>).write <span class="hljs-string"><span class="hljs-string">"source `brew --prefix`/share/antigen.zsh"</span></span> system <span class="hljs-string"><span class="hljs-string">"/bin/zsh"</span></span>, <span class="hljs-string"><span class="hljs-string">"--login"</span></span>, <span class="hljs-string"><span class="hljs-string">"-i"</span></span>, <span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"antigen help"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br></div></div><br>  To invoke the test locally, use the <code>brew test $formula</code> command. <br><br><h2>  Formula goes into the world </h2><br>  That's all, our formula is almost ready!  Now you need to make sure that it passes internal checks from Homebrew: run the <code>brew audit --strict --online $formula</code> .  If there are no errors, then continue.  If there is, then rule.  We immediately prompt that you need to change.  Now the formula is ready to enter the open world.  And from the open world there are several ways to install the formula: <br><br><ul><li>  Official Homebrew Repository </li><li>  Personal Tap </li></ul><br>  More about each. <br><br><h3>  Fill the formula in the official repository of Homebrew </h3><br>  Difficult way.  Our formula must satisfy <a href="">many of the requirements of</a> Homebrew to be accepted.  Here are some of them: <br><br><ul><li>  Not a duplicate.  Here we are talking not only about the main repository, but also official Tap </li><li>  The application should not update itself </li><li>  It should not download anything when installing </li><li>  The formula has stable versions. </li><li>  The formula should not be available through <code>gem</code> or <code>pip</code> </li><li>  The formula is known to people who support it, it should have a homepage </li><li>  She does not collect <code>.app</code> , such formulas place in <code>Cask</code> </li></ul><br>  But according to the authors, <a href="">there are exceptions</a> . <br><br>  If your formula fits, now you need to upload it to the official repository.  About how to make Pull-Request will tell the <a href="">official guide</a> to participate in the project, there are many subtleties and rules. <br><br>  Well, if it does not fit, or you intentionally do not want to send it there, then you need to create your Tap. <br><br><h3>  Create your Tap </h3><br>  Tap <sup><a href="">*</a></sup> is essentially just a repository in which you store your own formulas.  To create a Tap, we create a repository on github with the prefix <code>homebrew-</code> .  For example: <code>homebrew-mytap</code> .  The formulas themselves can be either in the root or in the <code>Formula</code> folder (or <code>HomebrewFormula</code> ).  Now to establish your formula there are two ways, first: <br><br><ul><li>  <code>brew tap &lt;your-github-username&gt;/mytap</code> - creates a local copy of your repository </li><li>  <code>brew install $formula</code> - install <code>brew install $formula</code> from it </li></ul><br>  Or one team: <br><br><ul><li>  <code>brew install &lt;your-github-username&gt;/mytap/$formula</code> - this method will first do <code>brew &lt;your-github-username&gt;/mytap</code> and then invoke the <code>install</code> command </li></ul><br>  Done! <br><br><h2>  Conclusion </h2><br>  I tried to skim and look at a number of the key features of Homebrew.  Of course, you can‚Äôt tell just one time, such topics as patches, compiler choice, writing your own loading strategies and many subtleties when working with <a href="">Python, Ruby (and other) programs</a> that have their own features and capabilities boxes. "  But those who wish can always read the relevant articles in the official documentation, which, by the way, is good. <br><br>  Writing your formulas is very simple, because Homebrew provides a very high-quality API.  Even if you do not know Ruby, then everything should turn out pretty quickly.  <a href="https://github.com/sobolevn/homebrew-tap">That's what</a> happened with me. <br></div><p>Source: <a href="https://habr.com/ru/post/279687/">https://habr.com/ru/post/279687/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279671/index.html">Angular is a design pattern.</a></li>
<li><a href="../279675/index.html">Track updates from MongoDB Oplog to Sharded Cluster using Scala and Akka Streams</a></li>
<li><a href="../279679/index.html">QNX RTOS: Qnet - transparent inter-tasking network interaction</a></li>
<li><a href="../279681/index.html">New home for repository or history of moving to GitLab</a></li>
<li><a href="../279685/index.html">The digest of interesting materials for the mobile # 145 developer (March 14-20)</a></li>
<li><a href="../279689/index.html">2.3 Working with custom data streams</a></li>
<li><a href="../279695/index.html">Yet another instructions for obtaining the Let's Encrypt ssl certificate</a></li>
<li><a href="../279699/index.html">Security Receivers demonstrate full-featured exploit for Android</a></li>
<li><a href="../279701/index.html">We use Yii2 migrations for working with multiple databases</a></li>
<li><a href="../279703/index.html">How to create the perfect pull request</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>