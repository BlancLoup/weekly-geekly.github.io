<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SMR: understandable in theory, difficult to practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today, data growth per person is growing exponentially, and companies offering storage solutions for this data strive to do their utmost to increase t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SMR: understandable in theory, difficult to practice</h1><div class="post__text post__text-html js-mediator-article">  Today, data growth per person is growing exponentially, and companies offering storage solutions for this data strive to do their utmost to increase the available capacity of their devices.  Seagate SMR (Shingled Magnetic Recording) tiled magnetic recording technology improves recording density, increasing disk capacity by 25%.  This is possible by increasing the number of tracks on each plate and reducing the distance between them.  The tracks are placed one above the other (like tiles on the roof), which allows you to record more data without increasing the area of ‚Äã‚Äãthe plate.  When recording new data, the tracks partially overlap or are truncated.  Due to the fact that the reading element on the disk head is smaller than the writing one, it can read data even from a truncated track without disturbing its integrity and reliability. <br><br>  However, the following problem is associated with the SMR technology: in order to overwrite or update the information, it is necessary to rewrite not only the required fragment, but also the data on the last tracks.  Due to the fact that the recording element is wider, it captures data on the adjacent tracks, so you need to overwrite it.  Thus, when changing data on the lower track, you need to correct the data on the nearest superimposed track, then on the next one, and so on, until the entire plate is rewritten. <a name="habracut"></a><br><br>  For this reason, the tracks of the SMR disk are grouped into small groups called tapes.  Superimposed on each other, respectively, only the tracks within the same tape.  Due to such grouping, in the case of updating some data, it will not be necessary to rewrite the entire plate, but only a limited number of tracks, which greatly simplifies and speeds up the process.  For each type of discs, its own tape architecture is developed, taking into account its scope.  Each Seagate product line is designed for a specific scope and specific working conditions, and SMR technology allows you to achieve the best results when used correctly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Seagate SMR is a technology to meet the ever-growing demand for additional capacity.  Today, it is being actively improved and, in combination with other innovative methods, can be used to increase the recording density on the next generation of hard drives. <br><br>  But first of all, it is necessary to understand some of the nuances of its application. <br><br>  There are three types of devices that support tiled writing: <br><br>  Standalone (Drive Managed) <br><br>  Working with these devices does not require any changes to the host software.  All write / read logic is organized by the device itself.  Does it mean we can just set them and relax?  Not. <br><br>  Drives that implement Drive Managed write technology usually have a large write-back cache (from 128 MB to disk).  In this case, successive requests are processed in write-around mode.  The main difficulties faced by developers of devices and storage systems based on this recording technology are the following: <br><br>  1. The cache size is limited and as it is filled we can get unpredictable device performance. <br>  2. Sometimes there are significant levels of delays with an intensive cache flush. <br>  3. Determination of sequences is not always a trivial task, and in difficult cases we can expect degradation of performance. <br><br>  The main advantage of this approach is the complete backward compatibility of devices with existing operating systems and applications.  By understanding your task well, you can now buy Drive Managed devices and benefit from the use of technology.  Further in the article you will see the results of testing such devices and be able to determine how they suit you. <br><br>  Host Managed <br><br>  These devices use a set of extensions to ATA and SCSI to interact with the disks.  This is a different type of device (14h), which requires major changes in the entire Storage Stack and is incompatible with classical technologies, that is, without special adaptation of applications and operating systems, you will not be able to use these disks.  The host must write to the devices strictly sequentially.  At the same time, device performance is 100% predictable.  But the correct operation of the higher-level software is necessary in order for the performance of the storage subsystem to be truly predictable. <br><br>  Supported by the host (Host Aware) <br><br>  These are hybrid solutions combining the advantages of Device Managed and Host Managed technologies.  By purchasing such disks, we get support for backward compatibility with the possibility of using special ATA and SCSI extensions for optimal operation with SMR devices.  That is, we can, as it is easy to write to devices, as we did before, and to do it in the most optimal way. <br><br>  In order to work with Host Managed and Host Aware devices, a pair of new standards are being developed: ZBC and ZAC, which are included in T10 / T13.  ZBC is an SCSI extension and is ratified by T10.  Standards are being developed for SMR disks, but in the future they may be applied to other devices. <br><br>  ZBC / ZAC define a logical model of devices, where the main element is the zone that is displayed as an LBA range. <br><br>  Standards define three types of logical zones into which devices are broken down: <br><br>  1. Conventional zone - a zone with which we can work in the traditional way, as with ordinary hard drives.  That is, we can write consistently and randomly. <br><br>  2. Two types of Write Pointer Zone: <br><br>  2.1.  Sequential write preferred - the main type of zones for Host Aware devices, preference is given to sequential write.  Random writing to devices is handled as in Device Managed devices and can cause performance loss. <br><br>  2.2.  Sequential write only is the main zone type for Host Manged devices, only sequential write is possible.  Random entry is not allowed, if you attempt to produce it, an error will be returned. <br><br>  Each zone has its own Write Pointer and its status.  For all devices that support HM write type, the first LBA of the next write command must necessarily correspond to the position of Write Pointer.  For HA devices, the Write Pointer is informational and serves to optimize disk handling. <br><br>  In addition to the new logical structure, new commands appear in the standards: <br><br>  REPORT_ZONES is the main method by which you can get information about existing zones on the device and their status.  The disk in response to this command reports the existing zones, their types (Conventional, Sequential Write Required, Sequential Write Preferred), state of the zones, size, information about finding Write Pointer. <br><br>  RESET_WRITE_POINTER is the successor to the TRIM command for ZBC devices.  When you call it, the zone is erased and Write Pointer is moved to the beginning of the zone. <br><br>  To control the status of a zone, 3 optional commands are used: <br><br>  OPEN_ZONE <br>  CLOSE_ZONE <br>  FINISH_ZONE <br><br>  In the VPD pages, new information has appeared, including the maximum number of open zones, providing the best performance and the maximum number of zones available for random recording with the best performance. <br><br>  Storage manufacturers need to take care of the support of HA / HM devices, making changes at all levels of the stack: libraries, schedulers, RAID engine, logical volumes, file systems. <br><br>  In addition, you need to provide two types of interfaces for applications: the traditional interface, organizing an array as a device-managed device, and the implementation of a virtual volume as a HOST AWARE device.  This is necessary because applications are expected to work directly with HM / HA devices. <br><br>  In general, the algorithm for working with HA devices is as follows: <br><br>  1. Determine the device configuration using the REPORT_ZONES <br>  2. Define zones for random recording. <br>  2.1.  Quantity limited by device capabilities <br>  2.2.  In these zones, there is no need to track the position of the Write Pointer. <br>  3. Use the remaining zones for sequential writing and using Write-Pointer position information and performing only sequential writing. <br>  4. Control the number of open zones <br>  5. Use garbage collection to release a pool of zones. <br><br>  Some recording techniques can be applied from existing all-flash storage systems for which problems of prostate sequential recording and garbage collection were solved. <br><br>  <a href="http://www.raidix.ru/">RAIDIX</a> has tested Seagate SMR drives in their lab and gives several recommendations for using them.  These disks differ in that they are Device Managed and do not require any major changes in the operation of applications. <br><br>  During testing, an attempt was made to test the performance expectations of such disks and to understand why we can use them. <br><br>  Two Seagate Archive HDD 8000GB drives participated in the tests. <br>  Testing was performed on the Debian operating system version 8.1 <br>  CPU Intel i7 c 2.67 MHz <br>  16 GB RAM <br>  The drives have SATA 3 interface, we included the controller in AHCI mode. <br><br>  To begin with, we provide information about devices by making an Inquiry inquiry. <br><br><div class="spoiler"> <b class="spoiler_title">For this, we used the sg3-utils utility set.</b> <div class="spoiler_text">  sg_inq / dev / sdb <br>  standard INQUIRY: <br>  PQual = 0 Device_type = 0 RMB = 0 version = 0x05 [SPC-3] <br>  [AERC = 0] [TrmTsk = 0] NormACA = 0 HiSUP = 0 Resp_data_format = 2 <br>  SCCS = 0 ACC = 0 TPGS = 0 3PC = 0 Protect = 0 BQue = 0 <br>  EncServ = 0 MultiP = 0 [MChngr = 0] [ACKREQQ = 0] Addr16 = 0 <br>  [RelAdr = 0] WBus16 = 0 Sync = 0 Linked = 0 [TranDis = 0] CmdQue = 0 <br>  [SPI: Clocking = 0x0 QAS = 0 IUS = 0] <br>  length = 96 (0x60) Peripheral device type: disk <br>  Vendor identification: ATA <br>  Product identification: ST8000AS0002-1NA <br>  Product revision level: AR13 <br>  Unit serial number: Z84011LQ <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">On page 83 is the VPD.</b> <div class="spoiler_text">  sg_inq / dev / sdb -p 0x83 <br>  VPD INQUIRY: Device Identification page <br>  Designation descriptor number 1, descriptor length: 24 <br>  designator_type: vendor specific [0x0], code_set: ASCII <br>  associated with the preferred logical unit <br>  vendor specific: Z84011LQ <br>  Designation descriptor number 2, descriptor length: 72 <br>  designator_type: T10 vendor identification, code_set: ASCII <br>  associated with the preferred logical unit <br>  vendor id: ATA <br>  vendor specific: ST8000AS0002-1NA17Z Z84011LQ <br></div></div><br><br>  Nothing special, we have not seen.  Attempts to read information about the zones turned out to be a failure. <br><br>  RAIDIX makes software for storage systems operating in various industries, and we tried not to use specialized or paid benchmarks. <br><br>  We start with the fact that we check the streaming performance of disks on internal and external tracks.  The test results will give the maximum expected performance of the device and correspond primarily to tasks such as data archiving. <br><br>  We did not touch the block subsystem settings.  We perform testing, writing data to the disks in blocks of 1 megabyte.  For this we use the benchmark fio v.2.1.11. <br><br>  Jobs differ from each other only by the offset from the beginning of the device and are launched one by one.  Libaio is selected as the I / O library. <br><br>  The results are pretty good: <br><br><img src="https://habrastorage.org/files/bc2/0e5/a48/bc20e5a48e694bf7a2a4aaa7e3a4b3f8.png"><br><br>  Performance on the external and internal lanes differs almost 2 times. <br>  We see occasional dips in performance.  They are not critical for archiving, but can be a problem for other tasks.  When the storage cache write-back works correctly, we assume that we will not observe such a situation.  We had a similar experience, creating a RAID 0 array from both disks, allocating 2GB of RAM cache to each disk, and did not see performance failures. <br><br>  When reading the failures are not visible.  And subsequent tests will show that the read performance of SMR drives in performance is no different from normal. <br><br><img src="https://habrastorage.org/files/e26/021/cec/e26021cec34344b5897218cbe689c8cb.png"><br><br>  Now we will conduct more interesting tests.  Run 10 threads with different offset at the same time.  We do this in order to check the correctness of buffering and see how the discs will work on the tasks of CCTV, Video Ingest and the like. <br>  The graphs show the total performance for all jobs: <br><br><img src="https://habrastorage.org/files/b17/0ea/6c8/b170ea6c8af647838248c35b6c766703.png"><br><br>  The disk coped well with the load! <br><br>  Performance is kept at 90 MB / s, evenly distributed over the streams, and there are no serious failures.  The reading schedule is absolutely similar, only raised by 20 MB.  For storing and distributing video content, sharing large files, the performance is suitable and practically does not differ from the performance of ordinary disks. <br><br>  Predictably, the disks performed well on streaming read and write operations, and working in several streams was a pleasant surprise for us. <br><br>  We proceed to the "random" reading and writing.  Let's see how disks behave in classic enterprise tasks: storing DBMS files, virtualization, etc. In addition, ‚Äúrandom‚Äù operations include frequent work with metadata and, for example, deduplication enabled on an array. <br><br>  Testing is carried out in blocks of 16 kilobytes and is still true fio. <br>  In the test, we set up several jobs with different queue depths, but we will not give full results.  Only the beginning of the test is significant. <br><br><img src="https://habrastorage.org/files/f6c/457/3e8/f6c4573e8dc74df9969aeb9fa0b4f66a.png"><br><br>  The first 70.5 seconds we see unrealistic for a hard disk 2500 IOps.  When this happens frequent failures.  Apparently, at this moment there is a recording in the buffer and its periodic reset.  Then there is a sharp drop to 3 IOps, which are held until the end of the test. <br><br>  If you wait a few minutes, then after the cache is reset, the situation will repeat. <br><br>  It can be expected that in the presence of a small number of random operations, the disk will behave well.  But if we expect a heavy load on the device, it is better to refrain from using SMR disks.  If possible, RAIDIX recommends that all work with metadata be transferred to external devices. <br><br>  And what about random reading? <br>  In this test, we limited the response time to 50 ms.  Our devices are doing well. <br><br><img src="https://habrastorage.org/files/3d0/114/31c/3d011431c2194cde9bbfe076f7fb875b.png"><br><br>  Reading is between 144-165 IOPs.  The numbers themselves are not bad, but the scatter of 20 IOPs is a bit scary.  Focus on the lower boundary.  The result is not bad, at the level of classic discs. <br><br>  Let's change the approach a little.  Let's take another look at working with a large number of files. <br>  The SGS frametest utility will help us with this.  This benchmark is designed to test the performance of the storage system when editing uncompressed video.  Each frame is a separate file. <br><br>  We created the xfs file system and mounted it with the following parameters: <br>  -o noatime, nodiratime, logbufs = 8, logbsize = 256k, largeio, inode64, swalloc, allocsize = 131072k, nobarrier <br><br>  We start frametest with the following parameters: <br><br>  ./frametest -w hd -n 2000 / test1 / <br><br>  The benchmark creates 2,000 files of 8MB size. <br><br>  The beginning of the test goes well: <br><br>  Averaged details: <br>  Open I / O Frame Data Rate Frame Rate <br>  Last 1s: 0.028 ms 79.40 ms 79.43 ms 100.37 MB / s 12.6 fps <br>  5s: 0.156 ms 83.37 ms 83.53 ms 95.44 MB / s 12.0 fps <br><br>  But after recording 1500 frames, the situation worsens significantly: <br><br>  Averaged details: <br>  Open I / O Frame Data Rate Frame Rate <br>  Last 1s: 0.035 ms 121.88 ms 121.92 ms 65.39 MB / s 8.2 fps <br>  5s: 0.036 ms 120.78 ms 120.83 ms 65.98 MB / s 8.3 fps <br><br>  Then everything is worse: <br><br>  Averaged details: <br>  Open I / O Frame Data Rate Frame Rate <br>  Last 1s: 0.036 ms 438.90 ms 438.94 ms 18.16 MB / s 2.3 fps <br>  5s: 0.035 ms 393.50 ms 393.55 ms 20.26 MB / s 2.5 fps <br><br>  Let's carry out the test for reading: <br><br>  ./frametest -r hd -n 2000 / test1 / <br><br>  Throughout the test, the performance is excellent: <br><br>  Averaged details: <br>  Last 1s: 0.004 ms 41.09 ms 41.10 ms 193.98 MB / s 24.3 fps <br>  5s: 0.004 ms 41.09 ms 41.10 ms 193.98 MB / s 24.3 fps <br><br>  Now work is underway on specialized file systems for SMR disks. <br>  Seagate is developing an ext4 based SMR_FS-EXT4.  You can find several log-structured file systems designed specifically for Device Managed SMR disks, but none of them can be called a mature, recommended product for implementation.  Seagate is also developing a host-supported (Host Aware) version of the SMR disk, which must be completed before the end of the year. <br><br>  What conclusions can we draw from the results of performance measurements? <br>  Device Managed devices can be safely used for tasks that do not differ intensive recording.  They do a very good job with single-threaded and multi-threaded recording tasks.  They are great for reading data.  Periodic ‚Äúrandom‚Äù requests to disks when updating metadata are absorbed by a large cache. <br><br>  For solving problems characterized by intensive ‚Äúrandom‚Äù recording or updating a large number of files, such devices are not very suitable, at least, without the use of additional technical means. <br><br>  The MTBF parameter of the tested disks is 800,000 hours, which is 1.5 times lower than that of, for example, NAS disks.  A large volume of disks significantly increases recovery time and makes it almost impossible to have a regular media scan.  We recommend when designing storage with such disks to rely on a RAID with a parity number greater than 2 and / or approaches that reduce recovery time (For example, Parity Declustering). </div><p>Source: <a href="https://habr.com/ru/post/264553/">https://habr.com/ru/post/264553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264543/index.html">Work with Queues and other Call Center features</a></li>
<li><a href="../264545/index.html">Deploying Rancher to InfoboxCloud: a portable infrastructure with a web interface for Docker</a></li>
<li><a href="../264547/index.html">Comparison of HP ProLiant DL360 Gen6 and HP ProLiant DL360 Gen8. What do we pay more for?</a></li>
<li><a href="../264549/index.html">How Spotify Scales Apache Storm</a></li>
<li><a href="../264551/index.html">Past and Present SSL Certificates</a></li>
<li><a href="../264555/index.html">We get access to the XenServer cloud through access to one virtual machine</a></li>
<li><a href="../264557/index.html">Webinar "Meet the FlyElephant"</a></li>
<li><a href="../264559/index.html">The benefits of learning the languages ‚Äã‚Äãof the family C</a></li>
<li><a href="../264561/index.html">An example of working with iBeacon technology using Swift</a></li>
<li><a href="../264565/index.html">Crowdsourcing map service for works of art</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>