<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An example of using the RabbitMQ Delayed Message Exchange in the Java Spring Framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post I want to show how to use deferred messages in RabbitMQ. As an example of a problem where it is convenient to use a delayed queue, I will...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An example of using the RabbitMQ Delayed Message Exchange in the Java Spring Framework</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/58c/aea/d97/58caead97ef0ce33afec4120ed5b8dff.png" alt="image" align="right">  In this post I want to show how to use deferred messages in RabbitMQ.  As an example of a problem where it is convenient to use a delayed queue, I will take the postback mechanism ( <i>s2s ping back</i> , <i>s2s pixel</i> ). <br><br><h4>  In a few words about the postback mechanism: </h4><br>  1. Some event occurs <br>  2. Your application must notify this event of a third-party service. <br>  3. If the third-party service was unavailable, then you need to repeat the notification again in a few minutes <br><br>  For re-notification, I will use a pending queue. <br><a name="habracut"></a><br>  RabbitMQ by default does not know how to delay messages, they are delivered immediately after publication.  The deferred delivery functionality is available as a <a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">rabbitmq-delayed-message-exchange</a> plugin. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Just want to note that the plugin is <b>experimental</b> .  Despite the fact that it is generally quite stable, it should be used in production at your own peril and risk. <br><br><h3>  Build a Docker Container with RMQ and Plugin </h3><br>  I will take the official image with the <a href="https://www.rabbitmq.com/management.html">management plugin</a> as a basis, useful for testing. <br><br>  Dockerfile: <br><br><pre><code class="hljs sql">FROM rabbitmq:3.6-management RUN apt-get <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -y curl RUN curl <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>://www.rabbitmq.com/community-plugins/v3<span class="hljs-number"><span class="hljs-number">.6</span></span>.x/rabbitmq_delayed_message_exchange<span class="hljs-number"><span class="hljs-number">-0.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>.ez &gt; $RABBITMQ_HOME/plugins/rabbitmq_delayed_message_exchange<span class="hljs-number"><span class="hljs-number">-0.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>.ez RUN rabbitmq-plugins <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-comment"><span class="hljs-comment">--offline rabbitmq_delayed_message_exchange</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Assembly</b> <div class="spoiler_text"><pre> <code class="bash hljs">docker build --tag=x25/rmq-delayed-message-exchange .</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Launch</b> <div class="spoiler_text"><pre> <code class="bash hljs">docker run -d --name rmq -p 5672:5672 -p 15672:15672 x25/rmq-delayed-message-exchange</code> </pre> </div></div><br><h3>  Spring AMQP </h3><br>  <b>The Spring Framework</b> fully supports the plugin in the <code>pring-rabbit</code> project.  Starting from version 1.6.4, you can use both xml / bean configurations and annotations. <br><br>  I will use the Spring Boot Amqp Starter. <br><br><div class="spoiler">  <b class="spoiler_title">Dependency for Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-amqp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Dependency for Gradle</b> <div class="spoiler_text"><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">compile</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">org</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.springframework</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.boot</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:spring-boot-starter-amqp"</span></span></code> </pre> </div></div><br><h3>  Configuration through annotations </h3><br>  When using bootstrappers and annotations, Spring takes over the majority of the work.  Just write: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(bindings = <span class="hljs-meta"><span class="hljs-meta">@QueueBinding</span></span>(value = <span class="hljs-meta"><span class="hljs-meta">@Queue</span></span>(value = DELAY_QUEUE_NAME), exchange = <span class="hljs-meta"><span class="hljs-meta">@Exchange</span></span>(value = DELAY_EXCHANGE_NAME, delayed = <span class="hljs-string"><span class="hljs-string">"true"</span></span>), key = DELAY_QUEUE_NAME)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message&lt;?&gt; message)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... }</span></span></code> </pre> <br>  And when the application is launched, RabbitAdmin will automatically declare a <code>delayed exchange</code> , <code>queue</code> , create event handlers and bind them to the annotated method. <br><br>  Need more threads to process messages?  This is configured through the external configuration file (the <b>spring.rabbitmq.listener.concurrency</b> property) or through the <b>containerFactory</b> parameter of the annotation: <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// : @Configuration public class RabbitConfiguration { @Bean(name = "containerFactory") @Autowired public SimpleRabbitListenerContainerFactory containerFactory(ConnectionFactory connectionFactory) { SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); factory.setConcurrentConsumers(10); factory.setPrefetchCount(30); return factory; } } // : @RabbitListener(containerFactory = "containerFactory", ...)</span></span></code> </pre> </div></div><br>  To send a deferred message, use RabbitTemplate: <br><br><pre> <code class="java hljs">rabbitTemplate.send( DELAY_EXCHANGE_NAME, DELAY_QUEUE_NAME, MessageBuilder .withBody(data) .setHeader(<span class="hljs-string"><span class="hljs-string">"x-delay"</span></span>, MESSAGE_DELAY_MS).build() );</code> </pre> <br>  It will be sent instantly, but will be delivered with a delay specified in the <code>x-delay</code> header.  The maximum allowed delay time (2 ^ 32-1) ms. <br><br>  Ready sample application: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = LoggerFactory.getLogger(Application.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String DELAY_QUEUE_NAME = <span class="hljs-string"><span class="hljs-string">"delayed.queue"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String DELAY_EXCHANGE_NAME = <span class="hljs-string"><span class="hljs-string">"delayed.exchange"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String DELAY_HEADER = <span class="hljs-string"><span class="hljs-string">"x-delay"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> String NUM_ATTEMPT_HEADER = <span class="hljs-string"><span class="hljs-string">"x-num-attempt"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> RETRY_BACKOFF = <span class="hljs-number"><span class="hljs-number">5000</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RabbitTemplate rabbitTemplate; <span class="hljs-meta"><span class="hljs-meta">@RabbitListener</span></span>(bindings = <span class="hljs-meta"><span class="hljs-meta">@QueueBinding</span></span>(value = <span class="hljs-meta"><span class="hljs-meta">@Queue</span></span>(value = DELAY_QUEUE_NAME), exchange = <span class="hljs-meta"><span class="hljs-meta">@Exchange</span></span>(value = DELAY_EXCHANGE_NAME, delayed = <span class="hljs-string"><span class="hljs-string">"true"</span></span>), key = DELAY_QUEUE_NAME)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[]&gt; message)</span></span></span><span class="hljs-function"> </span></span>{ String endpointUrl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(message.getPayload()); Long numAttempt = (Long) message.getHeaders().getOrDefault(NUM_ATTEMPT_HEADER, <span class="hljs-number"><span class="hljs-number">1L</span></span>); log.info(<span class="hljs-string"><span class="hljs-string">"Message received, url={}, attempt={}"</span></span>, endpointUrl, numAttempt); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!doNotifyEndpoint(endpointUrl) &amp;&amp; numAttempt &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { rabbitTemplate.send( DELAY_EXCHANGE_NAME, DELAY_QUEUE_NAME, MessageBuilder .withBody(message.getPayload()) .setHeader(DELAY_HEADER, numAttempt * RETRY_BACKOFF) .setHeader(NUM_ATTEMPT_HEADER, numAttempt + <span class="hljs-number"><span class="hljs-number">1</span></span>) .build() ); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNotifyEndpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String url)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { HttpURLConnection connection = (HttpURLConnection) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(url).openConnection(); <span class="hljs-comment"><span class="hljs-comment">/* @todo: set up connection timeouts */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (connection.getResponseCode() == <span class="hljs-number"><span class="hljs-number">200</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { log.error(e.getMessage()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(Application.class, args); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">application.yml</b> <div class="spoiler_text"><pre> <code class="hljs cs">spring: rabbitmq: host: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port: <span class="hljs-number"><span class="hljs-number">5672</span></span> username: guest password: guest <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>-host: / listener: prefetch: <span class="hljs-number"><span class="hljs-number">10</span></span> concurrency: <span class="hljs-number"><span class="hljs-number">50</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">build.gradle</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">buildscript { repositories { mavenCentral() } dependencies { classpath("org.springframework.boot:spring-boot-gradle-plugin:1.4.2.RELEASE") } } apply plugin: <span class="hljs-string"><span class="hljs-string">'java'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'eclipse'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'idea'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'org.springframework.boot'</span></span> jar { baseName = <span class="hljs-string"><span class="hljs-string">'rmq-delayed-demo'</span></span> version = <span class="hljs-string"><span class="hljs-string">'0.1.0'</span></span> } repositories { mavenCentral() } sourceCompatibility = <span class="hljs-number"><span class="hljs-number">1.8</span></span> targetCompatibility = <span class="hljs-number"><span class="hljs-number">1.8</span></span> dependencies { compile("org.springframework.boot:spring-boot-starter-amqp") testCompile("org.springframework.boot:spring-boot-starter-test") }</code> </pre> </div></div><br>  We check the delayed delivery through the control panel (rmq-management), it is available on port <b>15672</b> : <br><br><img src="https://i.gyazo.com/74a810210df2662a9e2968c2db9febe0.png" alt="image"><br><br>  Logs: <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">25.927</span></span>: Message received, url=http://localhost:<span class="hljs-number"><span class="hljs-number">1234</span></span>, attempt=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">25.941</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span> refused (<span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span> refused) <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">30.946</span></span>: Message received, url=http://localhost:<span class="hljs-number"><span class="hljs-number">1234</span></span>, attempt=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">30.951</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span> refused (<span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span> refused) <span class="hljs-number"><span class="hljs-number">2016</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span><span class="hljs-number"><span class="hljs-number">-21</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span>:<span class="hljs-number"><span class="hljs-number">40.954</span></span>: Message received, url=http://localhost:<span class="hljs-number"><span class="hljs-number">1234</span></span>, attempt=<span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre> <br><h3>  Configuration via XML </h3><br>  When using XML configurations, you just need to set the <code>delayed</code> property to <code>true</code> in the exchange-bean and RabbitAdmin does the rest for you. <br><br><div class="spoiler">  <b class="spoiler_title">Sample xml configuration in conjunction with the Integration Framework</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:int</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/integration"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:int-amqp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/integration/amqp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:rabbit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/rabbit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/integration/amqp http://www.springframework.org/schema/integration/amqp/spring-integration-amqp.xsd http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd http://www.springframework.org/schema/rabbit http://www.springframework.org/schema/rabbit/spring-rabbit.xsd http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int:channel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"to-delayed-rmq"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int-amqp:outbound-channel-adapter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">channel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"to-delayed-rmq"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">amqp-template</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rabbitTemplate"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">exchange-name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"delayed.exchange"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routing-key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"delayed.binding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mapped-request-headers</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"x-delay"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int-amqp:inbound-channel-adapter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">channel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"from-delayed-rmq-queue"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">queue-names</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"delayed.queue"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message-converter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"amqpMessageConverter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">connection-factory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"rabbitConnectionFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">concurrent-consumers</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">prefetch-count</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int:service-activator</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">input-channel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"from-delayed-rmq-queue"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onMessage"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"postbackServiceActivator"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PostbackServiceActivator"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">int:service-activator</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rabbit:queue</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"delayed.queue"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rabbit:direct-exchange</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"delayed.exchange"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">delayed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rabbit:bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rabbit:binding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">queue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"delayed.queue"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"delayed.binding"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rabbit:bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rabbit:direct-exchange</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3>  useful links </h3><br><ul><li>  <a href="http://docs.spring.io/spring-amqp/reference/html/_reference.html">Official documentation</a> </li><li>  <a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">Plugin page</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/318118/">https://habr.com/ru/post/318118/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318104/index.html">Elixir in bioinformatics</a></li>
<li><a href="../318106/index.html">Intercepting Linux system calls using LSM</a></li>
<li><a href="../318110/index.html">SPI Flash Programming with Arduino and SD Card</a></li>
<li><a href="../318112/index.html">How IT professionals work. Ilya Kosmodemyansky, PostgreSQL-Consulting LLC</a></li>
<li><a href="../318116/index.html">Three more online Mail.Ru Group courses in open mode</a></li>
<li><a href="../318120/index.html">Generating dummy data with Mimesis: Part I</a></li>
<li><a href="../318122/index.html">Underhanded Rust 2016 competition</a></li>
<li><a href="../318126/index.html">Experience with hacked server</a></li>
<li><a href="../318128/index.html">DevOps tools: What SaltStack is good for, and what tasks can be solved with it</a></li>
<li><a href="../318130/index.html">Top 10 key announcements from Microsoft in 2016</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>