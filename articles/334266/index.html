<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Applications for Tarantool. Part 1. Stored procedures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Today I want to share with you the experience of writing applications for Tarantool 1.7. This series of articles will be useful to those who...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Applications for Tarantool. Part 1. Stored procedures</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  Today I want to share with you the experience of writing applications for Tarantool 1.7.  This series of articles will be useful to those who are already going to use Tarantool in their projects, or to those who are looking for a new solution to optimize projects. </p><br><p>  The whole cycle is devoted to the consideration of an existing application on Tarantool.  This part will describe the installation of Tarantool, data storage and access to them, as well as some tricks of writing stored procedures. </p><br><p>  Tarantool is a NoSQL database that stores data in memory or on disk (depending on the storage subsystem).  The storage is persistent due to the well thought-out write ahead log mechanism.  LuaJIT (Just-In-Time Compiler) is built into Tarantool, allowing you to execute Lua code.  You can also write stored procedures in C. </p><br><p><img src="https://habrastorage.org/web/6bc/a42/ca2/6bca42ca2fc74d00923ad3348e4cdb09.png" alt="image"></p><a name="habracut"></a><br><h2 id="soderzhanie-cikla-prilozheniya-dlya-tarantool">  Content of the cycle ‚ÄúApplications for Tarantool‚Äù </h2><br><p>  - <a href="https://habrahabr.ru/company/mailru/blog/334266/">Part 1. Stored procedures</a> <br>  - <a href="https://habrahabr.ru/company/mailru/blog/336648/">Part 2. OAuth2 authentication</a> <br>  - <a href="https://habr.com/company/mailru/blog/358706/">Part 3. Testing and running.</a> </p><br><h2 id="zachem-sozdavat-svoi-prilozheniya-dlya-tarantool">  Why build your apps for Tarantool </h2><br><p>  There are two reasons: </p><br><ol><li>  <strong>This will speed up the service.</strong>  Data processing on the storage side reduces the amount of data transferred, and combining multiple requests into one stored procedure will save on network delays. </li><li>  <strong>Ready applications can be reused</strong> .  Now the Tarantool ecosystem is actively developing, there are new opensource applications on Tarantool, some of which are eventually transferred to Tarantool itself.  Such modules allow you to create new services faster. </li></ol><br><p>  Of course, this approach has its drawbacks.  Tarantool cannot utilize all the multi-core processor resources, so to scale up the service, you will have to take care of sharding the storage, as well as the appropriate project architecture.  However, with an increase in the number of requests, this approach will allow for easy scaling of the load. </p><br><p>  Consider how one of the Tarantool apps was created.  It implements an API for registering and authenticating users.  Application functionality: </p><br><ul><li>  registration and authentication by email in two stages: creating an account, confirming an account with a password; </li><li>  registration through social networks (FB, VK, Google+); </li><li>  the ability to recover a password. </li></ul><br><p>  As an example of writing a stored procedure Tarantool, we analyze the first stage of registration by email - obtaining a confirmation code.  To revive the examples, you can use the source code, which <a href="https://github.com/mailru/tarantool-authman">is available on github</a> . </p><br><p>  Go! </p><br><h2 id="ustanovka-tarantool">  Tarantool installation </h2><br><p>  Read how to install Tarantool <a href="https://tarantool.org/download.html">in the documentation</a> .  For example, for Ubuntu you need to run in a terminal: </p><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> http://download.tarantool.org/tarantool/1.7/gpgkey | sudo apt-key add - release=`lsb_release -c -s` sudo apt-get -y install apt-transport-https sudo rm -f /etc/apt/sources.list.d/*tarantool<span class="hljs-regexp"><span class="hljs-regexp">*.list</span></span> sudo tee /etc/apt/sources.list.d/tarantool_1_7.list &lt;&lt;- EOF deb http://download.tarantool.org/tarantool/1.7/ubuntu/ <span class="hljs-variable"><span class="hljs-variable">$release</span></span> main deb-src http://download.tarantool.org/tarantool/1.7/ubuntu/ <span class="hljs-variable"><span class="hljs-variable">$release</span></span> main EOF sudo apt-get update sudo apt-get -y install tarantool</code> </pre> <br><p>  We will verify that the installation was successful by calling tarantool in the console and starting the interactive mode. </p><br><pre> <code class="hljs pgsql">$ tarantool <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.7</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">-202</span></span>-gfe0a67c <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-string"><span class="hljs-string">'help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> interactive help tarantool&gt;</code> </pre> <br><p>  Here you can try your hand at programming on Lua. <br>  If there is no strength, then gather them <a href="http://tylerneylon.com/a/learn-lua/">in this small tutorial</a> . </p><br><h2 id="registraciya-po-email">  Register by email </h2><br><p>  Go ahead.  Let's write the first script, allowing to create space (space) with users.  Space is an analogue of tables for data storage.  The data itself is stored as a tuple.  Space should contain one primary (primary) index, it can also have several secondary (secondary) indices.  An index can be one key or several at once.  Tuple is an array in which records are stored.  Consider the scheme of space authentication service: </p><br><p><img src="https://habrastorage.org/web/7b7/387/2de/7b73872de7b0408da6885e35503a3e5e.png" alt="image"></p><br><p>  As can be seen from the diagram, we use two types of indices: hash and tree.  Hash-index allows you to find tuples by the complete coincidence of the primary key and must be unique.  The tree-index supports non-unique keys, search by the first part of the composite index and allows you to optimize the sorting operations by key, since the values ‚Äã‚Äãin the index are stored in an orderly manner. </p><br><p>  The space session holds the key (session_secret) that the session cookie is signed with.  Keeping session keys allows users to log on to the service side, if needed.  Session has an optional link to space social.  This is necessary to validate the sessions of users entering through social networks (checking the validity of the stored OAuth2-token). </p><br><p>  Let's move on to writing an application.  To begin, consider the structure of the future project: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tarantool-authman</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">authman</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">model</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">password</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">password_token</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">session</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">social</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">user</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">utils</span></span> ‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">utils</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">db</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">init</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">response</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">validator</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">test</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">case</span></span> ‚îÇ ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">auth</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îÇ ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">registration</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">authman</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.test</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span></code> </pre> <br><p>  Modules in Lua are imported from the paths specified in the package.path variable. <br>  In our case, the modules are imported relative to the current directory, i.e. tarantool-authman.  However, if necessary, the import path can be supplemented: </p><br><pre> <code class="hljs scala">lua --        (  ) <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>.path = <span class="hljs-string"><span class="hljs-string">"/some/other/path/?.lua;"</span></span> .. <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>.path</code> </pre> <br><p>  Before we create the first space, we will render the necessary constants in the model.  Each space and each index must define its name.  It is also necessary to determine the storage order of the fields in the tuple.  This is the model of user authman / model / user.lua: </p><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--   ‚Äî  Lua- local user = {} --     ‚Äî model,         --          lua- function user.model(config) local model = {} --     model.SPACE_NAME = 'auth_user' model.PRIMARY_INDEX = 'primary' model.EMAIL_INDEX = 'email_index' --      (tuple) --    Lua   1 (!) model.ID = 1 model.EMAIL = 2 model.TYPE = 3 model.IS_ACTIVE = 4 --  : email-    model.COMMON_TYPE = 1 model.SOCIAL_TYPE = 2 return model end --   return user</span></span></code> </pre> <br><p>  In the case of users, we need two indexes.  Unique by id and non-unique by email, since, by registering via social networks, two different users can receive the same email or not receive email at all.  The uniqueness of email for users who have not registered through social networks, will provide the application logic. </p><br><p>  The authman / db.lua module contains a method for creating spaces: </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> db = {} <span class="hljs-comment"><span class="hljs-comment">--      model --     config  nil ‚Äî   local user = require('authman.model.user').model() --   db,   (space)   function db.create_database() local user_space = box.schema.space.create(user.SPACE_NAME, { if_not_exists = true }) user_space:create_index(user.PRIMARY_INDEX, { type = 'hash', parts = {user.ID, 'string'}, if_not_exists = true }) user_space:create_index(user.EMAIL_INDEX, { type = 'tree', unique = false, parts = {user.EMAIL, 'string', user.TYPE, 'unsigned'}, if_not_exists = true }) end return db</span></span></code> </pre> <br><p>  We take uuid as the user id, the hash index type, we look for a complete match.  The index for email search consists of two parts: (user.EMAIL, 'string') - email, (user.TYPE, 'unsigned') - user type.  Types were previously defined in the model.  The composite index allows you to search not only for all fields, but also for the first part of the index, so you can search only by email (without the user type). </p><br><p>  Now we will launch the interactive console Tarantool in the directory with the project and try using the authman / db.lua module. </p><br><pre> <code class="hljs pgsql">$ tarantool <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">1.7</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">-202</span></span>-gfe0a67c <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-string"><span class="hljs-string">'help'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> interactive help tarantool&gt; db = require(<span class="hljs-string"><span class="hljs-string">'authman.db'</span></span>) tarantool&gt; <span class="hljs-type"><span class="hljs-type">box</span></span>.cfg({<span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>=<span class="hljs-number"><span class="hljs-number">3331</span></span>}) tarantool&gt; db.create_database()</code> </pre> <br><p>  Great, the first space is created!  Warning: before accessing box.schema.space.create, you must configure and start the server using the box.cfg method.  Now consider a few simple actions inside the created space: </p><br><pre> <code class="hljs scala">--   tarantool&gt; box.space.auth_user:insert({<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>}) --- - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] ... tarantool&gt; box.space.auth_user:insert({<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>}) --- - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] ... --  <span class="hljs-type"><span class="hljs-type">Lua</span></span>- ()   tarantool&gt; box.space.auth_user:select() --- - - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] ... --      tarantool&gt; box.space.auth_user:get({<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1'}) --- - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_1</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] ... --      tarantool&gt; box.space.auth_user.index.email_index:select({<span class="hljs-symbol"><span class="hljs-symbol">'exaple_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>}) --- - - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>2', <span class="hljs-symbol"><span class="hljs-symbol">'exaple_2</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] ... --       tarantool&gt; box.space.auth_user:update(<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', {{'=', <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'new_email</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru'}, }) --- - [<span class="hljs-symbol"><span class="hljs-symbol">'user_id_</span></span>1', <span class="hljs-symbol"><span class="hljs-symbol">'new_email</span></span><span class="hljs-meta"><span class="hljs-meta">@mail</span></span>.ru', <span class="hljs-number"><span class="hljs-number">1</span></span>] ...</code> </pre> <br><p>  Unique indexes limit the insertion of non-unique values.  If you need to create records that may already be in space, use the operation upsert (update / insert).  A complete list of available methods can be found <a href="https://tarantool.org/doc/1.7/book/box/box_space.html">in the documentation</a> . </p><br><p>  Update the user model by adding functionality that allows us to register it: </p><br><pre> <code class="lua hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model.get_space</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> box.space[model.SPACE_NAME] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">model.get_by_email</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(email, type)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> validator.not_empty_string(email) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model.get_space().index[model.EMAIL_INDEX]:<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>({email, <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>})[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">--   -- ,     ,  function model.create(user_tuple) local user_id = uuid.str() local email = validator.string(user_tuple[model.EMAIL]) and user_tuple[model.EMAIL] or '' return model.get_space():insert{ user_id, email, user_tuple[model.TYPE], user_tuple[model.IS_ACTIVE], user_tuple[model.PROFILE] } end --  ,    ,     --  ,    GET-   -- activation_secret ‚Äî        function model.generate_activation_code(user_id) return digest.md5_hex(string.format('%s.%s', config.activation_secret, user_id)) end</span></span></code> </pre> <br><p>  In the above code snippet, two standard Tarantool modules, uuid and digest, are used, as well as one custom module, the validator.  Before use, they must be imported: </p><br><pre> <code class="lua hljs"><span class="hljs-comment"><span class="hljs-comment">--   Tarantool local digest = require('digest') local uuid = require('uuid') --    (   ) local validator = require('authman.validator')</span></span></code> </pre> <br><p>  Variables are declared with the local operator, which limits the scope of the variable to the current block.  Otherwise, the variable will be global, which should be avoided due to a possible name conflict. </p><br><p>  And now let's create the main authman / init.lua module.  In this module all api application methods will be collected. </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> auth = {} <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> response = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.response'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.error'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> validator = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.validator'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> db = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.db'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> utils = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman.utils.utils'</span></span>) <span class="hljs-comment"><span class="hljs-comment">--     ‚Äî api,       function auth.api(config) local api = {} --  validator      --       config = validator.config(config) --       local user = require('authman.model.user').model(config) --  space db.create_database() --  api         function api.registration(email) --    email ‚Äî      email = utils.lower(email) if not validator.email(email) then return response.error(error.INVALID_PARAMS) end -- ,       email local user_tuple = user.get_by_email(email, user.COMMON_TYPE) if user_tuple ~= nil then if user_tuple[user.IS_ACTIVE] then return response.error(error.USER_ALREADY_EXISTS) else local code = user.generate_activation_code(user_tuple[user.ID]) return response.ok(code) end end --    space user_tuple = user.create({ [user.EMAIL] = email, [user.TYPE] = user.COMMON_TYPE, [user.IS_ACTIVE] = false, }) local code = user.generate_activation_code(user_tuple[user.ID]) return response.ok(code) end return api end return auth</span></span></code> </pre> <br><p>  Fine!  Now users can create accounts. </p><br><pre> <code class="hljs lua">tarantool&gt; auth = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'authman'</span></span>).api(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>) <span class="hljs-comment"><span class="hljs-comment">--  api     tarantool&gt; ok, code = auth.registration('example@mail.ru') --       email    tarantool&gt; code 022c1ff1f0b171e51cb6c6e32aefd6ab</span></span></code> </pre> <br><p>  That's all.  In the next part, we will look at using ready-made modules, networking and the implementation of OAuth2 in tarantool-authman. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/334266/">https://habr.com/ru/post/334266/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334256/index.html">Planning Poker: how to make the task setting process as transparent and clear as possible</a></li>
<li><a href="../334258/index.html">Release of the openSUSE 42.3 Linux distribution</a></li>
<li><a href="../334260/index.html">VESNIN Server: First Disk Subsystem Tests</a></li>
<li><a href="../334262/index.html">Unexpected Kotlin poll results: a small investigation</a></li>
<li><a href="../334264/index.html">We read, listen, use. Guide on the sources for the development of Android-developer</a></li>
<li><a href="../334268/index.html">Terrible recruiter, terrible candidate</a></li>
<li><a href="../334270/index.html">Automate CI / CD for Java applications using Microsoft Visual Studio Team Services</a></li>
<li><a href="../334274/index.html">If there is no difference between the two code options, choose the one that is easier to debug.</a></li>
<li><a href="../334276/index.html">Zabbix + RocksDB - migration and first impressions</a></li>
<li><a href="../334278/index.html">A bit about SSL certificates: How to choose and how to get</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>