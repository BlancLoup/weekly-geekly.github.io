<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Generators in action</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Small introduction 
 Not so long ago, I decided for myself that it was time to fill a large gap in knowledge and decided to read about transitions bet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Generators in action</h1><div class="post__text post__text-html js-mediator-article"><h4>  Small introduction </h4><br>  Not so long ago, I decided for myself that it was time to fill a large gap in knowledge and decided to read about transitions between versions of PHP, because  I realized that I was somewhere between 5.2 and 5.3, and this gap needs to be somehow eliminated.  Before that, I read about namespaces, traits, etc., but did not go further than reading.  And here I noticed the generators, read the documentation, one of the <a href="http://habrahabr.ru/post/147885/">articles on</a> this topic and after that the thought arose - how did they live without them before? <br><br>  With this translation I want to help at least the beginners, because on php.net the documentation on the generators is in English and, in my opinion, does not properly disclose the whole idea and places of use.  There is a lot of text, a bit less code, no pictures.  General knowledge is required, for example, about iterators.  I will not comment on the obvious code, but I will try to explain examples that are difficult to understand by virtue of my knowledge. <br><br>  <b>UPD1</b> : Changed vague wording, which was discussed in the comments. <br>  <b>UPD2</b> : Added a solution with a forced break. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  Theory </h4><br>  I‚Äôll say the main thing right away - the generators will in no way allow to do something new, which could not be done earlier, because there are no generators before PHP 5.5.  This is just a new feature that somewhat changes the usual behavior of the language.  Wherever generators are used, iterators can also be used.  Now, knowing this, let's take a look at an example.  Let's say we need to go through the lines in the file.  In procedural style, you can do it something like this: <br><br><pre><code class="php hljs">$f = fopen($file, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($line = fgets($f)) { doSomethingWithLine($line); }</code> </pre> <br><br>  This is the usual decision, there is nothing strange here.  But what if we need something more abstract?  Say, generate strings from an abstract source.  Yes, today it may be a file, but tomorrow we will decide that a better solution would be a database or something else. <br><br>  Now we have two ways to solve this problem - we can return an array or an iterator.  But returning an array has several problems: firstly, we don‚Äôt know how much memory we need (all of a sudden we have a 30 GB file?), And secondly, we may not be able to describe our source as an array at all (for example, we can return endless chunks of data and try to guess when this stream will end, if you are a client). <br><br>  So, there are <a href="http://www.php.net/manual/ru/class.iterator.php">iterators</a> .  Our example is very simple to describe through an iterator.  Moreover, PHP already has a ready class for this - <a href="http://php.net/manual/ru/class.splfileobject.php">SPLFileObject</a> .  But let's leave it and write something of our own. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileIterator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $f; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f = fopen($file, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fgets(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">key</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ftell(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rewind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ fseek(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">valid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !feof(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f); } }</code> </pre><br><br>  Quite easy, right?  Well, not really, but already something.  Although if we take a closer look at the example, we will see that we have not quite accurately described the iterator, since double calling the current () method will not give us the expected result in the form of the same value. <br>  I (the author of the article, not a ‚Äútranslator‚Äù) did this specifically to show that replacing a procedure with an iterator is not always an easy task, because in real situations everything is much more complicated.  Let's do the right iterator for our file. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileIterator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $f; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $data; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $key; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f = fopen($file, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__destruct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ fclose(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">key</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;key; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = fgets(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;key++; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rewind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ fseek(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data = fgets(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;f); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;key = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">valid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> !== <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;data; } }</code> </pre><br><br>  God, there are so many things for a seemingly simple task, such as traversing a file, and the main work is still hidden inside the file functions.  Now, imagine what we need to do to implement a more complex algorithm.  If you continue the current approach, it may become even more difficult and understand its work will be more difficult.  Let's solve our problem with the help of generators. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLines</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($file)</span></span></span><span class="hljs-function"> </span></span>{ $f = fopen($file, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$f) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($line = fgets($f)) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $line; } fclose($f); }</code> </pre><br><br>  Much easier!  Yes, this is almost like the first example with a function, only an exception and the keyword yield appear. <br><br><h4>  So how does it work? </h4><br>  It is very important to understand that in the example above the return value of the function changes.  This is not null, as it may seem at first glance.  The presence of a yield suggests that PHP will return us a special class - the generator.  The generator behaves in the same way as the iterator, because it implements it.  And you can use the generator in the same way as iterators. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (getLines(<span class="hljs-string"><span class="hljs-string">"someFile"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $line) { doSomethingWithLine($line); }</code> </pre><br><br>  The whole point here is that we can write the code in any way and just throw it away ( <a href="http://translate.google.ru/translate_t%3Fq%3Dyield">yield</a> , yeldnut, yeldanut ... I don‚Äôt know how to translate more correctly when there are throwing exceptions) each time a new value when we need it.  So how does it work?  When we call the getLines () function, PHP will execute the code before the first meeting of the yield keyword, in which it will remember this value and return the generator.  Then, there will be a call to the next () method of the generator (which is described by us or an iterator), PHP will execute the code again, only start it not from the very beginning, but starting from the last value that we safely threw and forgot about it, and again, until next yield or end of function, or return.  Knowing this algorithm, now you can make a useful generator: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doStuff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $last = <span class="hljs-number"><span class="hljs-number">0</span></span>; $current = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { $current = $last + $current; $last = $current - $last; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $current; } }</code> </pre><br><br>  Perhaps at first glance it is not entirely clear what it is, and indeed an endless cycle will ruin everything.  Yes, this function will work as an infinite loop.  But look closer - these are Fibonacci numbers. <br><br>  It should be noted that generators are not a replacement for iterators.  This is just an easy way to get them.  Iterators are still a powerful tool. <br><br><h4>  Difficult example </h4><br>  We need to make our own <a href="http://php.net/manual/ru/class.arrayobject.php">ArrayObject</a> .  Instead of doing an iterator, let's do a little trick with the generator.  The <a href="http://www.php.net/manual/ru/class.iteratoraggregate.php">IteratorAggregate</a> interface requires only one method from us ‚Äî getIterator ().  Since the generator returns an object that implements an iterator, we can override this method so that it returns the generator.  It's simple: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ArrayObject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IteratorAggregate</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $array; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $array)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;array = $array; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;array <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $key =&gt; $value; } } }</code> </pre><br><br>  Exactly!  Now we can iterate over all the properties of our array through a generator or through the usual syntax of addressing by key. <br><br><h4>  Send data back </h4><br>  Generators allow you to send data using the send () method.  In some cases it can be very convenient.  For example, when you need to make some kind of log file.  Instead of writing a whole class for it, you can simply use the generators: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createLog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($file)</span></span></span><span class="hljs-function"> </span></span>{ $f = fopen($file, <span class="hljs-string"><span class="hljs-string">'a'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment"># ,   ; $line = yield; #  ""  send()     $line; fwrite($f, $line); } } $log = createLog($file); $log-&gt;send("First"); $log-&gt;send("Second"); $log-&gt;send("Third");</span></span></code> </pre><br><br>  Pretty quick and easy.  In order to complicate the task a bit, let's see an example where functions work together, transferring control among themselves using generators.  We need to build a queue that receives and sends data packets.  Sometimes such tasks appear when we read a binary stream and need to control the size of the package. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchBytesFromFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($file)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">#   ,        $length = yield; #     $f = fopen($file, 'r'); while (!feof($f)) { #     $length = yield fread($f, $length); #    } yield false; } function processBytesInBatch(Generator $byteGenerator) { $buffer = ''; $bytesNeeded = 1000; while ($buffer .= $byteGenerator-&gt;send($bytesNeeded)) { #      // ,      list($lengthOfRecord) = unpack('N', $buffer); if (strlen($buffer) &lt; $lengthOfRecord) { $bytesNeeded = $lengthOfRecord - strlen($buffer); continue; } yield substr($buffer, 1, $lengthOfRecord); $buffer = substr($buffer, 0, $lengthOfRecord + 1); $bytesNeeded = 1000 - strlen($buffer); } } $gen = processBytesInBatch(fetchBytesFromFile($file)); foreach ($gen as $record) { doSomethingWithRecord($record); }</span></span></code> </pre><br><br>  A bit difficult, but I hope you understand how it works.  We divided the processing and retrieval of data of a certain size at the right time + the possibility of re-using the code remains. <br><br><h4>  Need more examples! </h4><br>  In general, generators can be used in many tasks.  One of them is flow simulation.  First, we define each stream as a generator.  Then we throw out the control signal to the parent so that he can transmit the signal to work to the next thread.  Let's build such a system that works with different data sources (working with non-blocking I / O).  Here is an example of such a system: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">step1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $f = fopen(<span class="hljs-string"><span class="hljs-string">"file.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($line = fgets($f)) { processLine($line); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">step2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $f = fopen(<span class="hljs-string"><span class="hljs-string">"file2.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($line = fgets($f)) { processLine($line); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">step3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $f = fsockopen(<span class="hljs-string"><span class="hljs-string">"www.example.com"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>); stream_set_blocking($f, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); $headers = <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1\r\n"</span></span>; $headers .= <span class="hljs-string"><span class="hljs-string">"Host: www.example.com\r\n"</span></span>; $headers .= <span class="hljs-string"><span class="hljs-string">"Connection: Close\r\n\r\n"</span></span>; fwrite($f, $headers); $body = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($f)) { $body .= fread($f, <span class="hljs-number"><span class="hljs-number">8192</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } processBody($body); } <span class="hljs-comment"><span class="hljs-comment">// 3  (step)    -  true,    ,     function runner(array $steps) { while (true) { #   ,     foreach ($steps as $key =&gt; $step) { $step-&gt;next(); #        yield if (!$step-&gt;valid()) { # ,      ()  unset($steps[$key]); } } if (empty($steps)) return; #    -   } } runner(array(step1(), step2(), step3()));</span></span></code> </pre><br><br><h4>  Conclusion </h4><br>  Generators are VERY powerful stuff.  They allow you to greatly simplify the code.  Just think, you can write a function for a range of numbers in one line of code: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">xrange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($min, $max)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = $min; $i &lt; $max; $i++) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $i; }</code> </pre><br><br>  Short and simple.  Easy to read, easy to understand how it works and very productive - faster than with an iterator. <br><br>  Original article - Anthony Ferrara @ <a href="http://blog.ircmaxell.com/2012/07/what-generators-can-do-for-you.html">blog.ircmaxell.com</a> <br><br>  A popular question arose in the comments about what to do when the generator (or rather, brute force through foreach) forcibly ends its work, for example, through break.  In this case, if we are dealing with file enumeration, as in the first example, then there is a risk that fclose will never work, since the generator simply ‚Äúforgets‚Äù about it.  One of the most correct solutions was suggested by <a href="http://habrahabr.ru/users/weirdan/" class="user_link">weirdan</a> ( <a href="http://habrahabr.ru/post/189796/">#</a> ) - use the try {...} finally {...} construction, where in the finally block we clear open resources.  This block will <b>always</b> work when the generator iterates through, but there is a small nuance: if the generator iteration went through completely (without break) normally, then the code after the finally block will be executed. <br><br><h4>  Briefly about generators </h4><br>  - Do not add new functionality to the language <br>  - Faster * <br>  - Resumption of generator operation occurs from the last ‚Äúrelease‚Äù yield <br>  - Values ‚Äã‚Äãand exceptions can be sent to the generator (via the throw () method) <br>  - Generators are unidirectional, i.e.  can't go back <br>  - Less code in most cases, easier to understand designs <br><br>  * Based <a href="https://gist.github.com/nikic/2975796">on these results</a> . <br>  For large enumeration scales, generators are faster.  Approximately 4 times faster than iterators and 40% faster than normal iteration.  With a small number of elements it can be slower than the usual iteration, but still faster than iterators. <br><br>  If the community approves the translation and considers it good (and most importantly, it does not approve of nonsense and does not change the essence of the code), it will be interesting to me to translate other articles sometimes. <br>  I think it will not be superfluous to translate and put together articles published now on phpmaster about data structures. <br>  Also I will be glad to any comments, instructions, comments about errors in the text with the code, and in the translation itself. <br><br>  PS In the process of translation, the idea of ‚Äã‚Äãworking the buffer was lost in one of the examples and, in order not to confuse anyone, I decided to abstain from vague comments on the code.  I would be glad if someone confirms my guess and I will add a comment. </div><p>Source: <a href="https://habr.com/ru/post/189796/">https://habr.com/ru/post/189796/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189786/index.html">"Multithreading" WSH VBScript</a></li>
<li><a href="../189788/index.html">The basis of AI - the structure of the mind</a></li>
<li><a href="../18979/index.html">Cybersquatting: two sides of the same coin.</a></li>
<li><a href="../189792/index.html">Creating a simple bot for WoW, programming routes</a></li>
<li><a href="../189794/index.html">Creating Metaboxes in WordPress</a></li>
<li><a href="../189798/index.html">Hadoop Tutorial. Writing your grep</a></li>
<li><a href="../1898/index.html">British publisher releases free online gloss</a></li>
<li><a href="../18980/index.html">Pencil Holder - Flopcup</a></li>
<li><a href="../189802/index.html">Unreal LED, or load management from Unreal Tournament</a></li>
<li><a href="../189804/index.html">Recognition and conversion of subtitles from VOB to SRT format</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>