<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I reinvent the media center</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the acquisition of a new TV, the question arose of which prefix for it to take. Chromecast capabilities are not enough, and I wanted a full-fledg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I reinvent the media center</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/u5/u2/5u/u5u25uj8x94cbqwfcsbt6hfaasq.png" alt="Raspberry Pi 3 model B"></p><br><p>  With the acquisition of a new TV, the question arose of which prefix for it to take.  Chromecast capabilities are not enough, and I wanted a full-fledged media center at Kodi.  TV with SmartTV is not an option to buy - Kodi can only be installed on Android (from SmartTV platforms), and I treat it without much love, besides, it is already inside the TV, and not in a separate box that can be safely reflashed.  Well, why do I need a full-sized Android, with all its services and programs in a virtual machine, without a full-fledged GNU / Linux environment and, most likely, without updates?  For the same reason, numerous ready-made media centers on Android were also flagged, although the same prefix from Xiaomi is pretty good.  One would think about SmartTV on TizenOS, but for him there is no Kodi. <a name="habracut"></a></p><br><p>  With such requirements, and despite the fact that this is my first single-board computer, the choice is obvious - Raspberry Pi, and specifically I took the RPi 3 model B. </p><br><h2 id="ustanovka-i-predvaritelnaya-nastroyka-raspbian">  Raspbian Installation and Pre-Setup </h2><br><p>  As a Debian user, I immediately installed Raspbian and started playing with the new system.  You can record the downloaded system image using the <a href="https://etcher.io/">Etcher</a> program, or from the console: </p><br><p>  First, clear the contents of the card, filling in everything with zeros ... </p><br><pre><code class="bash hljs">sudo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/dev/zero of=/dev/mmcblk0 bs=512 count=2047</code> </pre> <br><p>  then write the image ... </p><br><pre> <code class="bash hljs">sudo dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=/path/to/raspbian.img of=/dev/mmcblk0</code> </pre> <br><p>  Running raspberry with raspbian is very easy to install Kodi - with a command </p><br><pre> <code class="bash hljs">sudo apt update &amp;&amp; sudo apt install kodi</code> </pre> <br><p>  For the media center to start when the raspberry is turned on, you need to add a line to the <em>/home/pi/.config/lxsession/LXDE-pi/autostart</em> file </p><br><pre> <code class="hljs scala"><span class="hljs-meta"><span class="hljs-meta">@kodi</span></span> -fs</code> </pre> <br><p>  Despite all the charm of the Raspberry Pi, it has one important drawback: with a sudden power outage, it is likely that only part of the data will be overwritten to the SD card, and therefore memory cards do not last long and, on average, fail after a year.  There are solutions on the market that solve this problem with the help of an additional energy source (for example, a capacitor).  Also, SD cards have a limited number of rewrite cycles and it is important to reduce the number of these same rewrites in order for the memory card to last longer. </p><br><h3 id="udalenie-nezhelatelnyh-programm">  Remove unwanted programs </h3><br><p>  I removed the <em>dphys-swapfile</em> to remove the swap file with the ends, which consumes the resource of the memory card, and also deleted different toys and completely unnecessary programs, at least for me. </p><br><pre> <code class="bash hljs">sudo apt purge dphys-swapfile wolfram-engine logrotate nodejs nodered minecraft-pi oracle-java8-jdk openjdk-7-jre oracle-java7-jdk openjdk-8-jre sudo apt autoremove --purge</code> </pre> <br><h3 id="zamena-menedzhera-logov">  Replacing the log manager </h3><br><p>  I also changed the service for recording logs: </p><br><pre> <code class="bash hljs">sudo apt install busybox-syslogd sudo dpkg --purge rsyslog</code> </pre> <br><p>  Now logs are written to the ring buffer located in RAM, you can watch them with the command <code>logread</code> </p><br><h3 id="uvelichenie-nadyozhnosti-pri-otklyuchenii-pitaniya">  Increased reliability when power is off </h3><br><p>  The most logical step is to make the partition with the system read-only, and then, by definition, there will be no problems with writing, because there will be no recording.  But Raspbian is a complete system that cannot work on a partition on which writing is completely prohibited.  At a <a href="https://petr.io/en/blog/2015/11/09/read-only-raspberry-pi-with-jessie/">minimum</a> , you need to remove <em>/ var / log</em> , <em>/ var / tmp</em> and <em>/ tmp</em> in <em>tmpfs</em> , i.e., store the contents of these folders in RAM.  But for practical use, you need to make <a href="http://hallard.me/raspberry-pi-read-only/">much more changes</a> . </p><br><p>  I decided to do it differently: create a multi-layered file system, where the basis stored on the memory card is kept as read-only, and all changes that are made in the system are stored in RAM.  Accordingly, all changes are reset when the power is turned off and do not harm anyone.  The approach is not new, it is often used in routers, for example, and using <em>overlayfs is</em> very easy to implement. </p><br><p>  A link to a similar <a href="http://blog.pi3g.com/2014/04/make-raspbian-system-read-only">solution using UnionFS</a> has already <a href="https://geektimes.ru/post/283802/">been</a> posted to Hyktimes, but since its publication, support for the <em>OverlayFS</em> file system developed by SUSE as a more progressive replacement for <em>UnionFS</em> and <em>AUFS has</em> been added to the Linux kernel, so the whole thing is configured a little differently. </p><br><p>  I found a <a href="https://gist.github.com/sbonfert/7044eced553ea5c5c2346bcde6bb12e7">script</a> that does exactly what I planned: the system partition on the memory card mounts in read-only mode, and all changes are saved in the upper layer, located in RAM.  By the way, this script also supports <em>AUFS</em> . </p><br><p>  Installation is quite simple: </p><br><ol><li><p>  Create a <em>root-ro</em> file in the <em>/ etc / initramfs-tools / scripts / init-bottom /</em> folder, in which we put the contents of the script </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/initramfs-tools/scripts/init-bottom &amp;&amp; sudo wget https://gist.github.com/sbonfert/7044eced553ea5c5c2346bcde6bb12e7/raw/7ef62bd5553faae1cb2d2eb79d84dde5197e8c56/root-ro</code> </pre> <br></li><li><p>  Change script access rights: </p><br><pre> <code class="bash hljs">sudo chmod 0755 /etc/initramfs-tools/scripts/init-bottom/root-ro</code> </pre> <br></li><li><p>  Add overlay to the list of modules that will be loaded into the <em>initramfs</em> </p><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"overlay"</span></span> &gt;&gt; /etc/initramfs-tools/modules</code> </pre> <br></li><li><p>  Re-create the <em>initramfs</em> image: </p><br><pre> <code class="bash hljs">mkinitramfs -o /boot/initrd</code> </pre> <br></li><li><p>  It remains to add the <code>root-ro-driver=overlay</code> parameter to the bootloader, to the <em>/boot/cmdline.txt</em> file </p><br></li><li>  And 3 more lines in the bootloader configuration at <em>/boot/config.txt</em> : <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">initramfs</span></span> initrd followkernel ramfsfile=initrd ramfsaddr=-<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> </li></ol><br><p>  You can <code>disable-root-ro=true</code> read-only mode, by the way, either by adding <code>disable-root-ro=true</code> in / <em>boot / cmdline.txt</em> , or by creating a <em>disable-root</em> file in the root of the file system. </p><br><p>  In Debian (respectively, and in Raspbian), there is the <em>bilibop-lockfs package</em> , which does roughly the same thing as this script.  However, despite the fact that <em>bilibop</em> is available for installation, it is designed to work in conjunction with <em>GRUB</em> , and not used in the Raspbian loader.  In the x86 version of Raspbian, it works correctly.  Perhaps readers will be able to patch it for Raspberry Pi. </p><br><h3 id="zaschita-ot-perepolneniya-faylovoy-sistemy-v-pamyati">  File system overflow protection </h3><br><p>  For <em>tmpfs</em> , half the amount of RAM is allocated by default, and since memory is limited, once the changes to the root file system have reached the limit.  You can clear it by simply rebooting the system; to do this, add the line to <em>/ etc / crontab</em> : </p><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#        (100%)  . * * * * * root /bin/df -h | /bin/grep /$ | /usr/bin/awk '{if ($5==</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"100%"</span></span></span><span class="hljs-meta">) system (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/sbin/shutdown -r now"</span></span></span><span class="hljs-meta">)}'</span></span></code> </pre> <br><p>  and restart cron </p><br><pre> <code class="bash hljs">sudo service cron restart</code> </pre> <br><p>  This will allow you to respond to the problem within one minute. </p><br><h3 id="korni-otdelno-homyaki-otdelno">  Roots separately, hamsters separately </h3><br><p>  I used such a configuration for a while, but I was tired of losing settings and plugins in Kodi, and did not set everything up in advance, and I decided to leave the root system in read-only mode, and keep the home folder as it is, all the same, it doesn‚Äôt make much changes . </p><br><p>  Naturally, then the partition should be under <em>F2FS</em> - optimized for SSD and other flash drives to the file system.  As already mentioned, the memory card has two troubles: the probability of losing some of the data during recording and a relatively small number of supported cell overwrites.  F2FS refers to file systems that use the concept of copy-on-write (Copy-On-Write), that is, new data is not overwritten in the same cells, but written to a new place, and only if the operation is completed successfully, the link to the old area of ‚Äã‚Äãthe media is deleted . </p><br><p>  To work with F2FS, you need to install the <em>f2fs-tools</em> package both in our raspberry pi and in the system with which the new partition is created.  For Debian-like (including Raspbian), you need to run the command </p><br><pre> <code class="bash hljs">sudo apt install f2fs-tools</code> </pre> <br><p>  I cut off half with GParted, created the F2FS partition and at the same time gave the <em>home</em> tag to more conveniently access the partition. </p><br><p><img src="https://habrastorage.org/webt/yh/jn/f-/yhjnf-ommtkzeaiqno46uhfi4jy.png" alt="gparted home section"></p><br><p>  After that made changes to <em>/ etc / fstab</em> , adding the line </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">LABEL</span></span>=home /home f2fs rw,noatime,defaults <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><h3 id="vsyo-horosho-no-kak-teper-stavit-obnovleniya">  Everything is good, but how to install updates now? </h3><br><p>  I also thought of this, recalling the project Ubuntu Core Snappy.  It provides for the existence of 2 sections, available for reading to all others.  The system update is atomically written to the inactive partition and the system is rebooted, already using the updated partition.  These two sections of System-a / b also allow you to roll back to a working version in case of problems with the update. </p><br><p><img src="https://habrastorage.org/webt/zr/se/qe/zrseqe05zdwmlcstve8wvgdaclm.png" alt="partition structure in ubuntu core snappy"></p><br><p>  Similarly, I did, breaking the system partition into 2 equal sections.  Previously, of course, copying data from a memory card to a computer.  For this, it is convenient to use the rsync file copy utility.  For example: </p><br><pre> <code class="bash hljs">sudo rsync -aAXv --exclude={<span class="hljs-string"><span class="hljs-string">"/dev/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/proc/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/sys/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/tmp/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/run/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/mnt/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/media/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/backups/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/cache/apt/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/lock/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/tmp/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/lost+found"</span></span>, <span class="hljs-string"><span class="hljs-string">"/home"</span></span>} /media/user/folder /home/user/backup_raspbian</code> </pre> <br><p>  We split the above command and see what each argument does. </p><br><ul><li>  <strong>-aAXv</strong> ‚Äî Files are transferred in ‚Äúarchive‚Äù mode, which ensures that symbolic links, device, permission, ownership, modification time, access control lists, and extended attributes are preserved. </li><li>  <strong>--exclude</strong> - Exclude these directories from the backup. </li><li>  <strong>/ media / user / folder</strong> - Source directory. </li><li>  <strong>/ home / user / backup_raspbian</strong> - This is the backup destination folder. </li></ul><br><p>  In total, I received 4 sections, where the first one contains the bootloader, the next two are identical in size and contain a copy of the file system (for convenience, I called them root1fs and root2fs, respectively), and in the last section, user data. </p><br><p><img src="https://habrastorage.org/webt/db/yi/l6/dbyil6vhbptyko3pvon2rnm_qfc.png" alt="gparted sections"></p><br><p>  It remains to back up the backup from the computer to both sections of the memory card and register the changes in the <em>fstab</em> and the bootloader. </p><br><p>  In the <em>root1fs</em> section of the <em>/ etc / fstab file</em> in the line where the root is mounted, we change the line to </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">LABEL</span></span>=root1fs / ext4 defaults,noatime <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  and in the <em>root2fs</em> section <em>,</em> respectively, on <em>root2fs</em> </p><br><p>  It remains to make changes to <em>/boot/cmdline.txt</em> <br>  It is necessary to find the <code>root=PARTUUID=‚Ä¶</code> parameter there and replace it with <code>root=LABEL=root1fs</code> or <code>root=LABEL=root2fs</code> , it will depend on this from which partition it is being booted. </p><br><p>  Preparations are over, now you can make the first update of the system. <br>  On the computer where we saved the backup, you need to install the <em>proot</em> and <em>qemu-system</em> packages.  For Debian-like: </p><br><pre> <code class="bash hljs">sudo apt install proot qemu-system</code> </pre> <br><p>  Now we can do chrut in the saved backup ... </p><br><pre> <code class="bash hljs">sudo proot -q qemu-arm -S /home/user/backup_raspbian</code> </pre> <br><p>  and make the necessary changes.  For example, the very update that I suggested above. </p><br><pre> <code class="bash hljs">apt update &amp;&amp; apt upgrade</code> </pre> <br><p>  after downloading and installing updates, exit the command with the <code>exit</code> and can synchronize with the memory card: </p><br><pre> <code class="bash hljs">sudo rsync -aAXv --exclude={<span class="hljs-string"><span class="hljs-string">"/dev/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/proc/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/sys/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/tmp/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/run/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/mnt/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/media/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/backups/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/cache/apt/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/lock/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/var/tmp/*"</span></span>,<span class="hljs-string"><span class="hljs-string">"/lost+found"</span></span>, <span class="hljs-string"><span class="hljs-string">"/home"</span></span>, <span class="hljs-string"><span class="hljs-string">"/etc/fstab"</span></span>} /home/user/backup_raspbian /media/user/root2fs</code> </pre> <br><p>  Notice, I added the <em>/ etc / fstab</em> synchronization exception to the already mentioned <em>rsync</em> command, since this file is already configured on each partition separately. </p><br><p>  In this case, the changes are synchronized with the second partition (root2fs).  By choosing the active partition in <em>/boot/cmdline.txt</em> , you can boot from both the original version of the system and the updated one. </p><br><p>  And it was interesting to play with this synchronization, as well as network synchronization with the working raspberry, but the need to control from a separate device is inconvenient.  If I had a rack of minicomputers, or if I offered to use my distribution kit, of course, such non-atomic updates would be very convenient, but on the scale of one device there is no point.  And I started thinking about automatically updating the script, or that some script even directly from Raspbian should read the second section and update it, and then change the boot partition, but before that I decided to study the existing distros intended for deploying a media center on Kodi.  And suddenly‚Ä¶ </p><br><h2 id="schaste-s-xbian">  XBian Happiness </h2><br><p><img src="https://habrastorage.org/webt/6p/ok/2y/6pok2ytghqrtzsaxqijkgd-olds.png" alt="xbian logo"><br>  I don‚Äôt know how I used to pass <a href="http://www.xbian.org/">XBian</a> , but this is exactly what I need.  Unlike other distributions with Kodi, which are variations in the number of software originally installed, it is in XBian that many optimizations are used specifically to work as a media center.  In XBian released what I wanted, only better thought out. </p><br><p>  XBian is based on Debian, and, like Debian, uses rolling releases, because packages are always up to date.  Moreover, you can upgrade to the test branch and go back to the stable one. </p><br><p>  The system is located on the partition with the <em>Btrfs</em> file system, which, like <em>F2FS</em> , uses the copy-on-write mechanism, but also supports creating snapshots, and the XBian menu has convenient utilities for managing snapshots and settings for automatically creating snapshots.  If any file is damaged, <em>Btrfs will</em> instantly transfer the system to read-only mode to prevent further damage to the system, and provide the means to restore and roll back to the working version.  I think <em>Btrfs</em> is the perfect choice for the system partition in this case, and <em>F2FS</em> decided to use it on a flash drive with files connected to the Raspberry Pi.  I don‚Äôt need snapshots on a flash drive, but the data in <em>F2FS is</em> written strictly sequentially, unlike <em>Btrfs</em> , without worrying about fragmentation, which provides a more uniform load on the cells. </p><br><p>  In XBian, the services are set to the minimum number of records made on microSD, so the lack of the Read-Only section can be ignored.  In the end, the store gave me a 10-year warranty on the memory card, if anything, I‚Äôll change it. </p><br><p>  The only downside for me is that XBian uses <em>upstart</em> as the initialization system.  It is customary to scold <em>systemd</em> , and I myself am scolding as a joke myself, but it's much more convenient for me to go with it.  But you can not worry about this: <em>upstart</em> since 2014 does not develop, one day developers will have to change the initialization system. </p><br><p>  Then I found a great plugin for Kodi called <a href="https://quasar.surge.sh/">Quasar</a> , which I want to tell about separately.  It allows you to choose from various tops, either to find the desired movie or series and start watching it using torrent technology, and after viewing the plugin will offer to save this movie or series to the library.  And you can save as a downloaded file, and a link to it - then when you click on the product will start downloading torrents. </p><br><p>  <em>Quasar Burst</em> is an add-on for Quasar, which contains settings for which torrent trackers to use to search for content.  It already has popular Russian torrent trackers, for example, rutor and rutracker, so Quasar is absolutely suitable for Russian-speaking users. </p><br><p>  <strong>UP:</strong> In the <a href="https://habrahabr.ru/post/346594/">comments</a> recommended <a href="https://elementum.surge.sh/">Elementum</a> - fork of the <a href="https://elementum.surge.sh/">quasar</a> that <a href="https://elementum.surge.sh/">had</a> stopped developing.  I recommend to try it. </p><br><h2 id="obhod-blokirovok">  Bypass blocking </h2><br><p>  However, everything is not as good as we would like.  As you know, Roskomnadzor requires providers to block heap of sites, like recipe for crafting dynamite in minecraft or torrent trackers, and if installing a browser add-on is enough to bypass the lock on the desktop, then it‚Äôs not so easy for the media center. </p><br><p>  If all traffic is sent via Tor, VPN or a proxy, then this will affect the download speed.  Especially in the case of Tor.  Therefore, it is necessary to bypass blocking only blocked addresses, and connect to other torrent users directly. </p><br><p>  You can find various options for circumvention, varying degrees of reliability and complexity, I chose to use a VPN, and not for all traffic, but for a specifically specified list of addresses. </p><br><p>  You can use your VPN server, purchase it somewhere, or use the <a href="https://antizapret.prostovpn.org/">antizapret.prostovpn.org</a> service.  It seems like when installing this VPN traffic to the sites should go directly if this site is not on the blocked list, but for some reason all of my traffic on the Raspberry Pi bypasses the VPN, so I forcibly indicated which addresses to use for it, o what a little later. </p><br><p>  The command to install OpenVPN: </p><br><pre> <code class="bash hljs">sudo apt install openvpn</code> </pre> <br><p>  Then you need to add the <em>tun</em> kernel module to autoload at system startup in order to ensure the operation of OpenVPN </p><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"tun"</span></span> &gt;&gt; /etc/modules</code> </pre> <br><p>  and for the first time manually download it </p><br><pre> <code class="bash hljs">sudo modprobe tun</code> </pre> <br><p>  In the case of using a VPN from antizapret, I downloaded the <em>antizapret.ovpn</em> file stored there, saved it as <em>/etc/openvpn/client.conf</em> and added the addresses I needed to be transmitted via VPN </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 195<span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.146</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.214</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn_gateway</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">rutracker</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 185<span class="hljs-selector-class"><span class="hljs-selector-class">.112</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.157</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.181</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn_gateway</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">nnm-club</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 104<span class="hljs-selector-class"><span class="hljs-selector-class">.27</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.140</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.149</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn_gateway</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">rutor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 104<span class="hljs-selector-class"><span class="hljs-selector-class">.24</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.106</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn_gateway</span></span> # <span class="hljs-selector-tag"><span class="hljs-selector-tag">kinozal</span></span></code> </pre> <br><p>  It is important that the configuration does not have a line starting with <code>redirect-gateway</code> , otherwise all traffic will go through the VPN. </p><br><p>  The file <em>/ etc / default / openvpn is</em> used to configure which configurations will be run by default when OpenVPN is started.  It is enough to uncomment <code>AUTOSTART="all"</code> , or instead of <em>all</em> specify the <em>client</em> , that is, the configuration we created. </p><br><p>  OpenVPN launch: </p><br><pre> <code class="bash hljs">sudo service openvpn start</code> </pre> <br><p>  and adding to autostart: </p><br><pre> <code class="bash hljs">sudo update-rc.d openvpn <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span></code> </pre> <br><p>  Also, to bypass the blocking of service trackers, .t-ru.org <em>executed a command in the console and added in</em> /etc/rc.local* before <code>`exit</code> to auto-execute the command at boot: </p><br><pre> <code class="bash hljs">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 80 -d 195.82.146.120/30 -j DNAT --to-destination 163.172.167.207:3128</code> </pre> <br><p>  It would seem that all?  But no.  My provider turned out to be tricky, because my DNS requests addressed to Google at 8.8.4.4 are intercepted and changed if I request the IP address of a blocked resource.  Here that to me <em>nslookup</em> issues: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">nslookup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rutracker</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Server</span></span>:         8<span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Address</span></span>:        8<span class="hljs-selector-class"><span class="hljs-selector-class">.8</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.4</span></span><span class="hljs-selector-id"><span class="hljs-selector-id">#53</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Non-authoritative</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">answer</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">rutracker</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Address</span></span>: &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> &gt;</code> </pre> <br><p>  Well, long ago it was time to switch to DNSCrypt.  This utility connects to the DNS server over an encrypted channel, so the provider or another MitM will not be able to listen, spoof, or filter packets.  I installed DNSCrypt on the router, launched it and now everything is gorgeous. </p><br><p>  As a result, I got a wonderful media center, with a huge amount of available content, which is based on the best (at least in my estimation) technology, and using Raspberry Pi opens up huge opportunities for customization.  You can install an infrared receiver to control the media center using the remote, even when connected to a TV that does not support HDMI-CEC, or play old games by connecting a joystick, or you can completely convert from a media center to another device. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/346594/">https://habr.com/ru/post/346594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../346582/index.html">Risk management in the fairy tale of A.S. Pushkin ‚ÄúOn the Fisherman and the Fish‚Äù</a></li>
<li><a href="../346584/index.html">How to do typical tasks in a web application on React JS</a></li>
<li><a href="../346586/index.html">How to build a community. Translation of the book "Social Architecture": The Myth of Individual Intelligence</a></li>
<li><a href="../346588/index.html">Remote work, is it good or bad?</a></li>
<li><a href="../346590/index.html">How I determined the provider by IP</a></li>
<li><a href="../346598/index.html">We connect devices of the Internet of things and Azure by means of NodeJS</a></li>
<li><a href="../346600/index.html">Unusual multiplication system</a></li>
<li><a href="../346604/index.html">The digest of interesting materials for the mobile developer # 236 (January 8 - January 14)</a></li>
<li><a href="../346606/index.html">Learned Telegram chat bot with AI in 30 lines of Python code</a></li>
<li><a href="../346608/index.html">We test user scripts with Hermione. Yandex lecture</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>