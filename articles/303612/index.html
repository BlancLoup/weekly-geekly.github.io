<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ProxySQL - another mysql-proxy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√©, this tool was repeatedly mentioned for proxying SQL queries, but, unfortunately, I did not find a single article describing its work, moreov...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ProxySQL - another mysql-proxy</h1><div class="post__text post__text-html js-mediator-article">  On Habr√©, this tool was repeatedly mentioned for proxying SQL queries, but, unfortunately, I did not find a single article describing its work, moreover, documentation in Russian was not found either.  Well, let's try to fill this gap.  In this article we will look at the structure of ProxySQL, configuration and usage example. <br><img src="https://habrastorage.org/files/943/bfc/6ab/943bfc6ab7ba4ef28428633a1e927f7b.png"><br><a name="habracut"></a><br>  <b>What is ProxySQL?</b> <br>  This application is for proxying SQL database queries for MySQL forks, such as MariaDB and Percona (in the future, the developers promise to add support for other different databases).  It works as a separate daemon, all SQL queries that need to be proxied are processed, then, according to predefined rules, the daemon connects to the required MySQL server and executes the query, and after that gives the result to the application.  ProxySQL can also modify incoming requests according to templates. <br><br>  <b>ProxySQL architecture.</b> <br>  ProxySQL has a rather complicated but easy to configure system, thanks to which it is possible: <br><ul><li>  Make automatic changes to the configuration, which is important for large systems.  This is done through a MySQL-like administrative interface. </li><li>  Most changes can be made in runtime mode without restarting the ProxySQL daemon. </li><li>  It is easy to perform change rollbacks, if suddenly something was configured incorrectly. </li></ul><br><br>  This is achieved by using a multi-layer configuration system, which is divided into 3 layers: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/97e/97f/406/97e97f406aed4a4daaa82203ea1c5330.png" alt="image"><br><br>  Runtime Layer - This configuration layer is directly used by the ProxySQL daemon and contains all the configuration information for proxying requests. <br><br>  Memory layer ‚Äî Or the main layer is a SQLite3 database that is in memory, used to provide configuration information and the configuration itself.  Configuration is done through standard MySQL client using SQL commands. <br><br>  The Disk Layer - It is a normal SQLite3 file in which data entered through the Memory layer is saved (by the user) <br><br>  Conf.  file - the ProxySQL configuration file (proxysql.cnf) is used at the time of initialization, contains information about finding SQLite3 database, information about the administrative interface, as well as the initial configuration of the daemon. <br><br>  There are several administrative commands for moving configurations between layers: <br><br>  To move user configurations (USERS) between Memory (layer 2) and Runtime: <br><pre><code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span> MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> RUNTIME</code> </pre> <br><br>  From Runtime to Memory: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; SAVE MYSQL USERS TO MEMORY MySQL [(none)]&gt; SAVE MYSQL USERS FROM RUNTIME</code> </pre><br><br>  From disk (layer 3) to memory <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span> MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DISK</code> </pre><br><br>  From memory (layer 2) to disk (layer 3) <br><pre> <code class="sql hljs">MySQL [(none)]&gt; SAVE MYSQL USERS FROM MEMORY MySQL [(none)]&gt; SAVE MYSQL USERS TO DISK</code> </pre><br><br>  From disk (layer 3) to memory (layer 2) <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> CONFIG</code> </pre><br><br>  In the same way, moving can be done for other tables / variables.  List of available: <br>  QUERY RULES - Requests for proxying. <br>  VARIABLES - variables of MySQL-server and administrative settings. <br><br>  <b>Installation</b> <br>  Since this application is quite new and is under development, the best option would be to collect it from source code, which can be obtained on github: <a href="https://github.com/sysown/proxysql">github.com/sysown/proxysql</a> <br>  For RedHat (CentOS) and Debian (Ubuntu) OS binary packages are compiled: <a href="https://github.com/sysown/proxysql/releases">github.com/sysown/proxysql/releases</a> <br><br>  Install the package for CentOS 7: <br><pre> <code class="bash hljs">rpm -ihv https://github.com/sysown/proxysql/releases/download/v1.2.0i/proxysql-1.2.0-1-centos7.x86_64.rpm</code> </pre><br><br>  After installation, conf.  the file will be located at: /etc/proxysql.cnf <br>  Open it in your favorite editor: <br><br><pre> <code class="cpp hljs">datadir=<span class="hljs-string"><span class="hljs-string">"/var/lib/proxysql"</span></span> admin_variables= { admin_credentials=<span class="hljs-string"><span class="hljs-string">"admin:admin"</span></span> #     mysql_ifaces=<span class="hljs-string"><span class="hljs-string">"127.0.0.1:6032;/tmp/proxysql_admin.sock"</span></span> #      refresh_interval=<span class="hljs-number"><span class="hljs-number">2000</span></span> #      debug=<span class="hljs-literal"><span class="hljs-literal">true</span></span> admin-stats_credentials=stats:stats #    .   ( ) } mysql_variables= { threads=<span class="hljs-number"><span class="hljs-number">4</span></span> #      max_connections=<span class="hljs-number"><span class="hljs-number">2048</span></span> #  ,     . default_query_delay=<span class="hljs-number"><span class="hljs-number">0</span></span> default_query_timeout=<span class="hljs-number"><span class="hljs-number">36000000</span></span> have_compress=<span class="hljs-literal"><span class="hljs-literal">true</span></span> #     poll_timeout=<span class="hljs-number"><span class="hljs-number">2000</span></span> interfaces=<span class="hljs-string"><span class="hljs-string">"127.0.0.1:3306;/tmp/proxysql.sock"</span></span> default_schema=<span class="hljs-string"><span class="hljs-string">"information_schema"</span></span> stacksize=<span class="hljs-number"><span class="hljs-number">1048576</span></span> #        backend-. server_version=<span class="hljs-string"><span class="hljs-string">"5.1.30"</span></span> connect_timeout_server=<span class="hljs-number"><span class="hljs-number">10000</span></span> monitor_history=<span class="hljs-number"><span class="hljs-number">60000</span></span> monitor_connect_interval=<span class="hljs-number"><span class="hljs-number">200000</span></span> monitor_ping_interval=<span class="hljs-number"><span class="hljs-number">200000</span></span> ping_interval_server=<span class="hljs-number"><span class="hljs-number">10000</span></span> ping_timeout_server=<span class="hljs-number"><span class="hljs-number">200</span></span> commands_stats=<span class="hljs-literal"><span class="hljs-literal">true</span></span> sessions_sort=<span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre><br><br>  datadir is the location of the SQLite3 database file, the default is / var / lib / proxysql <br>  admin_variables - administrative interface settings <br>  mysql_variables - contains global variables for the server of incoming mysql requests. <br><br>  We will add backend servers and other settings via the mysql interface. <br><br>  <b>First run and initialize</b> <br>  Initialize the settings. <br><br>  Initialization transfers server settings from conf.  file (layer 3) to the SQLite3 database in memory (layer 2), while resetting all the settings that were stored in memory (layer 2) and renaming the file on disk (layer 3). <br><pre> <code class="bash hljs">proxysql --initial</code> </pre><br><br>  <b>Configuring ProxySQL on the fly (Runtime)</b> <br>  To configure ProxySQL on the fly, we will use the standard mysql client. <br><br><pre> <code class="bash hljs">mysql -h 127.0.0.1 -P6032 -uadmin -p Enter password: MySQL [(none)]&gt;</code> </pre><br><br>  Now we are in admin.  interface.  Let's see what tables there are: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">tables</span></span>; +<span class="hljs-comment"><span class="hljs-comment">--------------------------------------+ | tables | +--------------------------------------+ | global_variables | | mysql_collations | | mysql_query_rules | | mysql_replication_hostgroups | | mysql_servers | | mysql_users | | runtime_mysql_query_rules | | runtime_mysql_replication_hostgroups | | runtime_mysql_servers | | runtime_scheduler | | scheduler | +--------------------------------------+ 11 rows in set (0.00 sec)</span></span></code> </pre><br><br>  mysql_servers - contains a list of backend servers <br>  mysql_users - contains a list of all users who have access to ProxySQL and backend servers. <br>  mysql_query_rules - all the rules for caching, redirecting and replacing SQl requests that go through a proxy. <br>  global_variables - contains global variables (which we set up in the conf. file) of the MySQL-server ProxySQL and administrative settings. <br>  mysql_replication_hostgroups - a list of host groups to which backends will be attached, to which query rules will in turn be applied. <br>  mysql_query_rules - query proxy rules. <br><br>  Let's add backends, but first make sure that the mysql_servers, mysql_replication_hostgroups and mysql_query_rules tables are empty. <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mysql_servers; Empty <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec) MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mysql_replication_hostgroups; Empty <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec) MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mysql_query_rules; Empty <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec)</code> </pre><br><br>  Indeed, the necessary tables are empty.  Before adding we need to decide what and where we will be proxying, I will add two servers, one will be written (INSERT, UPDATE, etc.), and from the second we will only read the data (SELECT), in general the typical master- scheme slave with read-write distribution across different servers.  To do this, we will create 2 host groups. <br><br>  Add backend servers: <br>  The first server we will be engaged in writing to the database and consist in the host group 1: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_servers(hostgroup_id,hostname,port) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">'192.168.100.2'</span></span>,<span class="hljs-number"><span class="hljs-number">3307</span></span>);</code> </pre><br><br>  The second server is configured on our slave and we will only read from it, put it in group 2: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_servers(hostgroup_id,hostname,port) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'192.168.100.3'</span></span>,<span class="hljs-number"><span class="hljs-number">3307</span></span>); Query OK, 1 row affected (0.01 sec) MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mysql_servers; +<span class="hljs-comment"><span class="hljs-comment">--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+ | hostgroup_id | hostname | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | +--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+ | 0 | 192.168.100.2 | 3307 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | | 1 | 192.168.100.3 | 3307 | ONLINE | 1 | 0 | 1000 | 0 | 0 | 0 | +--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+ 2 rows in set (0.00 sec)</span></span></code> </pre><br><br>  The mysql_replication_hostgroups table has 2 fields, the first writer_hostgroup contains the numbers of the groups that include the write hosts.  In reader_hostgroup is readable. <br>  Add 2 host groups (1,2) to the mysql_replication_hostgroups table: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_replication_hostgroups <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); Query OK, 1 row affected (0.00 sec) MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mysql_replication_hostgroups; +<span class="hljs-comment"><span class="hljs-comment">------------------+------------------+ | writer_hostgroup | reader_hostgroup | +------------------+------------------+ | 1 | 2 | +------------------+------------------+ 1 row in set (0.00 sec)</span></span></code> </pre><br><br>  Now we transfer the data about the backend servers and host groups from memory to runtime so that they take effect immediately: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL SERVERS <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> RUNTIME; Query OK, 0 rows affected (0.00 sec)</code> </pre><br><br>  and save the data to disk (layer 3): <br><pre> <code class="sql hljs">MySQL [(none)]&gt; SAVE MYSQL SERVERS TO DISK; Query OK, 0 rows affected (0.00 sec)</code> </pre><br><br>  It's time to add rules for proxying queries, for this there is a table mysql_query_rules: <br>  The table has the following structure: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> mysql_query_rules ( rule_id <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> AUTOINCREMENT <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, active <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> (active <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, username <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, schemaname <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, flagIN <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, match_pattern <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, negate_match_pattern <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> (negate_match_pattern <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, flagOUT <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>, replace_pattern <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, destination_hostgroup <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, cache_ttl <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span>(cache_ttl &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>), reconnect <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span> (reconnect <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>, delay <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">apply</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHECK</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">apply</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> )</code> </pre><br>  rule_id - rule number <br>  active - the rule is on, 0 is off <br>  username and schemaname - If non-NULL, then the rule will be executed only if the username / schemaname is correctly matched for the connection <br>  flagIN, flagOUT, apply - These flags make it possible to create a ‚Äúchain of rules‚Äù.  In practice, I personally have not yet had to use them, so I give the original text from the official documentation so far, if anyone can translate correctly and clearly, please.  <i>"get the chains of rules" that get you applied one after the other.</i>  <i>An input flag is set to 0, and only rules with flagIN = 0 are considered at the beginning.</i>  <i>The flag will be flagged out and the flag will be flagged out.</i>  <i>If the flagOUT differs from the flagIN, it will exit from the flagIN as the new input flag.</i>  <i>This happens until there are no more matching rules.</i> <br>  match_pattern is a regular expression, the rules that fall under it will be proxied. <br>  replace_pattern is a regular expression for replacing a proxied request or part of it. <br>  destination_hostgroup is the host number of the group to which the rule will apply. <br>  cache_ttl - the number of seconds on which the request will be cached. <br>  reconnect - not yet used <br>  timeout - timeout for execution of match_pattern or replace_pattern, if the request takes more time, it is killed. <br>  delay - The delay before the request to the backend is executed, useful if for example a SELECT query goes right after INSERT / UPDATE to give time for replication. <br><br>  Add 3 rules to the mysql_query_rules table <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,<span class="hljs-keyword"><span class="hljs-keyword">apply</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'^SELECT .* FOR UPDATE$'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,<span class="hljs-keyword"><span class="hljs-keyword">apply</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'^SELECT'</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,<span class="hljs-keyword"><span class="hljs-keyword">apply</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'.*'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br><br>  The first rule redirects all SELECT UPDATE requests to the master server. <br>  The second rule redirects all queries to the slave SELECT server <br>  Finally, the third rule redirects all other requests to the master server. <br><br>  <b>Users</b> <br>  Now add users to the mysql_users table.  ProxySQL needs all users that are present on all servers connected to it.  Request to add root user for both host groups: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_users(username,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>,default_hostgroup) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'root'</span></span>,<span class="hljs-string"><span class="hljs-string">'password'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); Query OK, 1 row affected (0.00 sec) MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> mysql_users(username,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>,default_hostgroup) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-string"><span class="hljs-string">'root'</span></span>,<span class="hljs-string"><span class="hljs-string">'password'</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); Query OK, 1 row affected (0.00 sec)</code> </pre><br><br>  Transfer the changes to Runtime and save to disk: <br><pre> <code class="sql hljs">MySQL [(none)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span> MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> RUNTIME MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span> MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">USERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RULES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span> MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">LOAD</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RULES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> RUNTIME MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RULES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MEMORY</span></span> MySQL [(<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>)]&gt; <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> MYSQL <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RULES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> DISK</code> </pre><br><br>  <b>Conclusion</b> <br>  After the above steps, we have configured ProxySQL for Master-Slave replication.  Of course, this is not all the features of ProxySQL, among other things, it can carry out excellent monitoring of all backend-s, and, of course, of itself. <br><br>  References: <br>  Off site: <a href="http://www.proxysql.com/">http://www.proxysql.com/</a> <br>  Off  Documentation: <a href="https://github.com/sysown/proxysql/tree/master/doc">https://github.com/sysown/proxysql/tree/master/doc</a> <br>  Configure Master-Slave replication using ProxySQL and configuration from conf. File: <a href="http://unix-admin.su/scalable-mysql-cluster/">http://unix-admin.su/scalable-mysql-cluster/</a> </div><p>Source: <a href="https://habr.com/ru/post/303612/">https://habr.com/ru/post/303612/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303602/index.html">Experience useful modification UEFI: return Thinkpad W520 legitimate support for fast memory</a></li>
<li><a href="../303604/index.html">The digest of interesting events from the world of Java, and around it # 4 (06.06.2016 - 19.06.2016)</a></li>
<li><a href="../303606/index.html">DLMS / COSEM is an open protocol for data exchange with metering devices. Part 2: interface classes, metering device model</a></li>
<li><a href="../303608/index.html">typus is a local python typographer</a></li>
<li><a href="../303610/index.html">The digest of interesting materials for the mobile # 158 developer (June 14-19)</a></li>
<li><a href="../303614/index.html">We work with a budget institution. Part 2</a></li>
<li><a href="../303616/index.html">WWDC'16 Mobile Developer Guide</a></li>
<li><a href="../303618/index.html">The first confirmed case of actual use of ReactOS</a></li>
<li><a href="../303620/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ216 (June 13 - 19, 2016)</a></li>
<li><a href="../303624/index.html">Jsqry - a library for querying JS objects and arrays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>