<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As I taught AI to play Tetris for NES. Part 1: game code analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I explore the deceptively simple mechanics of Nintendo Tetris, and in the second part I will explain how I created the AI ‚Äã‚Äãthat expl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As I taught AI to play Tetris for NES. Part 1: game code analysis</h1><div class="post__text post__text-html js-mediator-article">  In this article, I explore the deceptively simple mechanics of Nintendo Tetris, and in the second part I will explain how I created the AI ‚Äã‚Äãthat exploits these mechanics. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/48f/1a4/9b8/48f1a49b87860e6139e8d298e1fe6188.png"></div><br><h2>  Try it yourself </h2><br><h3>  about the project </h3><br>  For those who lack the perseverance, patience and time needed to master Nintendo Tetris, I created an AI capable of playing on my own.  You can finally get to level 30 and beyond.  You will see how to get the maximum points and watch the endless changes in the counters of rows, levels and statistics.  Find out what colors appear on the levels above which a person could not climb.  See how far you can go. <br><a name="habracut"></a><br><h3>  Requirements </h3><br>  To run AI, you need a universal NES / Famicom <a href="http://www.fceux.com/">FCEUX emulator</a> .  Artificial Intelligence was developed for <a href="http://www.fceux.com/web/version.html">FCEUX 2.2.2</a> , the newest version of the emulator at the time of writing. <br><br>  You will also need a Nintendo Tetris ROM file (US version).  Try searching it on <a href="https://www.google.com/">google</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Download </h3><br>  Unpack <code>lua/NintendoTetrisAI.lua</code> from this <a href="">source zip file</a> . <br><br><h3>  Launch </h3><br>  Run FCEUX.  From the menu, select File |  Open ROM ... In the Open File dialog box, select the Nintendo Tetris ROM file and click Open.  The game will start. <br><br>  From the menu, select File |  Lua |  New Lua Script Window ... In the the Lua Script window, enter the path to <code>NintendoTetrisAI.lua</code> or click the Browse button to find it.  After that click Run. <br><br>  The script on Lua will redirect you to the first screen of the menu.  Leave the A-Type game type, and you can choose any music.  On slow computers, music can play very jerky, then you should turn it off.  Press Start (Enter) to go to the next menu screen.  In the second menu, you can use the arrow keys to change the starting level.  Click on Start to start the game.  And here management intercepts AI. <br><br>  If, after selecting a level in the second screen of the menu, to hold down the button of the gamepad A (you can change the keyboard layout in the Config | Input ... menu) and click Start, the initial level will be 10 more than the selected value.  The maximum elementary level is nineteenth. <br><br><h3>  Configuration </h3><br>  To make the game go faster, open the Lua script in a text editor.  At the beginning of the file, find the following line. <br><br> <code>PLAY_FAST = false</code> <br> <br>  Replace <code>false</code> with <code>true</code> as shown below. <br><br> <code>PLAY_FAST = true</code> <br> <br>  Save the file.  Then click the Restart button in the Lua Script window. <br><br><h2>  Nintendo Tetris Mechanics </h2><br><h3>  Tetrimino Description </h3><br>  Each figure Tetrimino corresponds to a single-letter name that resembles its shape. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/975/440/5ed/9754405ed7b3d83a47181edef3de6913.png"></div><br>  Nintendo Tetris designers arbitrarily set up the tetrimino order shown above.  The figures are shown in the orientation in which they appear on the screen, and the diagram creates an almost symmetrical picture (perhaps, therefore, this order was chosen).  The sequence index gives each tetrimino a unique numeric ID.  Sequence and type identifiers are important at the programming level;  in addition, they manifest themselves in the order of the figures displayed in the statistics field (see below). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc2/35d/778/dc235d778c47654e1abbc5896581fd6a.png"></div><br>  The 19 orientations used in Nintendo Tetris are tetrimino encoded in a table located at the <code>$8A9C</code> NES console memory.  Each shape is represented as a sequence of 12 bytes, which can be divided into triples <code>(Y, tile, X)</code> , describing each square in the shape.  The above hex coordinates above <code>$7F</code> denote negative integers ( <code>$FF= ‚àí1</code> , and <code>$FE = ‚àí2</code> ). <br><br> <code>; Y0 T0 X0 Y1 T1 X1 Y2 T2 X2 Y3 T3 X3 <br> <br> 8A9C: 00 7B FF 00 7B 00 00 7B 01 FF 7B 00 ; 00: T up <br> 8AA8: FF 7B 00 00 7B 00 00 7B 01 01 7B 00 ; 01: T right <br> 8AB4: 00 7B FF 00 7B 00 00 7B 01 01 7B 00 ; 02: T down (spawn) <br> 8AC0: FF 7B 00 00 7B FF 00 7B 00 01 7B 00 ; 03: T left <br> <br> 8ACC: FF 7D 00 00 7D 00 01 7D FF 01 7D 00 ; 04: J left <br> 8AD8: FF 7D FF 00 7D FF 00 7D 00 00 7D 01 ; 05: J up <br> 8AE4: FF 7D 00 FF 7D 01 00 7D 00 01 7D 00 ; 06: J right <br> 8AF0: 00 7D FF 00 7D 00 00 7D 01 01 7D 01 ; 07: J down (spawn) <br> <br> 8AFC: 00 7C FF 00 7C 00 01 7C 00 01 7C 01 ; 08: Z horizontal (spawn) <br> 8B08: FF 7C 01 00 7C 00 00 7C 01 01 7C 00 ; 09: Z vertical <br> <br> 8B14: 00 7B FF 00 7B 00 01 7B FF 01 7B 00 ; 0A: O (spawn) <br> <br> 8B20: 00 7D 00 00 7D 01 01 7D FF 01 7D 00 ; 0B: S horizontal (spawn) <br> 8B2C: FF 7D 00 00 7D 00 00 7D 01 01 7D 01 ; 0C: S vertical <br> <br> 8B38: FF 7C 00 00 7C 00 01 7C 00 01 7C 01 ; 0D: L right <br> 8B44: 00 7C FF 00 7C 00 00 7C 01 01 7C FF ; 0E: L down (spawn) <br> 8B50: FF 7C FF FF 7C 00 00 7C 00 01 7C 00 ; 0F: L left <br> 8B5C: FF 7C 01 00 7C FF 00 7C 00 00 7C 01 ; 10: L up <br> <br> 8B68: FE 7B 00 FF 7B 00 00 7B 00 01 7B 00 ; 11: I vertical <br> 8B74: 00 7B FE 00 7B FF 00 7B 00 00 7B 01 ; 12: I horizontal (spawn) <br> <br> 8B80: 00 FF 00 00 FF 00 00 FF 00 00 FF 00 ; 13: Unused</code> <br> <br>  At the bottom of the table there is one unused record, potentially giving the possibility of adding another orientation.  However, in different parts of the code, <code>$13</code> indicates that a value is not assigned to the active tetrimino orientation identifier. <br><br>  For ease of reading below are the coordinates of the squares in decimal form. <br><br> <code>-- { { X0, Y0 }, { X1, Y1 }, { X2, Y2 }, { X3, Y3 }, }, <br> <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, -1 }, }, -- 00: T up <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 01: T right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 02: T down (spawn) <br> { { 0, -1 }, { -1, 0 }, { 0, 0 }, { 0, 1 }, }, -- 03: T left <br> <br> { { 0, -1 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 04: J left <br> { { -1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 05: J up <br> { { 0, -1 }, { 1, -1 }, { 0, 0 }, { 0, 1 }, }, -- 06: J right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 07: J down (spawn) <br> <br> { { -1, 0 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 08: Z horizontal (spawn) <br> { { 1, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 09: Z vertical <br> <br> { { -1, 0 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0A: O (spawn) <br> <br> { { 0, 0 }, { 1, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0B: S horizontal (spawn) <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 0C: S vertical <br> <br> { { 0, -1 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 0D: L right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { -1, 1 }, }, -- 0E: L down (spawn) <br> { { -1, -1 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 0F: L left <br> { { 1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 10: L up <br> <br> { { 0, -2 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 11: I vertical <br> { { -2, 0 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 12: I horizontal (spawn)</code> <br> <br>  All orientations are placed in a 5 √ó 5 matrix. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ca/435/322/8ca435322ee85d07cc631640c11a9aee.png"></div><br>  In the figure above, the white square indicates the center of the matrix, the reference point for the rotation of the shape. <br><br>  Below is a graph of the orientation table. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b18/4e0/f0e/b184e0f0ea182222b58d151c09217567.png"></div><br>  The orientation identifier (table index) is shown in hexadecimal form in the upper right corner of each matrix.  And the mnemonic invented for this project is shown in the upper left corner.  <code>u</code> , <code>r</code> , <code>d</code> , <code>l</code> , <code>h</code> and <code>v</code> are abbreviations from "up, right, down, left, horizontal and vertical".  For example, it is easier to indicate the orientation of <code>Jd</code> , rather than <code>$07</code> . <br><br>  Matrices containing the orientation of the figures during creation are marked with a white frame. <br><br>  Tetrimino I, S and Z could be given 4 separate orientations, but the creators of Nintendo Tetris decided to limit themselves to two.  In addition, <code>Zv</code> and <code>Sv</code> are not ideal mirror images of each other.  Both are created by turning counterclockwise, which leads to an imbalance. <br><br>  The orientation table also contains tile values ‚Äã‚Äãfor each square in each oriented figure.  However, after careful study it becomes clear that the values ‚Äã‚Äãfor one type of tetrimino are always the same. <br><br><table><tbody><tr><th>  T </th><th>  J </th><th>  Z </th><th>  O </th><th>  S </th><th>  L </th><th>  I </th></tr><tr><td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> </tr></tbody></table><br>  The values ‚Äã‚Äãof the tiles are the indices of the table (pseudo-color) pattern shown below. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br>  Tiles <code>$7B</code> , <code>$7C</code> and <code>$7D</code> are located directly under "ATIS" from the word "STATISTICS".  These are the three types of squares that tetrimino is made of. <br><br>  For the curious, I will say that ostriches and penguins are used in the endings of the B-Type mode.  This topic is discussed in detail in the "Endings" section. <br><br>  Below is the result of the ROM modification after replacing <code>$7B</code> with <code>$29</code> .  The heart is the tile under the P symbol in the pattern table for all T orientations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5fa/551/215/5fa55121523b443f8f3b6daa2bd46ad8.png"></div><br>  Heart tiles remain on the playing field even after the modified Ts are locked in place.  As stated below in the ‚ÄúCreating Tetrimino‚Äù section, this means that the playing field stores the actual values ‚Äã‚Äãof the indexes of tiles played by Tetrimino. <br><br>  The programmers of the game made it possible to use 4 separate tiles for each piece, and not just one constant type of squares.  This is a useful feature that can be used to modify the look of the game.  There is a lot of empty space for new tiles in the pattern table that can give each Tetrimino a unique appearance. <br><br>  The coordinates of the squares are very easy to manipulate.  For example, below is a modified version of the first four triples in the orientation table. <br><br> <code>8A9C: FE 7B FE FE 7B 02 02 7B FE 02 7B 02 ; 00: T up</code> <br> <br>  This change is similar to the following: <br><br> <code>{ { -2, -2 }, { 2, -2 }, { -2, 2 }, { 2, 2 }, }, -- 00: T up</code> <br> <br>  The result is a split tetrimino. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a6/ab5/86d/3a6ab586d06a57b92208bd612b755109.png"></div><br>  When moving a divided tetrimino, its squares cannot go beyond the boundaries of the playing field and cannot pass through the previously blocked figures.  In addition, the game prohibits a rotation in this orientation, if it leads to a square falling outside the boundaries of the playing field or to the fact that the square is superimposed on the square that is already lying. <br><br>  A divided tetrimino is locked in place when there is support for any of its squares.  If the figure is blocked, the squares hanging in the air continue to hang. <br><br>  The game deals with divided tetrimino as with any normal figure.  This makes us understand that there is no additional table that stores the metadata of the figures.  For example, there might be a table storing the dimensions of the bounding box of each orientation to check for collisions with the perimeter of the playing field.  But such a table is not used.  Instead, the game simply performs checks of all four squares right before the figure manipulations. <br><br>  In addition, the coordinates of the squares can be any value;  they are not limited by the interval <code>[‚àí2, 2]</code> .  Of course, much higher than this interval values ‚Äã‚Äãwill give us inapplicable figures that do not fit on the playing field.  More importantly, as stated in the section ‚ÄúGame States and Rendering Modes‚Äù, when the shape is locked in place, the cleared line cleaning mechanism only scans the row offset from ‚àí2 to 1 from the shape's central square;  a square with a <code>y</code> coordinate outside this range will be unrecognized. <br><br><h3>  Tetrimino rotation </h3><br>  In the graphical illustration of the orientation table, the rotation consists in the transition from the matrix to one of the matrices on the left or right, with the transfer of a number if necessary.  This concept is encoded in the table at <code>$88EE</code> . <br><br> <code>; CCW CW <br> 88EE: 03 01 ; Tl Tr <br> 88F0: 00 02 ; Tu Td <br> 88F2: 01 03 ; Tr Tl <br> 88F4: 02 00 ; Td Tu <br> 88F6: 07 05 ; Jd Ju <br> 88F8: 04 06 ; Jl Jr <br> 88FA: 05 07 ; Ju Jd <br> 88FC: 06 04 ; Jr Jl <br> 88FE: 09 09 ; Zv Zv <br> 8900: 08 08 ; Zh Zh <br> 8902: 0A 0A ; OO <br> 8904: 0C 0C ; Sv Sv <br> 8906: 0B 0B ; Sh Sh <br> 8908: 10 0E ; Lu Ld <br> 890A: 0D 0F ; Lr Ll <br> 890C: 0E 10 ; Ld Lu <br> 890E: 0F 0D ; Ll Lr <br> 8910: 12 12 ; Ih Ih <br> 8912: 11 11 ; Iv Iv</code> <br> <br>  To make it clearer, we will move each column from this table to the row of the table shown below. <br><table><tbody><tr><th></th><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><th>  Counterclock-wise </th><td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr><tr><th>  Clockwise </th><td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr></tbody></table><br>  The mnemonics in the headers at the top can be interpreted as a sequence index or key for distribution.  For example, turning counterclockwise <code>Tu</code> gives us <code>Tl</code> , and turning clockwise <code>Tu</code> gives <code>Tr</code> . <br><br>  The turn table encodes chained sequences of orientations IDs;  therefore, we can modify the records so that the rotation transforms one type of tetrimino into another.  This technique can potentially be used to benefit from an unused row in the orientation table. <br><br>  Before the table of turns there is a code for access to it. <br><br> <code>88AB: LDA $0042 <br> 88AD: STA $00AE ; originalOrientationID = orientationID; <br> <br> 88AF: CLC <br> 88B0: LDA $0042 <br> 88B2: ASL <br> 88B3: TAX ; index = 2 * orientationID; <br> <br> 88B4: LDA $00B5 <br> 88B6: AND #$80 ; if (not just pressed button A) { <br> 88B8: CMP #$80 ; goto aNotPressed; <br> 88BA: BNE $88CF ; } <br> <br> 88BC: INX <br> 88BD: LDA $88EE,X <br> 88C0: STA $0042 ; orientationID = rotationTable[index + 1]; <br> <br> 88C2: JSR $948B ; if (new orientation not valid) { <br> 88C5: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88C7: LDA #$05 <br> 88C9: STA $06F1 ; play rotation sound effect; <br> 88CC: JMP $88ED ; return; <br> <br> aNotPressed: <br> <br> 88CF: LDA $00B5 <br> 88D1: AND #$40 ; if (not just pressed button B) { <br> 88D3: CMP #$40 ; return; <br> 88D5: BNE $88ED ; } <br> <br> 88D7: LDA $88EE,X <br> 88DA: STA $0042 ; orientationID = rotationTable[index]; <br> <br> 88DC: JSR $948B ; if (new orientation not valid) { <br> 88DF: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88E1: LDA #$05 <br> 88E3: STA $06F1 ; play rotation sound effect; <br> 88E6: JMP $88ED ; return; <br> <br> restoreOrientationID: <br> <br> 88E9: LDA $00AE <br> 88EB: STA $0042 ; orientationID = originalOrientationID; <br> <br> 88ED: RTS ; return;</code> <br> <br>  To rotate counterclockwise, the index of the turn table is subtracted by doubling the orientation ID.  By adding 1 to it, we get the rotation index clockwise. <br><br>  The coordinates <code>x</code> , <code>y</code> and the orientation ID of the current tetrimino are stored respectively at the addresses <code>$0040</code> , <code>$0041</code> and <code>$0042</code> . <br><br>  The code uses a temporary variable to back up the orientation ID.  Later, after changing the orientation, the code checks that all four squares are within the boundaries of the playing field and none of them overlap the already lying squares (the verification code is located at <code>$948B</code> , under the code snippet shown above).  If the new orientation is incorrect, then the original is restored, not allowing the player to rotate the figure. <br><br>  Counting from the cross, the NES controller has eight buttons, the state of which is represented by the address bit <code>$00B6</code> . <br><br><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td>  A </td><td>  B </td><td>  Select </td><td>  Start </td><td>  Up </td><td>  Way down </td><td>  To the left </td><td>  To the right </td></tr></tbody></table><br>  For example, <code>$00B6</code> will contain the value of <code>$81</code> while the player holds A and Left. <br><br>  On the other hand, <code>$00B5</code> reports when the buttons were pressed;  bits <code>$00B5</code> are true only during one iteration of the game cycle (1 rendered frame).  The code uses <code>$00B5</code> to respond to A and B presses. Each of them must be released before being used again. <br><br>  <code>$00B5</code> and <code>$00B6</code> are <code>$00F5</code> and <code>$00F6</code> .  The code in the following sections uses these addresses interchangeably. <br><br><h3>  Create Tetrimino </h3><br>  The Nintendo Tetris game board consists of a matrix with 22 rows and 10 columns so that the top two rows are hidden from the player. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/0dc/33b/6e10dc33b40eaa5dec35bc6e7bf42c5f.png"></div><br>  As shown in the code below, when creating a Tetrimino shape, it is always located in the coordinates <code>(5, 0)</code> playing field. <br><br> <code>98BA: LDA #$00 <br> 98BC: STA $00A4 <br> 98BE: STA $0045 <br> 98C0: STA $0041 ; Tetrimino Y = 0 <br> 98C2: LDA #$01 <br> 98C4: STA $0048 <br> 98C6: LDA #$05 <br> 98C8: STA $0040 ; Tetrimino X = 5</code> <br> <br>  Below is a 5 √ó 5 matrix overlaid on this point. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fcf/d3b/d94/fcfd3bd94514779d6e967770a1f216cb.png"></div><br>  None of the creation matrices have squares above the starting point.  That is, when creating a Tetrimino, all four of its squares are immediately visible to the player.  However, if a player quickly rotates a piece before it has time to fall, part of the piece will be temporarily hidden in the first two lines of the playing field. <br><br>  We usually think that the game ends when the heap reaches the top.  But in fact it is not so.  The game ends when it is no longer possible to create the next figure.  That is, before the appearance of the figure, all four cells of the playing field should be free, corresponding to the positions of the squares created by Tetrimino.  The figure may be blocked in place in such a way that some of its squares will appear in negatively numbered lines, and the game will not end;  however, in Nintendo Tetris, negative lines are an abstraction that only applies to active Tetrimino.  After the shape is blocked (becomes lying), only squares in lines from zero and more are written to the field.  Conceptually, it turns out that negatively numbered lines are automatically cleared after blocking.  But in reality, the game simply does not store this data, cutting off the upper parts of the figures. <br><br>  The visible area of ‚Äã‚Äãthe playing field 20 √ó 10 is stored at <code>$0400</code> in line-by-line order, each byte contains the value of the background tile.  Empty cells are indicated by a <code>$EF</code> tile, a solid black square. <br><br>  When creating a shape, three lookup tables are used.  If there is an arbitrary orientation ID, a table at <code>$9956</code> gives us an orientation ID when creating the corresponding type of tetrimino. <br><br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br>  Easier to show it in the table. <br><br><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Zh</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sh</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ih</code> </td> <td> <code>Ih</code> </td> </tr></tbody></table><br>  For example, all orientations of J are attached to <code>Jd</code> . <br><br>  The table at <code>$993B</code> contains a tetrimino type for the given orientation ID. <br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br>  For clarity, I will show everything in tabular form. <br><br><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>Z</code> </td> <td> <code>Z</code> </td> <td> <code>O</code> </td> <td> <code>S</code> </td> <td> <code>S</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>I</code> </td> <td> <code>I</code> </td> </tr></tbody></table><br>  We will look at the third lookup table in the next section. <br><br><h3>  Tetrimino Selection </h3><br>  In Nintendo Tetris, a pseudo-random number generator (PRNG) uses a 16-bit linear feedback shift register (LFSR) shift register in the Fibonacci configuration.  The 16-bit value is stored as big-endian at <code>$0017</code> - <code>$0018</code> .  As Seed an arbitrary number of <code>$8988</code> . <br><br> <code>80BC: LDX #$89 <br> 80BE: STX $0017 <br> 80C0: DEX <br> 80C1: STX $0018</code> <br> <br>  Each subsequent pseudo-random number is generated as follows: the value is perceived as a 17-bit number, and the most significant bit is obtained by performing XOR for bits 1 and 9. Then the value is shifted to the right, discarding the least significant bit. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a0/45d/3f2/3a045d3f2d64a94aa272aa15f351ac7a.png"></div><br>  This process takes place at <code>$AB47</code> . <br><br> <code>AB47: LDA $00,X <br> AB49: AND #$02 <br> AB4B: STA $0000 ; extract bit 1 <br> <br> AB4D: LDA $01,X <br> AB4F: AND #$02 ; extract bit 9 <br> <br> AB51: EOR $0000 <br> AB53: CLC <br> AB54: BEQ $AB57 <br> AB56: SEC ; XOR bits 1 and 9 together <br> <br> AB57: ROR $00,X <br> AB59: INX <br> AB5A: DEY ; right shift <br> AB5B: BNE $AB57 ; shifting in the XORed value <br> <br> AB5D: RTS ; return</code> <br> <br>  Interestingly, the parameters of the subroutine shown above can be set so that the calling function can specify the width of the shift register and the address at which it can be found in memory.  However, the same parameters are used everywhere, so we can assume that the developers somewhere have borrowed this code. <br><br>  For those who want to further modify the algorithm, I wrote it in Java. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit1 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit9 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> leftmostBit = bit1 ^ bit9; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (leftmostBit &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  And all this code can be pressed down to one line. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) ^ ((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>)) &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  This PRNG continuously and deterministically generates 32,767 unique values, starting each cycle from the initial seed.  This is one less than half of the possible numbers that can fit in a register, and any value in this set can be used as a seed.  Many of the values ‚Äã‚Äãoutside the set create a chain that will eventually lead to a number from the set.  However, some seed numbers result in an infinite sequence of zeros. <br><br>  To estimate the performance of this PRNG roughly, I generated a graphical representation of the values ‚Äã‚Äãit creates, based on a sentence with <a href="http://www.random.org/analysis/">RANDOM.ORG</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/254/477/bef/254477befbd14f540925a6d3169e5179.png"></div><br>  When creating an image, PRNG was used as a pseudo-random number generator, rather than 16-bit integers.  Each pixel is colored based on the value of bit 0. The image has a size of 128 √ó 256, that is, it covers the entire sequence. <br><br>  Except for the barely noticeable stripes on the top and left sides, it looks random.  No obvious patterns appear. <br><br>  After launching, the PRNG constantly shuffles the register, triggering at least once a frame.  This does not happen not only on the splash screen and menu screens, but also when tetrimino drops between the figure creation operations.  That is, the figure appearing next depends on the number of frames taken by the player to place the figure.  In fact, the game relies on the randomness of the actions of the person interacting with it. <br><br>  During the creation of the figure, the code at the address <code>$9907</code> , which selects the type of the new figure. <br><br> <code>9907: INC $001A ; spawnCount++; <br> <br> 9909: LDA $0017 ; index = high byte of randomValue; <br> <br> 990B: CLC <br> 990C: ADC $001A ; index += spawnCount; <br> <br> 990E: AND #$07 ; index &amp;= 7; <br> <br> 9910: CMP #$07 ; if (index == 7) { <br> 9912: BEQ $991C ; goto invalidIndex; <br> ; } <br> <br> 9914: TAX <br> 9915: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> 9918: CMP $0019 ; if (newSpawnID != spawnID) { <br> 991A: BNE $9938 ; goto useNewSpawnID; <br> ; } <br> <br> invalidIndex: <br> <br> 991C: LDX #$17 <br> 991E: LDY #$02 <br> 9920: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 9923: LDA $0017 ; index = high byte of randomValue; <br> <br> 9925: AND #$07 ; index &amp;= 7; <br> <br> 9927: CLC <br> 9928: ADC $0019 ; index += spawnID; <br> <br> 992A: CMP #$07 <br> 992C: BCC $9934 <br> 992E: SEC <br> 992F: SBC #$07 <br> 9931: JMP $992A ; index %= 7; <br> <br> 9934: TAX <br> 9935: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> useNewSpawnID: <br> <br> 9938: STA $0019 ; spawnID = newSpawnID; <br> <br> 993A: RTS ; return;</code> <br> <br>  At the address <code>$001A</code> stores the count of the number of shapes created with the power on.  The increment of the counter is performed by the first line of the subroutine, and since it is a single-byte counter, it returns to zero after every 256 figures.  Since the counter is not reset between games, the history of previous games affects the shape selection process.  This is another way the game uses the player as a source of randomness. <br><br>  The subroutine converts the most significant byte of a pseudo-random number ( <code>$0017</code> ) into a Tetrimino type and uses it as an index of the table located at <code>$994E</code> to convert the type to the shape creation ID orientation. <br><br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br>  At the first stage of the conversion, the counter of the created figures is added to the upper byte.  Then a mask is applied to save only the lower 3 bits.  If the result is not equal to 7, then this is the correct type of tetrimino, and if it is not the same as the previous selected shape, then the number is used as an index in the shape creation table.  Otherwise, the next pseudo-random number is generated and a mask is applied to obtain the lower 3 bits of the upper byte, and then the previous shape creation orientation ID is added.  Finally, a modular operation is performed to obtain the correct type of tetrimino, which is used as an index in the shape creation table. <br><br>  Since the processor does not support division with remainder, this operator is emulated by repeatedly subtracting 7, until the result is less than 7. Division with remainder is applied to the sum of the upper byte with the mask and the previous ID of creating the shape.  The maximum value of this sum is equal to 25. That is, in order to reduce it to the remainder of 4, only 3 iterations are required. <br><br>  At the beginning of each game, the shape creation ID ( <code>$0019</code> ) is initialized with a <code>Tu</code> value ( <code>$00</code> ).  This value can potentially be used at <code>$9928</code> at the time of the first shape creation. <br><br>  When used in the sum of the previous ID, the orientation of the shape creation, and not the previous type, Tetrimino adds distortion, because the values ‚Äã‚Äãof the orientation ID are not evenly distributed.  This is shown in the table: <br><br><table><tbody><tr><th>  $ 00 </th><th> <code>$02</code> </th> <th> <code>$07</code> </th> <th> <code>$08</code> </th> <th> <code>$0A</code> </th> <th> <code>$0B</code> </th> <th> <code>$0E</code> </th> <th> <code>$12</code> </th> </tr><tr><th>  0 </th><td>  2 </td><td>  0 </td><td>  one </td><td>  3 </td><td>  four </td><td>  0 </td><td>  four </td></tr><tr><th>  one </th><td>  3 </td><td>  one </td><td>  2 </td><td>  four </td><td>  five </td><td>  one </td><td>  five </td></tr><tr><th>  2 </th><td>  four </td><td>  2 </td><td>  3 </td><td>  five </td><td>  6 </td><td>  2 </td><td>  6 </td></tr><tr><th>  3 </th><td>  five </td><td>  3 </td><td>  four </td><td>  6 </td><td>  0 </td><td>  3 </td><td>  0 </td></tr><tr><th>  four </th><td>  6 </td><td>  four </td><td>  five </td><td>  0 </td><td>  one </td><td>  four </td><td>  one </td></tr><tr><th>  five </th><td>  0 </td><td>  five </td><td>  6 </td><td>  one </td><td>  2 </td><td>  five </td><td>  2 </td></tr><tr><th>  6 </th><td>  one </td><td>  6 </td><td>  0 </td><td>  2 </td><td>  3 </td><td>  6 </td><td>  3 </td></tr><tr><th>  7 </th><td>  2 </td><td>  0 </td><td>  one </td><td>  3 </td><td>  four </td><td>  0 </td><td>  four </td></tr></tbody></table><br>  Each cell contains a type of tetrimino, calculated by adding the orientation ID of the created figure (column) to the 3-bit value (line), and then applying the remainder of the division by 7 to the sum. Each line contains duplicates, because <code>$07</code> and <code>$0E</code> evenly divided by 7, and <code>$0B</code> and <code>$12</code> have a common remainder.  Lines 0 and 7 are the same because they are at a distance of 7. <br><br>  There are 56 possible input combinations, and if the resulting types of tetrimino are evenly distributed, then we can expect that in the table shown above each type should appear exactly 8 times.  But as shown below, it is not. <br><br><table><tbody><tr><th>  Type of </th><th>  Frequency </th></tr><tr><td>  T </td><td>  9 </td></tr><tr><td>  J </td><td>  eight </td></tr><tr><td>  Z </td><td>  eight </td></tr><tr><td>  O </td><td>  eight </td></tr><tr><td>  S </td><td>  9 </td></tr><tr><td>  L </td><td>  7 </td></tr><tr><td>  I </td><td>  7 </td></tr></tbody></table><br>  T and S appear more often, and L and I - less.  But skewed code using orientation ID is not executed every time a subroutine is called. <br><br>  Suppose that a PRNG does create a sequence of uniformly distributed statistical independent values.  In fact, this is a fair assumption, considering how the game tries to get the correct chance from the player‚Äôs actions.  Adding the number of created figures at <code>$990C</code> will not affect the distribution, because the number between calls increases evenly.  Applying a bitmask at <code>$990E</code> similar to applying division by 8 with a remainder, which also does not affect distribution.  Therefore, checking at <code>$9910</code> goes to <code>invalidIndex</code> in 1/8 of all cases.  And the probability of hitting when checking at <code>$9918</code> , where a new selected figure is compared with the previous figure, is 7/8, with a 1/7 probability of coincidence.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This means that there is an additional chance to </font></font><code>7/8 √ó 1/7 = 1/8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">be in </font></font><code>invalidIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In general, there is a probability of 25% use of the code with a skew and a probability of 75% of using the code that selects tetrimino evenly. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In a set of 224 created tetrimino, the expectation is 32 instances for each type. </font><font style="vertical-align: inherit;">But in fact, the code creates the following distribution:</font></font><br><br><table><tbody><tr><th>  Type of </th><th>  Frequency </th></tr><tr><td>  T </td><td>  33 </td></tr><tr><td>  J </td><td>  32 </td></tr><tr><td>  Z </td><td>  32 </td></tr><tr><td>  O </td><td>  32 </td></tr><tr><td>  S </td><td>  33 </td></tr><tr><td>  L </td><td>  31 </td></tr><tr><td>  I </td><td>  31 </td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, clearing 90 lines and reaching level 9, the player will receive one extra T and S and one less L and I than statistically expected. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetriminos are selected with the following probabilities:</font></font><br><br><table><tbody><tr><th>  Type of </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Probability </font></font></th></tr><tr><td>  T </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14.73% </font></font></td></tr><tr><td>  J </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14.29% </font></font></td></tr><tr><td>  Z </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14.29% </font></font></td></tr><tr><td>  O </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14.29% </font></font></td></tr><tr><td>  S </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14.73% </font></font></td></tr><tr><td>  L </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13.84% </font></font></td></tr><tr><td>  I </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13.84% </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It seems that in the statement that the ‚Äúlong stick‚Äù I never appears when it is needed, there is part of the truth (at least for Nintendo Tetris). </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino shift </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nintendo Tetris uses Delayed Auto Shift (DAS). </font><font style="vertical-align: inherit;">Pressing Left or Right instantly moves tetrimino one cell horizontally. </font><font style="vertical-align: inherit;">While holding one of these directional buttons causes the game to automatically move the piece every 6 frames with an initial delay of 16 frames. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This type of horizontal movement is controlled by the code at </font></font><code>$89AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As in the rotation code, a temporary variable is used here to back up the coordinates </font><font style="vertical-align: inherit;">in case the new position is wrong. </font><font style="vertical-align: inherit;">Notice that the check makes it difficult to move the piece while the player presses "Down".</font></font><br><br> <code>89AE: LDA $0040 <br> 89B0: STA $00AE ; originalX = tetriminoX; <br> <br> 89B2: LDA $00B6 ; if (pressing down) { <br> 89B4: AND #$04 ; return; <br> 89B6: BNE $8A09 ; } <br> <br> 89B8: LDA $00B5 ; if (just pressed left/right) { <br> 89BA: AND #$03 ; goto resetAutorepeatX; <br> 89BC: BNE $89D3 ; } <br> <br> 89BE: LDA $00B6 ; if (not pressing left/right) { <br> 89C0: AND #$03 ; return; <br> 89C2: BEQ $8A09 ; } <br> <br> 89C4: INC $0046 ; autorepeatX++; <br> 89C6: LDA $0046 ; if (autorepeatX &lt; 16) { <br> 89C8: CMP #$10 ; return; <br> 89CA: BMI $8A09 ; } <br> <br> 89CC: LDA #$0A <br> 89CE: STA $0046 ; autorepeatX = 10; <br> 89D0: JMP $89D7 ; goto buttonHeldDown; <br> <br> resetAutorepeatX: <br> <br> 89D3: LDA #$00 <br> 89D5: STA $0046 ; autorepeatX = 0; <br> <br> buttonHeldDown: <br> <br> 89D7: LDA $00B6 ; if (not pressing right) { <br> 89D9: AND #$01 ; goto notPressingRight; <br> 89DB: BEQ $89EC ; } <br> <br> 89DD: INC $0040 ; tetriminoX++; <br> 89DF: JSR $948B ; if (new position not valid) { <br> 89E2: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89E4: LDA #$03 <br> 89E6: STA $06F1 ; play shift sound effect; <br> 89E9: JMP $8A09 ; return; <br> <br> notPressingRight: <br> <br> 89EC: LDA $00B6 ; if (not pressing left) { <br> 89EE: AND #$02 ; return; <br> 89F0: BEQ $8A09 ; } <br> <br> 89F2: DEC $0040 ; tetriminoX--; <br> 89F4: JSR $948B ; if (new position not valid) { <br> 89F7: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89F9: LDA #$03 <br> 89FB: STA $06F1 ; play shift sound effect; <br> 89FE: JMP $8A09 ; return; <br> <br> restoreX: <br> <br> 8A01: LDA $00AE <br> 8A03: STA $0040 ; tetriminoX = originalX; <br> <br> 8A05: LDA #$10 <br> 8A07: STA $0046 ; autorepeatX = 16; <br> <br> 8A09: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>x</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino toss </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Automatic descent speed is a function of the level number. </font><font style="vertical-align: inherit;">Speeds are encoded as the number of rendered frames per descent in the table located at </font></font><code>$898E</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Since NES operates at 60.0988 frames / s, it is possible to calculate the period between descents and speed.</font></font><br><br><table><tbody><tr><th>  Level </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Frames on the descent </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Period (c / down) </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Speed ‚Äã‚Äã(cells / s) </font></font></th></tr><tr><td>  0 </td><td>  48 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .799 </font></font></td><td>  1.25 </td></tr><tr><td>  one </td><td>  43 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .715 </font></font></td><td>  1.40 </td></tr><tr><td>  2 </td><td>  38 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .632 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1.58 </font></font></td></tr><tr><td>  3 </td><td>  33 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .549 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1.82 </font></font></td></tr><tr><td>  four </td><td>  28 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .466 </font></font></td><td>  2.15 </td></tr><tr><td>  five </td><td>  23 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .383 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2.61 </font></font></td></tr><tr><td>  6 </td><td>  18 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .300 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3.34 </font></font></td></tr><tr><td>  7 </td><td>  13 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .216 </font></font></td><td>  4.62 </td></tr><tr><td>  eight </td><td>  eight </td><td>  .133 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7.51 </font></font></td></tr><tr><td>  9 </td><td>  6 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .100 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10.02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10‚Äì12 </font></font></td><td>  five </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .083 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12.02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13‚Äì15 </font></font></td><td>  four </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .067 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 15.05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16-18 </font></font></td><td>  3 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .050 </font></font></td><td>  20.03 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 19‚Äì28 </font></font></td><td>  2 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .033 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30.05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 29+ </font></font></td><td>  one </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .017 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 60.10 </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are 30 entries in the table. After level 29, the value of frames per descent is always 1. The </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integer number of frames per descent is not a particularly detailed way of describing speed. As shown in the graph below, the rate increases exponentially with each level. In fact, level 29 is twice as fast as level 28.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddd/18c/a29/ddd18ca2950f9055bd5f82108a4d3ddc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At 1 frame / descent, the player has no more than 1/3 of a second to position the piece before it starts moving. At this speed of descent, DAS does not allow the figure to reach the edges of the playing field before blocking in place, which means for most people a quick end to the game. However, some players, in particular, </font></font><a href="http://en.wikipedia.org/wiki/Thor_Aackerlund"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Toru Akerlund</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , managed to defeat DAS with a quick vibration of the cross buttons ( </font></font><code>D-pad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). In the shift code shown above, it can be seen that while the horizontal direction button is released through the frame, it is possible to shift tetrimino at levels 29 and above with half the frequency. This is a theoretical maximum, but any thumb vibration above 3.75 taps can defeat an initial delay of 16 frames.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the automatic and player controlled descent (by pressing "Down") coincide and occur in one frame, the effect does not add up. Either or both of these events cause the shape to drop down exactly one cell in this frame. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The descent control logic is located at </font></font><code>$8914</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The table of frames for descent is below the mark </font><font style="vertical-align: inherit;">. As stated above, at level 29 and above, the rate is always 1 descent / frame. </font><font style="vertical-align: inherit;">(address </font><font style="vertical-align: inherit;">) starts the descent when it reaches </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">). The increment </font><font style="vertical-align: inherit;">is performed at an address </font><font style="vertical-align: inherit;">outside of this code fragment. With automatic or controlled descent, it is reset to 0. The </font><font style="vertical-align: inherit;">variable </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) is initialized with the value </font><font style="vertical-align: inherit;">(at the address</font></font><br><br> <code>8914: LDA $004E ; if (autorepeatY &gt; 0) { <br> 8916: BPL $8922 ; goto autorepeating; <br> ; } else if (autorepeatY == 0) { <br> ; goto playing; <br> ; } <br> <br> ; game just started <br> ; initial Tetrimino hanging at spawn point <br> <br> 8918: LDA $00B5 ; if (not just pressed down) { <br> 891A: AND #$04 ; goto incrementAutorepeatY; <br> 891C: BEQ $8989 ; } <br> <br> ; player just pressed down ending startup delay <br> <br> 891E: LDA #$00 <br> 8920: STA $004E ; autorepeatY = 0; <br> 8922: BNE $8939 <br> <br> playing: <br> <br> 8924: LDA $00B6 ; if (left or right pressed) { <br> 8926: AND #$03 ; goto lookupDropSpeed; <br> 8928: BNE $8973 ; } <br> <br> ; left/right not pressed <br> <br> 892A: LDA $00B5 <br> 892C: AND #$0F ; if (not just pressed only down) { <br> 892E: CMP #$04 ; goto lookupDropSpeed; <br> 8930: BNE $8973 ; } <br> <br> ; player exclusively just presssed down <br> <br> 8932: LDA #$01 <br> 8934: STA $004E ; autorepeatY = 1; <br> <br> 8936: JMP $8973 ; goto lookupDropSpeed; <br> <br> autorepeating: <br> <br> 8939: LDA $00B6 <br> 893B: AND #$0F ; if (down pressed and not left/right) { <br> 893D: CMP #$04 ; goto downPressed; <br> 893F: BEQ $894A ; } <br> <br> ; down released <br> <br> 8941: LDA #$00 <br> 8943: STA $004E ; autorepeatY = 0 <br> 8945: STA $004F ; holdDownPoints = 0 <br> 8947: JMP $8973 ; goto lookupDropSpeed; <br> <br> downPressed: <br> <br> 894A: INC $004E ; autorepeatY++; <br> 894C: LDA $004E <br> 894E: CMP #$03 ; if (autorepeatY &lt; 3) { <br> 8950: BCC $8973 ; goto lookupDropSpeed; <br> ; } <br> <br> 8952: LDA #$01 <br> 8954: STA $004E ; autorepeatY = 1; <br> <br> 8956: INC $004F ; holdDownPoints++; <br> <br> drop: <br> <br> 8958: LDA #$00 <br> 895A: STA $0045 ; fallTimer = 0; <br> <br> 895C: LDA $0041 <br> 895E: STA $00AE ; originalY = tetriminoY; <br> <br> 8960: INC $0041 ; tetriminoY++; <br> 8962: JSR $948B ; if (new position valid) { <br> 8965: BEQ $8972 ; return; <br> ; } <br> <br> ; the piece is locked <br> <br> 8967: LDA $00AE <br> 8969: STA $0041 ; tetriminoY = originalY; <br> <br> 896B: LDA #$02 <br> 896D: STA $0048 ; playState = UPDATE_PLAYFIELD; <br> 896F: JSR $9CAF ; updatePlayfield(); <br> <br> 8972: RTS ; return; <br> <br> lookupDropSpeed: <br> <br> 8973: LDA #$01 ; tempSpeed = 1; <br> <br> 8975: LDX $0044 ; if (level &gt;= 29) { <br> 8977: CPX #$1D ; goto noTableLookup; <br> 8979: BCS $897E ; } <br> <br> 897B: LDA $898E,X ; tempSpeed = framesPerDropTable[level]; <br> <br> noTableLookup: <br> <br> 897E: STA $00AF ; dropSpeed = tempSpeed; <br> <br> 8980: LDA $0045 ; if (fallTimer &gt;= dropSpeed) { <br> 8982: CMP $00AF ; goto drop; <br> 8984: BPL $8958 ; } <br> <br> 8986: JMP $8972 ; return; <br> <br> incrementAutorepeatY: <br> <br> 8989: INC $004E ; autorepeatY++; <br> 898B: JMP $8972 ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>lookupDropSpeed</code><font style="vertical-align: inherit;"></font><br><br> <code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$0045</code><font style="vertical-align: inherit;"></font><code>dropSpeed</code><font style="vertical-align: inherit;"></font><code>$00AF</code><font style="vertical-align: inherit;"></font><code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$8892</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>autorepeatY</code><font style="vertical-align: inherit;"></font><code>$004E</code><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><code>$8739</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), which is interpreted as ‚àí96. The condition at the very beginning causes an initial delay. The very first tetrimino remains exposed in the air at the point of creation until </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it </font><font style="vertical-align: inherit;">rises </font><font style="vertical-align: inherit;">to 0, which takes 1.6 seconds. However, when you press "Down" in this phase, it is </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">instantly assigned 0. It is interesting that you can move and rotate the figure in this phase of the initial delay, without canceling it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The increment </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is performed while holding down. When it reaches 3, a man-controlled descent occurs (‚Äúsoft‚Äù descent) and is </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assigned 1. Therefore, the initial soft descent requires 3 frames, but then it repeats in each frame. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, it </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">increases from 0 to 1 only when the game recognizes that the player has just pressed "Down" (at</font></font><code>$00B5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), but does not recognize holding down. This is important because it is </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reset to 0 when creating tetrimino (at </font></font><code>$98E8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), which creates an important feature: if the player himself lowers the figure and it is blocked, and he continues to press "Down" when creating the next figure, which often occurs at high levels, This will not lead to a soft descent of a new figure. To make it happen, the player must release the "Down", and then press the button again. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Potentially soft descent can increase the number of points. </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$004F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) increases with each descent, but when you press "Down" is reset to 0. Therefore, for a set of points it is necessary to lower the tetrimino into the lock by a soft descent. Short-term soft descent, which can occur in the way of the figure, does not affect the glasses. The account is updated at</font></font><code>$9BFE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and is </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reset to 0 shortly thereafter, at </font></font><code>$9C2F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A check that prevents a player from performing a soft descent during a horizontal shift of a figure complicates the set of points. It means that the last move before blocking a piece in place must be ‚ÄúDown‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When a descent occurs, </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0041</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) is copied to </font></font><code>originalY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). If the new position created by the increment </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">turns out to be wrong (that is, the figure is either pushed through the floor of the playing field, or superimposed on the squares already lying), then the tetrimino remains in the previous position. In this case, is restored</font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the figure is considered blocked. </font><font style="vertical-align: inherit;">This means that the delay before blocking (the maximum number of frames that a tetrimino expects, keeping itself in the air before blocking) is equal to the delay of descent. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hard descent (instant figure drop) is not supported in Nintendo Tetris.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sliding and scrolling </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The Nintendo Tetris handbook has an illustrated example of how to do a slip: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f6f/4bb/647/f6f4bb647937094d3d68fae530b0bfd4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sliding consists of shifting along the surface of other pieces or along the floor of the playing field. </font><font style="vertical-align: inherit;">It is usually used to stick a piece under a hanging square. </font><font style="vertical-align: inherit;">The slide can be performed until the drop timer reaches the speed of descent, after which the figure will be locked in place. </font><font style="vertical-align: inherit;">Below is an animated example.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/9f5/022/efe9f502248d4185409fc20db3a47647.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On the other hand, scrolling allows you to stick figures into spaces that cannot be reached in any other way (see below). </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/ca5/350/c53ca53509826b9f2c462c0290ffa9c9.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Like sliding, scrolling is impossible without blocking delay. </font><font style="vertical-align: inherit;">But beyond that, scrolling exploits the way in which the game manipulates figures. </font><font style="vertical-align: inherit;">Before moving or rotating the figure, the game checks that after changing the position, all the squares of tetrimino will be in empty cells within the boundaries of the playing field. </font><font style="vertical-align: inherit;">Such a check, as shown below, does not prevent rotation through the nearest filled blocks. </font><font style="vertical-align: inherit;">As stated in the ‚ÄúTetrimino Description‚Äù section, each row of the orientation table contains 12 bytes; </font><font style="vertical-align: inherit;">therefore, the index in this table is calculated by multiplying the active orientation Tetrimino ID by 12. As shown below, all multiplications in the subroutine are performed using shifts and addition.</font></font><br><br> <code>948B: LDA $0041 <br> 948D: ASL <br> 948E: STA $00A8 <br> 9490: ASL <br> 9491: ASL <br> 9492: CLC <br> 9493: ADC $00A8 <br> 9495: ADC $0040 <br> 9497: STA $00A8 <br> <br> 9499: LDA $0042 <br> 949B: ASL <br> 949C: ASL <br> 949D: STA $00A9 <br> 949F: ASL <br> 94A0: CLC <br> 94A1: ADC $00A9 <br> 94A3: TAX ; index = 12 * orientationID; <br> 94A4: LDY #$00 <br> <br> 94A6: LDA #$04 <br> 94A8: STA $00AA ; for(i = 0; i &lt; 4; i++) { <br> <br> 94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY &lt; -2 || cellY &gt;= 20) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; } <br> <br> 94B6: LDA $8A9C,X <br> 94B9: ASL <br> 94BA: STA $00AB <br> 94BC: ASL <br> 94BD: ASL <br> 94BE: CLC <br> 94BF: ADC $00AB <br> 94C1: CLC <br> 94C2: ADC $00A8 <br> 94C4: STA $00AD <br> <br> 94C6: INX <br> 94C7: INX ; index += 2; <br> <br> 94C8: LDA $8A9C,X ; squareX = orientationTable[index]; <br> 94CB: CLC <br> 94CC: ADC $00AD <br> 94CE: TAY ; cellX = squareX + tetriminoX; <br> 94CF: LDA ($B8),Y ; if (playfield[10 * cellY + cellX] != EMPTY_TILE) { <br> 94D1: CMP #$EF ; return false; <br> 94D3: BCC $94E9 ; } <br> <br> 94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &lt; 0 || cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; } <br> <br> 94DF: INX ; index++; <br> 94E0: DEC $00AA <br> 94E2: BNE $94AA ; } <br> <br> 94E4: LDA #$00 <br> 94E6: STA $00A8 <br> 94E8: RTS ; return true; <br> <br> 94E9: LDA #$FF <br> 94EB: STA $00A8 <br> 94ED: RTS</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>index = (orientationID &lt;&lt; 3) + (orientationID &lt;&lt; 2); // index = 8 * orientationID + 4 * orientationID; <br> <br> (cellY &lt;&lt; 3) + (cellY &lt;&lt; 1) // 8 * cellY + 2 * cellY</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Each iteration of the cycle shifts the position of the tetrimino by the relative coordinates of one of the squares from the orientation table in order to obtain the corresponding position of the cell on the playing field. She then checks that the coordinates of the cell are within the boundaries of the playing field, and that the cell itself is empty. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The comments describe more clearly the way in which line spacing checks are performed. </font><font style="vertical-align: inherit;">In addition to the cells in the visible lines, the code considers two hidden lines above the playing field as the legal positions of the squares without using the compound condition. This works because in the </font><a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25BE%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25B4"><font style="vertical-align: inherit;">additional code the</font></a><font style="vertical-align: inherit;"> negative numbers represented by single-byte variables are equivalent to values ‚Äã‚Äãgreater than 127. In this case, the minimum value </font><font style="vertical-align: inherit;">is ‚àí2, which is stored as</font></font><br><br> <code>94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY + 2 &gt;= 22) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25BE%25D0%25BF%25D0%25BE%25D0%25BB%25D0%25BD%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25B4"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>cellY</code><font style="vertical-align: inherit;"></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(254 in decimal). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The playing field index is the amount </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplied by 10 and </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. However, when </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">equal to ‚àí1 ( </font></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 255) or ‚àí2 ( </font></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 254), the result is ‚àí10 ( </font></font><code>$F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 246) and ‚àí20 ( </font></font><code>$EC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 236). Being in the interval, it </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be no more than 9, which gives a maximum index of 246 + 9 = 255, and this is much further than the end of the playing field. However, the game initializes </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with a value </font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(empty tile), creating another 56 additional bytes of empty space. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is strange that the interval check</font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performed after examining the cell of the playing field. </font><font style="vertical-align: inherit;">But it works correctly in any order. </font><font style="vertical-align: inherit;">In addition, the interval check avoids a compound condition, as indicated below in the commentary. </font><font style="vertical-align: inherit;">The scrolling examples shown below are possible due to the way this code checks positions.</font></font><br><br> <code>94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45f/c2d/dc0/45fc2ddc0d156d534aad4fd065b86aa4.gif"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/15f/185/0db/15f1850dbfca0b491498e8d81ab03877.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As shown below, you can even perform a slide with scrolling. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08f/74c/c78/08f74cc7825cd53d5a8002b8e33c4612.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The AI ‚Äã‚Äãuses all the movement capabilities available in Nintendo Tetris, including sliding and scrolling. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Level 30 and above </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> After reaching level 30 it seems that the level is reset to zero. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/feb/fee/b1f/febfeeb1faafda1a70f5da385c2276ac.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> But level 31 shows that something else is happening: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/26e/057/20c/26e05720ca15aa302a0b61e09498e5a0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The displayed level values ‚Äã‚Äãare located in the table at </font></font><code>$96B8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <code>96B8: 00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As shown below, the pattern table is ordered in such a way that tiles with </font></font><code>$00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>$0F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are glyphs for characters from </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. This means that when displaying a digit of a decimal or hexadecimal number, the value of the digit itself is used as the index of the pattern table. In our case, the values ‚Äã‚Äãof the levels are stored as a binary-decimal code (binary-coded decimal, BCD); each nibble of each byte in the sequence is a tile value.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, it seems that the game designers assumed that no one would pass level 29, and therefore decided to insert only 30 records into the table. Strange display values ‚Äã‚Äãare different bytes after the table. To indicate the level number, only one byte is used (at the address </font></font><code>$0044</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), which is why the game slowly cycles around the 256 values ‚Äã‚Äãshown below.</font></font><br><br><table><tbody><tr><th> <code>00</code> </th> <th> <code>0</code> </th> <th> <code>1</code> </th> <th> <code>2</code> </th> <th> <code>3</code> </th> <th> <code>4</code> </th> <th> <code>5</code> </th> <th> <code>6</code> </th> <th> <code>7</code> </th> <th> <code>8</code> </th> <th> <code>9</code> </th> <th> <code>A</code> </th> <th> <code>B</code> </th> <th> <code>C</code> </th> <th> <code>D</code> </th> <th> <code>E</code> </th> <th> <code>F</code> </th> </tr><tr><th> <code>0</code> </th> <td> <code>00</code> </td> <td> <code>01</code> </td> <td> <code>02</code> </td> <td> <code>03</code> </td> <td> <code>04</code> </td> <td> <code>05</code> </td> <td> <code>06</code> </td> <td> <code>07</code> </td> <td> <code>08</code> </td> <td> <code>09</code> </td> <td> <code>10</code> </td> <td> <code>11</code> </td> <td> <code>12</code> </td> <td> <code>13</code> </td> <td> <code>14</code> </td> <td> <code>15</code> </td> </tr><tr><th> <code>1</code> </th> <td> <code>16</code> </td> <td> <code>17</code> </td> <td> <code>18</code> </td> <td> <code>19</code> </td> <td> <code>20</code> </td> <td> <code>21</code> </td> <td> <code>22</code> </td> <td> <code>23</code> </td> <td> <code>24</code> </td> <td> <code>25</code> </td> <td> <code>26</code> </td> <td> <code>27</code> </td> <td> <code>28</code> </td> <td> <code>29</code> </td> <td> <code>00</code> </td> <td> <code>0A</code> </td> </tr><tr><th> <code>2</code> </th> <td> <code>14</code> </td> <td> <code>1E</code> </td> <td> <code>28</code> </td> <td> <code>32</code> </td> <td> <code>3C</code> </td> <td> <code>46</code> </td> <td> <code>50</code> </td> <td> <code>5A</code> </td> <td> <code>64</code> </td> <td> <code>6E</code> </td> <td> <code>78</code> </td> <td> <code>82</code> </td> <td> <code>8C</code> </td> <td> <code>96</code> </td> <td> <code>A0</code> </td> <td> <code>AA</code> </td> </tr><tr><th> <code>3</code> </th> <td> <code>B4</code> </td> <td> <code>BE</code> </td> <td> <code>C6</code> </td> <td> <code>20</code> </td> <td> <code>E6</code> </td> <td> <code>20</code> </td> <td> <code>06</code> </td> <td> <code>21</code> </td> <td> <code>26</code> </td> <td> <code>21</code> </td> <td> <code>46</code> </td> <td> <code>21</code> </td> <td> <code>66</code> </td> <td> <code>21</code> </td> <td> <code>86</code> </td> <td> <code>21</code> </td> </tr><tr><th> <code>4</code> </th> <td> <code>A6</code> </td> <td> <code>21</code> </td> <td> <code>C6</code> </td> <td> <code>21</code> </td> <td> <code>E6</code> </td> <td> <code>21</code> </td> <td> <code>06</code> </td> <td> <code>22</code> </td> <td> <code>26</code> </td> <td> <code>22</code> </td> <td> <code>46</code> </td> <td> <code>22</code> </td> <td> <code>66</code> </td> <td> <code>22</code> </td> <td> <code>86</code> </td> <td> <code>22</code> </td> </tr><tr><th> <code>5</code> </th> <td> <code>A6</code> </td> <td> <code>22</code> </td> <td> <code>C6</code> </td> <td> <code>22</code> </td> <td> <code>E6</code> </td> <td> <code>22</code> </td> <td> <code>06</code> </td> <td> <code>23</code> </td> <td> <code>26</code> </td> <td> <code>23</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>F0</code> </td> <td> <code>4A</code> </td> <td> <code>4A</code> </td> </tr><tr><th> <code>6</code> </th> <td> <code>4A</code> </td> <td> <code>4A</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>0F</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>60</code> </td> <td> <code>A6</code> </td> <td> <code>49</code> </td> <td> <code>E0</code> </td> </tr><tr><th> <code>7</code> </th> <td> <code>15</code> </td> <td> <code>10</code> </td> <td> <code>53</code> </td> <td> <code>BD</code> </td> <td> <code>D6</code> </td> <td> <code>96</code> </td> <td> <code>A8</code> </td> <td> <code>8A</code> </td> <td> <code>0A</code> </td> <td> <code>AA</code> </td> <td> <code>E8</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> </tr><tr><th> <code>8</code> </th> <td> <code>20</code> </td> <td> <code>CA</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>F0</code> </td> <td> <code>1E</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> <td> <code>C9</code> </td> <td> <code>05</code> </td> <td> <code>F0</code> </td> <td> <code>0C</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> </tr><tr><th> <code>9</code> </th> <td> <code>96</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>0C</code> </td> </tr><tr><th> <code>A</code> </th> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>A2</code> </td> </tr><tr><th> <code>B</code> </th> <td> <code>0A</code> </td> <td> <code>B1</code> </td> <td> <code>B8</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>C8</code> </td> <td> <code>CA</code> </td> <td> <code>D0</code> </td> <td> <code>F7</code> </td> <td> <code>E6</code> </td> <td> <code>49</code> </td> <td> <code>A5</code> </td> <td> <code>49</code> </td> <td> <code>C9</code> </td> <td> <code>14</code> </td> </tr><tr><th> <code>C</code> </th> <td> <code>30</code> </td> <td> <code>04</code> </td> <td> <code>A9</code> </td> <td> <code>20</code> </td> <td> <code>85</code> </td> <td> <code>49</code> </td> <td> <code>60</code> </td> <td> <code>A5</code> </td> <td> <code>B1</code> </td> <td> <code>29</code> </td> <td> <code>03</code> </td> <td> <code>D0</code> </td> <td> <code>78</code> </td> <td> <code>A9</code> </td> <td> <code>00</code> </td> <td> <code>85</code> </td> </tr><tr><th> <code>D</code> </th> <td> <code>AA</code> </td> <td> <code>A6</code> </td> <td> <code>AA</code> </td> <td> <code>B5</code> </td> <td> <code>4A</code> </td> <td> <code>F0</code> </td> <td> <code>5C</code> </td> <td> <code>0A</code> </td> <td> <code>A8</code> </td> <td> <code>B9</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> </tr><tr><th> <code>E</code> </th> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> </tr><tr><th> <code>F</code> </th> <td> <code>C9</code> </td> <td> <code>04</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> </tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first 20 ordinal values ‚Äã‚Äãare actually another table in which the offsets on the playing field for each of the 20 rows are stored. </font><font style="vertical-align: inherit;">Since the playing field starts with </font><font style="vertical-align: inherit;">and each row contains 10 cells, the address of an arbitrary cell is: </font><font style="vertical-align: inherit;">Given that the processor does not directly multiply, this lookup table provides an extremely fast way to get the piece. </font><font style="vertical-align: inherit;">The corresponding table is the next 40 bytes. </font><font style="vertical-align: inherit;">It contains 20 addresses in little endian format for a nametable 0 (a VRAM memory area containing background tile values). </font><font style="vertical-align: inherit;">They are pointers to the playing field offset lines on </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The remaining bytes, of which the displayed level values ‚Äã‚Äãare composed, are instructions.</font></font><br><br> <code>96D6: 00 ; 0 <br> 96D7: 0A ; 10 <br> 96D8: 14 ; 20 <br> 96D9: 1E ; 30 <br> 96DA: 28 ; 40 <br> 96DB: 32 ; 50 <br> 96DC: 3C ; 60 <br> 96DD: 46 ; 70 <br> 96DE: 50 ; 80 <br> 96DF: 5A ; 90 <br> 96E0: 64 ; 100 <br> 96E1: 6E ; 110 <br> 96E2: 78 ; 120 <br> 96E3: 82 ; 130 <br> 96E4: 8C ; 140 <br> 96E5: 96 ; 150 <br> 96E6: A0 ; 160 <br> 96E7: AA ; 170 <br> 96E8: B4 ; 180 <br> 96E9: BE ; 190</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0400</code><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + 10 * y + x</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + [$96D6 + y] + x</code> <br> <br><font style="vertical-align: inherit;"></font><code>$06</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rows and statistics </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The number of filled rows and tetrimino statistics occupy 2 bytes each at the following addresses. </font></font><br><br><table><tbody><tr><th>  Addresses </th><th>  amount </th></tr><tr><td> <code>0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>0051</code> </td><td>  Rows </td></tr><tr><td> <code>03F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F1</code> </td><td>  T </td></tr><tr><td> <code>03F2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F3</code> </td><td>  J </td></tr><tr><td> <code>03F4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F5</code> </td><td>  Z </td></tr><tr><td> <code>03F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F7</code> </td><td>  O </td></tr><tr><td> <code>03F8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F9</code> </td><td>  S </td></tr><tr><td> <code>03FA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FB</code> </td><td>  L </td></tr><tr><td> <code>03FC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FD</code> </td><td>  I </td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essentially, these values ‚Äã‚Äãare stored as 16-bit packed BCD little endian. </font><font style="vertical-align: inherit;">For example, below is the number of rows equal to 123. The bytes are counted from right to left for the decimal digits to go in order.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f4/68b/c0e/4f468bc0e6f22afe40d74f1711bad46e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, the game designers assumed that none of the values ‚Äã‚Äãwould be greater than 999. Therefore, the display logic correctly processes the first byte as a packed BCD, where each nibble is used as a tile value. </font><font style="vertical-align: inherit;">But the entire second byte is actually used as the top decimal digit. </font><font style="vertical-align: inherit;">When the bottom digits go from </font></font><code>99</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the usual increment of the second byte occurs. </font><font style="vertical-align: inherit;">As a result, the second byte cycles through all 256 tiles. </font><font style="vertical-align: inherit;">Below is an example of this.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c7/b4a/d52/6c7b4ad52a59641b8c2e04971415f0df.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After the row is cleared, the following code is executed to increment the number of rows. </font><font style="vertical-align: inherit;">Checks are performed for the middle and lower digits so that they remain in the range from 0 to 9. But the upper digit can be increased indefinitely. </font><font style="vertical-align: inherit;">If after the increment of the number of rows, the lower digit is 0, then this means that the player has just completed a set of 10 rows and you need to increase the level number. As can be seen from the code below, an additional check is performed before the increment of the level. </font><font style="vertical-align: inherit;">The second check is related to the selected initial level. To go to any level </font><font style="vertical-align: inherit;">, regardless of the initial level, the player must clear</font></font><br><br> <code>9BA8: INC $0050 ; increment middle-lowest digit pair <br> 9BAA: LDA $0050 <br> 9BAC: AND #$0F <br> 9BAE: CMP #$0A ; if (lowest digit &gt; 9) { <br> 9BB0: BMI $9BC7 <br> 9BB2: LDA $0050 <br> 9BB4: CLC <br> 9BB5: ADC #$06 ; set lowest digit to 0, increment middle digit <br> 9BB7: STA $0050 <br> 9BB9: AND #$F0 <br> 9BBB: CMP #$A0 ; if (middle digit &gt; 9) { <br> 9BBD: BCC $9BC7 <br> 9BBF: LDA $0050 <br> 9BC1: AND #$0F <br> 9BC3: STA $0050 ; set middle digit to 0 <br> 9BC5: INC $0051 ; increment highest digit <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9BC7: LDA $0050 <br> 9BC9: AND #$0F <br> 9BCB: BNE $9BFB ; if (lowest digit == 0) { <br> 9BCD: JMP $9BD0 <br> <br> 9BD0: LDA $0051 <br> 9BD2: STA $00A9 <br> 9BD4: LDA $0050 <br> 9BD6: STA $00A8 ; copy digits from $0050-$0051 to $00A8-$00A9 <br> <br> 9BD8: LSR $00A9 <br> 9BDA: ROR $00A8 <br> 9BDC: LSR $00A9 <br> 9BDE: ROR $00A8 <br> 9BE0: LSR $00A9 <br> 9BE2: ROR $00A8 ; treat $00A8-$00A9 as a 16-bit packed BCD value <br> 9BE4: LSR $00A9 ; and right-shift it 4 times <br> 9BE6: ROR $00A8 ; this leaves the highest and middle digits in $00A8 <br> <br> 9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level &lt; [$00A8]) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>X</code><font style="vertical-align: inherit;"></font><code>10X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lines. For example, if a player starts from level 5, he will remain on him until he has cleared 60 lines, after which he will go to level 6. After that, every additional 10 lines will result in an increment of level numbers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To perform this check, the value of the filled rows is copied from </font></font><code>$0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Then the copy is shifted 4 times to the right, which for a packed BCD is similar to division by 10. The youngest decimal digit is discarded, and the highest and middle digits are shifted by one position, as a result becoming nibbles </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e4/c0b/2e7/8e4c0b2e7d53a33d54cea8717a872a65.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, at the address </font></font><code>$9BEA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the level number is directly compared with the BCD's packed value </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. There is no search in the table for converting the BCD value to decimal, and this is an obvious error. For example, in the picture shown above, the level number should be compared with </font></font><code>$12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(18 in decimal), and not with 12. Therefore, if a player decides to start at level 17, then the level will actually go to 120 rows, because 18 is greater than 17. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The table shows the expected number of rows required for the transition at each initial level. It is compared with the fact that because of the bug is actually happening.</font></font><br><br><table><tbody><tr><th> <code> </code> </th> <td>  0 </td><td>  one </td><td>  2 </td><td>  3 </td><td>  four </td><td>  five </td><td>  6 </td><td>  7 </td><td>  eight </td><td>  9 </td><td>  ten </td><td>  eleven </td><td>  12 </td><td>  13 </td><td>  14 </td><td>  15 </td><td>  sixteen </td><td>  17 </td><td>  18 </td><td>  nineteen </td></tr><tr><th> <code>  </code> </th> <td>  ten </td><td>  20 </td><td>  thirty </td><td>  40 </td><td>  50 </td><td>  60 </td><td>  70 </td><td>  80 </td><td>  90 </td><td>  100 </td><td>  110 </td><td>  120 </td><td>  130 </td><td>  140 </td><td>  150 </td><td>  160 </td><td>  170 </td><td>  180 </td><td>  190 </td><td>  200 </td></tr><tr><th> <code>    </code> </th> <td>  ten </td><td>  20 </td><td>  thirty </td><td>  40 </td><td>  50 </td><td>  60 </td><td>  70 </td><td>  80 </td><td>  90 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  110 </td><td>  120 </td><td>  130 </td><td>  140 </td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The expected number coincides with the true for the initial levels of 0‚Äì9. </font><font style="vertical-align: inherit;">In fact, the coincidence for entry level 9 is random; </font><font style="vertical-align: inherit;">10‚Äì15 also moves to the next level with 100 rows, because it </font></font><code>$10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is 16 in decimal form. </font><font style="vertical-align: inherit;">The largest difference between the expected and actual is 60 rows. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I suspect that the bug is related to design changes in the later stages of development. </font><font style="vertical-align: inherit;">Look at the menu screen, which allows the player to choose the starting level.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/858/51e/019/85851e019d65bf00d265fa4ea277b8c2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is no explanation of how to start with levels above 9. But in the Nintendo Tetris guide booklet this secret is revealed: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c20/cee/c3b/c20ceec3b4b30879812be109b6666b79.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It seems that this hidden feature was invented at the last moment. Perhaps it was added very close to the release date, which made it impossible to fully test it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, the verification of the initial series contains a second error associated with the output of values ‚Äã‚Äãfor the interval. Below are the comments in the code that best explain what is happening at a low level. </font><font style="vertical-align: inherit;">The comparison is performed by subtracting and checking the sign of the result. But the signed one-byte number is limited to the interval from ‚àí128 to 127. If the difference is less than ‚àí128, the number is transferred and the result becomes a positive number. This principle is explained in the comments to the code. </font><font style="vertical-align: inherit;">When checking that the difference is in this interval, you need to take into account that the level number with increment to values ‚Äã‚Äãgreater than 255 performs a transfer to 0, and</font></font><br><br> <code>9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level - [$00A8] &lt; 0) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9BE8: LDA $0044 ; difference = level - [$00A8]; <br> 9BEA: CMP $00A8 ; if (difference &lt; 0 &amp;&amp; difference &gt;= -128) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can potentially contain any value, because its upper nibble is taken from </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the increment of which can occur indefinitely. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These effects overlap, creating periods in which the level number erroneously remains unchanged. </font><font style="vertical-align: inherit;">Periods occur at regular intervals of 2,900 rows, starting at 2,190 rows, and last for 800 rows. </font><font style="vertical-align: inherit;">For example, from 2190 ( </font></font><code>L90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) to 2990 ( </font></font><code>T90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) the level remains equal to </font></font><code>$DB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>96</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), as shown below.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/055/e15/8de/055e158de2ecde24e0f052cd325bef32.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next period happens from 5090 to 5890, the level is constantly equal to </font></font><code>$AD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">In addition, during these periods the color palette also does not change.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Coloring Tetrimino </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At each level, tetrimino tiles are assigned 4 unique colors. </font><font style="vertical-align: inherit;">Colors are taken from the table located at </font></font><code>$984C</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Her records are reused every 10 levels. </font><font style="vertical-align: inherit;">From left to right: the columns of the table correspond to the black, white, blue and red areas of the image shown below.</font></font><br><br> <code>984C: 0F 30 21 12 ; level 0 <br> 9850: 0F 30 29 1A ; level 1 <br> 9854: 0F 30 24 14 ; level 2 <br> 9858: 0F 30 2A 12 ; level 3 <br> 985C: 0F 30 2B 15 ; level 4 <br> 9860: 0F 30 22 2B ; level 5 <br> 9864: 0F 30 00 16 ; level 6 <br> 9868: 0F 30 05 13 ; level 7 <br> 986C: 0F 30 16 12 ; level 8 <br> 9870: 0F 30 27 16 ; level 9</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68e/fc4/7d7/68efc47d771e9c673b003d76810d74fb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Values ‚Äã‚Äãcorrespond to the NES color palette. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e80/c0a/8b6/e80c0a8b624b90261042d71eb21d50db.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first 2 colors of each record are always black and white. However, in fact, the first color is ignored; regardless of the value, it is considered to be a transparent color through which a solid black background peeps through. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Access to the color table is performed in the subroutine at </font></font><code>$9808</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The index of the color table is based on the level number divided by the remainder by 10. The cycle copies the record to the palette tables in the VRAM memory. </font><font style="vertical-align: inherit;">The division with the remainder is emulated by a constant subtraction of 10 until the result is less than 10. Below is shown the beginning of the subroutine with comments.</font></font><br><br> <code>9808: LDA $0064 <br> 980A: CMP #$0A <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A <br> 9811: JMP $980A ; index = levelNumber % 10; <br> <br> 9814: ASL <br> 9815: ASL <br> 9816: TAX ; index *= 4; <br> <br> 9817: LDA #$00 <br> 9819: STA $00A8 ; for(i = 0; i &lt; 32; i += 16) { <br> <br> 981B: LDA #$3F <br> 981D: STA $2006 <br> 9820: LDA #$08 <br> 9822: CLC <br> 9823: ADC $00A8 <br> 9825: STA $2006 ; palette = $3F00 + i + 8; <br> <br> 9828: LDA $984C,X <br> 982B: STA $2007 ; palette[0] = colorTable[index + 0]; <br> <br> 982E: LDA $984D,X <br> 9831: STA $2007 ; palette[1] = colorTable[index + 1]; <br> <br> 9834: LDA $984E,X <br> 9837: STA $2007 ; palette[2] = colorTable[index + 2]; <br> <br> 983A: LDA $984F,X <br> 983D: STA $2007 ; palette[3] = colorTable[index + 3]; <br> <br> 9840: LDA $00A8 <br> 9842: CLC <br> 9843: ADC #$10 <br> 9845: STA $00A8 <br> 9847: CMP #$20 <br> 9849: BNE $981B ; } <br> <br> 984B: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">However, as mentioned in the previous section, subtraction and branching based on the sign of the difference is used in comparison. </font><font style="vertical-align: inherit;">A signed single-byte number is limited to an interval from ‚àí128 to 127. The updated comments below reflect this principle. </font><font style="vertical-align: inherit;">The comments below are even more simplified. </font><font style="vertical-align: inherit;">Such a formulation reveals an error in the code. </font><font style="vertical-align: inherit;">The division operation with the remainder is completely skipped for levels from 138 and above. </font><font style="vertical-align: inherit;">Instead, the index is assigned directly to the level number, which provides access to the bytes far beyond the end of the color table. </font><font style="vertical-align: inherit;">As shown below, it can even lead to almost invisible tetrimino.</font></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> ; difference = index - 10; <br> 980A: CMP #$0A ; while(difference &gt;= 0 &amp;&amp; difference &lt;= 127) { <br> 980C: BMI $9814 <br> 980E: SEC ; index -= 10; <br> 980F: SBC #$0A ; difference = index - 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10 &amp;&amp; index &lt;= 137) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6ed/2e5/2c6/6ed2e52c6a20dc9c8c1ffd1bf13d9b37.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Below are the colors of all 256 levels. </font><font style="vertical-align: inherit;">Tiles are arranged in 10 columns to emphasize the cyclic use of the color table, broken at level 138. Rows and columns in the headers are indicated in decimal form.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/423/6f0/ed6/4236f0ed6a508633b746d773a530fe90.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After 255, the level number returns to 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, as mentioned in the previous section, some levels do not change until 800 rows are removed. </font><font style="vertical-align: inherit;">During these long levels of color remain unchanged.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Game mode </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The game mode stored at the address </font></font><code>$00C0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">determines which of the various screens and menus is displayed to the user at the moment.</font></font><br><br><table><tbody><tr><th>  Value </th><th>  Description </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Legal Information Screen </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Screen saver </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Game Type Menu </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Level and height menu </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Game / screen records / ending / pause </font></font></td></tr><tr><td> <code>05</code> </td> <td>  Demo </td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As shown above, the game has a cleverly written subroutine that performs the role of a switch statement using the little endian transition table, located immediately after the call. </font><font style="vertical-align: inherit;">The list above shows the addresses of all game modes. Note that the ‚ÄúGame‚Äù and ‚ÄúDemo‚Äù modes use the same code. </font><font style="vertical-align: inherit;">This routine never returns. Instead, the code uses the return address; he usually points to the instruction immediately following the jump to the subroutine (minus 1 byte), but in this case he points to the jump table. The return address is removed from the stack and saved to </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. After saving the jump table address, the code uses the value in register A as an index and performs the corresponding jump.</font></font><br><br> <code>8161: LDA $00C0 <br> 8163: JSR $AC82 ; switch(gameMode) { <br> 8166: 00 82 ; case 0: goto 8200; //     <br> 8168: 4F 82 ; case 1: goto 824F; //   <br> 816A: D1 82 ; case 2: goto 82D1; //    <br> 816C: D7 83 ; case 3: goto 83D7; //     <br> 816E: 5D 81 ; case 4: goto 815D; //  /   /  /  <br> 8170: 5D 81 ; case 5: goto 815D; //  <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$0000</code><font style="vertical-align: inherit;"></font><code>$0001</code><font style="vertical-align: inherit;"></font><br><br> <code>AC82: ASL <br> AC83: TAY <br> AC84: INY <br> <br> AC85: PLA <br> AC86: STA $0000 <br> AC88: PLA ; pop return address off of stack <br> AC89: STA $0001 ; and store it at $0000-$0001 <br> <br> AC8B: LDA ($00),Y <br> AC8D: TAX <br> AC8E: INY <br> AC8F: LDA ($00),Y <br> AC91: STA $0001 <br> AC93: STX $0000 <br> AC95: JMP ($0000) ; goto Ath 16-bit address <br> ; in table at [$0000-$0001]</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The code can use this switch-subroutine, as long as the indices are close to 0 and there are no gaps between possible cases or few of them. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Legal Information Screen </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The game starts with a screen that shows legal notice. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/4e2/d4b/5244e2d4b26989579afaad64838c0962.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the bottom of the screen, </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0%25D0%25B6%25D0%25B8%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B2,_%25D0%2590%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2581%25D0%25B5%25D0%25B9_%25D0%259B%25D0%25B5%25D0%25BE%25D0%25BD%25D0%25B8%25D0%25B4%25D0%25BE%25D0%25B2%25D0%25B8%25D1%2587"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alexey Pajitnov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is mentioned </font><font style="vertical-align: inherit;">as an inventor, designer and programmer of the first Tetris. In 1984, while working as a computer developer at </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D1%258B%25D1%2587%25D0%25B8%25D1%2581%25D0%25BB%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2586%25D0%25B5%25D0%25BD%25D1%2582%25D1%2580_%25D0%25B8%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B8_%25D0%2590._%25D0%2590._%25D0%2594%25D0%25BE%25D1%2580%25D0%25BE%25D0%25B4%25D0%25BD%25D0%25B8%25D1%2586%25D1%258B%25D0%25BD%25D0%25B0_%25D0%25A0%25D0%2590%25D0%259D"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the Dorodnitsyn Computing Center</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (a leading research institute of the Russian Academy of Sciences in Moscow), he developed a prototype game for </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2582%25D1%2580%25D0%25BE%25D0%25BD%25D0%25B8%25D0%25BA%25D0%25B0-60"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Electronics-60</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (the Soviet clone DEC </font></font><a href="http://en.wikipedia.org/wiki/PDP-11"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSI-11</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). The prototype was developed for a green monochrome text mode, in which the squares are denoted by pairs of square brackets </font></font><code>[]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. With the help of 16-year-old schoolboy </font></font><a href="http://vadim.oversigma.com/Tetris.htm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vadim Gerasimov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and computer engineer Dmitry Pavlovsky a few days after the invention of the game, the prototype was ported to an IBM PC with MS DOS and </font></font><a href="http://en.wikipedia.org/wiki/Turbo_Pascal"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turbo Pascal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. For two years, they improved the game together, adding features such as tetrimino colors, statistics and, more importantly, timing code and graphics that allowed the game to work on many PC models and clones. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unfortunately, due to the peculiarities of the Soviet Union of that time, their attempts to monetize the game were not crowned with success, and in the end they decided to share the PC version with their friends for free. From that moment on, Tetris began to spread around the country and beyond its borders, copied from a floppy disk to a floppy disk. But since the game was developed by employees of a state institution, the state was its owner, and in 1987 the organization responsible for the international trade in electronic technology took up licensing the game </font></font><a href="http://en.wikipedia.org/wiki/Elektronorgtechnica"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ELorg)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). The abbreviation V / O on the legal information screen can be abbreviated from Version Originale. </font><a href="http://www.atarihq.com/tsr/special/tetrishist.html"><font style="vertical-align: inherit;">Andromeda, a</font></a></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> British software development company, </font><font style="vertical-align: inherit;">tried to get rights to Tetris and, before the deal was completed, slanted the game to other suppliers, for example, the British computer game publisher </font><a href="http://en.wikipedia.org/wiki/Mirrorsoft"><font style="vertical-align: inherit;">Mirrorsoft</font></a><font style="vertical-align: inherit;"> . Mirrorsoft, in turn, sublicensed it to </font><a href="http://en.wikipedia.org/wiki/Tengen_(company)"><font style="vertical-align: inherit;">Tengen</font></a><font style="vertical-align: inherit;"> , a subsidiary of Atari Games. Tengen granted Bullet-Proof Software the rights to develop games for computers and consoles in Japan, which resulted in Tetris for Nintendo </font><a href="http://en.wikipedia.org/wiki/Famicom"><font style="vertical-align: inherit;">Famicom</font></a><font style="vertical-align: inherit;"> . Below is his legal information screen.</font></font><a href="http://www.atarihq.com/tsr/special/tetrishist.html"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="http://en.wikipedia.org/wiki/Mirrorsoft"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="http://en.wikipedia.org/wiki/Tengen_(company)"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="http://en.wikipedia.org/wiki/Famicom"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/750/b96/6c0/750b966c0d526110e504b409b3f1a1af.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interestingly, in this version the schoolboy Vadim Gerasimov is called the original designer and programmer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Trying to get the rights to the portable version for the upcoming Game Boy console, Nintendo used Bullet-Proof Software to make a successful deal directly with ELORG. In the process of concluding a deal, ELORG revised its contract with Andromeda, adding that Andromeda received rights only for games for computers and arcade machines. Because of this, Bullet-Proof Software had to pay ELORG license fees for all the cartridges sold to Famicom, because the rights it received from Tengen turned out to be fake. But thanks to reconciliation with Bullet-Proof Software's ELORG, we finally managed to get worldwide rights to console games for Nintendo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bullet-Proof Software sublicensed the rights to Nintendo portable games and together they developed Game Boy Tetris, which is reflected in the legal information screen shown below.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0dc/d28/e4c/0dcd28e4c4f7b3da1a0259fcdbcf9b70.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Having obtained worldwide rights to console games, Nintendo developed the Tetris version for NES, which we study in this article. Then Bullet-Proof Software sublicensed Nintendo's rights, which allowed it to continue selling cartridges for Famicom in Japan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This was followed by a complex legal dispute. Both Nintendo and Tengen demanded that the opposing side stop producing and selling their version of the game. As a result, Nintendo won, and hundreds of thousands of </font></font><a href="http://en.wikipedia.org/wiki/Tetris_(Atari)"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengen Tetris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cartridges </font><font style="vertical-align: inherit;">were destroyed. The court‚Äôs verdict also prohibited several other companies like Mirrorsoft from creating console versions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pajitnov never received any deductions from ELORG or the Soviet state. However, in 1991 he moved to the USA and in 1996 with the support of the owner of Bullet-Proof Software</font></font><a href="http://en.wikipedia.org/wiki/Henk_Rogers"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Henk Rogers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> co-founded </font></font><a href="http://www.tetris.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Tetris Company</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which enabled him to profit from versions for mobile devices and modern consoles.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is curious to look at the legal information screen as a window, giving an idea of ‚Äã‚Äãthe modest birth of the game and the ensuing battles for intellectual property rights, because for most players this screen is just an annoying obstacle, the disappearance of which seems to wait forever. The delay is set by two counters, sequentially performing a counting from 255 to 0. The first phase cannot be skipped, and the second is skipped by pressing the Start button. Therefore, the legal information screen is displayed for at least 4.25 seconds and not more than 8.5 seconds. However, I think that most of the players give up, stopping pressing Start during the first interval, and because of this it is waiting for complete completion.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The timing of the phases, as well as the rest of the game, is controlled by a nonmaskable interrupt handler called at the beginning of each vertical blanking interval ‚Äî a short period of time between rendering television frames. That is, every 16.6393 milliseconds, normal program execution is interrupted by the following code. </font><font style="vertical-align: inherit;">The handler starts by transferring the values ‚Äã‚Äãof the main registers to the stack and retrieves them after completion in order not to interfere with the interrupted task. The call </font><font style="vertical-align: inherit;">updates VRAM, transforming the description of the memory model into what is displayed on the screen. Next, the handler reduces the value of the legal information screen counter, if it is greater than zero. Call</font></font><br><br> <code>8005: PHA <br> 8006: TXA <br> 8007: PHA <br> 8008: TYA <br> 8009: PHA ; save A, X, Y <br> <br> 800A: LDA #$00 <br> 800C: STA $00B3 <br> 800E: JSR $804B ; render(); <br> <br> 8011: DEC $00C3 ; legalScreenCounter1--; <br> <br> 8013: LDA $00C3 <br> 8015: CMP #$FF ; if (legalScreenCounter1 &lt; 0) { <br> 8017: BNE $801B ; legalScreenCounter1 = 0; <br> 8019: INC $00C3 ; } <br> <br> 801B: JSR $AB5E ; initializeOAM(); <br> <br> 801E: LDA $00B1 <br> 8020: CLC <br> 8021: ADC #$01 <br> 8023: STA $00B1 <br> 8025: LDA #$00 <br> 8027: ADC $00B2 <br> 8029: STA $00B2 ; frameCounter++; <br> <br> 802B: LDX #$17 <br> 802D: LDY #$02 <br> 802F: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 8032: LDA #$00 <br> 8034: STA $00FD <br> 8036: STA $2005 ; scrollX = 0; <br> 8039: STA $00FC <br> 803B: STA $2005 ; scrollY = 0; <br> <br> 803E: LDA #$01 <br> 8040: STA $0033 ; verticalBlankingInterval = true; <br> <br> 8042: JSR $9D51 ; pollControllerButtons(); <br> <br> 8045: PLA <br> 8046: TAY <br> 8047: PLA <br> 8048: TAX <br> 8049: PLA ; restore A, X, Y <br> <br> 804A: RTI ; resume interrupted task</code> <br> <br><font style="vertical-align: inherit;"></font><code>render()</code><font style="vertical-align: inherit;"></font><code>initializeOAM()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performs the step required by frame generation equipment. The handler continues to work by incrementing the frame counter ‚Äî the 16-bit little endian value stored at </font></font><code>$00B1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äî </font></font><code>$00B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which it uses in different places for controlled timing. After that, the next pseudo-random number is generated; as mentioned above, this happens regardless of the mode at least once per frame. At the address, </font></font><code>$8040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the vertical blanking interval flag is set, indicating that a handler has just been executed. Finally, the controller buttons are polled; The behavior of this subroutine is described below in the ‚ÄúDemo‚Äù section. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The flag is </font></font><code>verticalBlankingInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">used by the subroutine discussed above. It continues until the execution of the interrupt handler begins.</font></font><br><br> <code>AA2F: JSR $E000 ; updateAudio(); <br> <br> AA32: LDA #$00 <br> AA34: STA $0033 ; verticalBlankingInterval = false; <br> <br> AA36: NOP <br> <br> AA37: LDA $0033 <br> AA39: BEQ $AA37 ; while(!verticalBlankingInterval) { } <br> <br> AA3B: LDA #$FF <br> AA3D: LDX #$02 <br> AA3F: LDY #$02 <br> AA41: JSR $AC6A ; fill memory page 2 with all $FF's <br> <br> AA44: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This blocking subroutine is used in two stages of legal information screen timings that are executed one after the other. </font><font style="vertical-align: inherit;">The AI ‚Äã‚Äãscript on Lua bypasses this delay by assigning the value 0 to both counters.</font></font><br><br> <code>8236: LDA #$FF <br> 8238: JSR $A459 <br> <br> ... <br> <br> A459: STA $00C3 ; legalScreenCounter1 = 255; <br> <br> A45B: JSR $AA2F ; do { <br> A45E: LDA $00C3 ; waitForVerticalBlankingInterval(); <br> A460: BNE $A45B ; } while(legalScreenCounter1 &gt; 0); <br> <br> A462: RTS ; return;</code> <br> <br> <code>823B: LDA #$FF <br> 823D: STA $00A8 ; legalScreenCounter2 = 255; <br> <br> ; do { <br> <br> 823F: LDA $00F5 ; if (just pressed Start) { <br> 8241: CMP #$10 ; break; <br> 8243: BEQ $824C ; } <br> <br> 8245: JSR $AA2F ; waitForVerticalBlankingInterval(); <br> <br> 8248: DEC $00A8 ; legalScreenCounter2--; <br> 824A: BNE $823F ; } while(legalScreenCounter2 &gt; 0); <br> <br> 824C: INC $00C0 ; gameMode = TITLE_SCREEN;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><h3>  Demo </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The demo shows approximately 80 seconds of pre-recorded gameplay. It does not just display the video file, but uses the same engine as in the game. During playback, two tables are used. The first one, located at the address </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contains the following sequence of creating tetrimino: </font></font><br><br> <code>TJTSZJTSZJSZLZJTTSITO JSZLZLIOLZLIOJTSITOJ</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When creating a figure, it is either chosen randomly or read from a table, depending on the mode. Switching occurs at </font></font><code>$98EB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The tetrimino type is extracted from bits 6, 5, and 4 of each byte. From time to time this operation gives us the value </font><font style="vertical-align: inherit;">‚Äî the wrong type. However, the shape creation table ( </font><font style="vertical-align: inherit;">) used to convert the Tetrimino type to the orientation ID is actually located between two related tables: </font><font style="vertical-align: inherit;">Value</font></font><br><br> <code>98EB: LDA $00C0 <br> 98ED: CMP #$05 <br> 98EF: BNE $9903 ; if (gameMode == DEMO) { <br> <br> 98F1: LDX $00D3 <br> 98F3: INC $00D3 <br> 98F5: LDA $DF00,X ; value = demoTetriminoTypeTable[++demoIndex]; <br> <br> 98F8: LSR <br> 98F9: LSR <br> 98FA: LSR <br> 98FB: LSR <br> 98FC: AND #$07 <br> 98FE: TAX ; tetriminoType = bits 6,5,4 of value; <br> <br> 98FF: LDA $994E,X <br> 9902: RTS ; return spawnTable[tetriminoType]; <br> ; } else { <br> ; pickRandomTetrimino(); <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"></font><code>$994E</code><font style="vertical-align: inherit;"></font><br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">causes it to read past the end of the table, in the next one that gives </font></font><code>Td</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because of this effect, this scheme can give us an unlimited, but reproducible sequence of pseudo-random ID orientations of the created figures. The code will work because any arbitrary address in a varying sequence of bytes does not allow us to determine where the table ends. In fact, the sequence at an address </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be part of something completely unrelated to it, especially considering that the assignment of the remaining 5 non-zero bits is not clear, and the generated sequence exhibits repeatability. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">During the initialization of the demo mode, the index of the table ( </font></font><code>$00D3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) is reset to the address </font></font><code>$872B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second demo table contains a record of gamepad buttons, encoded in pairs of bytes. </font><font style="vertical-align: inherit;">The bits of the first byte correspond to the buttons.</font></font><br><br><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td>  A </td><td>  B </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Select </font></font></td><td>  Start </td><td>  Up </td><td>  Way down </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To the left </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To the right </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second byte stores the number of frames during which the combination of buttons is pressed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The table takes the address </font></font><code>$DD00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$DEFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and consists of 256 pairs. It is accessed by the subroutine at </font></font><code>$9D5B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Since the table of demo buttons has a length of 512 bytes, a two-byte index is required to access it. The index is stored as little endian to the addresses </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. It is initialized with the value of the address of the table </font><font style="vertical-align: inherit;">, and its increment is executed by the following code. </font><font style="vertical-align: inherit;">The programmers left in the code the player's input processing, which allows us to look at the development process and replace the demo with another entry. Demo recording mode is activated when </font><font style="vertical-align: inherit;">a value is assigned</font></font><br><br> <code>9D5B: LDA $00D0 ; if (recording mode) { <br> 9D5D: CMP #$FF ; goto recording; <br> 9D5F: BEQ $9DB0 ; } <br> <br> 9D61: JSR $AB9D ; pollController(); <br> 9D64: LDA $00F5 ; if (start button pressed) { <br> 9D66: CMP #$10 ; goto startButtonPressed; <br> 9D68: BEQ $9DA3 ; } <br> <br> 9D6A: LDA $00CF ; if (repeats == 0) { <br> 9D6C: BEQ $9D73 ; goto finishedMove; <br> ; } else { <br> 9D6E: DEC $00CF ; repeats--; <br> 9D70: JMP $9D9A ; goto moveInProgress; <br> ; } <br> <br> finishedMove: <br> <br> 9D73: LDX #$00 <br> 9D75: LDA ($D1,X) <br> 9D77: STA $00A8 ; buttons = demoButtonsTable[index]; <br> <br> 9D79: JSR $9DE8 ; index++; <br> <br> 9D7C: LDA $00CE <br> 9D7E: EOR $00A8 <br> 9D80: AND $00A8 <br> 9D82: STA $00F5 ; setNewlyPressedButtons(difference between heldButtons and buttons); <br> <br> 9D84: LDA $00A8 <br> 9D86: STA $00CE ; heldButtons = buttons; <br> <br> 9D88: LDX #$00 <br> 9D8A: LDA ($D1,X) <br> 9D8C: STA $00CF ; repeats = demoButtonsTable[index]; <br> <br> 9D8E: JSR $9DE8 ; index++; <br> <br> 9D91: LDA $00D2 ; if (reached end of demo table) { <br> 9D93: CMP #$DF ; return; <br> 9D95: BEQ $9DA2 ; } <br> <br> 9D97: JMP $9D9E ; goto holdButtons; <br> <br> moveInProgress: <br> <br> 9D9A: LDA #$00 <br> 9D9C: STA $00F5 ; clearNewlyPressedButtons(); <br> <br> holdButtons: <br> <br> 9D9E: LDA $00CE <br> 9DA0: STA $00F7 ; setHeldButtons(heldButtons); <br> <br> 9DA2: RTS ; return; <br> <br> startButtonPressed: <br> <br> 9DA3: LDA #$DD <br> 9DA5: STA $00D2 ; reset index; <br> <br> 9DA7: LDA #$00 <br> 9DA9: STA $00B2 ; counter = 0; <br> <br> 9DAB: LDA #$01 <br> 9DAD: STA $00C0 ; gameMode = TITLE_SCREEN; <br> <br> 9DAF: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D1</code><font style="vertical-align: inherit;"></font><code>$00D2</code><font style="vertical-align: inherit;"></font><code>$872D</code><font style="vertical-align: inherit;"></font><br><br> <code>9DE8: LDA $00D1 <br> 9DEA: CLC ; increment [$00D1] <br> 9DEB: ADC #$01 ; possibly causing wrap around to 0 <br> 9DED: STA $00D1 ; which produces a carry <br> <br> 9DEF: LDA #$00 <br> 9DF1: ADC $00D2 <br> 9DF3: STA $00D2 ; add carry to [$00D2] <br> <br> 9DF5: RTS ; return</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D0</code><font style="vertical-align: inherit;"></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">At the same time, the following code is launched, intended for writing to the table of demo buttons. </font><font style="vertical-align: inherit;">However, the table is stored in the PRG-ROM. </font><font style="vertical-align: inherit;">Attempting to write to it will not affect the stored data. </font><font style="vertical-align: inherit;">Instead, each write operation triggers a bank switch, which leads to the glitch effect shown below.</font></font><br><br> <code>recording: <br> <br> 9DB0: JSR $AB9D ; pollController(); <br> <br> 9DB3: LDA $00C0 ; if (gameMode != DEMO) { <br> 9DB5: CMP #$05 ; return; <br> 9DB7: BNE $9DE7 ; } <br> <br> 9DB9: LDA $00D0 ; if (not recording mode) { <br> 9DBB: CMP #$FF ; return; <br> 9DBD: BNE $9DE7 ; } <br> <br> 9DBF: LDA $00F7 ; if (getHeldButtons() == heldButtons) { <br> 9DC1: CMP $00CE ; goto buttonsNotChanged; <br> 9DC3: BEQ $9DE4 ; } <br> <br> 9DC5: LDX #$00 <br> 9DC7: LDA $00CE <br> 9DC9: STA ($D1,X) ; demoButtonsTable[index] = heldButtons; <br> <br> 9DCB: JSR $9DE8 ; index++; <br> <br> 9DCE: LDA $00CF <br> 9DD0: STA ($D1,X) ; demoButtonsTable[index] = repeats; <br> <br> 9DD2: JSR $9DE8 ; index++; <br> <br> 9DD5: LDA $00D2 ; if (reached end of demo table) { <br> 9DD7: CMP #$DF ; return; <br> 9DD9: BEQ $9DE7 ; } <br> <br> 9DDB: LDA $00F7 <br> 9DDD: STA $00CE ; heldButtons = getHeldButtons(); <br> <br> 9DDF: LDA #$00 <br> 9DE1: STA $00CF ; repeats = 0; <br> <br> 9DE3: RTS ; return; <br> <br> buttonsNotChanged: <br> <br> 9DE4: INC $00CF ; repeats++; <br> <br> 9DE6: RTS <br> 9DE7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a07/66a/261/a0766a261967e1ee2e7d4a61d3367ee6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This suggests that developers could run the program partially or completely in RAM. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To get around this obstacle, I created </font></font><code>lua/RecordDemo.lua</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, located in the </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zip source</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">After switching to the demo recording mode, it redirects the write operations to the table to the Lua console. </font><font style="vertical-align: inherit;">From it, the bytes can be copied and pasted into the ROM.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To record your own demo, run FCEUX and download the Nintendo Tetris ROM file (File | Open ROM ...). Then open the Lua Script window (File | Lua | New Lua Script Window ...), go to the file or enter the path. Click the Run button to start the demo recording mode, and then click the FCEUX window to switch focus to it. You can control the shapes until the table of buttons is filled. After that, the game will automatically return to the splash screen. Click Stop in the Lua Script window to stop the script. Recorded data will appear in the Output Console, as shown in the figure below.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f2e/3cd/f61/f2e3cdf61589005f2e1cae0659f66467.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Select all content and copy to clipboard (Ctrl + C). </font><font style="vertical-align: inherit;">Then run the Hex Editor (Debug | Hex Editor ...). </font><font style="vertical-align: inherit;">From the Hex Editor menu, select View | </font><font style="vertical-align: inherit;">ROM File, and then File | </font><font style="vertical-align: inherit;">Goto Address. </font><font style="vertical-align: inherit;">In the Goto dialog box, enter 5D10 (the address of the table of demo buttons in the ROM file) and click Ok. </font><font style="vertical-align: inherit;">Then paste the contents of the clipboard (Ctrl + V).</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bef/599/392/bef599392455c773652e850de13f6413.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally in the FCEUX menu, select NES | </font><font style="vertical-align: inherit;">Reset </font><font style="vertical-align: inherit;">If you managed to repeat all these steps, then the demo should be replaced with your own version. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you want to save the changes, in the Hex Editor menu, select File | </font><font style="vertical-align: inherit;">Save Rom As ... and enter the name of the modified ROM file, and then click Save. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Similarly, you can customize the sequence created by Tetrimino.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Death screen </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As mentioned above, the majority of players cannot cope with the speed of descent of figures at level 29, which quickly leads to the completion of the game. Therefore, the players he became associated with the name "screen of death." But from a technical point of view, the death screen does not allow the player to go further because of the bug, in which the quick descent actually turns out to be not a bug, but features. The designers were so kind that they allowed the game to continue as long as the player was able to withstand superhuman speed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This screen of death occurs on about 1,550 rows removed. It manifests itself in different ways. Sometimes the game reloads. In other cases, the screen just turns black. Usually, the game freezes (‚Äúfreezes‚Äù) immediately after deleting a row, as shown below. Such effects are often preceded by random graphic artifacts.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09d/7fe/4f3/09d7fe4f3ec1e77057c7ee5e252d8d75.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The screen of death is the result of a bug in the code that adds points when deleting rows. The six-character account is stored as a 24-bit packed BCD little endian and is located at </font></font><code>$0053</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0055</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A table is used to convert between the number of rows cleared and points received; each entry in it is a 16-bit BCD value little endian. </font><font style="vertical-align: inherit;">After incrementing the total number of rows, and possibly the level, the value in this list is multiplied by the level number plus one, and the result is added to the points. This is amply demonstrated in the table from the Nintendo Tetris guide booklet:</font></font><br><br> <code>9CA5: 00 00 ; 0: 0 <br> 9CA7: 40 00 ; 1: 40 <br> 9CA9: 00 01 ; 2: 100 <br> 9CAB: 00 03 ; 3: 300 <br> 9CAD: 00 12 ; 4: 1200</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34b/a36/7cf/34ba367cfefad47e493306fa6ef8fe3e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As shown below, the multiplication is simulated by a cycle that adds points to the score. It is executed after blocking the shape, even if no rows are cleared. </font><font style="vertical-align: inherit;">Unfortunately, the </font><a href="http://en.wikipedia.org/wiki/Ricoh_2A03"><font style="vertical-align: inherit;">Ricoh 2A03 does</font></a><font style="vertical-align: inherit;"> not have the 6502 processor binary-decimal mode; he could greatly simplify the body of the cycle. Instead, the addition is done in steps, using the binary mode. Any digit that exceeds the value of 9 after the addition is essentially obtained by subtracting 10 and the increment of the digit on the left. For example, </font><font style="vertical-align: inherit;">that is converted to </font><font style="vertical-align: inherit;">. But this scheme is not fully protected. Take </font><font style="vertical-align: inherit;">: verification is not able to convert the result to</font></font><br><br> <code>9C31: LDA $0044 <br> 9C33: STA $00A8 <br> 9C35: INC $00A8 ; for(i = 0; i &lt;= level; i++) { <br> <br> 9C37: LDA $0056 <br> 9C39: ASL <br> 9C3A: TAX <br> 9C3B: LDA $9CA5,X ; points[0] = pointsTable[2 * completedLines]; <br> <br> 9C3E: CLC <br> 9C3F: ADC $0053 <br> 9C41: STA $0053 ; score[0] += points[0]; <br> <br> 9C43: CMP #$A0 <br> 9C45: BCC $9C4E ; if (upper digit of score[0] &gt; 9) { <br> <br> 9C47: CLC <br> 9C48: ADC #$60 <br> 9C4A: STA $0053 ; upper digit of score[0] -= 10; <br> 9C4C: INC $0054 ; score[1]++; <br> ; } <br> <br> 9C4E: INX <br> 9C4F: LDA $9CA5,X ; points[1] = pointsTable[2 * completedLines + 1]; <br> <br> 9C52: CLC <br> 9C53: ADC $0054 <br> 9C55: STA $0054 ; score[1] += points[1]; <br> <br> 9C57: AND #$0F <br> 9C59: CMP #$0A <br> 9C5B: BCC $9C64 ; if (lower digit of score[1] &gt; 9) { <br> <br> 9C5D: LDA $0054 <br> 9C5F: CLC ; lower digit of score[1] -= 10; <br> 9C60: ADC #$06 ; increment upper digit of score[1]; <br> 9C62: STA $0054 ; } <br> <br> 9C64: LDA $0054 <br> 9C66: AND #$F0 <br> 9C68: CMP #$A0 <br> 9C6A: BCC $9C75 ; if (upper digit of score[1] &gt; 9) { <br> <br> 9C6C: LDA $0054 <br> 9C6E: CLC <br> 9C6F: ADC #$60 <br> 9C71: STA $0054 ; upper digit of score[1] -= 10; <br> 9C73: INC $0055 ; score[2]++; <br> ; } <br> <br> 9C75: LDA $0055 <br> 9C77: AND #$0F <br> 9C79: CMP #$0A <br> 9C7B: BCC $9C84 ; if (lower digit of score[2] &gt; 9) { <br> <br> 9C7D: LDA $0055 <br> 9C7F: CLC ; lower digit of score[2] -= 10; <br> 9C80: ADC #$06 ; increment upper digit of score[2]; <br> 9C82: STA $0055 ; } <br> <br> 9C84: LDA $0055 <br> 9C86: AND #$F0 <br> 9C88: CMP #$A0 <br> 9C8A: BCC $9C94 ; if (upper digit of score[2] &gt; 9) { <br> <br> 9C8C: LDA #$99 <br> 9C8E: STA $0053 <br> 9C90: STA $0054 <br> 9C92: STA $0055 ; max out score to 999999; <br> ; } <br> <br> 9C94: DEC $00A8 <br> 9C96: BNE $9C37 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="http://en.wikipedia.org/wiki/Ricoh_2A03"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>$07 + $07 = $0E</code><font style="vertical-align: inherit;"></font><code>$14</code><font style="vertical-align: inherit;"></font><code>$09 + $09 = $12</code><font style="vertical-align: inherit;"></font><code>$18</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">To compensate for this, none of the decimal digits in the scores table entries exceeds 6. In addition, the test can be used, the last digit of all entries is always 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It takes time to complete this long and complex cycle. </font><font style="vertical-align: inherit;">At large levels, a large number of iterations affect the timing of the game, because the generation of each frame takes more than 1/60 of a second. </font><font style="vertical-align: inherit;">All this as a result leads to different manifestations of the ‚Äúdeath screen‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The AI ‚Äã‚Äãscript on Lua limits the number of iterations in the loop to 30 ‚Äî the maximum value that the designers intended could be reached by the players, which makes it possible to eliminate the screen of death.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Endings </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the Nintendo Tetris guide booklet, an A-Type game is described as: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/f16/5ea/c53f165ea675badb06f75f6409f6c836.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The game rewards players who score large enough points in one of the five animations of the endings. The choice of ending is entirely based on the two leftmost digits of the six-digit count. As shown below, to get one of the endings, the player must score at least 30,000 points. </font><font style="vertical-align: inherit;">It is worth noting that </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">- this is a mirror of addresses </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. The account is duplicated by addresses </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">After passing the first test, the animation of the ending is selected with the following switch statement.</font></font><br><br> <code>9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0060</code><font style="vertical-align: inherit;"></font><code>$007F</code><font style="vertical-align: inherit;"></font><code>$0040</code><font style="vertical-align: inherit;"></font><code>$005F</code><font style="vertical-align: inherit;"></font><code>$0073</code><font style="vertical-align: inherit;"></font><code>$0075</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>A96E: LDA #$00 <br> A970: STA $00C4 <br> A972: LDA $0075 ; if (score[2] &lt; $05) { <br> A974: CMP #$05 ; ending = 0; <br> A976: BCC $A9A5 ; } <br> <br> A978: LDA #$01 <br> A97A: STA $00C4 <br> A97C: LDA $0075 ; else if (score[2] &lt; $07) { <br> A97E: CMP #$07 ; ending = 1; <br> A980: BCC $A9A5 ; } <br> <br> A982: LDA #$02 <br> A984: STA $00C4 <br> A986: LDA $0075 ; else if (score[2] &lt; $10) { <br> A988: CMP #$10 ; ending = 2; <br> A98A: BCC $A9A5 ; } <br> <br> A98C: LDA #$03 <br> A98E: STA $00C4 <br> A990: LDA $0075 ; else if (score[2] &lt; $12) { <br> A992: CMP #$12 ; ending = 3; <br> A994: BCC $A9A5 ; } <br> <br> A996: LDA #$04 ; else { <br> A998: STA $00C4 ; ending = 4; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the end of the rocket of increasing size are launched from the launch pad next to St. Basil's Cathedral. </font><font style="vertical-align: inherit;">In the fourth ending, the Buran spacecraft is shown - the Soviet version of the American Space Shuttle. </font><font style="vertical-align: inherit;">In the best ending, the cathedral itself rises in the air, and a UFO hangs above the launch pad. </font><font style="vertical-align: inherit;">Below is a picture of each ending and the score associated with it.</font></font><br><table><tbody><tr><td> <code>30000‚Äì49999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/0b9/b73/4b4/0b9b734b43dae52eccafaa71e3c1441d.png"></div></td><td> <code>50000‚Äì69999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/ade/f93/f39/adef93f395eb2bef2c1fd71562857c39.png"></div></td><td> <code>70000‚Äì99999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/df3/480/b63/df3480b63de128a70b7c9e4dd7cec81f.png"></div></td></tr><tr><td> <code>100000‚Äì119999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/8e3/91a/658/8e391a6581df6e7ec0c08134b6a6d5bf.png"></div></td><td> <code>120000+</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/3e1/2bd/42f/3e12bd42ffc331742d809325db418f78.png"></div></td><td></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the B-Type game mode, another test is implemented, which is described in the Nintendo Tetris guide booklet as follows: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/929/624/0aa929624f41a68ea1388b6ba9013dd3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If the player successfully clears 25 rows, the game shows the ending, depending on the initial level. The endings for levels 0‚Äì8 consist of animals and objects flying or running in the frame, mysteriously passing behind St. Basil‚Äôs Cathedral. A UFO from the best ending of the A-Type mode appears in the ending 3. In the ending 4, extinct flying pterosaurs appear, and in the ending 7 mythical flying dragons are shown. In the endings 2 and 6, wingless birds are shown: running penguins and ostriches. In the end 5, the sky is filled with GOOD airships (not to be confused with Goodyear airships). And in the end 8, a lot of ‚ÄúBurans‚Äù rush through the screen, although in reality it was only one. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The initial height (plus 1) is used as a multiplier, rewarding the player with a large number of animals / objects for increased complexity.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the best B-Type ending, the castle is filled with characters from the Nintendo universe: Princess Peach claps her hands, Kid Icarus plays the violin, Donki Kong knocks on the big drum, Mario and Luigi dance, Bowser plays the accordion, Samus plays the cello, Link - on the flute, while the domes of St. Basil‚Äôs Cathedral soar into the air. From the initial height depends on the number of these elements shown in the end. Below are the images of all 10 endings.</font></font><br><br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/c8e/525/5d9c8e525177613cb3fcd59c7c6aa53a.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ade/2fc/f3d/ade2fcf3d389b67e5d4b3d7e8c5c1ea0.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ec9/bd3/9dd/ec9bd39dd26529013d7d408f6a4e855b.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fdb/125/132/fdb125132ecaed550966562b5e08f169.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/22b/758/028/22b75802841a3b558f8fae476f2d2598.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43e/710/858/43e710858220b08e1860da00a309c665.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dda/332/1d5/dda3321d5e5246d2aa92eafb69f3cf5d.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6f/2d0/843/c6f2d0843995d294393bbbf277b83bdf.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/572/3b8/f29/5723b8f2919ac35746b52923d59dbf41.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/639/938/9df/6399389dfff187a8db7ac92f1dc815e3.png"></div></td><td></td><td></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The AI ‚Äã‚Äãcan quickly clear all 25 rows required in the B-Type mode at any initial level and height, allowing you to view any of the endings. It is also worth assessing how cool he is with large piles of random blocks. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the endings 0‚Äì8, up to 6 objects can move in the frame. The y coordinates of the objects are stored in a table located at </font></font><code>$A7B7</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Horizontal distances between objects are stored in a table at </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The sequence of values ‚Äã‚Äãwith a sign at the address </font><font style="vertical-align: inherit;">determines the speed and direction of objects. </font><font style="vertical-align: inherit;">Sprite indices are stored at </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">In fact, each object consists of two sprites with adjacent indexes. For the second index you need to add 1. For example, a dragon consists of</font></font><br><br> <code>A7B7: 98 A8 C0 A8 90 B0 ; 0 <br> A7BD: B0 B8 A0 B8 A8 A0 ; 1 <br> A7C3: C8 C8 C8 C8 C8 C8 ; 2 <br> A7C9: 30 20 40 28 A0 80 ; 3 <br> A7CF: A8 88 68 A8 48 78 ; 4 <br> A7D5: 58 68 18 48 78 38 ; 5 <br> A7DB: C8 C8 C8 C8 C8 C8 ; 6 <br> A7E1: 90 58 70 A8 40 38 ; 7 <br> A7E7: 68 88 78 18 48 A8 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A77B</code><font style="vertical-align: inherit;"></font><br><br> <code>A77B: 3A 24 0A 4A 3A FF ; 0 <br> A781: 22 44 12 32 4A FF ; 1 <br> A787: AE 6E 8E 6E 1E 02 ; 2 <br> A78D: 42 42 42 42 42 02 ; 3 <br> A793: 22 0A 1A 04 0A FF ; 4 <br> A799: EE DE FC FC F6 02 ; 5 <br> A79F: 80 80 80 80 80 FF ; 6 <br> A7A5: E8 E8 E8 E8 48 FF ; 7 <br> A7AB: 80 AE 9E 90 80 02 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A771</code><font style="vertical-align: inherit;"></font><br><br> <code>A771: 01 ; 0: 1 <br> A772: 01 ; 1: 1 <br> A773: FF ; 2: -1 <br> A774: FC ; 3: -4 <br> A775: 01 ; 4: 1 <br> A776: FF ; 5: -1 <br> A777: 02 ; 6: 2 <br> A778: 02 ; 7: 2 <br> A779: FE ; 8: -1</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A7F3</code><font style="vertical-align: inherit;"></font><br><br> <code>A7F3: 2C ; 0: dragonfly <br> A7F4: 2E ; 1: dove <br> A7F5: 54 ; 2: penguin <br> A7F6: 32 ; 3: UFO <br> A7F7: 34 ; 4: pterosaur <br> A7F8: 36 ; 5: blimp <br> A7F9: 4B ; 6: ostrich <br> A7FA: 38 ; 7: dragon <br> A7FB: 3A ; 8: Buran</code> <br> <br><font style="vertical-align: inherit;"></font><code>$38</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>$39</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The tiles for these sprites are contained in the pattern tables shown below.</font></font><br><br><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/524/373/86d5243738d9c3e34db5318889c4f894.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d82/2d1/229/d822d122984b77a0973f08feac962647.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d8a/3c1/9b5/d8a3c19b513fb9f7338e250b97fdeac1.png"></div></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The central table of the pattern we considered above, it is used to display tetrimino and the playing field. </font><font style="vertical-align: inherit;">Interestingly, it contains the entire alphabet, while others contain only part of it to save space. </font><font style="vertical-align: inherit;">But even more interesting are the sprites of the aircraft and the helicopter in the pattern table on the left; </font><font style="vertical-align: inherit;">they do not appear in the endings or in other parts of the game. </font><font style="vertical-align: inherit;">It turned out that the plane and the helicopter have indexes sprites </font></font><code>$30</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>$16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and you can change the table shown above, to see them in action.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/04e/2e2/203/04e2e2203b1581876d99736ad9b56fd6.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/445/153/3b4/4451533b43874485cb5a0cdfd9df0c58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unfortunately, the helicopter supports are not displayed, but the main and tail rotors are beautifully animated. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2 Player Versus </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nintendo Tetris contains an unfinished two-player mode, which can be turned on by changing the number of players ( </font></font><code>$00BE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) by 2. As shown below, two game fields appear in the background of the single-player mode.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/418/6e7/2af/4186e72af40c6c617996ca2f8d39a72c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is no border between the fields, because the central background area has a solid black color. The values </font></font><code>003</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shown above the playing fields indicate the number of rows cleared by each player. The only figure common for two players appears in the same place as in single player mode. Unfortunately, it is on the right playing field. Squares and other tiles are incorrectly painted. And when a player loses the game is restarted. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But if you do not take into account these problems, the mode is quite playable. Each player can independently control the pieces in the corresponding playing field. And when a player enters Double, Triple or Tetris (that is, clears two, three or four rows), trash cans appear at the bottom of the playing field with one missing square.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An additional field is located at </font></font><code>$0500</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A </font></font><code>$0060</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$007F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usually being a mirror </font></font><code>$0040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$005F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, is used for the second player. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probably, this interesting mode was abandoned due to the tight development schedule. And perhaps he was left unfinished on purpose. One of the reasons Tetris was selected as the game that came with the Nintendo Game Boy was that it encouraged him to buy </font></font><a href="http://en.wikipedia.org/wiki/Game_Link_Cable"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Game Link Cable</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- an accessory that connected together two Game Boy to launch 2 player versus mode. </font><font style="vertical-align: inherit;">This cable added an element of "sociality" to the system - pushing friends to buy a Game Boy to join in the fun. </font><font style="vertical-align: inherit;">Perhaps Nintendo feared that if in the console version of the game there would be 2 player versus mode, then the Tetris advertising power, which stimulated the purchase of a Game Boy, could be weakened.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music and sound effects </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Background music is turned on when </font></font><code>$06F5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one of the values ‚Äã‚Äãlisted in the table is assigned.</font></font><br><br><table><tbody><tr><th>  Value </th><th>  Description </th></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unused splash screen music </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> B-Type Mode Target Achieved </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music-1 </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music-2 </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music-3 </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music-1 allegro </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music-2 allegro </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music-3 allegro </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Congratulations screen </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Endings </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> B-Type Mode Target Achieved </font></font></td></tr></tbody></table><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can listen to unused screen saver music </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . In the game itself during the screen saver nothing sounds. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Music-1 is a version of </font></font><a href="https://simple.wikipedia.org/wiki/Dance_of_the_Sugar_Plum_Fairy"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dance of the Fairy Drazhe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , music for the ballerina from </font><font style="vertical-align: inherit;">Tchaikovsky </font><a href="https://ru.wikipedia.org/wiki/%25D0%25A9%25D0%25B5%25D0%25BB%25D0%25BA%25D1%2583%25D0%25BD%25D1%2587%25D0%25B8%25D0%25BA"><i><font style="vertical-align: inherit;">'s Nutcracker, the</font></i></a><font style="vertical-align: inherit;"> third act of the </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B0-%25D0%25B4%25D0%25B5-%25D0%25B4%25D0%25B5"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vallors </font><font style="vertical-align: inherit;">. The ending music is a variation of The </font><a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2583%25D0%25BF%25D0%25BB%25D0%25B5%25D1%2582%25D1%258B_%25D0%25AD%25D1%2581%25D0%25BA%25D0%25B0%25D0%25BC%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BE"><font style="vertical-align: inherit;">Bullfighter's Couplets</font></a><font style="vertical-align: inherit;"> , arias from the opera by </font><a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B0%25D1%2580%25D0%25BC%25D0%25B5%25D0%25BD_(%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0)"><i><font style="vertical-align: inherit;">Carmen</font></i></a><font style="vertical-align: inherit;"> Georges Bizet. These compositions are arranged by the composer for the rest of the music of the game </font><a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BA%25D0%25B0,_%25D0%25A5%25D0%25B8%25D1%2580%25D0%25BE%25D0%25BA%25D0%25B0%25D0%25B4%25D0%25B7%25D1%2583"><font style="vertical-align: inherit;">Hirokazu Tanaka</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Music-2 was inspired by traditional Russian folk songs. Music-3 is mysterious, futuristic and tender; for a while, it was the melody of a Nintendo of America customer support phone call.</font></font><a href="https://ru.wikipedia.org/wiki/%25D0%25A9%25D0%25B5%25D0%25BB%25D0%25BA%25D1%2583%25D0%25BD%25D1%2587%25D0%25B8%25D0%25BA"><i><font style="vertical-align: inherit;"></font></i></a><font style="vertical-align: inherit;"></font><a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D1%2583%25D0%25BF%25D0%25BB%25D0%25B5%25D1%2582%25D1%258B_%25D0%25AD%25D1%2581%25D0%25BA%25D0%25B0%25D0%25BC%25D0%25B8%25D0%25BB%25D1%258C%25D0%25BE"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25B0%25D1%2580%25D0%25BC%25D0%25B5%25D0%25BD_(%25D0%25BE%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B0)"><i><font style="vertical-align: inherit;"></font></i></a><font style="vertical-align: inherit;"></font><a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BA%25D0%25B0,_%25D0%25A5%25D0%25B8%25D1%2580%25D0%25BE%25D0%25BA%25D0%25B0%25D0%25B4%25D0%25B7%25D1%2583"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To help the player get into a state of panic, when the height of the heap approaches the ceiling of the playing field, a fast paced version of the background music ( </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">begins to play </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interestingly, among the musical compositions there is no " </font></font><a href="https://ru.wikipedia.org/wiki/%25D0%259A%25D0%25BE%25D1%2580%25D0%25BE%25D0%25B1%25D1%2583%25D1%2588%25D0%25BA%25D0%25B0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Korobeinikov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", a famous theme, sounding in Game Boy Tetris. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sound effects are triggered by recording to </font></font><code>$06F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>$06F1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, according to the following table.</font></font><br><br><table><tbody><tr><th>  Address </th><th>  Value </th><th>  Description </th></tr><tr><td> <code>06F0</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Curtain end game </font></font></td></tr><tr><td> <code>06F0</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rocket in the end </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Select menu option </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu screen selection </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino shift </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetris received </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino turn </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> New level </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino lock </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Chirping </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Row cleaning </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The row is full </font></font></td></tr></tbody></table><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Game states and rendering modes </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">During gameplay, the current state of the game is represented by an integer number at </font></font><code>$0048</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Most of the time it matters </font></font><code>$01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, meaning that the player controls the active Tetrimino. </font><font style="vertical-align: inherit;">However, when the figure is blocked in place, the game gradually passes from state </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to state </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, as shown in the table.</font></font><br><br><table><tbody><tr><th>  condition </th><th>  Description </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unassigned orientation ID </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Player controls active tetrimino </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino lock on the playing field </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verification of filled lines </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Displaying row cleaning animation </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Update rows and statistics </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Check B-Type Mode Target </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Not used </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create the following tetrimino </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Not used </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Update curtain end game </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Game state increment </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Code branching, depending on the game state, occurs at the address </font></font><code>$81B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">In the </font><font style="vertical-align: inherit;">switch </font><font style="vertical-align: inherit;">state </font><font style="vertical-align: inherit;">, jumps to the code assigning a </font><font style="vertical-align: inherit;">value </font><font style="vertical-align: inherit;">indicating that the orientation is not set. </font><font style="vertical-align: inherit;">The handler is never called; however, the game state </font><font style="vertical-align: inherit;">serves as a signal for other parts of the code. </font><font style="vertical-align: inherit;">The state </font><font style="vertical-align: inherit;">allows the player to shift, rotate, and lower the active Tetrimino: </font><font style="vertical-align: inherit;">As stated in the previous sections, the subroutines for shifting, rotating, and lowering the figure check for new Tetrimino positions before executing the code. The only way to block a shape in the wrong position is to create it on top of an existing shape. In this game ends. As shown below, this check is performed by the status code.</font></font><br><br> <code>81B2: LDA $0048 <br> 81B4: JSR $AC82 ; switch(playState) { <br> 81B7: 2F 9E ; case 00: goto 9E2F; // Unassign orientationID <br> 81B9: CF 81 ; case 01: goto 81CF; // Player controls active Tetrimino <br> 81BB: A2 99 ; case 02: goto 99A2; // Lock Tetrimino into playfield <br> 81BD: 6B 9A ; case 03: goto 9A6B; // Check for completed rows <br> 81BF: 39 9E ; case 04: goto 9E39; // Display line clearing animation <br> 81C1: 58 9B ; case 05: goto 9B58; // Update lines and statistics <br> 81C3: F2 A3 ; case 06: goto A3F2; // B-Type goal check; Unused frame for A-Type <br> 81C5: 03 9B ; case 07: goto 9B03; // Unused frame; Execute unfinished 2 player mode logic <br> 81C7: 8E 98 ; case 08: goto 988E; // Spawn next Tetrimino <br> 81C9: 39 9E ; case 09: goto 9E39; // Unused <br> 81CB: 11 9A ; case 0A: goto 9A11; // Update game over curtain <br> 81CD: 37 9E ; case 0B: goto 9E37; // Increment play state <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><code>orientationID</code><font style="vertical-align: inherit;"></font><code>$13</code><font style="vertical-align: inherit;"></font><br><br> <code>9E2F: LDA #$13 <br> 9E31: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9E33: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$01</code><font style="vertical-align: inherit;"></font><br><br> <code>81CF: JSR $89AE ; shift Tetrimino; <br> 81D2: JSR $88AB ; rotate Tetrimino; <br> 81D5: JSR $8914 ; drop Tetrimino; <br> <br> 81D8: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">If the locked position is correct, it marks the 4 associated game field cells as occupied. Otherwise, it makes the transition to the state </font><font style="vertical-align: inherit;">- the ominous curtain of the end of the game.</font></font><br><br> <code>99A2: JSR $948B ; if (new position valid) { <br> 99A5: BEQ $99B8 ; goto updatePlayfield; <br> ; } <br> <br> 99A7: LDA #$02 <br> 99A9: STA $06F0 ; play curtain sound effect; <br> <br> 99AC: LDA #$0A <br> 99AE: STA $0048 ; playState = UPDATE_GAME_OVER_CURTAIN; <br> <br> 99B0: LDA #$F0 <br> 99B2: STA $0058 ; curtainRow = -16; <br> <br> 99B4: JSR $E003 ; updateAudio(); <br> <br> 99B7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b1b/7c0/a46/b1b7c0a4637995c25423a07984bce24e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The curtain is drawn down from the top of the playing field, going down one line every 4 frames. </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0058</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) is initialized with a value of ‚àí16, creating an additional delay of 0.27 seconds between the final lock and the start of the animation. The address </font></font><code>$9A21</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">code shown below is used to access the multiplication table, which is erroneously displayed as level numbers. This is done to scale </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to 10. In addition, as shown above, the code at the address </font></font><code>$9A51</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starts the animation of the ending, if the player‚Äôs account is at least 30,000 points; otherwise, it waits to press Start. </font><font style="vertical-align: inherit;">The code is completed by assigning a value to the game state </font><font style="vertical-align: inherit;">, but the corresponding handler is not called because the game is over.</font></font><br><br> <code>9A11: LDA $0058 ; if (curtainRow == 20) { <br> 9A13: CMP #$14 ; goto endGame; <br> 9A15: BEQ $9A47 ; } <br> <br> 9A17: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9A19: AND #$03 ; return; <br> 9A1B: BNE $9A46 ; } <br> <br> 9A1D: LDX $0058 ; if (curtainRow &lt; 0) { <br> 9A1F: BMI $9A3E ; goto incrementCurtainRow; <br> ; } <br> <br> 9A21: LDA $96D6,X <br> 9A24: TAY ; rowIndex = 10 * curtainRow; <br> <br> 9A25: LDA #$00 <br> 9A27: STA $00AA ; i = 0; <br> <br> 9A29: LDA #$13 <br> 9A2B: STA $0042 ; orientationID = NONE; <br> <br> drawCurtainRow: <br> <br> 9A2D: LDA #$4F <br> 9A2F: STA ($B8),Y ; playfield[rowIndex + i] = CURTAIN_TILE; <br> 9A31: INY <br> 9A32: INC $00AA ; i++; <br> 9A34: LDA $00AA <br> 9A36: CMP #$0A ; if (i != 10) { <br> 9A38: BNE $9A2D ; goto drawCurtainRow; <br> ; } <br> <br> 9A3A: LDA $0058 <br> 9A3C: STA $0049 ; vramRow = curtainRow; <br> <br> incrementCurtainRow: <br> <br> 9A3E: INC $0058 ; curtainRow++; <br> <br> 9A40: LDA $0058 ; if (curtainRow != 20) { <br> 9A42: CMP #$14 ; return; <br> 9A44: BNE $9A46 ; } <br> <br> 9A46: RTS ; return; <br> <br> endGame: <br> <br> 9A47: LDA $00BE <br> 9A49: CMP #$02 <br> 9A4B: BEQ $9A64 ; if (numberOfPlayers == 1) { <br> <br> 9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; } <br> <br> 9A5E: LDA $00F5 ; if (not just pressed Start) { <br> 9A60: CMP #$10 ; return; <br> 9A62: BNE $9A6A ; } <br> ; } <br> <br> 9A64: LDA #$00 <br> 9A66: STA $0048 ; playState = INITIALIZE_ORIENTATION_ID; <br> 9A68: STA $00F5 ; clear newly pressed buttons; <br> <br> 9A6A: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The lines of the playing field are incrementally copied to VRAM for display. </font><font style="vertical-align: inherit;">The index of the current copied string is contained in </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0049</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">The address is </font></font><code>$9A3C</code> <code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assigned a value </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, which ultimately makes this line visible when rendering. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manipulations with VRAM occur during the vertical blanking interval, which is recognized by the interrupt handler described in the ‚ÄúLegal Information Screen‚Äù section. </font><font style="vertical-align: inherit;">It calls the subroutine shown below (marked in the comments of the interrupt handler as </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">The rendering mode is similar to the game mode. </font><font style="vertical-align: inherit;">It is stored at an address </font><font style="vertical-align: inherit;">and can be one of the following values:</font></font><br><br> <code>804B: LDA $00BD <br> 804D: JSR $AC82 ; switch(renderMode) { <br> 8050: B1 82 ; case 0: goto 82B1; // Legal and title screens <br> 8052: DA 85 ; case 1: goto 85DA; // Menu screens <br> 8054: 44 A3 ; case 2: goto A344; // Congratulations screen <br> 8056: EE 94 ; case 3: goto 94EE; // Play and demo <br> 8058: 95 9F ; case 4: goto 9F95; // Ending animation <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00BD</code><font style="vertical-align: inherit;"></font><br><br><table><tbody><tr><th>  Value </th><th>  Description </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Screen with jur. </font><font style="vertical-align: inherit;">information and screen saver</font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu screens </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Congratulations screen </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Game and demo </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An animation of the ending </font></font></td></tr></tbody></table><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part of the rendering mode is </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shown below. </font><font style="vertical-align: inherit;">As you can see below, it </font><font style="vertical-align: inherit;">sends to VRAM the string of the playing field that has an index </font><font style="vertical-align: inherit;">. If </font><font style="vertical-align: inherit;">more than 20, the subroutine does nothing. </font><font style="vertical-align: inherit;">The table </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) contains VRAM addresses in little endian format corresponding to the displayed lines of the playing field shifted by 6 in normal mode and ‚àí2 and 12 for the playing field in unfinished 2 Player Versus mode. The bytes of this table are part of a list of values ‚Äã‚Äãthat are erroneously displayed as level numbers after level 29. The adjacent lower and upper bytes of each address are obtained separately and are essentially combined into a 16-bit address that is used in the copy cycle. </font><font style="vertical-align: inherit;">At the end of the subroutine, the increment is executed.</font></font><br><br> <code>952A: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 952D: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9530: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9533: JSR $9725 ; copyPlayfieldRowToVRAM();</code> <br> <br><font style="vertical-align: inherit;"></font><code>copyPlayfieldRowToVRAM()</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><br><br> <code>9725: LDX $0049 ; if (vramRow &gt; 20) { <br> 9727: CPX #$15 ; return; <br> 9729: BPL $977E ; } <br> <br> 972B: LDA $96D6,X <br> 972E: TAY ; playfieldAddress = 10 * vramRow; <br> <br> 972F: TXA <br> 9730: ASL <br> 9731: TAX <br> 9732: INX ; high = vramPlayfieldRows[vramRow * 2 + 1]; <br> 9733: LDA $96EA,X <br> 9736: STA $2006 <br> 9739: DEX <br> <br> 973A: LDA $00BE <br> 973C: CMP #$01 <br> 973E: BEQ $975E ; if (numberOfPlayers == 2) { <br> <br> 9740: LDA $00B9 <br> 9742: CMP #$05 <br> 9744: BEQ $9752 ; if (leftPlayfield) { <br> <br> 9746: LDA $96EA,X <br> 9749: SEC <br> 974A: SBC #$02 <br> 974C: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] - 2; <br> <br> 974F: JMP $9767 ; } else { <br> <br> 9752: LDA $96EA,X <br> 9755: CLC <br> 9756: ADC #$0C <br> 9758: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] + 12; <br> <br> 975B: JMP $9767 ; } else { <br> <br> 975E: LDA $96EA,X <br> 9761: CLC <br> 9762: ADC #$06 ; low = vramPlayfieldRows[vramRow * 2] + 6; <br> 9764: STA $2006 ; } <br> <br> ; vramAddress = (high &lt;&lt; 8) | low; <br> <br> 9767: LDX #$0A <br> 9769: LDA ($B8),Y <br> 976B: STA $2007 <br> 976E: INY ; for(i = 0; i &lt; 10; i++) { <br> 976F: DEX ; vram[vramAddress + i] = playfield[playfieldAddress + i]; <br> 9770: BNE $9769 ; } <br> <br> 9772: INC $0049 ; vramRow++; <br> 9774: LDA $0049 ; if (vramRow &lt; 20) { <br> 9776: CMP #$14 ; return; <br> 9778: BMI $977E ; } <br> <br> 977A: LDA #$20 <br> 977C: STA $0049 ; vramRow = 32; <br> <br> 977E: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramPlayfieldRows</code><font style="vertical-align: inherit;"></font><code>$96EA</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. If the value reaches 20, then it is assigned a value of 32, meaning that the copying is fully completed. As shown above, only 4 lines are copied per frame. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The state handler </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is responsible for recognizing completed lines and removing them from the playing field. For 4 separate calls, it scans the offsets of the lines </font></font><code>[‚àí2, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">near the center of tetrimino (both coordinates of all the squares of tetrimino are in this interval). Indexes of completed lines are stored at </font></font><code>$004A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$004D</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; The recorded index 0 is used to indicate that no complete line was found in this passage. The handler is shown below. </font><font style="vertical-align: inherit;">Verification </font><font style="vertical-align: inherit;">at the beginning does not allow the handler to perform when transferring the lines of the playing field to VRAM (state handler</font></font><br><br> <code>9A6B: LDA $0049 <br> 9A6D: CMP #$20 ; if (vramRow &lt; 32) { <br> 9A6F: BPL $9A74 ; return; <br> 9A71: JMP $9B02 ; } <br> <br> 9A74: LDA $0041 ; rowY = tetriminoY - 2; <br> 9A76: SEC <br> 9A77: SBC #$02 ; if (rowY &lt; 0) { <br> 9A79: BPL $9A7D ; rowY = 0; <br> 9A7B: LDA #$00 ; } <br> <br> 9A7D: CLC <br> 9A7E: ADC $0057 <br> 9A80: STA $00A9 ; rowY += lineIndex; <br> <br> 9A82: ASL <br> 9A83: STA $00A8 <br> 9A85: ASL <br> 9A86: ASL <br> 9A87: CLC <br> 9A88: ADC $00A8 <br> 9A8A: STA $00A8 ; rowIndex = 10 * rowY; <br> <br> 9A8C: TAY <br> 9A8D: LDX #$0A <br> 9A8F: LDA ($B8),Y <br> 9A91: CMP #$EF ; for(i = 0; i &lt; 10; i++) { <br> 9A93: BEQ $9ACC ; if (playfield[rowIndex + i] == EMPTY_TILE) { <br> 9A95: INY ; goto rowNotComplete; <br> 9A96: DEX ; } <br> 9A97: BNE $9A8F ; } <br> <br> 9A99: LDA #$0A <br> 9A9B: STA $06F1 ; play row completed sound effect; <br> <br> 9A9E: INC $0056 ; completedLines++; <br> <br> 9AA0: LDX $0057 <br> 9AA2: LDA $00A9 <br> 9AA4: STA $4A,X ; lines[lineIndex] = rowY; <br> <br> 9AA6: LDY $00A8 <br> 9AA8: DEY <br> 9AA9: LDA ($B8),Y <br> 9AAB: LDX #$0A <br> 9AAD: STX $00B8 <br> 9AAF: STA ($B8),Y <br> 9AB1: LDA #$00 <br> 9AB3: STA $00B8 <br> 9AB5: DEY ; for(i = rowIndex - 1; i &gt;= 0; i--) { <br> 9AB6: CPY #$FF ; playfield[i + 10] = playfield[i]; <br> 9AB8: BNE $9AA9 ; } <br> <br> 9ABA: LDA #$EF <br> 9ABC: LDY #$00 <br> 9ABE: STA ($B8),Y <br> 9AC0: INY ; for(i = 0; i &lt; 10; i++) { <br> 9AC1: CPY #$0A ; playfield[i] = EMPTY_TILE; <br> 9AC3: BNE $9ABE ; } <br> <br> 9AC5: LDA #$13 <br> 9AC7: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9AC9: JMP $9AD2 ; goto incrementLineIndex; <br> <br> rowNotComplete: <br> <br> 9ACC: LDX $0057 <br> 9ACE: LDA #$00 <br> 9AD0: STA $4A,X ; lines[lineIndex] = 0; <br> <br> incrementLineIndex: <br> <br> 9AD2: INC $0057 ; lineIndex++; <br> <br> 9AD4: LDA $0057 ; if (lineIndex &lt; 4) { <br> 9AD6: CMP #$04 ; return; <br> 9AD8: BMI $9B02 ; } <br> <br> 9ADA: LDY $0056 <br> 9ADC: LDA $9B53,Y <br> 9ADF: CLC <br> 9AE0: ADC $00BC <br> 9AE2: STA $00BC ; totalGarbage += garbageLines[completedLines]; <br> <br> 9AE4: LDA #$00 <br> 9AE6: STA $0049 ; vramRow = 0; <br> 9AE8: STA $0052 ; clearColumnIndex = 0; <br> <br> 9AEA: LDA $0056 <br> 9AEC: CMP #$04 <br> 9AEE: BNE $9AF5 ; if (completedLines == 4) { <br> 9AF0: LDA #$04 ; play Tetris sound effect; <br> 9AF2: STA $06F1 ; } <br> <br> 9AF5: INC $0048 ; if (completedLines &gt; 0) { <br> 9AF7: LDA $0056 ; playState = DISPLAY_LINE_CLEARING_ANIMATION; <br> 9AF9: BNE $9B02 ; return; <br> ; } <br> <br> 9AFB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 9AFD: LDA #$07 <br> 9AFF: STA $06F1 ; play piece locked sound effect; <br> <br> 9B02: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">called in each frame). If the filled rows are found, it is </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reset to 0, which causes the full transfer to be performed. </font></font><br><br> <code>lineIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) is initialized with a value of 0 and its increment is executed in each pass. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unlike the game state </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and subroutines to copy the playing field, which use the multiplication table at an address </font></font><code>$96D6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a block that starts with </font></font><code>$9A82</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplies </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">by 10 using shifts and addition: </font></font><br><br> <code>rowIndex = (rowY &lt;&lt; 1) + (rowY &lt;&lt; 3); // rowIndex = 2 * rowY + 8 * rowY;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is done only because it is </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limited by an interval </font></font><code>[0, 20]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and the multiplication table covers only </font></font><code>[0, 19]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Scanning rows can go beyond the end of the playing field. However, as said earlier, the game initializes </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with the value</font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(empty tile), creating more than 5 additional empty hidden lines under the floor of the playing field. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The block starting with </font></font><code>$9ADA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is part of the unfinished 2 Player Versus mode. As stated above, cleaning up the ranks adds trash to the opponent‚Äôs playing field. The number of garbage rows is determined by the table at </font></font><code>$9B53</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">The cycle at the address </font><font style="vertical-align: inherit;">shifts the material above the filled row one line down. It takes advantage of the fact that each line in continuous sequence is separated from the other by 10 bytes. The next loop clears the top row. </font><font style="vertical-align: inherit;">The row cleaning animation is performed during the game state </font><font style="vertical-align: inherit;">, but as shown below, it does not occur in the game state handler, which is completely empty.</font></font><br><br> <code>9B53: 00 ; no cleared lines <br> 9B54: 00 ; Single <br> 9B55: 01 ; Double <br> 9B56: 02 ; Triple <br> 9B57: 04 ; Tetris</code> <br> <br><font style="vertical-align: inherit;"></font><code>$9AA6</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$04</code><font style="vertical-align: inherit;"></font><br><br> <code>9E39: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instead, the </font></font><code>$04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">following rendering branching is performed </font><font style="vertical-align: inherit;">during the game state </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">and mirrored values ‚Äã‚Äãare needed for unfinished 2 Player Versus mode. </font><font style="vertical-align: inherit;">The subroutine is shown below </font><font style="vertical-align: inherit;">. It is called in each frame, but the condition at the beginning allows it to be performed only in every fourth frame. In each pass, it cycles through the list of indexes of completed rows and clears 2 columns in these rows, moving from the center column to the outside. </font><font style="vertical-align: inherit;">The 16-bit VRAM address is composed in the same way that is shown in the playing field copying routine. However, in this case, it performs an offset to the column index obtained from the table shown below.</font></font><br><br> <code>94EE: LDA $0068 <br> 94F0: CMP #$04 <br> 94F2: BNE $9522 ; if (playState == DISPLAY_LINE_CLEARING_ANIMATION) { <br> <br> 94F4: LDA #$04 <br> 94F6: STA $00B9 ; leftPlayfield = true; <br> <br> 94F8: LDA $0072 <br> 94FA: STA $0052 <br> 94FC: LDA $006A <br> 94FE: STA $004A <br> 9500: LDA $006B <br> 9502: STA $004B <br> 9504: LDA $006C <br> 9506: STA $004C <br> 9508: LDA $006D <br> 950A: STA $004D <br> 950C: LDA $0068 <br> 950E: STA $0048 ; mirror values; <br> <br> 9510: JSR $977F ; updateLineClearingAnimation(); <br> <br> ; ... <br> ; }</code> <br> <br> <code>leftPlayfield</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>updateLineClearingAnimation()</code><font style="vertical-align: inherit;"></font><br><br> <code>977F: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9781: AND #$03 ; return; <br> 9783: BNE $97FD ; } <br> <br> 9785: LDA #$00 ; for(i = 0; i &lt; 4; i++) { <br> 9787: STA $00AA ; rowY = lines[i]; <br> 9789: LDX $00AA ; if (rowY == 0) { <br> 978B: LDA $4A,X ; continue; <br> 978D: BEQ $97EB ; } <br> <br> 978F: ASL <br> 9790: TAY <br> 9791: LDA $96EA,Y <br> 9794: STA $00A8 ; low = vramPlayfieldRows[2 * rowY]; <br> <br> 9796: LDA $00BE ; if (numberOfPlayers == 2) { <br> 9798: CMP #$01 ; goto twoPlayers; <br> 979A: BNE $97A6 ; } <br> <br> 979C: LDA $00A8 <br> 979E: CLC <br> 979F: ADC #$06 <br> 97A1: STA $00A8 ; low += 6; <br> <br> 97A3: JMP $97BD ; goto updateVRAM; <br> <br> twoPlayers: <br> <br> 97A6: LDA $00B9 <br> 97A8: CMP #$04 <br> 97AA: BNE $97B6 ; if (leftPlayfield) { <br> <br> 97AC: LDA $00A8 <br> 97AE: SEC <br> 97AF: SBC #$02 <br> 97B1: STA $00A8 ; low -= 2; <br> <br> 97B3: JMP $97BD ; } else { <br> <br> 97B6: LDA $00A8 <br> 97B8: CLC <br> 97B9: ADC #$0C ; low += 12; <br> 97BB: STA $00A8 ; } <br> <br> updateVRAM: <br> <br> 97BD: INY <br> 97BE: LDA $96EA,Y <br> 97C1: STA $00A9 <br> 97C3: STA $2006 <br> 97C6: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97C8: LDA $97FE,X <br> 97CB: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97CC: ADC $00A8 <br> 97CE: STA $2006 ; vramAddress = rowAddress + leftColumns[clearColumnIndex]; <br> 97D1: LDA #$FF <br> 97D3: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97D6: LDA $00A9 <br> 97D8: STA $2006 <br> 97DB: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97DD: LDA $9803,X <br> 97E0: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97E1: ADC $00A8 <br> 97E3: STA $2006 ; vramAddress = rowAddress + rightColumns[clearColumnIndex]; <br> 97E6: LDA #$FF <br> 97E8: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97EB: INC $00AA <br> 97ED: LDA $00AA <br> 97EF: CMP #$04 <br> 97F1: BNE $9789 ; } <br> <br> 97F3: INC $0052 ; clearColumnIndex++; <br> 97F5: LDA $0052 ; if (clearColumnIndex &lt; 5) { <br> 97F7: CMP #$05 ; return; <br> 97F9: BMI $97FD ; } <br> <br> 97FB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 97FD: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>97FE: 04 03 02 01 00 ; left columns <br> 9803: 05 06 07 08 09 ; right columns</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cleaning animation requires 5 passes. Then the code goes to the next game state. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The game state handler </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains the code described in the ‚ÄúSeries and Statistics‚Äù section. The handler ends with this code: The </font><font style="vertical-align: inherit;">variable is </font><font style="vertical-align: inherit;">not reset until the completion of the game state </font><font style="vertical-align: inherit;">, after which it is used to update the total number of rows and the score. This sequence allows for an interesting bug. In the demo mode, you need to wait until the game has collected a full row, and then quickly press Start, until the row cleaning animation has ended. The game will return to the splash screen, but if you select the correct time, the value will </font><font style="vertical-align: inherit;">remain. Now you can start the game in A-Type mode. When locking in place of the first figure, the game state handler</font></font><br><br> <code>9C9E: LDA #$00 <br> 9CA0: STA $0056 ; completedLines = 0; <br> <br> 9CA2: INC $0048 ; playState = B_TYPE_GOAL_CHECK; <br> <br> 9CA4: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$05</code><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">starts scanning completed rows. He will not find them, but will leave them </font></font><code>completedLines</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unchanged. Finally, when you perform the game state, the </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">total number of rows and the score will increase, as if you had typed them. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The easiest way to do this and get the most, waiting for the demo to collect Tetris (there will be 2 in the demo). As soon as you see the screen flicker, press Start.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a8/80a/091/2a880a09173c42fb8c5256f9921a635b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After starting a new game, the screen will continue to flicker. All this thanks to the following code, called the interrupt handler. </font><font style="vertical-align: inherit;">In fact, if you let the first piece automatically descend to the floor of the playing field, the score will increase by an even greater value, because </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) will also save its value from the demo. This is true even in cases where the demo did not fill a single row. </font><font style="vertical-align: inherit;">is not reset until the Down button is pressed. </font><font style="vertical-align: inherit;">Moreover, if you press Start during the animation of cleaning the rows of the Tetris combination in demo mode, and then wait for the demo to start again, the demo will not only score points for Tetris, but will also confuse the entire timing. As a result, the demo will lose the game. After the end of the game curtain, you can return to the splash screen by clicking on Start.</font></font><br><br> <code>9673: LDA #$3F <br> 9675: STA $2006 <br> 9678: LDA #$0E <br> 967A: STA $2006 ; prepare to modify background tile color; <br> <br> 967D: LDX #$00 ; color = DARK_GRAY; <br> <br> 967F: LDA $0056 <br> 9681: CMP #$04 <br> 9683: BNE $9698 ; if (completedLines == 4) { <br> <br> 9685: LDA $00B1 <br> 9687: AND #$03 <br> 9689: BNE $9698 ; if (frameCounter divisible by 4) { <br> <br> 968B: LDX #$30 ; color = WHITE; <br> <br> 968D: LDA $00B1 <br> 968F: AND #$07 <br> 9691: BNE $9698 ; if (frameCounter divisible by 8) { <br> <br> 9693: LDA #$09 <br> 9695: STA $06F1 ; play clear sound effect; <br> <br> ; } <br> ; } <br> ; } <br> <br> 9698: STX $2007 ; update background tile color;</code> <br> <br><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><code>$004F</code><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The game state </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">performs a goal check for B-Type mode games. </font><font style="vertical-align: inherit;">In A-Type mode, it is essentially an unused frame. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The game state </font></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contains only the unfinished mode logic 2 Player Versus. </font><font style="vertical-align: inherit;">In single player mode, it behaves like an unused frame. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The game state is </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discussed in the sections ‚ÄúCreating Tetrimino‚Äù and ‚ÄúChoosing Tetrimino‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The game state is </font></font><code>$09</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not used. </font></font><code>$0B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">increases the game state, but also looks unused. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now, finally, the main game loop:</font></font><br><br> <code>; while(true) { <br> <br> 8138: JSR $8161 ; branchOnGameMode(); <br> <br> 813B: CMP $00A7 ; if (vertical blanking interval wait requested) { <br> 813D: BNE $8142 ; waitForVerticalBlankingInterval(); <br> 813F: JSR $AA2F ; } <br> <br> 8142: LDA $00C0 <br> 8144: CMP #$05 <br> 8146: BNE $815A ; if (gameMode == DEMO) { <br> <br> 8148: LDA $00D2 <br> 814A: CMP #$DF <br> 814C: BNE $815A ; if (reached end of demo table) { <br> <br> 814E: LDA #$DD <br> 8150: STA $00D2 ; reset demo table index; <br> <br> 8152: LDA #$00 <br> 8154: STA $00B2 ; clear upper byte of frame counter; <br> <br> 8156: LDA #$01 <br> 8158: STA $00C0 ; gameMode = TITLE_SCREEN; <br> ; } <br> ; } <br> 815A: JMP $8138 ; }</code> </div><p>Source: <a href="https://habr.com/ru/post/420725/">https://habr.com/ru/post/420725/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420707/index.html">JITX startup uses AI to automate the development of complex printed circuit boards</a></li>
<li><a href="../420709/index.html">T2F: project to convert text to face drawing with in-depth training</a></li>
<li><a href="../420711/index.html">Moscow Data Science Major: announcement and registration</a></li>
<li><a href="../420713/index.html">How Chuck Hull Invented 3D Printing</a></li>
<li><a href="../420715/index.html">Hard truth about the burden of learning</a></li>
<li><a href="../420729/index.html">Open webinar "Naive Bayes Classifier"</a></li>
<li><a href="../420731/index.html">Zabbix on steroids: how the Sbertech single monitoring platform is arranged</a></li>
<li><a href="../420735/index.html">We invite you to the finale of the marathon ‚ÄúFind yourself in digital‚Äù in the office of Mail.Ru Group</a></li>
<li><a href="../420737/index.html">Mini ai cup 2 or almost AgarIO - what could be done to win</a></li>
<li><a href="../420739/index.html">The box is still in the pen: why in 2018 you still need to learn languages ‚Äã‚Äãyourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>