<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PowerLoader 64-bit updated with new LPE exploits</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few months ago we wrote about PowerLoader . This malicious code uses an interesting privilege elevation method in the context of explorer.exe. Power...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PowerLoader 64-bit updated with new LPE exploits</h1><div class="post__text post__text-html js-mediator-article">  A few months ago we <a href="http://habrahabr.ru/company/eset/blog/174169/">wrote</a> about <b>PowerLoader</b> .  This malicious code uses an interesting privilege elevation method in the context of explorer.exe.  PowerLoader sources that are publicly available are also used in other malware families.  For example, the <a href="http://habrahabr.ru/company/eset/blog/169131/">Win32 /</a> Gapz bootkit <a href="http://habrahabr.ru/company/eset/blog/169131/">droppers</a> are based on this PowerLoader code.  In August, we discovered a new modification of the PowerLoader for 64-bit OS (found by ESET as <b>Win64 / Vabushky.A</b> ).  This modification uses three exploits to raise its privileges in the system (Local Privelege Escalation): <a href="https://technet.microsoft.com/en-gb/security/bulletin/ms13-053">MS13-053</a> (CVE-2013-3660), <a href="https://technet.microsoft.com/en-gb/security/bulletin/ms12-041">MS12-041</a> (CVE-2012-1864), and <a href="https://technet.microsoft.com/en-gb/security/bulletin/ms12-042">MS12-042</a> (CVE-2012-0217) .  The use of such exploits has not previously been observed in PowerLoader samples or related families.  <a href="https://twitter.com/matrosov">Alexander Matrosov</a> performed an analysis of this malware. <br><br>  <b>Win64 / Vabushky malware</b> is a good example of how quickly attackers update their projects using <a href="http://habrahabr.ru/company/eset/blog/184576/">Carberp source code</a> .  Two 64-bit exploits (CVE-2012-1864 and CVE-2012-0217) from the new PowerLoader are based on Carberp source code.  It is also worth noting that the PowerLoader code, which became available to the public in April 2013, provoked a new wave of propagation of droppers based on it. <br><br><a name="habracut"></a>  Win64 / Vabushky droppers are packed using <a href="http://www.matcode.com/mpress.htm">MPRESS</a> , as this packer is one of the few free products that supports 64-bit PE32 + files.  After unpacking, the dropper retrieves the original PE32 + header with a compile time as shown below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage3/e0f/e83/b70/e0fe83b70206a544f1517737007b1df6.png"><br><br>  All files include a payload compiled in early August.  In the export table of this version of PowerLoader, you can see the changes compared to the older version. <br><br><img src="https://habrastorage.org/storage3/55c/e46/328/55ce46328bd523eed2732ad7fb81b963.png"><br><br>  After implementing the code in explorer.exe, PowerLoader tries to execute the following exploits in the context of trusted processes. <br><br><img src="https://habrastorage.org/storage3/60a/6fa/d7c/60a6fad7c9e1934f6352c3aaee2232b0.png"><br><br>  Such a set of exploits can be used to bypass certain types of sandboxes (sandboxes) that are used in security products, since these exploits use direct manipulation of kernel objects from user mode using the legal Win32 API. <br><br>  <b>CVE-2013-3660</b> <br><br>  In March, a researcher at Google Security Team <b>Tavis Ormandy</b> (@taviso) <a href="http://seclists.org/fulldisclosure/2013/May/91">discovered a</a> vulnerability CVE-2013-3660, which was closed by the July bulletin <a href="http://technet.microsoft.com/ru-ru/security/bulletin/ms13-053">MS13-053</a> .  We did not observe the 64-bit version of this exploit until the new modification of PowerLoader appeared, while the PoC x86 version is available to the public. <br><br>  Before directly exploiting, the exploit code creates a second desktop object ( <i>user32! CreateDesktopA</i> ) to hide the fact of working with GDI objects. <br><br><img src="https://habrastorage.org/storage3/59d/926/bd4/59d926bd4f70a05bcc1c741a2191ca78.png"><br><br>  The main operating code is shown below. <br><br><img src="https://habrastorage.org/storage3/996/1c1/302/9961c1302886ae14d99540888282fdcb.png"><br><br>  The shell code that is executed using <i>nt! NtQueryIntervalProfile</i> looks like this. <br><br><img src="https://habrastorage.org/storage3/6eb/866/f07/6eb866f076ceb46aa3305d3fef316361.png"><br><br>  This operating code does not work in 64-bit Windows 8, because it cannot bypass Intel SMEP hardware technology (Supervisor Mode Execution Protection), which the new OS software supports.  <a href="http://j00ru.vexillium.org/%3Fp%3D783">SMEP</a> blocks the execution of code pages of user address space in kernel mode and in the 64-bit version of Windows 8 <a href="http://blog.ptsecurity.com/2012/09/bypassing-intel-smep-on-windows-8-x64.html">can be bypassed</a> using ROP.  However, Intel has already announced another protective technology SMAP (Supervisor Mode Access Prevention), which introduces additional restrictions on access to memory pages.  Both of these SMAP and SMEP technologies are designed to prevent the exploitation of a <a href="http://www.ivanlef0u.tuxfamily.org/%3Fp%3D355">NULL pointer dereference vulnerability</a> in kernel mode, but SMAP is not yet supported in Windows. <br><br>  <b>CVE-2012-0217 and CVE-2012-1864</b> <br><br>  The exploit code for these vulnerabilities is based on leaked Carberp sources.  We did not observe 64-bit versions of ITE CVE-2012-1864 before the Carberp texts were made publicly available.  The operating code CVE-2012-0217, which is publicly available, does not work stably on 64-bit OS versions.  After inspecting the executable exploit files in the Carberp texts, it was determined that they indicated the same path to the build directories. <br><br><img src="https://habrastorage.org/storage3/7a9/221/5a3/7a92215a3f7be4062b444a26b43c5c67.png"><br><br><img src="https://habrastorage.org/storage3/336/a89/161/336a891618104159bf69f164cb4f7dab.png"><br><br>  This indicates that the exploits were developed on one system and, possibly, by one person.  The exploit code CVE-2012-0217 is significantly different from the publicly available PoC, which demonstrates the possibilities of exploitation.  The version of the text exploit Carberp is more stable and supports 64-bit operating systems.  Below are the matches in the code blocks of these versions of the exploit for CVE-2012-0217 (the code from the PowerLoader is indicated on the left). <br><br><img src="https://habrastorage.org/storage3/c75/bf9/62a/c75bf962ad64a1018adff34725499ff0.png"><br><br>  At first glance, they seem very similar.  The main differences are found only in the additional debug-code, which is not included in the modification of PowerLoader.  In addition, there are several methods in it to make operation more stable. <br><br><img src="https://habrastorage.org/storage3/2fc/21b/d06/2fc21bd06bda3314c409d164c8b4b708.png"><br><br>  This code provides a modification of <i>nt! HalDispatchTable</i> in order to avoid one hundred percent CPU load by multiple threads during operation. <br><br>  The exploit for CVE-2012-1864 was also not publicly available until the new modification of PowerLoader.  The vulnerability was discovered by <b>Tarjei Mandt</b> (aka @kernelpool) from Azimuth Security.  Details of the vulnerability were made public in his <a href="http://www.recon.cx/2012/schedule/events/215.en.html">Smashing the Atom</a> report at the RECon conference in June 2012, but the exploitation code was not published to the public.  The exploit code from PowerLoader looks more optimized and does not contain any debug information.  The following shows the differences in the different versions of this exploit, in the second screenshot, the version from PowerLoader, in which there is no debug output. <br><br><img src="https://habrastorage.org/storage3/92a/d3c/caa/92ad3ccaaba361e3999d9a69aa54cb0f.png"><br><br><img src="https://habrastorage.org/storage3/f3e/f9b/ab3/f3ef9bab3204a38d3c2e332bad908278.png"><br><br>  Both of these exploits for CVE-2012-0217 and CVE-2012-1864 vulnerabilities are good examples of bypassing the sandbox mode in security products.  Exploits can manipulate kernel mode objects from user mode using standard WinAPI.  A good description of how to circumvent sandboxes using these types of vulnerabilities is presented in the presentation <a href="http://bromiumlabs.files.wordpress.com/2013/07/application_sandboxes_a_pen_tester_s_perspective2.pdf">"Application Sandboxes: A Pen-Tester's Perspective"</a> . <br><br>  <b>Payload</b> <br><br>  After the successful execution of the PowerLoader code and privilege escalation, the ransomware <i>(Win32 / Vabushky.A</i> ) ransomware is downloaded to the user's computer.  The extortioner file is executed after the loader has raised the current privileges to the maximum, that is, SYSTEM.  The Win64 / Vabushky dropper uses a trick with the legitimate self-generated certificate and its subsequent installation in the local storage as a measles target, that is, ROOT CA and TrustedPublisher.  The following code demonstrates this technique. <br><br><img src="https://habrastorage.org/storage3/f4b/0a3/1da/f4b0a31dac901790b48d7f60fb9ab9a5.png"><br><br>  This trick is not new and was already mentioned in the Mandiant <a href="https://www.mandiant.com/blog/hikit-rootkit-advanced-persistent-attack-techniques-part-2/">"The‚Äú Hikit ‚ÄùRootkit: Advanced and Persistent Attack</a> analysis.  In addition, during the installation process, the malicious code modifies Boot Configuration Data (BCD) data to activate test-signing mode, which allows you to download unsigned drivers.  The following figure shows the registry keys in which the driver is installed. <br><br><img src="https://habrastorage.org/storage3/c88/c77/d45/c88c77d45f2f2efcab4564fb439b83c9.png"><br><br>  The next step is to install a malicious driver into the system to block the system and display a screen with a specific cover that is downloaded from one of the URLs that are hard-wired in the code itself. <br><br><img src="https://habrastorage.org/storage3/e06/ea4/179/e06ea4179d8bd17a1516ab805d75a347.png"><br><br>  After all actions of the malware, the user gets a locked desktop. <br><br><img src="https://habrastorage.org/storage3/a00/8b8/86d/a008b886d46960ec02c87f0b1ed147a7.png"><br><br>  Win64 / Vabushky encrypts user files using Microsoft CryptoAPI.  After encryption, the .crypted extension is appended to the file.  The driver code uses standard screen lock techniques and does not deserve detailed discussion. <br><br>  <b>Conclusion</b> <br><br>  Win64 / Vabushky dropper uses an interesting modification of the PowerLoader code.  It uses LPE exploits for 64-bit operating systems from Carberp sources.  All modules and components extracted by Win64 / Vabushky are used specifically for the 64-bit version of Windows.  In addition, CVE-2013-3660 can operate a 32-bit version of Windows 8, which makes it universal.  At the same time, due to the limitations of Intel SMEP and its support in Windows 8, the operation code cannot work for the 64-bit version of the OS.  Thus, Microsoft‚Äôs efforts to provide additional security mechanisms in Windows 8 are indeed justified if the user is protected from exploits. </div><p>Source: <a href="https://habr.com/ru/post/191904/">https://habr.com/ru/post/191904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191892/index.html">To GIF or not to GIF?</a></li>
<li><a href="../191894/index.html">3CXPhone for Android user guide published</a></li>
<li><a href="../191896/index.html">MegaFon launches Russian accounting system in housing and public utilities</a></li>
<li><a href="../191898/index.html">Android component from scratch - 2 - Magnifier for image</a></li>
<li><a href="../191902/index.html">Create autonomous robot Frank. Part two</a></li>
<li><a href="../191906/index.html">Highscreen Omega Prime XL Review</a></li>
<li><a href="../191908/index.html">Loc Kit: localization management and machine translation</a></li>
<li><a href="../191910/index.html">Pixel-perfect layout of Android layouts</a></li>
<li><a href="../191912/index.html">OpenMP is now available in Clang!</a></li>
<li><a href="../191916/index.html">Rust key features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>