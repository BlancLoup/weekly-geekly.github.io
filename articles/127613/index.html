<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cisco ASA traffic accounting using NetFlow and nfdump on FreeBSD or Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Almost every network administrator faces the challenge of traffic accounting. Either this is necessary for billing, or simply for monit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cisco ASA traffic accounting using NetFlow and nfdump on FreeBSD or Linux</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Almost every network administrator faces the challenge of traffic accounting.  Either this is necessary for billing, or simply for monitoring activity. <br>  To solve this problem, you can use the standard <b><a href="http://ru.wikipedia.org/wiki/Netflow">NetFlow protocol</a></b> (RFC 3954), which is supported by network equipment manufacturers (Cisco, Juniper, 3Com, etc.), as well as Linux, * BSD and DD-WRT firmware.  Netflow allows you to transfer traffic data (sender and recipient address, port, amount of information, etc.) from network equipment ( <i>sensor</i> ) to the <i>collector</i> .  The collector, in turn, saves the received information.  As a collector, you can use a normal server.  I will illustrate the scheme with a picture from Wikipedia: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/62a/d70/941/62ad70941f154ef7b96d8a88b74785e5.png" alt="NetFlow architecture"><br><br>  When I undertook to configure NetFlow, it turned out that opensource solutions for the implementation of the collector do not work well with Cisco ASA, and there is very little information on the Internet, which is the case in this case.  I decided to fill this gap: it is possible to make friends FreeBSD / Linux with Cisco ASA in 20 minutes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  Let's start with the fact that I did not work: <br>  Flow-tools - does not work at all, apparently does not support NetFlow v9. <br>  flowd - does not save data on the number of bytes transferred and packets. <br>  nfcapd - incorrectly saves the date and time, the number of bytes transferred. <br><br>  I do not deny the possibility that my crooked hands are to blame, or that the new version of these programs will add bug-free support for the Cisco ASA. <br><br><h4>  Collector </h4><br>  After a long search, I came across a version of nfdump with NSEL support: <a href="http://sourceforge.net/projects/nfdump/files/nsel/nfdump-1.5.8-NSEL/">nfdump-1.5.8-NSEL</a> , which works fine with ASA. <br><br>  The installation process is standard: <br>  First we download and unpack nfdump-1.5.8-NSEL. <br>  Then in the nfdump-1.5.8-NSEL folder: <br> <code>./configure <br> make <br> make install</code> <br> <br>  After that we will get several programs: <br>  nfcapd is a daemon collector, listens to the port, collects data and writes to files. <br>  nfdump - reads and prints data collected by nfcapd. <br>  nfexpire - rotates files created by nfcapd. <br>  nfreplay - reads the collected nfcapd files and sends them over the network to another collector. <br><br>  Start the collector: <br> <code>nfcapd -l &lt;   &gt; -t &lt;   ()&gt; -D</code> <br> <br>  nfcapd will start writing the resulting data to a temporary file nfcapd.current.  <i>PID</i> in the folder specified by the -l option.  When the time interval specified by -t passes, nfcapd will copy the contents of the temporary file to nfcapd.  <i>yyyymmddhhmm</i> .  Thus, each such file will contain information about traffic for the last -t seconds. <br>  The -D switch indicates to work in daemon mode. <br>  The -b parameter specifies the IP address to listen; -p allows you to change the default port. <br><br><h4>  Sensor </h4><br>  Now you need to configure the Cisco ASA.  Because  I am a layman in Cisco, I will provide links to ready-made manuals: <br>  <a href="https://supportforums.cisco.com/docs/DOC-6114">If you configure the ASA through the ASDM GUI.</a> <br>  <a href="http://knowledgebase.solarwinds.com/kb/questions/795/Configuring%2BCisco%2BASA%2Bdevices%2Bfor%2Buse%2Bwith%2BOrion%2BNTA">If you configure ASA through the tru console.</a> <br><br>  Unfortunately, in my version of ASDM (6.3) there was a glitch that did not allow adding a collector to the policy rule, so I still had to climb into the console. <br><br>  Now, if everything went well, the following packages should fall onto the collector: <br> <code>tcpdump port 9995 <br> tcpdump: verbose output suppressed, use -v or -vv for full protocol decode <br> listening on em0, link-type EN10MB (Ethernet), capture size 96 bytes <br> 18:22:36.909747 IP 192.168.4.1.56684 &gt; 192.168.4.7.9995: UDP, length 1436 <br> 18:22:37.012687 IP 192.168.4.1.56684 &gt; 192.168.4.7.9995: UDP, length 1464 <br> 18:22:37.065782 IP 192.168.4.1.56684 &gt; 192.168.4.7.9995: UDP, length 1432 <br> ... <br></code> <br>  And in the folder where the nfcapd files are saved, the size of the files should start to grow. <br><br><h4>  Garbage collection </h4><br>  At ~ 30 connections per second (network 150 users), the log in 1 minute takes about 2 MB. <br>  To avoid cluttering up the disk, add the nfexpire command to the crontab: <br> <code>/usr/local/bin/nfexpire -e &lt;   &gt; -s &lt;.  &gt; -t &lt;.   &gt;</code> <br>  For example, running nfexpire with the -t 2w option will remove all files older than two weeks, and with -s 20g the oldest files, so that their total size is no more than 20 GB.  These parameters can be used together. <br><br><h4>  Data processing </h4><br>  You can get data from nfcapd. * Files in a human-readable format using the nfdump utility: <br> <code>nfdump -r &lt;  &gt; <br> 2011-09-04 19:53:45.484 TCP 192.168.2.11:1057 NA -&gt; 217.20.152.98:80 DENIED I-ACL 0 <br> 2011-09-04 19:53:45.554 TCP 66.249.66.34:55383 NA -&gt; 46.46.152.214:80 DELE-U Deleted 0 <br> 2011-09-04 19:53:30.887 TCP 192.168.4.183:63015 46.46.152.212:63015 -&gt; 89.185.97.235:80 CREATE Ignore 214 <br> ... <br></code> <br>  As you can see, the output of nfdump is easily amenable to further parsing.  It is necessary to take into account that each record contains information not about a single packet, but about a <i>stream</i> ‚Äî a set of packets passing in one direction. <br>  Nfdump can also read multiple files, collect statistics and filter entries. <br><br>  There is also a web interface to nfdump - <a href="http://nfsen.sourceforge.net/">NfSen</a> , which can draw beautiful graphics. <br><br>  If you want to process the data yourself, you will need the -x key of the nfcapd daemon - it allows you to start the program when the next file is ready.  For example, I wrote a php script to process the nfdump output, and my nfcapd startup line looks like this: <br> <code>/usr/local/bin/nfcapd -t 600 -w -p 9999 -l /data/flows/ -D -x '/usr/local/bin/php /usr/local/share/sams/all_traf_stats.php %d/%f' &amp;</code> <br>  Note that the command is enclosed in single quotes, and that as parameters to the script,% d is transferred and% f is the nfcapd folder and the name of the last file, respectively. <br><br>  Logging each packet in the database turned out to be very expensive, so my script simply counts the statistics for each host and protocol in bytes every 10 minutes.  Thus, I track the airborne machines and lovers download the organization of the organization by downloading movies - in the morning I receive a letter from the top20 ‚Äúrocking players‚Äù.  Also, the data from nfdump complements the statistics of the transparent proxy server Squid, which serves only the 80th port. <br>  If someone needs this script as an example, you can <a href="http://pastebin.com/8Rcccvmn">download it</a> , but do not expect beautiful code :) The script does a good job at ~ 500 entries per second.  If the load is very large, then he will begin to eat too much memory. <br><br><h4>  findings </h4><br>  Using NetFlow you can organize traffic accounting by retrieving information from routers and firewalls.  This allows you to log traffic, get billing statistics, or detect suspicious activity on the network.  Also in this topic, I tried to tell how to make Cisco ASA work in tandem with FreeBSD, because  At one time I did not find such a howto on the network. </div><p>Source: <a href="https://habr.com/ru/post/127613/">https://habr.com/ru/post/127613/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127606/index.html">Motivate correctly - give bream</a></li>
<li><a href="../127608/index.html">The tender for the game about the Great Patriotic War for 90 million</a></li>
<li><a href="../127609/index.html">How would you translate REpresentational State Transfer (REST) ‚Äã‚Äãinto Russian?</a></li>
<li><a href="../127611/index.html">TV with built-in BitTorrent client</a></li>
<li><a href="../127612/index.html">The thinnest, lightest - Toshiba AT200</a></li>
<li><a href="../127614/index.html">The evolution of Internet browsers</a></li>
<li><a href="../127616/index.html">Creating a CRUD Application on Symfony 2, Part 2</a></li>
<li><a href="../127620/index.html">Germany allowed the open sale of Doom II (after 17 years of ban)</a></li>
<li><a href="../127623/index.html">To launch the Farminers incubator: race for the prize of $ 150,000 or 10 "golden" rules of the young startups</a></li>
<li><a href="../127624/index.html">A social network has opened for the dead</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>