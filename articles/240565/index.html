<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Semi-automatic registration of unit tests on pure C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the book Test Driven Development for Embedded C, I began to get acquainted with the world of unit testing with the cppUtest framework. N...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Semi-automatic registration of unit tests on pure C</h1><div class="post__text post__text-html js-mediator-article">  After reading the book <a href="http://www.amazon.com/Driven-Development-Embedded-Pragmatic-Programmers/dp/193435662X">Test Driven Development for Embedded C,</a> I began to get acquainted with the world of unit testing with the cppUtest framework.  Not least because in it the newly written test is registered and launched independently.  You have to pay for it - using C ++, dynamic memory allocation somewhere in the depths of the framework.  Maybe you can somehow simpler? <br>  Most recently, I learned about the minimal <a href="http://www.jera.com/techinfo/jtns/jtn002.html">minUnit</a> framework, which fits just 4 lines. <br><a name="habracut"></a><br>  I will bring them here for clarity: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> mu_assert(message, test) do { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!(test)) return message; } while (0) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> mu_run_test(test) do { char *message = test(); tests_run++; \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (message) return message; } while (0) extern int tests_run;</span></span></code> </pre> <br>  Simple and beautiful.  In this case, writing a test looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ mu_assert(<span class="hljs-string"><span class="hljs-string">"error, foo != 7"</span></span>, foo == <span class="hljs-number"><span class="hljs-number">7</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Unfortunately, when I tried to use this framework, I very quickly realized that I was terribly lazy to register each test with my hands.  This is because you need to get a header file for a file with tests, each test in the file to register an ad, then go to main and register the call! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I looked at other frameworks written in pure C: almost everywhere is the same.  Alternatively, there are separate programs that scan sources with tests and generate code to run. <br>  But maybe it can be easier? <br><br>  <a href="http://habrahabr.ru/post/239387/">This post</a> inspired confidence in me, where a linker is used to register tests.  But I did not want to attach to the linker and the compiler-specific attributes. <br>  As far as I know, on pure C it is impossible to make a full test registration.  What about semi-automatic? <br><br>  The idea took shape as follows.  For each module, the file module_tests.c is written, all tests for this module are written in it.  These tests form a group.  In the same file is written the magic function of running all the tests in the group. <br>  And in the main'e need hands to register only the launch of the group, and not each test separately. <br>  This boils down to the following task: you need to somehow get a list of all the functions in the file.  In C, this can only be done with a preprocessor.  But how?  For example, if functions will be called somehow monotonous. <br><br>  The ‚Äúservice‚Äù names of the tests may well be anything, as long as the title of the test is intelligible! <br>  So, you need to use the preprocessor to generate names for function tests, and in the same pattern and in a single pattern.  For example, like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_TEST_COUNTER BOOST_PP_COUNTER #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_TEST_INCREMENT() BOOST_PP_UPDATE_COUNTER() #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_TOKEN(x, y, z) x ## y ## z #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_TOKEN2(x, y, z) UMBA_TOKEN(x,y,z) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_TEST( description ) static char * UMBA_TOKEN2(umba_test_, UMBA_TEST_COUNTER, _(void) )</span></span></code> </pre><br>  I admit honestly, I used the boost for the first time in my life and was amazed at the depth of my soul by the power of C preprocessor! <br>  Now you can write tests as follows: <br><br><pre> <code class="cpp hljs">UMBA_TEST(<span class="hljs-string"><span class="hljs-string">"Simple Test"</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  static char * umba_test_0_(void) { uint8_t a = 1; uint8_t b = 2; UMBA_CHECK(a == b, "MATHS BROKE"); return 0; } #include UMBA_TEST_INCREMENT()</span></span></code> </pre><br>  After this inclusion, the counter will be incremented and the name for the next test will generate the name static char * umba_test_1_ (void). <br><br>  It remains only to generate a function that will run all the tests in the file.  For this, an array of pointers to functions is created and filled with pointers to tests.  Then the function simply in the loop calls each test from the array. <br>  This function will need to be written at the end of the test file so that the value of UMBA_TEST_COUNTER equals the number of the last test. <br>  To generate an array of pointers, I first went along a simple path and wrote a helper-file of this kind: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> UMBA_TEST_COUNTER == 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_LOCAL_TEST_ARRAY UmbaTest umba_local_test_array[ UMBA_TEST_COUNTER ] = {umba_test_0_}; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> UMBA_TEST_COUNTER == 2 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_LOCAL_TEST_ARRAY UmbaTest umba_local_test_array[ UMBA_TEST_COUNTER ] = {umba_test_0_, umba_test_1_}; ‚Ä¶</span></span></code> </pre><br>  In principle, it is quite possible to do this by generating ads for several hundred tests.  Then from boost'a will need only one file - boost / preprocessor / slot / counter.hpp. <br>  But, since I started using boost, why not continue? <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_DECL(z, n, text) text ## n ## _, #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_LOCAL_TEST_ARRAY UmbaTest umba_local_test_array[ UMBA_TEST_COUNTER ] = { BOOST_PP_REPEAT( UMBA_TEST_COUNTER, UMBA_DECL, umba_test_ ) }</span></span></code> </pre><br>  Only two lines, but what power behind them is hidden! <br>  Add the trivial code for the group launch function itself: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_RUN_LOCAL_TEST_GROUP( groupName ) UMBA_LOCAL_TEST_ARRAY; \ char * umba_run_test_group_ ## groupName ## _(void) \ { \ for(uint32_t i=0; i &lt; UMBA_TEST_COUNTER; i++) \ { \ tests_run++; \ char * message = umba_local_test_array[i](); \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(message) \ return message; \ } \ return 0; \ } \</span></span></code> </pre><br>  And to launch it from main: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_EXTERN_TEST_GROUP( groupName ) char * umba_run_test_group_ ## groupName ## _(void); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UMBA_RUN_GROUP( groupName ) do { \ char *message = umba_run_test_group_ ## groupName ## _(); \ tests_run++; \ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (message) return message; \ } while (0)</span></span></code> </pre><br>  Voila  Now starting a group with any number of tests looks the same: <br><br><pre> <code class="cpp hljs">UMBA_EXTERN_TEST_GROUP( SimpleGroup ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_all_tests</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ UMBA_RUN_GROUP( SimpleGroup ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *result = run_all_tests(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-number"><span class="hljs-number">0</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"!!!!!!!!!!!!!!!!!!!\n"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, result); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"ALL TESTS PASSED\n"</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"Tests run: %d\n"</span></span>, tests_run<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><br>  I am quite pleased with this result.  Mechanical action when writing a test is now noticeably less. <br>  All the macros mentioned fit in 40-50 lines, which, unfortunately, is somewhat larger than minUnit (and much less obvious). <br>  <a href="https://mega.co.nz/">All code is complete.</a> <br><br>  Yes, there is a lot of functional missing from large frameworks, but, frankly, I have never been able to use something other than a simple check of the CHECK type (if true) in the test. <br>  Description for the test is just thrown away, but it would seem easy to do something useful with it, if you suddenly want to. <br><br>  What I would like to find out: <br><ol><li>  Have I invented something new or have they used this trick for many years? </li><li>  Can this be somehow improved?  I don‚Äôt really like the need to write some strange connection after each test, but I didn‚Äôt find any other implementations of the counter on the preprocessor (__COUNT__ is not supported by my compiler). </li><li>  Should I use a homemade framework in production? </li><li>  How the hell does BOOST_PP_COUNTER work ?!  Even on stackoverflow, the answer to the corresponding question is <a href="http://stackoverflow.com/a/6212493/1823524">‚Äúmagic‚Äù.</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/240565/">https://habr.com/ru/post/240565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240549/index.html">Barcelona tried to seize the domain in the .email zone</a></li>
<li><a href="../240555/index.html">DigitalOcean launches metadata server</a></li>
<li><a href="../240557/index.html">Using the proxy pattern to organize caching in PHP</a></li>
<li><a href="../240559/index.html">Pricing model for SaaS: more money - more problems</a></li>
<li><a href="../240561/index.html">Methods in primitive types of PHP</a></li>
<li><a href="../240571/index.html">Device for laying additional air lines</a></li>
<li><a href="../240573/index.html">Billing in SaaS applications on Ruby on Rails. Continued about 3-D Secure</a></li>
<li><a href="../240575/index.html">Partnership Docker and Microsoft: a lot of announcements</a></li>
<li><a href="../240577/index.html">Russian OVP - Telebreeze</a></li>
<li><a href="../240579/index.html">15 e-commerce trends for 2015</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>