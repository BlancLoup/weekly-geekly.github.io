<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How does ntds.dit work?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="All Active Directory data is stored in the database in the ntds.dit file. The vast majority of applications interact with the directory through the DS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How does ntds.dit work?</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/34c/2b7/a4b/34c2b7a4b46784d8e3232fbd9086186c.gif"><br>  All Active Directory data is stored in the database in the ntds.dit file.  The vast majority of applications interact with the directory through the DSA layer implemented in ntdsa.dll.  In turn, functions from ntdsa.dll do not work directly with ntds.dit, their functionality is limited by the needs of the directory service and they cannot give us an idea about the internal structure of the Active Directory database.  However, ntds.dit is nothing more than a <a href="http://en.wikipedia.org/wiki/Extensible_Storage_Engine">JET Blue</a> database.  Each windows version (starting with Windows 2000) has everything you need to work with this database. <br><br clear="all">  In the article below I will try to highlight the following questions: <br><ul><li>  What is the structure of the database? </li><li>  How does the data in ntds.dit get "tree"? </li><li>  How is group membership implemented? </li><li>  What is the format of the replPropertyMetaData attribute and with what accuracy are the time stamps stored in the replication metadata? </li></ul><br><br><a name="habracut"></a><br><br><h5>  What you need to look into ntds.dit? </h5><br>  At a minimum: <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/gg269259%2528v%3Dexchg.10%2529.aspx">esent.dll</a> <br>  For "comfortable" use from various programming languages ‚Äã‚Äãover ESENT API there are various "wrappers".  I used <a href="http://managedesent.codeplex.com/">Meneged Esent</a> in conjunction with C #.  There are many examples on the project site - so I will try to concentrate on the contents of ntds.dit later. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also note that the JET Blue DB has a parameter like PageSize.  By default, it is equal to 4096 (for those versions of esent.dll that I came across).  So in ntds.dit the page size is 8192 and this parameter should be correctly set before opening the database. <br>  The ESENT API has several versions.  These versions are incompatible!  So ntds.dit from Windows Server 2008 R2 on windows xp will not open, only on Windoes 7. (I did not check backward compatibility) <br><br><h5>  Question one: What is the structure of the database? </h5><br>  The GetTableNames function will return a list of tables in the database: <br>  <i>datatable</i> - the main table with all directory data <br>  <i>hiddentable</i> <br>  <i>link_table</i> - according to an <a href="http://technet.microsoft.com/en-us/library/cc772829%2528v%3Dws.10%2529.aspx">article on the technet</a> table with information about related attributes (for example MemberOf) <br>  <i>quota_rebuild_progress_table</i> <br>  <i>quota_table</i> <br>  <i>sdpropcounttable</i> <br>  <i>sd_table</i> - according to the <a href="http://technet.microsoft.com/en-us/library/cc772829%2528v%3Dws.10%2529.aspx">article on the technet</a> table contains information about the inherited access rules for each directory object. <br><br>  Let us dwell on the datatable table.  The list of its columns has the form (in the screenshot the first few lines): <br><img src="https://habrastorage.org/storage2/25d/455/627/25d45562795a803255ab6128bdeac312.png"><br>  Dead end?  Not! <br>  The names of most columns have the ATT format &lt;one Latin letter&gt; &lt;numeric code&gt;.  So this digital code is the unique identifier of the Active Directory attribute.  The table has one row in which the value of the digital code of the column coincides with its value.  If we derive all the values ‚Äã‚Äãof the Text type from this line, we will see that this is the definition of the attribute ‚ÄúattributeID‚Äù. <br><br><div class="spoiler">  <b class="spoiler_title">Now nothing prevents to get the correspondence of all columns of the table to the attributes of Active Directory (the table is given for an example - it is reduced, otherwise it would not fit in the post)</b> <div class="spoiler_text"><table><tbody><tr><th>  JET_COLUMNID </th><th>  Column Name </th><th>  Jet column type </th><th>  AD atribute Name </th><th></th></tr><tr><td>  JET_COLUMNID (0x6) </td><td>  ab_cnt_col </td><td>  Long </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x100) </td><td>  Ancestors_col </td><td>  Longbinary </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x536) </td><td>  ATTb131079 </td><td>  Long </td><td>  subRefs </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x121) </td><td>  ATTb131088 </td><td>  Long </td><td>  nCName </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2dd) </td><td>  ATTb131108 </td><td>  Long </td><td>  dMDLocation </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x42c) </td><td>  ATTb1376270 </td><td>  Long </td><td>  documentAuthor </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x169) </td><td>  ATTb1376277 </td><td>  Long </td><td>  secretary </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2b8) </td><td>  ATTb1376294 </td><td>  Long </td><td>  associatedName </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x470) </td><td>  ATTb33 </td><td>  Long </td><td>  roleOccupant </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x203) </td><td>  ATTb34 </td><td>  Long </td><td>  seeAlso </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2d2) </td><td>  ATTb49 </td><td>  Long </td><td>  distinguishedName </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x4cc) </td><td>  ATTb50 </td><td>  Long </td><td>  uniqueMember </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x206) </td><td>  ATTb589856 </td><td>  Long </td><td>  domainPolicyObject </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x250) </td><td>  ATTb589864 </td><td>  Long </td><td>  fromServer </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x205) </td><td>  ATTb589881 </td><td>  Long </td><td>  defaultLocalPolicyObject </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x1cc) </td><td>  ATTb589921 </td><td>  Long </td><td>  preferredOU </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x5a6) </td><td>  ATTb590037 </td><td>  Long </td><td>  defaultClassStore </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x270) </td><td>  ATTb590038 </td><td>  Long </td><td>  nextLevelStore </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x183) </td><td>  ATTb590127 </td><td>  Long </td><td>  notificationList </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x238) </td><td>  ATTb590192 </td><td>  Long </td><td>  rIDManagerReference </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x57c) </td><td>  ATTb590193 </td><td>  Long </td><td>  fSMORoleOwner </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x3c8) </td><td>  ATTb590246 </td><td>  Long </td><td>  domainPolicyReference </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x566) </td><td>  ATTb590281 </td><td>  Long </td><td>  localPolicyReference </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x3c1) </td><td>  ATTb590295 </td><td>  Long </td><td>  trustParent </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x4c1) </td><td>  ATTb590296 </td><td>  Long </td><td>  domainCrossRef </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x5bc) </td><td>  ATTb590304 </td><td>  Long </td><td>  defaultGroup </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x57f) </td><td>  ATTb590318 </td><td>  Long </td><td>  siteServer </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x532) </td><td>  ATTb590338 </td><td>  Long </td><td>  physicalLocationObject </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x563) </td><td>  ATTb590341 </td><td>  Long </td><td>  ipsecPolicyReference </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x24f) </td><td>  ATTb590361 </td><td>  Long </td><td>  dynamicLDAPServer </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x1a4) </td><td>  ATTb590381 </td><td>  Long </td><td>  parentCA </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x233) </td><td>  ATTb590448 </td><td>  Long </td><td>  ipsecOwnersReference </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x345) </td><td>  ATTq590722 </td><td>  Currency </td><td>  aCSNonReservedTxSize </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x398) </td><td>  ATTq591137 </td><td>  Currency </td><td>  aCSMaxTokenBucketPerFlow </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x19b) </td><td>  ATTq591138 </td><td>  Currency </td><td>  aCSMaximumSDUSize </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x4d3) </td><td>  ATTq591139 </td><td>  Currency </td><td>  aCSMinimumPolicedSize </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x244) </td><td>  ATTq591140 </td><td>  Currency </td><td>  aCSMinimumLatency </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x12f) </td><td>  ATTq591141 </td><td>  Currency </td><td>  aCSMinimumDelayVariation </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x16e) </td><td>  ATTq591142 </td><td>  Currency </td><td>  aCSNonReservedPeakRate </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x344) </td><td>  ATTq591143 </td><td>  Currency </td><td>  aCSNonReservedTokenSize </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x4d4) </td><td>  ATTq591144 </td><td>  Currency </td><td>  aCSNonReservedMaxSDUSize </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x343) </td><td>  ATTq591145 </td><td>  Currency </td><td>  aCSNonReservedMinPolicedSize </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x5ac) </td><td>  ATTq591191 </td><td>  Currency </td><td>  mS-SQL-Memory </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x213) </td><td>  ATTq591204 </td><td>  Currency </td><td>  mS-SQL-Status </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x4d5) </td><td>  ATTq591220 </td><td>  Currency </td><td>  mS-SQL-Size </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2c5) </td><td>  ATTq591266 </td><td>  Currency </td><td>  msDS-Cached-Membership-Time-Stamp </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x548) </td><td>  ATTq591456 </td><td>  Currency </td><td>  msWMI-Int8Default </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x52a) </td><td>  ATTq591457 </td><td>  Currency </td><td>  msWMI-Int8Max </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x53f) </td><td>  ATTq591458 </td><td>  Currency </td><td>  msWMI-Int8Min </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x214) </td><td>  ATTq591459 </td><td>  Currency </td><td>  msWMI-Int8ValidValues </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2c1) </td><td>  ATTq591520 </td><td>  Currency </td><td>  lastLogonTimestamp </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2cc) </td><td>  ATTq591794 </td><td>  Currency </td><td>  msDS-LastSuccessfulInteractiveLogonTime </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x462) </td><td>  ATTq591795 </td><td>  Currency </td><td>  msDS-LastFailedInteractiveLogonTime </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x440) </td><td>  ATTq591835 </td><td>  Currency </td><td>  msDS-MaximumPasswordAge </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2a5) </td><td>  ATTq591836 </td><td>  Currency </td><td>  msDS-MinimumPasswordAge </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x200) </td><td>  ATTq591841 </td><td>  Currency </td><td>  msDS-LockoutObservationWindow </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x2e7) </td><td>  ATTq591842 </td><td>  Currency </td><td>  msDS-LockoutDuration </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x3d0) </td><td>  ATTq591879 </td><td>  Currency </td><td>  msDS-USNLastSyncSuccess </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x49a) </td><td>  ATTq591922 </td><td>  Currency </td><td>  msDS-ClaimValueType </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x476) </td><td>  ATTq592002 </td><td>  Currency </td><td>  msKds-UseStartTime </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x477) </td><td>  ATTq592003 </td><td>  Currency </td><td>  msKds-CreateTime </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x3a0) </td><td>  ATTq592007 </td><td>  Currency </td><td>  msDS-GeoCoordinatesAltitude </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x3a1) </td><td>  ATTq592008 </td><td>  Currency </td><td>  msDS-GeoCoordinatesLatitude </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x3a2) </td><td>  ATTq592009 </td><td>  Currency </td><td>  msDS-GeoCoordinatesLongitude </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x43b) </td><td>  ATTr589945 </td><td>  Longbinary </td><td>  securityIdentifier </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x1c9) </td><td>  ATTr589970 </td><td>  Longbinary </td><td>  objectSid </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x276) </td><td>  ATTr590433 </td><td>  Longbinary </td><td>  sIDHistory </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x443) </td><td>  ATTr590491 </td><td>  Longbinary </td><td>  syncWithSID </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x5e4) </td><td>  ATTr591234 </td><td>  Longbinary </td><td>  mS-DS-CreatorSID </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x50a) </td><td>  ATTr591668 </td><td>  Longbinary </td><td>  msDS-QuotaTrustee </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x1c2) </td><td>  ATTr591978 </td><td>  Longbinary </td><td>  msAuthz-CentralAccessPolicyID </td><td>  Multi-value </td></tr><tr><td>  JET_COLUMNID (0x5) </td><td>  cnt_col </td><td>  Long </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x1) </td><td>  DNT_col </td><td>  Long </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x5f1) </td><td>  extendedprocesslinks_col </td><td></td><td>  Longbinary </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x9) </td><td>  IsVisibleInAB </td><td>  UnsignedByte </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x8) </td><td>  NCDNT_col </td><td>  Long </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x3) </td><td>  OBJ_col </td><td>  UnsignedByte </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x2) </td><td>  PDNT_col </td><td>  Long </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x4) </td><td>  RDNtyp_col </td><td>  Long </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0xa) </td><td>  recycle_time_col </td><td>  Currency </td><td></td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x7) </td><td>  time_col </td><td>  Currency </td><td></td><td>  Single-value </td></tr></tbody></table><br></div></div><br><br>  There is only one "undeciphered" attribute ATTc0 - this is a link to "objectClass". <br>  Please note - all columns storing attributes of the Active Directory directory are entered as Multi-value regardless of the scheme. <br><br><h5>  Question two: How does the data in ntds.dit get "tree"? </h5><br>  The name of the column "DNT_col" provokes to suggest that it is somehow related to the distinguishedName of the object (as it turned out later - they are equal) <br>  The values ‚Äã‚Äãof the DNT_col column begin with 1, and the line with DNT_col = 1 corresponds to an interesting object with the attribute value name = "$ NOT_AN_OBJECT1 $" <br>  The string with DNT_col = 2 contains the attributes of the object named "$ ROOT_OBJECT $" (Not to be confused with the RootDSE) <br>  With DNT_col = 6, objectClass definitions begin. <br>  Again a dead end?  Again, no! <br>  Let's go the other way. <br>  Searching the ATTm589825 column (name) for values ‚Äã‚Äãof the type Text ‚ÄúAdministrator‚Äù returned an entry with DNT_col = 3841 and PDNT_col = 1951 <br>  Searching the ATTm589825 column (name) for values ‚Äã‚Äãof the Text ‚ÄúUsers‚Äù type (the container in which the standard administrator account is located) returned an entry with DNT_col = 1951 and PDNT_col = 1944 <br>  Here it is a connection!  The PDNT_col column contains the DNT_col identifier of the parent object. <br>  In the line with DNT_col = 1944 (PDNT_col = 1943) - there was a second-level domain object (ntds.dit was taken from the second-level test domain controller) <br>  In the line with DNT_col = 1943 (PDNT_col = 2) - the object of the first level domain. <br><br><a name="NCDNT_col"></a><br>  If you have ever wondered: ‚ÄúWhy do not objects from cn = Configuration, dc = contoso, dc = com appear when connecting to dc = contoso, dc = com?‚Äù Then you should pay attention to the column NCDNT_col - it contains links on the naming context object.  (moreover, the first-level domain object has no naming context - is this why it is not visible?).  For Objects in the naming contexts "dc = contoso, dc = com" and "cn = Configuration, dc = contoso, dc = com", the value of this column is different. <br><br>  No less interesting is how from these numbers a complete distinguishedName of the object is obtained?  Which object attribute is a relative unique name (RDN) and is used to build a full distinguishedName. <br>  The RDNtyp_col column contains the attribute identifier (attributeID) containing the RDN. <br>  The column CNT_col contains the number of objects associated with the current one.  This column is used by the <a href="http://msdn.microsoft.com/en-us/library/ee441978.aspx">Link Cleaner</a> mechanism. <br>  If the bit in the OBJ_col column is set to 1, then this string describes the directory object.  Otherwise, it is a phantom object. <br><br>  How is SubTree search implemented? <br>  It is clear that with such a structure, for searching OneLavel it is enough to search among the records with PDNT_col equal to the search base DN, but how to search by SubTree?  Bypass all branches?  No, it is too difficult. <br>  Look at the values ‚Äã‚Äãin the column with the speaker name Ancestors_col.  It is striking that the deeper the object is located in the hierarchy, the longer the value in this column.  Each nesting level adds 4 bytes to the length.  This is nothing more than a list of parent objects in the order of precedence. <br>  And the list starts with dn = 2, i.e.  with "$ ROOT_OBJECT $" <br>  Who is involved in keeping Ancestors_col up to date?  According to the <a href="http://msdn.microsoft.com/en-us/library/dd350247.aspx">document,</a> when an object is moved to a new place, only its PDNT_col is changed, and the Ancestors_col value is updated by the SDProp mechanism along with the recalculation of the new object access rules. <br><br><h5>  Question three: How is group membership realized? </h5><br>  Why did the server 2003 have the opportunity to include a practically unlimited number of users in a group, and at the same time it is not possible to write more than 1200 values ‚Äã‚Äãto a string or numeric multi-value attribute? <br>  Yes, because ‚Äúmember‚Äù and ‚ÄúmemberOf‚Äù are defined as links.  There are no columns in the datatable table corresponding to these attributes.  The values ‚Äã‚Äãof these attributes are implemented as matches in a separate link_table table. <br>  Perhaps that is why when you delete a group (without using RecucleBin), we lose information about its members - the object of the remote group receives a new identifier in DNT_col when moving to the <a href="http://support.microsoft.com/kb/258310">container of remote objects</a> (and the connection of the group and its member is based on this identifier) <br><div class="spoiler">  <b class="spoiler_title">Let's look at the columns of the link_table table.</b> <div class="spoiler_text"><table><tbody><tr><td>  JET_COLUMNID (0x2) </td><td>  backlink_DNT </td><td>  Long </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x3) </td><td>  link_base </td><td>  Long </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x100) </td><td>  link_data </td><td>  Longbinary </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x4) </td><td>  link_deactivetime </td><td>  Currency </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x5) </td><td>  link_deltime </td><td>  Currency </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x1) </td><td>  link_DNT </td><td>  Long </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x80) </td><td>  link_metadata </td><td>  Binary </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x7) </td><td>  link_ncdnt </td><td>  Long </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x101) </td><td>  link_ndesc </td><td>  Long </td><td>  Single-value </td></tr><tr><td>  JET_COLUMNID (0x6) </td><td>  link_usnchanged </td><td>  Currency </td><td>  Single-value </td></tr></tbody></table><br></div></div><br><br>  The names and type of the columns hint, and the analysis of the data they contain confirms that: <br>  link_DNT ‚Äî Contains the dn identifier (corresponding to DNT_col from datatable) of the object whose link is described (for example, a group object) <br>  backlink_DNT - Contains the dn identifier of the object associated with it (for example, a user object) <br>  link_ncdnt ‚Äî Contains the dn identifier of the naming context in which the members of the link are located. <br>  link_usnchanged - Contains the last modified USN <br>  link_data - I saw this field filled only for NTDS Settings object links.  Yes!  NTDS Settings objects have links to objects of directory partitions. Apparently, these connections define the replication parameters of various directory partitions. <br>  link_deltime ‚Äî Contains the time at which the link was deleted. <br>  link_metadata - contains metadata necessary for replicating the changes made.  I saw the filled values ‚Äã‚Äãof this column only on Windows 2012. <a href="http://blogs.chrisse.se/2012/11/28/how-the-active-directory-data-store-really-works-inside-ntds.dit-part-4/">Christoffer Andersson writes</a> that the column contains the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms676275%2528v%3Dvs.85%2529.aspx">structure DS_REPL_VALUE_META_DATA</a> and here I <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms676275%2528v%3Dvs.85%2529.aspx">totally disagree</a> with it.  The DS_REPL_VALUE_META_DATA structure is used at a higher level ‚Äî it is returned by calls to ntdsa.dll.  The data contained in this column are smaller than what is needed for the DS_REPL_VALUE_META_DATA structure.  While this column remains a mystery to me.  In principle, the replication metadata for attribute-relationships can be obtained from the built-in attribute msDS-ReplValueMetaData, but this does not reveal the internal mechanism for processing and storing this data. <br><br><h5>  Question four: What is the format of the replPropertyMetaData attribute and with what accuracy are the time stamps stored in the replication metadata? </h5><br><br>  This attribute stores binary replication metadata: <br><img src="https://habrastorage.org/storage2/f1a/743/961/f1a743961881ca12043cbdd4bdf9f613.png"><br>  What is stored in the first 8 bytes of this structure, I have not figured it out yet. <br>  Attention is drawn to the fact that in the replPropertyMetaData structure only replicable attributes with values ‚Äã‚Äãare listed.  For example, you will not see the logonTimestamp attribute identifier in replPropertyMetaData. <br>  There is an interesting point: in the replPropertyMetaData structure for Active Directory security objects (users, groups and computers), the objectSid attribute is present. <br>  By the way, in order to decipher the value of this attribute - it is not necessary to strain so much - there is a built-in attribute msDS-ReplAttributeMetaData - it is nothing but an parsed value of the replPropertyMetaData. <br><br>  The time stamps in Active Directory are 64-bit unsigned integers, indicating the number of seconds elapsed since 00:00 on January 1, 1601.  This leads to an interesting nuance: if you edit one attribute of the same object on two domain controllers for 1 second (for example, when batch processing a large number of users), you can get an unexpected result. <br>  According <a href="http://technet.microsoft.com/ru-ru/magazine/2007.10.replication.aspx">to the article on technet</a> , the attribute version wins from the controller with a lower GUID. <br><br><h5>  Information used: </h5><br>  <a href="http://technet.microsoft.com/en-us/library/cc772829%2528v%3Dws.10%2529.aspx">technet.microsoft.com/en-us/library/cc772829%28v=ws.10%29.aspx</a> <br>  <a href="http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1">blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1</a> <br>  <a href="http://blogs.chrisse.se/2012/02/15/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-2">blogs.chrisse.se/2012/02/15/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-2</a> <br>  <a href="http://blogs.chrisse.se/2012/02/20/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-3">blogs.chrisse.se/2012/02/20/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-3</a> <br>  <a href="http://blogs.chrisse.se/2012/02/28/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-4">blogs.chrisse.se/2012/02/28/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-4</a> <br>  <a href="http://gexeg.blogspot.ru/2009/12/active-directory.html">gexeg.blogspot.ru/2009/12/active-directory.html</a> <br>  <a href="http://www.ntdsxtract.com/">www.ntdsxtract.com</a> <br><br>  All experiments were performed on ntds.dit from Windows Server 2012 Eng <br><br>  <b>UPD</b> .  For a snack, a <a href="http://goo.gl/U9PdM">small utility</a> that I wrote to study ntds.dit (maybe someone will do). </div><p>Source: <a href="https://habr.com/ru/post/172865/">https://habr.com/ru/post/172865/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../172851/index.html">We translate from programmer to Russian</a></li>
<li><a href="../172855/index.html">Getting Started with Kannel SMS Gateway</a></li>
<li><a href="../172857/index.html">Why do I buy subscribers using targeted VK ads?</a></li>
<li><a href="../172859/index.html">Attributes in C #</a></li>
<li><a href="../172863/index.html">Microsoft and Dell represent the expedition "In the shadow of the Himalayas"</a></li>
<li><a href="../172867/index.html">Black Hat Europe 2013</a></li>
<li><a href="../172869/index.html">Video flicker when using Qt widget and Directshow</a></li>
<li><a href="../172871/index.html">"Hedgehog" on the road: measuring network quality</a></li>
<li><a href="../172873/index.html">Stop learning English words</a></li>
<li><a href="../172875/index.html">Dynamic Wordpress Template</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>