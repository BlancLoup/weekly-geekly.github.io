<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zimbra: delete random or unnecessary emails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The topic may be beaten and is not very relevant if the automatic deletion of emails is set up after a certain period of time. 

 But if it happens th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zimbra: delete random or unnecessary emails</h1><div class="post__text post__text-html js-mediator-article">  The topic may be beaten and is not very relevant if the automatic deletion of emails is set up after a certain period of time. <br><br>  But if it happens that one employee instead of sending a very private piquant message to another, sends it (message) to the entire holding ... To wait for the day when the automatic cleaning starts is not an option, but everyone should delete it now. <br><br>  Under the cut description of how this is implemented in me. <br><a name="habracut"></a><br>  Having rummaged in a network, I came across a <a href="http://www.ossportal.ru/technologies/zimbra/blogs/375">site</a> where the small script for removal of old mail is described, it is not bad, but did not approach for removal of letters in subfolders. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Solved problems in approximation to the main task. <br><br>  First you need to find all the folders that could get a letter with the details of the evening, for this we will help zmmailbox (powerful and comprehensive assistant).  Enter: <br><br><pre><code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m user@corp.org gaf <span class="hljs-comment"><span class="hljs-comment"># gaf - getAllFolders</span></span></code> </pre> <br>  In response, we get: <br><br><pre> <code class="bash hljs"> Id View Unread Msg Count Path ---------- ---- ---------- ---------- ---------- 1 unkn 0 0 / 16 docu 0 15 /Briefcase 10 appo 0 52 /Calendar 14 mess 0 1564 /Chats 7 cont 0 7 /Contacts 6 mess 0 56 /Drafts 13 cont 0 179 /Emailed Contacts 2 mess 0 5352 /Inbox 65450 mess 0 12433 /Inbox/ 1.04.2015 31907 mess 0 3125 /Inbox/ 5993 mess 0 881 /Inbox/ 4 mess 0 0 /Junk 5 mess 0 7527 /Sent 15 task 0 8 /Tasks 3 unkn 0 0 /Trash 1770 mess 7 7 /Trash/.  (support@corp.org:703) 3741 docu 0 1 / 87195 docu 0 1 / 1015 docu 0 12 / 663 cont 0 1 /   290 task 0 2 / 1100 mess 4404 22301 /.  -  (support@corp.org:2)</code> </pre><br>  As we see, we are full of everything.  The View column pre-opens our eyes and we see that there are folder types.  We need folders with messages - this is mess.  Knowing what we need, we can filter the query: <br><br><pre> <code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m user@corp.org gaf | grep mess</code> </pre><br>  Query output: <br><br><pre> <code class="bash hljs"> Id View Unread Msg Count Path ---------- ---- ---------- ---------- ---------- 14 mess 0 1564 /Chats 6 mess 0 56 /Drafts 2 mess 0 5352 /Inbox 65450 mess 0 12433 /Inbox/ 1.04.2015 31907 mess 0 3125 /Inbox/ 5993 mess 0 881 /Inbox/ 4 mess 0 0 /Junk 5 mess 0 7527 /Sent 1770 mess 7 7 /Trash/.  (support@corp.org:703) 1100 mess 4404 22301 /.  -  (support@corp.org:2)</code> </pre><br>  As you can see, we have already more than the desired list, but <b>1100 mess 4404 22301 / Tech.</b>  <b>Support - Inbox (support@corp.org: 2)</b> is a shared folder from another mailbox, and, therefore, it will be checked separately.  Add one more exception and immediately remove all unnecessary: ‚Äã‚Äãtypes, sequence numbers, remove all before the slash (folder names). <br><br><pre> <code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m user@corp.org gaf | grep mess | cut -d<span class="hljs-string"><span class="hljs-string">"/"</span></span> -f 2- | grep -v <span class="hljs-string"><span class="hljs-string">"@corp.org"</span></span></code> </pre><br>  We get the desired list: <br><br><blockquote>  Chats <br>  Drafts <br>  Inbox <br>  Inbox / until 1.04.2015 <br>  Inbox / Marketing <br>  Inbox / Eureka <br>  Junk <br>  Sent <br></blockquote><br>  The output of the command is redirected to a file, for small and rare convenience, and the script will take the names of the folders from the file already.  So, the most difficult thing is not so much to look in folders, as to look in folders whose names contain spaces or special characters. <br><br>  If you enter in the console: <br><br><pre> <code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m user@corp.org s -l 300 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Inbox/ | grep `date -d <span class="hljs-string"><span class="hljs-string">'-5 day'</span></span> +%m/%d/%y` | grep <span class="hljs-string"><span class="hljs-string">""</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">"s/^\s\s*//"</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">"s/\s\s*/ /g"</span></span></code> </pre><br>  Displays the subject of letters 5 days old.  Instead of <b>date -d '-5 day' +% m /% d /% y,</b> you can immediately write the dates in the 01/27/16 <b>format</b> or <b>change</b> <b>-5</b> to a different value, depending on how many days ago you need to roll back. <br><br>  But if you enter: <br><br><pre> <code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m user@corp.org s -l 300 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:Inbox/  | grep `date -d <span class="hljs-string"><span class="hljs-string">'-5 day'</span></span> +%m/%d/%y` | grep <span class="hljs-string"><span class="hljs-string">""</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">"s/^\s\s*//"</span></span> | sed -e <span class="hljs-string"><span class="hljs-string">"s/\s\s*/ /g"</span></span></code> </pre><br>  That the error will fall out: <br><br><pre> <code class="bash hljs">ERROR: mail.NO_SUCH_FOLDER (no such folder path: /Inbox/\)</code> </pre><br>  And even if you add quotes, apostrophes and screens - it will not help. <br><br>  <a href="http://ru.stackoverflow.com/questions/487858/zmmailbox-%25D0%25BF%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA-%25D0%25BA%25D0%25B0%25D1%2582%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B3%25D0%25BE%25D0%25B2-%25D1%2581%25D0%25BE%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B6%25D0%25B0%25D1%2589%25D0%25B8%25D1%2585-%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B1%25D0%25B5%25D0%25BB%25D1%258B-%25D0%25B2-%25D0%25B8%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B8">Then</a> I pointed to the <a href="https://wiki.zimbra.com/wiki/Ajcody-User-Management-Topics">wiki</a> , which found the answer to the question. <br>  To solve the problem, you need to put the folder name with spaces in certain blocks.  <b>"\"</b> Is a block tag. <br><br><pre> <code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m user@corp.org s -l 300 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:<span class="hljs-string"><span class="hljs-string">"\"Inbox/ "</span></span>\<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre><br>  By doing this in the console, I got the desired result, but my task was to script everything.  And in my script, the variable containing the folder name took the data from the file. <br><br><pre> <code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m user@corp.org gaf | grep mess | cut -d<span class="hljs-string"><span class="hljs-string">"/"</span></span> -f 2- | grep -v <span class="hljs-string"><span class="hljs-string">"@corp.org"</span></span> &gt; /tmp/messfolder.list</code> </pre><br>  And when inserting a variable into my code: <br><br><pre> <code class="bash hljs">/opt/zimbra/bin/zmmailbox -z -m <span class="hljs-variable"><span class="hljs-variable">$is</span></span> -l 300 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>:<span class="hljs-string"><span class="hljs-string">"\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$p</span></span></span><span class="hljs-string">"</span></span>\<span class="hljs-string"><span class="hljs-string">" | grep `date -d '-5 day' +%m/%d/%y` | grep "</span></span><span class="hljs-string"><span class="hljs-string">" | sed -e "</span></span>s/^\s\s*//<span class="hljs-string"><span class="hljs-string">" | sed -e "</span></span>s/\s\s*/ /g<span class="hljs-string"><span class="hljs-string">" |</span></span></code> </pre><br>  I fell out the exact same error: <br><br><pre> <code class="bash hljs">ERROR: mail.NO_SUCH_FOLDER (no such folder path: /Inbox/\)</code> </pre><br>  Although the variable is placed in the desired block tags.  Looking for some more, I <s>remembered</s> stumbled upon the IFS field separator variable.  I asked him the value of IFS = $ '\ n' and ran the script - everything went as planned. <br><br><div class="spoiler">  <b class="spoiler_title">Here is the whole script with descriptions</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash DOMAIN_NAME="corp.org" #   EMAIL=/tmp/email.list #     MESID=/tmp/mesid.list #  ID    DELTEXT='' #         IFS=$'\n' #      before="$(date +%s)" #    t=0 # ,     /opt/zimbra/bin/zmprov -l gaa $DOMAIN_NAME | sort &gt; $EMAIL #    #      for i in $(cat $EMAIL); do echo $i #      ,    ,          ,    -  ,    ,  mess /opt/zimbra/bin/zmmailbox -z -m $i gaf | grep mess | cut -d"/" -f 2- | grep -v "@corp.org" &gt; /tmp/messfolder.list #         ,       id   .      . for p in $(cat /tmp/messfolder.list); do echo $p #   :   grep     , grep   ,  grep  ,  sed'     cut     ,   . /opt/zimbra/bin/zmmailbox -z -m $is -l 300 in:"\"$p"\" | grep `date -d '-5 day' +%m/%d/%y` | grep "$DELTEXT" | sed -e "s/^\s\s*//" | sed -e "s/\s\s*/ /g" | cut -d" " -f2 &gt; $MESID #      - . cat $MESID count=`grep '' $MESID -c` let t=$t+$count for a in $(cat $MESID | grep ^- | sed s/-//g ) do /opt/zimbra/bin/zmmailbox -z -m $i deleteMessage $a done for a in $(cat $MESID | sed /-/d) do /opt/zimbra/bin/zmmailbox -z -m $i deleteConversation $a done echo -n &gt; $MESID RES=$? if [ "$RES" == "0" ]; then echo "[Ok]"; else echo "[Err]"; fi done echo " : "$t done after="$(date +%s)" elapsed="$(expr $after - $before)" hours=$(($elapsed / 3600)) elapsed=$(($elapsed - $hours * 3600)) minutes=$(($elapsed / 60)) seconds=$(($elapsed - $minutes * 60)) echo " : $hours  $minutes  $seconds " echo " : "$t" "</span></span></code> </pre><br></div></div><br>  Of course, the script can still be refined: remove unnecessary folders, enter the date and subject in advance, but this is not so important.  This script is hung on a homemade web-admin and all the dates and topics for removal I enter from it, everything is more convenient. <br><br>  Someone thinks that this is unnecessary, and such a script is superfluous, but as practice has shown, he saved at least 10 people and a couple of bosses.  They feel good, and the admin after they feel good, also became good. <br><br>  This script has one drawback - this is the time.  This script runs through all the folders of 700 users in 4 hours.  So far, I have not identified where it is possible to gain time, but if you tell me or point out mistakes, I will be grateful. <br><br>  Thanks for reading and comments. </div><p>Source: <a href="https://habr.com/ru/post/277117/">https://habr.com/ru/post/277117/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277107/index.html">Sandy Metz and Object-Oriented Design in Ruby</a></li>
<li><a href="../277109/index.html">Vision-based SLAM: tutorial</a></li>
<li><a href="../277111/index.html">Problems of access control based on the access list in ECM systems</a></li>
<li><a href="../277113/index.html">Why I no longer use MVC frameworks</a></li>
<li><a href="../277115/index.html">Cloud to organization scale - how Varonis can help build secure data sharing</a></li>
<li><a href="../277119/index.html">Unicorn in space: check the source code of 'Space Engineers'</a></li>
<li><a href="../277121/index.html">Resource Binding in Microsoft DirectX 12. Performance Issues</a></li>
<li><a href="../277123/index.html">Open letter @ignored test</a></li>
<li><a href="../277125/index.html">Results of 2015: IT industry</a></li>
<li><a href="../277127/index.html">Record of the webinar "Centralized Management with MyKerio"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>