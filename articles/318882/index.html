<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Launch Telegram bot on Android device (Remote Bot for Telegram)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Four months ago, I had an idea to write a Telegram bot, which will be launched not on an external server, like most bots, but on a mobile phone. 

 Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Launch Telegram bot on Android device (Remote Bot for Telegram)</h1><div class="post__text post__text-html js-mediator-article">  Four months ago, I had an idea to write a Telegram bot, which will be launched not on an external server, like most bots, but on a mobile phone. <br><br>  The idea was not born from scratch: I often missed incoming calls and SMS when the phone was in a jacket or pocket, so I needed an additional method of notification.  And since I actively use Telegram on a computer, I thought that it would not be bad if incoming SMS and missed calls came to Telegram.  Having rummaged a little, I decided to write a bot. <br><a name="habracut"></a><br><h2>  Prototype development </h2><br>  I began to study the subject of creating Telegram bots using <a href="https://core.telegram.org/bots/api">official documentation</a> and examples.  Basically, all the examples were written in Python.  Therefore, without hesitation, I began to look for ways to launch the Python server on Android.  But after evaluating the time to learn Python and not finding anything suitable for running the server, I started searching for alternatives and came across several Java libraries to write Telegram bots.  As a result, I stopped at a project from Pengrad: <a href="https://github.com/pengrad/java-telegram-bot-api">java-telegram-bot-api</a> . <br><br>  This library allowed, at that time, to initialize the bot and receive-send messages, which was what I needed.  Having added the library to my project, I implemented a simple service that started a cycle in the background thread for receiving messages from Telegram and processing them.  Previously, it was necessary to register a new bot through the parent bot @Botfather and get its token.  Learn more about creating a bot <a href="https://core.telegram.org/bots">using the link</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order for the service not to be killed by the system, when the device is off the screen, when starting the service, WakeLock was installed. <br><br>  I will cite as an example a function that allows you to receive the latest messages and send them for processing: <br><br><div class="spoiler">  <b class="spoiler_title">private void getUpdates (final TelegramBot bot)</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUpdates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TelegramBot bot)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { GetUpdatesResponse response = bot.execute( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetUpdates() .limit(LIMIT) .offset(updateId.get()) .timeout(LONG_POLLING_TIMEOUT)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; response.updates() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; response.updates().size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Update update : response.updates()) { obtainUpdate(bot, update); updateId.set(update.updateId() + <span class="hljs-number"><span class="hljs-number">1</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { ErrorUtils.log(TAG, e); } }</code> </pre> <br></div></div><br>  Later, for security reasons, I added the ability to link a bot to authorized Telegram accounts and the ability to prohibit the execution of certain commands for specified users. <br><br>  Having added several commands for the bot, such as sending, reading SMS, viewing missed calls, battery information, determining location, etc., I published the application on Google Play, created threads on several forums, waited for comments and feedback. <br><br>  The reviews were mostly good, but the problem of high battery consumption was revealed, which, as you might have guessed, was connected with WakeLock and constant service activity. After a bit of hard work, I decided to periodically start the service via the AlarmManager, then after receiving the messages and responding to them, stop the service. <br><br>  This helped a little, but another problem appeared, AlarmManager did not work correctly on some Chinese devices.  And so the bot sometimes did not wake up after several hours spent in a state of sleep.  Studying the official documentation, I read that Long Polling is not the only way to receive messages, messages could still be received using Webhook. <br><br><h2>  Receive messages via Webhook </h2><br>  I signed up for <a href="https://www.digitalocean.com/">Digital Ocean</a> , created VPS on Ubuntu, then implemented the simplest http server in Java using <a href="http://sparkjava.com/">Spark Framework</a> .  Two types of requests can be made to the server: push (sending push notifications via webhook) and ping. <br><br>  Push notifications were sent using Google Firebase. <br><br><div class="spoiler">  <b class="spoiler_title">An example of a class that helps send push notifications.</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PushHelper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String URL = <span class="hljs-string"><span class="hljs-string">"https://fcm.googleapis.com/fcm/send"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> java.util.logging.Logger log = java.util.logging.Logger.getLogger(PushHelper.class.getName()); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MediaType JSON = MediaType.parse(<span class="hljs-string"><span class="hljs-string">"application/json; charset=utf-8"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String AUTHORIZATION = <span class="hljs-string"><span class="hljs-string">"..."</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PushRequest pushRequest)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ ObjectMapper objectMapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectMapper(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> post(URL, objectMapper.writeValueAsString(pushRequest)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String url, String json)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ RequestBody body = RequestBody.create(JSON, json); Request request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Request.Builder() .url(url) .header(<span class="hljs-string"><span class="hljs-string">"Authorization"</span></span>, AUTHORIZATION) .post(body) .build(); OkHttpClient client = getSslClient(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Response response = client.newCall(request).execute(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.body().string(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IOException(<span class="hljs-string"><span class="hljs-string">"Unable to init okhttp client"</span></span>); } } ... }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Request model for sending push notifications</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PushRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PushData data; <span class="hljs-comment"><span class="hljs-comment">//,    private String to; //-  private String priority = "high"; //  ... }</span></span></code> </pre> <br>  In order for the message to arrive even when the device is in the sleep state, you need to specify priority = "high" <br></div></div><br><h3>  SSL certificate generation </h3><br>  Having tested sending push notifications, I began to figure out how to set up and run the server with HTTPS, since this is one of the requirements when receiving messages from Telegram via the webhook. <br><br>  A free certificate can be generated using the <a href="https://letsencrypt.org/">letsencrypt.org</a> service, but one of the limitations is that the indicated host cannot be an ip address when generating a certificate.  I did not want to register a domain name yet, especially the official documentation of the Telegram Bot API <a href="https://core.telegram.org/bots/self-signed">allows the</a> use of self-signed certificates, so I began to figure out how to create my certificate. <br><br>  After several hours spent in the attempts and searches, it turned out a script that allows you to generate the desired certificate. <br><br><div class="spoiler">  <b class="spoiler_title">create_cert.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">openssl req -newkey rsa:2048 -sha256 -nodes -keyout private.key -x509 -days 365 -out public_cert.pem -subj <span class="hljs-string"><span class="hljs-string">"/C=RU/ST=State/L=Location/O=Organization/CN=ServerHost"</span></span> openssl pkcs12 -<span class="hljs-built_in"><span class="hljs-built_in">export</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> public_cert.pem -inkey private.key -certfile public_cert.pem -out keystore.p12 keytool -importkeystore -srckeystore keystore.p12 -srcstoretype pkcs12 -sigalg SHA1withRSA -destkeystore keystore.jks -deststoretype JKS rm keystore.p12 rm private.key</code> </pre> <br></div></div><br>  After running the script, we get two files at the output: keystore.jks - used on the server, public_cert.pem - used when installing the webhook in the Android application. <br><br>  In order to run HTTPS on Spark Framework, it‚Äôs enough to add 2 lines, one indicating the port (allowed ports for the webhook: 443, 80, 88, 8443), another indicating the generated certificate and the password to it: <br><br><pre> <code class="java hljs">port(<span class="hljs-number"><span class="hljs-number">8443</span></span>); secure(<span class="hljs-string"><span class="hljs-string">"keystore.jks"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>);</code> </pre> <br>  To install a webhook for a bot, you need to add the following lines to your android application: <br><br><pre> <code class="java hljs">SetWebhook setWebHook = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SetWebhook().url(WEBHOOK_URL + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + pushToken + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + secret).certificate(getCert(context)); BaseResponse res = bot.execute(setWebHook);</code> </pre> <br>  When registering a webhook, the URL is the webhook address, then the push token that is required to send push notifications and the secret key generated on the device, which I added for additional checking of incoming notifications, is transmitted. <br><br>  Function of reading public certificate from RAW resource: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCert(Context context) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> IOException { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IOUtils.toByteArray(context.getResources().openRawResource(R.raw.public_cert)); }</code> </pre> <br>  After modifying the message processing service in the Android application, the bot began to use the battery much less, but it also added the dependence of the application on the push notification server, which was a necessity for the stable operation of the application. <br><br><h2>  Automatic bot creation </h2><br>  After updating the mechanism for receiving messages, another problem remained that did not allow a certain percentage of users to use the application due to the difficulty of creating a bot through BotFather.  So I decided to automate this process. <br><br>  The <a href="https://core.telegram.org/tdlib">tdlib</a> library from the creators of Telegram helped me with this.  Unfortunately, I found very few examples of the use of this library, but having understood the API, it turned out that everything is not so difficult.  As a result, we managed to implement authorization in Telegram by phone number, adding @Botfather to the contact list and sending and receiving messages to a given contact, and in a particular case, to bot @Botfather. <br><br><div class="spoiler">  <b class="spoiler_title">Example of functions for sending and receiving messages</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Observable&lt;TdApi.Message&gt; sendMessage(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> chatId, String text) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.create(subscriber -&gt; { telegramClient.sendMessage(chatId, text, object -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (object <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> TdApi.Error) { subscriber.onError(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Throwable(((TdApi.Error) object).message)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { TdApi.Message message = (TdApi.Message) object; subscriber.onNext(message); } }); }).delay(<span class="hljs-number"><span class="hljs-number">5</span></span>, TimeUnit.SECONDS).flatMap(msg -&gt; getLastIncomingMessage(((TdApi.Message) msg).chatId, ((TdApi.Message) msg).senderUserId, ((TdApi.Message) msg).id)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Observable&lt;TdApi.Message&gt; getLastIncomingMessage(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> chatId, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> userId, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> outgoingMessageId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.create(subscriber -&gt; { telegramClient.getLastIncomingMessage(chatId, outgoingMessageId, userId, object -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (object <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> TdApi.Error) { subscriber.onError(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Throwable(((TdApi.Error) object).message)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { TdApi.Message message = (TdApi.Message) object; subscriber.onNext(message); } }); }); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">TelegramClient.java - class wrapper over TdApi</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TelegramClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Client client; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TelegramClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Client.ResultHandler updatesHandler)</span></span></span><span class="hljs-function"> </span></span>{ TG.setDir(context.getCacheDir().getAbsolutePath()); TG.setFilesDir(context.getFilesDir().getAbsolutePath()); client = TG.getClientInstance(); TG.setUpdatesHandler(updatesHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearAuth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.ResetAuth request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.ResetAuth(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); client.send(request, resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAuthState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.GetAuthState req = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.GetAuthState(); client.send(req, resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendPhone</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String phone, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.SetAuthPhoneNumber smsSender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.SetAuthPhoneNumber(phone, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); client.send(smsSender, resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String code, String firstName, String lastName, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.CheckAuthCode request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.CheckAuthCode(code, firstName, lastName); client.send(request, resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> chatId, String text, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.InputMessageContent msg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.InputMessageText(text, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); TdApi.SendMessage request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.SendMessage(chatId, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, msg); client.send(request, resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastIncomingMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> chatId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fromMessageId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userId, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ getChat(chatId, chatObj -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (chatObj <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> TdApi.Chat) { TdApi.GetChatHistory getChatHistory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.GetChatHistory(chatId, fromMessageId, -<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); client.send(getChatHistory, messagesObj -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (messagesObj <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> TdApi.Messages) { TdApi.Messages messages = (TdApi.Messages) messagesObj; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (messages.totalCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (TdApi.Message message : messages.messages) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.id != fromMessageId &amp;&amp; message.senderUserId != userId) { resultHandler.onResult(message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } } resultHandler.onResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.Error(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Unable to get incoming message"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> resultHandler.onResult(messagesObj); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> resultHandler.onResult(chatObj); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getChat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> chatId, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.GetChat getChat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.GetChat(chatId); client.send(getChat, resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchContact</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String username, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.SearchPublicChat searchContacts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.SearchPublicChat(username); client.send(searchContacts, resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ client.send(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.GetMe(), resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeUsername</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String username, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ client.send(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.ChangeUsername(username), resultHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startChatWithBot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> botUserId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> chatId, Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ TdApi.CloseChat closeChat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.CloseChat(chatId); client.send(closeChat, resClose -&gt; { TdApi.OpenChat openChat = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.OpenChat(chatId); client.send(openChat, resOpen -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resOpen <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> TdApi.Error) { resultHandler.onResult(resOpen); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } TdApi.SendBotStartMessage request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.SendBotStartMessage(botUserId, chatId, <span class="hljs-string"><span class="hljs-string">"/start"</span></span>); client.send(request, resultHandler); }); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logout</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Client.ResultHandler resultHandler)</span></span></span><span class="hljs-function"> </span></span>{ client.send(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TdApi.ResetAuth(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>), resultHandler); } }</code> </pre><br></div></div><br><h2>  Adding new features </h2><br>  After solving the primary problems with autonomy, I started adding new commands. <br>  As a result, such commands were added as: photo, video recording, voice recorder, screenshot of the screen, player control, launch of selected applications, etc.  For a convenient command launch, I added a Telegram-keyboard and divided the commands into categories. <br><br>  At the request of users, I also added the ability to call Tasker commands and send messages from Tasker to Telegram. <br><br>  After that, I thought that it would be nice to add external access from third-party applications to send messages to Telegram.  Messages can be both text and include audio, video, location by coordinates.  In the end, I wrote a library that you can add to your project. <br><br>  ‚Üí <a href="https://github.com/AlexanderShtanko/Remote-Bot-for-Telegram-External-Api">Library</a> <br>  ‚Üí <a href="https://github.com/AlexanderShtanko/Remote-Bot-for-Telegram-External-Api-Example">Example of use</a> <br><br><h2>  Conclusion </h2><br>  In this article, I tried to share a brief history of work on a project to create a bot working on an Android device and the difficulties I encountered.  Now I am working on a project in my spare time, adding new commands and correcting errors that occur. <br><br>  Thank you very much for your attention.  I will be glad to hear from you useful comments and suggestions. <br><br>  <i>References:</i> <br>  ‚Üí <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.alexandershtanko.androidtelegrambot">Application in Google Play</a> <br>  ‚Üí <a href="https://telegram.me/rembofort">Channel in Telegram</a> <br>  ‚Üí <a href="https://remote-bot.com/">Project site</a> </div><p>Source: <a href="https://habr.com/ru/post/318882/">https://habr.com/ru/post/318882/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318872/index.html">How to write the best post on Habr√©. 7 answers, 7 tips</a></li>
<li><a href="../318874/index.html">Difficulties on the way of creating a ‚Äúuniversal‚Äù metamodel for modeling subject domains</a></li>
<li><a href="../318876/index.html">VCL, get rid of flicker, once and for all</a></li>
<li><a href="../318878/index.html">History of participation (and almost victory) in the annual competition Russian AI Cup 2016</a></li>
<li><a href="../318880/index.html">Drawing vector graphics - triangulation, rasterization, anti-aliasing and new scenarios</a></li>
<li><a href="../318886/index.html">Comparison of signal recognition methods. Neural networks against matched filter</a></li>
<li><a href="../318890/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ243 (December 26 - January 1, 2017)</a></li>
<li><a href="../318892/index.html">Pebble for lazy programmers</a></li>
<li><a href="../318894/index.html">How fake programmers design</a></li>
<li><a href="../318896/index.html">Truly live code reload in golang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>