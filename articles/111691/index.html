<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Makefile example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing a makefile sometimes becomes a headache. However, if you look at it, everything falls into place, and writing a powerful 40-line makefile for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Makefile example</h1><div class="post__text post__text-html js-mediator-article">  Writing a makefile sometimes becomes a headache.  However, if you look at it, everything falls into place, and writing a powerful 40-line makefile for an arbitrarily large project turns out quickly and elegantly. <br><br>  Attention!  The basic knowledge of the GNU make utility is assumed. <br><a name="habracut"></a><br><br>  We have a typical abstract project with the following directory structure: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage/8858bd6e/4d85ef45/a158aab0/c138b5b5.png"><br><br>  Suppose that for the inclusion of header files in the source code, something like #include &lt;dir1 / file1.h&gt; is used, that is, the project / include directory is made standard when compiled. <br><br>  After assembly, it is necessary to get it like this: <br><br><img src="https://habrastorage.org/storage/00b9382c/ff83740d/bbd8ee5a/6e622515.png"><br><br>  That is, in the bin directory there are working (application) and debugging (application_debug) versions, in the Release and Debug subdirectories of the project / obj directory the project / src directory structure is repeated with the corresponding source files of the object files, from which the contents of the bin directory are compiled. <br><br>  To achieve this effect, create a Makefile in the project directory as follows: <br><blockquote><ol><li>  root_include_dir: = include </li><li>  root_source_dir: = src </li><li>  source_subdirs: =.  dir1 dir2 </li><li>  compile_flags: = <font color="#660033">-Wall</font> <font color="#660033">-MD</font> <font color="#660033">-pipe</font> </li><li>  link_flags: = <font color="#660033">-s</font> <font color="#660033">-pipe</font> </li><li>  libraries: = <font color="#660033">-ldl</font> </li><li></li><li>  relative_include_dirs: = $ <font color="#7a0874">(</font> addprefix .. <font color="#000000">/</font> .. <font color="#000000">/</font> , $ <font color="#7a0874">(</font> root_include_dir <font color="#7a0874">)</font> <font color="#7a0874">)</font> </li><li>  relative_source_dirs: = $ <font color="#7a0874">(</font> addprefix .. <font color="#000000">/</font> .. <font color="#000000">/</font> $ <font color="#7a0874">(</font> root_source_dir <font color="#7a0874">)</font> <font color="#000000">/</font> , $ <font color="#7a0874">(</font> source_subdirs <font color="#7a0874">)</font> <font color="#7a0874">)</font> </li><li>  objects_dirs: = $ <font color="#7a0874">(</font> addprefix $ <font color="#7a0874">(</font> root_source_dir <font color="#7a0874">)</font> <font color="#000000">/</font> , $ <font color="#7a0874">(</font> source_subdirs <font color="#7a0874">)</font> <font color="#7a0874">)</font> </li><li>  objects: = $ <font color="#7a0874">(</font> patsubst .. <font color="#000000">/</font> .. <font color="#000000">/%</font> , <font color="#000000">%</font> , $ <font color="#7a0874">(</font> wildcard $ <font color="#7a0874">(</font> addsuffix <font color="#000000">/ *</font> .c <font color="#000000">*</font> , $ <font color="#7a0874">(</font> relative_source_dirs <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> </li><li>  objects: = $ <font color="#7a0874">(</font> objects: .cpp = .o <font color="#7a0874">)</font> </li><li>  objects: = $ <font color="#7a0874">(</font> objects: .c = .o <font color="#7a0874">)</font> </li><li></li><li>  all: $ <font color="#7a0874">(</font> program_name <font color="#7a0874">)</font> </li><li></li><li>  $ <font color="#7a0874">(</font> program_name <font color="#7a0874">)</font> : obj_dirs $ <font color="#7a0874">(</font> objects <font color="#7a0874">)</font> </li><li>  <font color="#c20cb9">g ++</font> <font color="#660033">-o</font> $ <font color="#000000">@</font> $ <font color="#7a0874">(</font> objects <font color="#7a0874">)</font> $ <font color="#7a0874">(</font> link_flags <font color="#7a0874">)</font> $ <font color="#7a0874">(</font> libraries <font color="#7a0874">)</font> </li><li></li><li>  obj_dirs: </li><li>  <font color="#c20cb9">mkdir</font> <font color="#660033">-p</font> $ <font color="#7a0874">(</font> objects_dirs <font color="#7a0874">)</font> </li><li></li><li>  VPATH: = .. <font color="#000000">/</font> .. <font color="#000000">/</font> </li><li></li><li>  <font color="#000000">%</font> .o: <font color="#000000">%</font> .cpp </li><li>  <font color="#c20cb9">g ++</font> <font color="#660033">-o</font> $ <font color="#000000">@</font> <font color="#660033">-c</font> $ <font color="#000000">&lt;</font> $ <font color="#7a0874">(</font> compile_flags <font color="#7a0874">)</font> $ <font color="#7a0874">(</font> build_flags <font color="#7a0874">)</font> $ <font color="#7a0874">(</font> addprefix -I, $ <font color="#7a0874">(</font> relative_include_dirs <font color="#7a0874">)</font> <font color="#7a0874">)</font> </li><li></li><li>  <font color="#000000">%</font> .o: <font color="#000000">%</font> .c </li><li>  <font color="#c20cb9">g ++</font> <font color="#660033">-o</font> $ <font color="#000000">@</font> <font color="#660033">-c</font> $ <font color="#000000">&lt;</font> $ <font color="#7a0874">(</font> compile_flags <font color="#7a0874">)</font> $ <font color="#7a0874">(</font> build_flags <font color="#7a0874">)</font> $ <font color="#7a0874">(</font> addprefix -I, $ <font color="#7a0874">(</font> relative_include_dirs <font color="#7a0874">)</font> <font color="#7a0874">)</font> </li><li></li><li>  .PHONY: clean </li><li></li><li>  clean: </li><li>  <font color="#c20cb9">rm</font> <font color="#660033">-rf</font> bin obj </li><li></li><li>  include $ <font color="#7a0874">(</font> wildcard $ <font color="#7a0874">(</font> addsuffix <font color="#000000">/ *</font> .d, $ <font color="#7a0874">(</font> objects_dirs <font color="#7a0874">)</font> <font color="#7a0874">)</font> <font color="#7a0874">)</font> </li></ol></blockquote><br>  In its pure form, such a makefile is only useful for achieving the clean target, which will remove the bin and obj directories. <br>  Add another script named Release to build the working version: <br><br><pre><code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p bin <span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p obj <span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p obj/Release make --directory=./obj/Release --makefile=../../Makefile build_flags=<span class="hljs-string"><span class="hljs-string">"-O2 -fomit-frame-pointer"</span></span> program_name=../../bin/application</code> </pre> <br><br>  And another Debug script to build debug version: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p bin <span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p obj <span class="hljs-keyword"><span class="hljs-keyword">mkdir</span></span> -p obj/Debug make --directory=./obj/Debug --makefile=../../Makefile build_flags=<span class="hljs-string"><span class="hljs-string">"-O0 -g3 -D_DEBUG"</span></span> program_name=../../bin/application_debug</code> </pre><br><br>  It is the challenge of one of them that will bring together our project in either working or debugging form.  And now, about everything in order. <br><br>  Suppose you need to build a debug version.  Go to the project directory and call ./Debug.  The first three lines create directories.  The fourth line to the make utility says that the current directory should be started at project / project / obj / Debug, the path to the makefile is then passed along and two constants are set: build_flags (the compilation flags important for the debug version are listed here) this is application_debug). <br><br>  Next, GNU make comes into play.  Comment on each line of makefile: <br><br>  1: A variable is declared with the name of the root directory of the header files. <br><br>  2: A variable is declared with the name of the source directory root. <br><br>  3: A variable is declared with the names of the subdirectories of the root source directory. <br><br>  4: A variable is declared with common compilation flags.  -MD forces the compiler to generate the same-named dependency file with the .d extension for each source.  Each such file looks as a rule, where the target is the source name, and dependencies are all source codes and header files that it includes with the #include directive.  The -pipe flag causes the compiler to use IPC instead of the file system, which somewhat speeds up compilation. <br><br>  5: A variable is declared with general layout flags.  -s causes the linker to remove .symtab, .strtab sections from the resulting ELF file and a bunch of sections with names like .debug *, which significantly reduces its size.  In order to better debug this key can be removed. <br><br>  6: A variable is declared with the names of the libraries used in the form of layout keys. <br><br>  8: A variable is declared containing relative names of directories with standard header files.  Then such names are directly passed to the compiler, preceded by the -I switch.  For our case, it will turn out ../../include, because we have one such directory.  The addprefix function adds its first argument to all the targets that the second argument sets. <br><br>  9: A variable is declared containing the relative names of all the subdirectories of the root directory of sources.  As a result, we get: ../../src/.  ../../src/dir1 ../../src/dir1. <br><br>  10: A variable is declared containing the names of the subdirectories of the project / obj / Debug / src directory relative to the current project / obj / Debug.  That is, by this we enumerate a copy of the structure of the project / src directory.  As a result, we get: / src / dir1 src / dir2. <br><br>  11: A variable is declared containing the names of the sources found on the basis of the same-name * .c * files (.cpp \ .c), irrespective of the current directory.  We look at the stages: the result of addsuff will be ../../src/./*.c* ../../src/dir1/*.c* ../../src/dir2/*.c*.  The wildcard function will expand the templates with asterisks to real file names: ../../src/./main.cpp ../../src/dir1/file1.c ../../src/dir1/file2.cpp ../../src/dir2/file3.c ../../src/dir2/file4.c.  The patsubsb function removes the prefix ../../ from file names (it replaces the pattern given by the first argument with the pattern in the second argument, and% denotes any number of characters).  As a result, we get: src /./ main.cpp src / dir1 / file1.c src / dir1 / file2.cpp src / dir2 / file3.c src / dir2 / file4.c. <br><br>  12: In the variable with the source names of the extension .cpp is replaced with .o. <br><br>  13: In the variable with the source name of the extension .c is replaced by .o. <br><br>  15: The first rule to be declared is that its goal becomes the goal of the entire project.  A dependency is a constant containing the name of the program (../../bin/application_debug we passed it when running make from the script). <br><br>  17: Description of the key target.  The dependencies are also obvious: the presence of the created sub-directories in project / obj / Debug, repeating the structure of the project / src directory and the many object files in them. <br><br>  18: Describes the action on linking object files to the target. <br><br>  20: The rule in which the target is the project / obj / Debug / src directory and its subdirectories. <br><br>  21: Goal Achievement Action ‚Äî create the appropriate directories src /., Src / dir1 and src / dir2.  The -p switch of the mkdir utility ignores the error if there is already a directory created during the creation of any directory. <br><br>  23: VPATH is set to ../../.  This is required for the following rule templates. <br><br>  25: Describes a set of rules for which goals are any goals that correspond to the pattern% .o (that is, whose names end in .o), and dependencies for this purpose are goals of the same name, which correspond to the pattern% .cpp (that is, names that end in .cpp)  In this case, the same name means not only an exact match, but also if the dependency name is preceded by the contents of the variable VPATH.  For example, the names src / dir1 / file2 and ../../src/dir1/file2 match, since VPATH contains ../../. <br><br>  26: Call the compiler to turn the source code in C ++ into an object file. <br><br>  28: Describes a set of rules for which goals are any goals that correspond to the pattern% .o (that is, whose names end in .o), and dependencies for this purpose are goals of the same name that correspond to the pattern% .c (that is, names that end in .c)  Same name as line 23. <br><br>  29: Call the compiler to turn the C source code into an object file. <br><br>  31: Some clean target is declared abstract.  Achieving an abstract goal always happens and does not depend on the existence of a file of the same name. <br><br>  32: Declaring an abstract clean target. <br><br>  33: The action to achieve it is to destroy the project / bin and project / obj directories with all their contents. <br><br>  36: Include the contents of all dependency files (with a .d extension) in subdirectories of the current directory.  The make utility does this at the beginning of the parsing makefile.  However, dependency files are created only after compilation.  This means that during the first build no such file will be included.  But it's not scary.  The purpose of including these files is to recompile the sources depending on the modified header file.  For the second and subsequent builds, the make utility will include the rules described in all dependency files and, if necessary, achieve all the goals dependent on the modified header file. <br><br>  <b>Good luck!</b> </div><p>Source: <a href="https://habr.com/ru/post/111691/">https://habr.com/ru/post/111691/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111686/index.html">Javascript and canvas in the game "Life" by John Conway</a></li>
<li><a href="../111687/index.html">Demystifying Juniper's rib-groups</a></li>
<li><a href="../111688/index.html">Today started Google Science Fair 2011</a></li>
<li><a href="../111689/index.html">Presented by Verizon iPhone 4</a></li>
<li><a href="../111690/index.html">Hudson => Jenkins. Oracle doesn't give up</a></li>
<li><a href="../111692/index.html">Universal donated over 200,000 music records to the Library of Congress</a></li>
<li><a href="../111696/index.html">Ice Cream will be released in the summer</a></li>
<li><a href="../111698/index.html">Test Acer Liquid Metal - Game Asphalt 5</a></li>
<li><a href="../111699/index.html">Write code and post packages - this is only half the job</a></li>
<li><a href="../111700/index.html">Tap dance in flippers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>