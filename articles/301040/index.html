<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What browsers do with your JavaScript code: about optimizations in JS engines using V8 as an example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Optimization of the code begins not so much with the study of the features of a programming language, but with an understanding of the scheme of opera...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What browsers do with your JavaScript code: about optimizations in JS engines using V8 as an example</h1><div class="post__text post__text-html js-mediator-article">  Optimization of the code begins not so much with the study of the features of a programming language, but with an understanding of the scheme of operation of the whole "technological chain" involved in creating an application - from the program's algorithm to the compiler. <br><br>  We spoke with <b>Vyacheslav Egorov</b> aka <a href="https://habrahabr.ru/users/mraleph/" class="user_link">mraleph</a> , an engineer from Google, a compiler to the core, who worked on a JavaScript engine called V8, built into Chromium (and, as a result, in Chrome, the Android browser version, the cloud-based operating system Chrome OS) and in less famous maxthone. <br>  JavaScript programmers Vyacheslav, most likely, is known as the author of <a href="http://mrale.ph/">posts about the insides of V8</a> and as a speaker, enthusiastically showing machine code at conferences for Web developers. <br><br>  Currently, Vyacheslav is actively working on Google on Dart VM. <br>  In this interview, he talked about what was going on inside the engine that runs dynamic JS code and shared examples of how some optimizations are performed and why it is important to understand the engine‚Äôs work in depth to ensure fast code execution. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/6ba/1be/f36/6ba1bef360c148d18fbdadef60aa292a.gif"></div><a name="habracut"></a><br><blockquote>  <i>The V8 engine was developed by the Danish division of Google and distributed under a BSD license.</i>  <i>The engine is written in C ++ and supports the ECMA-262 specification.</i> <i><br></i>  <i>The first version of the engine appeared in 2008.</i>  <i>Currently, the active development of the engine continues for the most part in the Munich office of Google.</i> <i><br></i>  <i>Among the main features of the engine are javascript compilation directly into machine code, adaptive optimization and de-optimization of the code at compile time, quick garbage collection.</i> </blockquote><br>  <b><i>- Please tell us in a few words about yourself and about working at Google related to the V8 JavaScript engine?</i></b> <br><br>  - Finished mekhmat NGU.  Always interested in compilers.  He first worked at Excelsior Novosibirsk, where people make their own JVM with an AOT compiler, then went to Google.  At first, Google was engaged in V8, then Dart VM, for some time even fixed various bugs in LuaJIT. <br><br>  <i><b>- Many people prefer the V8 car for its ability to optimize the code.</b></i>  <i><b>What's the secret?</b></i> <br><br>  - The main difficulty in optimizing dynamic programming languages ‚Äã‚Äãis that in order to achieve peak performance, the virtual machine must, in essence, guess the programmer‚Äôs intention and see the static structure hidden in the dynamic code.  A strong feature of the V8 is that it can notice well enough this very structure. <br><br>  For example, someone wrote in JavaScript: <br><br><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p)</span></span></span></span> {  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Math.<span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>(px * px + py * py); }</code> </pre> <br>  and it turns out that V8 is quite capable of compiling the body of this function into a fairly compact machine code: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovsd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax+0x17]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmulsd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovsd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax+0x1f]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmulsd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vaddsd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm2</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vsqrtsd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm1</span></span></code> </pre> <br>  This is a completely non-trivial task in conditions where everything is dynamically typed and statically completely incomprehensible what <pre> <code class="hljs">px</code> </pre> <br>  or even <pre> <code class="hljs matlab">Math.<span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span></code> </pre>  . <br>  <i><b>- What about the weaknesses of the engine?</b></i> <br><br>  - Sometimes the strong side of the V8 becomes its weak side.  This happens for two reasons. <br>  Firstly, not in any dynamically typed code, V8 is able to see a static structure, which, perhaps, was obvious to the programmer who wrote this code.  Somewhere this happens, because in V8 something else is not implemented, somewhere - because it is not always algorithmically possible. <br><br>  One common example is the code in the style: <br><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { f: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x } } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = make(<span class="hljs-number"><span class="hljs-number">0</span></span>), b = make(<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  Here, V8 cannot notice that <i>af</i> and <i>bf</i> have the same behavior (adjusted for the value of the captured variables), because  these are functions created from the same functional literal (function literal). <br><br>  Secondly, sometimes the V8 optimizing compiler simply does not support some construction in the code, and therefore the compiler refuses to look at the code.  For example, Crankshaft (this is the first implementation of the idea of ‚Äã‚Äãadaptive compilation in V8) never supported try-catch / finally and therefore refused to optimize the functions where it was present.  Now functions that use try-catch are compiled via TurboFan (a compiler developed to replace Crankshaft), so the situation is rectified. <br><br>  Thirdly, sometimes the costs spent on identifying a static structure do not pay off.  V8 spends time, builds trees of hidden classes, optimizes / deoptimizes / optimizes the code again - and the code doesn't get better, for example, because objects are mostly used as dictionaries.  This is a very interesting problem area - how to properly balance the costs of code optimization and performance improvement from this optimization.  How to execute code at a reasonable speed, even if this code does not fall on the obvious fast path. <br><br>  Work on all these problems is underway, and therefore, in any cases when your code is slow on V8, you should complain to the V8 developers - at least so that they explain why the code is slow or maybe even fix something in the V8 itself . <br><br>  By the way, everything said above to one degree or another applies to any JavaScript engine that at least somehow tries to optimize your code.  All engines try to guess what the programmer wanted to say with his program, and try to see the static in the dynamic.  All engines have a division into fast path and slow path and their own features. <br><br>  <i><b>- Do you think it makes sense to optimize the code for a specific engine (in our case - V8)?</b></i>  <i><b>After all, it happens that in some browser the code slows down.</b></i>  <i><b>What to do then?</b></i> <br><br>  - There are two possible options (or a combination of them): <br><br><ul><li>  your code is ‚Äúbad.‚Äù  In this case, performance under just several engines usually suffers, and optimization under one engine improves code performance right under several; <br><br></li><li>  engine code is "bad."  In this case, as I noted earlier, you need to send a bug report to the developers of the engine, who can either fix the engine itself, or often recommend a way around the bug. <br></li></ul><br>  <i><b>- Can you list the most common ‚Äúrakes‚Äù that developers are attacking in their code (i.e., in fact, the most common errors in the code that have a strong effect on performance when targeting V8 - within the framework of the above situation ‚Äù Is the code bad?)?</b></i> <br><br>  - There are two types of rake.  The first type is an algorithmic rake.  For example, sometimes people iterate over a string using a loop in the style: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">for</span></span> (; <span class="hljs-attribute"><span class="hljs-attribute">s</span></span> != <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">s</span></span> = s.substring(<span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br>  Many compilers begin to bounce slightly on the chair and rub their hands when they see such code, since implementing an optimization that would make such a cycle into something sane is a terribly interesting task.  However, from the point of view of the developer, it is much more efficient to understand how much s.substring costs at best and worst, and not to write such code.  Because without tricky optimizations inside the engine, this cycle has a time complexity O (n <sup>2</sup> ). <br><br>  Another type of rake is the rake associated with the optimization of dynamic languages ‚Äã‚Äã(I have already touched on this above).  For example, a polymorphic code, i.e.  code that works with different types of objects.  Such a code for V8 is often kryptonite (a crystalline radioactive substance appearing in the DC Comics universe. Kryptonite is famous for being the only nonmagical weakness of Superman and other Krypton people - it can have an effect on them that varies depending on the color of the mineral. - <i>note . ed.</i> ) for Superman.  The topic is quite deep, and I have <a href="http://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html">a whole post with pictures</a> on this topic. <br><br>  <i><b>- How to deal with these problems?</b></i>  <i><b>Search for ‚Äúrules for writing code for a specific engine‚Äù and check your code for compliance with them?</b></i> <br><br>  - The most important thing here is to realize that performance problems cannot be solved in a swoop.  Suppose you heard about polymorphism and ran, losing slippers, rewriting all your code in a monomorphic style.  Anything good from such undertakings usually does not work.  Here we need a completely different approach, which is very well described by the classic Russian saying ‚Äúmeasure seven times, cut once‚Äù.  You need to build in your head a mental model of how a VM works and how your code works, you need to thoroughly profile, understand where your performance leaks, and only then ask yourself questions of optimization.  It often turns out that the V8 does its job well, but the real bottleneck is not even in javascript code. <br><br>  <i><b>- And if you go back to the problems of the compiler code you mentioned (the situation ‚Äúengine code is bad‚Äù)?</b></i>  <i><b>Is it possible to bring some of the most frequently mentioned V8 problems?</b></i> <br><br>  - Bugs do not usually appear "often" or "not often."  It usually happens that the bug was noticed by some developer, it was quickly repaired, and that was it.  Bugs at the same time affect only a small population of developers, because they are found in very special places with the right set of circumstances. <br><br>  As an example from practice: I was once asked to look at the code, which for some reason sometimes started to work very slowly.  It turned out all because of the expression <i>Math.floor (x * y)</i> , in which sometimes x became equal to -1, and y equal to 0. It would seem nothing special, but <i>Math.floor (x * y)</i> in this case equals the magic number ‚Äú negative zero ‚Äù(which is almost completely like 0, but if you divide, say, 1 by zero, you get positive infinity, and if you divide 1 by minus zero, you get negative infinity).  Crankshaft, on the other hand, always assumed that the result of the <i>floor</i> operation is an integer number, and therefore <i>-0</i> is a number that cannot be represented as a whole, which caused deoptimization.  The solution to the problem in this particular case was to replace <i>Math.floor (x * y) with (x * y) |</i>  <i>0</i> (in general, this is not an equivalent conversion, but for the code that needed to be overclocked, it did not matter).  By the way, recently this problem was <a href="https://bugs.chromium.org/p/v8/issues/detail%3Fid%3D2890">repaired</a> in Crankshaft <a href="https://bugs.chromium.org/p/v8/issues/detail%3Fid%3D2890">once and for all</a> . <br><br>  I specifically chose this bug as an example, since  he is quite mysterious (‚Äúwhat is the minus-zero?‚Äù, ‚Äúwhat kind of de-optimization?‚Äù) in the hope of convincing the reader that knowledge of specific bugs is completely useless.  I found that the code I was looking at was attacking this bug not because I knew that <i>Math.floor</i> does not tolerate <i>-0</i> , and armed with this knowledge went to replace all of <i>Math.floor</i> with <i>| 0</i> , until the bug was fixed ... No, I found this bug, because I knew how to profile the V8, with which keys I had to run it, so that the V8 showed me the list of de-optimizations.  Therefore, it is most important to understand how V8 (and other JS VMs) work. <br>  With this knowledge, you can always find out ‚Äúwhat went wrong somewhere in deep dungeons,‚Äù and then complain to higher authorities. <br>  I write a lot about this in my <a href="http://mrale.ph/">blog</a> and even <a href="http://mrale.ph/irhydra/2">made a tool</a> that allows you to view information issued by V8 (compiler IR, deopts, etc) in a more or less convenient form. <br><br>  <i><b>- You are now engaged in Dart?</b></i>  <i><b>When will this new language replace js?</b></i>  <i><b>Does the developer need to move to a new language now?</b></i>  <i><b>What is his position in the industry?</b></i> <br><br>  - Take and that's just so replace the JS in our whole universe is impossible.  But in some jobs - it is quite possible.  People replace it with different things, someone ClojureScript, someone TypeScript, and someone Dart.  Programming languages ‚Äã‚Äãare complex and conflicting.  Everyone has their opinion on their account.  So my advice is usually simple - tired of javascript?  You can go to dartlang.org, download the SDK (or <a href="https://dartpad.dartlang.org/">play</a> with the language directly in the browser) and decide for yourself. <br><br>  Of the interesting things that now occur with the language outside the Web, you can select <a href="https://flutter.io/">flutter.io</a> - this is a framework for developing cross-platform (Android &amp; iOS) mobile applications and <a href="https://dartino.org/">dartino</a> - a small Dart for embedded systems. <br><br>  <i><b>Thank you for the conversation!</b></i> <i><br><br></i>  <i>The examples above illustrate vividly that it‚Äôs not enough just to list the ‚Äúsimple recommendations for a specific engine‚Äù to optimize the code - it is important to understand the principle of its operation and, at the same time, to clearly understand what results you want to achieve from the program.</i> <i><br></i> <br><br><hr><br><br>  On June 5, in St. Petersburg, Vyacheslav will speak at the JavaScript conference of <b><a href="http://holyjs.ru/">HolyJS</a></b> with a <a href="http://holyjs.ru/talks/egorov.html">report on JavaScript performance</a> .  Come! </div><p>Source: <a href="https://habr.com/ru/post/301040/">https://habr.com/ru/post/301040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../301026/index.html">Review conference ProfsoUX-2016</a></li>
<li><a href="../301028/index.html">ReactOS 0.4.1 release and answer to the question ‚ÄúCan I patch ReactOS under KDE4?‚Äù</a></li>
<li><a href="../301030/index.html">Metromarathon Algorithm. As a Yandex analyst, I calculated that all stations can be visited in one day.</a></li>
<li><a href="../301032/index.html">12 week sketch marathon, do or die</a></li>
<li><a href="../301036/index.html">Best Go practices, six years in</a></li>
<li><a href="../301042/index.html">Angular 2 brings the world to the frontend galaxy</a></li>
<li><a href="../301044/index.html">Five ways to paginate in Postgres, from basic to outlandish</a></li>
<li><a href="../301046/index.html">Test lab v.9: impossible or nothing</a></li>
<li><a href="../301048/index.html">EDS of CIS countries in Python</a></li>
<li><a href="../301052/index.html">Watch out! Cycle bike! Or 5 service errors worth 1000 rubles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>