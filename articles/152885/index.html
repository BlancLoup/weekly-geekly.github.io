<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Restore defocused and blurred images. Increase quality</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to your attention the final article from the trilogy "Restoring defocused and blurred images." The first two caused a noticeable interest - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Restore defocused and blurred images. Increase quality</h1><div class="post__text post__text-html js-mediator-article">  I present to your attention the final article from the trilogy "Restoring defocused and blurred images."  The first two caused a noticeable interest - the area is really interesting.  In this part, I will look at the family of methods that give the best quality compared to the standard Wiener filter - these are methods based on Total Variaton prior. <br>  Also, by tradition, I posted a new version of SmartDeblur (along with the sources in open-source) in which I implemented this method.  The final quality was obtained at the level of commercial counterparts of the Topaz InFocus type.  Here is an example of processing a real image with a very large blur: <br><br><img src="https://habrastorage.org/storage2/eff/36d/77a/eff36d77a583b46e461c12a3c0037063.png"><br><a name="habracut"></a><br><h1>  Introduction </h1><br>  I will not describe the basic theory of deconvolution here, it was written in great detail about it in previous articles.  Those who have not read or forgotten them, I recommend to get acquainted with them first, in order to understand the terminology and classical approaches: <br><br>  <a href="http://habrahabr.ru/post/136853/">Part 1. Theory</a> ; <br>  <a href="http://habrahabr.ru/post/147828/">Part 2. Practice</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before proceeding to the description of Total Variation (hereinafter TV prior), it is necessary to understand what are the disadvantages of algorithms such as the classic Wiener filter?  The most basic ones are the ringing effect (a periodic halo at the edges of objects) even with a small noise level, blurring of borders and small details, as well as poor noise reduction from the point of view of human perception.  All this greatly hinders the practical use of the Wiener filter, limiting its application to the tasks of technical image restoration, for example, for reading inscriptions of interest. <br>  Therefore, in recent times a large number of various methods have been developed, the purpose of which is to improve the visual quality.  It should be noted that the number of parts at the same time, as a rule, does not increase. <br><br><h1>  Description TV prior </h1><br>  The main quality of Total Variation prior in terms of result is the preservation of sharp edges and the smoothing of artifacts of deconvolution.  It is written as follows: <br><img src="https://habrastorage.org/storage2/341/981/147/3419811470ba3c31a68c8511304eec4b.png"><br>  Unfortunately, the calculation of this functional cannot be done in a simple way, since it requires the use of very complex optimization techniques. <br>  Alternatively, you can use the smoothed functionality instead of the absolute value: <br><img src="https://habrastorage.org/storage2/cd9/e49/e1c/cd9e49e1cf987a2e84743463f599fb3c.png"><br>  When epsilon tends to zero, the result tends to the original definition of Total Variation, but the optimization process becomes more complex.  Conversely, with sufficient large epsilon, the optimization result will resemble a Wiener filter with blurring of the edges.  Unfortunately, the above formula has a non-quadratic form, so it cannot be simply calculated in Fourier frequency space, as was the case with Wiener and Tikhonov filters.  Therefore, one of the step-by-step optimization methods is needed to find an approximate solution ‚Äî for example, the classical gradient descent method: <br><img src="https://habrastorage.org/storage2/e07/1b4/1f9/e071b41f9e359488c982a6b7248be4d7.png"><br>  Where tau is calculated by the following formula: <br><img src="https://habrastorage.org/storage2/673/f92/542/673f92542b354e0b190d913ad5f1eb3d.png"><br>  And the gradient of the smoothed functional is defined as: <br><img src="https://habrastorage.org/storage2/0a9/851/4fb/0a98514fb1bd7ed9830deaab1f6ebb8b.png"><br>  The number of iterations should be large enough - a few hundred. <br><br>  This is the most basic approach in implementing TV prior, which is called head-on.  Nevertheless, even he gives very good results.  On the basis of it in scientific publications, many studies have appeared that are trying to further improve the quality and also reduce the calculation time. <br><br><h1>  Practical implementation </h1><br>  The formulas described are, in principle, uncomplicated, although very cumbersome to implement.  The main problem is to achieve high speed, because  The number of iterations is very large and each iteration contains many complex actions.  Namely - a few convolutions of the entire image, the calculation of the full gradient and divergence. <br>  I‚Äôll say right away that I haven‚Äôt yet managed to achieve a good work rate; on the image of several megapixels, the final calculation time is 2-3 minutes.  But Preview is fast - about 0.2 seconds. <br>  The build for Windows can be downloaded at: <br>  <a href="">github.com/downloads/Y-Vladimir/SmartDeblur/SmartDeblur-1.27-win.zip</a> <br>  Sources (licensed under GPL v3) are available at: <a href="https://github.com/Y-Vladimir/SmartDeblur">github.com/Y-Vladimir/SmartDeblur</a> <br><br>  The main changes from the previous version, which was described in the second part: <br><ul><li>  Two methods of deconvolution are added: TV prior and Tikhonov filtering </li><li>  Added support for restoring Gaussian blur </li><li>  Improved speed (about 2.5 times) </li><li>  Reduced memory consumption (about 1.5 times) </li><li>  The maximum size of the image processed by default is 3000 (but can be changed in the settings) </li><li>  Added settings section </li><li>  Added Updates Checker </li><li>  Drag &amp; Drop support </li><li>  Added Help Screen with sample image and customization tips. </li><li>  Fixed a bug with ripples in preview mode </li></ul><br>  C ++ using Qt. <br><br><h1>  Comparison </h1><br>  Well, now the most important thing is what quality you can expect when processing blurred images.  We will compare it with Topaz commercial Topaz InFocus.  The remaining analogues (such as FocusMagic) have not been supported for a long time, or they give completely unacceptable processing results.  So let's go. <br>  First, take an example of advertising from the Topaz InFocus website: <a href="">www.topazlabs.com/infocus/_images/licenseplate_compare.jpg</a> <br><img src="https://habrastorage.org/storage2/507/78b/66d/50778b66dbdc2a976de4ac9cf42672a9.png"><br><br>  Here is the result from Topaz InFocus: <br><br><img src="https://habrastorage.org/storage2/22b/3c6/b7a/22b3c6b7a088a59931cab3037d15aea7.png"><br><br>  But the result of SmartDeblur with the following parameters: <br>  Type: Motion Blur, Length: 10.1, Angle: -45, Smooth: 60% <br><img src="https://habrastorage.org/storage2/add/01b/364/add01b36458841cd0df4ab213cd18410.png"><br><br>  As you can see, the results are very similar.  And not so obvious that better.  Apparently, Topaz InFocus also uses an algorithm similar to TV prior plus post-processing in the form of sharping edges.  It should be noted that the given source blurred image, with a very high probability, is synthetic.  Those.  an undistorted image is taken and a motion blur filter is applied.  This can be seen in almost perfect recovery, as well as in suspiciously whole distortion parameters - an angle of 45 degrees and a length of 10 pixels. <br><br>  Now let's take a real image, which yesterday I took on my Canon 500D with a manual focus shift: <br><img src="https://habrastorage.org/storage2/e53/35a/8a8/e5335a8a82444a06aae7c6e4b1d6ea0d.jpg"><br><br>  Result from Topaz InFocus with the following parameters: <br>  Type: Out-of-Focus, Radius: 5.5, Suppress Artifacts: 0.34 <br><img src="https://habrastorage.org/storage2/a2b/35c/c97/a2b35cc976e5eac85a93e301088943b1.jpg"><br><br>  SmartDeblur result with the following parameters: <br>  Type: Out of Focus, Radius: 5.9, Smooth: 60% <br><img src="https://habrastorage.org/storage2/d61/100/ed3/d61100ed3e50a4b151575db627064a50.jpg"><br><br>  There is a draw, you can say.  The parameters in each program were selected to ensure the best quality. <br><br>  Another real example I shot: <br><img src="https://habrastorage.org/storage2/875/5c9/57d/8755c957df48bf75ed3e9017296fb3a7.jpg"><br><br>  SmartDeblur result with the following parameters: <br>  Type: Motion Blur, Length: 6.6, Angle: -37, Smooth: 53% <br><img src="https://habrastorage.org/storage2/08f/879/966/08f8799667b03f11523db41e532a8624.jpg"><br><br><h1>  findings </h1><br>  The third final article has come to an end.  It turned out not very big, but I hope it will be useful.  As you can see, the quality of processing obtained is quite acceptable for real use.  The main problem that remains is in places where there are light objects, after processing, a noticeable ringing effect is obtained.  I think this is due to the fact that in the light areas the linearity of the display of the brightness of the pixels is disturbed, which gives an incorrect interpretation of its real brightness.  Perhaps you need a logarithmic pre-processing of brightness, or something else. <br><br>  Once again I will remind: <br>  The build for Windows can be downloaded at: <br>  <a href="">github.com/downloads/Y-Vladimir/SmartDeblur/SmartDeblur-1.27-win.zip</a> <br>  Sources (licensed under GPL v3) are available at: <a href="https://github.com/Y-Vladimir/SmartDeblur">github.com/Y-Vladimir/SmartDeblur</a> <br><br>  And as usual - I will be very happy with comments and suggestions on SmartDeblur! <br>  Who will try the program - please note that the Smooth quality parameter in the preview mode and in the High-Quality mode behaves very differently.  Therefore, the final result of the smoothing slider can be evaluated only after the completion of High-Quality rendering. <br><br>  PS A huge request to everyone who writes me a mail.  After the publication of the two previous articles, I received (and continues to receive) a large number of letters with a request to restore the machine numbers in the frames from surveillance cameras, when the entire number occupies an area of ‚Äã‚Äãa few pixels. <br>  <b>I do not do that!</b>  SmartDeblur does not know how to do this either.  This is a completely different task, namely Super-Resolution, when from several low-resolution images you get a high-resolution image with new details that were not on the original data.  Maybe someday she'll do it, but definitely not in the near future. <br><br>  <b>UPDATE</b> Continuation Link: <br>  <a href="http://habrahabr.ru/post/175717/">Blind Deconvolution - automatic recovery of blurred images</a> <br><br><pre>  - </pre>  Vladimir Yuzhikov (Vladimir Yuzhikov) </div><p>Source: <a href="https://habr.com/ru/post/152885/">https://habr.com/ru/post/152885/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../152863/index.html">What do programmers know?</a></li>
<li><a href="../152867/index.html">Code Signing certificates or developer certificates. Views, how to choose</a></li>
<li><a href="../152873/index.html">Node.js on the Fidonet node: automating recurring publications</a></li>
<li><a href="../152875/index.html">HP ENVY 14 SPECTER Ultrabook Video Review</a></li>
<li><a href="../152883/index.html">Small format niche</a></li>
<li><a href="../152887/index.html">15 years ago the world saw Fallout</a></li>
<li><a href="../152889/index.html">Through thorns to Haskell. 1/2</a></li>
<li><a href="../152895/index.html">Release the first version!</a></li>
<li><a href="../152897/index.html">NEC EA273WM - very angry 27 inches</a></li>
<li><a href="../152899/index.html">Spy in your pocket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>