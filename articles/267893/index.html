<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking Appleseed source code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most of the projects described by us in the articles contain dozens of warnings from the PVS-Studio analyzer. Of course, this is a small part of the a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking Appleseed source code</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ce/6a1/367/0ce6a13677b288d6b1718ba751165eea.png"></div><br>  Most of the projects described by us in the articles contain dozens of warnings from the PVS-Studio analyzer.  Of course, this is a small part of the analyzer report selected for the article, but there are projects where there are not so many warnings and there are no interesting ‚Äúblunders‚Äù for the article.  Usually these are small or non-developing projects.  In this article I will talk about the verification of the Appleseed project, where from the point of view of PVS-Studio, the code is very high-quality. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  <a href="http://appleseedhq.net/">Appleseed</a> is a modern open source engine with physically sound rendering, designed to reproduce photorealistic images, animations and visual effects.  It offers a set of tools built on reliable and open technologies, both for individual users and for small studios. <br><br>  Using the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> analyzer in the Appleseed project, consisting of approximately 700 source code files, only a few interesting warnings of the 1st and 2nd levels were found. <br><br><h2>  Test results </h2><br>  <a href="http://www.viva64.com/ru/d/0300/">V670</a> The uninitialized class member 'm_s0_cache' is used to initialize the 'm_s1_element_swapper' member.  Remember that members are initialized in the order of declarations inside a class.  animatecamera cache.h 1009 <br><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DualStageCache</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> NonCopyable { .... S1ElementSwapper m_s1_element_swapper; <span class="hljs-comment"><span class="hljs-comment">//&lt;==Line 679 S1Cache m_s1_cache; S0ElementSwapper m_s0_element_swapper; S0Cache m_s0_cache; //&lt;==Line 683 }; FOUNDATION_DSCACHE_TEMPLATE_DEF(APPLESEED_EMPTY) DualStageCache( KeyHasherType&amp; key_hasher, ElementSwapperType&amp; element_swapper, const KeyType&amp; invalid_key, AllocatorType allocator) : m_s1_element_swapper(m_s0_cache, element_swapper)//warning... // warning: referring to an uninitialized member , m_s1_cache(m_s1_element_swapper, allocator) , m_s0_element_swapper(m_s1_cache) , m_s0_cache(key_hasher, m_s0_element_swapper, invalid_key) { }</span></span></code> </pre> <br>  The analyzer detected a possible error in the initialization list of the class constructor.  Judging by the comment "warning: referring to an uninitialized member", which was already present in the code, the developers know that they still use the uninitialized field 'm_s0_cache' to initialize the 'm_s1_element_swapper' field, but do not correct it.  According to the language standard, the order of initialization of class members in the constructor occurs in the order they are declared in the class. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://www.viva64.com/ru/d/0220/">V605</a> Consider verifying the expression: m_variation_aov_index &lt;~ 0.  An unsigned value is compared to the number -1.  appleseed adaptivepixelrenderer.cpp 154 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_variation_aov_index; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> m_samples_aov_index; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_tile_end</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Frame&amp; frame, Tile&amp; tile, TileStack&amp; aov_tiles)</span></span></span><span class="hljs-function"> APPLESEED_OVERRIDE </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_variation_aov_index &lt; ~<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//&lt;== aov_tiles.set_pixel(x, y, m_variation_aov_index, ....); if (m_samples_aov_index != ~0) //&lt;== aov_tiles.set_pixel(x, y, m_samples_aov_index, ....); .... }</span></span></code> </pre> <br>  The result of the inversion '~ 0' is the value -1, which is of type int.  Then this number becomes the size_t unsigned type.  Not scary, but not aesthetically pleasing.  In such expressions it is recommended to immediately indicate the constant SIZE_MAX. <br><br>  At first glance, there is no obvious error here, but my attention was drawn to the use of two different conditional operators, although both conditions check the same thing.  Conditions are true if the variables are not equal to the maximum allowable value of type size_t (SIZE_MAX).  These checks are recorded in different ways.  This code is very suspicious, perhaps there is a logical error. <br><br>  <a href="http://www.viva64.com/ru/d/0293/">V668 allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated</a>  The exception will be generated in the case of memory allocation error.  appleseed string.cpp 58 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">duplicate_string</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* s)</span></span></span><span class="hljs-function"> </span></span>{ assert(s); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(s) + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result) <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(result, s); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  The analyzer detected a situation when the value of the pointer returned by the 'new' operator is compared with zero.  It should be noted that if the 'new' operator could not allocate memory, then according to the C ++ standard of the language, an exception std :: bad_alloc () is generated. <br><br>  Thus, in the Appleseed project, which is compiled in Visual Studio 2013, most likely checking the pointer to zero is meaningless.  And ever use of this function can lead to unexpected results.  It is assumed that the duplicate_string () function will return nullptr if it cannot create a duplicate string.  Instead, it will generate an exception for which other parts of the program may not be ready. <br><br>  <a href="http://www.viva64.com/ru/d/0362/">V719 Enum</a> : InputFormatEntity.  appleseed inputarray.cpp 92 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> InputFormat { InputFormatScalar, InputFormatSpectralReflectance, InputFormatSpectralIlluminance, InputFormatSpectralReflectanceWithAlpha, InputFormatSpectralIlluminanceWithAlpha, InputFormatEntity }; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> add_size(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (m_format) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> InputFormatScalar: .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> InputFormatSpectralReflectance: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> InputFormatSpectralIlluminance: .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> InputFormatSpectralReflectanceWithAlpha: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> InputFormatSpectralIlluminanceWithAlpha: .... } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> size; }</code> </pre> <br>  And where is the case for InputFormatEntity?  This switch () block contains neither the default section nor actions for a variable with the value 'InputFormatEntity'.  Is this a mistake or did the author consider it necessary to skip this value? <br><br>  Such places found two more: <ul><li>  V719 Enum: InputFormatEntity.  appleseed inputarray.cpp 121 </li><li>  V719 Enum: InputFormatEntity.  appleseed inputarray.cpp 182 </li></ul><br>  In the absence of the 'default' section and processing of all values ‚Äã‚Äãof a variable, you can in some place potentially skip adding the code for the new value of 'InputFormat' and for a long time not knowing about it. <br><br>  32-bit integer type: (unsigned long int) strvalue appleseed snprintf.cpp 885 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UINTPTR_T unsigned long int int portable_vsnprintf(char *str, size_t size, const char *format, va_list args) { const char *strvalue; .... fmtint(str, &amp;len, size, (UINTPTR_T)strvalue, 16, width, </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//&lt;== precision, flags); .... }</span></span></span></span></code> </pre> <br>  Finally, a serious error was found in Appleseed, which manifests itself in the 64-bit version of the program.  The project is cross-platform and compiled under Windows and Linux.  To obtain project files, use Cmake.  The build documentation for Windows suggests using ‚ÄúVisual Studio 12 Win64‚Äù, therefore, in addition to general-purpose diagnostics (GA, General Analysis), I looked at diagnosing 64-bit errors (64, Viva64) of the PVS-Studio analyzer. <br><br>  The complete code for defining the macro 'UINTPTR_T' is as follows: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Support for uintptr_t. */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> UINTPTR_T #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> HAVE_UINTPTR_T || defined(uintptr_t) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UINTPTR_T uintptr_t #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UINTPTR_T unsigned long int #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* HAVE_UINTPTR_T || defined(uintptr_t) */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* !defined(UINTPTR_T) */</span></span></span></span></code> </pre> <br>  The uintptr_t type is an unsigned integer <a href="http://www.viva64.com/ru/t/0030/">memsize type</a> and is capable of safely storing the pointer in itself, regardless of the platform's bitness, but the type ‚Äúunsigned long int‚Äù was defined for the build in Windows.  The size of the type depends on <a href="http://www.viva64.com/ru/t/0012/">the data model</a> , and unlike Linux, on Windows the type of 'long' is always 32-bit, so in the Win64 platform the pointer will not fit into a variable of this type. <br><br><h2>  Conclusion </h2><br>  For its volume, the project tested with PVS-Studio contains few serious warnings from the analyzer, for which it receives the Clear Code medal and may no longer be afraid of the unicorn) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ea8/cd2/a4b/ea8cd2a4be084757a916caea0b27111a.png"></div><br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0349/">Checking Appleseed source code</a> . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0349/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/267893/">https://habr.com/ru/post/267893/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267879/index.html">Financial Computing Challenge</a></li>
<li><a href="../267881/index.html">12 typical database backup errors</a></li>
<li><a href="../267883/index.html">Optimization of communication channels for mining in the north of Russia</a></li>
<li><a href="../267887/index.html">.sorting in Perl 6</a></li>
<li><a href="../267889/index.html">GitFlow and Semantic Versioning for every day</a></li>
<li><a href="../267895/index.html">Creating a JavaScript Synthesizer</a></li>
<li><a href="../267899/index.html">Online Trading: How to become a developer of systems for trading on the exchange</a></li>
<li><a href="../267901/index.html">The digest of news from the world of development on Unity</a></li>
<li><a href="../267903/index.html">Common Python problems and solutions (translation)</a></li>
<li><a href="../267905/index.html">Egret Free open source HTML5 game engine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>