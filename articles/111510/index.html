<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple implementation of RC4 in C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 At one time I played one fairly well-known MMORPG in runet. I spent a lot of time on it, but soon the gameplay bored me. However, there...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple implementation of RC4 in C #</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/a0/ac/a0ac113bc41821d05cc790ddf0d9ea86.png" align="left" alt="RC4"><br><h4>  Introduction </h4><br>  At one time I played one fairly well-known MMORPG in runet.  I spent a lot of time on it, but soon the gameplay bored me.  However, there was a desire to learn how the game works and try to make various bells and whistles for it.  The first result was the curve bot written in C # and able to beat the mobs, but it also quickly became uninteresting.  By that time I stumbled upon a forum related to hacking games and, in particular, the theme of a talented programmer who at his leisure decided to disassemble game traffic.  It really interested me and I decided to repeat his achievement. <br><br>  Armed with Wireshark, I received several dumps and was, frankly, stunned by the contents.  There was no need to get used to hexadecimal values, but it was impossible to isolate any structure.  Since I have very little experience in system programming, I decided to use the advice of a professional (the author of the topic) and ask him for a tip: which way to dig.  In addition to general recommendations, I learned that the game traffic is encrypted using the RC4 algorithm, and the server data is also compressed (about this another time).  The direction was set and I began to study the algorithm to implement it in C #. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  General information about RC4 </h4><br>  So, RC4 is a stream cipher (stream cipher), which means that each character of the open (unencrypted) text will be encrypted depending on two parameters: the key and the position of the character in the clear text.  In the next section, I will explain how this works. <br><br>  This encryption algorithm was created by a professor at MIT, Ronald Rivest, to whom we also owe such algorithms as RC2, RC5, RC6, RSA and the MD2-MD6 hash ruler. <br><br>  Despite the fact that it is unlikely that anyone will use RC4 in new responsible projects due to known vulnerabilities, there are a number of technologies that use it.  Examples of such technologies are WEP, SSL, TLS.  Also, in my example, the developers of one of the MMORPG decided to use it. <br><br><h4>  Algorithm </h4><br>  I want everyone to understand how RC4 works, so I will explain on my fingers. <br><br>  So, the input data will be an array of bytes.  This can be any information: voice, image, text.  Of course, information can come in the form of a stream, but what is a stream, if not a long array? <br>  What kind of encryption without a key !?  The key also acts as input.  For RC4, it can be from 8 to 2048 bits, but usually a range of 40 - 256 bits is used. <br>  But the data for encryption is an array of bytes, and for some reason, the key is in bits.  The fact is that there is such a thing as block size n.  For example, we will use n = 8, but the algorithm will be even more cryptographic if we take n = 16.  Then in one step 2 bytes will be encrypted immediately. <br><br>  The ideal option in terms of strength for a stream cipher is a key size comparable to the size of the encrypted data.  Then each bit of plaintext is combined with the corresponding key bit by modulo 2 summation (XOR), forming an encrypted sequence.  For decryption, it is necessary to do the same operation again on the receiving side. <br><img src="https://habrastorage.org/storage/habraeffect/b7/0c/b70c7e1f2161d583e5a39a48a10d1fca.png" alt="Encryption principle" width="712" height="522"><br>  Provided that the sequence of key bits is chosen arbitrarily and has no periods, it is impossible to crack the cipher, but there is a problem of transmitting a long key.  Therefore, in practice, a pseudo-random number generator based on a given key is used to generate a keystream.  That is, we expand our key to any size (dynamically, during the processing of input data) and combine it with XOR with input data. <br><br>  Specifically, we will deal with the algorithm on the example of C #.  Create a class "RC4" and declare the following members: <br><blockquote><code><font color="black"><font color="#0000ff">byte</font> [] S = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [256]; <br> <font color="#0000ff">int</font> x = 0; <br> <font color="#0000ff">int</font> y = 0;</font></code> <br> </blockquote><br>  To generate a key stream, the cipher uses a hidden internal state consisting of two parts: <br>  - <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0">Permutations</a> containing all possible bytes from 0x00 to 0xFF (array S). <br>  - Variable counters x and y. <br><br>  For the initial initialization of the permutation vector with the key, the Key-Scheduling Algorithm is used: <br><blockquote> <code><font color="black"><font color="#0000ff">private</font> <font color="#0000ff">void</font> init( <font color="#0000ff">byte</font> [] key) <br> { <br> <font color="#0000ff">int</font> keyLength = key.Length; <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 256; i++) <br> { <br> S[i] = ( <font color="#0000ff">byte</font> )i; <br> } <br> <br> <font color="#0000ff">int</font> j = 0; <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> i = 0; i &lt; 256; i++) <br> { <br> j = (j + S[i] + key[i % keyLength]) % 256; <br> S.Swap(i, j); <br> } <br> }</font></code> </blockquote> <br>  In terms of code, nothing complicated.  I just want to note that the Swap method (swap two elements of the array) expands the standard list of Array class methods: <br><blockquote> <code><font color="black"><font color="#0000ff">static</font> <font color="#0000ff">class</font> SwapExt <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Swap( <font color="#0000ff">this</font> T[] array, <font color="#0000ff">int</font> index1, <font color="#0000ff">int</font> index2) <br> { <br> T temp = array[index1]; <br> array[index1] = array[index2]; <br> array[index2] = temp; <br> } <br> }</font> <br></code> </blockquote><br>  The init method must be called before encryption / decryption when the key is known.  You can do this in the constructor: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> RC4( <font color="#0000ff">byte</font> [] key) <br> { <br> init(key); <br> }</font></code> <br> </blockquote><br>  Next you need to implement a pseudo-random sequence generator (Pseudo-Random Generation Algorithm).  With each call, the method will spit out the next byte of the key stream, which we will combine with the xor and the byte of the source data. <br><blockquote> <code><font color="black"><font color="#0000ff">private</font> <font color="#0000ff">byte</font> keyItem() <br> { <br> x = (x + 1) % 256; <br> y = (y + S[x]) % 256; <br> <br> S.Swap(x, y); <br> <br> <font color="#0000ff">return</font> S[(S[x] + S[y]) % 256]; <br> }</font></code> <br> </blockquote><br>  Now the simplest is left!  For each byte of the array / stream of input unencrypted data, we request the key byte and combine them with xor (^): <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">byte</font> [] Encode( <font color="#0000ff">byte</font> [] dataB, <font color="#0000ff">int</font> size) <br> { <br> <font color="#0000ff">byte</font> [] data = dataB.Take(size).ToArray(); <br> <br> <font color="#0000ff">byte</font> [] cipher = <font color="#0000ff">new</font> <font color="#0000ff">byte</font> [data.Length]; <br> <br> <font color="#0000ff">for</font> ( <font color="#0000ff">int</font> m = 0; m &lt; data.Length; m++) <br> { <br> cipher[m] = ( <font color="#0000ff">byte</font> )(data[m] ^ keyItem()); <br> } <br> <br> <font color="#0000ff">return</font> cipher; <br> }</font></code> <br> </blockquote><br>  For decoding, you can use the same method.  Wrap it up in a separate method for clarity: <br><blockquote> <code><font color="black"><font color="#0000ff">public</font> <font color="#0000ff">byte</font> [] Decode( <font color="#0000ff">byte</font> [] dataB, <font color="#0000ff">int</font> size) <br> { <br> <font color="#0000ff">return</font> Encode(dataB, size); <br> }</font></code> <br> </blockquote><br>  An example of how this class can be used: <br><blockquote> <code><font color="black"><font color="#0000ff">byte</font> [] key = ASCIIEncoding.ASCII.GetBytes( <font color="#A31515">"Key"</font> ); <br> <br> RC4 encoder = <font color="#0000ff">new</font> RC4(key); <br> <font color="#0000ff">string</font> testString = <font color="#A31515">"Plaintext"</font> ; <br> <font color="#0000ff">byte</font> [] testBytes = ASCIIEncoding.ASCII.GetBytes(testString); <br> <font color="#0000ff">byte</font> [] result = encoder.Encode(testBytes, testBytes.Length); <br> <br> RC4 decoder = <font color="#0000ff">new</font> RC4(key); <br> <font color="#0000ff">byte</font> [] decryptedBytes = decoder.Decode(result, result.Length); <br> <font color="#0000ff">string</font> decryptedString = ASCIIEncoding.ASCII.GetString(decryptedBytes);</font></code> <br> </blockquote><br>  And here is the result to make sure everything works correctly: <br><img src="https://habrastorage.org/storage/habraeffect/ed/a3/eda33313da05c460db04c03729648f90.png" alt="RC4 output"><br><br>  By implementing the class that decrypts the traffic, we are one step closer to parsing the packets. <br><br>  In conclusion, I will say that this implementation is the most simple and obvious.  It can be complicated to increase resistance to cracking. <br><br>  Many thanks to my friend Vort for advice and recommendations. <br><br>  Link to the entire source: <br>  <a href="http://sourceforge.net/projects/rc4charp/files/RC4.cs/download">SourceForge - RC4.cs</a> </div><p>Source: <a href="https://habr.com/ru/post/111510/">https://habr.com/ru/post/111510/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111504/index.html">MultiTouch Ltd introduced the 46-inch multi-touch touchpad at CES</a></li>
<li><a href="../111505/index.html">Wine 1.3.11 release</a></li>
<li><a href="../111507/index.html">Ways of visualization in multi-dimensional games</a></li>
<li><a href="../111508/index.html">Clever cache deletion (php 5 + Mongodb + memcached)</a></li>
<li><a href="../111509/index.html">Role information modeling in programming</a></li>
<li><a href="../111511/index.html">Android PC Game Controller</a></li>
<li><a href="../111512/index.html">Threats Inside: we initialize channels of leakage of corporate information</a></li>
<li><a href="../111513/index.html">Reverse engineering android applications</a></li>
<li><a href="../111514/index.html">Mt: C language for heavily loaded servers</a></li>
<li><a href="../111515/index.html">Corporate colors of sites and companies</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>