<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we did the wiren board</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For the last 9 months, we have been developing Wiren Board - a compact industrial computer with many built-in interfaces (Wi-Fi, GPRS, GPS, NFC, Ether...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we did the wiren board</h1><div class="post__text post__text-html js-mediator-article">  For the last 9 months, we have been developing Wiren Board - a compact industrial computer with many built-in interfaces (Wi-Fi, GPRS, GPS, NFC, Ethernet, etc.). We have already <a href="http://habrahabr.ru/post/176357/">written</a> about it, and received a bunch of feedback and suggestions.  As a result, many changes have been made to the new version, and this article is about the most significant of them. <br><br>  Compared with the April prototype, 2 USB-host, RS-485 interface and 8 GPIO connector appeared on the board.  In addition, we made a new power supply circuit that supports input voltages from 5 to 22 volts, Passive PoE and a Li-Pol battery connection, added low-voltage load control and analog inputs on the terminal blocks. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/241/f94/d36/241f94d36a5f1b0dc122dab2a90b1245.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      How we did it, what difficulties we encountered and what happened in the end - read our article. <br><a name="habracut"></a><br><br><h3>  What and where on the board? </h3><br>  Wiren Board with the removed processor module: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/970/564/e43/970564e437fcfc5c59b9543d7cf3d70e.png"><br><br>  The inner side is usually closed by the processor module: <br><img src="https://habrastorage.org/getpro/habr/post_images/978/e0b/661/978e0b66186ab30cc224c353239622ff.png"><br><br><h1>  Analog Inputs and Outputs </h1><br>  In the new version of Wiren Board, we added the ability to connect analog signals and sensors (digital, resistive, ‚Äúdry contact‚Äù sensors), as well as control of low-voltage loads. <br><br>  The SoC we use has two 12-bit public ADC channels.  To increase the number of available ADC channels, we use the SN74HC4851 multiplexer, which connects one of the 8 channels to the processor's ADC input. <br><img src="https://habrastorage.org/getpro/habr/post_images/c3c/fee/aef/c3cfeeaef721b4c48d73fc13147c0a39.jpg" align="left"><br>  One channel of the ADC is used to measure the supply voltage, seven are led through resistors to the terminal blocks.  To protect the outputs from high voltages, resistors are sufficient, since the multiplexer has built-in protective diodes.  The ADC channel of our SoC has a programmable current source.  The values ‚Äã‚Äãof the resistors were chosen in such a way that, with the current source on, be able to measure the resistance of resistive sensors. <br><br>  To control low-voltage loads (motors, LED strips, locks, etc.), it is convenient to use open collector outputs (see fig.) <br><br>  To save space, the analog inputs were combined with low-voltage load control channels.  The disadvantage of this solution is a small current flowing through a closed output at voltages above 3.3 V. <br><br><h1>  Power Adventures </h1><br>  The task was to come up with a power scheme for the board.  Requirements for the power scheme are as follows: <br><ol><li>  The output current of the buses 3.3V and 5V is not less than 500mA for connecting USB, UEXT-modules and others. </li><li>  To power a GSM modem, it is necessary to provide a voltage from 3.5V to 4.6V, with impulse currents up to 2A and voltage drops of no more than 300mV. </li><li>  Ability to work on the Li-Ion battery, battery charging.  Battery overdischarge protection. </li><li>  Extended input voltage range, at least 5-15V. </li></ol><br><br>  Other conditions: <br><ol><li>  Do not use chips in cases without legs - QFN, DFN and the like - to mount them in Russia is very expensive </li><li>  Low cost </li><li>  Minimum dimensions </li></ol><br><br>  Decision: <br><br>  Since it is supposed to power the circuit from the battery, it is impossible to do without a step-up DC-DC converter for the 5V line.  An inexpensive NCP1450 chip was chosen (as it turned out later, not the best choice).  This is a step-up DC-DC converter with an external transistor. <br>  The voltage on the Li-Pol battery is 2.7..4.2V, but the ‚Äúplateau‚Äù on the discharge curve is around 3.7V.  Therefore, it is possible to use LDO to get 3.3V. <br>  We chose the linear regulator MCP1826, it provides current up to 1A.  Given the requirements of the GSM modem for voltage and current, it should be connected directly to the battery.  And it is better to add more capacitors.  So, while the circuit in which everything is connected to the battery. <br>  And then not so obvious. <br>  To charge the battery requires a special chip that will properly charge it.  You cannot charge the usual DC-DC, because it is necessary to maintain a constant voltage (4.2V) with high accuracy and limit the charging current (CC / CV mode).  But to be able to work without a battery, one cannot do without a step-down DC-DC converter! <br>  To resolve this contradiction using power management systems. <br><br>  In our case, it would look something like this: <br><br><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f26/1b4/f21/f261b4f21bbfe2f2aa2887d14259b638.png"><br><br>  But this option did not suit us in terms of cost and footprint. <br><br>  We decided to make a feint ears and went the other way. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/833/db1/fda/833db1fdad6f3f389700c8215c37ae87.jpg"><br><br>  The LTC4002 is a simple and inexpensive Li-Ion battery charger with a PWM controller operating as a step-down DC-DC converter.  The charger operates in constant current / constant voltage mode: it maintains a constant charging current until the battery voltage reaches 4.2V.  After that, it maintains a constant voltage of 4.2V on the battery with great accuracy. <br><br>  The microcircuit determines the charging current by measuring the voltage drop across the external resistor R_sense using the SENSE input.  After this, the charging current is set to I_c = 100mV / Rsense. <br><br>  For small batteries at 1500-2000 mA * h, the charging current should not exceed 500-700 mA, and the power supply should provide up to 2 A in pulsed mode for the GSM module.  In order to simultaneously fulfill these two conditions, it is necessary to ‚Äúdeceive‚Äù LTC4002. <br><br>  Using two Rsense resistors, we ensure that the charging current of the battery is no more than 100mV / (R1 + R2), and the current per load is up to 100mV / R1. <br><br>  We check: we pick a handkerchief with a power scheme, we collect, everything works fine.  The voltage gives out as it should, the battery is charging. <br><br><h3>  Miracles 1 </h3><br>  We order a fee in Rezonita, collect the whole scheme, turn it on - it does not work. <br>  We look with an oscilloscope - it turns out that the NCP1450 (step-up converter 5V) outputs the required voltage, but not the current :) Without a load at the output of 5 volts, as it should be.  But a small load of 10 mA - and the voltage drops to the input. <br><br>  In the power line, a ceramic capacitor is needed as close as possible to the legs of the NCP1450, as advised in datasheet :) 1 cm from the legs - and no longer works.  Still need to output capacitor was not less than 330 microfarads.  Capricious microcircuit, in the next version we will change. <br><br>  Okay, soldered more capacitors - it works. <br><br><h3>  Miracles 2 </h3><br>  We put Olinuksinka on (our processor board - OLinuXino-MICRO), turn on - does not work.  Turn it off, turn it back on - it works. <br>  It is switched on randomly with a probability of ~ 50%.  Magic. <br><br>  Cause: <br><br>  The LTC4002 charger has a tricky mode of charging half-dead batteries, in which it tries to charge the battery with a current of 10% of the nominal (trickle mode charging). <br>  The mode turns on when the battery voltage is less than 2.9V, and the 5V boost converter starts operating from 2.2V. <br><br>  And then who is faster: if the LTC4002 has time to charge the output capacitors up to 2.9V faster than the converter starts working, the power will turn on and continue to work normally.  If it does not have time, then NCP1450 starts to consume current, the voltage does not reach 2.9V, and LTC4002 considers our system as a dead battery, without increasing the current. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b9e/50f/b80/b9e50fb806229f00cb77196f8dcb7bfb.jpg" align="left"><br><br><h3>  Bring to mind </h3><br>  We will have to assemble a circuit that will disconnect the load until the voltage rises to 3V in order to ‚Äúslip‚Äù the trickle-charging mode of the LTC4002. <br><br>  Well, we put a bipolar transistor with an ultra-low voltage drop and a three-output zener diode (also known as a programmable voltage source, also known as shunt regulator) to its base. <br>  Resistor R3 sets the base current, divider R4-R5 sets the threshold turn-on voltage, and positive feedback through R6 creates a small on-off hysteresis - 3.1-2.9V.  Resistor R7 provides the minimum current of the cathode. <br>  At the same time, this solution will protect the battery from overdischarge and allow you to make the shutdown button.  With one crutch we solve three problems! <br><br><h3>  Miracles 3 </h3><br>  We continue testing the board with the power scheme. <br>  Input voltage 5V - everything works!  12 volts - NFC stops working, can not read the card: (( <br>  Cause: <br>  The power circuit creates strong interference that interferes with the operation of NFC. <br><br>  Maybe it's in unshielded coils? <br><br>  Ok, turn the coils to the side so that their field lines become perpendicular to the NFC antenna. <br>  We are checking.  12 volts - works, 22V (power is supplied via PoE) - does not work.  So you have to put shielded coils, even though they are twice as large. <br>  Okay, let's add filter capacitors to the right places in the power supply circuit. <br>  And now NFC works in the entire range of input voltages. <br><br><h3>  Miracles 4 </h3><br>  We check the work under load on lines 3.3V and 5V at 0.5 A. Using an infrared thermometer we control the temperature of the elements, the board heats up a little, but everything is within reasonable limits. <br>  But at 22V, the Schottky diode burns in ten seconds. <br>  Diode PMEG3010 - to 30V 1A.  In the step-down converter circuit, the higher the voltage, the more current flows through the diode at the same output power. <br><br>  Ok, we put the diode more powerful. <br><br><h3>  The benefits of reading datasheets </h3><br>  We redraw the board under shielded coils, add filter capacitors, shorten the tracks with impulse currents as much as possible.  We change the burned-out Schottky diode to 2 amp, transfer it to the outside and draw polygons for better cooling. <br>  We test the board - the diode burns in the same 10 seconds: ((It's time to carefully read the datasheets for these diodes. <br><br>  Looking carefully at the graphs, we note that the reverse current through the Schottky diode depends exponentially on both the temperature and the applied voltage.  And at a voltage of 22V at the diode at 30V reverse current is not so small.  The breakdown mechanism is something like this: while the diode is cold, the reverse current is very small, and the diode is heated only by direct current.  The diode is a little warm - the reverse current increases and increases the heating.  The temperature rises - the current even more. <br><br>  And now - an avalanche-like rise in temperature and an end. <br>  In practice, it looks like this - turn on, the diode is cold, warm, even warmer, burned out. <br>  In general, you must read the datasheets very carefully and not believe what they write on the first page. <br><br><h3>  Lyrical digression </h3><br>  In this place, I want to convey heartfelt greetings to the <s>marketing</s> engineers of NXP, who actually write these datasheets.  Here, for example, Schottky diode PMEG4050.  The stated characteristics: 40V reverse voltage, 5A maximum current.  Looks good! <br>  However, if you read what is written in small print, it turns out that 5A is measured at an air temperature of 0 degrees (sic!) For a diode brazed on a ceramic printed circuit board.  Here it is asked why it was not to write an honest 3 amps in the characteristics?  Riddle. <br><br>  As a result, we put a diode with a voltage of 40V, the circuit works stably and without overheating.  Got a workable power scheme, which is used in the first series of devices. <br><br><h3>  Plans </h3><br>  Despite the fact that in the end we got an inexpensive and stable power supply scheme operating in the whole range, we already had a couple of ideas on how to improve it.  First, you can replace the linear stabilizer for the 3.3V line with a compact step-down DC-DC converter.  In addition, you can change the boost converter for the 5V line with a less demanding and higher frequency chip.  Such a conversion will slightly increase the efficiency and free up space on the board for some other module. <br><br><h1>  Conclusion </h1><br>  Detailed description of the Wiren Board and wiki with the documentation <a href="http://contactless.ru/blog/">here</a> . <br><br>  We collected the first small batch of 55 Wiren Board in Russia and distribute them among developers and users.  Looking forward to your feedback! <br><br>  UPD: devices from the first batch still remain, you can buy them on our website <br><br>  - Wiren Board Team </div><p>Source: <a href="https://habr.com/ru/post/197522/">https://habr.com/ru/post/197522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197512/index.html">The tale of how the First Channel itself creates prohibited content and complains about it</a></li>
<li><a href="../197514/index.html">Officials rejected the petition to repeal the "anti-piracy" law</a></li>
<li><a href="../197516/index.html">Network for the smallest. Micro Issue number 3. IBGP</a></li>
<li><a href="../197518/index.html">ePayService at Kyiv CasualConnect 2013</a></li>
<li><a href="../197520/index.html">Lock-free data structures. Basics: Memory Model</a></li>
<li><a href="../197524/index.html">Symfony CMF. Part 1, data storage</a></li>
<li><a href="../197528/index.html">ABCat: OpenSource catalog and audiobook downloader</a></li>
<li><a href="../197540/index.html">Algorithm of data distribution in a server cluster in dCache</a></li>
<li><a href="../197542/index.html">HTC One max officially presented</a></li>
<li><a href="../197546/index.html">Ghost: Just a blogging platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>