<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ÄúSometimes you have to look into the Spark code‚Äù: Alexander Morozov (SEMrush) about using Scala, Spark and ClickHouse</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the case of SEMrush, it is pointless to ask "which languages ‚Äã‚Äãand technologies the company uses": here each team is provided with the maximum degr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>‚ÄúSometimes you have to look into the Spark code‚Äù: Alexander Morozov (SEMrush) about using Scala, Spark and ClickHouse</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/ed/ba/59edba66c0eb7905381697.jpeg"><br><br>  In the case of SEMrush, it is pointless to ask "which languages ‚Äã‚Äãand technologies the company uses": here each team is provided with the maximum degree of autonomy, reducing the "common to all" to a minimum.  But the specific team is quite what to ask. <br><br>  We learned that Scala, C ++, Spark and ClickHouse are used in one of the projects.  The choice of Scala is in itself non-standard, the combination with C ++ can be found even less often, the ClickDouse DBMS from Yandex is also not the most common choice - so we decided to ask a few questions about how it all lives.  <b>Alexander Morozov</b> answered us. <br><a name="habracut"></a><br>  <b>- First, tell us which team you are on in SEMrush and in which position?</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      - Backend developer, Maroon team, Traffic Analytics project.  We do something like Google Analytics on the contrary - using all sorts of clever statistical methods, we use the metrics of sites all over the Internet. <br><br>  <b>- Why was it decided to use Scala - due to the fact that you have Spark, or for other reasons?</b>  <b>There is an opinion that ordinary Java is just as good for using Spark, and what does your experience say about it?</b> <br><br>  - If objectively, of course, because Spark is written in Scala.  Java fits perfectly, but when the standard functionality begins to be missed, it is more convenient to add your modules to Scala.  Personally, I don‚Äôt quite understand how easy and simple it is to write implish classes that extend the functionality of Spark structures ‚Äî I would have to drag a rock into the project. <br><br>  Well, yes, the best documentation is the code.  Sometimes it is necessary to look into the Spark code, and here without knowing the language in which this code is written, in any way.  A real-life example is to define and register a dialect in an SQL script so that it can insert data into ClickHouse via jdbc.  Obviously this moment was not documented, I had to poke around in the code of Spark to understand where the error is, and what needs to be implemented to eliminate it. <br><br>  And if we talk about the subjective side - a long story.  I had previous experience in telecoms, from there I brought out a love for actors, and there I became interested in functional programming: I started with Erlang, then Haskell, and then Scala.  Scala, as the intersection of OOP and OP, and even having Akka - the choice is obvious :) <br><br>  <b>- Since few people use Scala in Russia, I would like to ask: what was the practical experience, what is good, and what is pain?</b> <br><br>  - In general, I am satisfied with the conciseness of the code, the speed of development, the number of libraries (including those written in Java).  After the Erlang, there is a lack of a normal matching pattern.  Not that the pain, but sometimes it is difficult to deal with errors.  On the one hand, implications allow you to write concisely and flexibly, on the other - it is sometimes difficult to understand what went wrong even at the compilation stage.  Here, I really remember with a shudder what footcloths gcc displays to errors in the template classes. <br><br>  Most of all pain, in fact, delivers purely infrastructural things.  A computing cluster is quite a capricious thing.  That calculation will fall in the middle due to lack of memory.  That place on some of the disks will suddenly end.  That because of network lags in DTs the node will fall off.  Bugs in a distributed system - generally a separate conversation.  To diagnose and fix such problems is quite a chore. <br><br>  <b>- Both Scala and C ++ have the reputation of languages ‚Äã‚Äã‚Äúnot for the faint of heart‚Äù.</b>  <b>How do you live with this combination in one project?</b>  <b>Does he turn out to be much more ‚Äúhardcore‚Äù typical, is it difficult for a junior to do this?</b> <br><br>  - It seems to me that C ++ will be more smart.  What is sometimes worth otdebazhit "double free or corruption", or a memory leak.  Many things had to be done, including manual analysis of memory dumps in the hex editor.  In Scala, perhaps, there will be fewer ways to shoot one's leg, although there are also enough nuances, of course. <br><br>  And for the juna, sometimes it‚Äôs hardest not to write in C ++ in the C style with classes, and on Scala in the Java style with a strange syntax :) <br><br>  <b>- And do you have to pay for the choice of languages ‚Äã‚Äã/ technologies so that everything is technologically powerful, but is it difficult to find people for such a project?</b> <br><br>  - Of course.  We have just opened a vacancy for the second backend.  But since the problem of finding people in a non-most mainstream language is quite acute, we are not looking directly for a 100% match.  A person who knows, for example, C ++ and Scala, is quite suitable.  Or Scala / Java and Spark, but without C ++.  The rest - we will teach. <br><br>  <b>- Let's go to ClickHouse: and what were the reasons for choosing there?</b> <br><br>  - We needed a base capable of storing and processing hundreds of billions of events in a reasonable time.  ClickHouse is the base. <br><br>  <b>- Yandex says beautiful words like ‚Äúwithin the framework of its narrow niche, ClickHouse has no alternatives‚Äù - how much does your practical experience confirm such words?</b>  <b>Who can you recommend using ClickHouse?</b> <br><br>  - Well, we once thought seriously about Vertica.  I also had a working prototype of the analytical part of our current system exclusively on Spark / Hive, but it required a lot of intermediate ‚Äúmanual‚Äù actions, and as a result, it worked much slower.  Let's say so, in some form there is an alternative, then you need to choose the balance of pros and cons for a specific project.  ClickHouse is great for projects one way or another connected with web-analytics. <br><br>  <b>- ClickHouse is a relatively young development (at least, if you count from the transition to open source).</b>  <b>Does it interfere?</b>  <b>Are there any ‚Äúpioneers‚Äù with her who fill the bumps and send bug reports?</b> <br><br>  - Sometimes it baffles the lack of seemingly obvious functionality.  There is something in the roadmap for the coming quarters.  Non-critical bugs stumbled, but they were not pioneers - everyone was already worried.  In general, the main functionality is in place, the bugs are fixed fairly quickly. <br><br>  <b>- Does the use of ClickHouse somehow affect the fact that it was created in Russia?</b>  <b>Is there a feeling that its developers are ‚Äúat arm's length‚Äù, do you communicate with them?</b> <br><br>  - ClickHouse has a Russian-language Telegram-chat, in which you can very quickly get answers to questions from developers.  For me it was a pleasant surprise: even in corporate products with extremely expensive support, diagnostics and problem solving can result in a weekly correspondence ‚ÄúRe [100500]:‚Äù.  Taking this opportunity, I would like to thank the team of Yandex in general, and Alexey Milovidov for personally helping. <br><br>  <b>- In your opinion, how did ‚Äúindependence of teams‚Äù in SEMrush affect your choice of technology stack, which allows you to ‚Äúpick and choose‚Äù non-standard?</b> <br><br>  - I think almost nothing.  We didn‚Äôt wake up one day and didn‚Äôt say to ourselves, ‚Äúbut from now on, write on Scala‚Äù.  Such immaturity as a developer would be impermissible.  At first we had a project exclusively in C ++.  At some point, they wrote a prototype for research, which was not used in production.  However, it was possible to write it so quickly, to parallel the calculations became so much easier, and the development turned out to be such a boost that they decided to implement.  According to the experience of previous jobs, the process would be similar in a more ‚Äútraditional‚Äù company: write a prototype, give an assessment of the pros and cons of what is called ‚Äúsell‚Äù to its management, implement it.  Of course, an important condition is to provide support and further development - that is, several people in the company must be familiar with the stack and be able to ‚Äúpick up‚Äù the project. <br><br>  <b>- Given that the team chose the stack independently, I want to understand how the experience of the ‚Äúneighbors‚Äù affects.</b>  <b>When your stack was being formed, did its components actively use other commands in SEMrush, and did it affect the decision?</b> <br><br>  - Naturally, we are interested in what our neighbors have.  Spark used the R &amp; D team, when we still had it, for our own research and statistics.  They have learned from them.  ClickHouse began to study and implement with another team when the question of data storage arose. <br><br>  <b>- And how actively do you influence others now?</b>  <b>Does it often happen to share your expertise in the same Scala and ClickHouse within the company, and does this lead to ‚Äúoh, we also want‚Äù?</b> <br><br>  - On Scala, another team started writing.  And ClickHouse with us in general, as they say, ‚Äúhas entered‚Äù.  We actively communicate and exchange experience with other teams.  Not that purposefully promoted, but conversations in the spirit of ‚ÄúI heard, do you have a klikhaus?  And tell me, we also think ‚Äùarise regularly. <br><br><img src="https://habrastorage.org/webt/59/ed/ba/59edba66d31e0499508862.jpeg"></div><p>Source: <a href="https://habr.com/ru/post/341288/">https://habr.com/ru/post/341288/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341274/index.html">Graylog2 incremental setup</a></li>
<li><a href="../341276/index.html">Safety Issues of Smart Energy</a></li>
<li><a href="../341278/index.html">What is good (and bad) Typescript: experience of UI-developers</a></li>
<li><a href="../341280/index.html">Shutdown PC anywhere in the world (JAVA)</a></li>
<li><a href="../341282/index.html">Google Analytics API for a marketer on a practical example</a></li>
<li><a href="../341294/index.html">Monitoring system, are you sure that it works?</a></li>
<li><a href="../341296/index.html">An extraordinary charge: how we have automated the park</a></li>
<li><a href="../341298/index.html">Listen to traffic and increase the loyalty of bank customers: myth or reality</a></li>
<li><a href="../341300/index.html">Extreme Networks is making Network Fabrics a reality</a></li>
<li><a href="../341302/index.html">Beauty go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>