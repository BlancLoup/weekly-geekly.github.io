<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>UAC, let's be friends!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="UAC technology is not a superfluous component of the latest Windows OS security, and users come to this thought while fighting with malware and viruse...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>UAC, let's be friends!</h1><div class="post__text post__text-html js-mediator-article">  UAC technology is not a superfluous component of the latest Windows OS security, and users come to this thought while fighting with malware and viruses.  Programmers, in turn, should correctly approach the writing of applications and take into account the presence of such a "circumstance". <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c6/3da/333/0c63da333b3fb6a904051ffd36d8bca6.png" alt="image"><br><br>  There are a lot of articles on Habr√© and in general on the topic ‚ÄúHow to disable UAC‚Äù, ‚ÄúHow to bypass UAC‚Äù, etc. But why disconnect, because this function is useful?  Why bypass, we are not intruders? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Need to be friends! <br><br>  Below I will tell you how to do this in your application. <br><a name="habracut"></a><br><h4>  Manifesto </h4><br>  To begin with, we will consider the simplest and ugliest, in my opinion, option - editing the manifest.  What is he bad?  That is suitable only for those applications that always need to have administrator privileges.  How will it look like?  When launching your application, a user will receive a familiar window in which he will need to confirm permission for the program to perform actions with administrator privileges.  And so every time you start the program.  In principle, the option is acceptable for programs that run infrequently and in one instance. <br><br>  Immediately I must say that in autostart (not sure that by all means, but at least through the registry) such applications cannot be placed.  Windows will simply slam them at the start without showing any UAC window.  Maybe in this case it makes sense to use the technology of Windows services. <br><br>  So the implementation (taken <a href="http://www.codeproject.com/Articles/17968/Making-Your-Application-UAC-Aware">from here</a> ) <br><br><pre><code class="xml">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
    &lt;assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0"&gt;
    &lt;trustInfo xmlns="urn:schemas-microsoft-com:asm.v3"&gt;
        &lt;security&gt;
            &lt;requestedPrivileges&gt;
                &lt;requestedExecutionLevel level="asInvoker" uiAccess="false"/&gt;
            &lt;/requestedPrivileges&gt;
        &lt;/security&gt;
    &lt;/trustInfo&gt;
&lt;/assembly&gt;    
</code></pre><br>
  :<br>
<ul>
<li><b>asInvoker </b> ‚Äî     (-).    -.</li>
<li><b>highestAvailable </b> ‚Äî      . ..          ,      .</li>
<li><b>requireAdministrator</b> ‚Äî   .        .</li>
</ul><br>
        .     ,      ,    ,  ,        ,    .<br>
<br>
<h4> </h4><br>
<h5>   </h5><br>
         ,   ,           (    UAC).   ,       .    (, ,      C#):<br>
<br>
<pre><code class="cs">public static bool IsAdmin()
{
	System.Security.Principal.WindowsIdentity id = System.Security.Principal.WindowsIdentity.GetCurrent();
	System.Security.Principal.WindowsPrincipal p = new System.Security.Principal.WindowsPrincipal(id);
	
	return p.IsInRole(System.Security.Principal.WindowsBuiltInRole.Administrator);            
}
</code></pre><br>
<h5>    </h5><br>
,    .   ? ,   - ,        .             .    :<br>
<br>
<pre><code class="cs">public static void RunAsAdmin(string aFileName, string anArguments)
{
	System.Diagnostics.ProcessStartInfo processInfo = new System.Diagnostics.ProcessStartInfo();
  
	processInfo.FileName = aFileName;
	processInfo.Arguments = anArguments;
	processInfo.UseShellExecute = true;
	processInfo.Verb = "runas"; //   
            
	System.Diagnostics.Process.Start(processInfo);
}
</code></pre><br>
    ?    :<br>
1. <b>    .</b> ,         .   WinAPI      .NET,       ,    .    <b>DHCP Client</b>,  ,    <br>
<code>sc.exe start dhcp</code><br>
           ,      .<br>
<br>
2. <b>     .</b> ,      WinAPI             ,   .         ,      .      ,     ,    .. <br>
<br>
2. <b>           . </b>      ,           .      .   ,          Windows    ,  -    .<br>
<br>
3.<b>        .</b> ,      ,      .               .  -   ,      .  ,   StackOverflow   ,        ,     .<br>
<br>
4. <b>    .</b>      ,      :   .    (         <b>IsAdmin</b>()) ,   ,  ,                .    (<b>IsAdmin</b>()  <b>true</b>)    . <br>
<br>
 ,                  .     UAC,   ¬´¬ª     . <br>
<br>
       ,       -         .     .<br>
<br>
<h4> </h4><br>
             UAC         .<br>
<br>
<img src="https://habrastorage.org/storage2/3c7/af3/42b/3c7af342bc426b9208adcbe2af5c948b.png"><br>
<br>
    , link-label'    ,         UAC.  ,      ,   ,   ,       .<br>
<br>
 <b>WinForms</b>-        . <br>
<br>
<pre><code class="cs">[DllImport("user32.dll", CharSet = CharSet.Unicode)]
public static extern IntPtr SendMessage(HandleRef hWnd, UInt32 Msg, IntPtr wParam, IntPtr lParam);

public static void SetButtonShield(Button btn, bool showShield)
{
    // BCM_SETSHIELD = 0x0000160C
	btn.FlatStyle = FlatStyle.System;
    SendMessage(new HandleRef(btn, btn.Handle), 0x160C, IntPtr.Zero, showShield ? new IntPtr(1) : IntPtr.Zero);
}
</code></pre><br>
 ,     WinForms        <b>WPF</b>,   .  ,   <b>ImageSource </b>     - ,    .<br>
<br>
<pre><code class="cs">System.Drawing.Icon img = System.Drawing.SystemIcons.Shield;

System.Drawing.Bitmap bitmap = img.ToBitmap();
IntPtr hBitmap = bitmap.GetHbitmap();

ImageSource wpfBitmap =
	 System.Windows.Interop.Imaging.CreateBitmapSourceFromHBitmap(
		  hBitmap, IntPtr.Zero, Int32Rect.Empty,
		  BitmapSizeOptions.FromEmptyOptions());
</code></pre><br>
<h4></h4><br>
   ,    .<br>
   ,        (     MessageBox).      ,     .   ,          ,      .    <s> </s> . <br>
<br>
<img src="https://habrastorage.org/storage2/333/933/886/3339338861fa435d2e4f1899093a6d8d.png"><br>
<br>
 ,                    .<br>
<br>
<img src="https://habrastorage.org/storage2/546/4bb/a87/5464bba87e30f5289b06e8c141b79a85.png"><br>
<br>
,  ,                UAC.    <a href="https://github.com/yan4esko/MyHabra/tree/master/HabraProjects">github</a>.<br>
<br>
    ,   .</div><p>Source: <a href="https://habr.com/ru/post/185264/">https://habr.com/ru/post/185264/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185248/index.html">Authentication in a new way, or superkuki</a></li>
<li><a href="../185250/index.html">Summer, vacation, asterisk or your own VoIP operator</a></li>
<li><a href="../185252/index.html">C ++ notification area icon</a></li>
<li><a href="../185256/index.html">Weekday rdp or modest RDCMan say a word</a></li>
<li><a href="../185260/index.html">Implementation of work with faxes in asterisk</a></li>
<li><a href="../185266/index.html">Plasmoid in pure QML and JavaScript</a></li>
<li><a href="../185268/index.html">Drawings in SVG format. Part 2. - Draft Standard</a></li>
<li><a href="../185270/index.html">Connect to the live online broadcast of Visual Studio 2013 July 5</a></li>
<li><a href="../185274/index.html">ntop is back. New generation release - ntopng</a></li>
<li><a href="../185278/index.html">Mail.ru rejected Google search</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>