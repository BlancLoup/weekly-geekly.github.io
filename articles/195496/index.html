<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple parser JSON on PL / SQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Just yesterday, a problem suddenly arose - it was necessary to parse the data in JSON format directly in the Oracle stored procedure. Of course, Java ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple parser JSON on PL / SQL</h1><div class="post__text post__text-html js-mediator-article">  Just yesterday, a problem suddenly arose - it was necessary to parse the data in <a href="http://ru.wikipedia.org/wiki/JSON">JSON format</a> directly in the Oracle stored procedure.  Of course, <a href="http://www.oracle.com/technetwork/articles/java/json-1973242.html">Java</a> was added to such things in Oracle, but I wanted something more than my own and written directly in PL / SQL.  I spread the results of my impulse to the public.  Suddenly someone come in handy. <br><a name="habracut"></a><br>  For a start, it's helpful to decide what we are going to do.  Let the source data lie in the CLOB-field of a table: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ae_spec ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> varchar2(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLOB</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ae_spec <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> pk_ae_spec primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>);</code> </pre> <br>  We will add the result of the analysis to a tree placed in a temporary label and used directly in the same transaction in which we parse the data: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ae_json ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, parent_id <span class="hljs-built_in"><span class="hljs-built_in">number</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> varchar2(<span class="hljs-number"><span class="hljs-number">1000</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> varchar2(<span class="hljs-number"><span class="hljs-number">1000</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>;</code> </pre><br>  By loading data into this table, we can use the full power of SQL to process it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now everything is ready for the development of our small package: <br><br><div class="spoiler">  <b class="spoiler_title">Package preparation</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ae_spec_pkg <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> compile(p_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> varchar2); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> ae_spec_pkg; / <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> ae_spec_pkg <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> compile(p_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> varchar2) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">--  JSON load(p_name); -- </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">   commit; exception when others then rollback; raise; end; end ae_spec_pkg; /</span></span></code> </pre><br></div></div><br>  JSON parsing will be conveniently divided into two procedures.  The task of the scanner (load procedure) is to view the source text and extract from it a stream of <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B5%25D0%25BA%25D1%2581%25D0%25B5%25D0%25BC%25D0%25B0_%2528%25D0%25B8%25D0%25BD%25D1%2584%25D0%25BE%25D1%2580%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B8%25D0%25BA%25D0%25B0%2529">tokens</a> : <br><br><div class="spoiler">  <b class="spoiler_title">Scanner</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> ae_spec_pkg <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> g_spec_state <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; g_name_state constant number default 1; procedure lexem(p_state in number ,p_value in varchar2) as <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ae_script_log(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, tp, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (ae_script_log_seq.nextval, p_state, p_value); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; procedure <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>(p_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> varchar2) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> l_lob <span class="hljs-keyword"><span class="hljs-keyword">CLOB</span></span>; l_str varchar2(1000) default null; l_len number default null; l_pos number default 1; l_ix number default 1; l_st number default g_spec_state; l_ch varchar2(1) default null; l_val varchar2(1000) default null; l_qt varchar2(1) default null; l_bs number default 0; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_lob <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ae_spec <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = p_name <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>; dbms_lob.open(l_lob, dbms_lob.lob_readonly); l_len := dbms_lob.getlength(l_lob); while l_pos &lt;= l_len loop l_str := dbms_lob.substr(l_lob, 1000, l_pos); l_ix := 1; while l_ix &lt;= length(l_str) loop l_ch := substr(l_str, l_ix, 1); if not l_qt is null then if l_bs = 1 then if not l_ch in (chr(13), chr(10)) then l_val := l_val || l_ch; l_bs := 0; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch = '\' then l_bs := 1; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch = l_qt then lexem(l_st, l_val); l_st := g_spec_state; l_qt := null; else l_val := l_val || l_ch; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch in ('{', '}', '[', ']', ':', ',', ' ', chr(9), chr(13), chr(10)) then if l_st = g_name_state then lexem(l_st, l_val); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch in ('{', '}', '[', ']', ':', ',') then lexem(g_spec_state, l_ch); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; l_st := g_spec_state; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch in ('''', '"') then l_val:= null; l_qt := l_ch; l_st := g_name_state; l_bs := 0; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_st = g_name_state then l_val := l_val || l_ch; else l_val := l_ch; l_st := g_name_state; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; &lt;&lt;l&gt;&gt; l_ix := l_ix + 1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; l_pos := l_pos + 1000; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; if l_st = g_name_state then lexem(l_st, l_val); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; dbms_lob.close(l_lob); exception when others then if dbms_lob.isopen(l_lob) = 1 then dbms_lob.close(l_lob); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; raise; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> ae_spec_pkg; /</code> </pre><br></div></div><br>  Since JSON is a very simple format, our scanner needs only two states (g_spec_state - waiting for the next control character and g_name_state - waiting for the continuation of entering a name or value). <br><br>  In order to make sure that the analysis is correct, we will put the result for the time being in the tablet - the log.  Making sure on several test examples that everything works as intended, we make changes to lexem, to save the received data in the tree (we make small changes to the load in order for everything to work): <br><br><div class="spoiler">  <b class="spoiler_title">Ready parser</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-keyword"><span class="hljs-keyword">body</span></span> ae_spec_pkg <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> g_spec_state <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> <span class="hljs-built_in"><span class="hljs-built_in">number</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; g_name_state constant number default 1; e_syntax_error EXCEPTION; <span class="hljs-keyword"><span class="hljs-keyword">pragma</span></span> EXCEPTION_INIT(e_syntax_error, <span class="hljs-number"><span class="hljs-number">-20001</span></span>); procedure lexem(p_state in number ,p_value in varchar2 ,p_node in out NOCOPY number) as l_id number default null; l_vl ae_json.name%type; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p_state = g_spec_state <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p_value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'}'</span></span>, <span class="hljs-string"><span class="hljs-string">']'</span></span>, <span class="hljs-string"><span class="hljs-string">','</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> parent_id <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> p_node <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ae_json <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_node; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if p_value in ('{', '[', ',') then <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ae_json; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ae_json(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, parent_id) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (l_id, p_node); p_node := l_id; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if p_value = ':' then <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_vl <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ae_json <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_node; if l_vl is null then RAISE_APPLICATION_ERROR(-20001, 'Syntax error'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; else <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_vl <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ae_json <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_node; if l_vl is null then <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> ae_json <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = p_value <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_node; else <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_vl <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ae_json <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_node; if not l_vl is null then RAISE_APPLICATION_ERROR(-20001, 'Syntax error'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> ae_json <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = p_value <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = p_node; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; procedure <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>(p_name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> varchar2) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> l_lob <span class="hljs-keyword"><span class="hljs-keyword">CLOB</span></span>; l_str varchar2(1000) default null; l_len number default null; l_pos number default 1; l_ix number default 1; l_st number default g_spec_state; l_ch varchar2(1) default null; l_val varchar2(1000) default null; l_qt varchar2(1) default null; l_bs number default 0; l_node number default 0; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ae_json(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (l_node); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_lob <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ae_spec <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = p_name <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span>; dbms_lob.open(l_lob, dbms_lob.lob_readonly); l_len := dbms_lob.getlength(l_lob); while l_pos &lt;= l_len loop l_str := dbms_lob.substr(l_lob, 1000, l_pos); l_ix := 1; while l_ix &lt;= length(l_str) loop l_ch := substr(l_str, l_ix, 1); if not l_qt is null then if l_bs = 1 then if not l_ch in (chr(13), chr(10)) then l_val := l_val || l_ch; l_bs := 0; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch = '\' then l_bs := 1; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch = l_qt then lexem(l_st, l_val, l_node); l_st := g_spec_state; l_qt := null; else l_val := l_val || l_ch; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch in ('{', '}', '[', ']', ':', ',', ' ', chr(9), chr(13), chr(10)) then if l_st = g_name_state then lexem(l_st, l_val, l_node); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch in ('{', '}', '[', ']', ':', ',') then lexem(g_spec_state, l_ch, l_node); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; l_st := g_spec_state; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_ch in ('''', '"') then l_val:= null; l_qt := l_ch; l_st := g_name_state; l_bs := 0; goto l; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_st = g_name_state then l_val := l_val || l_ch; else l_val := l_ch; l_st := g_name_state; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; &lt;&lt;l&gt;&gt; l_ix := l_ix + 1; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; l_pos := l_pos + 1000; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>; if l_st = g_name_state then lexem(l_st, l_val, l_node); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; if l_node &lt;&gt; 0 then RAISE_APPLICATION_ERROR(-20001, 'Syntax error'); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; dbms_lob.close(l_lob); exception when others then if dbms_lob.isopen(l_lob) = 1 then dbms_lob.close(l_lob); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; raise; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; procedure compile(p_name in varchar2) as <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>(p_name); <span class="hljs-comment"><span class="hljs-comment">-- </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> commit; exception when others then rollback; raise; end; end ae_spec_pkg; /</span></span></code> </pre><br></div></div><br>  In this implementation, I did not try to catch all the possible syntax errors in JSON data, limiting myself to the detection of errors leading to the unconditional impossibility of data parsing.  In these cases, all changes made in the transaction are rolled back and the corresponding exception is returned. <br><br>  In addition, the developed parser (quite deliberately on my part) permits significant easing in terms of formatting the source data.  For example, it can parse the following description, generally speaking, not being <a href="http://jsonlint.com/">validated</a> as JSON data: <br><br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">tables</span></span>: { AD_ACTIVATION_TYPE: { ID: { attribute: id } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">ACT_DATE</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">attribute</span></span>: start_date , sql: <span class="hljs-string"><span class="hljs-string">"is null"</span></span> } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">ACT_PRIORITY</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">attribute</span></span>: priority } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">TYPE_ID</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">attribute</span></span>: subtype } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">ACT_STATE</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">attribute</span></span>: state , sql: <span class="hljs-string"><span class="hljs-string">"= 1"</span></span> } } } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">attributes</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">id</span></span>: { type: integer , is_mandatory } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">start_date</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">type</span></span>: date } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">priority</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">type</span></span>: integer } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">subtype</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">type</span></span>: integer , is_mandatory } , <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span>: { <span class="hljs-attribute"><span class="hljs-attribute">type</span></span>: integer , is_mandatory } } }</code> </pre><br>  Of course, if necessary, data parsing can be tightened by adding the necessary checks, but I do not see much point in this, since the correct JSON data is disassembled without any problems. <br><br>  That's all.  I would be glad if my post will be useful to someone. <br></div><p>Source: <a href="https://habr.com/ru/post/195496/">https://habr.com/ru/post/195496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195484/index.html">Java Update Coffee Shop in GTA V</a></li>
<li><a href="../195486/index.html">Meet SQL Server 14</a></li>
<li><a href="../195488/index.html">Read this before sending your next business letter.</a></li>
<li><a href="../195490/index.html">15 years of google</a></li>
<li><a href="../195494/index.html">We hunt for memory leaks in Node.js (1st of 12 articles on Node.js from the Mozilla Identity team)</a></li>
<li><a href="../195498/index.html">Nvidia introduced Tegra Note</a></li>
<li><a href="../195500/index.html">In African Hackspace collect 3d printer from the remnants of computers</a></li>
<li><a href="../195502/index.html">How is IT life in Koh Samui (Thailand)</a></li>
<li><a href="../195504/index.html">What unites VDS, Ruby and 1C-Bitrix: Corp. Portal? Jelastic on Infobox</a></li>
<li><a href="../195506/index.html">What is wrong with our EsheDeshe?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>