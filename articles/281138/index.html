<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bad package code for creating Toonz 2D animations</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few days ago it became known that Digital Video, the creators of the TOONZ project, and the Japanese publisher DWANGO signed an agreement on the acq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bad package code for creating Toonz 2D animations</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b3d/ece/34c/b3dece34ceb088220465fe2f1817223a.png" align="left">  A few days ago it became known that Digital Video, the creators of the TOONZ project, and the Japanese publisher DWANGO signed an agreement on the acquisition by DWANGO of the Toonz project, software for creating 2D animation. <br><br>  Under the terms of the agreement signed between the parties, OpenToonz, a project developed by Toonz, will be made publicly available.  It will also include some elements developed by Studio Ghibli, which in turn are active users of these programs.  With their help, for example, Studio Ghibli created the ‚ÄúHowl's Moving Castle‚Äù, ‚ÄúSpirited Away‚Äù, ‚ÄúPonyo Fish‚Äù, as well as many other paintings.  Among them is also the cartoon "Futurama", which inspired me to write this revealing article about the source code of OpenToonz. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  <a href="https://opentoonz.github.io/e/index.html">OpenToonz</a> is a software for creating 2D animations.  The basis is the project "Toonz", which was developed by the Italian company Digital Video.  Adapting this program, Studio Ghibli has been successfully using it for many years.  In addition to animated films, the project was also involved in computer games - Discworld 2 and Claw. <br><br>  It is worth noting that the price of the package has so far been $ 10,000, but the quality of the code leaves much to be desired.  This project is a godsend for any static analyzer.  The size of the OpenToonz source code is approximately 1/10 of the FreeBSD core, in which <a href="http://www.viva64.com/en/b/0377/">more than 40 serious errors</a> were found using the PVS-Studio analyzer, but there are much more of them here! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      OpenToonz was tested in Visual Studio 2013 using the <a href="http://www.viva64.com/en/pvs-studio/">PVS-Studio</a> static analyzer version 6.03, which is actively developed and supports the C / C ++ / C # languages, and various build systems.  Even during the compilation of the project, I became alert when the number of compiler warnings began to grow rapidly.  At the end of the assembly, their number was 1211 pieces!  Those.  control over the quality of the source code almost did not pay attention.  Moreover, some compiler warnings were turned off with the help of the <i>#pragma warning directive</i> , but even there were errors, which I will discuss below.  This article is different in that many very real errors were found in the project, which are usually made by beginners who are just starting to learn C / C ++.  I will begin the description of the detected analyzer warnings with errors of memory usage and pointers. <br><br><h2>  Wrong work with memory </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4e3/f0c/b2c/4e3f0cb2c71e63c73f5f2e75acde9584.png"></div><br><br>  <a href="http://www.viva64.com/en/d/0226/">V611</a> The memory was allocated using the 'new' operator.  Consider inspecting operation logics behind the 'row' variable.  motionblurfx.cpp 288 <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">doDirectionalBlur</span></span></span><span class="hljs-class">(....) {</span></span> T *row, *buffer; .... row = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> T[lx + <span class="hljs-number"><span class="hljs-number">2</span></span> * brad + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (!row) return; memset(row, 0, (lx + 2 * brad + 2) * sizeof(T)); .... free(row); // &lt;= r-&gt;unlock(); }</span></span></code> </pre> <br>  Here, the analyzer found that dynamic memory is allocated and released in incompatible ways.  After calling the operator <i>new [],</i> you must free the memory with the operator <i>delete []</i> .  It is with two square brackets!  I focus on this for a reason - see the following example. <br><br>  <a href="http://www.viva64.com/en/d/0226/">V611</a> The memory was allocated using the 'new T []' operator.  Consider inspecting this code.  It's probably better to use 'delete [] uPrime;'.  tstroke.cpp 3353 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reparameterize3D</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> *uPrime = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>[size]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= for (int i = 0; i &lt; size; i++) { uPrime[i] = NewtonRaphsonRootFind3D(....); if (!_finite(uPrime[i])) { delete uPrime; // &lt;= return 0; } } .... }</span></span></code> </pre> <br>  In C ++, the operators <i>new</i> / <i>delete</i> and <i>new []</i> / <i>delete []</i> are used in tandem with each other.  Using different operators to allocate and free dynamic memory is an error.  In the above code, the memory occupied by the <i>uPrime</i> array will not be correctly released. <br><br>  Unfortunately, this place is not the only one.  Another 20 places I wrote to the file <a href="http://www.viva64.com/external-pictures/OpenToonz_V611.txt">OpenToonz_V611.txt</a> . <br><br>  <a href="http://www.viva64.com/en/d/0145/">V554</a> Incorrect use of auto_ptr.  The memory is allocated with 'new []' will be cleaned using 'delete'.  screensavermaker.cpp 29 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeScreenSaver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">auto_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>&gt; swf(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[swfSize]); .... }</code> </pre> <br>  Before us is an alternative variant of the considered error, but here the <i>delete statement is</i> ‚Äúhidden‚Äù inside the smart pointer <i>std :: auto_ptr</i> .  This also leads to undefined program behavior. <br><br>  To correct the error, you must specify that the operator <i>delete []</i> should be used. <br><br>  The correct code is: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[]&gt; swf(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[swfSize]);</code> </pre><br>  <a href="http://www.viva64.com/en/d/0210/">V599</a> class contains virtual functions.  cellselection.cpp 891 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ insertLevelAndFrameIfNeeded(); TTileSet *tiles; <span class="hljs-comment"><span class="hljs-comment">// &lt;= bool isLevelCreated; pasteRasterImageInCellWithoutUndo(...., &amp;tiles, ....); delete tiles; // &lt;= TApp::instance()-&gt;getCurrentXsheet()-&gt;notifyXsheetChanged(); }</span></span></code> </pre> <br>  Now let's talk about memory leaks and incomplete destruction of objects.  In this example, the objects inherited from the <i>TTileSet</i> class will not be completely destroyed. <br><br>  <i>TTileSet</i> class <i>description</i> : <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DVAPI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TTileSet</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: TDimension m_srcImageSize; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Tile *&gt; Tiles; Tiles m_tiles; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TTileSet(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TDimension &amp;dim) : m_srcImageSize(dim) { } ~TTileSet(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... virtual void add(const TRasterP &amp;ras, TRect rect) = 0; .... virtual TTileSet *clone() const = 0; };</span></span></code> </pre> <br>  The class contains pure virtual functions and is abstract.  You cannot create objects of this class, so it is used only by derived classes.  Thus, due to the lack of a virtual destructor for <i>TTileSet</i> (there is a destructor, but it is not marked as virtual) all derived classes will not be completely cleared. <br><br>  In the source code of OpenToonz, I found several classes that inherit from <i>TTileSet</i> : <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DVAPI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TTileSetCM32</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TTileSet <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DVAPI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TTileSetCM32</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TTileSet <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DVAPI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TTileSetFullColor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TTileSet <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DVAPI</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Tile</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TTileSet::Tile</code> </pre> <br>  Each object of these classes (or classes inherited from them) will not be completely destroyed.  Formally, this will lead to an undefined program behavior;  in practice, this will most likely lead to a leak of memory and other resources. <br><br>  Developers need to check two more similar places: <ul><li>  The virtual destructor is not present, although the class contains virtual functions.  tipcsrv.cpp 91 </li><li>  V599 ColumnToCurveMapper class contains virtual functions.  functionselection.cpp 278 </li></ul><br><h2>  Dangerous use of pointers </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3bb/fd2/a70/3bbfd2a70345c1fd9bf23ef9cd4f4792.png"></div><br><br>  <a href="http://www.viva64.com/en/d/0092/">V503</a> This is a nonsensical comparison: pointer &lt;0. styleselection.cpp 104 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pasteStylesDataWithoutUndo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (palette-&gt;getStylePage(styleId) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= // styleId non e' utilizzato: uso quello // (cut/paste utilizzato per spostare stili) palette-&gt;setStyle(styleId, style); } else { // styleId e' gia' utilizzato. ne devo prendere un altro styleId = palette-&gt;getFirstUnpagedStyle(); if (styleId &gt;= 0) palette-&gt;setStyle(styleId, style); else styleId = palette-&gt;addStyle(style); } .... }</span></span></code> </pre> <br>  The <i>getStylePage ()</i> function returns a pointer to a page: <i>TPalette :: Page *</i> .  Such a comparison with zero does not make sense.  Having made a search for the use of the <i>getStylePage ()</i> function, I found that in all other cases, the result of this function is checked only for equality and inequality to zero, and in this place made a mistake. <br><br>  <a href="http://www.viva64.com/en/d/0111/">V522</a> Dereferencing of the null pointer 'region' might take place.  Check the logical condition.  palettecmd.cpp 102 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isStyleUsed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> TVectorImageP vi, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> styleId)</span></span></span><span class="hljs-function"> </span></span>{ .... TRegion *region = vi-&gt;getRegion(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (region || region-&gt;getStyle() != styleId) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; .... }</code> </pre> <br>  Most likely, the operators '&amp;&amp;' and '||' are confused in this code snippet.  Otherwise, if the <i>region</i> pointer is zero, then its dereference will be executed. <br><br>  <a href="http://www.viva64.com/en/d/0230/">V614</a> Potentially uninitialized pointer 'socket' used.  Consider checking the connect function.  tmsgcore.cpp 36 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TMsgCore::OnNewConnection() <span class="hljs-comment"><span class="hljs-comment">//server side { QTcpSocket *socket; if (m_tcpServer) // &lt;= socket = m_tcpServer-&gt;nextPendingConnection(); // &lt;= assert(socket); bool ret = connect(socket, ....); // &lt;= ret = ret &amp;&amp; connect(socket, ....); // &lt;= assert(ret); m_sockets.insert(socket); }</span></span></code> </pre> <br>  The analyzer has detected a potential use of an uninitialized <i>socket</i> pointer.  If <i>m_tcpServer</i> is false, then the pointer will not be initialized.  In this uninitialized form, it can be passed to the connect () function. <br><br>  <a href="http://www.viva64.com/en/d/0205/">V595</a> The 'batchesTask' pointer was used before it was verified against nullptr.  Check lines: 1064, 1066. batches.cpp 1064 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> BatchesController::update() { .... TFarmTask *batchesTask = getTask(batchesTaskId); <span class="hljs-comment"><span class="hljs-comment">// &lt;= TFarmTask farmTask = *batchesTask; // &lt;= if (batchesTask) { // &lt;= QString batchesTaskParentId = batchesTask-&gt;m_parentId; m_controller-&gt;queryTaskInfo(farmTaskId, farmTask); int chunkSize = batchesTask-&gt;m_chunkSize; *batchesTask = farmTask; batchesTask-&gt;m_chunkSize = chunkSize; batchesTask-&gt;m_id = batchesTaskId; batchesTask-&gt;m_parentId = batchesTaskParentId; } .... }</span></span></code> </pre> <br>  There are many places in the code where potentially null pointer dereferencing can occur.  Usually, a corresponding check is present, but one or several places of using the pointer still remain unsafe.  For example, in this code snippet there is a <i>batchesTask</i> check, but before the check, one pointer dereference will already be performed. <br><br>  Another 29 similar places I wrote in the file <a href="http://www.viva64.com/external-pictures/OpenToonz_V595.txt">OpenToonz_V595.txt</a> . <br><br><h2>  Errors when working with strings </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/553/d47/0e8/553d470e8488fa885e1b2e7ebe43e3f5.png"></div><br><br>  <a href="http://www.viva64.com/en/d/0119/">V530</a> The return value of the 'toUpper' is required to be utilized.  sceneviewerevents.cpp 847 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SceneViewer::keyPressEvent(QKeyEvent *event) { .... QString text = event-&gt;text(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((event-&gt;modifiers() &amp; Qt::ShiftModifier)) text.toUpper(); .... }</code> </pre> <br>  The toUpper () method does not change the string 'text'.  In the documentation, it is described as QString QString :: toUpper () const, i.e.  is a constant method. <br><br>  The correct code is: <br><pre> <code class="cpp hljs">QString text = event-&gt;text(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((event-&gt;modifiers() &amp; Qt::ShiftModifier)) text = text.toUpper();</code> </pre> <br>  There are three more functions in the code whose return value is not used.  All these places require correction: <ul><li>  V530 The return value of the function is required to be utilized.  tfarmserver.cpp 569 </li><li>  V530 The return value of the 'ftell' is required to be utilized.  tiio_bmp.cpp 804 </li><li>  V530 The return value of the function is required.  bendertool.cpp 374 </li></ul><br>  <a href="http://www.viva64.com/en/d/0230/">V614</a> Uninitialized iterator 'it1' used.  fxcommand.cpp 2096 <br><pre> <code class="cpp hljs">QString DeleteLinksUndo::getHistoryString() { .... <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>&lt;TFxP&gt;::const_iterator it1; <span class="hljs-comment"><span class="hljs-comment">// &lt;= std::list&lt;TFx *&gt;::const_iterator ft; for (ft = m_terminalFxs.begin(); ft != ....end(); ++ft) { if (ft != m_terminalFxs.begin()) str += QString(", "); str += QString("%1- -Xsheet") .arg(QString::fromStdWString((*it1)-&gt;getName())); // &lt;= } .... }</span></span></code> </pre> <br>  In operations with strings, the <i>it1</i> uninitialized iterator is used.  Most likely, in one place they forgot to replace it with an iterator <i>ft</i> . <br><br>  <a href="http://www.viva64.com/en/d/0260/">V642</a> Saving the '_wcsicmp' function is the result of the type of the variable is inappropriate.  Breaking the program's logic.  tfilepath.cpp 328 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> TFilePath::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>&lt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> TFilePath &amp;fp) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> differ; differ = _wcsicmp(iName.c_str(), jName.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (differ != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> differ &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... }</code> </pre> <br>  The <i>_wcsicmp</i> function returns the following <i>int</i> values: <ul><li>  &lt;0 - <i>string1</i> less then <i>string2</i> ; </li><li>  0 - <i>string1</i> identical to <i>string2</i> ; </li><li>  &gt; 0 - <i>string1</i> greater than <i>string2</i> . </li></ul><br>  Note.  '&gt; 0' means any numbers, not at all 1. These numbers can be: 2, 3, 100, 256, 1024, 5555, and so on.  The result of the <i>_wcsicmp</i> function may not fit into a char variable, which <i>causes the</i> comparison operator to return an unexpected result. <br><br>  <a href="http://www.viva64.com/en/d/0261/">V643</a> Unusual pointer arithmetic: "\\" + v [i].  The value of the 'char' type is being added to the string pointer.  tstream.cpp 31 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">escape</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { i = v.find_first_of(<span class="hljs-string"><span class="hljs-string">"\\\'\""</span></span>, i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i == (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>::npos) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> h = <span class="hljs-string"><span class="hljs-string">"\\"</span></span> + v[i]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= v.insert(i, "\\"); i = i + 2; } return v; }</span></span></code> </pre> <br>  The analyzer detected an error related to adding a character constant to a string literal.  It was expected that a character would be added to the string, but a numeric value would be added to the pointer to the string, which would lead to the output of the string literal and an unexpected result. <br><br>  To make it clearer, this code is equivalent to: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p1 = <span class="hljs-string"><span class="hljs-string">"\\"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> delta = v[i]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p2 = *p1 + delta; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> h = p2;</code> </pre> <br>  The correct code is: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">string</span></span> h = <span class="hljs-built_in"><span class="hljs-built_in">string</span></span>(<span class="hljs-string"><span class="hljs-string">"\\"</span></span>) + v[i];</code> </pre> <br>  <a href="http://www.viva64.com/en/d/0276/">V655</a> The strings were concatenated but are not utilized.  Consider inspecting the 'alias + "]"' expression.  plasticdeformerfx.cpp 150 <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">string</span></span> PlasticDeformerFx::getAlias(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alias</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(getFxType())</span></span></span></span>; alias += <span class="hljs-string"><span class="hljs-string">"["</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sd) alias += <span class="hljs-string"><span class="hljs-string">", "</span></span>+toString(sd, meshColumnObj-&gt;paramsTime(frame)); alias + <span class="hljs-string"><span class="hljs-string">"]"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= return alias; }</span></span></code> </pre> <br>  The analyzer detected an expression whose result is not used.  Most likely, the operator '+' was accidentally written in this function, instead of '+ ='.  As a result, a square bracket is not added to the <i>alias</i> line at the end, as the programmer planned. <br><br><h2>  Wrong exceptions </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b29/2d2/1b3/b292d21b305fe0a5d56afa81b45c3e9f.png"></div><br><br>  <a href="http://www.viva64.com/en/d/0206/">V596</a> The object was not used.  The 'throw' keyword could be missing: throw domain_error (FOO);  pluginhost.cpp 1486 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Loader::doLoad(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QString &amp;file) { .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = pi-&gt;ini_(host); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> host; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::domain_error(<span class="hljs-string"><span class="hljs-string">"failed initialized: error on ...."</span></span>); } .... }</code> </pre> <br>  The function has accidentally forgotten the <i>throw</i> keyword.  Consequence - this code does not generate an exception in case of an error situation.  Corrected code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::domain_error(<span class="hljs-string"><span class="hljs-string">"failed initialized: error on ...."</span></span>);</code> </pre> <br>  <a href="http://www.viva64.com/en/d/0436/">V746</a> Type slicing.  By reference rather than by value.  iocommand.cpp 1620 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IoCmd::saveLevel(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { sl-&gt;save(fp, TFilePath(), overwritePalette); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TSystemException se) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= QApplication::restoreOverrideCursor(); MsgBox(WARNING, QString::fromStdWString(se.getMessage())); return false; } catch (...) { .... } .... }</span></span></code> </pre> <br>  The analyzer has detected a potential error related to catching an exception by value.  This means that a new <i>se</i> object of type <i>TSystemException</i> will be constructed using the copy constructor.  This will lose some of the exception information that was stored in classes inherited from <i>TSystemException</i> . <br><br>  Similar suspicious locations: <ul><li>  V746 Type slicing.  By reference rather than by value.  iocommand.cpp 2650 </li><li>  V746 Type slicing.  By reference rather than by value.  projectpopup.cpp 522 </li><li>  V746 Type slicing.  By reference rather than by value.  projectpopup.cpp 537 </li><li>  V746 Type slicing.  By reference rather than by value.  projectpopup.cpp 635 </li><li>  V746 Type slicing.  By reference rather than by value.  tlevel_io.cpp 130 </li><li>  V746 Type slicing.  By reference rather than by value.  calligraph.cpp 161 </li><li>  V746 Type slicing.  By reference rather than by value.  calligraph.cpp 165 </li><li>  V746 Type slicing.  By reference rather than by value.  patternmap.cpp 210 </li><li>  V746 Type slicing.  By reference rather than by value.  patternmap.cpp 214 </li><li>  V746 Type slicing.  By reference rather than by value.  patternmap.cpp 218 </li><li>  V746 Type slicing.  By reference rather than by value.  scriptbinding_level.cpp 221 </li></ul><br><h2>  Invalid conditions </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/192/e77/d3e/192e77d3e81f8fa796a68618b0d45445.png"></div><br><br>  <a href="http://www.viva64.com/en/d/0137/">V547</a> Expression '(int) startOutPoints.size ()% 2! = 2' is always true.  rasterselection.cpp 852 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">TStroke </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIntersectedStroke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TStroke &amp;stroke, TRectD bbox)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (t = <span class="hljs-number"><span class="hljs-number">0</span></span>; t &lt; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)outPoints.size(); t++) addPointToVector(...., (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)startOutPoints.size() % <span class="hljs-number"><span class="hljs-number">2</span></span> != <span class="hljs-number"><span class="hljs-number">2</span></span>); .... }</code> </pre> <br>  An interesting mistake.  Most likely, it was planned to determine whether the value of <i>size () is</i> even or odd.  Therefore, the remainder of dividing by 2 should be compared with zero. <br><br>  <a href="http://www.viva64.com/en/d/0091/">V502</a> Perhaps the '?:' Operator was different.  The '?:' Operator has a lower limit than the '+' operator.  igs_motion_wind_pixel.cpp 127 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rgb_to_lightness_</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> re, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> gr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bl, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;li)</span></span></span><span class="hljs-function"> </span></span>{ li=((re &lt; gr) ? ((gr &lt; bl) ? bl : gr) : ((re &lt; bl) ? bl : re) + (gr &lt; re) ? ((bl &lt; gr) ? bl : gr) : ((bl &lt; re) ? bl : re)) / <span class="hljs-number"><span class="hljs-number">2.0</span></span>; }</code> </pre> <br>  In this code snippet, the ':?' Operator made a mistake related to the priority of the ternary.  Its priority is lower than that of the addition operator.  As a result, if the condition <i>(re &lt;gr) is</i> false, then further calculations are performed incorrectly: real variables begin to add up to logical ones. <br><br>  Never use several ternary operators together - this is the shortest way to add an error to the code. <br><br>  <a href="http://www.viva64.com/en/d/0194/">V590</a> Consider inspecting the 'state == (- 3) ||  state! = 0 'expression.  The expression is misprint.  psdutils.cpp 174 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">psdUnzipWithoutPrediction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { state = inflate(&amp;stream, Z_PARTIAL_FLUSH); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == Z_STREAM_END) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == Z_DATA_ERROR || state != Z_OK) <span class="hljs-comment"><span class="hljs-comment">// &lt;= break; } while (stream.avail_out &gt; 0); .... }</span></span></code> </pre> <br>  The condition that is marked with an arrow does not depend on the result of the state == Z_DATA_ERROR subexpression.  This is easy to see if you build a truth table for the entire conditional expression. <br><br><h2>  Copy-paste programming </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/035/567/667/0355676673fd38bd908f7a6fd4f7eabd.png"></div><br><br>  <a href="http://www.viva64.com/en/d/0106/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 1448, 1454. tcenterlineskeletonizer.cpp 1448 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Event::processVertexEvent() { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newLeftNode-&gt;m_concave) { <span class="hljs-comment"><span class="hljs-comment">// &lt;= newLeftNode-&gt;m_notOpposites = m_generator-&gt;m_notOpposites; append&lt;vector&lt;ContourEdge *&gt;, vector&lt;ContourEdge *&gt;::.... newLeftNode-&gt;m_notOpposites.push_back(newRightNode-&gt;m_edge); newLeftNode-&gt;m_notOpposites.push_back(newRightNode-&gt;....); } else if (newLeftNode-&gt;m_concave) { // &lt;= newRightNode-&gt;m_notOpposites = m_generator-&gt;m_notOpposites; append&lt;vector&lt;ContourEdge *&gt;, vector&lt;ContourEdge *&gt;::.... newRightNode-&gt;m_notOpposites.push_back(newLeftNode-&gt;m_edge); newRightNode-&gt;m_notOpposites.push_back(newLeftNode-&gt;....); } .... }</span></span></code> </pre> <br>  Here the variables <i>newLeftNode</i> and <i>newRightNode</i> in the conditions are confused.  As a result of this error, the <i>else</i> branch is never executed.  Most likely, one of the conditions should be like this: <i>if (newRightNode-&gt; m_concave)</i> . <br><br>  <a href="http://www.viva64.com/en/d/0090/">V501</a> There are identical to the left and the right of the | ||  operator: m_cutLx ||  m_cutLx canvassizepopup.cpp 271 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> m_cutLx, m_cutLy; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PeggingWidget::on00() { .... m_11-&gt;setIcon(...).rotate(m_cutLx || m_cutLx ? <span class="hljs-number"><span class="hljs-number">-90</span></span> : <span class="hljs-number"><span class="hljs-number">90</span></span>),....)); .... }</code> </pre> <br>  There are two logical variables in the code: <i>m_cutLx</i> and <i>m_cutLy</i> , which differ by only one last letter.  In the given example, the same <i>m_cutLx</i> variable is <i>used</i> .  Most likely, in one of them made a typo. <br><br>  <a href="http://www.viva64.com/en/d/0090/">V501</a> There are identical sub-expressions "parentTask-&gt; m_status == Aborted"  operator.  tfarmcontroller.cpp 1857 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> FarmController::taskSubmissionError(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parentTask-&gt;m_status == Aborted || <span class="hljs-comment"><span class="hljs-comment">// &lt;= parentTask-&gt;m_status == Aborted) { // &lt;= parentTask-&gt;m_completionDate = task-&gt;m_completionDate; if (parentTask-&gt;m_toBeDeleted) m_tasks.erase(itParent); } .... }</span></span></code> </pre> <br>  The analyzer detected two identical comparisons with the <i>Aborted</i> constant.  Having performed a file search, in line 2028 of this file I found an identical block of code, but with the following condition: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parentTask-&gt;m_status == Completed || parentTask-&gt;m_status == Aborted) {</code> </pre> <br>  Most likely, in this place the conditional expression should be similar. <br><br>  <a href="http://www.viva64.com/en/d/0090/">V501</a> There are identical sub-expressions 'cornerCoords.y&gt; upperBound' to the left of the | ||  operator.  tellipticbrush.cpp 1020 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> tellipticbrush::OutlineBuilder::addMiterSideCaps(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cornerCoords == TConsts::napd || cornerCoords.x &lt; lowerBound || cornerCoords.y &gt; upperBound || cornerCoords.y &lt; lowerBound || cornerCoords.y &gt; upperBound) { .... } .... }</code> </pre> <br>  Here the programmer made a small typo, using <i>y</i> instead of <i>x</i> . <br><br>  Another six mistakes made in the result of <a href="http://www.viva64.com/en/t/0068/">copy-paste programming</a> , I will not describe, but give a list.  These places must be checked by the developers: <ul><li>  V501 There are identical sub-expressions' s.m_repoStatus == "modified" |  operator.  svnupdatedialog.cpp 210 </li><li>  V501 There are identical sub-expressions "m_lineEdit-&gt; hasFocus ()"  operator.  framenavigator.cpp 44 </li><li>  V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 750, 825. tpalette.cpp 750 </li><li>  V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 123, 126. igs_density.cpp 123 </li><li>  V523 The 'then' statement is equivalent to the 'else' statement.  typetool.cpp 813 </li><li>  V583 The '?:' Operator, regardless of its conditional expression, always returns one and the same value: Comma.  tgrammar.cpp 731 </li></ul><br><h2>  Mistakes </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/00f/b6b/5b3/00fb6b5b36133749ca16a6f41b7585cb.png"></div><br><br>  <a href="http://www.viva64.com/en/d/0290/">V665</a> Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 20, 205. tspectrum.h 205 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> WIN32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(disable : 4251) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> .... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> WIN32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(default : 4251) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  This is how the compiler warnings are turned off, which were nevertheless noticed in this project.  The error is that the <i>#pragma warning (default: X)</i> directive does not include a warning, but sets it to the DEFAULT state, which may not be the same as the programmer expects. <br><br>  Corrected code: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> WIN32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(push) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(disable : 4251) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> .... #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> WIN32 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(pop) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  <a href="http://www.viva64.com/en/d/0136/">V546</a> Member of a class is initialized by itself: 'm_subId (m_subId)'.  tfarmcontroller.cpp 572 <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TaskId</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_id; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m_subId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: TaskId(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> subId = <span class="hljs-number"><span class="hljs-number">-1</span></span>) : m_id(id), m_subId(m_subId){};</code> </pre> <br>  An interesting error in the class initialization list.  The <i>m_subld</i> field <i>is</i> initialized by itself, although, most likely, they wanted to write <i>m_subId (subId)</i> . <br><br>  <a href="http://www.viva64.com/en/d/0148/">V557</a> Array overrun is possible.  The '9' index is pointing beyond array bound.  tconvolve.cpp 123 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PIXOUT</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">doConvolve_cm32_row_9_i</span></span></span><span class="hljs-class">(....) {</span></span> TPixel32 val[<span class="hljs-number"><span class="hljs-number">9</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... for (int i = 0; i &lt; 9; ++i) { // &lt;= OK .... else if (tone == 0) val[i] = inks[ink]; else val[i] = blend(....); } pixout-&gt;r = (typename PIXOUT::Channel)(( val[1].r * w1 + val[2].r * w2 + val[3].r * w3 + val[4].r * w4 + val[5].r * w5 + val[6].r * w6 + val[7].r * w7 + val[8].r * w8 + val[9].r * w9 + // &lt;= ERR (1 &lt;&lt; 15)) &gt;&gt; 16); pixout-&gt;g = (typename PIXOUT::Channel)(( val[1].g * w1 + val[2].g * w2 + val[3].g * w3 + val[4].g * w4 + val[5].g * w5 + val[6].g * w6 + val[7].g * w7 + val[8].g * w8 + val[9].g * w9 + // &lt;= ERR (1 &lt;&lt; 15)) &gt;&gt; 16); pixout-&gt;b = (typename PIXOUT::Channel)(( val[1].b * w1 + val[2].b * w2 + val[3].b * w3 + val[4].b * w4 + val[5].b * w5 + val[6].b * w6 + val[7].b * w7 + val[8].b * w8 + val[9].b * w9 + // &lt;= ERR (1 &lt;&lt; 15)) &gt;&gt; 16); pixout-&gt;m = (typename PIXOUT::Channel)(( val[1].m * w1 + val[2].m * w2 + val[3].m * w3 + val[4].m * w4 + val[5].m * w5 + val[6].m * w6 + val[7].m * w7 + val[8].m * w8 + val[9].m * w9 + // &lt;= ERR (1 &lt;&lt; 15)) &gt;&gt; 16); .... }</span></span></code> </pre> <br>  A large piece of code in which someone accesses the <i>val</i> array, consisting of 9 elements, by index from 1 to 9. Although there is a cycle next to it, in which the array is correctly referenced by index from 0 to 8. <br><br>  <a href="http://www.viva64.com/en/d/0147/">V556</a> The values ‚Äã‚Äãof different enum types are compared: m_action! = EDIT_SEGMENT.  Types: Action, CursorType.  controlpointeditortool.cpp 257 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Action { NONE, RECT_SELECTION, CP_MOVEMENT, SEGMENT_MOVEMENT, IN_SPEED_MOVEMENT, OUT_SPEED_MOVEMENT }; <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CursorType { NORMAL, ADD, EDIT_SPEED, EDIT_SEGMENT, NO_ACTIVE }; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ControlPointEditorTool::drawMovingSegment() { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> beforeIndex = m_moveSegmentLimitation.first; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextIndex = m_moveSegmentLimitation.second; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_action != EDIT_SEGMENT || <span class="hljs-comment"><span class="hljs-comment">// &lt;= beforeIndex == -1 || nextIndex == -1 || !m_moveControlPointEditorStroke.getStroke()) return; .... }</span></span></code> </pre> <br>  The analyzer detected a comparison of enum values ‚Äã‚Äãwith different types.  Using a code search, I also discovered that the <i>m_action</i> class <i>field is</i> initialized with the correct type, and in this place is compared with a constant of another type. <br><br><h2>  Conclusion </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8fa/e43/f36/8fae43f363587760980eb15f70ed80c7.png"></div><br><br>  As I already mentioned, the OpenToonz project is a godsend for any static code analyzer: there are a lot of serious errors for such a small project.  The article not only did not include all the messages of the analyzer, it did not even include many interesting and serious warnings due to their large number.  Of course, I will write about the check on the developer forum.  Perhaps they will be interested in improving the quality of the code. <br><br>  The intention to open the code of your software product Universal Scene Description (USD) was announced by Pixar.  I look forward to this event. <br><br>  I suggest everyone to try <a href="http://www.viva64.com/en/pvs-studio/">PVS-Studio</a> on their C / C ++ / C # projects.  The analyzer works in the Windows environment and supports various assembly systems. <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0389/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0389/">Toonz code leaves much to be desired</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/281138/">https://habr.com/ru/post/281138/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281124/index.html">We prepare WebP correctly</a></li>
<li><a href="../281126/index.html">Breaking anatomy: Sony</a></li>
<li><a href="../281132/index.html">Webinar recording available: ‚ÄúWhat's new in Windows Server 2016‚Äù</a></li>
<li><a href="../281134/index.html">How ONLYOFFICE has reconciled two generations of Microsoft formulas</a></li>
<li><a href="../281136/index.html">Omsk! Welcome to the practical StudyJam for Android</a></li>
<li><a href="../281140/index.html">Genetic programming. ELTRUT problem</a></li>
<li><a href="../281142/index.html">Xamarin for everyone! And other announcements on the topic with Build 2016</a></li>
<li><a href="../281144/index.html">Elastix High Availability - a solution for building a cluster of two PBXs</a></li>
<li><a href="../281146/index.html">Really useful app for Digium phones</a></li>
<li><a href="../281148/index.html">From idea to development: what you need to know about creating strategies for trading on the exchange. Part III</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>