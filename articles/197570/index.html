<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>200 line Go balancer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I mentioned that I developed a balancer on Go, although there is an opinion that the front end should be nginx. 

 I have a feeling that in the commen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>200 line Go balancer</h1><div class="post__text post__text-html js-mediator-article">  I <a href="http://habrahabr.ru/post/197468/">mentioned</a> that I developed a balancer on Go, although there is an opinion that the front end should be nginx. <br><br>  I have a feeling that in the comments people happen to fantasize about anything.  Perhaps someone thinks that I am also wrong and there is no balancer on Go.  Therefore, I decided to post the balancer code immediately.  This code was written in a ‚Äúspecial situation‚Äù for 4 hours, and then worked approximately in such a form for 2 weeks without overloading as ‚Äúeveryone‚Äù was in Greece.  The code is not beautiful and even contains errors, but since it worked and balanced, it is already worth something. <br><br>  Under the cut is almost original cursive balancer.  I removed the original constants and the decoding code of the cookies. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-comment"><span class="hljs-comment">// (c) http://habrahabr.ru/users/pyra/ BSD license import ( // "encoding/json" "fmt" // "io" "io/ioutil" "log" "time" "net/http" "net/url" // "os" // "sort" "strconv" "strings" // "time" "errors" ) func main() { //http.HandleFunc("/r", handle_redir) //http.Handle("/extrahtml/", http.FileServer(http.Dir("./extrahtml/"))) http.HandleFunc("/googleXXXXXXXXXXXX.html", handle_google) http.HandleFunc("/", handle_def) https1 := &amp;http.Server{ Addr: ":8443", Handler: nil, ReadTimeout: 20 * time.Second, WriteTimeout: 20 * time.Second, MaxHeaderBytes: 1 &lt;&lt; 15, } go func() { log.Fatal(https1.ListenAndServeTLS("device.crt", "device.key")) }() http1 := &amp;http.Server{ Addr: ":8080", Handler: nil, ReadTimeout: 20 * time.Second, WriteTimeout: 20 * time.Second, MaxHeaderBytes: 1 &lt;&lt; 15, } http1.ListenAndServe() } var reqcntr int var opencntr int func redirectPolicyFunc(req *http.Request, via []*http.Request) error { e := errors.New("redirect") return e } func handle_google(w http.ResponseWriter, r *http.Request) { fmt.Println("google") b, _ := ioutil.ReadFile("googleXXXXXXXXXXXXXXXX.html") fmt.Println(len(b)) w.Write(b) } func handle_def(w http.ResponseWriter, r *http.Request) { //      opencntr++ defer func() { opencntr-- }() client := &amp;http.Client{ CheckRedirect: redirectPolicyFunc, } ip := strings.Split(r.RemoteAddr, ":")[0] //    ( ) reqcntr++ q := r.URL.RawQuery //fmt.Println("def ", r.Method, reqcntr, q) //r.Form, _ = url.ParseQuery(r.URL.RawQuery) //io.WriteString(w, r.URL.Path) path := r.URL.Path // ID     var cid int64 //       breporting := false //      if strings.HasSuffix(path, ".php") { // fmt.Println("breporting = true") breporting = true } //        if path == "/ajax/main.php" { path = "/ajax/main_hide1777.php" } cid = -2 if strings.HasPrefix(path, "/ajax/") || strings.HasPrefix(path, "/im/") { //      ID  m, err := url.ParseQuery(q) if err == nil { id := m.Get("xid") if id == "" { id = m.Get("aid") if id == "" { id = m.Get("cid") if id == "" { id = m.Get("bid") } } } cid, err = strconv.ParseInt(id, 10, 64) if err != nil { cid = -1 } } } else if strings.HasPrefix(path, "/avatar/") { //     /avatar/1234.gif // ID - 1234 cid = -1 pos1 := strings.Index(path[8:], ".") if pos1 != -1 { id := path[6 : pos1+6] var err error cid, err = strconv.ParseInt(id, 10, 64) if err != nil { cid = -1 } } } //     else         //  ID        //host := "test000.cloud" host := "login.yahoo.com" //           if cid &gt; 1000 &amp;&amp; cid &lt; 5000 { host = "prod002.cloud" } else if cid &gt;= 5000 &amp;&amp; cid &lt; 7000 { host = "prod003.cloud" } else if cid &gt;= 7000 &amp;&amp; cid &lt; 15000 { host = "prod005.cloud" } else if cid &gt;= 15000 &amp;&amp; cid &lt; 16000 { host = "prod006.cloud" } else if cid &gt;= 25000 &amp;&amp; cid &lt; 34000 { host = "prod011.cloud" } url := "" //   IP     PHP 5.3 FastCGI     if breporting { url = "https://" + host + path + "?" + q + "&amp;HEHE_IP="+ip+"&amp;HEHE_SECRET=B87BVf5" }else{ url = "https://" + host + path + "?" + q } fmt.Println(url) //   GET  if r.Method == "GET" { req1, err := http.NewRequest("GET", url, nil) if err != nil { fmt.Println("Error1: ", err) //      } req1.Header = r.Header req1.Header.Add("XHEHE_REMOTE_IP", ip) resp, _ := client.Do(req1) StatusCode := resp.StatusCode defer resp.Body.Close() body, err := ioutil.ReadAll(resp.Body) if err != nil { fmt.Println("Error2: ", err) //   )))) //      } fmt.Println("def ", r.Method, reqcntr, opencntr, url, len(body), StatusCode) for k1, v1 := range resp.Header { for _, v2 := range v1 { w.Header().Add(k1, v2) } } w.WriteHeader(StatusCode) w.Write(body) } } // 190   </span></span></code> </pre> <br>  After this code has been rewritten.  It was implemented ideas from my previous pack.  A separate port for the admin, which always works, thanks to controlling how many connections to the server, statistics and reports, the API for updating the routing tables (this allows users to migrate).  And now we are developing delay requests for updating instances or user migrations, as well there is static caching, redirects caching in beta. <br><br>  What is user migration?  The main user profile without photos is ~ 10KB.  Server A serializes the user to a file, the file is compressed, the file is copied to server B, the balancer or balancer says that now requests from this user should be sent to server B. <br><br>  I would be interested to compare Go and nginx.  It is clear that nginx is faster, but if nginx on one core balances 300 or 500 Mbps, and Go is only 50 Mbps, then considering the speed of a typical virtual port on a cloud server for 5 bucks from the same DigitalOcean, I wonder how this is expressed in money?  What if Go can only balance 1 Mbps?  There is no time to compare and write. <br><br>  If someone decides to make a benchmark, it is important to consider not only that the size of the response is different, but also that the request can be processed with a delay.  Therefore, Go is perfect for instantiation simulation.  Instead of http.NewRequest put time.Sleep.  There should be an order of magnitude more than balancers. <br><br>  <b>PS</b> For those who are not familiar with Go.  Go turns this seemingly synchronous code into asynchronous, which can run on one thread or several threads using asynchronous calls.  Just like nginx does.  The compilation results in an executable file that is independent of Go and can be executed on a machine without Go. </div><p>Source: <a href="https://habr.com/ru/post/197570/">https://habr.com/ru/post/197570/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../197554/index.html">Technology rules ... information. Technological pizza</a></li>
<li><a href="../197560/index.html">30 years to the first commercial call on a portable cell phone</a></li>
<li><a href="../197564/index.html">Domestic projects on Kickstarter / part 2</a></li>
<li><a href="../197566/index.html">Localization of Node.js applications Part 1</a></li>
<li><a href="../197568/index.html">Column Viks VS-BT10 as a solution to parent-child music problems</a></li>
<li><a href="../197574/index.html">October 23 - Virtual Conference "All about Windows 8.1" for developers</a></li>
<li><a href="../197578/index.html">Paradoxes of set theory and their philosophical interpretation</a></li>
<li><a href="../197580/index.html">How we work with the iPhone camera in QCamplr</a></li>
<li><a href="../197582/index.html">KiCad and GOST. HBO Library</a></li>
<li><a href="../197584/index.html">Yandex bought Film Search</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>