<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Authorization through Network Policy Server (NPS) for MikroTik</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How to quickly and easily set up authorization via Microsoft RADIUS? I think this will help those who want to be able to access MikroTik devices via a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Authorization through Network Policy Server (NPS) for MikroTik</h1><div class="post__text post__text-html js-mediator-article">  How to quickly and easily set up authorization via Microsoft RADIUS?  I think this will help those who want to be able to access MikroTik devices via a friendly WinBox and simple SSH. <br><br><h4>  Plan: </h4>  <a href="https://habr.com/ru/post/343174/">Installing the NPS role;</a> <br>  <a href="https://habr.com/ru/post/343174/">Add RADIUS client;</a> <br>  <a href="https://habr.com/ru/post/343174/">Creating a connection policy;</a> <br>  <a href="https://habr.com/ru/post/343174/">Creating a network policy;</a> <br>  <a href="https://habr.com/ru/post/343174/">Add authorization server to MikroTik;</a> <br>  <a href="https://habr.com/ru/post/343174/">Check through SSH and WinBox.</a> <br><a name="habracut"></a><br><a name="1"></a><h4>  Installing the NPS Role </h4><br>  We have Windows Server 2016 Datacenter with an already established domain. <br><br><img src="https://habrastorage.org/webt/vu/mz/by/vumzbynlv-yxayxajjj-2ev3aqc.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Select the server on which the role will unfold.  Microsoft does not recommend doing this on a domain controller, but in some best practices, to reduce delays, they give advice to put it on him.  Add the role of the Network Policy and Access Server along with management tools for configuration. <br><br><pre><code class="actionscript hljs">Install-WindowsFeature NPAS -IncludeManagementTools</code> </pre> <br><img src="https://habrastorage.org/webt/ey/fq/sj/eyfqsjpic4zxv1sb_dqxycynmnc.png" alt="image"><br><br><img src="https://habrastorage.org/webt/q7/11/yl/q711ylbhb-zfbgjoxktvxly00ry.png" alt="image"><br><br><img src="https://habrastorage.org/webt/fk/1x/ph/fk1xpheotsy0w6smfl3pqfnsacq.png" alt="image"><br><br><img src="https://habrastorage.org/webt/zg/6g/zz/zg6gzz0fr1gytbkane1nvjpvpks.png" alt="image"><br><br>  Run the NPS admin panel in any convenient way.  For example, through the server manager. <br><br><img src="https://habrastorage.org/webt/cd/n8/pw/cdn8pw_ekrzju3_teh_73s9jris.png" alt="image"><br><br>  Register the NPS server in AD. <br><br><pre> <code class="actionscript hljs">netsh ras add registeredserver</code> </pre> <br><img src="https://habrastorage.org/webt/cy/yu/0e/cyyu0efhs-jy_f0ciso0jq_xyh0.png" alt="image"><br><br><a name="2"></a><h4>  Add RADIUS client </h4>  In order for the server to know which devices to communicate with, you need to add them to RADIUS Clients. <br><br><img src="https://habrastorage.org/webt/21/p4/ev/21p4evypfu4gpwydkfxkb6-ptac.png" alt="image"><br><br>  For example, I add my MikroTik wAP.  Friendly name installed both the Identity on the device and the IP specified on its only wired interface.  In order for the device to authenticate on the server, you must enter the key.  It is created on the server either manually or automatically generated.  I preferred the second option. <br><br><pre> <code class="actionscript hljs">New-NpsRadiusClient ‚ÄìAddress <span class="hljs-string"><span class="hljs-string">"10.1.1.21"</span></span> ‚ÄìName <span class="hljs-string"><span class="hljs-string">"router01"</span></span> ‚ÄìSharedSecret <span class="hljs-string"><span class="hljs-string">"egEcM4myJCptphGlZ1UymS#qLh^urp@fJ1hF8dE6dwb27NI^oIJtTWKKp^MEsU6p"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/kx/wr/xq/kxwrxqmgenj-hqxzs_mr60qtcfg.png" alt="image"><br><br>  Vendor name we will stop on standard RADIUS. <br><br><img src="https://habrastorage.org/webt/gq/wg/mt/gqwgmtfot22xymysjmukruorx6k.png" alt="image"><br><br>  Device added. <br><br><a name="3"></a><h4>  Create Connection Policy </h4><br><img src="https://habrastorage.org/webt/-m/e3/ej/-me3ej6hbsqzkbs0adsvxteoghm.png" alt="image"><br><br>  We select the appropriate name for the policy. <br><br><img src="https://habrastorage.org/webt/91/g9/gv/91g9gvvi5j44qrtme3c2oznjgho.png" alt="image"><br><br>  We define our device with which the server will work. <br><br><img src="https://habrastorage.org/webt/9c/gd/qk/9cgdqktpjuc2yihttxt7bsfrajk.png" alt="image"><br><br>  I selected only the Client Friendly Name with the value Router01.  This clearly binds this policy item to the device through the created client.  You can identify a Mikrotik device by Identity by selecting NAS Identifier. <br><br><img src="https://habrastorage.org/webt/vc/0j/rv/vc0jrvjonmozcykirhmwhbkh_1c.png" alt="image"><br><br>  Without prior configuration of the device Identity = MikroTik. <br><br><img src="https://habrastorage.org/webt/yg/oo/tu/ygootu7mzie_3abd1rfhkvps4du.png" alt="image"><br><br>  Further policy setting. <br><br><img src="https://habrastorage.org/webt/ku/en/6o/kuen6owcoj0m6dcpcsgmgyi_uig.png" alt="image"><br><br>  At the authentication protocol selection stage, it suffices to select an unencrypted (which you will receive a warning about) PAP for SSH or encrypted CHAP for WinBox.  I chose both.  If there is a need to use the web version, then it is enough to enable MS-CHAPv2, otherwise everything is the same. <br><br><img src="https://habrastorage.org/webt/wv/_r/mq/wv_rmqkfqpcy7bw1clsjc4riskg.png" alt="image"><br><br>  Actually, a warning about choosing an unsafe way.  They suggest reading step-by-step reference material. <br><br><img src="https://habrastorage.org/webt/i3/kk/by/i3kkbylmjhypugw_kf9sv0e43jq.png" alt="image"><br><br>  At this stage, I did not touch anything. <br><br><img src="https://habrastorage.org/webt/9y/sc/hi/9yschijgxsm4jglv_ahxc8bxwrk.png" alt="image"><br><br>  Summary policy settings. <br><br>  I could not reproduce it through PowerShell, even the standard example with <a href="https://technet.microsoft.com/en-us/library/cc732464(v%3Dws.10).aspx">technet</a> 'a.  I would be grateful if you tell me why. <br><br><pre> <code class="actionscript hljs">netsh nps add crp name = <span class="hljs-string"><span class="hljs-string">"Request Policy Router01"</span></span> state = <span class="hljs-string"><span class="hljs-string">"ENABLE"</span></span> processingorder = <span class="hljs-string"><span class="hljs-string">"1"</span></span> policysource = <span class="hljs-string"><span class="hljs-string">"0"</span></span> conditionid =<span class="hljs-string"><span class="hljs-string">"0x1020"</span></span> conditiondata = <span class="hljs-string"><span class="hljs-string">"router01"</span></span> profileid = <span class="hljs-string"><span class="hljs-string">"0x1025"</span></span> profiledata = <span class="hljs-string"><span class="hljs-string">"0x1"</span></span> profileid = <span class="hljs-string"><span class="hljs-string">"0x1009"</span></span> profiledata = <span class="hljs-string"><span class="hljs-string">"0x1"</span></span> <span class="hljs-string"><span class="hljs-string">"0x2"</span></span> profileid = <span class="hljs-string"><span class="hljs-string">"0x1fb0"</span></span> profiledata = <span class="hljs-string"><span class="hljs-string">"TRUE"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/lb/uw/b2/lbuwb2lsewqrylkejyxpkv1roca.png" alt="image"><br><br>  Select the desired priority by moving the item above or below the policy. <br><br><a name="4"></a><h4>  Creating network policy </h4><img src="https://habrastorage.org/webt/wf/0i/yv/wf0iyv0lqloingsb30stzdyz9wg.png" alt="image"><br><br>  Let's call it Routers. <br><br><img src="https://habrastorage.org/webt/55/tk/91/55tk917dxjzx5kxuyzwn-e2vtli.png" alt="image"><br><br>  As before, you need to define the conditions. <br><br><img src="https://habrastorage.org/webt/ma/yv/sm/mayvsmzur3v_mgcen3-6d5nsu50.png" alt="image"><br><br>  In AD, I have created an additional user in the Domain Admins group.  I choose the condition of the Windows Group based on the fact that all domain administrators can get access to MikroTik. <br><br><img src="https://habrastorage.org/webt/wc/fb/5z/wcfb5zxrpggeas2frm22htl98c0.png" alt="image"><br><br><img src="https://habrastorage.org/webt/1p/sy/-e/1psy-epxsvx1g0dhnrplhutwuhw.png" alt="image"><br><br>  Permissive or restrictive rule.  We will allow anyone who has fallen under the condition. <br><br><img src="https://habrastorage.org/webt/4d/ok/ho/4dokhogolhbbbbtee8fkjkv7vn0.png" alt="image"><br><br>  The way of authentication is chosen similar to the previous policy. <br><br><img src="https://habrastorage.org/webt/ez/wn/d1/ezwnd1lnqf2kjfdfl2gzdijro1c.png" alt="image"><br><br>  Based on the need, you can configure additional settings.  I left unchanged. <br><br><img src="https://habrastorage.org/webt/33/ml/gm/33mlgmfhnxnbt9uifoo5e_ai-au.png" alt="image"><br><br>  Next, you need to choose what will be sent to the server. <br><br><img src="https://habrastorage.org/webt/n5/st/hc/n5sthcu1yw6vf_my-kkmamwz5pc.png" alt="image"><br><br>  Final network policy settings. <br><br><img src="https://habrastorage.org/webt/j_/li/6g/j_li6gyht7rfu2gkbauxvpfdkji.png" alt="image"><br><br>  We select the necessary priority among other policies, if necessary. <br><br><img src="https://habrastorage.org/webt/qu/te/da/qutedatrugaieamwmbrbo4d8-fy.png" alt="image"><br><br>  In order for an account to be verified via NPS in AD for this user, on the Dial-in tab in the Network Access Permission section, the item Control access through NPS Network Policy should be marked. <br><br><img src="https://habrastorage.org/webt/ee/lf/bk/eelfbkahwmeotpjaai5v0xxw6ga.png" alt="image"><br><br>  To be able to log in through WinBox, you need to enable reversible encryption in the user profile. <br><br><img src="https://habrastorage.org/webt/fx/e6/dc/fxe6dclf6utua1khx4iivoqr19e.png" alt="image"><br><br><a name="5"></a><h4>  Adding an authorization server to MikroTik </h4>  First, assign System / Identity equal to router01 and IP with a mask for the interface. <br><br><pre> <code class="actionscript hljs">/system identity <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> name=router01 /ip address add address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.21</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ether1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">network</span></span></span><span class="hljs-class">=10.1.1.0</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/mi/_m/1e/mi_m1e3cyiox1lsxaaorc6tcpmm.png" alt="image"><br><br>  In System / Users and on the Users tab, we enable the Use RADIUS option.  By default, read-only access is selected. <br><br><pre> <code class="actionscript hljs">/user aaa <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span>-radius=yes</code> </pre> <br><img src="https://habrastorage.org/webt/dd/tu/lt/ddtultu0kwpwlryjfqrb4lxlwrk.png" alt="image"><br><br>  Open the Radius settings and add a new server.  Service is selected on the basis of destination.  Better, of course, to share access between them.  Address - the address of the server on which the NSP is installed. <br><br>  Secret is the key that was generated at the stage of adding a client to the server. <br><br><pre> <code class="actionscript hljs">/radius add address=<span class="hljs-number"><span class="hljs-number">10.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> secret=egEcM4myJCptphGlZ1UymS#qLh^urp@fJ1hF8dE6dwb27NI^oIJtTWKKp^MEsU6p service=login</code> </pre> <br><img src="https://habrastorage.org/webt/l3/29/n9/l329n9f89l9tepmjvppce-dttca.png" alt="image"><br><br><a name="6"></a><h4>  Check through SSH and WinBox </h4>  Verify connectivity via SSH and export configuration. <br><br><img src="https://habrastorage.org/webt/26/ww/lu/26wwlupabapasbuux8otgcpniq4.png" alt="image"><br><br>  And check the authorization in Winbox. <br><br><img src="https://habrastorage.org/webt/g8/6j/vs/g86jvsnaoo5e-dxc_1-khiiqp0g.png" alt="image"><br><br>  As you can see, the system admin and both connections of the domain user with read access via SSH and Winbox are hanging in the active users. <br><br><img src="https://habrastorage.org/webt/y2/ej/q8/y2ejq8vvgpskwtkrvqpbrjxzd9w.png" alt="image"><br><br>  Everything is working. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/343174/">https://habr.com/ru/post/343174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343162/index.html">My company did not take off, 6 lessons at the cost of 4 years of life and $ 150,000</a></li>
<li><a href="../343164/index.html">How cheat traders on cryptocurrency exchanges: the investigation of Business Insider</a></li>
<li><a href="../343166/index.html">NRF51822 in brief: Quick start</a></li>
<li><a href="../343168/index.html">// booby, later</a></li>
<li><a href="../343172/index.html">The effect of dithering in a three-dimensional game</a></li>
<li><a href="../343178/index.html">On fractals, martingales and random integrals. Part one</a></li>
<li><a href="../343180/index.html">Method Lego Serious Play: how to formulate and use the values ‚Äã‚Äãof the team with the help of children's designer</a></li>
<li><a href="../343184/index.html">Facebook Product Development Framework</a></li>
<li><a href="../343186/index.html">Cryptocurrencies and virtual economy</a></li>
<li><a href="../343188/index.html">Machine Learning: Azure Machine Learning Time Series Analysis for Anomaly Search</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>