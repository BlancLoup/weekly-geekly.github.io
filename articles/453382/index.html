<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make customizable caching in the project and save colleagues from writing the same type of code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúIf the essence of the programmer‚Äôs work is in automating the work of other people, then why my work is so little automated,‚Äù I thought, once again co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make customizable caching in the project and save colleagues from writing the same type of code</h1><div class="post__text post__text-html js-mediator-article">  ‚ÄúIf the essence of the programmer‚Äôs work is in automating the work of other people, then why my work is so little automated,‚Äù I thought, once again copying all the binding needed in the project to add a new entity to the database.  And I decided to get rid of this routine of adding template classes, at the same time making a ‚Äúgood‚Äù project, unloading the database from unnecessary read operations. <br><a name="habracut"></a><br>  A small digression about the system we are developing and its state at the time of the start of this experiment: <br><br><ul><li>  A system in which 90% of data is actively changed and processed (transactions, personal data, pre-calculated aggregations), but rarely read, and the remaining 10% rarely change, but are used for reading at every opportunity </li><li>  Almost monolithic service on the .Net Framework, in which all this is implemented </li><li>  Minimal binding Nhibernate, used to access a database and a certain amount of caches based on it (BO-entity changes subscriptions, transactional call processors) </li><li>  A dozen of unspoken rules ‚Äúhow to write code to access a database without killing performance with features of NHibernate‚Äù, regularly captured by Core Review </li><li>  Somewhat dull database in need of optimization </li></ul><br>  While thinking about the situation with the database, the thought arose: whether these 10% of requests are removed from the load on the database (and at the same time they open connections to the database, hold open transactions and template code to access the database through our repositories).  At the same time, it was necessary to take into account: <br><br><ul><li>  We already tried to work with the Nhibernate cache, but found its behavior not always explicit and predictable. </li><li>  I also didn‚Äôt want to change something fundamentally in a platform or infrastructure without good reason </li><li>  The number of _ruoped code, like any rather lazy programmer, should have decreased as a result, writing hundreds of lines of wrappers and subscriptions for existing caches </li></ul><br><div class="spoiler">  <b class="spoiler_title">An example of the implementation of one of these old caches</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Base class for caches, containing rarely changed entities. Updated by subscription to nHibernate session commits. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">Type, used as a base for the cache. Sessions, containing changes to any instance of this class will cause cache refresh.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="K"&gt;</span></span></span><span class="hljs-comment">Key used for cache search.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="V"&gt;</span></span></span><span class="hljs-comment">Value, stored in cache.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public abstract class RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, K, V&gt;</span></span></span><span class="hljs-comment"> : EmptySessionNotificationListener, ITransactionNotificationListener, IRareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment"> where T : class { [NotNull] private static readonly ILog Log = IikoBizLogManager.GetLogger(typeof(RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, K, V&gt;</span></span></span><span class="hljs-comment">)); [NotNull] protected readonly ReaderWriterLockSlim LockObj = new ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion); [NotNull] protected readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment"> Cache = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment">(); [NotNull] protected abstract QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> GetQuery(); [NotNull] private readonly ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;String, bool&gt;</span></span></span><span class="hljs-comment"> changesByTransaction = new ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, bool&gt;</span></span></span><span class="hljs-comment">(); private DateTime lastRefreshTime = DateTime.MinValue; [NotNull] public HibernateSessionManager SessionManager { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Interval of automatic data renewal for cases of read access to cache. Also, cache is forcibly refreshed on any commit, changing base entities of this cache. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public TimeSpan AutoRefreshInterval { get; set; } public void Reset() { lastRefreshTime = DateTime.MinValue; } protected void ReloadCacheIfNeeded(ISession session = null) { if (SystemTime.Now - lastRefreshTime </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;= AutoRefreshInterval) return; LockObj.EnterWriteLock(); try { if (SystemTime.Now - lastRefreshTime &lt;= AutoRefreshInterval) return; IList&lt;object&gt;</span></span></span><span class="hljs-comment"> result; if (session == null) result = SessionManager.CallTransacted(s =&gt; GetQuery().GetExecutableQueryOver(s).List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">()); else //TODO At that moment, the transaction may have been closed, so a new transaction opens implicitly result = GetQuery().GetExecutableQueryOver(session).List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">(); Cache.Clear(); ProcessResult(result); lastRefreshTime = SystemTime.Now; } catch (Exception e) { Log.Error("Exception on cache invalidation: ", e); } finally { LockObj.ExitWriteLock(); } } protected abstract void ProcessResult(IList</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> result); public override void OnSaveOrUpdate(ISession session, object entity, Guid id, object[] currentState, object[] previousState, string[] propertyNames, IType[] types) { if (entity is T) { var transactionName = HibernateSessionManager.GetTransactionName(); if (!string.IsNullOrEmpty(transactionName)) { changesByTransaction.TryAdd(transactionName, true); } } } public override void OnDelete(ISession session, object entity, Guid id) { if (entity is T) { var transactionName = HibernateSessionManager.GetTransactionName(); if (!string.IsNullOrEmpty(transactionName)) { changesByTransaction.TryAdd(transactionName, true); } } } void ITransactionNotificationListener.AfterCommit(ISession session, string transactionName) { bool tmp; if (changesByTransaction.TryRemove(transactionName, out tmp)) Reset(); ReloadCacheIfNeeded(session); } void ITransactionNotificationListener.AfterRollback(ISession session, string transactionName) { } public bool Contains(K key) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return Cache.ContainsKey(key); } finally { LockObj.ExitReadLock(); } } public virtual V TryGet(K key) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return Cache.TryGetValue(key, out var value) ? value : default; } finally { LockObj.ExitReadLock(); } } protected TV GetOrAddEntry</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TK, TV&gt;</span></span></span><span class="hljs-comment">(IDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TK, TV&gt;</span></span></span><span class="hljs-comment"> dictionary, TK key) where TV : new() { TV list; if (!dictionary.TryGetValue(key, out list)) dictionary[key] = (list = new TV()); return list; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Caches all guest categories, grouped by organization or network they belong. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [UsedImplicitly] public sealed class GuestCategoryCache : RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory, Guid, HashSet&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment">&gt; { private static readonly QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment"> SelectAllEntitiesQuery = QueryOver.Of</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment">() .Fetch(gc =&gt; gc.Organization).Eager .Fetch(gc =&gt; gc.Network).Eager; private readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Guid, string&gt;</span></span></span><span class="hljs-comment"> invertedCache = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Guid, string&gt;</span></span></span><span class="hljs-comment">(); public bool TryGetNetworkExternalId(Guid id, out string extId) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return invertedCache.TryGetValue(id, out extId); } finally { LockObj.ExitReadLock(); } } protected override QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment"> GetQuery() { return SelectAllEntitiesQuery; } protected override void ProcessResult(IList</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> result) { invertedCache.Clear(); foreach (GuestCategory gc in result) { var orgOrNetworkId = gc.Organization?.Id ?? gc.Network.Id; GetOrAddEntry(Cache, orgOrNetworkId).Add(gc); } } }</span></span></code> </pre> <br></div></div><br>  At that time, already somewhat tired. <br>  - A new feature should not globally affect other developers, migration to a new approach should occur smoothly and gently. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the same time, I wanted to make it so that adding a new entity to the caching mechanisms took a minimum of effort, the code remained readable and straightforward, and when retrieving data from the cache one could think minimally about what auxiliary code should be written.  The last two points strongly cut off the range of options.  In fact, one must either build something up with reflection and generic classes, or turn to the good old metaprogramming. <br><br>  Since the main development tool is Visual Studio, I didn‚Äôt want to spend a lot of effort on the fact that it‚Äôs not a fact that it would bring an enormous effect - I decided to make a decision on the forehead with the most standard means and only at the stage of the finished Proof Of Concept on a couple of the most frequently used entities - present a decision to colleagues at the court. <br><br>  Next was a moral dilemma.  Whether to use as a source any class hung with attributes for all occasions (in the style of Fluent-mapping Nhibernate on steroids), or write cute neat XML.  Remembering that laziness is the programmer‚Äôs best friend, and class description by attributes is more laborious than writing small XML, he chose the latter. <br><br>  Essentially, what did I need from the entity description? <br><br><ul><li>  Description of cached fields </li><li>  The ability to specify the properties by which we will make selections from this data, if necessary, the possibility to optimize these samples by getting rid of the linear passage through the lists (if you play in the optimization, so in full) </li><li>  Any additional convenience in order to spread classes in different folders and use the existing practices in the code to reduce its number </li></ul><br><div class="spoiler">  <b class="spoiler_title">Got just this xml structure</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"GuestCategory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logicallyDeletable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">revisioned</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">organizationNetworkBased</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">basedOn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BO.GuestCategory"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitBo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">emitMapping</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitRepository</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dependsOn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"guestCategoryCache"</span></span></span><span class="hljs-tag">&gt;</span></span>IGuestCategoryRepository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitRepository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IsActive"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bool"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IsDefaultForNewGuests"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bool"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">notNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  And a big scary T4 template for its parsing and generating unsuitable, but so necessary classes: <br><br><ul><li>  ‚ÄúCacheable‚Äù type with the same fields as BO, but not editable </li><li>  Cache implementation for type with filtering sample methods </li><li>  The cache register for subscribing to the Nhibernate mechanisms for notifications and registration in DI (Spring in our case) </li><li>  Interfaces for all this to hide the guts and the possibility of replacing the generated code with handwritten and back. </li><li>  As a pleasant unplanned bonus initially, if the work with the main entities was already ready - he made another half-step luckily, and added to the side the possibility of generating simple BO-types and mappings to them, to give colleagues the opportunity to add new classes from the half-kick. </li></ul><br>  The template itself, from a logical point of view, consists of two parts: parsing the original xml into classes that describe the desired class structure (to reduce the risk of the formation of any implicit behavior, while it was decided to do it through explicit tag parsing, and not through mapping attributes. <br><br><div class="spoiler">  <b class="spoiler_title">Classes that describe the structure</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> LogicallyDeletable { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> BasedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DalBOType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] Implements { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] Include { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CustomConsistencyManager { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;DalField&gt; Fields { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;DalField&gt; ExplicitlyDefinedFields { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalGetBy[] GetBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalGetBy[] GetAllBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GenerateInterface { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalEmitBo EmitBo { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalEmitRepository EmitRepository { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Implements = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='implements']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; f.InnerText + <span class="hljs-string"><span class="hljs-string">","</span></span>) .ToArray(); Include = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='include']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; f.InnerText) .ToArray(); Name = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); LogicallyDeletable = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"logicallyDeletable"</span></span>); BasedOn = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"basedOn"</span></span>); DalBOType = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"dalBoType"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"dalBoType"</span></span>) : BasedOn; CustomConsistencyManager = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"customConsistencyManager"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"customConsistencyManager"</span></span>) == <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Fields = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='field']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalField(f)) .ToList(); ExplicitlyDefinedFields = Fields.ToList(); Fields = Fields.OrderBy(f=&gt;f.Name).ToList(); GetBy = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='getBy']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalGetBy(f)) .ToArray(); GetAllBy = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='getAllBy']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalGetBy(f)) .ToArray(); EmitBo = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='emitBo']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalEmitBo(f)) .SingleOrDefault(); EmitRepository = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='emitRepository']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalEmitRepository(f, Name)) .SingleOrDefault(); GenerateInterface = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetIncludedNamespaces</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"/n"</span></span>, Include.Select(i =&gt; <span class="hljs-string"><span class="hljs-string">"using "</span></span> + i + <span class="hljs-string"><span class="hljs-string">";"</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBoClassDefinition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Name + <span class="hljs-string"><span class="hljs-string">" :\n\t\tBaseEntity,\n\t\t"</span></span> + (LogicallyDeletable ? <span class="hljs-string"><span class="hljs-string">"ILogicallyDeletable,\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + (Implements.Any() ? <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span>, Implements) + <span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"I"</span></span> + Name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCachedClassDefinition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Cached"</span></span> + Name + <span class="hljs-string"><span class="hljs-string">" :\n\t\t"</span></span> + (LogicallyDeletable ? <span class="hljs-string"><span class="hljs-string">"Deletable"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"CachedEntity&lt;"</span></span> + BasedOn + <span class="hljs-string"><span class="hljs-string">"&gt;,\n\t\t"</span></span> + (Implements.Any() ? <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span>, Implements) + <span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"I"</span></span> + Name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetIsDeletedParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LogicallyDeletable) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">",bool getDeleted"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetIsDeletedFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LogicallyDeletable) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">@" if (!getDeleted) entities = entities.Where(e =&gt; !e.IsDeleted); "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFilterParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DalGetBy getBy</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;FieldDescription&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> getBy.Filters) filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldDescription { TypeName = Fields.Single(f =&gt; f.Name == filter.Key).FieldType, Alias = filter.Value }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">", "</span></span>, filters.Select(f =&gt; f.TypeName + <span class="hljs-string"><span class="hljs-string">" "</span></span> + f.Alias)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> FieldDescription { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TypeName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Alias; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalField</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FieldType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Source { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PropertySource { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> NotNull { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span> { Name = name; FieldType = type; Source = name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Name = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); FieldType = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>); Source = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"source"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"source"</span></span>) : sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); PropertySource = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"propertySource"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"propertySource"</span></span>) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NotNull = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"notNull"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"notNull"</span></span>) == <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConstructorInitValueExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldRealType = FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PropertySource!=<span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; fieldRealType.StartsWith(<span class="hljs-string"><span class="hljs-string">"I"</span></span>)) fieldRealType = <span class="hljs-string"><span class="hljs-string">"Cached"</span></span> + fieldRealType.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" = source."</span></span> + Source + (fieldIsArray ? <span class="hljs-string"><span class="hljs-string">".Select(i=&gt;new "</span></span> + fieldRealType + <span class="hljs-string"><span class="hljs-string">"(i)).ToArray()"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">";"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"public "</span></span> + GetType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + (PropertySource != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span> + PropertySource + <span class="hljs-string"><span class="hljs-string">";"</span></span> : <span class="hljs-string"><span class="hljs-string">" { get; private set; }"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBOPropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"public virtual "</span></span> + GetBoType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" { get; set; }"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInterfacePropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetNullAttribute() + GetType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" { get; }"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldIsArray) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"IEnumerable&lt;"</span></span> + FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FieldType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBoType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldIsArray) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"IList&lt;"</span></span> + FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FieldType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNullAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; TypeCanBeNull() ? NotNull ? <span class="hljs-string"><span class="hljs-string">"[NotNull] "</span></span> : <span class="hljs-string"><span class="hljs-string">"[CanBeNull] "</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] NotNullTypes = { <span class="hljs-string"><span class="hljs-string">"Guid"</span></span>, <span class="hljs-string"><span class="hljs-string">"DateTime"</span></span>, <span class="hljs-string"><span class="hljs-string">"DateTimeOffset"</span></span>, <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-string"><span class="hljs-string">"int"</span></span>, <span class="hljs-string"><span class="hljs-string">"long"</span></span>, <span class="hljs-string"><span class="hljs-string">"short"</span></span>, <span class="hljs-string"><span class="hljs-string">"ProgramType"</span></span>, <span class="hljs-string"><span class="hljs-string">"GuestSubscriptionTypes"</span></span>, <span class="hljs-string"><span class="hljs-string">"SenderType"</span></span>, <span class="hljs-string"><span class="hljs-string">"ApiClientType"</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TypeCanBeNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; !NotNullTypes.Contains(FieldType); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpperInitial</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name[<span class="hljs-number"><span class="hljs-number">0</span></span>].ToString().ToUpperInvariant() + name.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalGetBy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsTry { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Alias { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Filters { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalGetBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { IsTry = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"try"</span></span>); Alias = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"alias"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (XmlElement filterNode <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='field']"</span></span>)) Filters.Add(filterNode.GetAttribute(<span class="hljs-string"><span class="hljs-string">"field"</span></span>), filterNode.GetAttribute(<span class="hljs-string"><span class="hljs-string">"alias"</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConditions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">" &amp;&amp; "</span></span>, Filters.Select(f =&gt; <span class="hljs-string"><span class="hljs-string">$"e.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Key}</span></span></span><span class="hljs-string"> == </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Value}</span></span></span><span class="hljs-string">"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">" &amp;&amp; "</span></span>, Filters.Select(f =&gt; <span class="hljs-string"><span class="hljs-string">$"e.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Key}</span></span></span><span class="hljs-string"> == </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Value}</span></span></span><span class="hljs-string">"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalEmitBo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Namespace { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EmitMapping { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> XmlElement sourceXml; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalEmitBo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Namespace = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"ns"</span></span>); EmitMapping = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"emitMapping"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sourceXml = sourceXml; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMapping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DalField field</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> notNull = !field.TypeCanBeNull() || field.NotNull; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> overridenXml = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='column']"</span></span>).Cast&lt;XmlElement&gt;().SingleOrDefault(e =&gt; e.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) == field.Name); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = overridenXml != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OverridenProperties(overridenXml) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(field.FieldType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"string"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(notNull ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"not-null=\"true\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(props?.SqlType !=</span></span><span class="hljs-literal"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-literal">null</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"sql-type=\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> + props.SqlType+</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string">/&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\" type=\"boolean\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\" default=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{props?.DefaultValue??</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">\" sql-type=\"bit\" /&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"DateTime"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\"/&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"DateTime?"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" /&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"ProgramType"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" default=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{props?.DefaultValue??</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">\" </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(notNull ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"not-null=\"true\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string">/&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"Guid?"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" /&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">$"Not supported type </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.FieldType}</span></span></span><span class="hljs-string">. Edit DAL.tt to add mapping definition."</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OverridenProperties</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DefaultValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SqlType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OverridenProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { DefaultValue = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"default"</span></span>); SqlType = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"sql-type"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalEmitRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Interface { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DependsOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalEmitRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> className</span></span></span><span class="hljs-function">)</span></span> { Interface = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(sourceXml.InnerText) ? <span class="hljs-string"><span class="hljs-string">"IRepository&lt;"</span></span>+className+<span class="hljs-string"><span class="hljs-string">"&gt;"</span></span> : sourceXml.InnerText; DependsOn = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"dependsOn"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRepositoryClassName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; Interface.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">The code of the resulting pattern</b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta">#@ template debug="false" hostspecific="true" language="C#" #&gt; &lt;#@ assembly name="System.Xml" #&gt; &lt;#@ assembly name="System.Core" #&gt; &lt;#@ assembly name="EnvDTE" #&gt; &lt;#@ import namespace="System.Xml" #&gt; &lt;#@ import namespace="System.Collections.Generic" #&gt; &lt;#@ import namespace="System.IO" #&gt; &lt;#@ import namespace="System.Linq" #&gt; &lt;#@ output extension="/" #&gt; &lt;# EnvDTE.DTE dte = (EnvDTE.DTE) ((IServiceProvider) this.Host) .GetService(typeof(EnvDTE.DTE)); XmlDocument doc = new XmlDocument(); doc.Load(System.IO.Path.Combine(dte.ActiveDocument.Path, "DAL.xml")); var classes = doc.SelectNodes("//*[local-name()='class']").Cast&lt;XmlElement&gt;().Select(classXml=&gt;new DalClass(classXml)).ToArray(); //fields foreach(var classNode in classes) { #&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using System.Collections.Generic; using System.Linq; using System.Runtime.Serialization; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace Domain.DALV2 { public class &lt;#=classNode.GetCachedClassDefinition()#&gt; { public Cached&lt;#=classNode.Name#&gt;(&lt;#=classNode.DalBOType#&gt; source) : base(source) { &lt;#=string.Join("\n\t\t\t", classNode.Fields.Where(f =&gt; f.PropertySource == null).Select(f=&gt;f.GetConstructorInitValueExpression()))#&gt; } &lt;#=string.Join("\n\n\t\t", classNode.Fields.Select(f=&gt;f.GetPropertyDefinitionExpression()))#&gt; } } &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.GenerateInterface){#&gt; namespace Domain.DAL { public interface I&lt;#=classNode.Name#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; :ILogicallyDeletableReadonly &lt;#}#&gt; { Guid Id { get; } &lt;#=string.Join("\n\n\t\t", classNode.Fields.Select(f=&gt;f.GetInterfacePropertyDefinitionExpression()))#&gt; } } &lt;#SaveOutput("Entities//gen//"+classNode.Name+".g.cs");#&gt; &lt;#}#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using System.Collections.Generic; using System.Linq; using System.Runtime.Serialization; using Resto.Framework.Common; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace Domain.DALV2 { public partial class &lt;#=classNode.Name#&gt;DAL : DAL&lt;Cached&lt;#=classNode.Name#&gt;, &lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt; { internal &lt;#=classNode.Name#&gt;DAL(ISessionManager sessionManager, ICacheConsistencyManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt; consistencyManager) : base(sessionManager, Repositories.&lt;#=classNode.Name#&gt;, consistencyManager) { } &lt;#foreach (var getBy in classNode.GetBy){#&gt; &lt;#=getBy.IsTry?"[CanBeNull]":"[NotNull]"#&gt; public Cached&lt;#=classNode.Name#&gt; &lt;#=getBy.IsTry?"Try":""#&gt;GetBy&lt;#=getBy.Alias#&gt;(&lt;#=classNode.GetFilterParameters(getBy)#&gt;) { UpdateCacheIfNeeded(); using (ConsistencyManager.GetReadLock()) { return Cache.Values.Single&lt;#=getBy.IsTry?"OrDefault":""#&gt;(e =&gt; &lt;#=getBy.GetConditions()#&gt;); } } &lt;#}#&gt; &lt;#foreach (var fieldNode in classNode.GetAllBy){#&gt; [NotNull] [ItemNotNull] public IList&lt;Cached&lt;#=classNode.Name#&gt;&gt; GetAllBy&lt;#=fieldNode.Alias#&gt;(&lt;#=classNode.GetFilterParameters(fieldNode)#&gt;) { UpdateCacheIfNeeded(); using (ConsistencyManager.GetReadLock()) { return Cache.Values.Where(e =&gt; &lt;#=fieldNode.GetConditions()#&gt;).ToList(); } } &lt;#}#&gt; [NotNull] protected override Cached&lt;#=classNode.Name#&gt; Convert(&lt;#=classNode.DalBOType#&gt; source) { return new Cached&lt;#=classNode.Name#&gt;(source); } } } &lt;#SaveOutput("Repositories//gen//"+ classNode.Name+".g.cs");#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(classNode.EmitBo != null){#&gt; &lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" assembly="Domain" namespace="&lt;#=classNode.EmitBo.Namespace#&gt;"&gt; &lt;class name="&lt;#=classNode.Name#&gt;" dynamic-update="true" dynamic-insert="true"&gt; &lt;id name="Id"&gt; &lt;generator class="assigned" /&gt; &lt;/id&gt; &lt;#=string.Join("\n\t\t", classNode.ExplicitlyDefinedFields.Select(f=&gt;classNode.EmitBo.GetMapping(f)))#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; &lt;property name="IsDeleted" not-null="true" type="boolean"&gt; &lt;column name="IsDeleted" not-null="true" default="0" /&gt; &lt;/property&gt; &lt;property name="WhenDeleted" type="DateTime" not-null="false"/&gt; &lt;#}#&gt; &lt;/class&gt; &lt;/hibernate-mapping&gt; &lt;#SaveOutput("..\\..\\DAL.Hibernate\\Mapping\\gen\\"+classNode.Name+".hbm.xml");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using Common.Domain.BO.DB; using Domain.DAL; using Domain.DALV2; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace &lt;#=classNode.EmitBo.Namespace#&gt; { public partial class &lt;#=classNode.GetBoClassDefinition()#&gt; { [UsedImplicitly] protected &lt;#=classNode.Name#&gt;(){} &lt;#=string.Join("\n\n\t\t", classNode.ExplicitlyDefinedFields.Select(f=&gt;f.GetBOPropertyDefinitionExpression()))#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; public virtual bool IsDeleted { get; set; } public virtual DateTime? WhenDeleted { get; set; } &lt;#}#&gt; } } &lt;# SaveOutput("..//BO//gen//"+ classNode.Name+".g.cs"); } } #&gt; &lt;!-- The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. --&gt; &lt;objects xmlns="http://www.springframework.net" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:db="http://www.springframework.net/database" xsi:schemaLocation="http://www.springframework.net http://www.springframework.net/xsd/spring-objects.xsd"&gt; &lt;# foreach(var classNode in classes.Where(c =&gt; !c.CustomConsistencyManager)) { #&gt; &lt;object id="&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager" type="Domain.DALV2.TransactionSubscribedManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt;, Domain" singleton="true"&gt; &lt;/object&gt; &lt;#}#&gt; &lt;object id="dalGeneratedListeners" type="System.Collections.Generic.List&lt;Common.Hibernate.DAL.ISessionNotificationListener&gt;, mscorlib"&gt; &lt;constructor-arg&gt; &lt;list element-type="Common.Hibernate.DAL.ISessionNotificationListener, Common.Hibernate"&gt; &lt;# foreach(var classNode in classes) { #&gt; &lt;ref object="&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager"/&gt; &lt;#}#&gt; &lt;/list&gt; &lt;/constructor-arg&gt; &lt;/object&gt; &lt;/objects&gt; &lt;#SaveOutput("..//Config//DALSpringDefinitions.g.xml");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using Common; using Common.Domain.DAL; using Domain.BO; using Domain.DALV2; using Spring.Context.Support; using JetBrains.Annotations; &lt;#=string.Join("\n", classes.Select(c=&gt;c.GetIncludedNamespaces()).Where(s=&gt;!string.IsNullOrEmpty(s)))#&gt; namespace Domain.DAL { public partial class DALs { private static readonly SafeLazy&lt;DALs&gt; instance = new SafeLazy&lt;DALs&gt;(() =&gt; new DALs()); private DALs() { var sessionManager = (ISessionManager)ContextRegistry.GetContext().GetObject("sessionManager"); &lt;# foreach(var classNode in classes){ #&gt; this.&lt;#=LowerInitial(classNode.Name)#&gt; = new &lt;#=classNode.Name#&gt;DAL(sessionManager, (ICacheConsistencyManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt;)ContextRegistry.GetContext().GetObject("&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager")); &lt;# } #&gt; } &lt;# foreach(var classNode in classes) { #&gt; [NotNull] private readonly &lt;#=classNode.Name#&gt;DAL &lt;#=LowerInitial(classNode.Name)#&gt;; [NotNull] public static &lt;#=classNode.Name#&gt;DAL &lt;#=classNode.Name#&gt; =&gt; instance.Value.&lt;#=LowerInitial(classNode.Name)#&gt;; &lt;#}#&gt; public static void ResetAll() =&gt; instance.Value.ResetAllImpl(); private void ResetAllImpl() { &lt;#foreach(var classNode in classes){#&gt; this.&lt;#=LowerInitial(classNode.Name)#&gt;.Reset(); &lt;#}#&gt; } } } &lt;#SaveOutput("DALs.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using JetBrains.Annotations; namespace Domain.DAL { public partial interface IRepositoryFactory { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; { get; } &lt;#}#&gt; } } &lt;#SaveOutput("IRepositoryFactory.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using JetBrains.Annotations; namespace Domain.DAL { public static partial class Repositories { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] public static &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; =&gt; Instance.Value.&lt;#=classNode.Name#&gt;; &lt;#}#&gt; } } &lt;#SaveOutput("Repositories.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using Common.Domain.DAL; using Common.Hibernate.DAL; using DAL.Hibernate.Cache.CachingProviders; using Domain.BO; using Domain.DAL; using Domain.DAL.Cache; using Domain.SaveManager; using System; using System.Collections.Generic; using JetBrains.Annotations; using Engine.Main; &lt;#=string.Join("\n", classes.Select(c=&gt;c.GetIncludedNamespaces()).Where(s=&gt;!string.IsNullOrEmpty(s)))#&gt; namespace DAL.Hibernate.DAL { public partial class RepositoryFactory : IRepositoryFactory { public void Init([NotNull] IOrganizationsByNetworkCache organizationsByNetworkCache, [NotNull] INetworkCache networkCache, [NotNull] ITransactionSaveManager transactionSaveManager, [NotNull] ILoginEntryDataProvider loginEntryDataProvider, ListenerNotifier listenerNotifier) { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; this.&lt;#=classNode.Name#&gt; = new &lt;#=classNode.EmitRepository.GetRepositoryClassName()#&gt;(&lt;#=classNode.EmitRepository.DependsOn#&gt;); &lt;#}#&gt; } &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] public &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; { get; private set; } &lt;#}#&gt; } } &lt;#SaveOutput("..\\..\\DAL.Hibernate\\DAL\\RepositoryFactory.g.cs");#&gt; &lt;#+ private string LowerInitial(string name) { return name[0].ToString().ToLowerInvariant() + name.Substring(1); } private string UpperInitial(string name) { return name[0].ToString().ToUpperInvariant() + name.Substring(1); } void SaveOutput(string outputFileName) { string templateDirectory = Path.GetDirectoryName(Host.TemplateFile); string outputFilePath = Path.Combine(templateDirectory, outputFileName); File.WriteAllText(outputFilePath, this.GenerationEnvironment.ToString()); this.GenerationEnvironment.Remove(0, this.GenerationEnvironment.Length); } #&gt;</span></span></code> </pre> <br></div></div><br>  And where without some tricky Generic-code, to subscribe to make changes to the database, update on-demand caches, and other pleasures of life.  Here generic turned out to be quite enough to close all usage scenarios, coupled with those already used with <br><br><div class="spoiler">  <b class="spoiler_title">General code for data access</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DAL</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>, <span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">CachedEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ILog log; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ISessionManager SessionManager; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IReadonlyRepository&lt;TBase&gt; BaseRepository; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICacheConsistencyManager&lt;TBase, TCachedBo&gt; ConsistencyManager; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Dictionary&lt;Guid, T&gt; Cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Guid, T&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DAL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISessionManager sessionManager, [NotNull] IReadonlyRepository&lt;TBase&gt; baseRepository, [NotNull] ICacheConsistencyManager&lt;TBase, TCachedBo&gt; consistencyManager</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SessionManager = sessionManager; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BaseRepository = baseRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ConsistencyManager = consistencyManager; log = LogManager.GetLogger(GetType()); } [CanBeNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Cache.GetOrDefault(id); } } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ValidateEntityFound(Cache.GetOrDefault(id), <span class="hljs-string"><span class="hljs-string">"{0} with id {1} not found"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T), id); } } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TBase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISession session, Guid id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseRepository.GetById(session, id); } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TBase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISession session, [NotNull] T e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseRepository.GetById(session, e.Id); } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HashSet&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByIds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] HashSet&lt;Guid&gt; ids</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ids .Select(id =&gt; Cache.GetOrDefault(id)) .ToHashSet(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ConsistencyManager.Reset(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Convert</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TCachedBo source</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateCacheIfNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ConsistencyManager.UpdateRequired) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; log.Debug(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-string"><span class="hljs-subst">(T).Name}</span></span></span><span class="hljs-string"> DAL: Update required, getting writeLock"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateScope = ConsistencyManager.GetWriteLock()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updateScope.UpdateRequired ?? ConsistencyManager.UpdateRequired) SessionManager.RunTransacted(session =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatedEntities = updateScope.GetUpdatedEntities(BaseRepository, session); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatedEntity <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> updatedEntities) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updatedEntity.Value != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Cache[updatedEntity.Key] = Convert(updatedEntity.Value); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Cache.Remove(updatedEntity.Key); Reindex(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ConsistencyManager.Reset(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }); } } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Reevaluate specific indexes, used for search in cached entities. Called after cache has been updated. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> protected virtual void Reindex() { } [NotNull] protected T1 ValidateEntityFound</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T1&gt;</span></span></span><span class="hljs-comment">([CanBeNull] T1 entity, [NotNull] string errorMessage, [NotNull] string frontMessage, [NotNull] params object[] p) { if (entity == null) throw new DataAccessException(Util.GetMessage(errorMessage, p), Util.GetMessage(frontMessage, p)); return entity; } }</span></span></code> </pre> <br><br></div></div><br>  Interesting, in my opinion, was the class that monitors the consistency of the cache and manages its update, the main place where I had to think about the implementation of locks so that everything was optimal and minimally blocking, but at the same time protected <br><br><div class="spoiler">  <b class="spoiler_title">Actually implementation</b> <div class="spoiler_text"><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">UsedImplicitly</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TransactionSubscribedManager</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">EmptySessionNotificationListener</span></span>, <span class="hljs-title"><span class="hljs-title">ICacheConsistencyManager</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">ITransactionNotificationListener</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> UpdateRequired =&gt; needFullUpdate || !entitiesToUpdate.IsEmpty; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim LockObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion); [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConcurrentBag&lt;Guid&gt;&gt; changesByTransaction = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConcurrentBag&lt;Guid&gt;&gt;(); [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ConcurrentBag&lt;Guid&gt; entitiesToUpdate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> needFullUpdate = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> CacheWriteLockScope&lt;TBase, TCachedBo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWriteLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LockObj.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needFullUpdate) { needFullUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CacheWriteLockScope&lt;TBase, TCachedBo&gt;(LockObj); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdBasedCacheWriteLockScope&lt;TBase, TCachedBo&gt;(LockObj, ChangedEntitiesIdsProvider); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { LockObj.ExitWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ICollection&lt;Guid&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangedEntitiesIdsProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ids = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newBag = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldBag = Interlocked.Exchange(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> entitiesToUpdate, newBag); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (oldBag.TryTake(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id)) ids.Add(id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ids; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheReadLockScope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetReadLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CacheReadLockScope(LockObj); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSaveOrUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ISession session, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entity, Guid id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] currentState, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] previousState, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] propertyNames, IType[] types</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TBase) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionName = HibernateSessionManager.GetTransactionName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(transactionName)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changesByTransaction.TryAdd(transactionName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;() { id })) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; changesByTransaction.TryGetValue(transactionName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionChangedEntities); <span class="hljs-comment"><span class="hljs-comment">// ReSharper disable once PossibleNullReferenceException // R# does not have attributes telling that value in dictionary is not null. But we know it. transactionChangedEntities.Add(id); } } } public override void OnDelete(ISession session, object entity, Guid id) { if (entity is TBase) { var transactionName = HibernateSessionManager.GetTransactionName(); if (string.IsNullOrEmpty(transactionName)) return; if (changesByTransaction.TryAdd(transactionName, new ConcurrentBag&lt;Guid&gt;() { id })) return; changesByTransaction.TryGetValue(transactionName, out var transactionChangedEntities); // ReSharper disable once PossibleNullReferenceException // R# does not have attributes telling that value in dictionary is not null. But we know it. transactionChangedEntities.Add(id); } } public void Reset() { needFullUpdate = true; } void ITransactionNotificationListener.AfterCommit(ISession session, string transactionName) { if (changesByTransaction.TryRemove(transactionName, out var transactionChangedEntities) &amp;&amp; !transactionChangedEntities.IsEmpty) while (transactionChangedEntities.TryTake(out var id)) entitiesToUpdate.Add(id); } void ITransactionNotificationListener.AfterRollback(ISession session, string transactionName) { changesByTransaction.TryRemove(transactionName, out _); } }</span></span></code> </pre> <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">IdBasedCacheWriteLockScope</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">CacheWriteLockScope</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICollection&lt;Guid&gt; changedEntitiesIds; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>? UpdateRequired =&gt; changedEntitiesIds.Any(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IdBasedCacheWriteLockScope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ReaderWriterLockSlim lockObj, [NotNull] Func&lt;ICollection&lt;Guid&gt;&gt; changedEntitiesIdsProvider</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lockObj</span></span></span><span class="hljs-function">)</span></span> { changedEntitiesIds = changedEntitiesIdsProvider() ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(changedEntitiesIdsProvider)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IDictionary&lt;Guid, TCachedBo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUpdatedEntities</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReadonlyRepository&lt;TBase&gt; repository, ISession session</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entities = repository.GetByIds(session, changedEntitiesIds, <span class="hljs-literal"><span class="hljs-literal">true</span></span>).ToDictionary(e =&gt; e.Id, be =&gt; be <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCachedBo); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> changedEntitiesIds.Where(i =&gt; !entities.ContainsKey(i))) entities.Add(id, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entities; } }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interesting shoals that came to light in the process of developing and rolling on the battle: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It‚Äôs just not possible to pull out and cache related entities with direct links between them. </font><font style="vertical-align: inherit;">Otherwise, when we change one of the entities, the outdated copy remains in the objects that reference it. </font><font style="vertical-align: inherit;">Instead of doing the cunning logic of the invalidation of such connections, they decided to simply retrieve the latest information from the cache when accessing by property.</font></font></li><li>   ,              ,         (       ,   ,            , ).     ,              </li><li>     ¬´¬ª   (         )   ,         ,          </li></ul></div><p>Source: <a href="https://habr.com/ru/post/453382/">https://habr.com/ru/post/453382/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453366/index.html">How to use commas in English: 15 rules and examples of errors</a></li>
<li><a href="../453368/index.html">Recover data from XtraDB tables without a structure file, using byte analysis of the ibd file</a></li>
<li><a href="../45337/index.html">Quicky template review: Performance and Flexibility</a></li>
<li><a href="../453370/index.html">Opposition 2019: Jet Security Team ranked first in defense</a></li>
<li><a href="../453380/index.html">World War with private cars: MaaS strides across the planet</a></li>
<li><a href="../453384/index.html">Security Cheat Sheets: REST</a></li>
<li><a href="../453388/index.html">How to get a ride on OFFZONE 2019 and an offer in one day</a></li>
<li><a href="../453390/index.html">About axes and cabbage</a></li>
<li><a href="../453392/index.html">News of the week: US war with Huawei, launch of Internet satellites into orbit, Russian electric car</a></li>
<li><a href="../453394/index.html">Star card or how to balance knowledge in a team when affected by Soft Skills</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>