<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Translation: how gitLab uses unicorn and unicorn-worker-killer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I bring to your attention a translation of a small article in which GitLab engineers tell how their application works on Unicorn and what they do with...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Translation: how gitLab uses unicorn and unicorn-worker-killer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5e8/afa/b1f/5e8afab1f6d649539c9ac8bb448e3063.jpg" align="left">  I bring to your attention a translation of a small article in which GitLab engineers tell how their application works on Unicorn and what they do with the memory that flows.  This article can be viewed as a simplified version of an article already <a href="http://habrahabr.ru/post/206840/">translated</a> by another author. <br><a name="habracut"></a><br><h1>  <b>Unicorn</b> </h1><br>  To handle HTTP requests from git and users, GitLab uses a <a href="http://unicorn.bogomips.org/">Unicorn</a> , Ruby server with <a href="https://en.wiktionary.org/wiki/prefork">prefork</a> .  Unicorn is a daemon written in Ruby and C that can download and run a Ruby on Rails application, in our case GitLab Community Edition or GitLab Enterprise Edition. <br><br>  Unicorn has a multi-process architecture to support multi-core systems (processes can run in parallel on different cores) and for fault tolerance (an abnormally terminated process does not end GitLab).  On startup, the main Unicorn process loads Ruby and Gitlab into memory, and then starts a number of worker processes that inherit this ‚Äúinitial‚Äù memory snapshot.  The main Unicorn process does not process incoming requests ‚Äî workflows do this.  The network stack of the operating system receives incoming connections and distributes them to workflows. <br><br>  In an ideal world, the main process runs the workflow pool once, which then processes incoming network connections until the end of the centuries.  In practice, workflows may crash or be killed by a timeout.  If the main Unicorn process finds that one of the worker processes has processed the request for too long, then it kills the process with <b>SIGKILL</b> ( <b>kill -9</b> ).  Regardless of how the workflow ended, the main process will replace it with a new one, which inherits the same ‚Äúinitial‚Äù state.  One of the features of Unicorn is the ability to replace defective workflows without interrupting network connections with user requests. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An example of a workflow timeout, which can be found in <b>unicorn_stderr.log</b> .  The main process id is 56227: <br><br><pre><code class="hljs delphi">[<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T10:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">08.660325</span></span> <span class="hljs-string"><span class="hljs-string">#56227</span></span>] ERROR -- : worker=<span class="hljs-number"><span class="hljs-number">10</span></span> PID:<span class="hljs-number"><span class="hljs-number">53009</span></span> timeout (<span class="hljs-number"><span class="hljs-number">61</span></span>s &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>s), killing [<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T10:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">08.699360</span></span> <span class="hljs-string"><span class="hljs-string">#56227</span></span>] ERROR -- : reaped #&lt;Process::Status: pid <span class="hljs-number"><span class="hljs-number">53009</span></span> SIGKILL (signal <span class="hljs-number"><span class="hljs-number">9</span></span>)&gt; worker=<span class="hljs-number"><span class="hljs-number">10</span></span> [<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T10:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">08.708141</span></span> <span class="hljs-string"><span class="hljs-string">#62538</span></span>] INFO -- : worker=<span class="hljs-number"><span class="hljs-number">10</span></span> spawned pid=<span class="hljs-number"><span class="hljs-number">62538</span></span> [<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T10:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">08.708824</span></span> <span class="hljs-string"><span class="hljs-string">#62538</span></span>] INFO -- : worker=<span class="hljs-number"><span class="hljs-number">10</span></span> ready</code> </pre> <br><br>  The basic Unicorn settings for working with processes is the number of processes and the timeout after which the process will be completed.  A description of these settings can be found in <a href="">this section of the</a> GitLab documentation. <br><br><h1>  <b>unicorn-worker-killer</b> </h1><br>  GitLab has memory leaks.  These leaks manifest themselves in long-running processes, in particular, in the workflows created by Unicorn (there are no such leaks in the main Unicorn process, since it does not process requests). <br><br>  To combat these memory leaks, GitLab uses a <a href="https://github.com/kzk/unicorn-worker-killer">unicorn-worker-killer</a> that <a href="http://habrahabr.ru/company/Voximplant/blog/269467/">modifies</a> Unicorn workflows to check memory usage every 16 requests.  If the workflow memory used exceeds the set limit, the process ends and the main Unicorn process automatically replaces it with a new one. <br><br>  In fact, this is a good way to deal with memory leaks, since the design of Unicorn allows you not to lose the user's request at the end of the workflow.  Moreover, unicorn-worker-killer ends the process between processing requests, so it does not affect the work with them. <br><br>  So in the file <b>unicorn_stderr.log</b> looks like a restart of the workflow due to a memory leak.  As you can see, the process with the identifier 125918 after introspection decides to complete.  The threshold memory value in this case is 254802235 bytes, that is, of the order of 250 megabytes.  GitLab uses as a threshold a random number in the range from 200 to 250 megabytes.  The main GitLab process with ID 117565 then creates a new workflow with ID 127549: <br><br><pre> <code class="hljs delphi">[<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T12:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">41.828374</span></span> <span class="hljs-string"><span class="hljs-string">#125918</span></span>] WARN -- : #&lt;Unicorn::HttpServer:<span class="hljs-number"><span class="hljs-number">0</span></span>x00000002734770&gt;: worker (pid: <span class="hljs-number"><span class="hljs-number">125918</span></span>) exceeds memory limit (<span class="hljs-number"><span class="hljs-number">256413696</span></span> bytes &gt; <span class="hljs-number"><span class="hljs-number">254802235</span></span> bytes) [<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T12:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">41.828472</span></span> <span class="hljs-string"><span class="hljs-string">#125918</span></span>] WARN -- : Unicorn::WorkerKiller send SIGQUIT (pid: <span class="hljs-number"><span class="hljs-number">125918</span></span>) alive: <span class="hljs-number"><span class="hljs-number">23</span></span> sec (trial <span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T12:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">42.025916</span></span> <span class="hljs-string"><span class="hljs-string">#117565</span></span>] INFO -- : reaped #&lt;Process::Status: pid <span class="hljs-number"><span class="hljs-number">125918</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>&gt; worker=<span class="hljs-number"><span class="hljs-number">4</span></span> [<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T12:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">42.034527</span></span> <span class="hljs-string"><span class="hljs-string">#127549</span></span>] INFO -- : worker=<span class="hljs-number"><span class="hljs-number">4</span></span> spawned pid=<span class="hljs-number"><span class="hljs-number">127549</span></span> [<span class="hljs-number"><span class="hljs-number">2015</span></span>-<span class="hljs-number"><span class="hljs-number">06</span></span>-<span class="hljs-number"><span class="hljs-number">05</span></span>T12:<span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">42.035217</span></span> <span class="hljs-string"><span class="hljs-string">#127549</span></span>] INFO -- : worker=<span class="hljs-number"><span class="hljs-number">4</span></span> ready</code> </pre><br><br>  What else is striking when studying this log: the workflow processed only 23 requests before completing due to memory leaks.  This is currently the norm for gitlab.com <br><br>  Such a frequent restart of workflows on GitLab servers can be a cause of concern for system administrators and devops, but in practice this is often the normal behavior. </div><p>Source: <a href="https://habr.com/ru/post/270227/">https://habr.com/ru/post/270227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270215/index.html">Event-oriented Python backtesting step by step. Part 5 (and last)</a></li>
<li><a href="../270217/index.html">Google Play Services Research: Place Picker & Autocomplete</a></li>
<li><a href="../270219/index.html">Unity Cloud Build or how to build an iOS build on Windows</a></li>
<li><a href="../270223/index.html">Download and convert video to Rutube: from crutches to meta-programming</a></li>
<li><a href="../270225/index.html">Double cycle KCS. Just about knowledge management.</a></li>
<li><a href="../270229/index.html">Visual Studio Online: Continuous Integration and Testing</a></li>
<li><a href="../270231/index.html">How the second chip allows hackers to bypass the verification process of a bank card</a></li>
<li><a href="../270233/index.html">About Parboiled</a></li>
<li><a href="../270235/index.html">Programmer's resume: how to make it convenient?</a></li>
<li><a href="../270237/index.html">CONVERT web analytics and internet marketing conference: preliminary program</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>