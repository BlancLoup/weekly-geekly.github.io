<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making a simple RC aerial boat</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes on the Internet I see questions from newbies who want to build a quadrocopter from scratch and write firmware to it. I myself am so that in ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making a simple RC aerial boat</h1><div class="post__text post__text-html js-mediator-article">  Sometimes on the Internet I see questions from newbies who want to build a quadrocopter from scratch and write firmware to it.  I myself am so that in order to practice creating RC models I decided to start with something more simple. <br><br><img src="https://habrastorage.org/files/7dd/6f2/46e/7dd6f246e98e47b8b5f3eda1ccdd14b0.JPG"><br><br>  The article in detail for the smallest described the algorithm of the boat, the control panel and the choice of components. <br><a name="habracut"></a><br><h2>  Why aeroboat? </h2><br><ol><li>  Simply; </li><li>  Cheap; </li><li>  It can move in natural conditions; </li><li>  You can train to tweak various control options, including the PID controller. </li></ol><br>  Flying vehicles are great, but difficult.  In the air, you can not just turn off the screws, if something goes wrong.  Yes, and specific traction is needed very decent, even for airplanes, not to mention multikopter. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Platforms like this <br><br><img src="https://habrastorage.org/files/2ea/857/305/2ea8573051be4afcbe6aaf40c94a753d.jpg"><br><br>  ( <a href="http://informatik-m.ru/mir_robototehniki/kak-sdelat-mini-robota-svoimi-rukami.html">there</a> is a more detailed description). <br><br>  they know how to move only according to, in most cases, an artificial flat surface, and their control differs greatly. <br><br>  But on the water, we can swim anywhere, which in the future can give us the opportunity to make an autopilot using GPS.  The classic design with the propeller for me is complicated by the shaft exit from the hull - I have no idea how to seal it. <br><br>  More advantages of air propulsion: <br><ol><li>  It can be put on different platforms: boat, sleigh, piece of foam ... </li><li>  It will not catch on the bottom or algae. </li></ol><br>  It is necessary that the device could rotate.  There are 3 options: <br><ol><li>  <a href="https://www.youtube.com/watch%3Fv%3Db3DOPYeYqZY">One screw + steering wheel for turns</a> ; </li><li>  <a href="https://www.youtube.com/watch%3Fv%3D8LyCP_28QAg">One screw + turning system</a> ; </li><li>  Two rigid screws.  Rotate changing their traction - the easiest way.  He used it. </li></ol><br><br><h2>  Remote control </h2><br><h3>  Operating principle </h3><br>  1 joystick + several switches.  The task of the console - several times per second to broadcast data on the position of the joystick knob and switches. <br><br><h3>  What to do </h3><br>  First, you need a radio transmitter.  The cheapest option is the NRF24L01 +, which costs <a href="http://www.ebay.com/itm/2PCS-Hot-Sell-NRF24L01-2-4GHz-Antenna-Wireless-Transceiver-Module-for-Arduino-/221746847061">$ 0.85</a> . <br><br>  Secondly, you need a joystick.  Another <a href="http://www.ebay.com/itm/Hot-Sale-JoyStick-Breakout-Module-Shield-PS2-Joystick-Game-Controller-Arduino-/201416176593">$ 1</a> . <br><br>  Several switches - <a href="http://www.ebay.com/itm/10Pcs-Slide-Type-Switch-Module-2-54mm-4-Bit-4-Position-Way-DIP-Red-Pitch-FKS-/321897494822">$ 0.12</a> . <br><br>  Well, all this is fixed on a piece of PCB for <a href="http://www.ebay.com/itm/10Pcs-5-x-7-cm-DIY-Prototype-Paper-PCB-fr4-Universal-Board-prototyping-pcb-kit-/181846671646">$ 0.13</a> . <br><br>  Already counted $ 2.1, but still need MK and power.  It's all not so simple. <br><br>  Looking ahead, I‚Äôll say that ATmega8 or STM8S103F3P6 is quite enough, but since I started this project a long time ago and I had little experience, I put Arduino Pro Mini in the control panel and Arduino Nano (everywhere ATmega32P). <br><br>  In the remote still needed: <br><ol><li>  Power converter 0.9 - 5 V -&gt; 5 V to power the Arduino for <a href="http://www.ebay.com/itm/5PCS-0-9V-5V-to-5V-DC-DC-Booster-USB-Mobile-Step-up-Power-Supply-Module-/181916952600">$ 0.35</a> (USB connector, together with a piece of board, can be broken off for compactness); </li><li>  The 3.3 V AMS1117-3.3 stabilizer for powering the radio module, they cost <a href="http://www.ebay.com/itm/100PCS-AMS1117-3-3-LM1117-1A-3-3V-SOT-223-Voltage-Regulator-/181930531943">$ 0.03 per unit</a> ; </li><li>  Battery compartment for one finger battery for <a href="http://www.ebay.com/itm/10Pcs-1-5V-Plastic-Hard-Storage-Holder-Case-Box-For-1-AA-Battery-With-Wire-Leads-/262239973732">$ 0.15</a> ; </li></ol><br>  Total plus $ 0.53.  Apart from the controller, a pair of capacitors and wires, the cost of the remote control components is $ 2.63. <br><br><h2>  The filling of the radio-controlled model </h2><br><h3>  Components </h3><br>  Everything comes from the engines.  What kind of engines you buy, you need to install such an electronic power, and the base (vessel, sled) will require the appropriate capacity.  And ideologically, everything else is needed only to rotate the screws with the desired speed. <br><br>  I bought these motors with propellers <br><br><img src="https://habrastorage.org/files/02a/811/047/02a8110476e840e68848408e6fcc4872.jpg"><br>  for <a href="http://www.ebay.com/itm/2PCS-DC-3-7V-22000RPM-Coreless-Motor-Propeller-for-RC-Aircraft-Helicopter-Toy-/381374910740">$ 2.88 per pair</a> . <br><br>  He took the L293D as a motor driver - another <a href="http://www.ebay.com/itm/5PCS-Push-Pull-Four-Channel-Motor-Driver-IC-ST-DIP-16-L293D-/272041696769">$ 0.35</a> . <div class="spoiler">  <b class="spoiler_title">And then a lot of problems</b> <div class="spoiler_text">  For L293D, the switched voltage must not be lower than the logic supply voltage.  And these motors very much subsided the voltage, as a result of which the current from the logic power flowed into the motors and the logic power along with the power of the microcontroller also dropped to the point that the MC was turned off. <br></div></div><br>  Nutrition.  We need as many as three supply voltages: <br><ol><li>  5 V for all electronics except radio; </li><li>  3.3 V for the radio module; </li><li>  for motors as they need (my 4.2 V). </li></ol><br>  1 and 2 we will also receive as in the control panel, and for small motors we will put MT3608 for <a href="http://www.ebay.com/itm/MT3608-DC-DC-Step-Up-Power-Apply-Module-Booster-Power-Module-for-Arduino-WF-R4-/141881461656">$ 0.86</a> . <br><br>  Now the most interesting: gyroscope.  The MPU-6050 module <a href="http://www.ebay.com/itm/MPU-6050-3-Axis-Gyroscope-Acce-lerometer-Module-3V-5V-Compatible-Arduino-/181922780294">costs $ 1.53</a> .  There was a desire to use the accelerometer as well, so that when the joystick knob is moved to the side, the vessel would turn around.  But in the end, he rejected this idea: a slight slope in pitch, and the system begins to think that it is accelerating forward or backward.  It turned out to be easier to turn the vessel on the spot simply by compensating the movement of the joystick forward / backward. <br><br>  Add to this $ 0.4 per battery compartment for 2 AA elements and get components for $ 6.4 without a controller and wires. <br><br><h3>  Program </h3><br>  And again we go from the engines.  Each of the two engines driven L293D can <s>dig, but can not dig</s> : <br><ol><li>  Twist forward; </li><li>  Twist back; </li><li>  Do not twist. </li></ol><br>  To make the code easier to read, write <div class="spoiler">  <b class="spoiler_title">6 functions</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motLeftStop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_PLUS); PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_MINUS); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motLeftForward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ PORTD |= <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_PLUS; PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_MINUS); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motLeftBackward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_PLUS); PORTD |= <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_MINUS; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motRightStop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_PLUS); PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_MINUS); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motRightForward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ PORTD |= <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_PLUS; PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_MINUS); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motRightBackward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ PORTD &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_PLUS); PORTD |= <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_MINUS; }</code> </pre> <br></div></div><br>  Now we want to control the speed of rotation of the screws.  Of course, we will do this with the help of PWM.  I do not know whether it is possible to make such a PWM hardware ... I did it programmatically on interrupts.  Let's declare a couple of global variables. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int8_t</span></span> motLeft = <span class="hljs-number"><span class="hljs-number">0</span></span>, motRight = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// -127..+127</span></span></code> </pre><br>  Let the values ‚Äã‚Äãof these variables &lt;0 mean that it is necessary to turn backwards, values&gt; 0 - forward, and if they are equal to 0, then it is not necessary to turn. <br><div class="spoiler">  <b class="spoiler_title">Write the timer interrupt handlers</b> <div class="spoiler_text"><pre> <code class="cpp hljs">ISR(TIMER2_OVF_vect) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(motLeft &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) motLeftForward(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(motLeft &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) motLeftBackward(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(motRight &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) motRightForward(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(motRight &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) motRightBackward(); } ISR(TIMER2_COMPA_vect) { motLeftStop(); } ISR(TIMER2_COMPB_vect) { motRightStop(); }</code> </pre><br></div></div><br>  Now, to change the rotational speed of the propeller, we need to do 2 steps: <br><ol><li>  Write a positive, negative or zero value in motLeft / motRight (module is not important); </li><li>  Write the ‚Äúrotation speed‚Äù in OCR2A / OCR2B. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Let's write for this another couple of functions.</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMotLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">// -127..+127 if(abs(v) &lt; 5) v = 0; motLeft = v; OCR2A = abs(v) * 2; } void setMotRight(int8_t v){ // -127..+127 if(abs(v) &lt; 5) v = 0; motRight = v; OCR2B = abs(v) * 2; }</span></span></code> </pre><br>  Strings <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(v) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) v = <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br>  it is necessary that the boat does not spend energy trying to turn the screws and writing a value less than 5 in OCR2x (they still do not spin). <br></div></div><br><div class="spoiler">  <b class="spoiler_title">It now remains to configure the pins MK and timer</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ DDRD |= (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_PLUS) | (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_LEFT_MINUS) | (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_PLUS) | (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; MOT_RIGHT_MINUS); <span class="hljs-comment"><span class="hljs-comment">//TCCR2B |= (1 &lt;&lt; CS22)|(1 &lt;&lt; CS21)|(1 &lt;&lt; CS20); // set up timer with prescaler = 1024.   16  //TCCR2B |= (1 &lt;&lt; CS22)|(0 &lt;&lt; CS21)|(0 &lt;&lt; CS20); // set up timer with prescaler = 64.   1  TCCR2B |= (0 &lt;&lt; CS22)|(1 &lt;&lt; CS21)|(0 &lt;&lt; CS20); // set up timer with prescaler = 8.  128  //TCCR2B |= (0 &lt;&lt; CS22)|(0 &lt;&lt; CS21)|(1 &lt;&lt; CS20); // set up timer with prescaler = 1.  16  TIMSK2 |= (1 &lt;&lt; TOIE2)|(1 &lt;&lt; OCIE2A)|(1 &lt;&lt; OCIE2B); // enable overflow interrupt TCCR2A &amp;= ~(3); // set WGM20 = 0, WGM21 = 0 TCCR2B &amp;= ~(1 &lt;&lt; 3); // set WGM22 = 0 setMotLeft(0); setMotRight(0); sei(); }</span></span></code> </pre><br></div></div><br>  And you can control the motors by simply calling the functions setMotLeft (int8_t v) and setMotRight (int8_t v). <br><br>  But we want to control the boat wrong!  We want to give commands like "forward / backward" and "right / left"!  And let her figure out what kind of propellers for which she has to turn for this.  Moreover, I want the boat itself to compensate for the turning action of the wind, the currents and ... crookedly set propellers! <br><br>  Let's go now from the other side.  From the remote control.  In the simplest case, the algorithm for its operation is as follows: <br><ol><li>  When you turn on the power, remember the starting position of the joystick; </li><li>  In the cycle, read the position of the joystick, subtract the zero position from it and send the data to the boat. </li></ol><br>  Our radio module supports packets up to 32 bytes.  In order not to memorize offsets, we will use the record. <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControlStatus</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span> x,y; } controlStatus;</code> </pre><br><div class="spoiler">  <b class="spoiler_title">In the following way</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> packet[MAX_BUFF]; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(packet, <span class="hljs-number"><span class="hljs-number">0</span></span>, MAX_BUFF); controlStatus.x = (<span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span>)analogRead(<span class="hljs-number"><span class="hljs-number">1</span></span>) - x0; controlStatus.y = (<span class="hljs-keyword"><span class="hljs-keyword">int16_t</span></span>)analogRead(<span class="hljs-number"><span class="hljs-number">0</span></span>) - y0; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(packet, &amp;controlStatus, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(controlStatus)); Mirf.send(packet); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(Mirf.isSending()){;};</code> </pre><br></div></div><br>  On the receiver side, we will declare the exact same entry and <br><div class="spoiler">  <b class="spoiler_title">we will fill it</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Mirf.dataReady()) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> data[MAX_BUFF]; Mirf.getData(data); <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(&amp;controlStatus, data, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(controlStatus)); setMotRot(-controlStatus.x); setMotForward(controlStatus.y); }</code> </pre><br></div></div><br>  In the setMotRot and setMotForward functions <br><div class="spoiler">  <b class="spoiler_title">write the values ‚Äã‚Äãin the global variables motRot and motForward</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMotRot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(v)&lt;<span class="hljs-number"><span class="hljs-number">10</span></span>) v = <span class="hljs-number"><span class="hljs-number">0</span></span>; motRot = (<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)v; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMotForward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">abs</span></span>(v)&lt;<span class="hljs-number"><span class="hljs-number">10</span></span>) v = <span class="hljs-number"><span class="hljs-number">0</span></span>; motForward = (<span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span>)v; }</code> </pre><br></div></div><br>  And move on to the most interesting.  To how to convert "turn left at a speed of 5 degrees per second and slightly move forward!" Into "left engine 10% back, right 20% forward!". <br><br>  About what <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D0%2598%25D0%2594-%25D1%2580%25D0%25B5%25D0%25B3%25D1%2583%25D0%25BB%25D1%258F%25D1%2582%25D0%25BE%25D1%2580">PID controllers are</a> written quite a lot.  I used to rotate only two components: <br><ol><li>  Proportional; </li><li>  Integral. </li></ol><br>  And for the movement back and forth, the regulator did not use it. <br><br>  Let's sort on an example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> iDeltaRot = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">motTick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> rot = getRotAvg(); <span class="hljs-comment"><span class="hljs-comment">//      int32_t deltaRot = rot - motRot * rotMaxSpeed / 512; iDeltaRot += deltaRot; int32_t motRight = (int32_t)motForward * forwardMult - deltaRot * rotMult - iDeltaRot * iDeltaRotMult, motLeft = (int32_t)motForward * forwardMult + deltaRot * rotMult + iDeltaRot * iDeltaRotMult; int32_t motMax = max(abs(motRight), abs(motLeft)); if(motMax &gt; 127){ motRight = (int32_t)motRight * 127 / motMax; motLeft = (int32_t)motLeft * 127 / motMax; } setMotRight(motRight); setMotLeft(motLeft); }</span></span></code> </pre><br>  The code is simplified, in order to focus on important parts, the archive will be the full version. <br><br>  What are we doing here? <br><ol><li>  Calculate the difference between the real speed of rotation of the boat (rot) and the desired (motRot * rotMaxSpeed); </li><li>  Calculate the desired rotation speed of the screws motRight and motLeft; </li><li>  If the desired rotational speeds exceed the maximum possible ones, reduce them keeping the ratio between them; </li><li>  Call the setMotRight / setMotLeft already familiar to us. </li></ol><br>  Everything! <br><br>  This is the whole boat control algorithm! <br><br>  Complicated?  It seems to me no.  But, nevertheless, during the tests and adjustments, a whole heap of problems would arise that would lead to numerous derailments if it were an aircraft. <br><br>  In the described function there are 4 factors: <br><ol><li>  forwardMult - sensitivity to the movement of the joystick forward / backward; </li><li>  rotMaxSpeed ‚Äã‚Äã- the desired rotation speed when the joystick is tilted all the way to the right / left; </li><li>  rotMult - the coefficient of the proportional component (how much the deviation of the current rotational speed from the desired one affects the rotation); </li><li>  iDeltaRotMult is the coefficient of the integral component (how much does the deviation of the current angle of rotation from the desired effect on the rotation). </li></ol><br>  We adjust these coefficients experimentally, and the response of the boat to the joystick and external sweeping effects will depend on them. <br><br><h2>  Status indication </h2><br>  When debugging / configuring, there will be misunderstandings from the series ‚ÄúWhy does the boat react to the joystick not in the way I want it to?‚Äù.  Some points can be debugged by displaying debug information on a PC, but it would be more convenient to understand what is happening right on the spot.  At first, I considered 2 options: <br><ol><li>  A laptop; </li><li><div class="spoiler">  <b class="spoiler_title">Display Nokia 5110</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a23/fc5/65d/a23fc565d564418bad9c2ad6a1144f0c.jpg"><br></div></div></li></ol><br>  The drawbacks of both are clear: the laptop is large and it is inconvenient to carry around with it, and the display of the Nokia 5110 will not allow you to visually display a large number of parameters of the state of the boat. <br><br>  I took something between them: <a href="https://www.itead.cc/nextion-nx4827k043.html">Nextion Enhanced NX4827K043 - Generic 4.3 '' HMI Touch Display</a> .  Thanks to the touch screen, you can quickly and conveniently adjust the parameters of the boat on the go.  This is a kind of computer consisting of: <br><ol><li>  Microcontroller GD32F103R8T6; </li><li>  Winbond W9864G6KH-6 SDRAM (8 MB); </li><li>  Winbond W25Q256FVFG flash memory (32 MB, 100,000 rewrite cycles, which is quite pleasing); </li><li>  FPGA Altera MAX II EPM570T144C5N. </li></ol><br>  Everything in the collection looks like this (clickable): <br><br> <a href=""><img src="https://habrastorage.org/files/b78/b67/ad2/b78b67ad2ffd4f00a0e82daae979dad8.JPG"></a> <br><br>  This computer / display is a black box and is sharpened to interact with a person.  Even the existing GPIO is sharpened for connecting buttons and indicators.  Their <a href="https://www.itead.cc/nextion-expansion-board.html">Expansion Board</a> confirms this.  So, using the built-in controller as a boat control panel (read the joystick readings, exchange data with the NRF24L01 + radio module) will not work.  To interact with the microcontroller there is a UART and ... and that's it. <br><br>  About how and what you can do with the help of this display you can do, it says a lot + there are videos on Youtube.  Look, for example, <a href="https://www.youtube.com/watch%3Fv%3DD-zgtylBKUc">here it</a> is - everything is clearly shown there.  But since this display is more expensive than all the other components of the boat and console combined, I will describe in more detail my impressions of working with it.  Perhaps this will help someone to understand whether this option is suitable for him or a laptop / display Nokia 5110 would be preferable.  Advantages of Nextion Enhanced NX4827K043: <br><ol><li>  Very easy to use.  There is simple documentation, examples, videos on Youtube, ... For a couple of hours, you can figure it out from scratch.  Almost everything you need to know about him is on two pages: the <a href="https://www.itead.cc/wiki/NX4827K043">wiki page</a> and the <a href="https://www.itead.cc/wiki/Nextion_Instruction_Set">Instruction Set</a> </li><li>  Very fast development.  Visual editor like Visual Studio (only easier).  Threw components and everything works. </li><li>  High quality components.  Same flash memory for 100k rewrite cycles. </li><li>  A debugger that can simulate a display using a PC and communicate with your MC via a COM port.  Allows you to fully develop the device, debug and buy the display, only if everything is fine. <div class="spoiler">  <b class="spoiler_title">Although there is a problem with him</b> <div class="spoiler_text">  With frequent updates of the display readings, the debugger does not even have time on a very good computer.  The piece of iron works much faster.  However, if in your case you manage to do everything in the debugger, then when transferring to iron, the situation should not get worse. <br></div></div></li><li>  Resistive sensor.  You can create quite small controls and poke them with a fingernail or any stylus. </li></ol><br>  Disadvantages: <br><ol><li>  Price.  $ 50 is still a lot for the 4.3 '' display. </li><li>  There are few existing components, there is little component configuration, how to create your own is not clear.  This is partially offset by the primitive drawing functions (lines, rectangles, circles, ...). </li><li>  The standard component Gauge flickers when upgrading. </li><li>  No (at least I did not find) transparency. </li><li>  Power requirements: 4.75-7 V and average current 250 mA.  When voltage drops, the display flashes. </li><li>  Only UART.  Could make communication with him even on SPI and I¬≤C. </li><li>  GPIO output only under a loop (no comb 2.54 mm), no ADC. </li></ol><br><br>  In general, the display creates the impression of a very high-quality product, which is easy and pleasant to work with. <br><br>  The display can perform two tasks at once: <br><ol><li>  Status indication.  I am primarily interested in: <br><ul><li>  "Speed ‚Äã‚Äãof rotation" screws; </li><li>  The value of the variable iDeltaRot - how much the desired angle of rotation is different from the desired one; </li><li>  Boat rotation speed; </li><li>  Angle of rotation of the boat; </li><li>  The frequency of receiving packets from the remote; </li><li>  The frequency of calls to the motTick function. </li></ul><br></li><li>  Setting parameters, namely the above described forwardMult, rotMaxSpeed, rotMult, iDeltaRotMult. </li></ol><br><br>  Made 2 pages (clickable for quality assessment): <br><ol><li>  Indications: <br><br> <a href=""><img src="https://habrastorage.org/files/6f7/aaa/571/6f7aaa57152e48a5b92e6555d230d863.JPG"></a> <br></li><li>  Parameter Settings: <br><br> <a href=""><img src="https://habrastorage.org/files/256/9f6/22d/2569f622dc234426b0dc8d4352a8488e.JPG"></a> <br><br>  The first 4 columns from left to right are: forwardMult, rotMult, iDeltaRotMult, rotMaxSpeed. <br></li></ol><br><br>  Video of the boat test on the floor: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/kwHMI4QUjIs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  The reaction of the boat to the external unfolding effect at various iDeltaRotMult (integral coefficients): <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3numZhKZnic" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Demonstration of the influence of parameters on water: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/QuOtIunGEME" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Video on open water could not be photographed.  You can take it on faith that he has good handling, and the maximum speed is not very. <br><br><h2>  Specifications </h2><br><ul><li>  Traction 9 g; </li><li>  Weight 115 g, of which batteries weigh 52g; </li><li>  The maximum acceleration is obtained at 0.77 m / s ^ 2.  To human 5 km / h, if there was no water resistance, the boat would accelerate in 1.8 s; </li><li>  The cost of the components is about $ 15 if you use Arduino Nano in both the remote and in the boat (without the display and batteries). </li></ul><br><br><h2>  Conclusion </h2><br>  Those who have a desire to collect something radio-controlled, I recommend to start with a vessel with two fixed propellers.  In my opinion, this is the simplest thing that can be done in this area. <br><br>  <a href="">Archive with projects</a> <br><br>  And finally, to have something to strive for, here is a video of an amazing device: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/_iqqHAWJq_0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/390429/">https://habr.com/ru/post/390429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../390419/index.html">Connect LED matrix to Raspberry pi</a></li>
<li><a href="../390421/index.html">DVB Stick Radio for $ 8 - Learn SDR with GNURadio</a></li>
<li><a href="../390423/index.html">Amazon‚Äôs zombie apocalypse clause has been included in Amazon‚Äôs web services terms</a></li>
<li><a href="../390425/index.html">Robots have learned to cook ramen, change their color and size</a></li>
<li><a href="../390427/index.html">Debugging Arduino Code (AVR). Part 1. Virtual Debugging</a></li>
<li><a href="../390431/index.html">Home projectors Epson EH-TW5210, EH-TW5300 and EH-TW5350 - better, faster, brighter</a></li>
<li><a href="../390433/index.html">Google will not participate in the upcoming frequency auction in the US</a></li>
<li><a href="../390435/index.html">Mathematicians built a map of connections in the Star Wars universe</a></li>
<li><a href="../390437/index.html">Self-made electronic altimeter variometer with sound and light warning signals</a></li>
<li><a href="../390439/index.html">Mirrored interband Andreev reflections on van der Waals contacts between graphene and niobium selenide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>