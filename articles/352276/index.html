<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Time-to-Digital (TDC) converters: what it is and how they are implemented in FPGA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The figure is the first in the world of the Mo-Tzu quantum communication satellite , which was launched from China in 2016, with the TDC implemented i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Time-to-Digital (TDC) converters: what it is and how they are implemented in FPGA</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/mq/zo/8_/mqzo8_ixswcj-skz1zc1qm28e3a.jpeg"><br>  <sub><i>The figure is the first in the world of the <a href="https://lenta.ru/news/2016/08/16/china/">Mo-Tzu quantum communication satellite</a> , which was launched from China in 2016, with the <a href="">TDC</a> implemented in FPGA.</i></sub> <br><br>  To explain to his girlfriend (or boyfriend) what ADC and DAC are, and in what household appliances they are used, every person who calls himself an engineer can.  But what TDC is and why we don‚Äôt have them at home can often be found only after the wedding. <br><br>  TDC is a time-to-digital converter.  In Russian, speaking: time-measuring system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main consumers of high-speed TDC are research groups.  As a rule, something very specific is required for a specific research project.  That channels need a lot, the resolution is very high, then the performance is compact.  And the level of development of modern FPGAs and their availability just give researchers the opportunity to experiment with implementations and adjust them for their own needs. <br><br>  In this habrastia, a detailed description of a simple time-measuring system on FPGA Cyclone IV.  The article will be useful not only for expanding horizons, but also from a methodological point of view, since the implementation of the system is nontrivial. <br><a name="habracut"></a><br>  Immediately, we note that the thought that came to mind ‚ÄúWhat are they writing about?  We read the CPU / MCU counter / timer by event and it's in the bag ‚Äùis not suitable here.  The fact is that applications require precision by an order of magnitude greater than can be provided by ‚Äústandard‚Äù counters, as well as deterministic latency, multi-channel and large ‚Äúevent throughput‚Äù. <br><br>  Formally, the task that TDC solves is to determine the time interval between events.  In multichannel systems, top-level logic can additionally calculate correlations between events.  The event is usually triggered by a particle detector or optical sensor.  In everyday life, of course, such systems do not find application.  And in general, on the scale of picoseconds, it makes sense to measure physical processes occurring in comparable times, for example, the passage of elementary particles in a detector.  Note some areas of TDC application: <br><br><ul><li>  Mass spectroscopy, positron emission tomography (PET) ‚Äîthe arrival times of particles at the detectors are recorded. </li><li>  LIDAR - based on time counts, the distance to the irradiated area is determined. </li><li>  Quantum cryptography - the response times of single photon detectors are recorded. </li><li>  Random number generation - the times of occurrence of events are used as entropy. </li></ul><br>  The electrical impulse generated by the detector goes through a preprocessing circuit that translates it into a ‚Äúdigestible‚Äù form for electronics.  That is, the needle ( <b>glitch</b> ) turns into a signal with a duration of several nanoseconds with an amplitude of several volts.  Depending on the implementation, this circuit may be located directly in the detector or in the measuring system.  Below is a timing chart of the output signal of the <a href="https://www.idquantique.com/single-photon-systems/products/id100/"><i>ID Quantique</i> single photon <i>detector</i></a> .  In addition to the impulse itself, the so-called ‚Äúdead time‚Äù of the detector can be seen in the picture.  This is the time interval during which the detector does not respond to external events.  Since this time arises from the features of electronic circuits, then the TDCs themselves have some dead time, with which developers continuously struggle. <br><br><img src="https://habrastorage.org/webt/u9/fl/ns/u9flnserglnnseco9vulfdexjvm.png"><br><br>  For highly accurate measurement of time intervals, both boxed solutions and specialized ASICs are available on the market.  On the topic of implementation of TDC is quite extensive material.  The general theory can be found in the book <a href="http://www.springer.com/la/book/9789048186273"><i>Time-to-Digital Converters by</i> Stefan Hantsler</a> , and with various modern implementations in periodicals, for example, <a href="https://arxiv.org/find/all/1/all:%2BAND%2Btdc%2Bfpga/0/1/0/all/0/1">on arxiv.org</a> .  We will talk about a simple TDC FPGA implementation. <br><br><h2>  TDC implementation in FPGA </h2><br>  From an electronic point of view, the implementation of the task is reduced to ‚Äúregistering the position‚Äù of the signal front relative to any sync signal.  The FPGA elements that we have at our disposal are physically on-chip signal lines, registers, logic blocks, clock lines, and <b>PLL</b> .  The main approaches to the implementation of TDC using these elements were proposed relatively long ago: sub- <b>tact delay line</b> ( <b>tapped delay line</b> ), <b>Vernier delay line</b> ( <b>delayed line</b> ), <a href="https://www.researchgate.net/publication/319183131_Multiphase_Clock_based_Vernier_TDC_on_FPGA_for_On-chip_Temperature_Measurement_Application">‚Äúphased PLL‚Äù</a> .  But engineers are still working on their improvement and implementation on modern platforms. <br><br>  In our FPGA implementation, we basically followed <a href="">this publication</a> , describing the sub-tact delay line, as well as some general ideas drawn <a href="http://ieeexplore.ieee.org/search/searchresult.jsp%3FqueryText%3D.QT.Jinyuan%2520Wu.QT.%2520.AND.%2520.QT.TDC.QT.%26newsearch%3Dtrue">from the Jinyuan Wu publications</a> from CERN 2000-x. <br><br>  The concept of a sub-tactical delay line is shown in the figures below (the animation is taken from the presentation of Jinyuan Wu, Z. Shi and I. Wang).  Essence: to pass the input signal through the circuit formed by the delay elements, the outputs of which are connected to simultaneously latching registers.  As a result, the values ‚Äã‚Äãsnapped into the register set ‚Äî the thermocode ‚Äî correspond to the mutual arrangement of the input fronts and the clock signals.  Then everything is simple.  We correct the errors in the thermocode, decode it into a number, reset the values ‚Äã‚Äãof the registers, add the number of the cycle in which the event is registered, and pass to the output. <br><br><img src="https://habrastorage.org/webt/ca/_n/-s/ca_n-s1oqdaet7jy3lsuiuqwob8.gif"><br><br><img src="https://habrastorage.org/webt/dm/oc/ky/dmockyh03wpn4wh9pu_j4vjz0uy.png"><br><br>  We recall the device FPGA Cyclone family from Intel (Altera).  Logic elements ( <b>LE</b> ) are grouped into blocks ( <b>LAB</b> ), controlled by one line of the shred and connected by lines of transfer of the discharge ( <b>carry line</b> ).  This is exactly the scheme we need.  That is, the input signal will start on some <b>LE</b> and direct it along the lines of transfer of the discharge to the neighboring ones.  At the same time <b>LE</b> should work in arithmetic mode.  We will clock all LEs in one shred and pick up the thermocode upon the appearance of the input signal. <br><br>  Now we face several practical issues: <br><br><ol><li>  How to describe the delay line scheme on verilog? </li><li>  How to explain to Quartus that we want to use the transfer lines and disable their optimization? </li><li>  How to form a delay line on neighboring <b>LEs</b> from one <b>LAB</b> ? </li></ol><br>  Verilog's schema description language does not allow to describe synthesized delays.  The delays specified by the <b>#N</b> instruction are intended for simulation.  But in our case, this is not required.  The key is to describe the use of <b>LE in a</b> specific way. <br>  For this, the <b>LE</b> element IP block goes to the Intel element library.  This module is common to the <b>LE-</b> Cyclone family, and in our case some of its parameters are not involved. <br><br>  From the point of view of Quartus, the delay line is pointless.  Why keep the signal tricky way, if it can be immediately carried out from point A to point B?  In order for Quartus not to try to optimize the delay line, and as a result, threw out the components of its <b>LE</b> , we use the directive <b>/ * synthesis keep = 1 * /</b> opposite the declaration of the element to which it relates.  As a result, the main code looks like this: <br><br><pre><code class="hljs vhdl">//     cyclone_lcell #( .operation_mode (<span class="hljs-string"><span class="hljs-string">"arithmetic"</span></span> ), // ¬´¬ª   .synch_mode (<span class="hljs-string"><span class="hljs-string">"off"</span></span> ), .register_cascade_mode (<span class="hljs-string"><span class="hljs-string">"off"</span></span> ), .sum_lutc_input (<span class="hljs-string"><span class="hljs-string">"datac"</span></span> ), .lut_mask (<span class="hljs-string"><span class="hljs-string">"cccc"</span></span> ), // ¬´¬ª   .power_up (<span class="hljs-string"><span class="hljs-string">"low"</span></span> ), .cin_used (<span class="hljs-string"><span class="hljs-string">"false"</span></span> ), .cin0_used (<span class="hljs-string"><span class="hljs-string">"false"</span></span> ), .cin1_used (<span class="hljs-string"><span class="hljs-string">"false"</span></span> ), .output_mode (<span class="hljs-string"><span class="hljs-string">"reg_and_comb"</span></span> ), //      .lpm_type (<span class="hljs-string"><span class="hljs-string">"cyclone_lcell"</span></span>), .x_on_violation (<span class="hljs-string"><span class="hljs-string">"off"</span></span> ) ) u_cell0( <span class="hljs-comment"><span class="hljs-comment">/* synthesis keep = 1 */</span></span> .clk ( clk ), //   .dataa ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .datab ( in_hit ), //   .datac ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .aclr ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .aload ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .sclr ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .sload ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .ena ( <span class="hljs-number"><span class="hljs-number">1</span></span> ), .inverta ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .regcascin ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .combout ( ), .regout ( r_out[<span class="hljs-number"><span class="hljs-number">0</span></span>] ), //   .cout ( c_out[<span class="hljs-number"><span class="hljs-number">0</span></span>] ) //    ); //     genvar i; <span class="hljs-keyword"><span class="hljs-keyword">generate</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; DELAY_STAGES; i = i + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> : DELAY_LINE cyclone_lcell #( .operation_mode (<span class="hljs-string"><span class="hljs-string">"arithmetic"</span></span> ), // ¬´¬ª   .synch_mode (<span class="hljs-string"><span class="hljs-string">"off"</span></span> ), .register_cascade_mode (<span class="hljs-string"><span class="hljs-string">"off"</span></span> ), .sum_lutc_input (<span class="hljs-string"><span class="hljs-string">"cin"</span></span> ), .lut_mask (<span class="hljs-string"><span class="hljs-string">"f0f0"</span></span> ), // ¬´¬ª   .power_up (<span class="hljs-string"><span class="hljs-string">"low"</span></span> ), .cin_used (<span class="hljs-string"><span class="hljs-string">"true"</span></span> ), //    .cin0_used (<span class="hljs-string"><span class="hljs-string">"false"</span></span> ), .cin1_used (<span class="hljs-string"><span class="hljs-string">"false"</span></span> ), .output_mode (<span class="hljs-string"><span class="hljs-string">"reg_and_comb"</span></span> ), //      .lpm_type (<span class="hljs-string"><span class="hljs-string">"cyclone_lcell"</span></span>), .x_on_violation (<span class="hljs-string"><span class="hljs-string">"off"</span></span> ) ) u_cell1( <span class="hljs-comment"><span class="hljs-comment">/* synthesis keep = 1 */</span></span> .clk ( clk ), //   .dataa ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .datab ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .datac ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .cin ( c_out[i-<span class="hljs-number"><span class="hljs-number">1</span></span>] ), //   .aclr ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .aload ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .sclr ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .sload ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .ena ( <span class="hljs-number"><span class="hljs-number">1</span></span> ), .inverta ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .regcascin ( <span class="hljs-number"><span class="hljs-number">0</span></span> ), .combout ( ), .regout ( r_out[i] ), //   .cout ( c_out[i] ) //    ); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> endgenerate</code> </pre> <br>  To indicate the use of neighboring <b>LEs</b> and their placement in a specific location on a chip, use the <b>LogicLock Regions</b> tool.  That is, let us indicate a rectangular area on the crystal and clearly indicate the set LE, which Quartus should place in it.  In the figure below, the <b>line</b> area contains the delay line, and the <b>delay_line</b> area includes the additional logic for processing the thermal code. <br><br><img src="https://habrastorage.org/webt/b2/mi/g_/b2mig_z2t5fqe8re_rjtb652eyu.png"><br><br>  Below is the layout of the elements of the delay line from <b>Chip Planner</b> with a schematic display of signals and a detailed diagram of the first two elements of the delay line. <br><br><img src="https://habrastorage.org/webt/ov/hv/hl/ovhvhlywxuq4v0yokezoovda0e4.png"><br><br>  Note that the implemented circuit has a dead time of one cycle, which is necessary for ‚Äúresetting‚Äù the delay line registers. <br><br>  The scheme described was decomposed on a Cyclone IV EP4CE22 chip.  Experiments with the length of the delay line and the frequency of the clock resulted in the following parameters: the length of the delay line 64 <b>LE</b> , the frequency of the clock ~ 120 MHz.  The delay line and the thermal code processing logic fit into 42 <b>LABs</b> . <br><br><h2>  TDC Calibration </h2><br>  Obviously, the physical delays on each logical element are different.  To account for this fact, it is necessary to calibrate the device.  The first thing that comes to mind is the input to the TDC input of a signal with a known period.  However, such a path is rather laborious, since it requires precision scanning of the signal period in a relatively wide range. <br><br>  The next suggestion is a random event calibration: we apply signals with uniformly distributed random delays to the input and observe a histogram of events falling into the time bin.  In this case, the accuracy increases with the accumulation of events as <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>s</mi><mi>q</mi><mi>r</mi><mi>t</mi><mo stretchy=&quot;false&quot;>(</mo><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.246ex" height="2.66ex" viewBox="0 -832 4411.5 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-31" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-2F" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-73" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-71" x="1470" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-72" x="1931" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-74" x="2382" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-28" x="2744" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-4E" x="3133" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-29" x="4022" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>s</mi><mi>q</mi><mi>r</mi><mi>t</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-1"> 1 / sqrt (N) </script>  where N is the number of events filed.  We will use the <a href="http://ieeexplore.ieee.org/document/5485143/">method of correlated events</a> .  In this method, accuracy is limited initially and can be achieved by a relatively small number of measurements. <br><br>  The essence of the method is to select the frequency of generation of events, at which they will be evenly distributed in time bins.  For this, it is necessary to satisfy the relation: <br><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><merror><mtext>\&amp;#xA0;left&amp;#xA0;\&amp;#xA0;{N&amp;#xA0;*&amp;#xA0;T2&amp;#xA0;/&amp;#xA0;T1&amp;#xA0;\&amp;#xA0;right&amp;#xA0;\}&amp;#xA0;=&amp;#xA0;0</mtext></merror></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><span class="noError" aria-hidden="true" style="display: inline-block;">\&nbsp;left&nbsp;\&nbsp;{N&nbsp;*&nbsp;T2&nbsp;/&nbsp;T1&nbsp;\&nbsp;right&nbsp;\}&nbsp;=&nbsp;0</span><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><merror><mtext>\&nbsp;left&nbsp;\&nbsp;{N&nbsp;*&nbsp;T2&nbsp;/&nbsp;T1&nbsp;\&nbsp;right&nbsp;\}&nbsp;=&nbsp;0</mtext></merror></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-2"> \ left \ {N * T2 / T1 \ right \} = 0 </script></p><br><br>  where N is the number of events that we want to evenly distribute in the time interval T1, 1 / T2 is the frequency of event generation, {...} is the fractional part of the number. <br><br>  In this case, signals can be generated by an internal PLL.  In our example, the PLL input frequency is 50 MHz and for the number of events N = 256, we selected the following operating frequencies: <br><br><ul><li>  1 / T1 = 50 MHz * 93/40 = 116.26 MHz: clock frequency TDC </li><li>  1 / T2 = 50 MHz * 32/285 = 5.614 MHz: frequency of event generation </li></ul><br>  The ratio is such that at approximately twenty TDC clock cycles there is one event.  In this case, the resolution between adjacent events is: <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi><mi>T</mi><mo>=</mo><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>T</mi><mn>1</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>N</mi><mo>=</mo><mn>33.6</mn><mi>p</mi><mi>s</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.793ex" height="2.66ex" viewBox="0 -832 10244.1 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-64" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-54" x="523" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-3D" x="1505" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-31" x="2562" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-2F" x="3062" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-54" x="3563" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-31" x="4267" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-2F" x="4768" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-4E" x="5268" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-3D" x="6434" y="0"></use><g transform="translate(7491,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-33"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-33" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-2E" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMAIN-36" x="1279" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-70" x="9271" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/352276/&amp;xid=25657,15700023,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjUAA4K4Q4X5UuupzIgKk2ifIZjkg#MJMATHI-73" x="9774" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>d</mi><mi>T</mi><mo>=</mo><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>T</mi><mn>1</mn><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>N</mi><mo>=</mo><mn>33.6</mn><mi>p</mi><mi>s</mi></math></span></span><script type="math/tex" id="MathJax-Element-3"> dT = 1 / T1 / N = 33.6ps </script><br><br>  The calibration procedure consists in the repeated measurement of a continuous sequence of 256 events.  In our experiment, the total number of measured events is 8192. The resulting histogram corresponds to the fraction of the individual delay elements in one TDC cycle. <br><br><img src="https://habrastorage.org/webt/nk/2z/4f/nk2z4fmonp-jirlfowjjg3qya9k.png"><br><br>  The upper graph shows the distribution of samples by the elements of the delay line.  The reference number should be understood as the boundary between ones and zeros in the corrected hotcode.  The failure on the 45th element of the delay line corresponds to the simultaneous operation of two adjacent elements, which is characteristic of such a realization (bubble error [Wu08]).  The position of the dip depends on the area where the delay line is located on the chip.  With an increase in the number of recorded events, there is no significant change in the distribution of samples. <br><br>  The lower graph shows a calibration curve that compares the interval number with the delay time.  The sum of all time-counting samples corresponds to the time T1 = 8.6ns.  Translation of the bin number into time intervals can be carried out directly in the chip or using a programmable Nios II processor. <br><br>  The following are the absolute time intervals corresponding to the elements of the delay line with a significant number of operations and the distribution of intervals.  The average value of the interval is 160 ps, ‚Äã‚Äãthe time variance is 31 ps.  As a result, it can be argued that the achieved resolution of the time-measuring system is <b>~ 200 ps</b> .  To feel this number, we note that it corresponds to the frequency of 5 GHz.  And this is only the simplest implementation in FPGA, not on the very last chip! <br><br><img src="https://habrastorage.org/webt/vb/sg/8r/vbsg8rgwfmgdrkhmerlahcgxt7u.png"><br><br><h2>  Conclusion </h2><br>  We looked at some aspects of TDC implementation in FPGA.  However, much of the detail is omitted.  If you are interested in this topic, we advise you to get acquainted with such things as dynamic calibration;  methods of error correction (bubble errors), increasing the resolution of TDC (wavelauncher), reducing the uncertainty of the interval (averaging, multiple TDC instances), reducing the dead time.  You can also consider the implementation of TDC on alternative platforms. </div><p>Source: <a href="https://habr.com/ru/post/352276/">https://habr.com/ru/post/352276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352266/index.html">Flask Mega-Tutorial, Part XVII: Deploying Under Linux</a></li>
<li><a href="../352268/index.html">Conference DEFCON 21. ‚ÄúThe secret life of SIM cards‚Äù. Eric Butler, Karl Kosher</a></li>
<li><a href="../352270/index.html">How to track file downloads from your site on WordPress</a></li>
<li><a href="../352272/index.html">Thymeleaf Tutorial: Chapter 13. Template text modes</a></li>
<li><a href="../352274/index.html">Critical vulnerability in Drupal core versions 6, 7 and 8</a></li>
<li><a href="../352278/index.html">IT Event Digest for April</a></li>
<li><a href="../352280/index.html">C ++ cycling for professionals</a></li>
<li><a href="../352282/index.html">Continuous Integration for Newbies</a></li>
<li><a href="../352292/index.html">Hitachi: how the Japanese sunk from chainsaws to modern storage systems</a></li>
<li><a href="../352294/index.html">How to create an ideal product roadmap and what is needed for this?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>