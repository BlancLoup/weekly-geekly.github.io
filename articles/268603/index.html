<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hello! Is it FreeSWITCH? Then we will check you</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the request of our readers, the open source project FreeSWITCH was taken for verification using PVS-Studio. It was originally founded by the develo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hello! Is it FreeSWITCH? Then we will check you</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cb8/a46/43e/cb8a4643efb749c18f78b4516c019fa9.png"><br>  At the request of our readers, the open source project FreeSWITCH was taken for verification using PVS-Studio.  It was originally founded by the developers of the project, Asterisk, which we have already tested.  The FreeSWITCH project is being actively developed and contains many interesting analyzer warnings, which will be described in the article. <br><a name="habracut"></a><br><h2>  Introduction </h2>  <a href="https://freeswitch.org/">FreeSWITCH</a> is an open source telephony platform designed to meet the need for voice or text-driven systems that scale from softphone to softswitch.  FreeSWITCH can be used as a switch, PBX, media gateway or media server for IVR applications using simple or XML scripts to control the call processing algorithm. <br><br>  Using the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> 5.29 analyzer, the FreeSWITCH project was easily tested in Visual Studio 2015. <br><br><h2>  If (bug) then find_copy_paste (); </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eac/046/460/eac04646021d5f41f30fb738408c2209.png"></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://www.viva64.com/ru/d/0197/">V593</a> Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  switch_channel.c 493 <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { SWITCH_STATUS_SUCCESS, SWITCH_STATUS_FALSE, SWITCH_STATUS_TIMEOUT, SWITCH_STATUS_RESTART, .... } <span class="hljs-keyword"><span class="hljs-keyword">switch_status_t</span></span>; SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">switch_status_t</span></span>) switch_channel_queue_dtmf(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">switch_status_t</span></span> status; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((status = switch_core_session_recv_dtmf(channel-&gt;session, dtmf) != SWITCH_STATUS_SUCCESS)) { <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> done; } .... }</code> </pre> <br>  The source of logical errors in the program may be an incorrectly written condition.  For example, in this code fragment, the priority of the comparison operator is higher than the priority of the assignment operator.  Thus, the result of a logical operation is stored in 'status', and not the result of the function switch_core_session_recv_dtmf ().  The code contains the goto transition operator, so the corrupted value of the 'status' variable can later be used anywhere. <br><br>  Unfortunately, there are many such places: <ul><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  switch_core_db.c 208 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  switch_core_db.c 211 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  switch_core_db.c 214 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  switch_core_db.c 217 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  switch_event.c 2986 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  switch_ivr.c 3905 </li><li>  V593 Consider reviewing the A = B == C 'kind.  The expression is calculated as the following: 'A = (B == C)'.  fsodbc.cpp 285 </li><li>  V593 Consider reviewing the A = B! = C 'kind.  The expression is calculated as the following: 'A = (B! = C)'.  mod_db.c 653 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0106/">V517</a> The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 141, 168. mod_easyroute.c 141 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> switch_status_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load_config</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (globals.db_dsn) { <span class="hljs-comment"><span class="hljs-comment">//&lt;== .... } else if (globals.db_dsn) { //&lt;== switch_log_printf(SWITCH_CHANNEL_LOG, SWITCH_LOG_CRIT, "Cannot Open ODBC Connection (did you enable it?!)\n"); } .... }</span></span></code> </pre> <br>  In the conditions cascade, the same variable ‚Äúglobals.db_dsn‚Äù is checked, therefore the message about unsuccessful connection to the database will not be logged. <br><br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  sofia_glue.c 552 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sofia_overcome_sip_uri_weakness</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strchr</span></span>(stripped, <span class="hljs-string"><span class="hljs-string">';'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (params) { new_uri = switch_core_session_sprintf(session, <span class="hljs-string"><span class="hljs-string">"...."</span></span>, uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>, stripped, sofia_glue_transport2str( transport), params, uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { new_uri = switch_core_session_sprintf(session, <span class="hljs-string"><span class="hljs-string">"...."</span></span>, uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>, stripped, sofia_glue_transport2str( transport), uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (params) { new_uri = switch_core_session_sprintf(session, <span class="hljs-string"><span class="hljs-string">"...."</span></span>, uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>, stripped, sofia_glue_transport2str( transport), params, uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { new_uri = switch_core_session_sprintf(session, <span class="hljs-string"><span class="hljs-string">"...."</span></span>, uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;"</span></span>, stripped, sofia_glue_transport2str( transport), uri_only ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>); } } .... }</code> </pre> <br>  A large piece of code containing a lot of identical text.  If there is no error, this code fragment can be cut in half, otherwise here is another forgotten copy-paste. <br><br>  <a href="http://www.viva64.com/ru/d/0194/">V590</a> Consider inspecting the '* data ==' '&amp;&amp; * data! =' \ 0 '' expression.  The expression is misprint.  mod_curl.c 306 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_json</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">switch_memory_pool_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pool, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (*data == <span class="hljs-string"><span class="hljs-string">' '</span></span> &amp;&amp; *data != <span class="hljs-string"><span class="hljs-string">'\0'</span></span>) { data++; } .... }</code> </pre> <br>  There is no error, but the expression is redundant, which can make it difficult to read the code.  Checking "* data! = '\ 0'" does not make sense.  Abbreviated code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (*data == <span class="hljs-string"><span class="hljs-string">' '</span></span>) { data++;</code> </pre><br>  <a href="http://www.viva64.com/ru/d/0265/">V646</a> Consider inspecting the application's logic.  It's possible that 'else' keyword is missing.  conference_api.c 1532 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch_status_t</span></span> conference_api_sub_vid_logo_img(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!strcasecmp(text, <span class="hljs-string"><span class="hljs-string">"allclear"</span></span>)) { switch_channel_set_variable(member-&gt;channel, <span class="hljs-string"><span class="hljs-string">"...."</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); member-&gt;video_logo = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!strcasecmp(text, <span class="hljs-string"><span class="hljs-string">"clear"</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//&lt;== member-&gt;video_logo = NULL; } else { member-&gt;video_logo = switch_core_strdup(member-&gt;pool, text); } .... }</span></span></code> </pre> <br>  From the code you can see that it was planned to write ‚Äúelse if '.  But apparently accidentally missed the keyword 'else' and this led to a change in the logic of the program. <br><br>  To understand the essence of the error, let's consider a simplified version of the code.  At the beginning of the correct option: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (A == <span class="hljs-number"><span class="hljs-number">1</span></span>) { X(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (A == <span class="hljs-number"><span class="hljs-number">2</span></span>) { Y(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Z(); }</code> </pre> <br>  Depending on the value of the variable A, one of the functions will be called: X, Y, or Z. Let's see what happens if we forget the 'else': <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (A == <span class="hljs-number"><span class="hljs-number">1</span></span>) { X(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (A == <span class="hljs-number"><span class="hljs-number">2</span></span>) { Y(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Z(); }</code> </pre> <br>  Now, if A is equal to one, then not only the function X, but also Z will be called! <br><br><h2>  Use of type SOCKET </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cb2/62d/8db/cb262d8dbb3d683ce9c97d6d1916ad62.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0220/">V605</a> Consider verifying the expression: context-&gt; curlfd&gt; - 1. An unsigned value is compared to the number -1.  mod_shout.c 151 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> SOCKET <span class="hljs-keyword"><span class="hljs-keyword">curl_socket_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">curl_socket_t</span></span> curlfd; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">free_context</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">shout_context_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *context)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context-&gt;curlfd &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { shutdown(context-&gt;curlfd, <span class="hljs-number"><span class="hljs-number">2</span></span>); context-&gt;curlfd = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } .... }</code> </pre> <br>  The SOCKET type is an unsigned type, so a comparison with a negative number is <a href="https://msdn.microsoft.com/ru-ru/library/windows/desktop/ms740128%2528v%3Dvs.85%2529.aspx">not allowed</a> .  In this case, it is necessary to perform a comparison with special named constants for working with the SOCKET type, for example, SOCKET_ERROR, etc. <br><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression is always false.  Unsigned type value is never &lt;0. esl.c 690 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> SOCKET <span class="hljs-keyword"><span class="hljs-keyword">ws_socket_t</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ws_socket_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_socket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ips_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ips)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">ws_socket_t</span></span> sock = ws_sock_invalid; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((sock = socket(family, SOCK_STREAM, IPPROTO_TCP)) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { die(<span class="hljs-string"><span class="hljs-string">"Socket Error!\n"</span></span>); } .... }</code> </pre> <br>  A similar example of incorrect work with variables of type SOCKET.  This is an unsigned type, and there are specially defined constants to check the error status, for example, SOCKET_ERROR. <br><br><h2>  Double assignments </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb8/0e7/8a0/eb80e78a0260139409d21e4bd7ad901d.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0168/">V570</a> The variable is assigned to itself.  skypopen_protocol.c 1512 <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SkypopenHandles</span></span></span><span class="hljs-class"> {</span></span> HWND win32_hInit_MainWindowHandle; HWND win32_hGlobal_SkypeAPIWindowHandle; .... }; <span class="hljs-function"><span class="hljs-function">LRESULT APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">skypopen_present</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., WPARAM uiParam, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tech_pvt-&gt;SkypopenHandles.currentuserhandle) { tech_pvt-&gt;SkypopenHandles.api_connected = <span class="hljs-number"><span class="hljs-number">1</span></span>; tech_pvt-&gt;SkypopenHandles.win32_hGlobal_SkypeAPIWindowHandle = (HWND) uiParam; tech_pvt-&gt;SkypopenHandles.win32_hGlobal_SkypeAPIWindowHandle = tech_pvt-&gt;SkypopenHandles.win32_hGlobal_SkypeAPIWindowHandle; } .... }</code> </pre> <br>  The analyzer has detected that a variable is assigned to itself.  It can be assumed that during the writing of the code, the wrong structure field was randomly selected in the second assignment: ‚Äûwin32_hGlobal_SkypeAPIWindowHandle‚Äú instead of ‚Äûwin32_hInit_MainWindowHandle‚Äú. <br><br>  Perhaps the function code should be like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tech_pvt-&gt;SkypopenHandles.currentuserhandle) { tech_pvt-&gt;SkypopenHandles.api_connected = <span class="hljs-number"><span class="hljs-number">1</span></span>; tech_pvt-&gt;SkypopenHandles.win32_hGlobal_SkypeAPIWindowHandle = (HWND) uiParam; tech_pvt-&gt;SkypopenHandles. win32_hInit_MainWindowHandle = tech_pvt-&gt;SkypopenHandles.win32_hGlobal_SkypeAPIWindowHandle; }</code> </pre><br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'status' variable is assigned twice twice successively.  Perhaps this is a mistake.  Check lines: 365, 368. fscoredb.cpp 368 <br><pre> <code class="cpp hljs">JS_COREDB_FUNCTION_IMPL(BindInt) { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> status; .... <span class="hljs-comment"><span class="hljs-comment">/* convert args */</span></span> status = !info[<span class="hljs-number"><span class="hljs-number">0</span></span>].IsEmpty() &amp;&amp; info[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;IsInt32() ? <span class="hljs-literal"><span class="hljs-literal">true</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>; param_index = info[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;Int32Value(); status = !info[<span class="hljs-number"><span class="hljs-number">1</span></span>].IsEmpty() &amp;&amp; info[<span class="hljs-number"><span class="hljs-number">1</span></span>]-&gt;IsInt32() ? <span class="hljs-literal"><span class="hljs-literal">true</span></span>:<span class="hljs-literal"><span class="hljs-literal">false</span></span>; param_value = info[<span class="hljs-number"><span class="hljs-number">1</span></span>]-&gt;Int32Value(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (param_index &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { info.GetIsolate()-&gt;ThrowException(....); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } .... }</code> </pre> <br>  The analyzer detected a potential error related to the fact that the same variable is assigned a value twice in a row.  And between these assignments the variable itself is not used.  Using the analyzer, it was possible to find the missed check: the value of the 'status' variable is not used anywhere. <br><br>  Perhaps the code should be like this: <br><pre> <code class="cpp hljs">.... param_index = status ? info[<span class="hljs-number"><span class="hljs-number">0</span></span>]-&gt;Int32Value() : <span class="hljs-number"><span class="hljs-number">0</span></span>; .... param_value = status ? info[<span class="hljs-number"><span class="hljs-number">1</span></span>]-&gt;Int32Value() : <span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The 'status' variable is assigned twice twice successively.  Perhaps this is a mistake.  Check lines: 1239, 1240. switch_core_io.c 1240 <br><pre> <code class="cpp hljs">SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">switch_status_t</span></span>) switch_core_session_write_frame(...., <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stream_id) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptime_mismatch &amp;&amp; status != SWITCH_STATUS_GENERR) { status = perform_write(session, frame, flags, stream_id); status = SWITCH_STATUS_SUCCESS; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> error; } .... }</code> </pre> <br>  Why here the status of the record is simply overwritten on the successful is not clear.  Let's leave the study of this fragment to the authors of the code. <br><br><h2>  Errors in strings </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/081/13f/f7a/08113ff7a4bc2d2e2ed5806a1ef1a0c4.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0330/">V694</a> The condition (mode + 5) is only false if there is a pointer overflow which is undefined behavior anyway.  mod_ilbc.c 51 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> switch_status_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">switch_ilbc_fmtp_parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fmtp &amp;&amp; (mode = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(fmtp, <span class="hljs-string"><span class="hljs-string">"mode="</span></span>)) &amp;&amp; (mode + <span class="hljs-number"><span class="hljs-number">5</span></span>)) { codec_ms = atoi(mode + <span class="hljs-number"><span class="hljs-number">5</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!codec_ms) { <span class="hljs-comment"><span class="hljs-comment">/* default to 30 when no mode is defined for ilbc ONLY */</span></span> codec_ms = <span class="hljs-number"><span class="hljs-number">30</span></span>; } .... }</code> </pre> <br>  At first glance, a simple algorithm is implemented here: <ol><li>  Find the substring "mode ="; </li><li>  Make sure that there is no null character after the substring; </li><li>  Convert the next character to a number. </li></ol>  The error lies in the stage N2: making sure that the 'mode' pointer to the substring is non-zero, the code shifts the pointer to 5 characters, but it will remain non-zero.  In operation (mode + 5) the dereferencing of the shifted pointer is missing.  Because of such an error, situations are possible when the terminator is converted to a number and get a value of zero.  Thanks to the ‚Äúif (! Codec_ms) {codec_ms = 30;}‚Äú check, the zero value is always reset to the default value. <br><br>  <a href="http://www.viva64.com/ru/d/0108/">V519</a> The '* e' variable is assigned values ‚Äã‚Äãtwice successively.  Perhaps this is a mistake.  Check lines: 1438, 1439. switch_xml.c 1439 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">preprocess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((e = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(tcmd, <span class="hljs-string"><span class="hljs-string">"/&gt;"</span></span>))) { *e += <span class="hljs-number"><span class="hljs-number">2</span></span>; *e = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fwrite(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(e), write_fd) != (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(e)) { switch_log_printf(....); } } .... }</code> </pre> <br>  And in this place an error occurs as in the previous example, just the opposite.  Here, if the substring is found, they plan to move the pointer and write the end-of-line character, but in the ‚Äú* e + = 2‚Äù operation, it is not the pointer that changes, but the character code to which it points.  Then the terminal zero is simply written to this character. <br><br>  The correct code looks like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((e = <span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(tcmd, <span class="hljs-string"><span class="hljs-string">"/&gt;"</span></span>))) { e += <span class="hljs-number"><span class="hljs-number">2</span></span>; *e = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0211/">V600</a> Consider inspecting the condition.  The 'name' pointer is not always equal to NULL.  fsodbc.cpp 323 <br><pre> <code class="cpp hljs">JS_ODBC_FUNCTION_IMPL(GetData) { .... SQLCHAR name[<span class="hljs-number"><span class="hljs-number">1024</span></span>] = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-comment"><span class="hljs-comment">//&lt;== SQLCHAR *data = _colbuf; SQLLEN pcbValue; SQLDescribeCol(_stmt, x, name, sizeof(name), ....); //&lt;== SQLGetData(_stmt, x, SQL_C_CHAR, _colbuf, _cblen, &amp;pcbValue); if (name) { //&lt;== if (SQL_NULL_DATA == pcbValue) { arg-&gt;Set(String::NewFromUtf8(GetIsolate(), (const char *)name), Null(info.GetIsolate())); } else { arg-&gt;Set(String::NewFromUtf8(GetIsolate(), (const char *)name), String::NewFromUtf8(GetIsolate(), data ? (const char *)data : "")); } } .... }</span></span></code> </pre> <br>  This function allocates memory on the stack for the character array "name".  The zero character is written to the beginning and some actions are performed with the array.  In the condition ‚Äûif (name) {....} they wanted to check whether the string remained empty (the sign is the zero character at the beginning of the string).  But because of the missed pointer dereference character, the value of the pointer, which is always non-zero, is checked. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a>  Check lines: 2496, 2499. switch_ivr.c 2496 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">switch_ivr_set_xml_chan_var</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *val, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> off)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *data; <span class="hljs-keyword"><span class="hljs-keyword">switch_size_t</span></span> dlen = <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(val) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//&lt;== switch_xml_t variable; if (!val) val = ""; //&lt;== .... }</span></span></code> </pre> <br>  A zero pointer to the ‚Äúval‚Äù character array can come into the function, which is indicated by the presence of a check.  But before that, such a pointer will be passed to the ‚Äústrlen ()‚Äù function to calculate the length of the string where the null pointer dereference will be performed. <br><br><h2>  Dangerous Signs </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eb2/dbe/607/eb2dbe6079fa4b4b89d7121d91298c70.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0354/">V713</a> The pointer codec-&gt; cur_frame was used in the same logical expression.  mod_opus.c 631 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> switch_status_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">switch_opus_decode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">switch_codec_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *codec, ....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (opus_packet_get_bandwidth(codec-&gt;cur_frame-&gt;data) != <span class="hljs-comment"><span class="hljs-comment">//&lt;== OPUS_BANDWIDTH_FULLBAND &amp;&amp; codec-&gt;cur_frame &amp;&amp; //&lt;== (jb = switch_core_session_get_jb(....))) { .... } .... }</span></span></code> </pre> <br>  It was not easy, but the analyzer found a potential dereference of the null pointer.  Problem due to incorrect order of logical expressions in condition.  First, the ‚Äúcodec-&gt; cur_frame-&gt; data‚Äù variable is used, and then the ‚Äúcodec-&gt; cur_frame‚Äù pointer is checked for equality to zero. <br><br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'a_engine' pointer was used before it was verified against nullptr.  Check lines: 6024, 6052. switch_core_media.c 6024 <br><pre> <code class="cpp hljs">SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">switch_status_t</span></span>) switch_core_media_activate_rtp(<span class="hljs-keyword"><span class="hljs-keyword">switch_core_session_t</span></span> *session) { .... <span class="hljs-keyword"><span class="hljs-keyword">switch_port_t</span></span> remote_rtcp_port = a_engine-&gt;remote_rtcp_port; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (session &amp;&amp; a_engine) { check_dtls_reinvite(session, a_engine); } .... }</code> </pre> <br>  Unlike the <a href="http://www.viva64.com/ru/d/0354/">V713</a> diagnostic, the <a href="http://www.viva64.com/ru/d/0354/">V595</a> diagnostic looks for a potential null pointer dereference within all functions.  Notice how the "a_engine" pointer is used. <br><br>  Another list of dangerous places: <ul><li>  V595 The 'session' pointer has been verified against nullptr.  Check lines: 6027, 6052. switch_core_media.c 6027 </li><li>  V595 The 'session' pointer has been verified against nullptr.  Check lines: 6689, 6696. switch_core_media.c 6689 </li><li>  V595 The 'v_engine' pointer was used before it was verified against nullptr.  Check lines: 6677, 6696. switch_core_media.c 6677 </li><li>  V595 The 'stream.data' pointer was used before it was verified against nullptr.  Check lines: 2409, 2411. switch_event.c 2409 </li><li>  V595 The 'stack' pointer was used against it.  Check lines: 461, 466. switch_ivr_menu.c 461 </li><li>  V595 The 'smin' pointer was used before it was verified nullptr.  Check lines: 3269, 3277. switch_utils.c 3269 </li><li>  V595 The 'key' pointer was used against it.  Check lines: 111, 124. switch_xml.c 111 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'fftstate-&gt; Perm == ((void *) 0)' is always false.  Pointer 'fftstate-&gt; Perm'! = NULL.  fft.c <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SpaceAlloced; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MaxPermAlloced; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Tmp0[MAXFFTSIZE]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Tmp1[MAXFFTSIZE]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Tmp2[MAXFFTSIZE]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Tmp3[MAXFFTSIZE]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Perm[MAXFFTSIZE]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> factor [NFACTOR]; } FFTstr; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FFTRADIX</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...., FFTstr *fftstate)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fftstate-&gt;Tmp0 == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || fftstate-&gt;Tmp1 == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || fftstate-&gt;Tmp2 == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || fftstate-&gt;Tmp3 == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> || fftstate-&gt;Perm == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } .... }</code> </pre> <br>  There is a large, but meaningless condition in the code in which the addresses of 5 arrays that are members of the FFTstr class are checked.  It does not matter if a class object or heap was created on the stack.  The addresses of arrays will always be different from zero.  Even if the 'fftstate' pointer is 0, the checks are still meaningless, as the Tmp0..Tmp3 members are offset from the beginning of the structure. <br><br><h2>  Double protection </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8c7/831/838/8c783183811ad4a93e71301c72b86057.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0119/">V530</a> The return value of the function 'LoadLibraryExA' is required to be utilized.  switch_dso.c 42 <br><br>  <a href="http://www.viva64.com/ru/d/0183/">V581</a> The conditional expressions of the 'if' are located alongside each other are identical.  Check lines: 41, 45. switch_dso.c 45 <br><pre> <code class="cpp hljs">SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">switch_dso_lib_t</span></span>) switch_dso_open(....) { HINSTANCE lib; lib = LoadLibraryEx(path, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lib) { LoadLibraryEx(path, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, LOAD_WITH_ALTERED_SEARCH_PATH); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lib) { DWORD error = GetLastError(); *err = switch_mprintf(<span class="hljs-string"><span class="hljs-string">"dll open error [%ul]\n"</span></span>, error); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lib; }</code> </pre> <br>  An interesting situation arose on this code fragment, when 2 different diagnostics of the analyzer worked in one place.  In V530, it says that the ‚ÄúLoadLibraryEx ()‚Äù function does not use a return value, and in V581 it says that there are 2 checks with the same logical expression. <br><br>  The first check of the ‚Äúlib‚Äù descriptor checks the loading of the module by the ‚ÄúLoadLibraryEx ()‚Äù function; if the descriptor is zero, then you should try to load the module again.  At this point, they forget to overwrite the 'lib' descriptor with the new value returned by the function, and during the second check the descriptor still remains zero. <br><br>  The correct code snippet is: <br><pre> <code class="cpp hljs">lib = LoadLibraryEx(path, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!lib) { lib = LoadLibraryEx(path, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, LOAD_WITH_ALTERED_SEARCH_PATH); }</code> </pre> <br><h2>  About memory </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8b0/f93/036/8b0f930363328e5666497f0c420f6a41.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0208/">V597</a> The compiler couldn‚Äôt need the function call, which is used to flush ‚ÄôcorrSurfBuff‚Äô buffer.  The RtlSecureZeroMemory () function should be used to erase the private data.  pitch_estimator.c 158 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebRtcIsac_InitializePitch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> old_lag, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> old_gain, PitchAnalysisStruct *State, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *lags)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>*PITCH_BW+<span class="hljs-number"><span class="hljs-number">3</span></span>; k++) { CorrSurf[k] = &amp;corrSurfBuff[<span class="hljs-number"><span class="hljs-number">10</span></span> + k * (PITCH_LAG_SPAN2+<span class="hljs-number"><span class="hljs-number">4</span></span>)]; } <span class="hljs-comment"><span class="hljs-comment">/* reset CorrSurf matrix */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(corrSurfBuff, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) * (<span class="hljs-number"><span class="hljs-number">10</span></span> + (<span class="hljs-number"><span class="hljs-number">2</span></span>*PITCH_BW+<span class="hljs-number"><span class="hljs-number">3</span></span>) * (PITCH_LAG_SPAN2+<span class="hljs-number"><span class="hljs-number">4</span></span>))); .... }</code> </pre> <br>  The code above may leave the matrix uncleaned.  Note that the ‚ÄúcorrSurfBuff‚Äù array is cleared at the end and is no longer used.  Therefore, when building the Release version of a program, the compiler will most likely remove the memset () function call.  The compiler has every right to do this.  The analyzer suggests using the RtlSecureZeroMemory () function for Windows, but since the project is cross-platform, you should find another way to avoid optimizing other compilers. <br><br>  Note.  This is not paranoia.  The compiler really removes such function calls.  Read the description of the V597 diagnostic to understand the depth of the rabbit hole.  For non-believers, even an assembler listing is provided.  This is a serious and unfortunately very common security error. <br><br>  <a href="http://www.viva64.com/ru/d/0340/">V701</a> realloc () possible leak: when realloc () fails in allocating memory, the original pointer 'abuf' is lost.  Consider assigning realloc () to a temporary pointer.  switch_ivr_play_say.c 1535 <br><pre> <code class="cpp hljs">SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">switch_status_t</span></span>) switch_ivr_play_file(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buflen &gt; write_frame.buflen) { abuf = <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(abuf, buflen); write_frame.data = abuf; write_frame.buflen = buflen; } .... }</code> </pre> <br>  This code is potentially dangerous: it is recommended to save the result of the realloc () function in another variable.  The realloc () function changes the size of a block of memory.  If it is not possible to change the size of the memory block at the moment, the function will return a null pointer.  The main problem is that when using a construction like "ptr = realloc (ptr, ...)" the ptr pointer to this data block can be lost. <br><br>  More places like this: <ul><li>  V701 realloc () possible leak: when realloc () fails in allocating memory, the original pointer 'buf' is lost.  Consider assigning realloc () to a temporary pointer.  switch_event.c 1556 </li><li>  V701 realloc () possible leak: when realloc () fails in allocating memory, the original pointer 'buf' is lost.  Consider assigning realloc () to a temporary pointer.  switch_event.c 1582 </li></ul><br><h2>  The remaining warnings </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/41a/2a8/c02/41a2a8c0274373778f83d7c94afe3806.png"></div><br><br>  <a href="http://www.viva64.com/ru/d/0290/">V665</a> Possibly, the usage of #pragma warning (default: X) 'is incorrect in this context.  The '#pragma warning (push / pop)' should be used instead.  Check lines: 802, 837. switch_utils.h 837 <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _MSC_VER #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(disable:6011) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> static inline char *switch_lc_strdup(const char *it) { .... } static inline char *switch_uc_strdup(const char *it) { .... } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _MSC_VER #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(default:6011) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  Programmers often believe that after the ‚Äúpragma warning (default: X)‚Äù directive, the warnings will again take effect, previously disabled using the ‚Äúpragma warning (disable: X)‚Äù.  This is not true.  The 'pragma warning (default: X)' directive sets the warning with the number 'X' to the state that is valid DEFAULT.  This is not the same thing. <br><br>  The correct code is: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(push) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">warning</span></span></span><span class="hljs-meta">(disable: 6011) .... </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Correct code triggering the 6011 warning .... #pragma warning(pop)</span></span></span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0146/">V555</a> The expression 'parser-&gt; maxlen - parser-&gt; minlen&gt; 0' will work as 'parser-&gt; maxlen! = Parser-&gt; minlen'.  switch_ivr.c 2342 <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">switch_size_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch_size_t</span></span> maxlen; <span class="hljs-keyword"><span class="hljs-keyword">switch_size_t</span></span> buflen; <span class="hljs-keyword"><span class="hljs-keyword">switch_size_t</span></span> minlen; SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *) switch_ivr_digit_stream_parser_feed(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parser-&gt;maxlen - parser-&gt;minlen &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; ....) { len = <span class="hljs-number"><span class="hljs-number">0</span></span>; } .... }</code> </pre> <br>  The difference between unsigned numbers is always greater than zero if they are not equal.  So here is the error or meant checking 'parser-&gt; maxlen! = Parser-&gt; minlen'? <br><br>  <a href="http://www.viva64.com/ru/d/0228/">V612</a> An unconditional 'goto' within a loop.  mod_verto.c 112 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">json_cleanup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ .... top: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (hi = switch_core_hash_first_iter(....); hi;) { switch_core_hash_this(hi, &amp;var, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, &amp;val); json = (cJSON *) val; cJSON_Delete(json); switch_core_hash_delete(json_GLOBALS.store_hash, var); <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> top; } switch_safe_free(hi); switch_mutex_unlock(json_GLOBALS.store_mutex); }</code> </pre> <br>  In the project source code, unconditional jump operators are used in several places, which makes it difficult to read and maintain the code, especially when used in loops. <br><br>  A few more places: <ul><li>  V612 An unconditional 'break' within a loop.  mod_event_socket.c 1643 </li><li>  V612 An unconditional 'goto' within a loop.  mod_verto.c 328 </li><li>  V612 An unconditional 'break' within a loop.  mod_verto.c 1993 </li></ul><br>  <a href="http://www.viva64.com/ru/d/0272/">V652</a> The '!'  3 or more times in succession.  mod_verto.c 3032 <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> switch_bool_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verto__modify_func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... switch_core_media_toggle_hold(session, !!!switch_channel_test_flag(tech_pvt-&gt;channel, ....)); .... }</code> </pre> <br>  An incomprehensible place with the use of as many as three negation operators, perhaps there is a typo. <br><br>  <a href="http://www.viva64.com/ru/d/0162/">V567</a> Unspecified behavior.  Evaluation order is not defined for 'strtol' function.  Consider inspecting the 'exp' variable.  switch_utils.c 3759 <br><pre> <code class="cpp hljs">SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) switch_number_cmp(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> val) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;; ++<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = strtol(<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **)&amp;<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span> != <span class="hljs-string"><span class="hljs-string">'-'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a == val) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = strtol(++<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **)&amp;<span class="hljs-built_in"><span class="hljs-built_in">exp</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">//&lt;== .... } if (*exp != ',') return 0; } }</span></span></code> </pre> <br>  It is not known whether the 'exp' pointer will be changed first or its address will be taken.  Accordingly, the expression works correctly or not, depends on luck. <br><br>  <a href="http://www.viva64.com/ru/d/0238/">V621</a> Consider inspecting the 'for' operator.  It is possible that you will not be executed at all.  switch_core.c 3014 <br><pre> <code class="cpp hljs">SWITCH_DECLARE(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) switch_max_file_desc(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> max = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//&lt;== #ifndef WIN32 #if defined(HAVE_GETDTABLESIZE) max = getdtablesize(); #else max = sysconf(_SC_OPEN_MAX); #endif #endif return max; } SWITCH_DECLARE(void) switch_close_extra_files(....) { int open_max = switch_max_file_desc(); int i, j; for (i = 3; i &lt; open_max; i++) { //&lt;== .... close(i); skip: continue; } }</span></span></code> </pre> <br>  It is not known whether this is an error or not, but the analyzer found a stub code for Windows in the ‚Äúswitch_max_file_desc ()‚Äù function.  If this function always returns zero in Windows, the loop after its call is never executed. <br><br><h2>  Conclusion </h2>  In the article, I talked about the most suspicious parts of the FreeSWITCH project code, in my opinion, found using the PVS-Studio static analyzer.  This is another project related to computer telephony, as I once tested a similar <a href="http://www.viva64.com/ru/b/0276/">Asterisk</a> project.  The FreeSWITCH project is quite large and many interesting warnings were issued by the analyzer, although there were even more warnings to the used libraries in this project, but this is another story.  Prior to the publication of the article, the developers were already notified of the verification of their project and received a full report of the analyzer.  Therefore, some parts of the code can be corrected. <br><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0351/">Hello, Is That FreeSWITCH?</a>  <a href="http://www.viva64.com/en/b/0351/">Then We're Coming to Check You!</a>  . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0351/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected the answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/268603/">https://habr.com/ru/post/268603/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268585/index.html">Go Benchmarks</a></li>
<li><a href="../268587/index.html">Blocks. The internal structure of the Cach√© database file. Part 3</a></li>
<li><a href="../268593/index.html">Huawei and NTT DOCOMO successfully tested 5G technology in the field</a></li>
<li><a href="../268597/index.html">Mobile communications in Europe</a></li>
<li><a href="../268599/index.html">Enable HTTP / 2 in NGINX for the site</a></li>
<li><a href="../268605/index.html">Primary key - GUID or autoincrement? Part two</a></li>
<li><a href="../268607/index.html">Volker Simonis - Interiors of SAP JVM [Meeting JUG in St. Petersburg]</a></li>
<li><a href="../268609/index.html">Rust in details: we write scalable chat from scratch, part 1</a></li>
<li><a href="../268611/index.html">The digest of interesting materials for the mobile # 124 developer (October 5-11)</a></li>
<li><a href="../268613/index.html">Using hardlinks (hardlink) for Synology DSM incremental backup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>