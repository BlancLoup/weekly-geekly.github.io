<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Domain Driven Design in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evans wrote a good book with good ideas. But these ideas lack a methodological basis. Experienced developers and architects, on an intuitive level, un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Domain Driven Design in practice</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/webt/mc/xv/xx/mcxvxx5zbueqfamfftgldnyupx4.png">  Evans wrote a <a href="https://www.ozon.ru/context/detail/id/5497184/">good book</a> with good ideas.  But these ideas lack a methodological basis.  Experienced developers and architects, on an intuitive level, understand that you need to be as close as possible to the customer‚Äôs domain, and you need to talk to the customer.  But it is not clear how to evaluate the project for compliance with the Ubiquitous Language and the customer's real language?  How to understand that the domain is divided into Bounded Context correctly?  How generally to define DDD in the project is used or not? <br><br>  The last point is especially relevant.  In one of his speeches, Greg Young asked those who practice DDD to raise their hands.  And then I asked to omit those who create classes with a set of public getters and setters, have logic in the ‚Äúservices‚Äù and ‚Äúhelpers‚Äù and call it DDD.  A chuckle passed through the hall :) <br><br>  How to structure business logic in DDD style?  Where to store the "behavior": in services, entities, extension-methods or everywhere a little bit?  In the article I will talk about how to design the subject area and what rules I use. <br><a name="habracut"></a><br><h2>  All people are lying </h2><br><img align="right" src="https://habrastorage.org/webt/6c/fh/ty/6cfhty-ssjpgtzcz2xl-eaadua4.png">  Not specifically of course :) The fact is that business applications are created for a wide range of tasks and to satisfy the interests of various groups of users.  At best, only top management understands business processes from start to finish.  Not rarely misunderstand, by the way.  Inside the subdivision, users see only a certain part.  Therefore, the result of interviewing all stakeholders usually becomes a tangle of contradictions.  The following follows from this rule. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  First, analytics, then design, and only then - development </h2><br><img align="left" src="https://habrastorage.org/files/2b1/eea/d27/2b1eead27a6a45b4927002fb06797ec3.jpg">  You need to start not from the database structure or set of classes, but from business processes.  We use BPMN and UML Activity in conjunction with <a href="https://habrahabr.ru/post/166747/">test cases</a> .  Charts are well read even by those who are not familiar with the standards.  Test cases in tabular form help to better identify the boundary cases and eliminate inconsistencies. <br><br>  Abstract talk is just a waste of time.  People are convinced that the details are not significant and "there is no need to discuss them at all, because everything is already clear."  Please fill in the table of test cases clearly shows that the options are not really 3 and 26 (this is not an exaggeration, but the result of analytics on one of our projects). <br><br>  Tables and charts - the main tool for communication between business, analytics and development.  In parallel with the compilation of BPMN diagrams and test case tables, we are starting to write terms into the <a href="https://habrahabr.ru/post/232881/">project‚Äôs thesis</a> .  The dictionary will help later for the design of entities. <br><br><h2>  Select contexts </h2><br><img width="350" align="right" src="https://habrastorage.org/webt/ph/b0/1a/phb01a61skk0baii2mr9udyxtvy.png">  A single subject model for the entire application can be created only if the policy of using a single consistent language throughout the organization is adopted and implemented at the top management level.  Those.  when the sales department says ‚Äúaccount production‚Äù, they both understand the word in the same way.  This is the same account, not "account in CRM" and "legal entity. Client." <br><br>  In real life, I have not seen this.  Therefore, it is desirable to immediately roughly "cut" the subject model into <a href="https://habrahabr.ru/post/232881/">several parts</a> .  The less they are connected, the better.  Usually, it still turns out to grope some set of common terms.  I call this the core of the domain.  Any context may depend on the kernel.  It is highly desirable to avoid dependencies between contexts.  Potentially, this approach leads to a ‚Äúswelling‚Äù of the core, but the mutual dependence of contexts gives rise to a strong connectivity, which is worse than a ‚Äúthick‚Äù core. <br><br><h2>  Architecture </h2><br><img src="https://habrastorage.org/web/bb3/430/769/bb3430769e6c4e8fbca757a8bc071f2e.png"><br>  Ports and adapters, <a href="https://habrahabr.ru/post/233747/">onion architecture</a> , <a href="https://www.youtube.com/watch%3Fv%3DlZq8Jlq18Ec">clean architecture</a> - all of these approaches are based on the idea of ‚Äã‚Äãusing a <a href="https://habrahabr.ru/post/344164/">domain as the core of an application</a> .  Evans casually touches on this question when he talks about the ‚Äúdomain‚Äù and ‚Äúinfrastructure‚Äù.  Business logic does not use the terms ‚Äútransaction‚Äù, ‚Äúdatabase‚Äù, ‚Äúcontroller‚Äù, ‚Äúlazy load‚Äù, etc.  n-layer - the architecture does not allow to spread these concepts.  The request will be sent to the controller, transferred to the ‚Äúbusiness logic‚Äù, and the ‚Äúbusiness logic‚Äù will interact with the <code>DAL</code> .  And <code>DAL</code> is a solid "transaction", "table", "lock", etc.  Clean Architecture allows you to invert dependencies and separate flies from cutlets.  Of course completely abstract from the details of the implementation will not work.  RDBMS, ORM, network interaction will still impose its limitations.  But in the case of using <code>Clean Architecture</code> this can be controlled.  In <code>n-layer</code> sticking to a ‚Äúsingle language‚Äù is much more difficult because of the storage structure on the bottom layer. <br><br>  <code>Clean Architecture</code> works well with <code>Bounded Context.</code>  Different contexts may represent different subsystems.  Simple contexts are best implemented using simple <code>CRUD</code> .  For asymmetric load contexts, <a href="https://habrahabr.ru/post/347908/">CQRS is</a> well suited.  For subsystems requiring Audit Log, it makes sense to use Event Sourcing.  For the subsystems loaded for reading and writing with limitations on bandwidth and latency, it makes sense to consider an event driven approach.  At first glance, this may seem inconvenient.  For example, I worked with the <code>CRUD</code> subsystem and I received a task from the <code>CQRS</code> subsystem.  It will take some time to look at all these <code>Command</code> and <code>Query</code> as a new gate.  The alternative - to design a system in the same style - is short-sighted.  Architecture is a set of tools, and each tool is suitable for solving a specific problem. <br><br><h2>  Project structure </h2><br>  I structure the .NET projects as follows: <br><br><pre> <code class="hljs pgsql">/App /ProjectName.Web.<span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> /ProjectName.Web.<span class="hljs-keyword"><span class="hljs-keyword">Admin</span></span> /ProjectName.Web.SomeOtherStuff /<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span> /ProjectName.<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>.Core /ProjectName.<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>.BoundedContext1 /ProjectName.<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>.BoundedContext1.Services /ProjectName.<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>.BoundedContext2 /ProjectName.<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>.BoundedContext2.Command /ProjectName.<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>.BoundedContext2.Query /ProjectName.<span class="hljs-keyword"><span class="hljs-keyword">Domain</span></span>.BoundedContext3 /Data /ProjectName.Data /Libs /Problem1Resolver /Problem2Resolver</code> </pre><br>  Projects from the <code>Libs</code> folder do not depend on the domain.  They only solve their local problem, for example, generating reports, parsing csv, caching mechanisms, etc.  The domain structure corresponds to the <code>BoundedContext'</code> .  Projects from the <code>Domain</code> folder are independent of <code>Data</code> .  <code>Data</code> contains <code>DbContext</code> , migrations, configurations related to DAL.  <code>Data</code> depends on <code>Domain</code> entities for building migrations.  Projects from the <code>App</code> folder use an IOC container to inject dependencies.  Thus it turns out to achieve maximum isolation of the domain code from the infrastructure. <br><br><h2>  Model entities </h2><br>  By an entity, we mean an object of the domain that has a unique identifier.  For example, let's take a class describing a Russian company in the context of obtaining accreditation in a certain department. <br><br><pre> <code class="css hljs"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[DisplayName("  ()")]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Company</span></span> : <span class="hljs-selector-tag"><span class="hljs-selector-tag">LongIdBase</span></span> , <span class="hljs-selector-tag"><span class="hljs-selector-tag">IHasState</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">CompanyState</span></span>&gt; { public static class Specs { public static Spec&lt;Supplier&gt; ByInnAndKpp(string inn, string kpp) =&gt; new Spec&lt;Supplier&gt;(x =&gt; x.Inn == inn &amp;&amp; x.Kpp == kpp); public static Spec&lt;Supplier&gt; ByInn(string inn) =&gt; new Spec&lt;Supplier&gt;(x =&gt; x.Inn == inn); } //  <span class="hljs-selector-tag"><span class="hljs-selector-tag">EF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">protected</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Company</span></span> () { } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Company</span></span> (<span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inn</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kpp</span></span>) { DangerouslyChangeInnAndKpp(inn, kpp); } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">void</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DangerouslyChangeInnAndKpp</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inn</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kpp</span></span>) { Inn = inn.NullIfEmpty() ?? throw new ArgumentNullException(nameof(inn)); Kpp = kpp.NullIfEmpty() ?? throw new ArgumentNullException(nameof(kpp)); this.ValidateProperties(); } <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Display(Name = "")]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Required]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[DisplayFormat(ConvertEmptyStringToNull = true)]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Inn]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Inn</span></span> { get; protected set; } <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Display(Name = "")]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[DisplayFormat(ConvertEmptyStringToNull = true)]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Kpp]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Kpp</span></span> { get; protected set; } <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Display(Name = " ")]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CompanyState</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">State</span></span> { get; protected set; } <span class="hljs-selector-attr"><span class="hljs-selector-attr">[DisplayFormat(ConvertEmptyStringToNull = true)]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Comment</span></span> { get; protected set; } <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Display(Name = "  ")]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DateTime</span></span>? <span class="hljs-selector-tag"><span class="hljs-selector-tag">StateChangeDate</span></span> { get; protected set; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">void</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Accept</span></span>() { StateChangeDate = DateTime.UtcNow; State = AccreditationState.Accredited; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">void</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Decline</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">comment</span></span>) { StateChangeDate = DateTime.UtcNow; State = AccreditationState.Declined; Comment = comment.NullIfEmpty() ?? throw new ArgumentNullException(nameof(comment)); }</code> </pre><br>  In order to choose the right units and relationships, often one iteration is not enough.  First, I cover the basic structure of classes, define one-to-one, one-to-many, and many-to-many relationships and describe the data structure.  Then I trace the structure by business process, referring to the BMPN and test cases.  If some case does not fit into the structure, then an error is made in the design and the structure must be changed.  The resulting structure can be arranged in the form of a diagram and further coordinated with experts in the subject area. <br><br>  Experts may point out errors and inaccuracies in the design.  Sometimes in the process it turns out that for some entities there is no suitable term.  Then I offer options and after a while is suitable.  A new term is introduced into the thesis.  It is very important to discuss and agree on terminology together.  This eliminates a large amount of misunderstanding problems in the future. <br><br><h2>  Choosing a unique identifier </h2><br>  Fortunately, Evans makes clear recommendations on this: first we look for an identifier in the subject area: TIN, CAT, passport details, etc.  If found - use it.  Did not find - rely on <code>GUID</code> or <code>Id</code> generated by database.  Sometimes it is advisable to use as an Id identifier other than the domain, even if the latter exists.  For example, if the entity must be versioned and the system must store all previous versions, or if the identifier from the subject model is a complex composite and is not friendly with persistance. <br><br><h2>  Real designers </h2><br>  To materialize ORM objects, reflection is most often used.  EF will be able to reach the protected constructor, but programmers will not.  They will have to create a correct legal entity.  person identified by TIN and KPP.  The designer is supplied with guards.  Creating an incorrect object simply will not work.  The <code>ValidateProperties</code> extension method validates against <code>DataAnnotation</code> attributes, but <code>NullIfEmpty</code> does not allow you to pass empty strings. <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Extensions</span></span> { public static void ValidateProperties(this object obj) { var context = new ValidationContext(obj); Validator.ValidateObject(obj, context, true); } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NullIfEmpty</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">this</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span>) =&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">string</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.IsNullOrEmpty</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span>) ? <span class="hljs-selector-tag"><span class="hljs-selector-tag">null</span></span> : <span class="hljs-selector-tag"><span class="hljs-selector-tag">str</span></span>; }</code> </pre><br>  To validate the TIN, an attribute of the following form was specifically written: <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">InnAttribute</span></span> : <span class="hljs-selector-tag"><span class="hljs-selector-tag">RegularExpressionAttribute</span></span> { public InnAttribute() : base(@"^(\d{10}|\<span class="hljs-selector-tag"><span class="hljs-selector-tag">d</span></span>{12})$") { ErrorMessage = "     10/12 ."; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">InnAttribute</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">CivilLawSubject</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">civilLawSubject</span></span>) : <span class="hljs-selector-tag"><span class="hljs-selector-tag">base</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">civilLawSubject</span></span> == <span class="hljs-selector-tag"><span class="hljs-selector-tag">CivilLawSubject</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Individual</span></span> ? @"^\<span class="hljs-keyword"><span class="hljs-keyword">d</span></span>{12}$" : @"^\<span class="hljs-keyword"><span class="hljs-keyword">d</span></span>{10}$") { ErrorMessage = civilLawSubject == CivilLawSubject.Individual ? "       12 ." : "       10 ."; } }</code> </pre><br>  A constructor without parameters has been declared protected, so that it is used only for ORM.  For materialization, reflection is used, so the access modifier is not a hindrance.  In the "real" designer passed both required fields: TIN and CAT.  The remaining fields of legal entity in the context of the system are optional and are filled in by a company representative later. <br><br><h2>  Encapsulation and Validation </h2><br>  TIN and KPP properties are declared with a protected setter.  EF will be able to reach them again, and the programmer will have to use the <code>DangerouslyChangeInnAndKpp</code> function.  The name of the function clearly hints that changing the TIN and the checkpoint is not a regular situation.  Two parameters are passed to the function, which means that if you change the TIN and PPC, then only together.  TIN + PPC could even be made a composite key.  But for compatibility, I left a <code>long Id</code> .  Finally, when calling this function, validators will work and if the TIN and checkpoint are not correct, a <code>ValidationException</code> will be thrown. <br><blockquote>  You can further <a href="https://habrahabr.ru/post/266937/">strengthen the type system</a> .  However, the approach described by reference has a significant drawback: the lack of support from the standard ASP.NET infrastructure.  Support can be added, but such an infrastructure code is worth something and needs to be accompanied. </blockquote><br><h2>  Properties for reading, specialized methods for changing </h2><br>  According to the business process, the organization can be ‚Äúaccepted‚Äù or ‚Äúrejected‚Äù, and in case of rejection, you must leave a comment.  If all properties were public, then this could only be learned from the documentation.  In this case, the status change rules are visible from the method signatures.  In the article I gave only a fragment of the class legal entity.  In fact, there are much more fields there and understanding what is connected with it helps a lot, especially when connecting new team members.  If the property can be uncontrolledly changed in isolation from others without explicit business operations, the setter can also be made public.  However, this property should be alerted: if there are no explicit operations associated with the data, perhaps this data is not needed? <br><blockquote>  An alternative is to use the ‚Äú <a href="https://habrahabr.ru/post/341134/">state</a> ‚Äù pattern and put the behavior into separate classes. </blockquote><br><h2>  <a href="https://habrahabr.ru/post/325280/">Specs</a> </h2><br>  For some time, it was not clear that it would be better to write extensions that modify <code>Queryable</code> or <a href="https://habrahabr.ru/post/325280/">to mess with expression trees</a> .  In the end, the <a href="https://github.com/navozenko/LinqSpecs">LinqSpec</a> implementation was the most convenient. <br><br><h2>  Extension methods </h2><br>  Ad hoc polymorphism for interfaces (so that you don‚Äôt have to implement methods in each successor) <a href="https://github.com/dotnet/csharplang/issues/52">will appear in C # sooner or later</a> .  While it is necessary to be content extension-methods. <br><br><pre> <code class="css hljs"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">interface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IHasId</span></span> { object Id { get; } } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">interface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IHasId</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">out</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TKey</span></span>&gt; : <span class="hljs-selector-tag"><span class="hljs-selector-tag">IHasId</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">where</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TKey</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">IEquatable</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">TKey</span></span>&gt; { new TKey Id { get; } } <span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bool</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IsNew</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">TKey</span></span>&gt;(<span class="hljs-selector-tag"><span class="hljs-selector-tag">this</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IHasId</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">TKey</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">obj</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">where</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TKey</span></span> : <span class="hljs-selector-tag"><span class="hljs-selector-tag">IEquatable</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">TKey</span></span>&gt; { return obj.Id == null || obj.Id.Equals(default(TKey)); }</code> </pre><br>  Extension methods are suitable for use in LINQ for greater expressiveness.  However, the <code>ByInnAndKpp</code> and <code>ByInn</code> cannot be used inside other expressions.  They can not make out the provider.  In more detail about the use of extension-methods a la <code>DSL</code> told Dino Esposito on <a href="https://www.youtube.com/watch%3Fv%3D3oO7gd16Xp0">one of the DotNext</a> . <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">class</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">CompanyDataExtensions</span></span> { public static CompanyData ByInnAndKpp( this IQueryable&lt;CompanyData&gt; query, string inn, string kpp) =&gt; query .Where(x =&gt; x.Company, Supplier.Specs.ByInnAndKpp(inn, kpp)) .FirstOrDefault(); public static CompanyData ByInn( this IQueryable&lt;CompanyData&gt; query, string inn) =&gt; query .Where(x =&gt; x.Company, Supplier.Specs.ByInn(inn)); }</code> </pre><br>  Note the <a href="https://habrahabr.ru/post/313394/">unusual Where with two parameters</a> .  <code>EF Core</code> began to support <code>InvokeExpression</code> .  The application code is used as follows: <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">var</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">priceInfos</span></span> = <span class="hljs-selector-tag"><span class="hljs-selector-tag">DbContext</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.CompanyData</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.ByInn</span></span>("") <span class="hljs-selector-class"><span class="hljs-selector-class">.ToList</span></span>();</code> </pre><br>  An alternative is to use <code>SelectMany</code> . <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">var</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">priceInfos</span></span> = <span class="hljs-selector-tag"><span class="hljs-selector-tag">DbContext</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.Company</span></span> //     <span class="hljs-selector-tag"><span class="hljs-selector-tag">extension-</span></span>    <span class="hljs-selector-class"><span class="hljs-selector-class">.ByInnAndKpp</span></span>("", "") <span class="hljs-selector-class"><span class="hljs-selector-class">.SelectMany</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">x</span></span> =&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">x</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Company</span></span>) <span class="hljs-selector-class"><span class="hljs-selector-class">.ToList</span></span>();</code> </pre><br><blockquote>  I have not fully studied the equivalence of options with <code>Select</code> and <code>SelectMany</code> from the point of view of <code>IQueryProvider</code> .  I would be grateful for any information on this topic in the comments. </blockquote><br><h2>  Related collections </h2><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">public</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">virtual</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ICollection</span></span>&lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">Document</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Documents</span></span> { get; protected set; }</code> </pre><br>  It is advisable to use only in the <code>Select</code> block to convert to an SQL query, because the code of the form <code>company.Documents.Where(‚Ä¶).ToList()</code> does not build a query to the database, but first lifts all the related entities into RAM, and therefore applies <code>Where</code> to sampling in memory.  Thus, the presence of collections in the model can adversely affect the performance of the application.  At the same time, refactoring will be difficult, because you will have to transfer the necessary <code>IQueryable</code> from outside.  To control the quality of requests you need to glance in <a href="https://miniprofiler.com/">miniProfiler</a> . <br><br><h2>  Services </h2><br>  In an anemic model, in general, all logic is stored in services.  I prefer to add services only when necessary, if the logic is out of place in the unit code or describes the interaction between the units.  The best option when the domain contains the exact name for the service - "cash", "warehouse", "call center".  In this case, the ‚ÄúService‚Äù postfix can be omitted.  The set of methods in each class corresponds to a set of use cases, grouped by user interface elements.  It works well if the interface is designed in the style of <code>Task Based UI</code> . <br><br>  Write methods accept an entity or DTO as input.  Validation of the request is performed in a separate layer strictly before the method is executed.  If the method can fail, it should be explicitly indicated in the signature using the <a href="https://habrahabr.ru/post/347284/"><code>Result</code></a> type.  Exceptions remain for exceptional situations. <br><br>  Read methods return DTOs for serialization and sending to the client.  Thanks to <code>Queryable Extensions</code> in <a href="https://github.com/AutoMapper/AutoMapper/wiki/Queryable-Extensions">AutoMapper</a> and <a href="https://github.com/MapsterMapper/Mapster/wiki/Basic-usages">Mapster,</a> you can use mappings to translate into expressions for <code>Select</code> , which allows you not to drag the whole entity from the database as a whole. <br><br><h2>  Managers (Manager) </h2><br>  I use rarely, for operations within one unit.  <code>AspNet.Identity</code> , for example, contains a <code>UserManager</code> .  Basically, managers are needed when it is necessary to implement logic on an aggregate that is not directly related to the domain. <br><br><h2>  TPT for union-type </h2><br>  Sometimes one condition may be associated with one of several others.  <a href="https://msdn.microsoft.com/en-us/library/jj618293(v%3Dvs.113).aspx">TPT</a> can be used to create a consistent storage system, and <a href="https://habrahabr.ru/post/257283/">pattern matching</a> can be used for control flow.  This approach is described in detail in a <a href="https://habrahabr.ru/post/322168/">separate article</a> . <br><br><h2>  <a href="https://github.com/AutoMapper/AutoMapper/wiki/Queryable-Extensions">Queryable Extensions</a> for DTO projections </h2><br>  Using <code>DataMapper</code> allows reducing the number of boilerplate code, and using <code>Queryable Extensions</code> - to build requests for receiving DTO without the need to write <code>Select</code> manually.  Thus, you can reuse expressions for in-memory mapping and expression tree construction for <code>IQueryProvider</code> .  <code>AutoMapper</code> quite <code>AutoMapper</code> in memory and not fast, so it eventually replaced it with <a href="https://github.com/MapsterMapper/Mapster">Mapster</a> . <br><br><h2>  <a href="https://habrahabr.ru/post/347908/">CQRS</a> for individual subsystems </h2><br>  When working in conditions of high uncertainty, the risk of design error is also great.  Before designing a database structure, making decisions on denormalization or writing stored procedures makes sense to resort to quick prototyping and test hypotheses.  When there is confidence: what is at the entrance, and what is at the output you can do optimization. <br><br>  In the absence of implementation commands, <code>IQuery</code> returns identical results on identical input data.  Therefore, the bodies of such methods can be aggressively cached.  Thus, after replacing implementations, the infrastructure code (controllers) will remain unchanged, and only the body of the <code>IQuery</code> method will have to be modified.  The approach allows you to optimize the application pointwise in small pieces, and not all of it. <br><blockquote>  The approach is limited to a very, very busy resource due to the overhead of the IOC container and memory traffic for per-request lifestyle.  However, all <code>IQuery</code> can be made singleton'ami, if you do not inject dependencies from the database into the constructor, and instead use the using construct. </blockquote><br><h2>  Work with legacy code </h2><br>  When working with the existing code base, you should decide on the format of work: ‚Äúsupport‚Äù or ‚Äúdevelopment‚Äù.  In the first case, the appearance of a new functionality and the refinement of the system are not expected.  Maximum - add a few new reports, a couple of forms here and there.  In the second - there is a need for significant processing of the subject model and / or architecture in general.  If the project needs to be ‚Äúsupported‚Äù and not ‚Äúdeveloped‚Äù, it is better to follow the existing rules, no matter how successful they are.  If there is a frank shit in front of you, it is better to refuse the offer to bid it. <br><br>  Project development is a more difficult task.  The topic of refactoring is beyond the scope of this article.  I will note only two of the most useful patterns: " <a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/anti-corruption-layer">anti-corruption layer</a> " and " <a href="http://blog.byndyu.ru/2014/01/blog-post_8.html">strangler</a> ".  They are very similar.  The main idea is to build a "facade" between the old and the new code bases and gradually <s>have an elephant</s> rewrite the entire system in pieces.  The facade takes on the role of a barrier that prevents the problems of the old code base from leaking into the new one and ensuring that the old business logic is mapped to the new one.  Be prepared that the facade will consist entirely of hacks, tricks and crutches and sooner or later will sink into oblivion along with the entire old code base. </div><p>Source: <a href="https://habr.com/ru/post/334126/">https://habr.com/ru/post/334126/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334116/index.html">We send routine and bureaucracy into the past or how large and medium-sized enterprises stay on top of the iceberg</a></li>
<li><a href="../334118/index.html">Why i hate spring</a></li>
<li><a href="../334120/index.html">A happy ending story: Bitrix24 integration with Asterisk</a></li>
<li><a href="../334122/index.html">How do programmers get their first offer</a></li>
<li><a href="../334124/index.html">IP unnumbered on Debian or distribute addresses sparingly</a></li>
<li><a href="../334128/index.html">Mom wants grandchildren! Or where telemedicine may be useful</a></li>
<li><a href="../334130/index.html">Uncle Bob Martin: ‚ÄúTake me to Toronto, HAL‚Äù</a></li>
<li><a href="../334134/index.html">BIT-picnic sip of summer and useful information</a></li>
<li><a href="../334136/index.html">Random forest vs neural network: who will better cope with the task of recognizing gender in speech (part 1)</a></li>
<li><a href="../334138/index.html">Work with servlets for dummies. GET / POST</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>