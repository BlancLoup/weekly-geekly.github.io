<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Problems in the library of Django forms on the example of the phone entry field</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, Django includes a library for generating and maintaining html forms. Some time ago another library of forms was bundled with Django, but ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Problems in the library of Django forms on the example of the phone entry field</h1><div class="post__text post__text-html js-mediator-article">  As you know, Django includes a library for generating and maintaining html forms.  Some time ago another library of forms was bundled with Django, but then it was completely rewritten.  Perhaps, then the developers have solved a lot of architectural problems.  But when working with the current library there are some difficulties.  That's what I want to talk about. <br><br>  So, the task.  Users love to leave their phones and other private information on sites.  Moreover, they want to do this without thinking about how to enter it correctly: 8 (908) 1271669 or, say, 908 127 16 69. Website visitors like to see the right phones, preferably uniformly designed: (+7 495) 722- 16-25, +7 968 ‚Äã‚Äã127-31-32.  It turns out that you need to validate and store the numbers in a normalized form, that is, without registration.  In the field about which I will talk, you can enter more than one phone number.  The storage format is defined as a sequence of 11 digits, separated by a space. <br><a name="habracut"></a><br>  For further narration, I need to briefly outline the principle of how forms work.  A form consists of the Form class and a set of fields included in the form (the Field class).  When the form is first created, the initial dictionary is passed to the initial values ‚Äã‚Äãfor the fields.  If we are talking about a ModelForm, the initial dictionary is automatically created from the model instance instance that was passed during creation.  The Form class provides an interface for generating the code for the html form itself.  The process is managed by instances of the BoundField class, linking the fields and the data contained in the form.  The HTML code itself is generated by widgets (Widget class).  When the user submits the completed form, the data dictionary is transferred to the form constructor - the contents of the POST request.  Now the form fields should check the user input and make sure that all the fields are correct.  In the event of an error, the form is generated again, but not the initial dictionary, but the user input data dictionary is taken as the values ‚Äã‚Äãfor the fields. <br><br>  As you can see, the data inside the form has three routes: from application to user (through initial when first creating the form), from user to user (re-displaying erroneously entered data) and from user to application (if the entered data are correct).  Well, the task seems simple.  It is necessary to hook into the first and third route, formatting the phones for the user and normalizing for the application.  Let's start with the last one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To begin, we will make a blank for the future of the field.  Obviously, it must be inherited from CharField. <br><br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MultiplePhoneFormField</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(forms.CharField)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,      . phone_code = ''</span></span></code> </pre> <br>  The <a href="https://docs.djangoproject.com/en/1.4/ref/forms/validation/">documentation</a> describes all the methods involved in processing the value during validation.  to_python () is used to cast to the correct data type for the application.  But our data type is a string, so we will not use this method.  Next are the validate () and run_validators () methods.  They are used to check the correctness of the entered value, but cannot change it, therefore they are not suitable either.  Remains the clean () method of the field.  In the base implementation, it calls the above methods in the correct order and returns the final value.  So, here and post the code. <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clean</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, phones)</span></span></span><span class="hljs-function">:</span></span> phones = super(MultiplePhoneFormField, self).clean(phones) cleaned_phones = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> phone <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> phones.split(<span class="hljs-string"><span class="hljs-string">','</span></span>): phone = re.sub(<span class="hljs-string"><span class="hljs-string">r'[\s +.()\-]'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, phone) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> phone: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> phone.isdigit(): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValidationError(<span class="hljs-string"><span class="hljs-string">u'   .'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(phone) == <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(phone) == <span class="hljs-number"><span class="hljs-number">10</span></span>: phone = <span class="hljs-string"><span class="hljs-string">'7'</span></span> + phone <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(self.phone_code + phone) == <span class="hljs-number"><span class="hljs-number">11</span></span>: phone = self.phone_code + phone <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValidationError(<span class="hljs-string"><span class="hljs-string">u'  .'</span></span>) cleaned_phones.append(phone) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>.join(cleaned_phones)</code> </pre><br>  I will not describe in detail exactly how the number is being validated, I think, and so everything is clear. <br><br>  Now the route from application to user.  The documentation has an example implementation of the MultiEmailField field, which returns a list of email addresses to the application.  But how it lists this list to the user is not mentioned.  Apparently, it is implied that this task falls on the shoulders of the application creating the form.  There are no other examples either.  But we are not proud, we can see it in the source code. <br><br>  The BoundField class has an as_widget () method, which passes a field value to this widget that needs to be displayed by calling its value () method.  It is in this method that it is determined whether the data source is data or initial.  And here we are waiting for a big disappointment: if the data is taken from initial, then the field can not be integrated into the process and change the data.  The value () method simply calls self.form.initial.get (self.name) and then, regardless of the data source, passes it to the prepare_value () method of the field.  It turns out that all values ‚Äã‚Äãpass through the same pipeline, at the end of which the ‚Äúcorrect‚Äù value should turn out. <br><br>  Either I didn‚Äôt understand something, or Jung forms are really designed so that only the application itself can prepare the data for output in the form.  In the initial dictionary at the time of form creation, there should already be data ready for insertion into html. <br><br>  ‚ÄúBut wait, but how does DatetimeField work, which calmly takes datetime as initial?‚Äù You say.  So I thought how.  It turned out that the value received from an unknown source is passed to the render () method of the DateTimeInput widget, which in turn passes it to its _format_value () method.  And already this method, if it finds that the value is datetime, converts it to a string.  Why it is impossible to make also in our case?  Because the type of the value transmitted from the application and received when sending the form is the same.  In both cases, it is a string. <br><br>  Nevertheless, the solution is necessary and it is.  If you look at the BoundField.value () method again, you will notice that the value received from the user is additionally passed to the bound_data () method.  Consequently, in the prepare_value () method, where the value falls after, you can determine where it came from, if you first mark it.  So do. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueFromDatadict</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unicode)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MultiplePhoneFormField</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(forms.CharField)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,      . phone_code = '' def bound_data(self, data, initial): return ValueFromDatadict(data) def prepare_value(self, value): if not value or isinstance(value, ValueFromDatadict): return value return ', '.join(format_phones(value, code=self.phone_code))</span></span></code> </pre><br>  Hooray!  Now phones are formatted when they are displayed in the form for the first time, and do not change when edited data comes from the user.  And this is how you can format phones. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format_phones</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(phones, code=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> phone <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filter(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, phones.split(<span class="hljs-string"><span class="hljs-string">' '</span></span>)): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(phone) != <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-comment"><span class="hljs-comment">#  . pass elif phone[0:4] == '8800': # 8 800 100-31-32 phone = u'8 800 %s-%s-%s' % (phone[4:7], phone[7:9], phone[9:11]) elif code and phone.startswith(code): # (+7 351) 722-16-25 # (+7 3512) 22-16-25 phone = phone[len(code):] phone = u'(+%s %s) %s-%s-%s' % (code[0], code[1:], phone[:-4], phone[-4:-2], phone[-2:]) else: # +7 968 127-31-32 phone = u'+%s %s %s-%s-%s' % (phone[0], phone[1:4], phone[4:7], phone[7:9], phone[9:11]) yield phone</span></span></code> </pre><br>  It remains only to indicate in the form constructor the code of the city to which the edited object is attached. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RestaurantForm</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(forms.ModelForm)</span></span></span><span class="hljs-class">:</span></span> phone = MultiplePhoneFormField(label=<span class="hljs-string"><span class="hljs-string">u''</span></span>, required=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, help_text=<span class="hljs-string"><span class="hljs-string">u'     .'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super(RestaurantForm, self).__init__(*args, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.instance: self.fields[<span class="hljs-string"><span class="hljs-string">'phone'</span></span>].phone_code = self.instance.city.phone_code</code> </pre><br>  Well, for the output of phones on the site will fit this filter: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@register.filter def format_phones_with_code(phones, code): return mark_safe(u', '.join([u'&lt;nobr&gt;%s&lt;/nobr&gt;' % phone for phone in format_phones(phones, code)]))</span></span></code> </pre><br>  Of course, we can assume that the task was solved.  But obviously not without crutches.  The same can be said about the field implementations bundled with Django.  For example, in the to_python () method of the same DateTimeField field there is a check that the value is already of type datetime.  In this case, the to_python () method is called only for values ‚Äã‚Äãobtained from the data dictionary.  The <a href="https://docs.djangoproject.com/en/1.4/ref/forms/api/">documentation for the forms</a> about the contents of the data dictionary clearly states: "These will usually be strings, but they are not required."  Apparently, this makes some sense for validating something other than user input from a post request.  But such flexibility introduces uncertainty and makes validation a heuristic, not an algorithmic, task. </div><p>Source: <a href="https://habr.com/ru/post/158107/">https://habr.com/ru/post/158107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../158093/index.html">The digest of interesting news and materials from the world of ayti for the last week ‚Ññ30 (November 3 - 9, 2012)</a></li>
<li><a href="../158095/index.html">Ten rules calm development</a></li>
<li><a href="../158097/index.html">USPS lifts a ban on shipping lithium batteries</a></li>
<li><a href="../158099/index.html">W.Script languages. Part 2 - high-level languages, or why are we in the C ++ corporation</a></li>
<li><a href="../158101/index.html">Retina website optimization tools</a></li>
<li><a href="../158109/index.html">Project RetroGSM, or how to surprise your grandmother</a></li>
<li><a href="../158113/index.html">Pro user interface and one mouse button</a></li>
<li><a href="../158115/index.html">What's wrong with Google+</a></li>
<li><a href="../158117/index.html">Canonical decided to create a game development team.</a></li>
<li><a href="../158119/index.html">We work with SteamWorks. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>