<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Daemon for remote control of a computer via e-mail</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, Habr! 

 In this article, I would like to share my experience in creating a daemon for remote control of a computer via e-mail. 

 Introduction...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Daemon for remote control of a computer via e-mail</h1><div class="post__text post__text-html js-mediator-article">  Hello, Habr! <br><br>  In this article, I would like to share my experience in creating a daemon for remote control of a computer via e-mail. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  In my work, I use many remote machines.  Often, access to them is limited by IP filter, so you have to use long chains from hosts to enter the machine. <br>  After completing this quest once again, in order to fulfill a couple of teams, I realized that I needed to change something.  Of course, the simplest solution would be to create a direct SSH tunnel and forget about all the difficulties, but, firstly, this is hindered by a strict security policy, and, secondly, I would like to have a flexible and independent system. <br><br>  Over time, a number of requirements emerged: <br><ul><li>  system security; </li><li>  simple access to the system without unnecessary gestures (from a telephone, someone else's computer, etc.); </li><li>  history of executed commands and execution results. </li></ul><br>  After a detailed analysis of the requirements, I came to the conclusion that the most suitable solution is a bot that works through email.  After all, it is very convenient.  Nowadays, you can send E-mail from any device that has a screen and a keyboard (computer, phone, Kindle, even TVs already know how to do it).  The list of letters is always available on the server and you can conveniently analyze the change in the state of the system. <br>  Among the ready-made solutions, nothing suitable was found, so I decided to do it myself. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Implementation </h4><br>  Python was chosen as the programming language; not only the flexibility of the language itself, but also the long-standing desire to use it in practice served as the selection criterion. <br>  The program algorithm is quite simple: <br><ol><li>  Receive commands by e-mail </li><li>  Command execution </li><li>  Send results back to user </li></ol><br><h5>  1. Receive commands by e-mail </h5><br>  To begin with we establish connection with the server, there are two options: POP3 or IMAP4.  The choice depends on the supported protocols on the mail server and on the openness of the ports on the target machine. <br>  Connection to server for POP3 protocol <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_enabled(self.get_param_str(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"USE_SSL"</span></span>)): session = poplib.POP3_SSL(self.get_param_str(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"POP_SERVER"</span></span>), self.get_param_int(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"POP_SSL_PORT"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: session = poplib.POP3(self.get_param_str(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"POP_SERVER"</span></span>), self.get_param_int(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"POP_PORT"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">#if if is_enabled(self.get_param_str("Debug", "NETWORK_COMM_LOGGING")): session.set_debuglevel(10) #if try: session.user(self.get_param_str("Mail", "EMAIL_USER")) session.pass_(self.get_param_str("Mail", "EMAIL_PASS")) except poplib.error_proto as e: sys.stderr.write("Got an error while connecting to POP server: '%s'\n" % (e)) return False #try</span></span></code> </pre> <br>  Connection to server for IMAP4 protocol <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_enabled(self.get_param_str(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"USE_SSL"</span></span>)): session = imaplib.IMAP4_SSL(self.get_param_str(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"IMAP_SERVER"</span></span>), self.get_param_int(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"IMAP_SSL_PORT"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: session = imaplib.IMAP4(self.get_param_str(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"IMAP_SERVER"</span></span>), self.get_param_int(<span class="hljs-string"><span class="hljs-string">"Mail"</span></span>, <span class="hljs-string"><span class="hljs-string">"IMAP_PORT"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">#if if is_enabled(self.get_param_str("Debug", "NETWORK_COMM_LOGGING")): session.debug = 10 #if try: session.login(self.get_param_str("Mail", "EMAIL_USER"), self.get_param_str("Mail", "EMAIL_PASS")) except imaplib.IMAP4.error as e: sys.stderr.write("Got an error while connecting to IMAP server: '%s'\n" % (e)) return False #try</span></span></code> </pre><br><br>  After the connection is established, you need to filter out of all messages commands for our bot.  I decided to use three-level filtering: <br><ul><li>  filtering by subject; </li><li>  filtering senders by white and black lists; </li><li>  login + password authorization. </li></ul><br>  The algorithm for filtering by topic in the case of POP3 is the following: receive only message headers, check the ‚ÄúSubject:‚Äù field, if the topic is correct, we receive the message completely and pass it on to further processing. <br><pre> <code class="python hljs">numMessages = len(session.list()[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(numMessages): m_parsed = Parser().parsestr(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>.join(session.top(i+<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.get_param_str(<span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'SUBJECT_CODE_PHRASE'</span></span>) == m_parsed[<span class="hljs-string"><span class="hljs-string">'subject'</span></span>]: <span class="hljs-comment"><span class="hljs-comment">#Looks like valid cmd for bot, continue if self._process_msg("\n".join(session.retr(i+1)[1])): session.dele(i+1) #if #if #for</span></span></code> </pre><br>  In the case of IMAP, everything is a bit simpler, the protocol allows you to perform selections on the server side, i.e., it is enough for us to specify the subject, and the server will give us all the appropriate letters. <br><pre> <code class="python hljs">session.select(self.get_param_str(<span class="hljs-string"><span class="hljs-string">'Mail'</span></span>, <span class="hljs-string"><span class="hljs-string">'IMAP_MAILBOX_NAME'</span></span>)) typ, data = session.search(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-string"><span class="hljs-string">'SUBJECT'</span></span>, self.get_param_str(<span class="hljs-string"><span class="hljs-string">"Main"</span></span>, <span class="hljs-string"><span class="hljs-string">"SUBJECT_CODE_PHRASE"</span></span>))</code> </pre><br><br>  The next step is to filter the sender by white and black lists (regular expressions can be used) <br><br>  And the last bastion is authorization for a pair of login: password, which should go in the first line of the letter with the command. <br>  On the client, instead of passwords, only md5 hashes are stored. <br><br>  Yes, I understand that this is too paranoid, on the other hand, is it possible to talk about excessive paranoia in matters of security? <br><br><h5>  2. Execution of commands </h5><br>  Since potentially the execution of some commands may take considerable time, it was decided to execute each command in a separate process.  It was also introduced a top limit on the number of active processes. <br>  The disadvantage of executing arbitrary commands is the ability to suspend the system by launching an interactive program (mc, htop, etc).  So far, I have not figured out how to deal with this. <br><br><h5>  3. Send results back to user </h5><br>  After the user command completes, a report will be sent to the user containing all command output and the return code. <br>  For sending the smtplib module is used. <br><br><pre> <code class="python hljs">self.__send_lock.acquire() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> msg <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"[%s] Sending response to '%s'"</span></span> % (datetime.today().strftime(<span class="hljs-string"><span class="hljs-string">'%d/%m/%y %H:%M'</span></span>), email_from) recipients = [email_from, self.get_param_str(<span class="hljs-string"><span class="hljs-string">'Mail'</span></span>, <span class="hljs-string"><span class="hljs-string">'SEND_COPY_TO'</span></span>)] message = <span class="hljs-string"><span class="hljs-string">"%s%s%s\n%s"</span></span> % (<span class="hljs-string"><span class="hljs-string">'From: %s \n'</span></span> % (self.get_param_str(<span class="hljs-string"><span class="hljs-string">'Main'</span></span>, <span class="hljs-string"><span class="hljs-string">'BOT_NAME'</span></span>)), <span class="hljs-string"><span class="hljs-string">'To: %s \n'</span></span> % (email_from), <span class="hljs-string"><span class="hljs-string">'Subject: Report %s \n'</span></span> % (datetime.today().strftime(<span class="hljs-string"><span class="hljs-string">'%d/%m/%y %H:%M'</span></span>)), msg) <span class="hljs-comment"><span class="hljs-comment"># Currently in python SMTP_SSL is broken, so always using usual version session = smtplib.SMTP(self.get_param_str("Mail", "SMTP_SERVER"), self.get_param_int("Mail", "SMTP_PORT")) if is_enabled(self.get_param_str("Debug", "NETWORK_COMM_LOGGING")): session.set_debuglevel(10) #if session.login(self.get_param_str("Mail", "EMAIL_USER"), self.get_param_str("Mail", "EMAIL_PASS")) session.sendmail(self.get_param_str("Mail", "EMAIL_USER"), recipients, message) session.quit() #if self.__send_lock.release()</span></span></code> </pre><br><br>  <a href="http://www.jejik.com/articles/2007/02/a_simple_unix_linux_daemon_in_python/">This</a> class was used to create the daemon. <br><br><h4>  Conclusion </h4><br>  As an example, send a command to the bot: <br><img src="https://habrastorage.org/storage1/8e707c5e/23a91958/e05649cd/e8f71f82.png"><br><br>  After some time we see the answer: <br><img src="https://habrastorage.org/storage1/cf041ffb/4cdbaf00/a3283ab8/6c6dac4c.png"><br><br>  <a href="https://github.com/chuda/msh">Project code</a> is available on github <br><br>  I hope that this information will be useful to someone. <br><br>  Thank you for your attention, waiting for your comments. <br><br>  UPD: fixed a bug related to incorrect processing of multi-part messages, thanks to github user megres. <br><br>  UPD2: added the ability to set an arbitrary timeout for the command.  To use, you must add the prefix ": time = x" before the command, i.e.  ": time = 10 make", will give 10 seconds to build, and then shoot it off. <br>  Thank you <a href="http://habrahabr.ru/users/tanenn/" class="user_link">tanenn</a> for the idea. </div><p>Source: <a href="https://habr.com/ru/post/128431/">https://habr.com/ru/post/128431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../128425/index.html">Itanium Poulson: what's new</a></li>
<li><a href="../128426/index.html">Master Part Chart with Highcharts and jQuery UI</a></li>
<li><a href="../128427/index.html">How to stop worrying and start working?</a></li>
<li><a href="../128428/index.html">6 sad squids cuddle tenderly</a></li>
<li><a href="../128429/index.html">Extreme data recovery from degraded 5th raid</a></li>
<li><a href="../128432/index.html">The dark side of programming for beginners, including php</a></li>
<li><a href="../128433/index.html">Hidden in the foliage</a></li>
<li><a href="../128434/index.html">The government loved Wi-Fi. Gorky Park, metro, universities. Calculating the cost of the network at the university</a></li>
<li><a href="../128437/index.html">How to add a new diagnostic rule in PVS-Studio? Everyday developers ...</a></li>
<li><a href="../128438/index.html">The basic theory of collision objects, sprites on Javascript</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>