<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimize load balancing in Veeam Backup & Replication infrastructure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My wonderful colleagues from the technical support department write not only harmful, but also useful tips and recommendations on how to configure Vee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimize load balancing in Veeam Backup & Replication infrastructure</h1><div class="post__text post__text-html js-mediator-article">  My wonderful colleagues from the technical support department write not only harmful, but also useful tips and recommendations on how to configure Veeam Backup &amp; Replication.  Since the publication of the <a href="https://habr.com/company/veeam/blog/354302/">article for novice users,</a> its author, Evgeny Ivanov, continuing to work with the Romanian team in Bucharest, has moved from the post of senior engineer to the position of team lead.  But Eugene did not leave the technical-literary field, for which he thanks a lot! <br>  Eugene's new article contains recommendations for the already experienced specialists working with Veeam Backup &amp; Replication, who are faced with the task of using the backup infrastructure resources most effectively.  However, the article will be useful to those who are just planning to install and configure our product. <br><br><img src="https://habrastorage.org/webt/ml/wf/yq/mlwfyqyowbq_dg7asos37xybia4.png"><br>  <i>Optimized load distribution during warm lamp times</i> <br><br>  For useful tips welcome under cat. <br><a name="habracut"></a><br><h1>  About the advantages of a distributed installation </h1><br>  Veeam Backup &amp; Replication is a modular software consisting of various components, each of which performs specific functions.  Among these components is a central manager, Veeam backup server, a proxy server, a repository, a WAN accelerator and others.  A number of components can be installed on one machine (of course, quite powerful), which is what many users do.  However, a distributed installation has its advantages, namely: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  For companies with a network of branches, it is possible to install the necessary components locally in these branches.  This helps optimize traffic, organizing most of it again, locally. </li><li>  As the infrastructure grows, it becomes necessary to scale the backup solution.  If the backup takes longer (the ‚Äúbackup window‚Äù grows), you can install an additional proxy server.  If you need to increase the capacity of the backup repository, you can configure a scalable repository (scale-out backup repository) and add new extents as needed. </li><li>  For some components, you can ensure constant availability (High Availability) - for example, if you have several proxy servers deployed and one of them suddenly turns off, then the others will continue to work and the backup will not be affected. </li></ul><br>  It must be borne in mind that distributed systems will be effective only with a reasonable load distribution.  Otherwise, ‚Äúbottlenecks‚Äù, overloading of individual components may occur - and this is fraught with a general drop in productivity and slowdown. <br><br><h1>  How is the data transmitted? </h1><br>  To have a clearer idea of ‚Äã‚Äãwhere data is transferred from and from during the backup process, consider the following diagram (for example, take the infrastructure on the vSphere platform): <br><br><img src="https://habrastorage.org/webt/fx/fm/np/fxfmnpj4_z8qpv9yreas9ybf88c.png"><br><br>  As you can see, the data is transferred from the source location (source) to the target (target) using ‚Äútransport agents‚Äù (VeeamAgent.exe), which work in both locations.  So, when a backup job is running, the following happens: <br><br><ul><li>  The ‚Äúsource‚Äù transport agent runs on a proxy server;  it reads data from the datastore, performs compression and deduplication, and sends the data in this form to the ‚Äútarget‚Äù transport agent. </li><li>  The ‚Äútarget‚Äù transport agent runs directly on the repository (Windows / Linux) or on the gateway (gateway server), if CIFS share is used.  This agent, in turn, also performs deduplication on its side and saves the data to a backup file (.VBK, .VIB, etc.). </li></ul><br>  Thus, 2 components are always involved in data transfer, even if they are actually on the same machine.  This must be taken into account when planning deployment solutions. <br><br><h1>  Load sharing between proxy and repository </h1><br>  First, let's define the concept of ‚Äútask‚Äù.  In the terminology of Veeam Backup &amp; Replication, each task (task) is the processing of 1 disk of a virtual machine.  That is, if you have a backup job (job) that includes 5 VMs with 2 disks each, this means that you have to handle 10 tasks (and if the machine has only 1 disk, then 1 task = 1 VM).  Veeam Backup &amp; Replication is capable of processing several tasks in parallel, but their number, of course, is not infinite. <br><br>  For each proxy server in its properties you can specify the maximum number of tasks for parallel execution: <br><br><img src="https://habrastorage.org/webt/ra/sf/b1/rasfb1_rus_8c64vjnlt-iyz80k.png"><br><br>  In standard backup operations, a similar interpretation will be made for the repository: one task is to transfer data from one virtual disk.  In the interface, it looks very similar: <br><br><img src="https://habrastorage.org/webt/ul/0w/8s/ul0w8si2kepgtfj-1y4d1srv1vs.png"><br><br>  Here we must fix a very important <b>rule number 1:</b> <i>be sure to keep a balance when assigning proxy and repository resources and specifying the maximum number of tasks for parallel processing!</i> <br><br><h3>  Example </h3><br>  Assume that you have 3 proxy servers, each of which can process 4 tasks in parallel (that is, a total of 12 virtual disks of the source VMs are obtained).  But the repository is configured to handle only 4 tasks in parallel (by the way, this is the default value).  With such settings, only the 4 disks will be saved in parallel from the source location to the target, although they could be for all 12. That is, the resources will be underloaded. <br><br>  However, when it comes to creating a synthetic full backup (and similar operations), the concept of a task relative to the repository acquires a slightly different meaning.  We remember that such operations do not use proxy servers, but are performed locally on the repository (Windows or Linux) or (in the case of CIFS share) using a gateway (gateway). <br><br>  In this case, when building a normal chain of backups, a task = a backup task.  That is, a limit of 4 tasks for parallel processing here will mean that the synthetic repositories for 4 backup tasks can be simultaneously created on the repository. <br><br>  When building the same chain of backups, decomposed in accordance with the original VMs (the so-called ‚Äúmachine-sided‚Äù storage is per-VM), the task = 1 VM.  That is, a limit of 4 tasks for parallel processing here will mean that 4 VBK files for 4 virtual machines can be generated on the repository at the same time. <br><br>  Thus, we arrive at <b>rule number 2:</b> <i>Depending on the backup settings, the same number of tasks may mean a completely different load on the repository.</i>  <i>Therefore, when scheduling resources, you certainly need to check these very settings: backup mode, schedule of tasks, method of organizing backup chains.</i> <br><br>  <i>Note:</i> Unlike proxy server settings, you can disable the limit on the number of tasks for the repository.  In this case, the repository will receive all data from proxy servers.  But this is only apparent freedom from limitations, since there is a risk of overloading the repository and failures in the work of backup tasks.  Therefore, we strongly do not recommend to refuse this limit. <br><br><h3>  Another example </h3><br>  Suppose you have a backup task that includes a sufficiently large number of VMs with a total number of virtual disks of 100 pieces.  At the same time, the repository is configured to store backup chains ‚Äúper-VM‚Äù.  The settings for parallel processing are as follows: for a proxy, 10 disks at a time, and for a repository, there are no restrictions.  During an incremental backup, the load on the repository will be limited due to the proxy settings, and thus the balance will be maintained.  But then comes the moment of creating a synthetic full backup.  Such a backup does not use a proxy, and all operations to create "synthetics" take place exclusively on the repository.  Since there is no restriction on parallel processing of tasks for the repository, the repository server will try to process the entire hundred simultaneously.  This will require considerable strain on resources and will most likely lead to overload. <br><br><h1>  Features of using CIFS share as a repository </h1><br>  If you are working with a repository based on a Windows or Linux server, then the ‚Äútarget‚Äù agent starts directly on this server.  However, if you use the CIFS share folder as the repository (CIFS share), then the ‚Äútarget‚Äù agent starts on a specially designed machine - this is the so-called.  "Gateway" (gateway), which will receive incoming data flow from the agent on the side of the source VM.  The ‚Äútarget‚Äù agent will receive this data and then send data blocks to the CIFS ball.  This auxiliary machine should be placed as close as possible to a machine that provides SMB shared folders ‚Äî this is especially important for scenarios involving a WAN connection. <br><br>  <b>Rule number 3:</b> <i>You should not place an auxiliary machine (proxy / gateway) on one site, and the CIFS share shared folder - on another site (including on the cloud) - otherwise you will face persistent problems with the network.</i> <br><br>  You can also apply all the above considerations for balancing the load on the system to gateways.  In addition, you need to keep in mind that the gateway has 2 additional settings: the server for it can be assigned explicitly or automatically selected: <br><br><img src="https://habrastorage.org/webt/zp/ot/v3/zpotv33yivh4xspx_vqbsnaboom.png"><br><br>  In principle, you can use any Windows server included in the Veeam backup infrastructure as such a gateway.  Depending on the deployment scenario, one of the options may suit you: <br><br><ul><li>  Explicitly specified server - this, of course, simplifies a lot, because you will know exactly which machine the ‚Äútarget‚Äù agent is running on.  This option is recommended, in particular, for cases where access to the ball is allowed only from certain servers, as well as for scenarios with distributed infrastructure - you probably want reasonable people to use the agent on a machine located near the file server from the target shary </li><li>  Automatic server <b>selection</b> ( <b>Automatic selection</b> option).  Here it takes an interesting turn: if you use several proxy servers, the choice of this option, it turns out, leads to the fact that the program uses more than one gateway, distributing the load.  I note that ‚Äúautomatically‚Äù does not mean ‚Äúarbitrarily‚Äù - here quite specific selection rules apply. </li></ul><br><h2>  How it works? </h2><br>  The "target" agent starts on the proxy server that performs the backup. <br><br><ul><li>  In the case of a normal chain of backups, the logic is as follows: if there are several tasks performed at the same time, each with its own proxy server, then you can run several ‚Äútarget‚Äù agents.  However, within one job, the job logic is different: even if the VMs contained in it are processed by different proxies, the ‚Äútarget‚Äù agent will be started on only one ‚Äî the one that starts work first. </li><li>  In the case of the "back-up" chain of backups, a separate "target" agent is started for each VM.  Thus, even within the same task, the load is distributed. </li></ul><br>  <b>When creating synthetic backups,</b> proxy servers are not used, and here the machine to start the ‚Äútarget‚Äù agent is selected as follows: an auxiliary mount server is taken (the mount server on which the files are mounted, for example, during recovery operations) associated with the repository and it starts the agent.  If the mount server is unavailable for some reason, it is possible to switch to the north Veeam backup.  As you understand, the load distribution in this version will not be. <br><br>  Therefore, I repeat: ( <i>IMPORTANT!</i> ) It is not recommended for such scenarios to remove the restriction on the number of parallel processed tasks, because when performing operations with ‚Äúsynthetics‚Äù this can lead to a huge overload of the mount server or even the Veeam backup server. <br><br><h1>  Additional features </h1><br>  <b>Scalable repository.</b>  <a href="https://habr.com/company/veeam/blog/275115/">SOBR</a> is a set of standard repositories (here they are called ‚Äúextents‚Äù).  If you already use SOBR, then in the backup task you specify it, not the extent.  At extent-ah, you can use some settings, for example, load distribution. <br><br>  All the basic principles that work for regular repositories work for SOBR.  For optimal use of resources, it is advisable to set up SOBR with ‚Äúback-end‚Äù storage of backups (per-VM - this option is set by default), with the ‚ÄúPerformance‚Äù placement policy (‚Äúoptimize for better performance‚Äù) and distribution of chains across repositories-extent-s. <br><br>  <b>Transferring backups (backup copy).</b>  Here, the source agents will work on the source repository.  Everything mentioned above applies to the original repositories (except for the fact that in the case of the Backup Copy Job transfer job, operations with ‚Äúsynthetics‚Äù on the original repository are not performed). <br><br>  <i>Note:</i> If the source repository is a CIFS share, then the ‚Äúsource‚Äù agent starts on the corresponding mount server (with the ability to switch to Veeam backup server). <br><br>  <b>Devices with built-in deduplication.</b>  For DataDomain, StoreOnce storage systems (and in the future, probably, for others), for which integration with Veeam is configured, the same considerations apply as for the CIFS share.  For a repository on StoreOnce with deduplication on the source side ( <b>Low Bandwidth</b> mode), the requirement to place the gateway as close as possible to the repository is no longer relevant - the gateway on one site can be configured to send data to StoreOnce on another site via WAN. <br><br>  <b>Preferred proxy server.</b>  This feature appeared, as you remember, in release 9.5, and is responsible for supporting the ‚Äúpriority list of proxies‚Äù, which the program will follow when working with a specific repository. <br><br><img src="https://habrastorage.org/webt/kg/vp/4o/kgvp4ojq2s7pcryr8qtc0gbhrek.png"><br><br>  If the proxy from this list is not available, then the task will work with any other available.  However, if there is access to the proxy, but the proxy server does not have free slots for processing the task, then the backup task will be suspended pending those.  Therefore, it is necessary to use this feature very carefully (and not in the ‚Äúincluded and forgotten‚Äù style) - we had users who thus ‚Äúhung up‚Äù the backup tasks.  More information about the feature can be read <a href="https://helpcenter.veeam.com/docs/backup/vsphere/proxy_affinity.html">here</a> (in English. Language). <br><br><h1>  Finally </h1><br>  It doesn't matter if you are installing Veeam Backup &amp; Replication for the first time or you are a long-time user - I want to believe that in this article you will find useful information and with its help optimize the performance of your backup infrastructure or even eliminate potential risks of data loss.  Here are some more useful links: <br><br><ul><li>  <a href="https://habr.com/company/veeam/blog/354302/">Veeam Backup &amp; Replication: 10 Tips for Beginners</a> </li><li>  <a href="https://habr.com/company/veeam/blog/349964/">Useful tips on archiving Veeam backups to tape</a> </li><li>  <a href="https://habr.com/company/veeam/blog/275115/">Article on Habr√© about infinitely scalable repository (SOBR)</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/428069/">https://habr.com/ru/post/428069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../428059/index.html">Connecting Multipath LUN storage to VMware ESXi and Debian GNU / Linux</a></li>
<li><a href="../428061/index.html">Manage project cost with Earned Value Management</a></li>
<li><a href="../428063/index.html">Browsers refuse to support TLS 1.0 and 1.1</a></li>
<li><a href="../428065/index.html">Less does not mean worse: skyrmions and domain walls in ferr-magnets</a></li>
<li><a href="../428067/index.html">AntiFuzzing: Security through obscurity !?</a></li>
<li><a href="../428071/index.html">Sberbank lost the address book of 421,000 employees of the bank and its subsidiaries</a></li>
<li><a href="../428073/index.html">Rust 1.30 release</a></li>
<li><a href="../428075/index.html">All the same you will not manage! - Use of interfaces and dependency injection for durable design</a></li>
<li><a href="../428077/index.html">React.js: an Intuitive Beginner Guide</a></li>
<li><a href="../428079/index.html">Application of SOLID principles in the development of React-applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>