<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a multiplatform bot for transferring money from card to card using Microsoft Bot Framework V1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During the Microsoft Build 2016 conference, the Microsoft Bot Framework was announced (session with Build 2016: video ). With it, you can create a bot...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a multiplatform bot for transferring money from card to card using Microsoft Bot Framework V1</h1><div class="post__text post__text-html js-mediator-article">  During the Microsoft Build 2016 conference, the Microsoft Bot Framework was announced (session with Build 2016: <a href="https://channel9.msdn.com/Events/Build/2016/B821">video</a> ).  With it, you can create a bot (in C # or Node.js), which can then be connected to various channels / applications: SMS, Skype, Telegram, Slack, etc.  We write a bot using the Bot Builder SDK from Microsoft, and the Bot Connector takes over the problems of interacting with third-party APIs (see image).  It sounds beautiful, we will try to create a simple bot that could transfer money from card to card (let's take the logic of the transfer from Alpha Bank - a test stand, API description: <a href="http://docs.alfabank.ru/">Alpha Bank</a> ), having experienced all the charms of the product in the alpha version. <br><br>  Disclaimer: while writing an article, Microsoft released a new version of the framework, so wait for the second series: we are migrating the bot from v1 to V3. <br><br><img src="https://habrastorage.org/files/27d/0b6/f33/27d0b6f338d3454c8e1e7a61807c37bf.png"><br><a name="habracut"></a><br><h2>  Preparing the development environment </h2><br>  For the successful development of the bot, we will need: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  <a href="https://www.visualstudio.com/">Visual Studio 2015</a> </li><li>  Microsoft account to login to <a href="https://dev.botframework.com/">dev.botframework.com</a> </li><li>  URL with the code of our bot.  This URL must be publicly available. </li><li>  Telegram / Skype / etc developer accounts to be able to add communication channels (for each application, there are different tricks and settings). </li></ol><br>  Now download the project template for the Bot Framework: <a href="http://aka.ms/bf-bc-vstemplate">aka.ms/bf-bc-vstemplate</a> .  To make the new type of project available in Visual Studio 2015, we will copy the downloaded archive into the folder ‚Äú% USERPROFILE% \ Documents \ Visual Studio 2015 \ Templates \ ProjectTemplates \ Visual C #". Now we are ready to create the simplest echo-bot. <br><br><h2>  First bot </h2><br>  Open Visual Studio 2015, we have a new type of project: <br><br><img src="https://habrastorage.org/files/2ee/5a4/8ad/2ee5a48adb40462bb8a6ddf97f71cebd.png"><br><br>  The created project is a Web API project with one controller - <i>MessagesController</i> , which, in turn, has only one available <i>Post</i> method: <br><br><div class="spoiler">  <b class="spoiler_title">MessagesController</b> <div class="spoiler_text"><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">BotAuthentication</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessagesController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> POST: api/Messages </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Receive a message from a user and reply to it </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public async Task</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Message&gt;</span></span></span><span class="hljs-comment"> Post([FromBody]Message message) { if (message.Type == "Message") { // calculate something for us to return int length = (message.Text ?? string.Empty).Length; // return our reply to the user return message.CreateReplyMessage($"You sent {length} characters"); } else { return HandleSystemMessage(message); } } private Message HandleSystemMessage(Message message) { if (message.Type == "Ping") { Message reply = message.CreateReplyMessage(); reply.Type = "Ping"; return reply; } else if (message.Type == "DeleteUserData") { // Implement user deletion here // If we handle user deletion, return a real message } else if (message.Type == "BotAddedToConversation") { } else if (message.Type == "BotRemovedFromConversation") { } else if (message.Type == "UserAddedToConversation") { } else if (message.Type == "UserRemovedFromConversation") { } else if (message.Type == "EndOfConversation") { } return null; } }</span></span></code> </pre> <br></div></div><br><br>  This method accepts a single parameter of the <i>Message</i> type, which represents not only the message sent to our bot, but also an event, for example, adding a new user to the chat or ending a conversation.  To find out exactly what the <i>message</i> object is, you need to check its <i>Type</i> property, which is done in the controller.  If this is a regular message from the user (message.Type == "Message"), we can read the message itself, process it and respond - using the <i>CreateReplyMessage method</i> .  A simple bot is ready, now we try to start it and test its performance.  Microsoft provides a convenient utility Bot Framework Emulator ( <a href="https://aka.ms/bf-v1-emulator">download for v1</a> ), which allows you to conveniently run and debug bots on a local machine.  <i>Launch</i> our <i>EchoBot</i> project, the browser will show such a page at <a href="http://localhost/">localhost</a> : 3978 / <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/810/010/7fd/8100107fdae1440f979bcd50e4ef888d.png"></div><br>  Let's start the now installed Bot Framework Emulator, which knows that our running bot should be looked for on port 3978: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/82c/868/108/82c8681087204cc7aad69af14e0d8f50.png"></div><br>  Send a message to the bot, we will receive an answer.  As you can see, everything works.  Now consider the creation of a bot that, based on the data entered by the user, could transfer money from card to card. <br><br><h2>  Bot to transfer money from card to card </h2><br>  In order to transfer money from card to card, we need information about these cards and the amount of transfer.  To facilitate the task of writing standard scripts using the Microsoft Bot Framework, support was created for the two most common options for interacting with the bot: Dialogs and FormFlow.  In our case, FormFlow is suitable because all the work of a bot can be represented as filling a form with data and then processing it.  Dialogs, on the other hand, allows you to work with simpler scenarios, for example, an alert scenario when a given event occurs (it can be useful for monitoring servers).  Let's start creating a bot by adding a class, which will be a form that the user needs to fill out.  This class must be marked as <i>[Serializable]</i> , and properties from the <i>Microsoft.Bot.Builder.FormFlow</i> namespace are used for property annotation: <br><br><div class="spoiler">  <b class="spoiler_title">CardToCardTransfer</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CardToCardTransfer</span></span> { [Prompt(<span class="hljs-string"><span class="hljs-string">"  :"</span></span>)] [Describe(<span class="hljs-string"><span class="hljs-string">" ,      "</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SourceCardNumber; [Prompt(<span class="hljs-string"><span class="hljs-string">"  :"</span></span>)] [Describe(<span class="hljs-string"><span class="hljs-string">" ,      "</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DestinationCardNumber; [Prompt(<span class="hljs-string"><span class="hljs-string">"VALID THRU ():"</span></span>)] [Describe(<span class="hljs-string"><span class="hljs-string">"VALID THRU ()"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Month ValidThruMonth; [Prompt(<span class="hljs-string"><span class="hljs-string">"VALID THRU ():"</span></span>)] [Describe(<span class="hljs-string"><span class="hljs-string">"VALID THRU ()"</span></span>)] [Numeric(<span class="hljs-number"><span class="hljs-number">2016</span></span>, <span class="hljs-number"><span class="hljs-number">2050</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ValidThruYear; [Prompt(<span class="hljs-string"><span class="hljs-string">"CVV:"</span></span>)] [Describe(<span class="hljs-string"><span class="hljs-string">"CVV (    )"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CVV; [Prompt(<span class="hljs-string"><span class="hljs-string">"  ():"</span></span>)] [Describe(<span class="hljs-string"><span class="hljs-string">"  ()"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount; [Prompt(<span class="hljs-string"><span class="hljs-string">" ():"</span></span>)] [Describe(<span class="hljs-string"><span class="hljs-string">" ()"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Fee; }</code> </pre><br></div></div><br>  In order for the Bot Framework to use the class in FormFlow, all open fields or properties must be of one of the following types: <br><br><ul><li>  Integral types: sbyte, byte, short, ushort, int, uint, long, ulong </li><li>  Numeric floating point types: float, double </li><li>  Strings </li><li>  Datetime </li><li>  Transfers </li><li>  List of listings </li></ul><br>  The <i>Prompt</i> attribute is responsible for what text will be displayed as a hint to fill the field, <i>Describe</i> - what the field will be called for the user.  Now, using the <b>FormBuilder</b> class <b>,</b> we need to tell the Bot Framework that we want to use the <i>CardToCardTransfer</i> class as a form for the dialogue.  Create a new class CardToCardFormBuilder: <br><div class="spoiler">  <b class="spoiler_title">CardToCardFormBuilder</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CardToCardFormBuilder</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IForm&lt;CardToCardTransfer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { FormBuilder&lt;CardToCardTransfer&gt; _order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormBuilder&lt;CardToCardTransfer&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _order .Message(<span class="hljs-string"><span class="hljs-string">"         !"</span></span>) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.SourceCardNumber)) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.ValidThruMonth)) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.ValidThruYear)) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.DestinationCardNumber), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, validateCard) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.CVV)) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.Amount)) .OnCompletionAsync(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (context, cardTocardTransfer) =&gt; { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"{0}"</span></span>, cardTocardTransfer); }) .Build(); } }</code> </pre></div></div><br>  We create an instance of the <b>FormBuilder &lt;CardToCardTransfer&gt;</b> class, indicating that we use <i>CardToCardTransfer</i> as the form.  Now using the call method chain, we do the following <br><br><ol><li>  The <i>Message</i> method sets a welcome message. </li><li>  The <i>Field</i> method sets the fields, the value of which the user must enter, the order is important. </li><li>  The <i>OnCompletionAsync</i> method allows <i>you</i> to specify the delegate that will be called when the user fills in all the fields. </li><li>  The <i>Build</i> method does the main work - returns an object that implements the <i>IForm &lt;CardToCardTransfer&gt;</i> . </li></ol><br>  Everything is quite simple, but now we want to add a simple validation of the entered values ‚Äã‚Äãand the calculation of the commission.  To calculate the commission, we use the fact that we have a class <i>AlfabankService</i> that implements all the interaction with the banking API.  To validate the card number, create the <i>CardValidator</i> class. To specify the delegate used to validate the field, the <i>Field</i> method must be passed to the third parameter.  The calculation of the commission also has to be done in the validation method, because in version 1 the Bot Framework did not provide other mechanisms for this. <br><div class="spoiler">  <b class="spoiler_title">CardToCardFormBuilder with validation and commission calculation</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CardToCardFormBuilder</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IForm&lt;CardToCardTransfer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { FormBuilder&lt;CardToCardTransfer&gt; _order = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormBuilder&lt;CardToCardTransfer&gt;(); ValidateAsyncDelegate&lt;CardToCardTransfer&gt; validateCard = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (state, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cardNumber = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> errorMessage; ValidateResult result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidateResult(); result.IsValid = CardValidator.IsCardValid(cardNumber, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> errorMessage); result.Feedback = errorMessage; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _order .Message(<span class="hljs-string"><span class="hljs-string">"         !"</span></span>) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.SourceCardNumber), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, validateCard) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.Fee), state =&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.ValidThruMonth)) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.ValidThruYear)) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.DestinationCardNumber), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, validateCard) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.CVV)) .Field(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(CardToCardTransfer.Amount), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (state, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> amount = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.ToString()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> alfabankService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlfabankService(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> auth = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> alfabankService.AuthorizePartner(); state.Fee = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> alfabankService.GetCommission(auth, state.SourceCardNumber, state.DestinationCardNumber, amount); ValidateResult result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidateResult(); result.IsValid = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }) .Confirm(<span class="hljs-string"><span class="hljs-string">"   {Amount}    {SourceCardNumber}   {DestinationCardNumber}?   {Fee} . (y/n)"</span></span>) .OnCompletionAsync(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (context, cardTocardTransfer) =&gt; { Debug.WriteLine(<span class="hljs-string"><span class="hljs-string">"{0}"</span></span>, cardTocardTransfer); }) .Build(); } }</code> </pre><br></div></div><br>  The last step is to integrate <i>CardToCardFormBuilder</i> into the controller.  To do this, we need a method that returns an <i>IDialog &lt;CardToCardTransfer&gt;</i> in order to pass it in turn to the <i>Conversation.SendAsync</i> method as a second parameter. <br><div class="spoiler">  <b class="spoiler_title">MessagesController</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">BotAuthentication</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessagesController</span></span> : <span class="hljs-title"><span class="hljs-title">ApiController</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IDialog&lt;CardToCardTransfer&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MakeRoot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Chain.From(() =&gt; FormDialog.FromForm(CardToCardFormBuilder.MakeForm)) .Do(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (context, order) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> completed = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> order; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> alfaService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlfabankService(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> expDate = completed.ValidThruYear.ToString() + ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)completed.ValidThruMonth).ToString(<span class="hljs-string"><span class="hljs-string">"D2"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> confirmationUrl = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> alfaService.TransferMoney(completed.SourceCardNumber, expDate, completed.CVV, completed.DestinationCardNumber, completed.Amount); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> context.PostAsync(<span class="hljs-string"><span class="hljs-string">$"   .    </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{confirmationUrl}</span></span></span><span class="hljs-string">"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FormCanceledException&lt;CardToCardTransfer&gt; e) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> reply; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.InnerException == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { reply = <span class="hljs-string"><span class="hljs-string">$"  ,  !"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { reply = <span class="hljs-string"><span class="hljs-string">",  .  ."</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> context.PostAsync(reply); } }); } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> POST: api/Messages </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Receive a message from a user and reply to it </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public async Task</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Message&gt;</span></span></span><span class="hljs-comment"> Post([FromBody]Message message) { if (message.Type == "Message") { return await Conversation.SendAsync(message, MakeRoot); } else { return HandleSystemMessage(message); } }</span></span></code> </pre></div></div><br>  The actual binding occurs in the Chain.From (() =&gt; FormDialog.FromForm (CardToCardFormBuilder.MakeForm) code, and then in the <i>Do</i> method we pass a method that waits for the completion of the query and processes it, responding to error handling.  Now we can run the bot and test its operation in the emulator: <br><br><img src="https://habrastorage.org/files/6ab/1c7/ea2/6ab1c7ea2b38483aa31f5c8fcab33658.png"><br><br>  You can make sure that the bot works as expected, now we make friends with the Bot Connector. <br><br><h2>  Registering bot in Bot Connector </h2><br>  First we need to download our bot to some public URL, for example, in Azure (a free subscription will do): <a href="https://alfacard2cardbot.azurewebsites.net/">https://alfacard2cardbot.azurewebsites.net</a> .  Now go to <a href="https://dev.botframework.com/">dev.botframework.com</a> using a Microsoft account.  In the top menu, select "Register a Bot", enter all the required fields: name, description, Messaging endpoint - the same public URL, etc. <br><br><img src="https://habrastorage.org/files/40f/df5/33b/40fdf533bff74d1d9e3c767d10a5c652.png"><br><br>  Do not forget to update our web.config, adding there AppId and AppSecret, generated to us at this step.  We will see these changes.  Now our bot has appeared in the ‚ÄúMy Bots‚Äù menu; you can make sure that the Connector Bot interacts correctly with the bot using the ‚ÄúTest connection to your bot‚Äù window at the bottom left.  Now it remains to add interaction with Telegram, to do this, in the right column, select ‚ÄúAdd another channel‚Äù - ‚ÄúTelegram‚Äù - ‚ÄúAdd‚Äù, this window will open, in which the steps describe how to add Telegram bot: <br><br><img src="https://habrastorage.org/files/8e5/132/c59/8e5132c59ea34abfb27541bc3e56004a.png"><br><br><h2>  Source code, testing, conclusion </h2><br>  Telegram bot can write <b>@ AlfaCard2CardBot</b> , money will not be transferred, test environment.  The code can be found in GitHub: <a href="https://github.com/StanislavUshakov/AlfaCardToCardBot">https://github.com/StanislavUshakov/AlfaCardToCardBot</a> . <br>  In the next series we will migrate the bot to version 3! </div><p>Source: <a href="https://habr.com/ru/post/307530/">https://habr.com/ru/post/307530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307520/index.html">PosCardStealer: new malware and large-scale attacks threaten PoS systems</a></li>
<li><a href="../307522/index.html">HR errors by the eyes of the developer</a></li>
<li><a href="../307524/index.html">Introduction to binary technology</a></li>
<li><a href="../307526/index.html">8 tips to work more effectively with Git</a></li>
<li><a href="../307528/index.html">Analyzing NetFlow v.9 of Cisco ASA using Logstash (ELK)</a></li>
<li><a href="../307532/index.html">10 years of online security</a></li>
<li><a href="../307534/index.html">VMware Virtual SAN 6.2: The Technology Future</a></li>
<li><a href="../307536/index.html">How I increased my productivity with streaming</a></li>
<li><a href="../307538/index.html">QRLJacking: a new type of attack threatens the security of users of a number of services and instant messengers</a></li>
<li><a href="../307540/index.html">Microsoft fixes vulnerabilities in Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>