<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Universal ADO.NET Entity Repository</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dear programmers! 
 There was no sadness It took me a lot of work with ASP.NET MVC2 + Entity Framework, but the basic functionality of working with th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Universal ADO.NET Entity Repository</h1><div class="post__text post__text-html js-mediator-article">  Dear programmers! <br>  <s>There was no sadness</s> It took me a lot of work with ASP.NET MVC2 + Entity Framework, but the basic functionality of working with the database didn‚Äôt impress me at all, because I had to choose the right collection of objects from the list each time.  How to avoid writing a few classes and use only one - it goes on. <br><br><h5>  Requirements </h5><br>  To begin with, we‚Äôll decide what we would really like to be at the exit. <br><br>  I want to work with objects more conveniently: <br><ul><li>  Add. </li><li>  Delete. </li><li>  Edit. </li><li>  Receive by ID. </li><li>  Get a list of all objects. </li></ul><br><a name="habracut"></a><br>  using constructions of the form: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">Unit a = <font color="#0000ff">new</font> Unit(); <br> BaseRepository&lt;Unit&gt; unitRepository = <font color="#0000ff">new</font> BaseRepository&lt;Unit&gt;(); <br> ........... <br> unitRepository.AddItem(a); <br> unitRepository.ChangeItem(a); <br> unitRepository.DeleteItem(a.ID);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Moreover, in order not to explicitly specify with which set ( <b>ObjectSet</b> &lt;...&gt;) <b>ObjectContext</b> should work. <br><br><h5>  A bit of reflection theory </h5><br><br>  Since all my code will be based on this principle, you should understand what it is. <br><br>  <i><a href="http://ru.wikipedia.org/wiki/%25D0%259E%25D1%2582%25D1%2580%25D0%25B0%25D0%25B6%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">Reflection</a> is a process during which a program can monitor and modify its own structure and behavior at run time.</i> <br><br>  In short, the base Object class has a GetType () method, which returns the structure of the class (all its properties, fields, methods).  Therefore, we can use it to call a function and set values ‚Äã‚Äãto properties at runtime, even without knowing at the stage of writing code about the presence of these fields and functions in the class. <br><br>  The GetType () method returns a <a href="http://msdn.microsoft.com/en-us/library/system.type.aspx">Type</a> object, which we actually need.  Following the link, you can see for yourself the number and variety of methods and properties of this object.  For now, we need GetMethod () and GetProperty (). <br><br><h5>  Actually implementation </h5><br>  To begin, I will describe the principle of operation. <br><br>  In a nutshell: <br><ol><li>  Get the type of object transferred. </li><li>  Get name from type. </li><li>  Select the desired entity set from the ObjectContext. </li><li>  "Pull" the desired method (Add, Delete). </li></ol><br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Base repository for all sets.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;typeparam name="T"&gt;Class from Business Model, should be EntityType&lt;/typeparam&gt;</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> BaseRepository&lt;T&gt; <font color="#0000ff">where</font> T : EntityObject</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  When transferring an object in angle brackets, we can already get all the necessary data from it (in particular, the name, which is important).  Since the default objects in the <a href="http://msdn.microsoft.com/en-us/library/bb156104.aspx">ObjectContext</a> are called ****** Set, where ****** is the name of the entity in the visual editor.  Using reflection, we get the opportunity to reach out to any set of objects, without specifying this name in the code.  Thus, all the manipulations are performed. <br><br>  For example, in all <b>ObjectSet</b> 's contains the <b>DeleteObject</b> method. <br><br>  Next, we need the <b>ObjectContext</b> itself (where, in fact, we will write and receive data): <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//DataBase container</font> <br> DBContainer db = <font color="#0000ff">new</font> DBContainer();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  You <s>have already received it</s> can be obtained using the wizard and visual editing of objects. <br><br>  A few more lines of code just improve readability: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Reflection - get name of T.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">string</font> name <br> { <br> <font color="#0000ff">get</font> { <font color="#0000ff">return</font> <font color="#0000ff">typeof</font> (T).Name; } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This is getting the type name T (above) and a small ‚Äúmacro‚Äù getting the <b>ObjectContext</b> type: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//Simple macros</font> <br> Type dbT = <font color="#0000ff">typeof</font> (DBContainer);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  In general, the entry is complete and you can go to the whole code.  Further I will tell about not absolutely obvious pieces of code. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">using</font> System; <br> <font color="#0000ff">using</font> System.Collections. <font color="#2B91AF">Generic</font> ; <br> <font color="#0000ff">using</font> System.Linq; <br> <font color="#0000ff">using</font> System.Text; <br> <font color="#0000ff">using</font> System.Reflection; <br> <font color="#0000ff">using</font> System.Data.Objects; <br> <font color="#0000ff">using</font> System.Data.Objects.DataClasses; <br> <br> <font color="#0000ff">namespace</font> Chib.Lib <br> { <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Base repository for all sets.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;typeparam name="T"&gt;Class from Business Model, should be EntityType&lt;/typeparam&gt;</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> BaseRepository&lt;T&gt; <font color="#0000ff">where</font> T : EntityObject <br> { <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Reflection - get name of T.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">string</font> name <br> { <br> <font color="#0000ff">get</font> { <font color="#0000ff">return</font> <font color="#0000ff">typeof</font> (T).Name; } <br> } <br> <br> <font color="#008000">//DataBase container</font> <br> DBContainer db = <font color="#0000ff">new</font> DBContainer(); <br> <font color="#008000">//Simple macros</font> <br> Type dbT = <font color="#0000ff">typeof</font> (DBContainer); <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Get all items in Set as IQueryable, making easy to operate with data.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;returns&gt;Items in Set&lt;/returns&gt;</font> <br> <font color="#0000ff">public</font> IQueryable&lt;T&gt; AllItems <br> { <br> <font color="#0000ff">get</font> <br> { <br> <font color="#0000ff">return</font> (IQueryable&lt;T&gt;)AllItemsAsObj; <br> } <br> } <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Get the items (ObjectSet) as Object. For internal use only.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;returns&gt;Object&lt;/returns&gt;</font> <br> <font color="#0000ff">private</font> <font color="#0000ff">object</font> AllItemsAsObj <br> { <br> <font color="#0000ff">get</font> <br> { <br> PropertyInfo mi = dbT.GetProperty(name + <font color="#A31515">"Set"</font> ); <br> <font color="#0000ff">object</font> obj = mi.GetValue(db, <font color="#0000ff">null</font> ); <br> <font color="#0000ff">return</font> obj; <br> } <br> } <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Add item to collection and save changes.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;typeparam name="T"&gt;The type of item&lt;/typeparam&gt;</font> <br> <font color="#008000">/// &lt;param name="item"&gt;Added item&lt;/param&gt;</font> <br> <font color="#008000">/// &lt;returns&gt;True if no errors.&lt;/returns&gt;</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> AddItem(T item) <br> { <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">object</font> obj = AllItemsAsObj; <br> obj.GetType().GetMethod( <font color="#A31515">"AddObject"</font> ).Invoke(obj, <font color="#0000ff">new</font> <font color="#0000ff">object</font> [] { item }); <br> db.SaveChanges(); <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <font color="#0000ff">catch</font> <br> { <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <br> } <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Get the single T item by it's ID</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;param name="id"&gt;Guid ID&lt;/param&gt;</font> <br> <font color="#008000">/// &lt;returns&gt;Null if nothing found.&lt;/returns&gt;</font> <br> <font color="#0000ff">public</font> T GetItem( <font color="#2B91AF">Guid</font> id) <br> { <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> item <font color="#0000ff">in</font> AllItems) <br> { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">new</font> <font color="#2B91AF">Guid</font> (item.GetType().GetProperty( <font color="#A31515">"ID"</font> ).GetValue(item, <font color="#0000ff">null</font> ).ToString()) == id) <br> <font color="#0000ff">return</font> (T)item; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> } <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Delets an item by it's ID.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;param name="id"&gt;ID of item&lt;/param&gt;</font> <br> <font color="#008000">/// &lt;returns&gt;True if no errors.&lt;/returns&gt;</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> DeleteItem( <font color="#2B91AF">Guid</font> id) <br> { <br> <font color="#0000ff">try</font> <br> { <br> T item = GetItem(id); <br> <font color="#0000ff">object</font> <font color="#0000ff">set</font> = AllItemsAsObj; <br> <font color="#0000ff">set</font> .GetType().GetMethod( <font color="#A31515">"DeleteObject"</font> ).Invoke( <font color="#0000ff">set</font> , <font color="#0000ff">new</font> <font color="#0000ff">object</font> [] { item }); <br> db.SaveChanges(); <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <font color="#0000ff">catch</font> <br> { <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> ChangeItem(T item) <br> { <br> <font color="#0000ff">try</font> <br> { <br> <font color="#0000ff">var</font> guid = <font color="#0000ff">new</font> <font color="#2B91AF">Guid</font> (item.GetType().GetProperty( <font color="#A31515">"ID"</font> ).GetValue(item, <font color="#0000ff">null</font> ).ToString()); <br> T modyfying = AllItems.Single(x =&gt; x.GetType().GetProperty( <font color="#A31515">"ID"</font> ).GetValue( <font color="#0000ff">null</font> , <font color="#0000ff">null</font> ).ToString() == guid.ToString()); <br> modyfying = item; <br> db.SaveChanges(); <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <font color="#0000ff">catch</font> <br> { <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> } <br> <br> <font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Force save changes to DB.</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;returns&gt;True if no errors.&lt;/returns&gt;</font> <br> <font color="#0000ff">public</font> <font color="#0000ff">bool</font> SaveChanges() <br> { <br> <font color="#0000ff">try</font> <br> { <br> db.SaveChanges(); <br> <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; <br> } <br> <font color="#0000ff">catch</font> <br> { <br> <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; <br> } <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h5>  Underwater rocks </h5><br>  Here I would like to explain some points <s>about which I was too lazy to read</s> which did not immediately work, as well as unobvious pieces of code. <br><br>  The private object function AllItemsAsObj () is used to get the object set itself (ObjectSet) and is available only inside the class.  It is needed in almost all cases, since it is our basic object, which will be followed by manipulations. <br><br>  The AddItem (T item) function was written first. <br>  On the move did not want the method Invoke method GetMethod.  It turned out that it is necessary to pass as an argument the object on which we perform actions.  Putting null (as I saw in the examples on unknown sites) the method was not called.  Pay attention to this! <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/// &lt;summary&gt;</font> <br> <font color="#008000">/// Get the single T item by it's ID</font> <br> <font color="#008000">/// &lt;/summary&gt;</font> <br> <font color="#008000">/// &lt;param name="id"&gt;Guid ID&lt;/param&gt;</font> <br> <font color="#008000">/// &lt;returns&gt;Null if nothing found.&lt;/returns&gt;</font> <br> <font color="#0000ff">public</font> T GetItem( <font color="#2B91AF">Guid</font> id) <br> { <br> <font color="#0000ff">foreach</font> ( <font color="#0000ff">var</font> item <font color="#0000ff">in</font> AllItems) <br> { <br> <font color="#0000ff">if</font> ( <font color="#0000ff">new</font> <font color="#2B91AF">Guid</font> (item.GetType().GetProperty( <font color="#A31515">"ID"</font> ).GetValue(item, <font color="#0000ff">null</font> ).ToString()) == id) <br> <font color="#0000ff">return</font> (T)item; <br> } <br> <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  This part of the code selects one object from the set by its ID.  In my project, each object has a field ID like Guid.  If you have it different - just replace all references to "ID" with your name. <br>  In this function, all elements of the collection are searched, and if the value of the ID field coincides with the input parameter, the desired object is returned. <br><br>  At the end of each function there is a line: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">db.SaveChanges();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  It saves all changes made to the database. <br><br><h5>  Usage example </h5><br>  Suppose you have two classes: Unit and City. <br>  To declare two repositories working with the database, do the following: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">BaseRepository&lt;Unit&gt; unitRepository = <font color="#0000ff">new</font> BaseRepository&lt;Unit&gt;(); <br> BaseRepository&lt;City&gt; cityRepository = <font color="#0000ff">new</font> BaseRepository&lt;City&gt;();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Everything, no more manipulations are needed.  You already have ready-made objects that will help in the work.  If you wish, you can extend the functionality with the functions you need by inheriting your class. </div><p>Source: <a href="https://habr.com/ru/post/124619/">https://habr.com/ru/post/124619/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124611/index.html">Leo Tolstoy and static code analysis</a></li>
<li><a href="../124612/index.html">Samsung Galaxy S II - still a cake!</a></li>
<li><a href="../124613/index.html">External web services and traffic-generating sites. Why be friends?</a></li>
<li><a href="../124615/index.html">Discontinued Google Toolbar for Firefox</a></li>
<li><a href="../124617/index.html">Preparations for the launch of Levenhuk-1 (part 2)</a></li>
<li><a href="../124626/index.html">Developer's Brief through the eyes of the customer</a></li>
<li><a href="../124627/index.html">Version migration of the database structure: why it is better not to do this</a></li>
<li><a href="../124628/index.html">LiqPay and PHP4 - implementation experience and problem solving</a></li>
<li><a href="../124629/index.html">At MAKS 2011 with Dassault Systemes</a></li>
<li><a href="../124631/index.html">Odesk-client stopped taking screenshots (OS X Lion)?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>