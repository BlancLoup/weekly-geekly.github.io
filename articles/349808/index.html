<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we do AB-DOC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I want to talk about us and how we do AB-DOC ‚Äî serverless web application that provides an interface to Amazon S3 storage. Read more ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we do AB-DOC</h1><div class="post__text post__text-html js-mediator-article">  In this article, I want to talk about us and how we do <a href="https://ab-doc.com/">AB-DOC</a> ‚Äî serverless web application that provides an interface to Amazon S3 storage.  Read more about AB-DOC in our <a href="https://habrahabr.ru/company/abdoc/blog/346504/">previous article</a> .  Now we will talk about the technological solutions that underlie AB-DOC.  I'll tell you how we built the development and deployment process. <br><br><img src="https://habrastorage.org/webt/fd/jh/ci/fdjhciztd_nxfznmkrvxxhmhd9k.jpeg"><br><br>  In the photo I am at my desk in my home, where I work 90% of the time. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We have a small <a href="https://erp-lab.com/">team</a> , we develop web applications for business automation.  In addition to completing projects to order, we have created and are developing two online services: <br><ol><li>  <a href="https://ab-doc.com/">AB-DOC</a> information storage and systematization service </li><li>  task tracker <a href="https://ab-tasks.ru/">AB-TASKS</a> </li></ol><br>  AB-DOC does not work all our team, but only two people: me and <a href="https://habrahabr.ru/users/igorbb/" class="user_link">IgorBB</a> . <br><br><img src="https://habrastorage.org/webt/6h/he/0j/6hhe0jyhlvfih1_i2mzckzfcyxk.png"><br><br>  So what is AB-DOC? <br><br><h2>  Serverless architecture </h2><br>  Serverless applications are now a powerful trend in the world of web development.  In simple terms, these are applications that operate entirely on the basis of cloud service providers.  Their benefits derive from the characteristics of the cloud services that make them work ‚Äî this is fault tolerance and scalability.  In addition, as with cloud services, their costs are directly dependent on the load.  If there is no load, then the cost is zero.  It is very comfortable and cool. <br><br>  But there is a downside.  The first drawback of serverless applications is a complex development process.  That is, during the initial setup of the infrastructure, and building the development process, they require more effort than regular web applications that have a server.  The second drawback is that such applications are usually dependent on the vendor and transferring them to another cloud provider can be a daunting task. <br><br>  We create applications in Amazon Web Services, so later in the article everything will be related to this cloud provider. <br><br>  Serverless applications usually have a backend.  The backend is a database in the form of a DynamoDB service (NOSQL DBMS) or RDS (relational DBMS).  The code for the backend is implemented as Lambda functions, which are accessed via the API Gateway. <br><br>  AB-DOC has none of this.  He has no backend and server code at all (at least for now). <br><br>  The AB-DOC architecture looks like this. <br><br><img src="https://habrastorage.org/webt/e4/ji/nk/e4jinkcypnwrvhiwe65ihd13yh0.png"><br><br>  Application code (HTML, CSS, JavaScript, etc.) is placed in a separate S3 batch and is sent via CDN CloudFront.  In principle, it would be possible to give directly from S3, because for the buckets you can enable the function of hosting static content. <br><br>  The reason we need CloudFront is not only to speed up the loading of content, but also because we needed a way to redirect all links to index.html.  AB-DOC is a single-page-application (SPA), so when requesting any URL, we need the user to load index.html.  Next, based on the requested URL, JavaScript loads the necessary content for the user using ajax.  We do not use front-end frameworks, so we wrote our own small router. <br><br>  So, in order to redirect all the URLs to index.html, we set up our own 404 error handling rule in CloudFront (page not found). <br><br><img src="https://habrastorage.org/webt/ic/1f/4c/ic1f4cib4o-xf3_ynwh7fwdrs6e.png"><br><br>  Thanks to this rule, CloudFront, when requesting any non-existent URL on our resource, gives index.html with a response code of 200. That's all the magic for implementing a SPA with hosting code in S3. <br><br>  User content is also placed in S3, in a separate batch, and is also provided via CloudFront.  Custom content includes a tree structure (Json), document content (HTML), images embedded in documents and attached files (various formats). <br><br>  Then we will discuss the individual, interesting in my opinion, the nuances of the implementation of our application. <br><br><h2>  Authentication and authorization </h2><br>  After downloading the code to the user's browser, AB-DOC first performs authentication and authorization of the user.  For this we use Cognito. <br><br>  Let me remind you that authentication is the process of authenticating a user, and authorization is the process of endowing this user with certain rights to work in the program. <br><br>  Cognito consists of 3 services: <br><br><ol><li>  User Pools </li><li>  Federated Identities </li><li>  Sync </li></ol><br><br>  If you have not had experience with Cognito services, it will be difficult to understand why each of them is needed.  I write, as I understand it. <br><br><h3>  User Pools </h3><br>  This is a managed service that provides registration, authentication (authentication) of users and storage of their accounts.  It allows you to customize the data fields for each user (that is stored), password complexity policy, whether you will use MFA, various triggers that can be triggered during registration, entry, and so on.  Here you can configure the messages that the service will send to verify the email when registering users. <br><br>  External identity providers (Facebook, Google, Amazon or SAML) can be attached to the User pool.  When you log in through an external provider, an account is created in your User pool.  This basically works if you use the login pages hosted in the Cognito service itself.  That is, you need to redirect users to login to a special URL of the form your-app.auth. [Region] .amazoncognito.com.  You can customize the look of this page so that it looks like the look of your application.  After logging in, the user will be returned to your application.  I did not like this implementation option. <br><br>  For a long time, I tried to implement integration of the User pool with external providers using the Amazon Cognito Identity SDK for JavaScript.  Theoretically, this is also possible, but I could not find any documentation on this topic and I gave up.  It was 2-3 months ago. <br><br><h3>  Federated Identities </h3><br>  Unlike User Pools, this service is responsible for authorizing users, that is, empowering them with certain powers to access AWS services (S3, for example). <br><br>  For this service to work, you need to create an Identity pool and configure authentication providers with which it will work.  Your User pool can act as authentication providers, as well as a number of external providers such as Amazon, Facebook, Google, Twitter, OpenID, SAML, or even an authentication provider that you create yourself. <br><br>  In AB-DOC, we use our User pool and one external provider, Google, as authentication providers.  Therefore, users have 2 options: <br><br><ol><li>  Create a new account (create a login password, confirm email).  In this case, an account is created for it in the User pool and then an entry is created in the Identity pool, thanks to which it obtains the necessary permissions. </li><li>  Sign in with your google account.  Then the account in the User pool is not created, the user simply creates an entry in the Identity pool, and he is given the necessary permissions to work with the application. </li></ol><br><br>  The process of empowering the Identity pool is pretty simple.  For Identity pool are selected in 2 roles from AWS Identity and Access Management (IAM): for authenticated and unauthenticated users. <br><br>  For each role in IAM, you can link any policies that will arbitrarily give users the necessary rights.  Customization is possible through the use of variables in policies.  For example, in order to give write access to users only within their folder in the S3 batch, we use this variable in the resource description <br><pre><code class="hljs perl">... <span class="hljs-string"><span class="hljs-string">"Resource"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arn:aws:s3:::ab-doc-storage/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${cognito-identity.amazonaws.com:</span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">}", "</span></span></span><span class="hljs-title"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-title">arn</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">:</span></span></span><span class="hljs-title"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-title">aws</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">:</span></span></span><span class="hljs-title"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-title">s3</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">:::</span></span></span><span class="hljs-title"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-title">ab</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">-</span></span></span><span class="hljs-title"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-title">doc</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">-</span></span></span><span class="hljs-title"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-title">storage</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">/$</span></span></span></span><span class="hljs-string"><span class="hljs-subst">{cognito-identity.amazonaws.com:</span></span><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span></span></span><span class="hljs-string"><span class="hljs-subst"><span class="hljs-function">}/*", ] ...</span></span></span></span></span></span></code> </pre> <br><br>  Thus, instead of <b>$ {cognito-identity.amazonaws.com:sub}</b> for each user, its ID in the Identity pool is substituted into the policy.  Each user works inside his folder in the batch, whose name corresponds to his id in the Identity pool. <br><br>  The word folder here could be put in quotes, because in fact there are no folders in S3.  This is a flat file system.  Each file simply has a key (Key), and the division into "folders" is conditional. <br><br><h3>  Sync </h3><br>  This service provides data storage for users of the application.  Data placed in Sync is stored as key-value sets (Datasets), which are tied to the user id in the Identity pool.  Thus, Sync allows you to save arbitrary information on all users, through which they are not authenticated: whether it is User pool or an external provider.  In addition, Sync provides synchronization of data sets between all devices on which the user works in the application. <br><br>  In general, authorization is built on tokens.  The JavaScript code responsible for it currently makes up more than 1/3 of the entire application code.  That is, this is quite a voluminous topic, and maybe I will write a separate article about it in the future. <br><br><h2>  Track changes and event queues </h2><br>  AB-DOC itself keeps track of and saves the changes that the user makes when editing tree nodes or document contents. <br><br>  The operation of this mechanism is based on JavaScript timers: setInterval ().  Separate timers are created for the tree and for the document, which check once every 3 seconds whether the changes have appeared, and if so, save them in S3.  Timers in the application are centrally created via the TIMERS object. <br><br>  For centralized change tracking, we wrote an ACTIVITY object, which is responsible for event queue management.  The queue is formed in accordance with the options of content that the user can create.  The tree has its own queue, the document has its own queue, each queue has its own queue, and so on. <br><br>  The events recorded in the queue can be of two types: pending or saving.  The logic of the queues as follows. <br><br>  When the user makes some editing, a wait event is added to the desired queue.  In the tree, events are added directly from the code that handles changes, and changes to documents are tracked thanks to Mutation Observer. <br><br>  Then, when the corresponding timer is triggered, a <b>save</b> event is added to the queue, and the process of uploading changes to S3 begins.  After a successful download, this queue is cleared until the last <b>save</b> event.  At the time of cleaning in the queue there may be new <b>wait</b> events that will wait for the next 3 second cycle. <br><br>  This is how it looks in the example of the doc modify queue, which is responsible for document changes. <br><br><img src="https://habrastorage.org/webt/le/uo/6t/leuo6tq-lswcokyx2d1_zikzbj4.jpeg"><br><br>  The change indicator in the header reflects the status of the event queues. <br><br>  When nothing happens and all queues are empty, the indicator is not displayed. <br><img src="https://habrastorage.org/webt/pi/jq/-r/pijq-rxtmrhglrg0iitrcybx4iw.png"><br>  If there are <b>waiting</b> events in the queues, it is represented by an orange pencil. <br><img src="https://habrastorage.org/webt/ux/1d/py/ux1dpym2yehrnrionse--gqrgzo.png"><br>  If there are queues in which the <b>saving</b> process is in progress, the indicator turns white. <br><img src="https://habrastorage.org/webt/om/sf/u-/omsfu-oiyy7espxbpmd8bxist3i.png"><br><br>  If the queues are not empty, and the user tries to close the browser or just leave the page, then the window.onbeforeunload () function will work.  She will warn the user that his edits have not yet survived.  He can either wait for the save to finish or leave the page, losing the last changes. <br><br>  The indicator is written to the $ update variable: <br><pre> <code class="javascript hljs">$update = $(<span class="hljs-string"><span class="hljs-string">'#update'</span></span>);</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Object code TIMERS</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//TIMERS object //tracks all timers and prevents memory leaks //call TIMERS.set('name') to create new timer //call TIMERS.&lt;timer_name&gt;.destroy() to destroy timer //call TIMERS.&lt;timer_name&gt;.execute() to execute timer TIMERS = { on: true, //timers are ON when true set: function(callback, interval, name){ if(['on', 'set', 'execute', 'destroy', 'Timer'].indexOf(name) !== -1){ throw new Error('Invalid timer name: ' + name); } if(this.hasOwnProperty(name) &amp;&amp; this[name].id !== 0){ //automatically clears previous timer this[name].destroy(); } if(this.on || PRODUCTION){ this[name] = new this.Timer(callback, interval); } else { this[name] = { id: 0, execute: callback, destroy: function(){ void(0); } } } }, Timer: function(callback, interval){ //timer constructor this.id = setInterval(callback, interval); this.execute = callback; this.destroy = function(){ clearInterval(this.id); }; } };</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ACTIVITY object code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//ACTIVITY object //stores activities states and updates indicator in navbar. //Activities: doc edit, file [guid] upload, file [guid] delete or whatever. //Two possible states: pending or saving. //Each activity on each specific object must be reported independently! //"saving" class is "!important", so it dominates if both classes are active ACTIVITY = { lines: {}, //each activity has own line of pending and saving events push: function (activity, state){ var self = this; if(this.lines.hasOwnProperty(activity)){ this.lines[activity].push(state); } else { this.lines[activity] = [state]; } this.refresh(); return self; }, get: function(activity){ var self = this; if(this.lines.hasOwnProperty(activity)){ var length = this.lines[activity].length; return this.lines[activity][length-1]; } else { return undefined; } }, flush: function(activity){ var self = this; if(this.lines.hasOwnProperty(activity)){ var index = this.lines[activity].indexOf('saving'); if(index !== -1){ this.lines[activity] = this.lines[activity].slice(index+1); } } this.refresh(); return self; }, drop: function(activity){ var self = this; if (this.lines.hasOwnProperty(activity)){ delete this.lines[activity]; this.refresh(); } return self; }, refresh: function(){ var keys = Object.keys(this.lines), pending = false, saving = false; for (var i = 0; i &lt; keys.length; i++) { pending = pending || this.lines[ keys[i] ].indexOf('pending') !== -1; saving = saving || this.lines[ keys[i] ].indexOf('saving') !== -1; } pending ? $update.addClass('pending') : $update.removeClass('pending'); saving ? $update.addClass('saving') : $update.removeClass('saving'); } }</span></span></code> </pre> <br></div></div><br>  Again, using the example of a document, the process looks like this.  When you open a document, the event handler changes the content of the document (inside it is Mutation Observer).  The handler simply adds the <b>wait</b> event to the doc queue to modify: <br><pre> <code class="javascript hljs">editor.on(<span class="hljs-string"><span class="hljs-string">'text-change'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ACTIVITY.push(<span class="hljs-string"><span class="hljs-string">'doc modify'</span></span>, <span class="hljs-string"><span class="hljs-string">'pending'</span></span>); });</code> </pre> <br><br>  The document timer every 3 seconds checks the doc modify queue for <b>wait</b> events and loads the document content into S3 if necessary, and then clears the queue: <br><pre> <code class="javascript hljs">TIMERS.set(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ACTIVITY.get(<span class="hljs-string"><span class="hljs-string">'doc modify'</span></span>) === <span class="hljs-string"><span class="hljs-string">'pending'</span></span>){ ACTIVITY.push(<span class="hljs-string"><span class="hljs-string">'doc modify'</span></span>, <span class="hljs-string"><span class="hljs-string">'saving'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-attr"><span class="hljs-attr">Bucket</span></span>: STORAGE_BUCKET, <span class="hljs-attr"><span class="hljs-attr">Key</span></span>: self.ownerid + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + self.docGUID + <span class="hljs-string"><span class="hljs-string">'/index.html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">Body</span></span>: self.editor.root.innerHTML, <span class="hljs-attr"><span class="hljs-attr">ContentType</span></span>: <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>, <span class="hljs-attr"><span class="hljs-attr">ContentDisposition</span></span>: abUtils.GetContentDisposition(<span class="hljs-string"><span class="hljs-string">'index.html'</span></span>), <span class="hljs-attr"><span class="hljs-attr">ACL</span></span>: <span class="hljs-string"><span class="hljs-string">'public-read'</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([ s3.upload(params).promise(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">res, rej</span></span></span><span class="hljs-function">) </span></span>{ setTimeout(res, <span class="hljs-number"><span class="hljs-number">800</span></span>); }) ]).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ ACTIVITY.flush(<span class="hljs-string"><span class="hljs-string">'doc modify'</span></span>); }).catch(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ g.abUtils.onWarning(g.abUtils.translatorData[<span class="hljs-string"><span class="hljs-string">'couldNotSave'</span></span>][g.LANG]); }); } }, <span class="hljs-number"><span class="hljs-number">3000</span></span>, <span class="hljs-string"><span class="hljs-string">'doc'</span></span>);</code> </pre><br><br>  There is a funny moment here, due to the fact that loading in S3 is usually very fast.  Therefore, so that the save indicator does not flicker, we use Promise.all (), which is triggered when the two Promise completes: the actual s3.upload () and the small setTimeout () with a duration of 0.8 seconds.  It is necessary for the indicator to show saving for at least 0.8 seconds, even if, in fact, the changes loaded faster. <br><br><h2>  Download and store data in S3 </h2><br>  Each user in S3 is allocated a separate folder whose name matches its id in the Identity pool.  In the root of this folder, AB-DOC saves the tree.json file, which stores the structure of the user's tree. <br><br>  The file format for tree.json is: <br><pre> <code class="hljs json">[ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"GUID  ()"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"  ()"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [...] }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [...] }, ... ] }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"GUID  ()"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"  ()"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [...] }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"children"</span></span>: [...] }, ... ] }, ... ]</code> </pre> <br>  This structure is used unchanged as a data source for zTree when rendering a tree. <br><br>  Each document is stored in a separate subfolder, the name of which coincides with the document guid.  Inside this folder is saved file index.html, which actually is a document.  In addition to this file, images inserted into the document are saved as separate objects in the document folder, and all files attached to the document are stored in the attachments subfolder. <br><br>  All data is downloaded <u>directly from the user's browser</u> to S3 using the AWS JavaScript SDK <a href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/S3.html">upload ()</a> function.  She is able to upload files to S3, breaking them into parts (multipart upload) and doing it in several streams. <br><br>  For example, the files attached to the document are loaded into 4 streams in this way, with splitting into parts of 6 MB each.  This code works inside the abDoc object (document), self in this case = this object. <br><pre> <code class="javascript hljs">ACTIVITY.push(<span class="hljs-string"><span class="hljs-string">'doc file upload'</span></span>, <span class="hljs-string"><span class="hljs-string">'saving'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileGUID = abUtils.GetGUID(), key = self.ownerid + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + self.docGUID + <span class="hljs-string"><span class="hljs-string">'/attachments/'</span></span> + fileGUID, partSize = <span class="hljs-number"><span class="hljs-number">6</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> file_obj = { <span class="hljs-attr"><span class="hljs-attr">guid</span></span>: fileGUID, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: file.name, <span class="hljs-attr"><span class="hljs-attr">iconURL</span></span>: abUtils.mimeTypeToIconURL(file.type), <span class="hljs-attr"><span class="hljs-attr">key</span></span>: key, <span class="hljs-attr"><span class="hljs-attr">size</span></span>: file.size, <span class="hljs-attr"><span class="hljs-attr">percent</span></span>: <span class="hljs-string"><span class="hljs-string">'0%'</span></span>, <span class="hljs-attr"><span class="hljs-attr">abortable</span></span>: file.size &gt; partSize <span class="hljs-comment"><span class="hljs-comment">//only multipart upload can be aborted }; var params = { Bucket: STORAGE_BUCKET, Key: key, Body: file, ContentType: file.type, ContentDisposition: abUtils.GetContentDisposition(file.name), ACL: 'public-read' }; var upload = s3.upload(params, {partSize: partSize, queueSize: 4}); upload.on('httpUploadProgress', function(e) { var $file = $('.file-container[data-guid='+fileGUID+']'); if(!$file.hasClass('freeze')){ file_obj.percent = Math.ceil(e.loaded * 100.0 / e.total) + '%'; var $file_size = $file.find('.file-size'); $file_size.css('width', file_obj.percent); if($file_size.attr('data-text')){ $file_size.text( file_obj.percent ); } } }); upload.send(function(err, data) { if(err) { if (err.name !== 'RequestAbortedError') { abUtils.onError(err); } } else { var params = { Bucket: data.Bucket, Prefix: data.Key }; s3.listObjectsV2(params, function(err, data) { if (err) { abUtils.onError(err); } else { file_obj.modified = data.Contents[0].LastModified; self.updateFilesList(); ACTIVITY.flush('doc file upload'); } }); } });</span></span></code> </pre><br><br>  The httpUploadProgress event allows you to track download progress and update the progress bar of the file. <br><br>  The s3 object (AWS JavaScript SDK) uses credentials, which include the id Identity pool, user id token and authentication provider name.  All calls to the S3 service are made with the transfer of the user‚Äôs token id.  The user is endowed with those rights that are specified in the policy associated with the role, which in turn is set in the Identity pool.  The same principle works with other AWS services via the JavaScript SDK.  Id token has a short lifespan (1 hour), after which you need to get a new id token with the help of refresh token.  Refresh token has a lifespan of 365 days. <br><br><h2>  Free Space Indicator </h2><br>  At first glance it may seem that this is a very simple thing, but it is not quite so. <br><br><img src="https://habrastorage.org/webt/f6/-8/jx/f6-8jxes0vrgaljkotcctyhxtcy.png"><br><br>  We made an indicator of the free space in the form of a basket: narrow at the bottom and diverging up.  We wanted to make the basket visually consistent with how the basket would be filled in the physical world.  That is, at first it is filled quickly, since it is narrower from below.  And as you fill, the level rises more and more slowly due to its expansion upwards. <br><br>  To realize this, we used <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25BE%25D1%2580%25D0%25BC%25D1%2583%25D0%25BB%25D0%25B0_%25D0%25BF%25D0%25BB%25D0%25BE%25D1%2589%25D0%25B0%25D0%25B4%25D0%25B8_%25D0%2593%25D0%25B0%25D1%2583%25D1%2581%25D1%2581%25D0%25B0">the Gauss area formula</a> for quadrilaterals. <br><br><img src="https://habrastorage.org/webt/rh/iy/u3/rhiyu34xy5xl1f-qjd8tfnnmmzi.png"><br><br>  Using this formula, using the coordinates of the basket points, we can calculate the area of ‚Äã‚Äãthe entire basket - this corresponds to the maximum free space limit of 1 GB.  Further, based on the value of the volume filled by the user, we calculate, using a simple proportion, the area of ‚Äã‚Äãthe part of the basket that will be occupied by the user. <br><br>  Having occupied the user space, it remains to calculate the Y-coordinate of the upper boundary of the filled space based on the above formula.  The X-coordinates of the upper points of the occupied space are displayed through the tangent of the angle of the basket.  In general, as a result of the output Y, I got, although terrible in appearance, but the usual quadratic equation.  On the board it is in the lower right corner. <br><br><img src="https://habrastorage.org/webt/mw/il/wx/mwilwxm2y1uspjxiymszxi3vcck.png"><br><br>  On the board, size indicates the length of the side of the square into which the basket fits.  For example, size = 30 on the blackboard. It was necessary to derive a general formula, so I used the notation size. <br><br>  Now, when I write these lines, vague doubts crept in.  Probably, I was very wise and could be inferred much easier, considering that the figures are equi-sided trapeziums ... <br><br>  To draw the indicator, we used the amazing <a href="http://svgjs.com/">SVG.js</a> library, which allows you to draw SVG graphics in JavaScript.  And you can not just draw, but also manipulate graphic primitives, do animation, and even hang event handlers on graphic elements.  The last opportunity, however, we did not use. <br><br><div class="spoiler">  <b class="spoiler_title">Here is the function that draws the indicator.</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> size = <span class="hljs-number"><span class="hljs-number">32</span></span>, bucket_capacity = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxUsedSpace, space_occupied = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userUsedSpace + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userUsedSpaceDelta + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userUsedSpacePending; <span class="hljs-comment"><span class="hljs-comment">//bucket coords var bx1 = 2, bx2 = 5, bx3 = size - bx2, bx4 = size - bx1, by1 = 2, by2 = size - by1, by3 = by2, by4 = by1, tg_alpha = (bx2 - bx1) / (by2 - by1); //calculate areas var barea = Math.abs(bx1*by2 + bx2*by3 + bx3*by4 + bx4*by1 - bx2*by1 - bx3*by2 - bx4*by3 - bx1*by4) / 2, sarea = Math.min(1.0, space_occupied / bucket_capacity) * barea; //calculate y of the occupied space (see sizeIndicator.jpg for details) var a = -2*tg_alpha, b = 3*tg_alpha*by2 + bx3 + size - 3*bx2 + tg_alpha*by3, c = bx2*by2 - tg_alpha*Math.pow(by2, 2) + 2*bx2*by3 - bx3*by2 - size*by3 - tg_alpha*by2*by3 + 2*sarea, D = Math.pow(b, 2) - 4*a*c, y = (-b + Math.sqrt(D)) / (2*a); //occupied space coords var sx1 = Math.ceil(bx2 - by2*tg_alpha + y*tg_alpha), sx2 = bx2, sx3 = bx3, sx4 = size - sx1, sy1 = Math.ceil(y)-2, sy2 = by2, sy3 = by3, sy4 = sy1; //draw if(!this.sizeIndicator){ this.sizeIndicator = SVG('sizeIndicator'); this.sizeIndicator.space = this.sizeIndicator .polygon([sx1,sy1, sx2,sy2, sx3,sy3, sx4,sy4]) //occupied space .fill('#DD6600'); this.sizeIndicator.bucket = this.sizeIndicator .polyline([bx1,by1, bx2,by2, bx3,by3, bx4,by4]).fill('none') //bucket shape .stroke({ color: '#fff', width: 3, linecap: 'round', linejoin: 'round' }); } else { this.sizeIndicator.space .animate(2000) .plot([sx1,sy1, sx2,sy2, sx3,sy3, sx4,sy4]); } //update tooltip $('#sizeIndicator').attr('title', g.abUtils.GetSize(space_occupied) + ' / ' + g.abUtils.GetSize(bucket_capacity)); }</span></span></code> </pre> <br></div></div><br><br><h2>  Pro mobile version </h2><br>  We do not plan to create a separate mobile application.  Because the mobile application needs to be additionally installed, which users do not like to do very much.  And because for this, you will actually need to make a separate application, which will complicate the support and development of the project.  Instead, we are going to follow the path of a progressive web application (Progressive Web App or PWA).  But at the moment AB-DOC is not.  So far we have just tried to make work in the application from mobile browsers as complete and convenient as possible. <br><br>  On mobile devices with a screen width of less than 600px, the application begins to behave somewhat differently.  On such devices, it works only in one of two modes: tree or document.  In general, we were able to fully maintain functionality on touch devices, including drag'n drop tree nodes and attachment of files to documents. <br><br>  However, while the application does not allow working with documents without an Internet connection.  This is a key feature that will be implemented when creating a PWA. <br><br>  One of the difficulties that we faced when working to adapt the application on mobile devices is the lack of convenient tools for testing. <br><br>  It is not difficult to open an application running on the developer‚Äôs local machine from a mobile device.  You can go to the local address via Wi-Fi.  You can create a domain for this and send it to your external IP, and forward the port to the local machine on the router.  And then this domain will become the address of the application on the local machine. <br><br>  There is also an option using Wi-Fi via a usb adapter if it is not possible to get into the settings of the router.  He came up with <a href="https://habrahabr.ru/users/igorbb/" class="user_link">IgorBB</a> .  You can read more about this option in my AB-DOC tree: <a href="https://ab-doc.com/eu-west-1_a01c087d-a71d-401c-a599-0b8bbacd99e5/d4b68bc3-2f32-4a3a-a57c-15cb697e8ef3">https://ab-doc.com/eu-west-1_a01c087d-a71d-401c-a599-0b8bbacd99e5/d4b68bc3-2f32-4a3a-a57c-15cb697e8ef3</a> . <br><br>  The main problem with testing is that there is no developer console in mobile browsers.  For now, we display debug information through alert (), which of course is not a good option.  But we have not yet implemented a more adequate method. <br><br><h2>  Development and deployment </h2><br>  The development process is fairly simple, since only two people work on the project.  We use git and a private BitBucket repository.  The master branch is production code.  Only from it we do.  We work on all functions / errors in separate branches.  Each branch corresponds to a separate task in our own task tracker <a href="https://ab-tasks.ru/">AB-TASKS</a> .  We try to merge the branches with the master and deploy. <br><br>  The deployment process is that we need to load the application code into the S3 baket.  There are some nuances. <br><br>  As I wrote above, we use CloudFront to upload content.  We need to provide a mechanism whereby the content will almost always be delivered from the CloudFront cache, but when we upload an updated version of the file (image, css, js, html or any other file), CloudFront must update the file in its cache.  Otherwise, there may be unpleasant situations in which the user receives, for example, some of the files from the cache, and some updated from the source (S3).  This can lead to unpredictable consequences. <br><br>  To return the application code, we use a separate CloudFront Distribution with one source in the form of an S3 baket, containing the source code AB-DOC, and with two caching rules (Cache Behaviors). <br><br>  The caching rule determines how CloudFront will cache certain files.  To configure the rule, a request pattern is set (* .html or images / *. Jpg and the like) and settings that will be applied when the request matches the specified pattern.  Settings include HTTP methods for which caching is active, TTL parameters or the lifetime of objects in the cache (min, max, default), compression, and based on what caching is actually performed (are the parameters taken into account, cookies ...), plus a number of other parameters. <br><br>  We set up 2 caching rules: <br><ul><li>  The first rule for HTML files.  Small TTLs are set in their caching settings (Minimum TTL = 100 seconds).  Provided that we set max-age = 0 for these files, the minimum TTL is applied, that is, HTML files after 100 seconds are considered expired, and CloudFront contacts the source to check if there is a more recent version of the file. </li><li>  The second rule for all other files.  For these files, we do not set the cache-control max-age file headers, so the maximum of two values ‚Äã‚Äãis used for them: minimum TTL and default TTL.  In our case, this is 86400 seconds or 24 hours, that is, they are cached for a long time.  But beyond that, in the rule settings, we indicate that CloudFront should ‚Äúlook‚Äù at the request parameters when caching objects. </li></ul><br><br>  This is where the <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html">AWS documentation</a> describes how the various TTL and cache-control settings are combined. <br><br>  Query parameters make caching easy to manage.  For all files we add the conditional version of the file as a parameter: <b>filename.extension? V = 123</b> .  If the file is changed, you only need to change the value of the parameter, and this will force CloudFront to return the file not from the cache, but by referring to the source. <br><br>  However, it would be very tiring to track changes to files and manually updating links to them, and by and large it is impossible.  We would constantly forget to do it.  Therefore, we wrote a bash script that does this automatically.  At the same time, it performs a number of functions for the full deployment of the application code in S3. <br><br>  Here are the actions he performs: <br><ol><li>  It scans all HTML files.  With <b>grep it</b> finds all references to images, styles, scripts.  Checks the timestamp of the last change of each file using the <b>stat</b> command.  If the file has changed since the last pass of the script, it uses <b>sed to</b> update the timestamp in the v = [timestamp] parameter in the file reference. </li><li>  In the script config, you can indicate to it which JavaScript files we want to assemble into a single bundle.    ,    babel     .           . </li><li>        S3     HTML    ,   : <br><pre> <code class="bash hljs">aws s3 sync <span class="hljs-variable"><span class="hljs-variable">$PACKAGE</span></span> s3://<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bucket</span></span></span><span class="hljs-string">"</span></span>/ --delete --acl public-read --exclude <span class="hljs-string"><span class="hljs-string">"*.html"</span></span> aws s3 sync <span class="hljs-variable"><span class="hljs-variable">$PACKAGE</span></span> s3://<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bucket</span></span></span><span class="hljs-string">"</span></span>/ --delete --acl public-read --cache-control max-age=0 --exclude <span class="hljs-string"><span class="hljs-string">"*"</span></span> --include <span class="hljs-string"><span class="hljs-string">"*.html"</span></span></code> </pre> </li></ol><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash # This script is used for deployment # It uploads files to the bucket, corrects timestamps of files included in HTML, bundles js scripts. # To use this script you need a config file: # .service/deploy.config : # bucket=mybucket # exclude=.git/*,.service/*,secret_file # Files and directories to exclude from uploading # bundle=script1.js,script2.js,script3.js # Scripts listed here would be removed from HTML files and bundeled into a single file, which will be minified. A separate bundle is created for every HTML file # You also need to install babel-cli and babel-preset-minify from npm: # npm install --save-dev babel-cli # npm install --save-dev babel-preset-minify # If you want this script to correct timestamps in HTML, you should include them with a ?v=&lt;number&gt; : &lt;link rel="apple-touch-icon" sizes="180x180" href="/apple.png?ver=v123"&gt; # You can use following options: # -v,--verbose - for detailed output # -n,--no-upload - do not upload result into bucket VERBOSE=false NO_UPLOAD=false PACKAGE="package" TMP="$PACKAGE/.temp" CONFIG=".service/deploy.config" PATH="$PATH:./node_modules/.bin" function log() { local message=$1 if [ "$VERBOSE" = true ] ; then echo $message fi } function error() { echo "$1" } bundle_n=0 function create_bundle() { local html_source_file=$1 echo "Creating bundle for \"$html_source_file\"..." #this is a grep command local grep0="$BUNDLE_GREP $html_source_file" #name before babel local bundle_before_babel="$TMP/ab.doc.bundle$bundle_n.js" #name to be used in html local bundle_after_babel_src="scripts/ab.doc.bundle$bundle_n.min.js" #name after babel local bundle_after_babel="$PACKAGE/$bundle_after_babel_src" $grep0 | while read -rx; do log "Adding \"$x\" to bundle" echo -en "//$x\n" &gt;&gt; $bundle_before_babel cat $x &gt;&gt; $bundle_before_babel echo -en "\n" &gt;&gt; $bundle_before_babel done # if files for bundling were found in html if [ -f $bundle_before_babel ] then #putting bundle through babel log "\"$bundle_before_babel\" &gt;===(babel)===&gt; \"$bundle_after_babel\"" npx --no-install babel "$bundle_before_babel" --out-file "$bundle_after_babel" --presets=minify #removing bundeled scripts from file log "Removing old scripts from \"$html_source_file\"..." sed="sed -i.bak -e \"" grep1="$BUNDLE_GREP -n $html_source_file" lines=($($grep1 | cut -f1 -d:)) for ln in ${lines[*]} do sed="$sed$ln d;" done sed="$sed\" $html_source_file" eval $sed #adding bundle instead of old scripts log "Adding bundle to \"$html_source_file\"..." current_time=$(stat -c %Y .$filename) sed -i.bak -e "${lines[0]}i&lt;script src=\"/$bundle_after_babel_src?ver=v$current_time\"&gt;&lt;/script&gt;" $html_source_file rm $html_source_file.bak bundle_n=$(expr $bundle_n + 1) fi } function update_versions() { local html_source_file=$1 local found=0 local modified=0 #set file versions according to modify timestamp echo "Updating file versions in \"$html_source_file\"..." grep -oE "\"[^\"]+\?ver=v[^\"]+\"" $html_source_file | while read -r href ; do ((found++)) local href="${href//\"/}" local current_timestamp=$(echo $href | grep -oE "[0-9]+$") local filename="${href/?ver=v[0-9]*/}" local new_timestamp=$(stat -c %Y $PACKAGE$filename) log $new_timestamp if [ "$current_timestamp" != "$new_timestamp" ] then ((modified++)) sed -i "s|$filename?ver=v[0-9]*|$filename?ver=v$new_timestamp|g" $html_source_file fi log "Found $found, modified $modified" done } function init_directory() { local path=$1 log "Creating empty directory \"$path\"" if [ -d "$path" ]; then log "\"$path\" already exists. Removing \"$path\"" rm -rf "$path" fi mkdir "$path" } echo "==== Initialization ====" # check flags while [[ $# -gt 0 ]] do key="$1" case $key in -v|--verbose) VERBOSE=true shift ;; -n|--no-upload) NO_UPLOAD=true shift ;; *) shift ;; esac done if [ ! -f $CONFIG ]; then error "Could not load config \"$CONFIG\"." exit -1 fi . $CONFIG exclude=${exclude//,/ } if ! npm list babel-preset-minify &gt; /dev/null ; then error "babel-preset-minify is not installed" exit -2 fi if ! npm list babel-cli &gt; /dev/null ; then error "babel-cli is not installed" exit -3 fi if [ -v bundle ]; then log "Using bundle" bundle=${bundle//,/ } BUNDLE_GREP="grep " for b in $bundle do BUNDLE_GREP="$BUNDLE_GREP -o -e $b " done else log "Not using bundle" fi # create package and tmp directories echo "==== Creating temporary directories ====" init_directory "$PACKAGE" init_directory "$TMP" # copying everything into package excluding files listed in $exclude copy="tar -c --exclude \"$PACKAGE\" " files_to_exclude="$exclude $bundle" #( "${exclude[@]}" "${bundle[@]}" ) for e in $files_to_exclude do log "Excluding $e" copy="$copy --exclude \"$e\"" done copy="$copy . | tar -x -C $PACKAGE" eval $copy echo "==== Working with HTML files ====" for f in $(find $PACKAGE -name '*.html') do if [ -v bundle ]; then create_bundle $f fi update_versions $f done rm -rf $TMP if [ "$NO_UPLOAD" = false ] ; then echo "==== S3 upload ====" #upload to S3 aws s3 sync $PACKAGE s3://"$bucket"/ --delete --acl public-read --exclude "*.html" aws s3 sync $PACKAGE s3://"$bucket"/ --delete --acl public-read --cache-control max-age=0 --exclude "*" --include "*.html" fi echo "==== Cleaning up ====" rm -rf $PACKAGE exit 0</span></span></code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/349808/">https://habr.com/ru/post/349808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349796/index.html">Why I don't like DevOps (and modern software)</a></li>
<li><a href="../349798/index.html">Automate the removal of forgotten transactions</a></li>
<li><a href="../349800/index.html">Depth training with reinforcements does not work yet</a></li>
<li><a href="../349802/index.html">Multi-stage (multi-stage builds) builds in Docker</a></li>
<li><a href="../349804/index.html">From a series of conversations with colleagues or a grain of experience: DC Edge design</a></li>
<li><a href="../349810/index.html">Hyperapp for Refugees with React / Redux</a></li>
<li><a href="../349812/index.html">Segregated Witness for Dummies</a></li>
<li><a href="../349816/index.html">Open webinar "Features of JavaScript"</a></li>
<li><a href="../349818/index.html">Asynchronous HTTP requests in C ++: incoming through RESTinio, outgoing through libcurl. Part 2</a></li>
<li><a href="../349820/index.html">–ï–ì–ê–ò–° 3.0 - 100% readiness! Alcohol accounting markup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>