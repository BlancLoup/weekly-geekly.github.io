<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We continue to optimize costs with Yota</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will focus on automating the management of YOTA tariffs using curl, OpenWRT and MR-3020. The proposed scripts can be used in another * ni...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We continue to optimize costs with Yota</h1><div class="post__text post__text-html js-mediator-article">  This article will focus on automating the management of YOTA tariffs using curl, OpenWRT and MR-3020.  The proposed scripts can be used in another * nix environment with curl installed. <br><a name="habracut"></a><br><br><h4>  Prologue </h4><br>  It so happened that about a month ago I became the happy (or not) owner of the YOTA LTE modem.  In the absence of other alternatives, one has to use it as the main home source of access to the global web. <br><br>  To distribute the Internet around the apartment (due to the high cost of Yotov devices), it was decided to use the YOTA + TP-LINK MR-3020 modem with <a href="http://ru.wikipedia.org/wiki/OpenWrt">OpenWRT</a> on board.  The choice fell on the MR-3020 as a compact and cheapest router with a USB port and support for OpenWRT. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the stock MR-3020 curl will not, not enough space.  More specifically, there is not enough space for libopenssll, where the libcrypto library weighs more than 1 MB.  In this situation, the easiest way out is to load libopenssll into RAM after loading the router, the installation instructions below.  I use an additional usb hub + usb-hdd, which is mounted to rootfs, minidlna, samba and transmission are also installed on the hdd, respectively, for downloading torrents and watching them on TV and facing the problem of lack of space. <br><br>  It should be noted that setting up OpenWRT to work with the YOTA modem is very simple - you just need to install additional packages for working with USB and the network, as well as add an additional network interface in the settings. <br><br><h4>  Automation and OpenWRT </h4><br>  In cases where there is an opportunity to jump from tariff to tariff with impunity, questions of automation-optimization arise by themselves.  In addition, after reading the <a href="http://habrahabr.ru/post/166721/">article</a> <a href="http://habrahabr.ru/users/linx56/" class="user_link">linx56</a> "automation itch" (thanks to the author for the term) did not give rest. <br><br>  The task was as follows - instead of installing the proposed <a href="http://habrahabr.ru/users/linx56/" class="user_link">linx56</a> script on each home PC, you need to ‚Äúforce‚Äù the router to independently switch the tariffs depending on the time of day and day of the week, the benefit of Internet consumption seemed to be quite definite.  The above cross-platform Yota script did not meet the requirements for the reason that it uses phantom.js, the installation of which on the stock MR-3020 with OpenWRT is not possible. <br><br>  Thus, the need for writing a script without using heavy headless browsers has matured.  The output was found almost immediately (according to the comments to the above article) - it was decided to use the <a href="http://curl.haxx.se/">curl</a> utility to send requests to the YOTA server. <br><br>  Initially, curl was installed on the router: <br><br><pre><code class="bash hljs">opkg install curl</code> </pre> <br>  After that, it was necessary to find out how the browser communicates with the Yota site, namely, which requests with which parameters. <br><br>  With the help of <a href="http://ru.wikipedia.org/wiki/Firebug">FireBug, the</a> first authorization request was caught in my account.  The obtained results were sent by curl to the server and ... failure - authorization error !!!  I checked the parameters and values ‚Äã‚Äã- again an error, and again, and again ... <br><br>  As a result, it turned out that for authorization and for setting parameters in the personal account, the YOTA website actively uses cookies.  Fortunately, curl does an excellent job with handling cookies - the issue of authorization has been resolved: <br><br><pre> <code class="bash hljs">curl -c cook.txt -s -k -L -d <span class="hljs-string"><span class="hljs-string">"IDToken1=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">&amp;IDToken2=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string">&amp;IDToken3=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string">&amp;goto=https%3A%2F%2Fmy.yota.ru%3A443%2Fselfcare%2FloginSuccess&amp;gotoOnFail=https%3A%2F%2Fmy.yota.ru%3A443%2Fselfcare%2FloginError&amp;old-token=&amp;org=customer"</span></span> https://login.yota.ru/UI/Login</code> </pre> <br>  Here we are in your account.  Again, we use FireBug to intercept a tariff change request.  The received parameters and cookies are sent to the server and ... again failure !!! <br><br>  After analyzing several requests, I was interested in the value of one of the parameters transmitted to the server, namely ‚ÄúProductID‚Äù, each time this value was new after changing the tariff.  As it was found out, the ProductID value is returned by the server in the page code and changes every time the tariff changes.  The tariff itself is an offerCode parameter, taking values ‚Äã‚Äãfrom POS-MA14-0002 to POS-MA14-0022. <br><br><pre> <code class="bash hljs">curl -b cook.txt -s -k -L -d <span class="hljs-string"><span class="hljs-string">"product=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$pr</span></span></span><span class="hljs-string">&amp;offerCode=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OCODE</span></span></span><span class="hljs-string">&amp;homeOfferCode=&amp;areOffersAvailable=false&amp;period=&amp;status=custom&amp;autoprolong=0&amp;isSlot=false&amp;resourceId=¬§tDevice=1&amp;username=&amp;isDisablingAutoprolong=false"</span></span> https://my.yota.ru/selfcare/devices/changeOffer</code> </pre><br>  As a result, the algorithm is as follows: <br><br><ol><li>  Log in to your account; </li><li>  Go to the page with the "regulator" speed; </li><li>  Select the ProductID from the resulting page; </li><li>  We set a new tariff. </li></ol><br>  As a result of the research, a small script was born that can be obtained <a href="">here</a> . <br><br>  The application is simple: <br><pre> <code class="bash hljs">yota.sh &lt;&gt; &lt;&gt; &lt;&gt;</code> </pre><br>  The result of the performance is the established tariff (speed) and the number of days (hours) left on the tariff. <br><br>  With the help of crontab, the intended mode of Internet consumption was configured, namely: <br>  For working days: <br><ul><li>  the inclusion of speed in the morning - during the fees for work; </li><li>  off in the morning - when you go to work; </li><li>  inclusion in the evening - when you return from work; </li><li>  off at night - when you go to sleep; </li></ul><br>  for weekends - a separate schedule with a late morning start :). <br><br><h4>  It's been seven days </h4><br>  A week later, it became clear that the proposed method of changing tariffs on a schedule is not entirely effective, if the time of night and morning shutdown speed almost always coincides with the established one, then the switch-on time is often significantly different from the set one, sometimes the Internet is needed earlier, sometimes much later (and if you overslept, you don‚Äôt need it at all :)). <br><br>  The first thought is to change the speed depending on the network load.  Having a little thought about the implementation, I found this idea not very successful - firstly, the bandwidth set in the tariff does not always coincide with the actually available bandwidth.  You can constantly raise the tariff, but the real band from this will change little and will be constantly loaded - respectively, losses, and secondly - the torrents on the media server will maintain constant high speed around the clock, and so on. <br><br>  The next thought is to change the speed on and off parameters depending on the presence of ‚ÄúInternet users‚Äù in the home network, namely: <br><br><ol><li>  Turn on speed when a stationary PC or laptop (or any other specified device) appears on the network. </li><li>  Turn off - when both disappear. </li><li>  Turn off - at a specified time (at night), because  You can forget to turn off the computer at night :). </li></ol><br>  In this regard, a small pingsh.sh script was also born, which, by means of the ping command, determines the presence of ‚Äúnecessary‚Äù devices on the network, the IP addresses of these devices are listed in the pings file, and the router's dhcp is set to issue ¬ªHome devices fixed ip-addresses.  If at least one address from the file is present in the network, the speed is turned on, in the absence of all, after 3 minutes, the devices are checked again in the network (in case wi-fi has fallen off), and if no devices are detected, the speed is turned off.  In order not to annoy Yot with unnecessary requests, every time when changing the tariff, we set the speed on / off flag. <br><br>  The use of the <a href="">pingsh.sh</a> script <a href="">is</a> simple - we enter the necessary ip-addresses of home devices into the pings file, edit the values ‚Äã‚Äãof login, psw, speedon and speedoff in the script itself. <br><br>  Now I have only 2 lines in the crontab: the first is to start pingsh.sh every 6 minutes, and the second is to force off the speed at one in the morning in case I fell asleep and did not turn off the computer :) <br><br>  The above scripts can be found <a href="https://github.com/bambrman/yota">here</a> . <br><br><h4>  PS </h4><br>  A little offtop.  At the request of the workers, a simple Delphi program for Windows was written in parallel to quickly change the tariffs.  In contrast to the <a href="http://habrahabr.ru/post/166285/">option</a> proposed by <a href="http://habrahabr.ru/users/ratswolf/" class="user_link">ratswolf,</a> <a href="http://habrahabr.ru/post/166285/">the</a> browser is not used, we work with the Yota server directly by means of GET and POST requests with the above parameters. <br>  Speed ‚Äã‚Äãselection option and display of current speed / balance: <br><img src="https://habrastorage.org/storage2/3b0/e4d/9d2/3b0e4d9d2377cde7f60734b9d15ce09c.jpg" alt="image"><br><br>  And all the settings: <br><br><img src="https://habrastorage.org/storage2/c6a/9bd/395/c6a9bd3952c23c4f1aff788697830f01.jpg"><br><br>  You can take it <a href="https://sourceforge.net/projects/yotaset/files/">here</a> . <br><br><h4>  The most important thing </h4><br>  And the most important question - the real savings amounted to about 50%, at the base rate of 900 rubles / month (5.5 Mb / s), it was possible to work for almost a month and a half. <br><br><h4>  Instructions for installing curl </h4><br>  If there is not enough space on rootfs, do as follows. <br>  Connect to the router via ssh and execute the following commands: <br><pre> <code class="bash hljs">opkg update opkg install curl --nodeps opkg install zlib --nodeps opkg install libcurl --nodeps opkg install libopenssl -d ram ln -s /tmp/usr/lib/libcrypto.so.1.0.0 /lib/libcrypto.so.1.0.0 ln -s /tmp/usr/lib/libssl.so.1.0.0 /lib/libssl.so.1.0.0</code> </pre><br>  Now we add lines to rc.local (can be done via the System Startup web interface): <br><br><pre> <code class="bash hljs">sleep 180 opkg update opkg install libopenssl -d ram</code> </pre><br>  Thus, even after a reboot, the router itself will load the missing packet into RAM. <br><br><h4>  UPD </h4><br>  As it turned out, the Yota provider uses different tariffs and parameters for different regions. <br>  Presented by yota.sh for Khabarovsk.  To get a script for your region <br>  You must use the gen.sh script (located there): <br><pre> <code class="bash hljs">gen.sh login password</code> </pre><br>  At the end of the script, n_yota.sh will be created with the necessary parameters and tariffs. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/176817/">https://habr.com/ru/post/176817/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176803/index.html">Practical tips for choosing a cloud provider</a></li>
<li><a href="../176805/index.html">Why do we hang a television in the office?</a></li>
<li><a href="../176809/index.html">Elegant strings</a></li>
<li><a href="../176813/index.html">Minifest (minimalist developers manifesto)</a></li>
<li><a href="../176815/index.html">We write toy OS on C #</a></li>
<li><a href="../176819/index.html">Vulnerability in mail.ru mail, allowing you to change the password on any mailbox without a secret question</a></li>
<li><a href="../176823/index.html">Running Windows under Linux KVM</a></li>
<li><a href="../176825/index.html">Decompiling Java Applications</a></li>
<li><a href="../176829/index.html">Google Mirror API published</a></li>
<li><a href="../176833/index.html">On Kickstarter is collecting funds for the game, the heir of the famous Road Rush</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>