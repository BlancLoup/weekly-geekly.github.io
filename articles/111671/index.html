<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We create an original gift with the help of chemistry, physics and electronics: part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The third, final part of my article on the creation of a luminous crystal souvenir. It describes the software part, that is, the ATTiny13 microcontrol...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We create an original gift with the help of chemistry, physics and electronics: part 3</h1><div class="post__text post__text-html js-mediator-article">  The third, final part of my article on the creation of a luminous crystal souvenir.  It describes the software part, that is, the ATTiny13 microcontroller firmware from the glorious kind of AVRok. <br><a name="habracut"></a><br><br><h4>  Step 4: develop the firmware </h4><br><br>  The firmware for the device is quite trivial, but you should pay attention to the following points: <br>  1) This microcontroller has only one 8-bit timer, so you have to use it simultaneously for both PWM and sensor polling, switching back and forth. <br>  2) To reduce power consumption, it would be nice to immerse the device in a dream when no one touches it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here with the second point there was some hitch.  Maybe I‚Äôll say something you already know, but it may well be that it will save you from a long search for a glitch in the firmware.  After transferring the microcontroller to the Power Down low power mode, it can be awakened only by an external interrupt (which we don‚Äôt have anywhere in the circuit) or a watchdog timer. <br>  But the fact is that the watchdog timer can work in two modes: reload on overflow and interrupt on overflow (yes, there is still a third mode, a combination of the two previous ones).  And, as it turned out, in the overload mode on overflow, it does not take the controller out of sleep mode, at least the circuit has flatly refused to work like that.  Therefore, we will use exactly the overflow interrupt mode. <br><br>  And one more note: if you assemble such a device and test the ‚Äúshed‚Äù, remember the following: <br>  The sensor will show a much larger capacity if you touch, say, the minus of the battery when testing with your second hand.  I stuck with this, because during testing I pressed the wires to the battery with my hands, so I set an overly large threshold. <br><br>  The general approach to the implementation is as follows: the device can be in one of six states: <br>  1) The diode is off, waiting for a response from the sensor.  In this state, we periodically check the sensor, after which we fall asleep for about a second, which will ensure low power consumption <br>  2) After the first response from the sensor, we no longer fall asleep, wait about 300 ms to make sure that this is not a hindrance, and recheck the sensor.  If the sensor is not active, then return to state 1. Otherwise, go to state 3. <br>  3) Switch the timer to the PWM mode and slowly increase the duty cycle, then we glow until 4 seconds pass and we go to state 4 <br>  4) Switch the timer from PWM to touch mode, check the sensor to determine when the device is put in place, when the sensor becomes inactive, go to state 5 <br>  5) We are waiting for another 15 seconds, recheck the sensor.  If active, then return to state 4. Otherwise, go to state 6. <br>  6) Slowly extinguish, while periodically switching the timer from PWM mode to sensor mode and re-checking its activity.  If the sensor has become active again, then go to state 3, again starting to flare up.  Otherwise, when the duty cycle reached 0, again switch to mode 1. <br><br>  Below I will set out the code with comments.  Because  I had to hurry with the code in order to have time for the new year, there may well be completely non-optimal moments, please do not kick for them) <br>  However, this is a fully working and debugged code.  Takes about 70-80 percent of flash memory tinky. <br><br><pre><code class="hljs lua">#define F_CPU <span class="hljs-number"><span class="hljs-number">9600000</span></span>UL #include&lt;avr/<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>.h&gt; #include&lt;util/delay.h&gt; #include&lt;avr/wdt.h&gt; #include&lt;avr/sleep.h&gt; #include&lt;avr/interrupt.h&gt; //  enum DEV_MODE{M_WAITING_SENSOR, //      M_SENSOR_RECHECK, //    M_GLOW, // M_GLOW_AND_CHECK, //    M_GLOW_AND_RECKECK, //,   M_FADE}; // unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> SensorHi=<span class="hljs-number"><span class="hljs-number">0</span></span>; //,        unsigned short Delay=<span class="hljs-number"><span class="hljs-number">0</span></span>; //      unsigned short PWM=<span class="hljs-number"><span class="hljs-number">0</span></span>; //  unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> Mode=<span class="hljs-number"><span class="hljs-number">0</span></span>; //  void SetTimer(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> Mod) //          { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Mod) //<span class="hljs-number"><span class="hljs-number">1</span></span>,   { TCCR0A=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; TCCR0B=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; TCNT0=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> //<span class="hljs-number"><span class="hljs-number">0</span></span>,  { TCCR0A=<span class="hljs-number"><span class="hljs-number">0x83</span></span>; TCCR0B=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; TCNT0=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; } } void Recalibrate() //  { cli(); //    ,   ) SetTimer(<span class="hljs-number"><span class="hljs-number">1</span></span>); DDRB&amp;= <span class="hljs-number"><span class="hljs-number">0</span></span>b11110111; PORTB|=<span class="hljs-number"><span class="hljs-number">0</span></span>b00010000; TCCR0B=<span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!(PINB&amp;<span class="hljs-number"><span class="hljs-number">0</span></span>b00001000)); TCCR0B=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; DDRB|= <span class="hljs-number"><span class="hljs-number">0</span></span>b00001000; PORTB&amp;= <span class="hljs-number"><span class="hljs-number">0</span></span>b11101111; SensorHi=TCNT0+<span class="hljs-number"><span class="hljs-number">3</span></span>; //   +<span class="hljs-number"><span class="hljs-number">3</span></span>   ,    sei(); //   } unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> CheckSensor() { cli(); SetTimer(<span class="hljs-number"><span class="hljs-number">1</span></span>); DDRB&amp;= <span class="hljs-number"><span class="hljs-number">0</span></span>b11110111; PORTB|=<span class="hljs-number"><span class="hljs-number">0</span></span>b00010000; TCCR0B=<span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!(PINB&amp;<span class="hljs-number"><span class="hljs-number">0</span></span>b00001000)); TCCR0B=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; DDRB|= <span class="hljs-number"><span class="hljs-number">0</span></span>b00001000; PORTB&amp;= <span class="hljs-number"><span class="hljs-number">0</span></span>b11101111; unsigned <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> Time=TCNT0; sei(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Time&gt;SensorHi) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xFF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>; } ISR(SIG_WATCHDOG_TIMEOUT) //     { __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"nop"</span></span>); //     } int main() { ACSR = <span class="hljs-number"><span class="hljs-number">0</span></span>b1000000; //   DDRB = <span class="hljs-number"><span class="hljs-number">0</span></span>b00011001; SetTimer(<span class="hljs-number"><span class="hljs-number">1</span></span>); //      Mode= M_WAITING_SENSOR; sei(); PORTB=<span class="hljs-number"><span class="hljs-number">0</span></span>b00000001; //    <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">40</span></span>;i++) //  ,    { _delay_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>); _delay_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>); _delay_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>); _delay_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>); _delay_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>); } PORTB=<span class="hljs-number"><span class="hljs-number">0</span></span>b00000000; //  Recalibrate(); // _delay_ms(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) { switch(Mode) { case M_WAITING_SENSOR: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(CheckSensor()) { Mode= M_SENSOR_RECHECK; PWM=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //       //    ,      //          sei(); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"in r16, 0x21"</span></span>); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"ori r16, 0b00011000"</span></span>); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"out 0x21 ,r16"</span></span>); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"ldi r16, 0b01000111"</span></span>); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"out 0x21 ,r16"</span></span>); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"ldi r16 ,0b00110000"</span></span>); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"out 0x35 ,r16"</span></span>); __asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"sleep"</span></span>); //     <span class="hljs-number"><span class="hljs-number">1</span></span> ,   } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case M_SENSOR_RECHECK: cli(); Delay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Delay&gt;<span class="hljs-number"><span class="hljs-number">0x0010</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!CheckSensor()) { Mode= M_WAITING_SENSOR; Delay=<span class="hljs-number"><span class="hljs-number">0x0000</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Delay=<span class="hljs-number"><span class="hljs-number">0x0000</span></span>; Mode= M_GLOW; SetTimer(<span class="hljs-number"><span class="hljs-number">0</span></span>); PWM=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; OCR0A=PWM; TCCR0B|=<span class="hljs-number"><span class="hljs-number">0x01</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case M_GLOW: Delay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((PWM&lt;<span class="hljs-number"><span class="hljs-number">0xFF</span></span>)&amp;&amp;(Delay%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>)) // **,  Delay%<span class="hljs-number"><span class="hljs-number">2</span></span> PWM++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Delay&gt;<span class="hljs-number"><span class="hljs-number">0x0200</span></span>) //  { SetTimer(<span class="hljs-number"><span class="hljs-number">1</span></span>); PORTB =<span class="hljs-number"><span class="hljs-number">0</span></span>b00000001; //    . <span class="hljs-number"><span class="hljs-number">1</span></span> Mode= M_GLOW_AND_CKECK; Delay=<span class="hljs-number"><span class="hljs-number">0x0000</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case M_GLOW_AND_CKECK: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!CheckSensor()) { Mode=M_GLOW_AND_RECKECK; PWM=<span class="hljs-number"><span class="hljs-number">0xFF</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case M_GLOW_AND_RECKECK: Delay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Delay&gt;<span class="hljs-number"><span class="hljs-number">0x0500</span></span>) // ,        { //    <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(CheckSensor()) { Mode= M_GLOW_AND_CKECK; Delay=<span class="hljs-number"><span class="hljs-number">0x0000</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Delay=<span class="hljs-number"><span class="hljs-number">0x0000</span></span>; Mode=M_FADE; PWM=<span class="hljs-number"><span class="hljs-number">0xFF</span></span>; OCR0A=PWM; SetTimer(<span class="hljs-number"><span class="hljs-number">0</span></span>); TCCR0B=<span class="hljs-number"><span class="hljs-number">0x01</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case M_FADE: Delay++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Delay%<span class="hljs-number"><span class="hljs-number">5</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>) //   Delay   { TCCR0B=<span class="hljs-number"><span class="hljs-number">0x00</span></span>; PORTB = <span class="hljs-number"><span class="hljs-number">0</span></span>b00000000; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(CheckSensor()) { Mode=<span class="hljs-number"><span class="hljs-number">0x02</span></span>; //  -    Delay=<span class="hljs-number"><span class="hljs-number">0x0000</span></span>; } SetTimer(<span class="hljs-number"><span class="hljs-number">0</span></span>); TCCR0B=<span class="hljs-number"><span class="hljs-number">0x01</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((PWM&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>)&amp;&amp;(Delay%<span class="hljs-number"><span class="hljs-number">2</span></span>==<span class="hljs-number"><span class="hljs-number">0</span></span>)) //  PWM<span class="hljs-comment"><span class="hljs-comment">--; if(Delay&gt;0x0200) //  { SetTimer(1); PORTB=0b00000000; Mode= M_WAITING_SENSOR; Delay=0x0000; } break; } OCR0A=PWM; _delay_ms(20); } }</span></span></code> </pre> <br><br><h4>  Conclusion </h4><br><br>  That's all - the technical work is still there: fix the firmware in SMD ATTiny13, solder the SMD resistor to its two pins (perhaps you have enough space in the stand for non-SMD components, but my place was critical), moving away from its wire as a sensor to the foil side of the stand, solder the leads of the LED to the microcontroller and the common wire, plus from the battery, connect to the power supply of the microcontroller, and minus to the common wire and close the stand with a lid. <br><br>  In my device, I divided the stand into two parts, at the top I placed the circuit from which I took the power and sensor wires, and sealed it with a plastic partition.  He put a wide spring on it under the minus of the battery and a curved plate on top under the plus.  Thus, after the stand is closed with a lid, the plates are pressed against the battery and the circuit turns on, giving me 4 seconds to remove my hands before calibration.  If this is not done, the device will consider that the capacity of the inactive sensor is equal to the capacity of the active one, and it will be impossible to ignite it without recalibrating. <br><br>  Judging by my measurements, the circuit consumes 0.02 mA in idle mode and about 12 mA at full brightness of the diode.  Even if the multimeter showed an inaccurate result and was mistaken by an order of magnitude, the energy in the battery should be enough for about half a year of idle time, which is quite a good result. <br><br>  With due diligence, you can make a similar device of any size, and as a salt, you can take a substance of a different color and grow a red or yellow crystal.  All in your hands) <br><br>  <a href="http://habrahabr.ru/blogs/DIY/111610/">Part 1</a> <br>  <a href="http://habrahabr.ru/blogs/DIY/111627/">Part 2</a> </div><p>Source: <a href="https://habr.com/ru/post/111671/">https://habr.com/ru/post/111671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111663/index.html">The most promising jobs in Canada in 2011</a></li>
<li><a href="../111664/index.html">Software engineer and mathematician - the best professions of 2011 in the USA</a></li>
<li><a href="../111666/index.html">Creating and publishing an extension</a></li>
<li><a href="../111668/index.html">Google Goggles - Solve Sudoku</a></li>
<li><a href="../111670/index.html">Choosing from a long list, speeding up the process correctly</a></li>
<li><a href="../111672/index.html">We write our intermediate driver. Part 1</a></li>
<li><a href="../111673/index.html">Duokan. Or how to read DJVU on Kindle</a></li>
<li><a href="../111674/index.html">Software life cycle models</a></li>
<li><a href="../111675/index.html">Construction of the suffix tree: Ukkonen algorithm</a></li>
<li><a href="../111676/index.html">loop_dance - quick deployment background scheduler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>