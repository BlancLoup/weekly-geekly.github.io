<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Examining Tracing with eBPF: Guide and Examples</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I bring to your attention the translation of an article by Brendan Gregg devoted to the study of eBPF 

 There were at least 24 eBPF talks a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Examining Tracing with eBPF: Guide and Examples</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  Hi, Habr!  I bring to your attention the translation of an <a href="http://www.brendangregg.com/blog/2019-01-01/learn-ebpf-tracing.html">article by</a> Brendan Gregg devoted to the study of eBPF </blockquote><p>  There were at least 24 eBPF talks at the Linux Plumbers conference.  He quickly became not just an invaluable technology, but also an in-demand skill.  Perhaps you would like to set some goal for the new year - study eBPF! </p><br><p>  The term eBPF should mean something significant, such as the Virtual Kernel Instruction Set (VKIS), but in its origin it is an extended Berkeley Packet Filter.  It is applicable in many areas, such as network performance, firewalls, security, tracing, and device drivers.  For some of them there is a lot of freely available information on the Internet - for example, on tracing, but on others it is not.  The term tracing refers to performance analysis and monitoring tools that can generate information for each event.  Perhaps you have already used the tracer - tcpdump and strace are specialized tracer. </p><br><p>  In this post, I'm going to describe the process of learning how to use eBPF for tracing purposes, grouped into sections for beginners, experienced and advanced users.  Eventually: </p><br><ul><li>  Getting Started: running <a href="https://github.com/iovisor/bcc">bcc</a> tools </li><li>  Proficient: developing <a href="https://github.com/iovisor/bpftrace">bpftrace</a> tools </li><li>  Advanced: developing <a href="https://github.com/iovisor/bcc">bcc</a> tools, contributing to bcc and bpftrace </li></ul><a name="habracut"></a><br><h1>  Beginners </h1><br><h2>  1. What are eBPF, bcc, bpftrace and iovisor? </h2><br><p>  <strong>eBPF</strong> does for Linux the same as JavaScript does for HTML, well, sort of.  So, instead of a static HTML site, JavaScript allows you to specify mini-programs that run on events ‚Äî such as mouse clicks ‚Äî that run in a secure virtual machine in a browser.  And with eBPF ‚Äî instead of editing the kernel, you can now write mini-programs that run on events like disk I / O on a secure virtual machine in the kernel.  In fact, eBPF is more like a v8 virtual machine that runs javascript than javascript itself.  eBPF is part of the Linux kernel. </p><br><p>  Programming directly in eBPF is incredibly difficult, just like in bytecode on v8.  But nobody kodit in v8: everyone writes in JavaScript, or often in a framework over JavaScript (jQuery, Angular, React, etc.).  The same with eBPF.  People will use it, and write code through frameworks.  The main traces are <b><a href="https://github.com/iovisor/bcc">bcc</a></b> and <b><a href="https://github.com/iovisor/bpftrace">bpftrace</a></b> .  They do not live in the kernel codebase, they live in the Linux Foundation project on a githab called <strong>iovisor</strong> . </p><br><h2>  2. Can an example of tracing using eBPF? </h2><br><p>  This eBPF-based utility shows fully established TCP sessions with their process ID (PID), command name (COMM), bytes sent and received (TX_KB, RX_KB), and the duration in milliseconds (MS): </p><p></p><blockquote>  # <b>tcplife</b> <pre> PID COMM LADDR LPORT RADDR RPORT TX_KB RX_KB MS
 22597 recordProg 127.0.0.1 46644 127.0.0.1 28527 0 0 0.23
 3277 redis-serv 127.0.0.1 28527 127.0.0.1 46644 0 0 0.28
 22598 curl 100.66.3.172 61620 52.205.89.26 80 0 1 91.79
 22604 curl 100.66.3.172 44400 52.204.43.121 80 0 1 121.38
 22624 recordProg 127.0.0.1 46648 127.0.0.1 28527 0 0 0.22
 3277 redis-serv 127.0.0.1 28527 127.0.0.1 46648 0 0 0.27
 22647 recordProg 127.0.0.1 46650 127.0.0.1 28527 0 0 0.21
 3277 redis-serv 127.0.0.1 28527 127.0.0.1 46650 0 0 0.26
 [...] </pre><br></blockquote><br><p>  <em>This is not what</em> eBPF makes possible ‚Äî I can rewrite tcplife to use older kernel technologies.  But if I had done this, we would never have launched such a tool in production due to poor performance, security problems, or both.  eBPF has made this tool <em>practical</em> : it is effective and safe.  For example, it does not track every packet, as was done with previous approaches, and that could lead to excessive performance degradation.  Instead, it tracks only TCP session events that occur less frequently.  This makes the overhead so low that we can run this tool in 24x7 mode. </p><br><h2>  3. How can I use it? </h2><br><p>  Beginners should start exploring bcc.  See <a href="">bcc installation instructions for</a> your operating system.  For Ubuntu, it looks something like this: </p><br><blockquote>  # <b>sudo apt-get update</b> <br>  # <b>sudo apt-get install bpfcc-tools</b> <br>  # <b>sudo / usr / share / bcc / tools / opensnoop</b> <pre> PID COMM FD ERR PATH
 25548 gnome-shell 33 0 / proc / self / stat
 10190 opensnoop -1 2 /usr/lib/python2.7/encodings/ascii.x86_64-linux-gnu.so
 10190 opensnoop -1 2 /usr/lib/python2.7/encodings/ascii.so
 10190 opensnoop -1 2 /usr/lib/python2.7/encodings/asciimodule.so
 10190 opensnoop 18 0 /usr/lib/python2.7/encodings/ascii.py
 10190 opensnoop 19 0 /usr/lib/python2.7/encodings/ascii.pyc
 25548 gnome-shell 33 0 / proc / self / stat
 29588 device poll 4 0 / dev / bus / usb
 ^ C
</pre></blockquote><br><p>  Here I ended up running opensnoop to test the functionality of the tools.  If you have come this far, you have definitely enjoyed eBPF! </p><br><p>  In companies like Netflix and Facebook, bcc is installed on all servers by default.  Maybe you want to do the same. </p><br><h2>  4. Is there a beginner's guide? </h2><br><p>  Yes, I wrote a bcc guide, which is a good starting point for new traders using eBPF: </p><br><ul><li>  <a href="">Bcc tutorial</a> </li></ul><br><p>  As a beginner, you do not need to write any code for eBPF.  bcc already contains more than 70 tools that you can immediately use.  This tutorial will guide you through the following eleven steps: execsnoop, opensnoop, ext4slower (or btrfs *, xfs *, zfs *), biolatency, biosnoop, cachestat, tcpconnect, tcpaccept, tcpretrans, runqlat and profile. </p><br><p>  After you have tried them, you just have to know that there are many other means: </p><br><p> <a href=""><img src="https://hsto.org/webt/km/jt/hy/kmjthyb3fxb0e90fwfrvqy6x-t8.png" width="500"></a> </p><br><p>  They are also fully provided with documentation by means of man pages and files with examples.  The sample files (* _example.txt in bcc / tools) contain screenshots with explanations: for example, <a href="https://github.com/iovisor/bcc/blob/master/tools/biolatency_example.txt">biolatency_example.txt</a> .  I have written many of them (both man pages and tools) that look like an additional 50 blog posts, you will find them in the bcc repository. </p><br><p>  What is missing is real production examples.  I wrote this documentation when eBPF was so new that it was only available in our test environments, so most of the examples are artificial.  Over time, we will add examples from the real world.  This is an area where newbies can help: if you solve a problem, consider writing an article and sharing screenshots or adding them as sample files. </p><br><h1>  For experienced </h1><br><p>  At this stage, you should already run bcc and test these tools, and also be interested in modifying them and writing your own tools.  The best way is to go to bpftrace, which contains a high-level language that is <em>much</em> easier to learn.  The disadvantage is that it is not as flexible in configuration as bcc, so you may be confronted with restrictions and want to go back to bcc. </p><br><p>  Refer to the <a href="">bpftrace installation instructions</a> .  This is a newer project, so at the time of this writing, packages have not yet been compiled for all systems.  In the future, it should just be apt-get install bpftrace or something similar. </p><br><h2>  1. bpftrace tutorial </h2><br><p>  I developed a tutorial that teaches how to use bpftrace through a series of one-liners: </p><br><ul><li>  <a href="">Bpftrace tutorial with one-line examples</a> </li></ul><br><p>  There are 12 lessons that will teach you how to work with bpftrace, step by step.  Here is an example: </p><br><blockquote>  # <b>bpftrace -e 'tracepoint: syscalls: sys_enter_open {printf ("% d% s \ n", pid, str (args-&gt; filename));</b>  <b>} '</b> <pre> Attaching 1 probe ...
 181 / proc / cpuinfo
 181 / proc / stat
 1461 / proc / net / dev
 1461 / proc / net / if_inet6
 ^ C
</pre></blockquote><br><p>  It uses the open system call as a trace point to track the PID and open file paths. </p><br><h2>  2. bpftrace Reference Manual </h2><br><p>  For details on bpftrace, I wrote a manual containing examples of syntax, tests, and built-in commands: </p><br><ul><li>  <a href="">Bpftrace reference manual</a> </li></ul><br><p>  This is for the sake of brevity: I try to place the title, summary and screenshot on one page.  I think it is too long - if you are looking for something and you need to scroll through the page several times. </p><br><h2>  3. bpftrace in examples </h2><br><p>  There are over 20 tools in the bpftrace repository, which you can look at with examples: </p><br><ul><li>  <a href="https://github.com/iovisor/bpftrace/tree/master/tools">Bpftrace tools</a> </li></ul><br><p>  For example: </p><br><blockquote>  # <b>cat tools / biolatency.bt</b> <pre> [...]
 BEGIN
 {
     printf ("Tracing block device I / O ... Hit Ctrl-C to end. \ n");
 }

 kprobe: blk_account_io_start
 {
     @start [arg0] = nsecs;
 }

 kprobe: blk_account_io_completion
 / @ start [arg0] /

 {
     @usecs = hist ((nsecs - @start [arg0]) / 1000);
     delete (@start [arg0]);
 }
</pre></blockquote><br><p>  Like bcc, these utilities have man pages and sample files.  For example, <a href="https://github.com/iovisor/bpftrace/blob/master/tools/biolatency_example.txt">biolatency_example.txt</a> . </p><br><h1>  For advanced </h1><br><h2>  1. We study the development of bcc </h2><br><p>  I created two manuals to help: </p><br><ul><li>  <a href="">Bcc tutorial for python developer</a> </li><li>  <a href="">Bcc reference manual</a> </li></ul><br><p>  There are also many examples in bcc / tools / *. Py.  The bcc tools consist of two parts: a BPF code for the kernel written in C, and a user-space level tool written in Python (or lua, or C ++).  The development of bcc tools is fairly advanced and may include some of the smaller core components or internal application components. </p><br><h2>  2. Participation in the development </h2><br><p>  Help is welcome with: </p><br><ul><li>  <a href="https://github.com/iovisor/bcc/issues">bcc issues</a> </li><li>  <a href="https://github.com/iovisor/bpftrace/issues">bpftrace issues</a> </li></ul><br><p>  For bpftrace, I created the <a href="">bpftrace internal development guide</a> .  It's hard when you program in llvm IR, but if you are ready to accept the challenge ... </p><br><p> There is also the core of eBPF (aka BPF): if you look at the bcc and bpftrace issues, you will see there are several requests for improvements.  For example, the <a href="https://github.com/iovisor/bpftrace/issues%3Fq%3Dis%253Aissue%2Bis%253Aopen%2Blabel%253Akernel">kernel tag in bpftrace</a> .  Also check out the <a href="https://www.spinics.net/lists/netdev/">netdev</a> mailing <a href="https://www.spinics.net/lists/netdev/">list</a> for the latest BPF kernel developments that are added to net-next before merging them with the Linux mainline. </p><br><p>  In addition to writing code, you can also take part in testing, packaging, blog posts and discussions. </p><br><h1>  Conclusion </h1><br><p>  eBPF can do a lot of different things.  In this post, I looked at mastering eBPF for tracing and performance analysis.  Eventually: </p><br><ul><li>  Getting Started: running <a href="https://github.com/iovisor/bcc">bcc</a> tools </li><li>  Proficient: developing <a href="https://github.com/iovisor/bpftrace">bpftrace</a> tools </li><li>  Advanced: developing <a href="https://github.com/iovisor/bcc">bcc</a> tools, contributing to bcc and bpftrace </li></ul><br><p>  I also have a separate <b><a href="http://www.brendangregg.com/ebpf.html">eBPF Tracing Tools</a></b> page covering all of this in more detail.  Successes! </p><p></p><p></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/435142/">https://habr.com/ru/post/435142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435128/index.html">Pi-Sonos: a hobby out of control</a></li>
<li><a href="../435132/index.html">Nomad: problems and solutions</a></li>
<li><a href="../435134/index.html">Simplify working with databases in Qt using QSqlRelationalTableModel</a></li>
<li><a href="../435136/index.html">Sergey and the scientific method</a></li>
<li><a href="../435138/index.html">How to take control of network infrastructure. Part Three Network security</a></li>
<li><a href="../435144/index.html">Introduction to Spring Boot: Creating a Simple Java REST API</a></li>
<li><a href="../435148/index.html">Own bash DHCP server</a></li>
<li><a href="../435150/index.html">Clinical trials on the threshold - an interview with Aubrey de Gray</a></li>
<li><a href="../435152/index.html">Apple and Qualcomm patent dispute led to a halt in sales of iPhone 7 and 8 in Germany</a></li>
<li><a href="../435154/index.html">Memoirs of the subhuman robot, chapters 9-12</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>