<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The first 10 minutes on the server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ABC Security Ubuntu 
 ‚Äú My first 5 minutes on the server ‚Äù by Brian Kennedy is a great introduction to quickly securing a server against most attacks....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The first 10 minutes on the server</h1><div class="post__text post__text-html js-mediator-article"><h3>  ABC Security Ubuntu </h3><br>  ‚Äú <a href="http://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers">My first 5 minutes on the server</a> ‚Äù by Brian Kennedy is a great introduction to quickly securing a server against most attacks.  We have several fixes for this manual to complement our <a href="https://github.com/codelittinc/incubator-resources">full guide</a> .  I would also like to explain in more detail some things for younger engineers. <br><br>  Every morning I check logwatch email notifications and get thorough pleasure by watching a few hundred (sometimes thousands) of unsuccessful attempts to gain access.  (Many are quite prosaic - trying to log in as <code>root</code> with a password of <code>1234</code> again and again).  The general methodology given here is suitable for Debian / Ubuntu servers, which we personally prefer to everyone else.  They usually serve only as hosts for Docker containers, but the principles are the same. <br><br>  On a large scale, it is better to use fully automatic installations with tools like <a href="https://github.com/ansible/ansible">Ansible</a> or <a href="https://shipyard-project.com/">Shipyard</a> , but sometimes you just pick up a single server or pick up tasks for Ansible ‚Äî an instruction is intended for such situations. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Note: This help is created as a basic alphabet.</b>  <b>It should be expanded and supplemented according to your needs.</b> <br><a name="habracut"></a><br><h3>  Firstly </h3><br>  We don't even have a root password yet.  I would like to choose something random and difficult.  We use the password manager generator with the maximum complexity settings.  Password Manager saves the password and encrypts it, access to it is possible only by a long master password.  It provides a couple of redundant security measures (a long, complex random password + password protection with encryption and another long password).  You use a password manager or other tools, keep your password safe by using some form of encryption.  You only need this root password if you lose your sudo password. <br><br> <code># passwd</code> <br> <br>  <i>* Note: An interesting discussion about root passwords has opened on <a href="https://news.ycombinator.com/item%3Fid%3D11909543">HN</a> and <a href="https://www.reddit.com/r/netsec/comments/4o7wpo/my_first_10_minutes_on_a_server/">Reddit</a> .</i>  <i>It is worth reading.</i> <br><br>  Now you should update the repositories and roll out the latest patches.  Next will be a separate section on automating the installation of security updates. <br><br> <code>apt-get update <br> apt-get upgrade</code> <br> <br><h3>  Add user </h3><br>  You should never go to the server as root.  We follow the same rules when creating users that Brian Kennedy has set, but you can use your own.  Our small team did not have problems using a single user for authorization, but in large teams it‚Äôs better to create different users with different privilege levels, where only a select few receive sudo privileges. <br><br> <code>useradd deploy <br> mkdir /home/deploy <br> mkdir /home/deploy/.ssh <br> chmod 700 /home/deploy/.ssh</code> <br> <br>  Install the default shell for the user deploy, we use bash: <br><br> <code>usermod -s /bin/bash deploy</code> <br> <br>  Remember: <code>chmod 700</code> means that the account owner has rights to read, write and run programs.  We are still with root privileges, but after a minute we will run the <code>chown</code> recursively in this folder for the user deploy and the group deploy.  Only this user should be allowed to work with the .ssh folder. <br><br><h3>  Ssh key authentication </h3><br>  We try not to use passwords to log on to the server.  There was a lot of controversy about this after Brian's instructions came out, but I am also inclined to agree with this position.  Here are a few comments on this: <br><br><ol><li>  Ssh keys are better than passwords because they contain and require more information. <br><br></li><li>  Passwords can be picked up by brute force.  Guessing by the public key is essentially impossible, so that they can be considered completely safe. <br><br></li><li>  What about computer theft?  Yes, your private keys are there, but it is easy to revoke the ssh-key; you just need to remove the public key from authorized_keys.  You should also protect the secret key with a secure and long passphrase.  See next item. <br><br></li><li>  All this works ONLY ON THE CONDITION OF A SAFE AND LONG PASSWORD PHRASE PROTECTING THE KEY.  Repeat a second time, because it is critically important. </li></ol><br>  So let's leave in the past password authentication.  Copy the contents of id_rsa.pub <a name="3"></a>  <sup><a href="https://habr.com/ru/company/rootwelt/blog/303462/">1</a></sup> from your local machine to the servers in the file authorized_keys. <br><br> <code>vim /home/deploy/.ssh/authorized_keys</code> <br> <br>  Set the correct privileges, guided by the principle of Linux security, known as the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF_%25D0%25BC%25D0%25B8%25D0%25BD%25D0%25B8%25D0%25BC%25D0%25B0%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D1%2585_%25D0%25BF%25D1%2580%25D0%25B8%25D0%25B2%25D0%25B8%25D0%25BB%25D0%25B5%25D0%25B3%25D0%25B8%25D0%25B9">principle of minimal privileges</a> : <br><br> <code>chmod 400 /home/deploy/.ssh/authorized_keys <br> chown deploy:deploy /home/deploy -R</code> <br> <br>  <code>chmod 400</code> sets permissions so that only the owner can read the file.  Another <code>chown</code> makes the user deploy and the group deploy the owners (recursively) of their home directory.  We mentioned this earlier when we set permissions to read, write and execute for the owner of this directory. <br><br>  Let us come back to this a bit later, when we correctly test our user deploy and sudo to disable root authorization and install authorization only using the ssh key. <br><br><h3>  Testing the user deploy and installing sudo </h3><br>  We are going to check how the author of the user deploy is happening, while at the same time keeping the ssh connection for root open, just in case.  If everything works fine, we use our open root connection to set the password for deploy.  Since we disable password authentication, this password will be used when using sudo.  Again, we launch the password manager to generate a complex and random password, save it in an encrypted form and inform colleagues (synchronize the encrypted file with the password). <br><br> <code>passwd deploy</code> <br> <br>  Installing sudo is easy.  Open the sudo file: <br><br> <code>visudo</code> <br> <br>  Add the <code>%sudo</code> group under the root user, as shown below.  Make sure that all other users and groups are repulsed with comments with the <code>#</code> symbol (users have no prefixes, and groups start with <code>%</code> ).  On most fresh installations there is nothing there, just in case. <br><br> <code>root ALL=(ALL) ALL <br> %sudo ALL=(ALL:ALL) ALL</code> <br> <br>  Now add the user <code>deploy</code> to the <code>sudo</code> group. <br><br> <code>usermod -a -G sudo deploy</code> <br> <br>  This will give the deploy user access to sudo after entering the password we just created. <br><br>  <i>Note to the correction: Thanks to the user <a href="https://www.reddit.com/r/netsec/comments/4o7wpo/my_first_10_minutes_on_a_server/d4aeajf">ackackacksyn</a> on Reddit for the correct remark that you should not add users directly to the sudo list</i> . <br><br><h3>  Activate ssh key login </h3><br>  The ssh configuration for this machine is stored here: <br><br> <code>vim /etc/ssh/sshd_config</code> <br> <br>  You will want to add a few lines there.  I think they are quite understandable in their own right.  This is the IP address you use to connect.  Our company uses a VPN configuration with OpenVPN and cryptographic authentication, so you also need to be authenticated and connected to a VPN to connect to the server. <br><br> <code>PermitRootLogin no <br> PasswordAuthentication no <br> AllowUsers deploy@(your-VPN-or-static-IP)</code> <br> <br>  Activate all of these rules by restarting ssh services.  Probably have to reconnect (do this through the user deploy!). <br><br> <code>service ssh restart</code> <br> <br><h3>  Firewall installation </h3><br>  Usually there are two camps.  Some use IPtables directly, while others use a convenient interface called <code>ufw</code> , which is a layer above IPtables to simplify the configuration process.  A simpler option is usually preferable from a security point of view.  <a href="https://www.digitalocean.com/community/tutorials/how-to-setup-a-firewall-with-ufw-on-an-ubuntu-and-debian-cloud-server">DigitalOcean ufw is</a> really good and helps with basic things. <br><br>  <code>ufw</code> installed by default on Ubuntu, and on Debian it is enough to run the command <code>apt-get install ufw</code> . <br><br>  By default, <code>ufw</code> should refuse all incoming connections and allow all outgoing, however, it will not start (because otherwise how would you connect?).  We will go through and explicitly resolve connections that are considered normal. <br><br>  First, you should make sure that IPv6 is supported.  Open the configuration file. <br><br> <code>vim /etc/default/ufw</code> <br> <br>  Set IPv6 to <code>yes</code> . <br><br> <code>IPV6=yes</code> <br> <br>  For the remaining ports that we are going to open, you can simply use the <code>ufw</code> tool from the command line, which is very convenient. <br><br> <code>sudo ufw allow from {your-ip} to any port 22 <br> sudo ufw allow 80 <br> sudo ufw allow 443 <br> sudo ufw disable <br> sudo ufw enable</code> <br> <br>  The first is a redundant measure that ensures that only connections from our IP address can be connected over SSH (standard SSH port) <a name="4"></a>  <sup><a href="https://habr.com/ru/company/rootwelt/blog/303462/">2</a></sup>  The second and third commands open http and https traffic. <br><br>  Note: Thanks to <a href="https://news.ycombinator.com/item%3Fid%3D11910341">chrisfosterelli</a> for <a href="https://news.ycombinator.com/item%3Fid%3D11910341">noticing</a> that if you are going to set the first rule (and you should do this), then make sure that you have a static IP address or a secure VPN that you are connecting to.  A dynamic IP address will leave you without access to the server sometime in the future. <br><br><h3>  Automatic Security Updates </h3><br>  I like them.  They are not perfect, but it's better than missing patches after they are released. <br><br> <code>apt-get install unattended-upgrades <br> <br> vim /etc/apt/apt.conf.d/10periodic</code> <br> <br>  Update this file as follows: <br><br> <code>APT::Periodic::Update-Package-Lists "1"; <br> APT::Periodic::Download-Upgradeable-Packages "1"; <br> APT::Periodic::AutocleanInterval "7"; <br> APT::Periodic::Unattended-Upgrade "1";</code> <br> <br>  I generally agree with Brian that it is better to disable regular updates, and leave only security updates.  The idea is that it will not be very good if an application suddenly stops working due to updating a package with dependencies, while security updates very rarely create problems with dependencies at the application level. <br><br> <code>vim /etc/apt/apt.conf.d/50unattended-upgrades</code> <br> <br>  Edit the file as follows: <br><br> <code>Unattended-Upgrade::Allowed-Origins { <br> "Ubuntu lucid-security"; <br> //"Ubuntu lucid-updates"; <br> };</code> <br> <br>  All is ready. <br><br><h3>  Fail2ban </h3><br><img src="https://habrastorage.org/files/1f7/093/035/1f7093035bcb4e34888c55ba9a696639.png"><br><br>  fail2ban is a great package that proactively blocks suspicious activity as soon as it is detected.  Their <a href="http://www.fail2ban.org/wiki/index.php/Main_Page">wiki</a> says that fail2ban scans the log files (for example, <code>/var/log/apache/error_log</code> ) and bans IP addresses that show suspicious symptoms - too many attempts to enter the wrong password, search for exploits, and so on ... Immediately after installing, Fail2Ban is equipped filters for various services (apache, courier, ssh, etc.). <br><br> <code>apt-get install fail2ban</code> <br> <br><h3>  Two-factor authentication </h3><br>  Two-factor authentication is required if we design a system that meets safety standards.  Theoretically, if you activate two-factor authentication on top of all other protective measures, then to gain access to the server (through the opening of vulnerabilities in applications), attackers will also have to have: <br><br><ol><li>  Access to your certificate and VPN access key. </li><li>  Access your computer to get the secret key. </li><li>  Access your passphrase for the secret key. </li><li>  Access your phone for two-factor authentication. </li></ol><br>  These are many barriers (four) that will have to be overcome.  Even if they get root access through sudo, they will have to find the password deploy, which is protected by AES encryption (the fifth barrier). <br><br>  Install the package. <br><br> <code>apt-get install libpam-google-authenticator</code> <br> <br>  To install, run the command and follow the instructions: <br><br> <code>su deploy <br> google-authenticator</code> <br> <br>  Two-factor authentication is very easy to install and adds a nice extra level of security. <br><br><h3>  Logwatch </h3><br>  This tool is more for fun and monitoring after the fact.  Logwatch keeps track of the logs and, in accordance with the settings, sends by mail a daily beautifully structured summary.  This is quite entertaining data, and you will be surprised how many attempts to access the server occur every day.  I installed it only to show my colleagues how important it is to have good security. <br><br>  DigitalOcean has an <a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-logwatch-log-analyzer-and-reporter-on-a-vps">excellent description of installing and configuring Logwatch</a> , but if we want to keep within 10 minutes, then just install it and do a cron job to run it daily and send an email. <br><br> <code>apt-get install logwatch</code> <br> <br>  Add cron job. <br><br> <code>vim /etc/cron.daily/00logwatch</code> <br> <br>  Add the following line to the cron file: <br><br> <code>/usr/sbin/logwatch --output mail --mailto you@example.com --detail high</code> <br> <br><h3>  All is ready </h3><br>  Here you go.  After completing all of the above, your main concern and failure point will be your application and services.  This is a completely different area. <br><br>  We are trying to formalize and describe our best practices and processes as much as possible; if you want to learn more, study our <a href="https://github.com/codelittinc/incubator-resources">repository</a> .  Everything is in the public domain, and we continue to replenish it. <br><br><hr><br><a name="1"></a>  <sup>1</sup> Make sure that it is `.pub`.  It seems very simple, but I met two comrades (both * do not work in our company ‚Äî they would quickly stop working here) during their careers, who sent me their secret keys (`id_rsa` without the .pub extension) when I asked send the public key.  <a href="https://habr.com/ru/company/rootwelt/blog/303462/" title="back to article">Back to article</a> <br><br><a name="2"></a>  <sup>2</sup> Opinions differ on whether to assign a standard or non-standard port for SSH connections.  See <a href="https://www.adayinthelifeof.nl/2012/03/12/why-putting-ssh-on-another-port-than-22-is-bad-idea/">here</a> and <a href="https://major.io/2013/05/14/changing-your-ssh-servers-port-from-the-default-is-it-worth-it/">here the</a> arguments of both sides.  <a href="https://habr.com/ru/company/rootwelt/blog/303462/" title="back to article">Back to article</a> </div><p>Source: <a href="https://habr.com/ru/post/303462/">https://habr.com/ru/post/303462/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303448/index.html">Another 0day vulnerability found in Adobe Flash Player</a></li>
<li><a href="../303450/index.html">High-Density WiFi. Part 3: About technology. Part 4: About Money</a></li>
<li><a href="../303452/index.html">Report from Moscow Data Science Meetup May 27</a></li>
<li><a href="../303456/index.html">Redux Tutorial</a></li>
<li><a href="../303458/index.html">Ranking Quality Metrics</a></li>
<li><a href="../303464/index.html">10 ways to abuse employees of their official position and methods of dealing with them using the accounting system</a></li>
<li><a href="../303466/index.html">IntelliJ IDEA 2016.2 Public Preview Review</a></li>
<li><a href="../303468/index.html">Experiments with Arduino 101</a></li>
<li><a href="../303470/index.html">The substandard world of open state finances</a></li>
<li><a href="../303472/index.html">Portrait of a participant of the ‚ÄúDarudar‚Äù - infographics poll</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>