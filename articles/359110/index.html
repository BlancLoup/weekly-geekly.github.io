<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New attack technique based on Meltdown. Using speculative instructions for detecting virtualization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Meltdown attack has opened a new class of processor attacks that uses architectural states to transfer information. But the speculative execution,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New attack technique based on Meltdown. Using speculative instructions for detecting virtualization</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/webt/su/lj/zq/suljzqjyckcxbhounfhhfjikzze.png">  The Meltdown attack has opened a new class of processor attacks that uses architectural states to transfer information.  But the speculative execution, which was first used to attack in Meltdown, allows not only to execute the code with the removal of restrictions, but also to find out certain details of the processor.  We found a new way to implement an attack using architectural states.  It allows you to detect virtualization, based on how the processor chooses to send instructions for speculative execution or not.  We reported this method to Intel, and on May 21, 2018, the vulnerability alert <a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00115.html">"Q2 2018 Speculative Execution Side Channel Update" was released</a> , in which our vulnerability CVE-2018-3640 or Specter Variant 3a is present. <br><a name="habracut"></a><br><h3></h3><h4>  <font color="#4169E1">1. Introduction</font> </h4><br>  The attack is based on a side channel in a cache similar to the Meltdown attack.  Meltdown is known to use speculative execution to access memory, which should not be available without special privileges.  The attack in question differs from Meltdown in that it does not use the cache access time threshold.  This is possible due to the fact that the processor executes certain instructions in advance to speed up the execution of the code.  Meltdown recycles reading from buffers controlled by buffers during speculative execution in such a way that the offender can use the memory access time measurements as a side channel. <br><br><h3></h3><h4>  <font color="#4169E1">2. Virtualization</font> </h4><br>  The VT-x technology in Intel processors allows the hypervisor to choose whether VMEXIT (context switch to hypervisor) will occur when executing certain instructions, for example rdtsc.  Most virtualization environments in the standard configuration configure rdtsc interception by default.  So do, for example Virtualbox, VMware, Hyper-V, Parallels on the hypervisor from Apple and from Parallels.  Because VMEXIT actually means a context switch, the instructions that generate VMEXIT are longer to execute than if they were executed in a non-virtualized environment. <br><br><h3></h3><h4>  <font color="#4169E1">3. Attack</font> </h4><br>  A buffer of several pages is created.  Then, instead of speculative access to memory areas in order to obtain data, rdtsc instruction is executed speculatively and the result of its execution is used to access a certain part of the previously allocated buffer.  In the case of speculative execution, only a certain part of the allocated buffer is accessed, which makes it possible to distinguish cases of speculative access from random errors.  After completing the execution of the function containing the speculative execution of the code, the page number of the memory with the lowest access time is added to the statistics.  Then the cache is reset in the entire buffer.  The following are the functions that are used to trigger speculative execution and memory access in 32-bit versions of Windows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs ruby">_declspec(naked) void herring() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    __asm { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  xorps xmm<span class="hljs-number"><span class="hljs-number">0</span></span>, xmm<span class="hljs-number"><span class="hljs-number">0</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/   speculate sqrtpd xmm0, xmm0 sqrtpd xmm0, xmm0 sqrtpd xmm0, xmm0 sqrtpd xmm0, xmm0 sqrtpd xmm0, xmm0 sqrtpd xmm0, xmm0 sqrtpd xmm0, xmm0 sqrtpd xmm0, xmm0 movd eax, xmm0 lea esp, [esp+eax+4] ret } } _declspec(naked) void __fastcall speculate(const char* detector) { __asm { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    rdtsc  mfence. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ,  mov esi, ecx. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ rdtsc  call herring rdtsc. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  and eax, 7. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  or eax, 32. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/* shl eax, 12. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/* movzx eax, byte ptr [esi+eax] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/* } }</span></span></code> </pre> <br>  To successfully launch an attack, these actions must be repeated to find the distribution of cached pages.  You need to perform as many repetitions as you need to collect enough statistical data: during the described test, 10,000 iterations were used.  Then the number of misses by the selected memory region is calculated.  In virtualized environments where rdtsc interception is enabled, the percentage of such misses is between 50 and 99 percent.  On non-virtualized systems, it is less than one percent.  This information is presented in the figure below (the darker the memory region, the more hits recorded in it).  When testing, macOS, Ubuntu, Debian and Windows were used as non-virtualized systems, and Ubuntu, Debian and Windows were used as guest systems. <br><br><img src="https://habrastorage.org/webt/wb/qv/mn/wbqvmnukthx3wucubhf0uyffpao.png"><br><br>  <b>Distribution of cached pages in different environments</b> <br><br><h3></h3><h4>  <font color="#4169E1">4. Description of the attack</font> </h4><br>  The attack uses speculative execution of instructions to force the processor to reveal information about the performance of rdtsc.  In a non-virtualized environment, rdtsc is executed on the processor itself, which simply returns a counter.  In a virtualized environment where the RDTSC exiting bit is set to MSR IA32_VMX_PINBASED_CTLS, the execution of rdtsc is essentially a context switch that takes too long. <br><br>  At the time of the discovery of vulnerabilities, the available internal documentation of Intel processors did not contain data that would allow to explain exactly what is happening.  We have two assumptions: either the processor decides that rdtsc will be executed for too long, and does not execute it until the execution flow reaches it directly, or all instructions that cause VMEXIT are not executed speculatively.  In a non-virtualized environment, the rdtsc instructions immediately following it are executed speculatively, but this does not happen in a virtualized environment. <br><br><h3></h3><h4>  <font color="#4169E1">5. Conclusions and directions for future research</font> </h4><br>  The described attack uses a new Meltdown-based caching technique to create a side channel, which, instead of accessing privileged memory regions, reveals information about the processor's mode of operation.  All known methods for detecting virtualization are highly dependent on using the rdtsc instruction as a timer, which allows the smart hypervisor to deceive these methods by replacing the returned values.  Such an attack can also be limited, but if you make small changes to the code, the substitution of time by the hypervisor will not be able to affect the result.  Perhaps we will publish a PoC of this version later. <br>  It can be concluded that in virtualized environments with intercepted rdtsc, the variation of the described attack allows detecting the presence of virtualization, and in the absence of interception, it is possible to use previously known methods, for example, the method of measuring the speeds of working with TLB caches. <br><br>  This attack allows you to easily and quickly detect virtualization in environments with standard settings or in environments that intentionally use rdtsc interception in order to protect themselves from the detection of virtualization.  This attack was successfully tested on a virtualized sandbox: experts found a sandbox without posing themselves. <br><br>  PoC code can be found at the <a href="https://github.com/bi-zone/rdtsc-checkvirt-poc">link</a> </div><p>Source: <a href="https://habr.com/ru/post/359110/">https://habr.com/ru/post/359110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../359096/index.html">Understanding of homogeneous space-time</a></li>
<li><a href="../359102/index.html">Selectel IPv4 prefix route leaking</a></li>
<li><a href="../359104/index.html">How to deploy the infrastructure for Pivotal CF, or Puff Pie Recipe in pictures</a></li>
<li><a href="../359106/index.html">Work with EventSystem in Unity. Basic things in working with UI</a></li>
<li><a href="../359108/index.html">How do we hire using the bootcamp. Experience of the department of search interfaces</a></li>
<li><a href="../359114/index.html">What is business: a conversation on concepts</a></li>
<li><a href="../359116/index.html">Reverse engineering of the device firmware on the example of a flashing "rhino". Part 1</a></li>
<li><a href="../359118/index.html">It's time to grow up for IT communities: why do we gather activists at RHS?</a></li>
<li><a href="../359120/index.html">Experiments with kube-proxy and node unavailability in Kubernetes</a></li>
<li><a href="../359122/index.html">A bunch of different ways to read bits</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>