<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimizing HSV to RGB Conversion for Microcontrollers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a hobby, I work on LED props and faced an interesting challenge - to show something ‚Äúbeautiful‚Äù on a controlled LED strip instead of a traditional ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimizing HSV to RGB Conversion for Microcontrollers</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/c88/a3c/603/c88a3c6039caac6d8eb87f4dd5551262.png" align="right"><br>  As a hobby, I work on LED props and faced an interesting challenge - to show something ‚Äúbeautiful‚Äù on a controlled LED strip instead of a traditional rainbow, without spending half the microcontroller‚Äôs memory and a significant portion of processor time. <br><br>  LED strip pixels are different from screen pixels by the lack of backlighting.  The black pixel will not look ‚Äúblack‚Äù - it will merge with the background, and in motion it will actually be ‚Äútransparent‚Äù, but if you add at least one to any color channel, this pixel will glow.  In turn, the ‚Äúgray‚Äù pixel will differ from white only in brightness and will appear dimmer, but still ‚Äúwhite‚Äù. <br><br>  The color of the pixel is stored and transmitted in 24-bit RGB, but a large part of this color range (unsaturated and bright colors) is not very representative in individual LEDs.  In addition, building nice gradients in the RGB model will not work - mixing RGB colors does not give an intuitively obvious result ( <a href="http://www.fastcompany.com/3002676/magical-tech-behind-paper-ipads-color-mixing-perfection">yellow + blue = gray</a> , but I want it - green).  The <a href="http://en.wikipedia.org/wiki/HSL_and_HSV">HSL and HSV</a> models fit better, but standard implementations use non-integer arithmetic.  It will be convenient to use a model that can compactly store color parameters and quickly read their RGB values, without using floating-point numbers and dividing by an arbitrary number ‚Äî this is a microcontroller and complex algorithms do not need anything, and division (except for small powers of two ) and is completely contraindicated. <br><a name="habracut"></a><br><h2>  Decision </h2><br>  For my needs, I use the HSV (HSB) model with defined ranges for each of the coordinates (some magic numbers). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Hue - tone, cyclic angular coordinate. </li><li>  Value, Brightness - brightness, perceived as an alpha channel, with <img src="https://habrastorage.org/getpro/geektimes/post_images/518/334/549/5183345497c2adc15f64d54f896b39be.gif" alt="V = 0">  pixel does not glow when <img src="https://habrastorage.org/getpro/geektimes/post_images/385/8ab/4f1/3858ab4f1099ca58234644a8dcd2c264.gif" alt="Vmax = 17">  - glows as brightly as possible, depending on <img src="https://habrastorage.org/getpro/geektimes/post_images/bc8/797/0f9/bc87970f9d091fc0ff31e212051799d3.gif" alt="H">  and <img src="https://habrastorage.org/getpro/habr/post_images/960/581/d21/960581d2147fb9a77d5d6d9b9e69e816.gif" alt="S">  . </li><li>  Saturation.  No background value <img src="https://habrastorage.org/getpro/geektimes/post_images/1bc/c79/678/1bcc79678d7ab429be223abf256eff14.gif" alt="S = 0">  will give not gray, but white of different brightness, therefore the parameter <img src="https://habrastorage.org/getpro/geektimes/post_images/556/0dc/a4f/5560dca4f2e8b73409379dd56bcd940b.gif" alt="W = Smax - S">  can be called Whiteness - it reflects the degree of "whiteness" of color.  With <img src="https://habrastorage.org/getpro/geektimes/post_images/88c/e2e/924/88ce2e924ddbac1071af619a470acb98.gif" alt="W = 0, S = Smax = 15">  color is completely determined by Hue, with <img src="https://habrastorage.org/getpro/geektimes/post_images/a37/611/77a/a3761177a9065dd84d66e36b32a7e9a6.gif" alt="S = 0, W = Wmax = 15">  pixel color will be white. </li></ul><br>  Mathematics of the model is based on the integer division by one sixth of the maximum tone value (size of one sector), therefore, as <img src="https://habrastorage.org/getpro/geektimes/post_images/440/d92/5a5/440d925a5b984f2616bbdfca24e7dac2.gif" alt="Hmax">  convenient to take the maximum value equal <img src="https://habrastorage.org/getpro/geektimes/post_images/0cb/cc9/ac2/0cbcc9ac29efb0f282063035b3d115a7.gif" alt="6 * 2 ^ x">  , for example, 48 or 96. This will allow you to conveniently calculate the RGB color, and a value less than 128 will allow you to build a gradient that several times contains a full color circle.  On HSV / HSL models <img src="https://habrastorage.org/getpro/geektimes/post_images/820/5f1/515/8205f1515b401d3e7573ece51789703e.gif" alt="Hmax = 360">  , in MS Paint - 240, in some libraries - 255. <br><br>  When choosing the maximum values <img src="https://habrastorage.org/getpro/geektimes/post_images/733/e2f/23e/733e2f23e4d2390a1c5224d67eb015db.gif" alt="Bmax = 17">  and <img src="https://habrastorage.org/getpro/geektimes/post_images/732/e45/afb/732e45afb7a3183aac001a2614dc698c.gif" alt="Wmax = 15">  multiplication <img src="https://habrastorage.org/getpro/geektimes/post_images/856/1b3/216/8561b321635a6adcc606bc03a6d1e595.gif" alt="B * w">  gives the result lying in the range <img src="https://habrastorage.org/getpro/geektimes/post_images/a36/07b/fc4/a3607bfc4fe3fd75d3a36c57838d0896.gif" alt="0..255">  . <br><br>  Minimal HSV configuration, simple to calculate and limited to 8-bit values, with ranges <img src="https://habrastorage.org/getpro/geektimes/post_images/16d/f5f/a31/16df5fa31b04e1bb44f5367b9f368082.gif" alt="H = 0..11">  , <img src="https://habrastorage.org/getpro/geektimes/post_images/e04/d83/dc4/e04d83dc4c8f02a26703acfc7afb36e3.gif" alt="B = 0..17">  and <img src="https://habrastorage.org/getpro/geektimes/post_images/571/0d7/a67/5710d7a67ea1686d602f27db5b3754a5.gif" alt="W = 0..3">  gives us <img src="https://habrastorage.org/getpro/geektimes/post_images/e0f/ae3/4aa/e0fae34aaa63e37bb97c85653f8278e2.gif" alt="12 * 18 * 4 = 864">  colors, some of which are almost the same, and some are far enough apart ( <em>for fairness, I note that all color models that operate on H are sinning - Mercator could not stretch the three sides of the cube on a cone without distorting the length</em> ).  The figure seems scant compared to the 24-bit color in a typical monitor ( <strong>16.7 million</strong> unique colors), but it is enough to diversify the LED props, in which earlier and seven colors instead of one were often a pleasant bonus.  The color coordinates in this model can be stored in two bytes. <br><br>  Of course, HSV resolution can and should be increased to a convenient one.  I use <img src="https://habrastorage.org/getpro/geektimes/post_images/74f/f13/e2d/74ff13e2d40cc61a2a1345b72ccb01bf.gif" alt="W = 0..15">  and 96 tones, which gives already <strong>27.6</strong> thousand shades.  An example of code with such parameters (model configuration - max_value, max_whiteness, sixth_hue): <br><br><h2>  Code </h2><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> r; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> g; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> b; } RGB_t; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> h; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> s; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> v; } HSV_t; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> max_whiteness = <span class="hljs-number"><span class="hljs-number">15</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> max_value = <span class="hljs-number"><span class="hljs-number">17</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> sixth_hue = <span class="hljs-number"><span class="hljs-number">16</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> third_hue = sixth_hue * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> half_hue = sixth_hue * <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> two_thirds_hue = sixth_hue * <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> five_sixths_hue = sixth_hue * <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> full_hue = sixth_hue * <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> RGB_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rgb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> r, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> g, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (RGB_t) {r, g, b}; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> HSV_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hsv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> h, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> s, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (HSV_t) {h, s, v}; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RGB_t black = {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-function"><span class="hljs-function">RGB_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hsv2rgb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HSV_t hsv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hsv.v == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> black; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> high = hsv.v * max_whiteness;<span class="hljs-comment"><span class="hljs-comment">//channel with max value if (hsv.s == 0) return rgb(high, high, high); uint8_t W = max_whiteness - hsv.s; uint8_t low = hsv.v * W;//channel with min value uint8_t rising = low; uint8_t falling = high; uint8_t h_after_sixth = hsv.h % sixth_hue; if (h_after_sixth &gt; 0) {//not at primary color? ok, h_after_sixth = 1..sixth_hue - 1 uint8_t z = hsv.s * uint8_t(hsv.v * h_after_sixth) / sixth_hue; rising += z; falling -= z + 1;//it's never 255, so ok } uint8_t H = hsv.h; while (H &gt;= full_hue) H -= full_hue; if (H &lt; sixth_hue) return rgb(high, rising, low); if (H &lt; third_hue) return rgb(falling, high, low); if (H &lt; half_hue) return rgb(low, high, rising); if (H &lt; two_thirds_hue) return rgb(low, falling, high); if (H &lt; five_sixths_hue) return rgb(rising, low, high); return rgb(high, low, falling); }</span></span></code> </pre> <br><br>  PS <br>  TeX-codes in the topic included in the experiment.  If there is a way to do it more conveniently or more correctly - hint at the PM. <br>  If it is interesting, I can separately explain the features of HSV calculation, in particular, the mechanics of rising / falling functions and the function of reverse calculation in ‚Äúsuch‚Äù HSV. </div><p>Source: <a href="https://habr.com/ru/post/166317/">https://habr.com/ru/post/166317/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166305/index.html">How do SSDs (video)</a></li>
<li><a href="../166307/index.html">MintEye CAPTCHA solution in 23 lines of code</a></li>
<li><a href="../166311/index.html">Orange provider forced Google to pay for traffic</a></li>
<li><a href="../166313/index.html">Mega file hosting launched</a></li>
<li><a href="../166315/index.html">Logic - the most interesting gaming and IT-industry news number 10</a></li>
<li><a href="../166319/index.html">Link Aggregation between Cisco Catalyst and Avaya ERS</a></li>
<li><a href="../166321/index.html">We trace "onresize" on an element</a></li>
<li><a href="../166325/index.html">Log in via Facebook, Google, Twitter and Github using Omniauth</a></li>
<li><a href="../166327/index.html">Data center Mega barely copes with the load</a></li>
<li><a href="../166329/index.html">How to measure the interface. Quantitative criterion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>