<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sessions in ASP.NET or how to create your own provider</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ASP.NET offers many options for working with out-of-box sessions: 


- Storing session information in server memory, inside an ASP.NET process 
- Stor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sessions in ASP.NET or how to create your own provider</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/00b/c6d/200/00bc6d2004d3fa3ec3c1d5864c46b23f.png"><br><br>  <b>ASP.NET</b> offers many options for working with out-of-box sessions: <br><ul><li>  Storing session information in server memory, inside an ASP.NET process </li><li>  Storing session information on the state server </li><li>  Storing session information in a SQL Server database in a predefined schema </li></ul><br>  But no matter how many options out of the box, they can not fully respond to the tasks that confront the developer.  In this article, we will look at how to implement our own <strong>ASP.NET</strong> (MVC) session state session storage provider. <br><br>  <strong>SQL Server</strong> will act as session storage.  We will work with the database through <a href="http://msdn.microsoft.com/ru-ru/library/bb399567.aspx" rel="nofollow">EntityFramework</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h2>  Table of contents </h2><br><ol><li>  <a href="https://habr.com/ru/post/141056/">Why am I writing this article?</a> <br></li><li>  <a href="https://habr.com/ru/post/141056/">The reasons for the implementation of its own provider</a> <br><ul><li>  <a href="https://habr.com/ru/post/141056/">Using unsupported storage</a> </li><li>  <a href="https://habr.com/ru/post/141056/">Custom database table schema</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/141056/">Who and how sessions are managed in ASP.NET</a> <br><ul><li>  <a href="https://habr.com/ru/post/141056/">Scheme of work sessions</a> </li><li>  <a href="https://habr.com/ru/post/141056/">Why do we need session locks?</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/141056/">Session Provider Implementation</a> <br><ul><li>  <a href="https://habr.com/ru/post/141056/">Creating a table to store session data</a> </li><li>  <a href="https://habr.com/ru/post/141056/">Creating EntityFramework Data Model</a> </li><li>  <a href="https://habr.com/ru/post/141056/">Provider implementation</a> </li><li>  <a href="https://habr.com/ru/post/141056/">Configuration setting</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/141056/">Testing provider</a> </li><li>  <a href="https://habr.com/ru/post/141056/">Conclusion</a> </li></ol><br><a name="why"></a><br><h2>  Why am I writing this article? </h2><br>  For a long time I was developing <b>php</b> sites.  At some point, I decided to learn something new and chose ASP.NET for this.  Through the prism of the php session, authorization, membership and roles in ASP.NET caused me a lot of questions and dissatisfaction from misunderstanding how this works, and what was understandable was annoying because it didn't work well enough. <br><br>  Now, several years later, I decided to create a series of articles not just to explain how it works, but to show that in ASP.NET there is nothing that could not be changed and done in its own way. <br><br><a name="reasons"></a><h2>  The reasons for the implementation of its own provider </h2><br><a name="reasons1"></a><h3>  Using unsupported storage </h3><br>  Microsoft products are quite expensive and this is a fact, and free versions have a number of limitations.  Thus, you may want to use another database in a free edition, such as <a href="http://ru.wikipedia.org/wiki/Mysql" rel="nofollow">MySQL</a> or <a href="http://ru.wikipedia.org/wiki/PostgreSQL" rel="nofollow">PostgreSQL</a> . <br><br>  On the other hand, you may want to use <a href="http://ru.wikipedia.org/wiki/NoSQL" rel="nofollow">Key-Value storage</a> to improve the performance of a distributed application.  Or maybe you simply have already purchased licenses for products of other companies. <br><br><a name="reasons2"></a><h3>  Custom database table schema </h3><br>  This reason is the most frequent. <br><br>  Standard features are good, but the more complex an application becomes, the more innovative solutions it requires for its work. <br><br>  <strong>Example:</strong> <br>  The site requires that you make it possible to close the session (to do forced exit - logout) for specific users.  The standard database schema for SQL Server does not support this functionality, since sessions do not store user membership information. <br><br><a name="how"></a><h2>  Who and how sessions are managed in ASP.NET </h2><br>  <a href="http://msdn.microsoft.com/ru-ru/library/system.web.sessionstate.sessionstatemodule.aspx" title="msdn" rel="nofollow">SessionStateModule</a> is responsible for processing the state (sessions), it is the default handler.  If you wish, you can implement your own <a href="http://support.microsoft.com/kb/307996" rel="nofollow">http-module</a> that is responsible for handling sessions. <br><br>  The <strong>SessionStateModule</strong> object interacts with the session provider, invoking certain provider methods during its work.  Which session provider to use the module determines based on the configuration of the web application.  Any session provider must inherit from the <strong>SessionStateStoreProviderBase</strong> class, which defines the necessary methods for <strong>SessionStateModule</strong> . <br><br><a name="how-pic"></a><h3>  Scheme of work sessions </h3><br>  Below is a brief scheme of calling the provider methods in order to better understand how sessions work in ASP.NET (clickable). <br><br> <a href=""><img src="https://habrastorage.org/storage2/14e/fd5/e3a/14efd5e3a25d0cfb92fe01050046256a.png"><br></a> <br>  <em>Fig.</em>  <em>Sequence of calling methods for working with sessions</em> <br><br>  First, the <strong>SessionStateModule</strong> determines the session mode for this page (ASP.NET WebForms) or the controller (ASP.NET MVC). <br><br>  If the page attribute is set: <br>  &lt;% @ Page EnableSessionState = "true | false | ReadOnly"%&gt; <br>  (or the <strong>SessionState</strong> attribute for for ASP.NET MVC) <br><br>  That work with the session will occur in <strong>Read Only</strong> mode (read only), which slightly improves the overall performance.  Otherwise, the <strong>SessionStateModule</strong> module requests exclusive access and blocks the contents of the session.  Blocking is removed only in the final stage of the request. <br><br><a name="lock"></a><h3>  Why do we need session locks? </h3><br>  <strong>ASP.NET</strong> applications are multi-threaded applications, and <strong>ajax</strong> technologies are very popular.  It may be a situation that several threads will access the session of the same user at once, in order to avoid conflicts, overwrite stored values ‚Äã‚Äãor retrieve outdated values, locks are used. <br><br><blockquote>  Locks only occur when a session is accessed by the same user from multiple threads. </blockquote><br>  The thread that accessed the session resources first gets exclusive access for the duration of the request.  The remaining threads are waiting until the resources are released, or until a short timeout occurs. <br><br>  We can implement a provider without blocking support, if we have reasons to believe that there will be no conflicts between threads, or they will not lead to significant consequences. <br><br><a name="do"></a><h2>  Session Provider Implementation </h2><br><a name="do-table"></a><h3>  Creating a table to store session data </h3><br>  I will use the following table structure to store session state data: <br><br><img src="https://habrastorage.org/storage2/b66/c19/465/b66c194651952b3ecca72dda2de7d918.png"><br><br>  It supports locks.  I also added the <strong>UserId</strong> field, for my needs, to store information about the user who owns the session (for example, to force the user to logout from the admin panel). <br><br><table><tbody><tr><td>  <strong>SessionId</strong> </td><td>  A unique string label not generated by us.  This random number, encoded into a string composed of Latin letters and numbers, reaches a <a href="http://msdn.microsoft.com/en-us/library/system.web.sessionstate.sessionidmanager.aspx" rel="nofollow">maximum of</a> 24 characters in length. </td></tr><tr><td>  <strong>Created</strong> </td><td>  Time to create a session. </td></tr><tr><td>  <strong>Expires</strong> </td><td>  The time when the session expires. </td></tr><tr><td>  <strong>Lookdate</strong> </td><td>  The moment when the session was blocked. </td></tr><tr><td>  <strong>Lookid</strong> </td><td>  Session lock number. </td></tr><tr><td>  <strong>Looked</strong> </td><td>  Is there currently a lock. </td></tr><tr><td>  <strong>Itemcontent</strong> </td><td>  The contents of the session in serialized form. </td></tr><tr><td>  <strong>Userid</strong> </td><td>  The user Id to which the session belongs (my guest has id = 1) </td></tr></tbody></table><br><br>  SQL query to create the above table (SQL Server): <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[Sessions] ( [SessionId] <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Created] smalldatetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Expires] smalldatetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LockDate] smalldatetime <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [LockId] <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">Locked</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_Sessions_Locked] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ItemContent] varbinary(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [UserId] <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_Sessions] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ([SessionId]) ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br><br><a name="do-ef"></a><h3>  Creating EntityFramework Data Model </h3><br>  I want to save myself from writing SQL queries manually and save time, so I will use ADO.NET <strong>EntityFramework</strong> .  At the same time I will lose a little bit in the performance of the code, compared with the manual creation of SQL queries. <br><br>  To do this, I will use the <strong>ADO.NET Entity Data Model</strong> wizard to create the model I need. <br><br><img src="https://habrastorage.org/storage2/628/20a/aa5/62820aaa58c77247cd3c8db0c0183516.png"><br>  <em>Fig.</em>  <em>Select the ADO.NET Entity Data Model wizard to create a data model</em> <br><br>  I called the created entity <strong>DbSession</strong> .  After that, I will use the code generation templates to create the necessary class and context for interaction with the database.  The context manages the <a href="http://dotnetways.com/sharpbook/collection-overview/" title="collections in .NET">collection of</a> entities from the database. <br><br><img src="https://habrastorage.org/storage2/210/283/14a/21028314a4122323c05a0fbea9e4b7d7.png"><br>  <em>Fig.</em>  <em>Select a menu to apply code generation patterns</em> <br><br>  I like the <strong>DbContext API</strong> , which is available from version 4.1 of <strong>EntityFramework</strong> , and that‚Äôs what I‚Äôll choose. <br><br><img src="https://habrastorage.org/storage2/473/cb3/24f/473cb324fc275dd934ae04a17ecd3261.png"><br>  <em>Fig.</em>  <em>Selecting DbContext as a code generation template</em> <br><br>  Done, now I have a context named <strong>CommonEntities</strong> and a <strong>DbSession</strong> class.  You can begin to implement the provider. <br><br><a name="do-provider"></a><h3>  Provider implementation </h3><br>  First we need to create a <a href="http://dotnetways.com/sharpbook/class-example/" title="classes in c #">class</a> that will be inherited from the base class <strong>SessionStateStoreProviderBase</strong> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> QueryHunter.WebDomain.Layouts.Session; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SessionStateProvider</span></span> : <span class="hljs-title"><span class="hljs-title">SessionStateStoreProviderBase</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br><br>  Next, you need to implement a number of methods, which are best described by the <a href="http://msdn.microsoft.com/en-us/library/ms178587.aspx" rel="nofollow">documentation</a> or the code below with comments: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class SessionStateProvider : SessionStateStoreProviderBase { CommonEntities _dataContext; int _timeout; </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  ,  ,  ... </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override void Initialize(string name, NameValueCollection config) { if (config == null) throw new ArgumentNullException("config"); base.Initialize(name, config); var applicationName = System.Web.Hosting.HostingEnvironment.ApplicationVirtualPath; var configuration = WebConfigurationManager.OpenWebConfiguration(applicationName); var configSection = (SessionStateSection)configuration.GetSection("system.web/sessionState"); _timeout = (int)configSection.Timeout.TotalMinutes; // ,      EntityFramework      . //    Dependency Injection       . _dataContext = new CommonEntities(); } public override void Dispose() { _dataContext.Dispose(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     "  "   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override SessionStateStoreData GetItem(HttpContext context, string id, out bool locked, out TimeSpan lockAge, out object lockId, out SessionStateActions actions) { return GetSessionItem(context, id, false, out locked, out lockAge, out lockId, out actions); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">         . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override SessionStateStoreData GetItemExclusive(HttpContext context, string id, out bool locked, out TimeSpan lockAge, out object lockId, out SessionStateActions actions) { return GetSessionItem(context, id, true, out locked, out lockAge, out lockId, out actions); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">           . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   GetItem,   GetItemExclusive. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> private SessionStateStoreData GetSessionItem(HttpContext context, string id, bool exclusive, out bool locked, out TimeSpan lockAge, out object lockId, out SessionStateActions actions) { locked = false; lockAge = new TimeSpan(); lockId = null; actions = 0; var sessionItem = _dataContext.DbSessions.Find(id); //    if (sessionItem == null) return null; //  ,   if (sessionItem.Locked) { locked = true; lockAge = DateTime.UtcNow - sessionItem.LockDate; lockId = sessionItem.LockId; return null; } //  ,    if (DateTime.UtcNow &gt; sessionItem.Expires) { _dataContext.Entry(sessionItem).State = EntityState.Deleted; _dataContext.SaveChanges(); return null; } //  ,   . if (exclusive) { sessionItem.LockId += 1; sessionItem.Locked = true; sessionItem.LockDate = DateTime.UtcNow; _dataContext.SaveChanges(); } locked = exclusive; lockAge = DateTime.UtcNow - sessionItem.LockDate; lockId = sessionItem.LockId; var data = (sessionItem.ItemContent == null) ? CreateNewStoreData(context, _timeout) : Deserialize(context, sessionItem.ItemContent, _timeout); data.Items["UserId"] = sessionItem.UserId; return data; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   ,     . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override void ReleaseItemExclusive(HttpContext context, string id, object lockId) { var sessionItem = _dataContext.DbSessions.Find(id); if (sessionItem.LockId != (int)lockId) return; sessionItem.Locked = false; sessionItem.Expires = DateTime.UtcNow.AddMinutes(_timeout); _dataContext.SaveChanges(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">      . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override void SetAndReleaseItemExclusive(HttpContext context, string id, SessionStateStoreData item, object lockId, bool newItem) { var intLockId = lockId == null ? 0 : (int)lockId; var userId = (int)item.Items["UserId"]; var data = ((SessionStateItemCollection)item.Items); data.Remove("UserId"); //   var itemContent = Serialize(data); //    ,      . if (newItem) { var session = new DbSession { SessionId = id, UserId = userId, Created = DateTime.UtcNow, Expires = DateTime.UtcNow.AddMinutes(_timeout), LockDate = DateTime.UtcNow, Locked = false, ItemContent = itemContent, LockId = 0, }; _dataContext.DbSessions.Add(session); _dataContext.SaveChanges(); return; } //    ,     , //       . var state = _dataContext.DbSessions.Find(id); if (state.LockId == (int)lockId) { state.UserId = userId; state.ItemContent = itemContent; state.Expires = DateTime.UtcNow.AddMinutes(_timeout); state.Locked = false; _dataContext.SaveChanges(); } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override void RemoveItem(HttpContext context, string id, object lockId, SessionStateStoreData item) { var state = _dataContext.DbSessions.Find(id); if (state.LockId != (int)lockId) return; _dataContext.Entry(state).State = EntityState.Deleted; _dataContext.SaveChanges(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override void ResetItemTimeout(HttpContext context, string id) { var sessionItem = _dataContext.DbSessions.Find(id); if (sessionItem == null) return; sessionItem.Expires = DateTime.UtcNow.AddMinutes(_timeout); _dataContext.SaveChanges(); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">   ,          . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">        ,   . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override SessionStateStoreData CreateNewStoreData(HttpContext context, int timeout) { var data = new SessionStateStoreData(new SessionStateItemCollection(), SessionStateUtility.GetSessionStaticObjects(context), timeout); data.Items["UserId"] = 1; return data; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">         . </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public override void CreateUninitializedItem(HttpContext context, string id, int timeout) { var session = new DbSession { SessionId = id, UserId = 1, Created = DateTime.UtcNow, Expires = DateTime.UtcNow.AddMinutes(timeout), LockDate = DateTime.UtcNow, Locked = false, ItemContent = null, LockId = 0, }; _dataContext.DbSessions.Add(session); _dataContext.SaveChanges(); } #region      public override bool SetItemExpireCallback(SessionStateItemExpireCallback expireCallback) { return false; } public override void EndRequest(HttpContext context) { } public override void InitializeRequest(HttpContext context) { } #endregion #region      private byte[] Serialize(SessionStateItemCollection items) { var ms = new MemoryStream(); var writer = new BinaryWriter(ms); if (items != null) items.Serialize(writer); writer.Close(); return ms.ToArray(); } private SessionStateStoreData Deserialize(HttpContext context, Byte[] serializedItems, int timeout) { var ms = new MemoryStream(serializedItems); var sessionItems = new SessionStateItemCollection(); if (ms.Length &gt; 0) { var reader = new BinaryReader(ms); sessionItems = SessionStateItemCollection.Deserialize(reader); } return new SessionStateStoreData(sessionItems, SessionStateUtility.GetSessionStaticObjects(context), timeout); } #endregion }</span></span></code> </pre><br><br><a name="do-config"></a><h3>  Configuration setting </h3><br>  After we have implemented the provider, it is necessary to register it in the configuration.  To do this, add the code below to the <strong>&lt;system.web&gt;</strong> section: <br><br><img src="https://habrastorage.org/storage2/0a6/216/d16/0a6216d163a384bc3586cc0a594004d8.png"><br><br>  At the same time, <strong>CustomSessionStateProvider.Infrastructure.SessionProvider.SessionStateProvider</strong> is the full class name of our provider, including the namespace.  You will most likely have yours. <br><br><a name="testing"></a><h2>  Testing provider </h2><br>  In order to demonstrate the work of the sessions, I created an empty <strong>ASP.NET MVC 3</strong> application, where I created a <strong>HomeController</strong> controller and defined a number of actions that map and record various elements in the session, including a <a href="http://dotnetways.com/sharpbook/collection-overview/list-example/" title="list in c #">list</a> and a custom class object. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">CustomSessionStateProvider.Controllers</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HomeController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-comment"><span class="hljs-comment">// // GET: /Home/ public ActionResult Index() { return View(); } //   public ActionResult SetToSession() { Session["Foo"] = new List&lt;int&gt;() {1, 2, 3, 4, 5}; Session["Boo"] = new SomeClass(50); return View(); } //    public ActionResult ViewSession() { return View(); } } //   . [Serializable] public class SomeClass { readonly int _value; public SomeClass(int value) { _value = value; } public override string ToString() { return "value = " + _value.ToString(); } } }</span></span></code> </pre><br><br>  I will not give the contents of the views ( <strong>View</strong> ), at the end of the article there is a link to the source codes.  Instead, I will give the result that I received in the browser, sequentially invoking controller actions. <br><br><img src="https://habrastorage.org/storage2/99a/529/85e/99a52985e2de0177896b934ee8b4ca44.png"><br><br><a name="summary"></a><h2>  Conclusion </h2><br>  In conclusion, I just want to add that you do not need to be afraid to deviate from the standards, often your own solutions allow you to create more productive and flexible applications. <br><br>  In the next article I will look at how to create your own membership mechanism in ASP.NET. <br>  Thank you for your attention, enjoy your weekend! <br><br>  PS Source codes are available at the link: <a href="">CustomSessionStateStoreProvider.zip</a> <br><br><h4>  useful links </h4><br>  <a href="http://habrahabr.ru/post/123812/" rel="nofollow">Writing your Session Store Provider ASP.NET using Redis</a> by Kirill Muzykova ( <a href="https://habrahabr.ru/users/kmuzykov/" class="user_link">kmuzykov</a> ) <br>  <a href="http://msdn.microsoft.com/ru-ru/library/ms178587.aspx" rel="nofollow">Implementing session state storage provider</a> (msdn) <br>  <a href="http://msdn.microsoft.com/ru-ru/library/ms178588.aspx" rel="nofollow">Sample session state storage provider</a> (msdn) <br>  <a href="http://www.codeproject.com/Articles/20575/ASP-NET-session-state-store-provider-for-MySQL" rel="nofollow">MySQL Provider for</a> Harry Kimpel </div><p>Source: <a href="https://habr.com/ru/post/141056/">https://habr.com/ru/post/141056/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141049/index.html">Habrometer Widget for Dashboard</a></li>
<li><a href="../141050/index.html">ParaType has released a free font "PT Mono Bold" (bold version of the font "PT Mono")</a></li>
<li><a href="../141051/index.html">April 14, 2012 - Russian final of the Imagine Cup AKA Student Day 2.0</a></li>
<li><a href="../141052/index.html">Microsoft has translated into Open Source another part of the stack of technologies ASP.NET</a></li>
<li><a href="../141055/index.html">Company Mars - Re: Skype went on the advertising path</a></li>
<li><a href="../141058/index.html">Preparing content for the site - problems and solutions</a></li>
<li><a href="../141060/index.html">Let's civilize the mailing lists</a></li>
<li><a href="../141061/index.html">Scene # 27</a></li>
<li><a href="../141062/index.html">Taxer - submission of the annual report to the pension fund of Ukraine online</a></li>
<li><a href="../141063/index.html">Technology: Autograph</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>