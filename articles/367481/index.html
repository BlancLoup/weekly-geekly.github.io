<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making an "eternal" mass air flow sensor on the ATiny13</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This project appeared because of the reluctance to buy a used part for about 30 (thirty) years of detail for a very big amount of 3000 - 5000 rubles. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making an "eternal" mass air flow sensor on the ATiny13</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b64/f1e/a7c/b64f1ea7c5dc4e4d996164cac1046ed6.jpg"><br><br>  This project appeared because of the reluctance to buy a used part for about 30 (thirty) years of detail for a very big amount of 3000 - 5000 rubles.  We can say that it will be a sample of the pen in the circuit design and programming of microcontrollers.  If interested - continued under the cut. <br><br><h4>  Caution many photos! </h4><a name="habracut"></a><br>  So, we start to prop the bikes with crutches. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Input data </h4><br>  BMW E30 in the back of 1986 with the engine M10B18 (4 cylinder, 1.8l, injector): <br><br><img src="https://habrastorage.org/files/4fa/442/5d4/4fa4425d44004da994d238b6a1159329.jpg"><br><br><h5>  Problems </h5><br>  1. sneezes <br>  2. Does not go <br>  3. Eats and does not get fat <br><br>  Years in Russia did not spare her.  High-quality gasoline, salt baths, <a href="https://www.youtube.com/watch%3Fv%3DRyzrmiRxQwc">"porous roads</a> . <a href="https://www.youtube.com/watch%3Fv%3DRyzrmiRxQwc">"</a>  However, most of all she got from the former owners and the harsh Russian auto mechanics, senseless and merciless, who made repairs of dubious necessity and efficiency.  A striking example of one of these repairs, you can admire the KDPV.  And what is this little white there, all in solder?  This is a ceramic board - the main part of the <abbr title="Mass air flow sensor">DMRV</abbr> , film resistors are applied to it and the path along which the moving contact should run.  As you can see in the photo, she cracked, and someone tried to restore it by such a barbaric method.  Unsuccessfully.  Here it is - the root of all problems!  Here it must be said that <abbr title="Mass air flow sensor">DFID</abbr> is the main sensor affecting the mixture formation. <br><br><h4>  Some theory </h4><br>  Our machine is equipped with the miracle of the German industry with the L-Jetronic distributed injection system. <br><br>  Google says: <br><blockquote>  The system of distributed injection L-Jetronic is a system of pulse injection with electronic control of the quantitative and qualitative composition of the fuel-air mixture.  To ensure the pulse injection of fuel in the system used nozzles with electromagnetic control. </blockquote><br><img src="https://habrastorage.org/files/13e/451/b55/13e451b558454e4ba1efd426d42f2656.jpg"><br><br><img src="https://habrastorage.org/files/c5e/a75/138/c5ea75138afb49568a3d626a9c5037ac.gif"><br><br>  Well, distributed - it is loudly said, here all 4 injectors are connected in parallel and, accordingly, pshikayut at the same time, although yes, I find fault with it, they are installed opposite each other to its cylinder in different places of the intake manifold - i.e.  distributed.  The brain here is rather silly - idling, ignition, does not control the heating rotations. <br><br>  All that is subject to him is a few sensors and injectors. <br><br>  Let's return to DFID.  Here is installed electro-mechanical DMRV, popularly referred to as "shovel", apparently for the characteristic form of a movable damper. <br><br><img src="https://habrastorage.org/files/8bc/e21/bde/8bce21bde01a46e9a54202ebb72806e3.jpg"><br><br>  Its principle of operation is quite simple: the air consumed by the motor passes through the inlet, and, depending on the intensity (count the air mass per unit of time), deflects the measuring flap by a certain angle.  A movable contact is installed on the gate axis, which runs along the path of our long-suffering card from the first picture. <br><br><h4>  Solutions to the problem: </h4><br>  <b>1. Buy a new DFID</b> - cosmic money costs 35,000-60000 rubles, comparable to the cost of a car. <br>  <b>2. Buy BU DFID</b> - 30 years of operation, no guarantees, it costs 3000 - 5000 rubles. <br>  <b>3. Buy a new board</b> (unoriginal, do in small batches) - the price is 300r + forward, it looks like this: <br><br><img src="https://habrastorage.org/files/115/f9b/815/115f9b8158674acaa24d38ba6001a804.jpg"><br><br>  As you can see, the design is different from the factory.  Reliability is questionable, on the Internet you can find negative reviews about the allegedly fragility of this decision, confirmed by photos of worn-out boards of this type. <br><br>  <b>4. Buy a modern type DFID without moving parts + a so-called converter</b> - the price of the issue is a little scary, just need to adapt the intake tract, increase the length of the pipes, etc. <br><br>  <b>5. Come up with something different</b> . <br><br>  For me, the choice was obvious. <br><br>  I decided to leave the mechanical part, as I did not find any signs of wear.  I think it will last longer than the rest of the car. <br><br>  The task has simplified a bit, it is necessary to convert the angle of rotation into voltage.  But no, wait, not everything is so simple ... The fact is that, as I already said, the brain is quite silly here and, accordingly, he wants to receive the most up-to-date data at the entrance.  This is reflected in the DFID design - the graph of output voltage versus the angle of rotation of the flap axis is nonlinear, and the added complexity is scaled by the resistance of the air temperature sensor, which is also integrated into the DFID.  Accordingly, the sensor characteristic should change depending on the air temperature. <br><br>  The search for a ready-made circuit solution did not lead to success.  The problem with the wear and tear of DFID of this type has touched many, many topics in specialized forums where people discuss dozens of pages how to solve it. <br><br>  For a start, I would like to receive data on the angle of rotation of the axis.  Variable resistors and other mechanics I immediately dropped as unreliable.  The optical sensor is good, but dust can cause trouble, and there is enough dust on the road.  Magnetic sensors are probably what you need. <br><br>  I found this: <a href="http://datasheet.octopart.com/KMA200-T/R-NXP-datasheet-611991.pdf">KMA-200</a> . <br><br><img src="https://habrastorage.org/files/a09/665/22f/a0966522f6bc4a128c41ba2bc53ca566.jpg"><br><br>  On the move, I could not buy it in my own wilderness.  And accidentally stumbled upon such a ready-made TPS in which KMA-200 was applied. <br><br><img src="https://habrastorage.org/files/130/aa4/5b8/130aa45b81474ede8a44570bb7fe89ea.jpg"><br><br>  In the load I get a magnet with a mount, the sensor is already on the board with the necessary strapping, coated with varnish that protects against moisture and static.  Found by the way a <a href="https://www.drive2.ru/l/2690133/">similar project</a> . <br><br>  Fine! <br><br>  At the output of this sensor voltage from 0 to 5 volts, the dependence on the angle of rotation is linear.  We need to somehow convert it to the characteristic we need.  Analog circuits could, in principle, provide this, but they would be rather complicated in design and adjustment, for example, some integrator on thermal operators with thermal compensation, but this is difficult for me ... <br><br>  Then I remembered that I have a handful of ATiny13, why not use them? <br><br>  Sketched and modeled shemku: <br><br><img src="https://habrastorage.org/files/321/1d4/ef1/3211d4ef1cb24acebdd5f8edad3e00a3.jpg"><br><br>  A little about the scheme. <br><br><ul><li>  The microcontroller is clocked from an internal 8 MHz oscillator. </li><li>  Two ADC channels were used, the angle of rotation of the valve axis and the voltage level on the resistive divider are read, of which the temperature sensor is part. </li><li>  PWM output signal with a frequency of about 18 kHz </li></ul><br>  Then a simple filter and an LM358 operational amplifier from the old motherboard (CG = 1 + (330000/100000) = 4.3), which controls the field engineer (from the same motherboard).  Maximum output voltage = 4.3 * 2.5 = 10.75V. <br><br>  Why do you ask a fieldman?  And who knows, I will answer you!  Excess will not be.  Using this scheme, I managed a powerful load in the form of several automotive lamps connected in parallel just to check that it could also. <br><br>  In general, all the details I had in stock except for the rotation sensor. <br><br>  Time to write the firmware!  This is my first MK firmware, so of course everything is not optimal, and of course I chose the slightly weird BascomAVR tool, in which I have to write in some kind of pseudo-Cubesian.  Obviously, the compiler built in there is not very optimized, the firmware turns out to be bold, and the polynomial interpolation I wanted to cram in there unfortunately did not fit.  I had to implement the approximation in three straight lines.  Why three?  Because it is no longer climbed (Bascom + 1 kb flash). <br><br><pre><code class="diff hljs">$regfile = "attiny13.dat" $hwstack = 8 $swstack = 16 $framesize = 16 Config Portb.1 = Output Config Timer0 = Pwm , Prescale = 1 , Compare B Pwm = Clear Up Config Adc = Single , Prescaler = Auto Start Timer0 Dim Adcval As Word , Temp As Single Do Adcval = Getadc(2) '  Select Case Adcval '        Case 0 To 306 Temp = Adcval * 2.2 Adcval = Temp Case 307 To 613 Temp = Adcval * 0.9377 Adcval = Temp Adcval = Adcval + 384 Case 614 To 1023 Temp = Adcval * 0.15 Adcval = Temp Adcval = Adcval + 870 End Select Temp = Adcval * 0.0009765625 '   Adcval = Getadc(3) '  Temp = Temp * Adcval '        Pwm0b = Temp * 0.25 '   Loop End $prog &amp;HFF , &amp;H7A , &amp;HFF , &amp;H00 ' generated. Take care that the chip supports all fuse bytes. $prog &amp;HFF , &amp;H6A , &amp;HFF , &amp;H00 ' generated. Take care that the chip supports all fuse bytes. $prog &amp;HFF , &amp;H7A , &amp;HFF , &amp;H00 ' generated. Take care that the chip supports all fuse bytes. $prog &amp;H00 , &amp;H00 , &amp;H00 , &amp;H00 ' generated. Take care that the chip supports all fuse bytes. $prog &amp;H00 , &amp;H00 , &amp;H00 , &amp;H00 ' generated. Take care that the chip supports all fuse bytes.</code> </pre> <br>  To find out the equations of lines literally for 10 minutes, I sketched a dull soft in Qt Creator, I moved the control points, I decided on the position of the lines. <br><br><img src="https://habrastorage.org/files/138/3f0/b91/1383f0b9198545419e550b363c15b56d.jpg"><br><br>  The red line is the desired characteristic, the blue line is an approximation of straight lines.  Next, compile and upload the firmware to the emulator.  Everything moves as I expected. <br><br>  In a hurry, we part the board and uncover the laser iron. <br><br><img src="https://habrastorage.org/files/2f3/7c8/5a7/2f37c85a79fa4a148961684e52a040fd.jpg"><br><br>  We poison, we solder, we fix the jambs of the wiring (well, where can we go without them). <br><br><img src="https://habrastorage.org/files/363/ca1/bc1/363ca1bc15b2460a8c974875c8640b31.JPG"><br><br><img src="https://habrastorage.org/files/dc6/c9b/5b0/dc6c9b5b0dba4117bbbeb7e6e8d13bfc.JPG"><br><br>  Attentive reader and experienced amateur radio will notice 2 errors that I made when sealing. <br><br>  Further inclusion, check of basic parameters, and daily running in the different modes.  The audit showed that everything works as planned.  The time of assembly and installation on the car. <br><br><img src="https://habrastorage.org/files/f45/f28/a6d/f45f28a6d25e42398ee83b0dd9041632.JPG"><br><br><img src="https://habrastorage.org/files/7d0/9cc/01b/7d09cc01b6a245149207fa1e822d0c52.JPG"><br><br><img src="https://habrastorage.org/files/fa2/45d/b1c/fa245db1cd40427c8ebc79f9b6cb8a3a.JPG"><br><br>  After tuning by the trimmer, the car starts to work as it should, later the gas mileage and dynamics were checked, everything turned out to be normal, those corresponded to the declared characteristics.  The machine rolled to the south from central Russia, no problems appeared. <br><br><hr><br>  I believe that the first experience of programming microcontrollers, and in principle and the creation of circuits, was successful for me.  Of course there are flaws: for example, the choice of programming environment.  In the next project I already used CVAVR, the firmware is much more compact.  The choice of a microcontroller could also be called not successful, although I did not choose it, I had one, and there was a desire to use it.  Immediately after completing this project, I ordered several ATiny85s, which have 8 times more memory, but while the package was being sent, they suddenly bought this car, and the DFID remained with a non-ideal algorithm). </div><p>Source: <a href="https://habr.com/ru/post/367481/">https://habr.com/ru/post/367481/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../367471/index.html">New service Google News Lab helps journalists to do their work</a></li>
<li><a href="../367473/index.html">Even Saudi Arabia is switching to solar energy.</a></li>
<li><a href="../367475/index.html">Registrars suspend domains of Rutor and most of The Pirate Bay</a></li>
<li><a href="../367477/index.html">Electricity on the plane</a></li>
<li><a href="../367479/index.html">The robot cockroach runs fast and easily overcomes obstacles</a></li>
<li><a href="../367485/index.html">IBM Watson is now cooking for everyone.</a></li>
<li><a href="../367487/index.html">Expert opinion: Comments of MISiS scientists on future professions in medicine</a></li>
<li><a href="../367489/index.html">Telegram has opened a platform for bots</a></li>
<li><a href="../367491/index.html">Hospital Detective: the deadly "superbug" was hiding in plain sight</a></li>
<li><a href="../367493/index.html">DEXP tablets on Intel¬Æ: a review of 4 models priced from 11,990 to 15,990 rubles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>