<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Competent setting of the mail sending server for PHP scripts, setting up the mail () function</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic, you will learn how to properly configure the outgoing mail server and, in particular, the mail () function in PHP. I myself am a creepy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Competent setting of the mail sending server for PHP scripts, setting up the mail () function</h1><div class="post__text post__text-html js-mediator-article">  In this topic, you will learn how to <u>properly</u> configure the outgoing mail server and, in particular, the mail () function in PHP.  I myself am a creepy pedant.  I love everything to be everywhere in their places, I do not like hack-work.  Seeing once complete nonsense in the headers of the letter from my server, I figured it out dramatically and unconditionally.  By intelligent configuration, I mean one that meets the needs of spam filters of large mail systems, and just looked beautiful and meaningful. <br><img align="left" src="https://habrastorage.org/storage2/a82/501/623/a825016230806e86a2ca38756a4d0f64.jpg"><br>  As you know, the SMTP protocol does not imply any means of protection against spam and user authentication, so large and not-so-great companies have invented protocol fixes. <br>  If you are installing a dedicated server with a domain hosted on it, it is highly recommended that you make these settings so that everything is as it should be. <br><br>  I spent a lot of time studying this question, having understood each heading.  I started with the basic settings from the packages, at the same time I chose what I liked from the provided packages, but I finished it with a subtle fenshui, which I didn‚Äôt realize until the end, because it was already quite refined. <br><br>  The title of the title chose exactly this, since at the beginning of my path I was looking for something like this.  We will configure postfix, php, dns (ptr, spf), and more. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This article will be interesting to people setting up dedicated servers, but <b>no less interesting for ordinary programmers</b> . <br><br>  Details under the cut <br><a name="habracut"></a><br><h4>  Preamble </h4><br>  Someone uses the libs that replace the mail function (for example, phpmailer), they can communicate with SMTP directly, or they can send it to a local server.  But it is better to use the standard built-in and configured PHP mail () function which will send mail to the local outgoing mail server, which in turn will deal with it itself.  When using this function, the brakes are the least quantity, as the local mail agent quickly accepts or rejects the mail, and if so, it delivers it by itself. <br><br>  The article is not formatted in the best way.  I apologize, time is running out, but I want to tell while I remember, but then there will be no time. <br><br><h4>  What to check our work? </h4><br>  We test this method <br><pre><code class="php hljs">$result = mail(<span class="hljs-string"><span class="hljs-string">'yourmail@domain.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'subject'</span></span>, <span class="hljs-string"><span class="hljs-string">'message'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($result) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'-  '</span></span>; }</code> </pre> <br><br>  We will read a lot of headers.  It is very convenient to browse headlines in gmail, there is such a chip in 2 clicks, you will find it yourself. <br><br><h4>  What goals in the headings do we need to achieve? </h4><br>  <b>- Here are these headers from gmail.com</b> <br>  Please note that these are the headers with which the <b>letter goes to the end-user box.</b> <br><pre> Delivered-To: YOURMAIL@DOMAIN.DOM
 Received: by 10.182.0.137 with SMTP id 9cs9033obe;
         Sat, 21 Jan 2012 13:25:09 -0800 (PST)
 Received: by 10.205.119.199 with SMTP id fv7mr1052469bkc.113.1327181107295;
         Sat, 21 Jan 2012 13:25:07 -0800 (PST)
 Return-Path: &lt;no-reply@wartur.ru&gt;
 Received: from wartur.ru (wartur.ru. [188.134.79.140])
         by mx.google.com with ESMTP id ua10si4066845bkb.110.2012.01.13.13.25.06;
         Sat, 21 Jan 2012 13:25:07 -0800 (PST)
 Received-SPF: pass (google.com: domain of no-reply@wartur.ru designates 188.134.79.140 as permitted sender) client-ip = 188.134.79.140;
 Authentication-Results: mx.google.com;  spf = pass (google.com: domain of no-reply@wartur.ru designates 188.134.79.140 as permitted sender) smtp.mail=no-reply@wartur.ru
 Received: by wartur.ru (Postfix, from userid 1002)
	 id 9913B61D;  Sun, 22 Jan 2012 01:24:55 +0400 (MSK)
 To: YOURMAIL@DOMAIN.DOM
 Subject: subject
 X-PHP-Originating-Script: 1002: index.php
 Message-Id: &lt;20120121212455.9913B61D@wartur.ru&gt;
 Date: Sun, 22 Jan 2012 01:24:55 +0400 (MSK)
 From: no-reply@wartur.ru
</pre><br>  <b>- As well as these headers from mail.ru</b> <br><pre> Return-path: &lt;no-reply@wartur.ru&gt;
 Received-SPF: pass (mx64.mail.ru: domain of designart 188.134.79.140 as permitted sender) client-ip = 188.134.79.140;  envelope-from=no-reply@wartur.ru;  helo = wartur.ru;
 Received: from [188.134.79.140] (port = 64667 helo = wartur.ru)
	 by mx64.mail.ru with esmtp (envelope-from &lt;no-reply@wartur.ru&gt;)
	 id 1RoiQJ-0005E9-6r
	 for wartur@list.ru;  Sun, 22 Jan 2012 01:24:31 +0400
 X-Mru-BL: 0: 0: 0: 0
 X-Mru-PTR: wartur.ru
 X-Mru-NR: 1
 X-Mru-OF: Linux (ethernet / modem)
 X-Mru-RC: RU
 Received: by wartur.ru (Postfix, from userid 1002)
	 id 460BC9B7;  Sun, 22 Jan 2012 01:24:20 +0400 (MSK)
 To: wartur@list.ru
 Subject: subject
 X-PHP-Originating-Script: 1002: index.php
 Message-Id: &lt;20120121212420.460BC9B7@wartur.ru&gt;
 Date: Sun, Jan 22, 2012 01:24:20 +0400 (MSK)
 From: no-reply@wartur.ru
 X-Spam: Not detected
 X-Mras: Ok
 X-Mru-Authenticated-Sender: uid: 1002@wartur.ru
</pre><br><br>  When you first start, you will see that you do not have such beautiful headlines.  The receiving mail server will take you as a chuchmek, and will write about this in the header of the letter with a warning that he will deliver you a little more in a black list.  All information in the header is used by all chains of servers and the receiving agent in order to, depending on the settings of the spam filter, reject the letter or accept.  The most dragon methods are black lists, and soft ones define bad ones by headings and complaints. <br><br>  I also notice that if you set the 4th parameter in the mail () function and put the From header, then the From: no-reply@wartur.ru title will also change, and if you do not specify it, it will be automatically determined the same as the header Return-path: &lt;no-reply@wartur.ru&gt;, which you can see in my headlines. <br>  Such a scheme is very convenient: sending goes through a server with a modified From header, and reception to gmail (via domain services).  It is desirable that the mail would also belong to the same domain for which the server is configured, as well as some of the items listed below. <br><br><h4>  Let's get started </h4><br>  <b>- Board</b> <br>  Gentlemen, I like to put all the packages, and I do not advise newcomers to engage in amateur activities, many packages already have automatic configuration scripts, the results of which need only be a little tweaked and everything will be fine.  In addition, from the repositories it is updated by itself and generally less so is just because it is smaller. <br><br>  <b>- PHP setup</b> <br>  We set as we want php, it's you somehow without me. <br><br>  Go to the settings of php, replace the equivalent: <br><pre> sendmail_path = / usr / sbin / sendmail -t -i -fno-reply@wartur.ru
</pre><br><br>  By this we have specified the header Return-Path: &lt;no-reply@wartur.ru&gt; <br><br>  By the way, 1: it will be such for all virtual domains of the server, in order to fix it and configure it for the current one, then you need to pass the 5th parameter to the mail () function. <br><pre> <code class="php hljs">$result = mail(<span class="hljs-string"><span class="hljs-string">'YOURMAIL@DOMAIN.DOM'</span></span>, <span class="hljs-string"><span class="hljs-string">'subject'</span></span>, <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-string"><span class="hljs-string">'From ...'</span></span>, <span class="hljs-string"><span class="hljs-string">'-fno-reply@yourdomine.ru'</span></span>);</code> </pre><br>  By the way 2: if you put the 5th parameter on a regular virtual hosting, then you are also advised to set up your domain, as described below.  I draw your attention to the fact that the operation with PTR records cannot be done, since 1 IP = Domain, or at least it is not recommended to make them 2, I don‚Äôt remember already. <br><br>  <b>- Configure MTA</b> , it is also a local outgoing mail server <br>  I sincerely advise you postfix, then go to the settings /etc/postfix/main.cf <br>  for those who have already run into sendmail, and realized how hard they are being cut out of the system, I advise the command: <br><pre> <code class="bash hljs">aptitude purge sendmail</code> </pre><br><br>  Next, we do an equivalence like this <br>  myhostname = wartur.ru <br>  #smtp_helo_name = k-wartur.wartur.ru <br>  mydestination = _ALL_, wartur.ru, k-wartur.wartur.ru, localhost.wartur.ru, localhost <br><br>  (k-wartur.wartur.ru - this is my server in the domain wartur.ru) <br><br>  - If I'm not mistaken, it helped.  When the delivery agent is submitted to another server, HELO is transmitted.  Change myhostname, change the following header: <br>  Message-Id: &lt;20120121212420.460BC9B7@wartur.ru&gt; <br><br>  - smtp_helo_name by default is myhostname, read materiel <br><br>  - mydestination - if I'm not mistaken, it sets the domains from which the MTA will accept mail for processing, if you have virtual hosting (which I arranged on the server at home), then without _ALL_ you will have problems sending mail from other domains than those specified . <br><br>  <i>Well, you see, the headlines are much more correct, aren't they, or else the horror was at first.</i> <br><br>  <b>- Showdown with postal services (mailers)</b> <br>  And they consider us as an unkind source. <br>  Our server was able to correctly introduce helo, but only mailers do not trust us anyway. <br>  For this, an algorithm was invented, so that the domain owner using DNS (if he is of course literate as we) could indicate that you can trust such-and-such servers, but others cannot. <br><br>  You instead of the horror that now should have this: <br><pre> Received-SPF: pass (google.com: domain of no-reply@wartur.ru designates 188.134.79.140 as permitted sender) client-ip = 188.134.79.140;
 Received-SPF: pass (mx64.mail.ru: domain of designart 188.134.79.140 as permitted sender) client-ip = 188.134.79.140;  envelope-from=no-reply@wartur.ru;  helo = wartur.ru;
</pre><br><br>  We are already on the road to truth.  By the way, by default, the mailer considers everything as v = spf1 ~ all, which lowers the threshold level of entry into the blacklist, and you can also use your domain to send spam, and you did not know yourself that they would be marked as bad for future times. <br><br>  We go to DNS and create a TXT record in your domain, in my case wartur.ru <br>  v = spf1 + mx + a: wartur.ru + a: k-wartur.wartur.ru + include: gmail.com -all <br><br>  v = spf1 <br>  This means that the version of the spf1 algorithm <br><br>  + mx <br>  You can trust the mail if it is sent from mx servers, for example, if mx.wartur.ru is a reception server, then if it sends the server, everything will be fine. <br><br>  + a: wartur.ru <br>  You can trust the server serving the domain wartur.ru <br><br>  I will also add, for example, pupkin.ru is located on my mail server. <br>  I gave Pupkin to drive my outgoing mail server k-wartur.wartur.ru (the usual situation of virtual hosting, it always stands locally, as a database, and everything is all all).  Then <b>he</b> should set up + a: k-wartur.wartur.ru <br><br>  + include: gmail.com <br>  We import all the rules of gmail.com, they also have such a TXT record for their servers.  (I use google services for a domain) <br><br>  -all <br>  We indicate that the admin considers other places not his own, and this may be the nearest brothel in the gateway sending spam on my behalf <br>  (+ all and this means that the whole world is my friends) <br><br>  Materiel for self-learning <br>  <a href="http://ru.wikipedia.org/wiki/Sender_Policy_Framework">http://ru.wikipedia.org/wiki/Sender_Policy_Framework</a> <br><br>  <b>- Showdowns with postal services, setting up reverse PTR</b> <br>  Mailers still ask for the return domain zone PTR for an extra tick, I think this tick is one of the <b>fattest</b> , as it defines the server 100%, and if it behaves correctly, then it is very much trusted and any letter will reach the addressee. <br>  X-Mru-PTR: wartur.ru, it‚Äôs in google it‚Äôs Received: from wartur.ru (wartur.ru. [188.134.79.140]) <br><br>  <u>The note:</u> <br>  In a virtual hosting, you will not be allowed to do this, they have their server zamapin at this address, some servername.badhosting.ru, on which you host, and generally only on your own server with your own IP, it is possible to crank it. <br><br>  Interesting: If you live at home, and I have one of the servers at home, in particular wartur.ru.  What to do?  like IP dedicated, and the return address is not configured.  I called above (to the provider) said they say, and so I want to PTR zone.  I did it, very pleased. <br><br><h4>  Some more words about headlines (all mixed up) </h4><br>  X-Mru-BL: 0: 0: 0: 0 God forbid you to have anything other than zeros, these are blacklist. <br>  X-Mru-OF: the interface from which is sent, I still do not understand what it depends on. <br>  X-PHP-Originating-Script: - I would advise you to add, although if you are very concerned about security and non-disclosure, you can also prohibit it.  This is done not far from the PHP settings of which we did.  Enabled by default. <br><br>  It is also possible and interesting to see what Yandex writes when receiving, very interesting. <br><br><h4>  Additionally </h4><br>  There are still some digital signatures. <br>  determined by the header, DKIM-Signature <br>  In appearance, I already had everything in order, and this title is not very necessary.  It is usually needed by a very large scale service like facebook or google where the sending of notifications and mail goes on a gigaton scale.  If your service does not have millions of users, do not think about it, although if you are a surveyor, write how it is here and we will link the articles - that everything would seem completely complete, but I ask you to write a lot easier, because I have already seen somewhere articles about it all.  From myself I‚Äôll add that I was too lazy to install another package, to figure it out and something else. <br><br><hr><br>  Unfortunately, there is no material, because I collected it from scratch 4 months ago, then I didn‚Äôt have time, and now I have written from memory. <br><br>  Successful competent setup of your server.  I tried to explain at least one of several aspects of customization. <br><br>  <b>UPD:</b> <br>  Found an interesting proof on the topic: <a href="http://forum.ixbt.com/topic.cgi%3Fid%3D7:26978">http://forum.ixbt.com/topic.cgi?id=7:26978</a> <br><br>  It is also interesting to read: <br>  <a href="http://habrahabr.ru/blogs/sysadm/114852/">http://habrahabr.ru/blogs/sysadm/114852/</a> <br><br>  <b>UPD2: 2012.08.02</b> <br>  Cool article just on the topic! <br>  <a href="http://habrahabr.ru/post/141534/">http://habrahabr.ru/post/141534/</a> <br><br>  <b>UPD3: 2013.04.04</b> <br>  Hoping for the consciousness / attentiveness of people, I put the workplaces, so that you saw the real picture and changed them.  I repeatedly received messages with meaningless content in the mail, so I changed the address to YOURMAIL@DOMAIN.DOM </div><p>Source: <a href="https://habr.com/ru/post/136735/">https://habr.com/ru/post/136735/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136722/index.html">iPhonekino - video review of applications and games for the iPhone</a></li>
<li><a href="../136724/index.html">Casio CSF-5750. Color electronic notebook</a></li>
<li><a href="../136725/index.html">Tower Defense + Box2D</a></li>
<li><a href="../136727/index.html">Startup Request: Kill Hollywood</a></li>
<li><a href="../136728/index.html">Next generation Wi-Fi - 802.11ac in brief</a></li>
<li><a href="../136736/index.html">The principle of domino or XSS on large sites runet</a></li>
<li><a href="../136737/index.html">Promotion experience in the Russian AppStore</a></li>
<li><a href="../136738/index.html">JavaScript application for iPad. Couple of tips</a></li>
<li><a href="../136740/index.html">I slowly remove apache from the server</a></li>
<li><a href="../136742/index.html">Prolog - parse and language problems</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>