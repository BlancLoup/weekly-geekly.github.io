<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Magic Constant" 0x5f3759df</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article we will talk about the "magic" constant 0x5f3759df, which is the basis of an elegant algorithmic trick to quickly calculate the invers...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">ğŸ”</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">ğŸ“œ</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">â¬†ï¸</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">â¬‡ï¸</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Magic Constant" 0x5f3759df</h1><div class="post__text post__text-html js-mediator-article">  In this article we will talk about the "magic" constant 0x5f3759df, which is the basis of an elegant algorithmic trick to <a href="http://en.wikipedia.org/wiki/Fast_inverse_square_root">quickly calculate the inverse square root</a> . <br><br>  Here is the full implementation of this algorithm: <br><br><pre><code class="cpp">float FastInvSqrt(float x) {
  float xhalf = 0.5f * x;
  int i = *(int*)&amp;x;  //   float    
  i = 0x5f3759df - (i &gt;&gt; 1);  //     ?
  x = *(float*)&amp;i;
  x = x*(1.5f-(xhalf*x*x));
  return x;
}</code></pre><br>
    ( )   <br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/460/bc7/d55/460bc7d55c4920d2de99f2086fdd06b9.png" alt="image"><br>
<br>
     ,          Quake III Arena  2005 .   -   ,  ,  <a href="http://www.beyond3d.com/content/articles/15/">   </a> â€“  <a href="http://en.wikipedia.org/wiki/Ardent_Computer">Ardent Computer</a>,    80-    .    ,    (  ),    Quake. <br>
        ,                -1  1. <br>
<br>
,   ,     ,  .<br>
<a name="habracut"></a><br>
<h2>?</h2><br>
        ,        ,       ? ,        3D .    3D    .   (  )   ,     ,   ..    . ,    ,  .    (   ) ?        .  , ,      :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/aba/d41/552/abad41552fcd31d1b1886b047aafc24a.png" alt="image"><br>
 <br>
 <img src="https://habrastorage.org/getpro/habr/post_images/ac0/5bb/8b4/ac05bb8b432b392343d3cb6797c929ce.png" alt="image">         .        â€“  .    â€“        â€” FastInvSqrt.<br>
<br>
<h2>  ?</h2><br>
       ?      .       (     float)         i  integer ( ). <br>
<br>
<pre><code class="cpp">int i = *(int*)&amp;x;         //   float    </code></pre><br>
         ,           <br>
<br>
<pre><code class="cpp">i = 0x5f3759df - (i &gt;&gt; 1);  //     ?</code></pre><br>
,       ,   , , .    ,         ,   .  ,     int  float.<br>
<br>
<pre><code class="cpp">x = *(float*)&amp;i;</code></pre><br>
, ,    <a href="http://en.wikipedia.org/wiki/Newton%2527s_method"> </a>   .<br>
<br>
<pre><code class="cpp">x = x*(1.5f-(xhalf*x*x));</code></pre><br>
            .    ( ) â€“   ,      .      â„–2:        ,             int.     .<br>
<br>
<h2>   ?</h2><br>
       <a href="http://en.wikipedia.org/wiki/Single_precision"></a>,         .     ,      (     ).         : ,   .   32-    :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/749/cc6/41e/749cc641eb4d5dafd085e8c23f8826aa.png" alt="image"><br>
<br>
   ,  8    23  .         ,   ,          (    0).<br>
<br>
        ,           .   , ,    (       ).   ,      ,        0  1, ..       0,    â€“     (    ) 1.    ,      8-  ,    (   ),         -127  128.   float-      m.   ,     (, )       (, m) â€“       (float). <br>
<br>
     :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e20/4f6/0da/e204f60da8cd0817a4e780d1bb040767.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b3c/587/908/b3c5879085ad90e7bdb51854803b2375.png" alt="image"><br>
 <br>
    32-  L = 2^23,   = 127.    e  m,      :<br>
 <br>
<img src="https://habrastorage.org/getpro/habr/post_images/1e4/d11/3b3/1e4d113b311c654d1aa11bf6ab69aad9.png" alt="image"><br>
<br>
      :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e7f/4fb/7b4/e7f4fb7b4e0d26ea4fa5f0c87484a881.png" alt="image"><br>
<br>
       ,     â€œâ€   . ,              :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fc5/217/c7e/fc5217c7ea90261a96111ab15890d1e5.png" alt="image"><br>
<br>
  ,    ,    ,      2     :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/2e8/142/d4a/2e8142d4a0691814fa7e1fb989e2c0f9.png" alt="image"><br>
<br>
 ,    ,        ,            :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/e3e/483/0a1/e3e4830a1140ec9e98526d80b71b7fac.png" alt="image"><br>
<br>
   . ,          .  ,      ,       ,    ,    . <br>
        :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7f0/71a/3cb/7f071a3cb749faaa906b062c6573685b.png" alt="image"><br>
<br>
 v     0  1.  ,   v  0  1       :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/230/ec1/a1e/230ec1a1e4f2af4784e816add3307403.png" alt="image"><br>
<br>
    :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/d62/ce4/ee7/d62ce4ee77931f98c5d6ab2f6c29a68e.png" alt="image"><br>
<br>
 Ïƒ â€“  .    ,      Ïƒ  ,     . ,  ,         ,    ,    ,  ,   :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/81e/439/481/81e439481fa38dd0eee19213002c8081.png" alt="image"><br>
<br>
  -!                     :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/802/de1/219/802de1219ff7f298350ffb67675b3051.png" alt="image"><br>
<br>
     (  ),   ,    :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ae8/7c6/387/ae87c6387c6e08b48666c9f2ca86665a.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/52c/844/4ed/52c8444ed66d49d544c7ec05734de8e2.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/7fa/f54/acf/7faf54acfd2548eeb99388992ab54f32.png" alt="image"><br>
<br>
        .   ,         y,     ,     :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/9fc/897/ff2/9fc897ff2e6b16793c55b3e3df569c9c.png" alt="image"><br>
<br>
  : â€œy (  ) â€“         â€.    :<br>
<br>
<pre><code class="cpp">i = K - (i &gt;&gt; 1);</code></pre><br>
         , ?<br>
<br>
    K.     B  L,       Ïƒ. <br>
  , Ïƒ â€“   â€œ â€,               0  1. ..      .    0.0450465,         .  ,  :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/245/b6d/973/245b6d973e775793897d08295d28517e.png" alt="image"><br>
<br>
,   1597463007   HEX? , ,  0x5f3759df. ,     ,    Ïƒ  ,     . <br>
<br>
 ,       (     ,     hex-),    .<br>
 <br>
,    : â€œ    ,    ,   ,    â€.     ,            ,   :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/92f/34d/b69/92f34db69cf09309e4bb98a243babe43.png" alt="image"><br>
<br>
     1  100. , ?     ,  ,     , ,             . <br>
<br>
<h2>     !</h2><br>
           0x5f3759df,      . <br>
<br>
-,     L  B.          ,       .  ,          64-   128-     â€“        . <br>
<br>
-,   -     Ïƒ.     (     â€“  )    x + Ïƒ  . Ïƒ  ,           .      ,   Ïƒ        ,      . <br>
<br>
   -,     â€œ-1/2â€   .    -  ,     (â€œ  â€). ,  ,       -1  1.             ,   â€œ-1/2â€  :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/60b/dde/096/60bdde0967db98dcbbef0cf0ae9c73c8.png" alt="image"><br>
 <br>
  =0.5     ( )   :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/327/8ac/3fe/3278ac3fe4117548e0d07bbd7a3cb043.png" alt="image"><br>
<img src="https://habrastorage.org/getpro/habr/post_images/1b0/722/def/1b0722def05d4e8ed10e8c2f34228e13.png" alt="image"><br>
 <br>
    :<br>
<br>
<pre><code class="cpp">i = 0x1fbd1df5 + (i &gt;&gt; 1);</code></pre><br>
 ,  ? , :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/161/16b/aec/16116baec153f85a3445a22fe1fa2cc3.png" alt="image"><br>
<br>
, ,        ,        . ,  ?<br>
       â€œâ€ ,   :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/3cd/7e0/5c3/3cd7e05c3d16a8f90d7f75c99e5888df.png" alt="image"><br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/ddf/714/c2a/ddf714c2a23d6abe0ca4b77e0ae5c7d0.png" alt="image"><br>
 <br>
    , :<br>
<br>
<pre><code class="cpp">i = (int) (0x2a517d3c + (0.333f * i));</code></pre><br>
 , -  1/3              0.333f.     :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/237/28c/c8f/23728cc8f0790f93860291de889d6a50.png" alt="image"><br>
<br>
<h2>   !</h2><br>
      ,          :     .                ,    .       :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/b60/418/678/b60418678d4b84e48afdaf07d852cf3a.png" alt="image"><br>
<br>
      ,     -1  1:<br>
<br>
<pre><code class="cpp">i = (1 - p) * 0x3f7a3bea + (p * i);</code></pre><br>
  ,       :<br>
<br>
<pre><code class="cpp">i = 0x3f7a3bea + p * (i - 0x3f7a3bea);</code></pre><br>
    â€œâ€ ,           (   -1  1).          ,              ,          .         , ,     (,  ).<br>
<br>
    â€œ â€ 0x3f7a3bea.    (-  )   â€œ â€,     .          .<br>
<br>
      ,  p = 0.      ,     0  .      ?    â€“   0       :<br>
<br>
<pre><code class="cpp">i = 0x3f7a3bea;</code></pre><br>
,    ,    float-,   0.977477 â€“ .. â€œ 1â€.       â€“   .  ,    - .        .         (  â€œ â€)<br>
 .   :<br>
<br>
  C :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/8f8/04f/625/8f804f625d5a14378881ce21f12d1129.png" alt="image"><br>
 <br>
 ,     ,     .   â€“     ,      .    :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/54d/dc1/4e4/54ddc14e43de0edefb16a7e8fcef704f.png" alt="image"><br>
<br>
            .  ,   ,     ,       .  :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/181/499/46d/18149946d0b62fd204ecf880a65c6744.png" alt="image"><br>
 <br>
  :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/75f/f7d/c02/75ff7dc02e9cea442e4fa32953a9852b.png" alt="image"><br>
<br>
, ,     :<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/1cb/c9a/34a/1cbc9a34acef9e94c7e349ffb35ece89.png" alt="image"><br>
 <br>
 ,    Ïƒ (    0.0450465)  2     ,       0.97747675,  ,  â€œ 1â€.              :<br>
 <br>
<pre><code class="cpp">float sigma = 0.0450465;
float c_sigma = 1 - (0.5f * sigma);
int C_sigma = *(*int)&amp;c_sigma;</code></pre><br>
,    Ïƒ             .   0x3f7a3beb,    0x3f7a3bea   ,       1  ( ).         (   ) ,      1.5.<br>
<br>
        ,         â€œâ€, â€œâ€, â€œâ€, â€œâ€    ,     ,     .           ,   float  int           â€“       â€œâ€,      . , , ,         . ,  ,          â€“  .</div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336110/">https://habr.com/ru/post/336110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336098/index.html">Dive into BerkeleyDB JE. Introduction to DPL API</a></li>
<li><a href="../336100/index.html">Notation Oh-big and complexity of social interactions</a></li>
<li><a href="../336102/index.html">Bitcoin Cash. Was there a fork?</a></li>
<li><a href="../336104/index.html">Load testing of Web-systems. We finish the training</a></li>
<li><a href="../336106/index.html">Do not compile it: a live preview for the Lokalise SDK, so that you can check on the fly on the button</a></li>
<li><a href="../336112/index.html">DsPlus - project evaluation before ICO</a></li>
<li><a href="../336114/index.html">XBRL: just about the complex - Chapter 6. Immersion in XBRL - Part 3. Calculations and validation</a></li>
<li><a href="../336116/index.html">Next steps in black magic processor after you've mastered Harris & Harris</a></li>
<li><a href="../336118/index.html">Helm secrets - the missing part of Kubernetes</a></li>
<li><a href="../336120/index.html">Scheduling tasks in Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>