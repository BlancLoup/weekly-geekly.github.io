<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Spy Camera on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! Today I want to share the experience of developing a single Android application and the difficulties that I had to face when using the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Spy Camera on Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/56c/8e8/869/56c8e88699afd0f6de77284d7a8024cb.jpg" align="right">  Hi% username%!  Today I want to share the experience of developing a single Android application and the difficulties that I had to face when using the camera in a not quite fair way. <br>  The idea of ‚Äã‚Äãthe ‚ÄúGuardian‚Äù application lived within the development department for a long time, but the first implementation appeared on the Symbian platform 2 years ago.  The very idea is simple - to take photos of the person who took the phone in his hands.  In the first implementation, the application was divided into signal modules and callback modules.  Signal modules were responsible for recording changes in a certain state of the phone.  For example: removing or installing a SIM or memory card, incoming or outgoing call, or very tricky - the main sensor was the accelerometer sensor, which detected the moment when the phone was lifted from the table.  Callback modules are actions that are performed by sensor signals.  Were implemented photography and sound recording. <br>  When porting the application to the Android platform, the approach has changed noticeably.  And in general, only the idea remained from the old application, it ceased to be modular, and of all the functionality, only the photographing functionality remained.  I want to tell about the implementation of this functionality. <br><a name="habracut"></a><br><h4>  Make a photo </h4><br>  First I will give a free translation of official documentation concerning the issue of using the camera. <br><ul><li>  For photos in Android meets the class <a href="http://developer.android.com/reference/android/hardware/Camera.html">Camera</a> . </li></ul><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.CAMERA"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.camera"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.camera.autofocus"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  To get the picture you need: <br><ol><li>  Find the Id of the desired camera using the <a href="http://developer.android.com/reference/android/hardware/Camera.html">getNumberOfCameras</a> and <a href="http://developer.android.com/reference/android/hardware/Camera.html">getCameraInfo methods</a> ); </li><li>  Get a link to the camera object using the <a href="http://developer.android.com/reference/android/hardware/Camera.html">open</a> method. </li><li>  Get the current (default) settings by the <a href="http://developer.android.com/reference/android/hardware/Camera.html">getParameters</a> method. </li><li>  If necessary, change the parameters and set them again with the <a href="http://developer.android.com/reference/android/hardware/Camera.html">setParameters</a> method; </li><li>  If necessary, set the camera orientation using the <a href="http://developer.android.com/reference/android/hardware/Camera.html">setDisplayOrientation</a> method (NO vertical video!); </li><li>  <b>IMPORTANT:</b> Pass a properly initialized <a href="http://developer.android.com/reference/android/view/SurfaceHolder.html">SurfaceHolder</a> object to the <a href="http://developer.android.com/reference/android/view/SurfaceHolder.html">setPreviewDisplay method</a> .  If this is not done, the camera will not be able to start the preview. </li><li>  <b>IMPORTANT:</b> Call the <a href="http://developer.android.com/reference/android/hardware/Camera.html">startPreview</a> method), which will begin to update SurfaceHolder.  You <b>MUST</b> begin a preview before taking a photo. </li><li>  Finally call the <a href="http://developer.android.com/reference/android/hardware/Camera.html">takePicture</a> method and wait for the data to return to <a href="http://developer.android.com/reference/android/hardware/Camera.PictureCallback.html">onPictureTaken</a> ; </li><li>  After calling the takePicture method, the preview will be stopped.  If you need to take another photo, you will have to call startPreview again; </li><li>  If the camera is no longer needed, you must first stop the preview with the stopPreview method; </li><li>  <b>IMPORTANT:</b> Call the release () method to free up camera resources for other applications.  The application should immediately release camera resources in the <a href="http://developer.android.com/reference/android/app/Activity.html">onPause</a> method (and get them back in the <a href="http://developer.android.com/reference/android/app/Activity.html">onResume</a> method). </li></ol><br>  This class is not thread safe.  Most operations (preview, focus, photo taking) are asynchronous and return the result via callbacks that will be called on the same thread as the open method.  In no case should methods of this class be called from multiple threads at once. <br>  <b>Warning:</b> Different devices on the Android OS may have different camera capabilities (for example, resolution, autofocus capability, etc.). <br><br>  Here the translation ends and the fun begins. <br>  From all of the above, the following problems are striking: <br><ol><li>  It is necessary to show a preview. </li><li>  On different devices, the camera can work in different ways. </li></ol><br>  With them, we will fight. <br>  When a problem arises from the category ‚Äúit is written in the docks that it is impossible to do this,‚Äù the first thing to look at is the source code.  It became clear from them that the drawing of the preview was brought up to the level of the native code setPreviewDisplay (Surface).  An attempt was made to quickly understand how the system at all determines whether we started the preview or not.  It was not possible to quickly get through the thorns of C ++ code, so I took the path of least resistance - I created a preview, but displayed it imperceptibly for the user.  If you search for stackoverflow, then you can find another way - to transfer to SurfaceHolder created by setPreviewDisplay dynamically.  And since the object is not added to the Activity markup, it will not be displayed.  Unfortunately, this method only works for older versions of Android (up to 3.0, if I'm not mistaken).  In new versions, the developers have corrected this misunderstanding. <br>  Thus, we come to the only conclusion - we must somehow display the previews on the screen, the question now is whether it can be done imperceptibly?  Fortunately, the answer is ‚Äúyes you can.‚Äù  And this is what is needed for this: <br><ol><li>  Transparent Activity. </li><li>  FrameLayout size of 1 to 1 pixel in the upper left corner of our Activity. </li></ol><br>  Transparent Activity is done by one line of the manifest, for this we define it as follows: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">activity</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".activities.CameraActivity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:launchMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleTask"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:excludeFromRecents</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:theme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@android:style/Theme.Translucent.NoTitleBar"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  and create the following simple markup for it: <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FrameLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/surfaceHolder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0px"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  A SurfaceHolder object is created and added to the markup dynamically.  In principle, it was possible to add it immediately to the markup, this moment was rendered into the code so as not to go into the markup if necessary to redefine the behavior of the object. <br>  So, transparent Activity is, we create SurfaceHolder dynamically, what next?  Then the main thing is to initialize the camera and take a photo.  The idea here is to take a photo immediately at the start of the Activity and close it as soon as possible.  We define our Activity as follows: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CameraActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Camera</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PictureCallback</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SurfaceHolder</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Callback</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> NO_FRONT_CAMERA = -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Camera mCamera; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> mPreviewIsRunning = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> mIsTakingPicture = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CameraPreview</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SurfaceView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CameraPreview</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } } ...</code> </pre><br><br>  Thus, events from SurfaceHolder (surfaceCreated, surfaceChanged, surfaceDestroyed) and Camera (onPictureTaken) will pour into it.  The internal CameraPreview class is needed solely so that, as I noted above, quickly and painlessly make changes to the behavior of our SurfaceView if necessary.  The following is a bunch of methods Activity 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Some code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.surface_holder); SurfaceView surfaceView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CameraPreview(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); ((FrameLayout) findViewById(R.id.surfaceHolder)).addView(surfaceView); SurfaceHolder holder = surfaceView.getHolder(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB) holder.setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS); holder.addCallback(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResume</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ startPreview(); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onResume(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ stopPreview(); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onPause(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">surfaceCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SurfaceHolder surfaceHolder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cameraId = getFrontCameraId(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cameraId != NO_FRONT_CAMERA) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mCamera = Camera.open(cameraId); Camera.Parameters parameters = mCamera.getParameters(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getResources().getConfiguration().orientation == Configuration.ORIENTATION_PORTRAIT) parameters.setRotation(<span class="hljs-number"><span class="hljs-number">270</span></span>); List&lt;String&gt; flashModes = parameters.getSupportedFlashModes(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flashModes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; flashModes.contains(Camera.Parameters.FLASH_MODE_OFF)) parameters.setFlashMode(Camera.Parameters.FLASH_MODE_OFF); List&lt;String&gt; whiteBalance = parameters.getSupportedWhiteBalance(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (whiteBalance != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; whiteBalance.contains(Camera.Parameters.WHITE_BALANCE_AUTO)) parameters.setWhiteBalance(Camera.Parameters.WHITE_BALANCE_AUTO); List&lt;String&gt; focusModes = parameters.getSupportedFocusModes(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (focusModes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; focusModes.contains(Camera.Parameters.FOCUS_MODE_AUTO)) parameters.setFocusMode(Camera.Parameters.FOCUS_MODE_AUTO); List&lt;Camera.Size&gt; sizes = parameters.getSupportedPictureSizes(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sizes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; sizes.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Camera.Size size = sizes.get(<span class="hljs-number"><span class="hljs-number">0</span></span>); parameters.setPictureSize(size.width, size.height); } List&lt;Camera.Size&gt; previewSizes = parameters.getSupportedPreviewSizes(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (previewSizes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { Camera.Size previewSize = previewSizes.get(previewSizes.size() - <span class="hljs-number"><span class="hljs-number">1</span></span>); parameters.setPreviewSize(previewSize.width, previewSize.height); } mCamera.setParameters(parameters); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) mCamera.enableShutterSound(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException e) { A.handleException(e, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); finish(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Log.e(Value.LOG_TAG, <span class="hljs-string"><span class="hljs-string">"Could not find front-facing camera"</span></span>); finish(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { mCamera.setPreviewDisplay(surfaceHolder); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException ioe) { A.handleException(ioe, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); finish(); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">surfaceChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SurfaceHolder surfaceHolder, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> format, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height)</span></span></span><span class="hljs-function"> </span></span>{ startPreview(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">surfaceDestroyed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SurfaceHolder surfaceHolder)</span></span></span><span class="hljs-function"> </span></span>{ releaseCamera(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPictureTaken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] bytes, Camera camera)</span></span></span><span class="hljs-function"> </span></span>{ mIsTakingPicture = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; releaseCamera(); <span class="hljs-comment"><span class="hljs-comment">//noinspection PrimitiveArrayArgumentToVariableArgMethod new SaveImageTask().execute(bytes); finish(); } private int getFrontCameraId() { final int numberOfCameras = Camera.getNumberOfCameras(); for (int i = 0; i &lt; numberOfCameras; i++) { Camera.CameraInfo info = new Camera.CameraInfo(); Camera.getCameraInfo(i, info); if (info.facing == Camera.CameraInfo.CAMERA_FACING_FRONT) return i; } return NO_FRONT_CAMERA; } private void startPreview() { if (!mPreviewIsRunning &amp;&amp; mCamera != null) { try { mCamera.startPreview(); mCamera.autoFocus(new Camera.AutoFocusCallback() { @Override public void onAutoFocus(boolean b, Camera camera) { if (!mIsTakingPicture) { try { mIsTakingPicture = true; mCamera.setPreviewCallback(null); mCamera.takePicture(null, null, CameraActivity.this); } catch (RuntimeException e) { A.handleException(e, true); finish(); } } } }); mPreviewIsRunning = true; } catch (Exception e) { A.handleException(e, true); finish(); } } } private void stopPreview() { if (!mIsTakingPicture &amp;&amp; mPreviewIsRunning &amp;&amp; mCamera != null) { mCamera.stopPreview(); mPreviewIsRunning = false; } } private void releaseCamera() { if (mCamera != null) { mCamera.setPreviewCallback(null); mCamera.stopPreview(); mCamera.release(); mCamera = null; } }</span></span></code> </pre><br></div></div><br>  What is interesting about this code?  Sign for the points. <br><ol><li>  The most important thing is the procedure for calling methods.  The documentation states that you need to call and in what order, but does not specify when.  For example, the setPreviewDisplay method.  If you initialize the camera and call this method immediately in onCreate or in onResume, the photo will not work.  Then how to know when to call this method?  The correct answer is from the comments to the <a href="">setPreviewDisplay</a> method in the source code.  Here is a short excerpt from there: <br><blockquote>  The android.view.SurfaceHolder must already contain this surface when this method is called.  If you are usingandroid.view.SurfaceView, android.view.SurfaceHolder.Callback withandroid.view.SurfaceHolder.addCallback (android.view.SurfaceHolder.Callback) android.view.SurfaceHolder) before calling setPreviewDisplay () or starting preview. <br>  This method must be called before startPreview (). <br></blockquote></li><li>  The second point is related to the life cycle of the SurfaceHolder object relative to the Activity.  The life cycle of the Activity can be found in the documentation, but with SurfaceHolder, everything is not clear, so I had to figure it out empirically: <br><br><pre> onCreate (Bundle savedInstanceState)
 onResume ()
 onPause ()
 surfaceCreated (SurfaceHolder surfaceHolder)
 surfaceChanged (SurfaceHolder surfaceHolder, int format, int width, int height)
 onStop ()
 surfaceDestroyed (SurfaceHolder surfaceHolder)
</pre><br></li><li>  The next interesting point is related to the order of calls to the Life cycle methods of the Activity.  You may ask: ‚ÄúWhy are all these checks in the spirit of if (mCamera! = Null) and the variables mPreviewIsRunning, mIsTakingPicture?‚Äù.  Unfortunately, the only answer I can give in this case is that.  And the point is that in some situations, the order of calls to the methods of the life cycle of an Activity may differ from that specified in the official docks (from this diagram, <a href="">for example</a> ).  Most incidents occur when the screen lock is enabled on the phone.  I had cases when the onStop method was called twice in a row, and after that, bypassing onStart, as if nothing had happened, onResume was called.  In this case, the order of calling methods may differ on different devices, even despite the same version of Android on board.  I have long tried to figure it out, to understand why this is happening.  As a result, I just spent a lot of time on it and wrote the current implementation. </li></ol><br>  So, it is time to summarize what is happening.  Here is what happens in the application: <br><ol><li>  We start the Activity on the desired event (in my case - to turn on the screen). </li><li>  In onCreate, we create a SurfaceHolder and register an Activity to get callbacks. </li><li>  We are waiting for the surfaceCreated call and initialize the camera in it. </li><li>  After the camera is initialized, try to call takePicture.  Since the order of calling methods strongly depends on the device, the OS version and the type of screen lock, we try using the onResume |  surfaceChanged start a preview, and onPause stop it.  At the same time onResume |  onPause can happen both before and after surfaceCreated, so everywhere we check the camera for "initialization". </li><li>  The surfaceChanged method, according to the documentation, is guaranteed to be called at least once after the surfaceCreated, but theoretically it can be called as many times as necessary in the process of obtaining a photo.  We add the mPreviewIsRunning variable in order not to accidentally start the preview several times.  We start the preview, call takePicture, wait. </li><li>  We catch a photo in onPictureTaken.  We release the camera, create AsyncTask to save the image, close the Activity. </li></ol><br>  Thus, the general order of calls is as follows: <br><br><pre> onCreate (Bundle savedInstanceState)
 onResume ()
 onPause ()
 surfaceCreated (SurfaceHolder surfaceHolder)
 surfaceChanged (SurfaceHolder surfaceHolder, int format, int width, int height)
 onPictureTaken (byte [] bytes, Camera camera)
 onStop ()
 surfaceDestroyed (SurfaceHolder surfaceHolder)
</pre><br><h4>  Conclusion </h4><br>  The application works and stably makes pictures on my phone (Nexus 4).  In addition, he tested on other models, including the Motorola Droid RAZR and HTC Sensation.  As I mentioned above, cameras work differently on different phones.  On some phones, when you take a photo, you hear a shutter sound.  On others, the photo is turned in the wrong direction and this is corrected only by editing EXIF.  On some phones, and at all (I suppose, due to the peculiarities of the shell), the order of calling methods of the life cycle of an Activity may differ markedly.  All this is connected not only with a huge number of device manufacturers on Android, but also with an incredible fragmentation of the OS itself (an interesting note on this subject can be found on page 57 of 1 of the Hacker magazine for 2014).  Therefore, I would very much like to: <br><ol><li>  Add profiles for different phone models and take a photo with this profile.  For example, for phones that produce a shutter sound when photographing, add a mute immediately before the photograph. </li><li>  Thoroughly drive the application on a large set of test models and try to understand the reason for the difference in the call of the Activity methods. </li><li>  Dig deeper into the source code of Android.  Finally, climb into the native part and figure out why takePicture can only be called after initializing the preview.  Think how else you can deal with it. </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/c61/00c/ca1/c6100cca145aee13cf3dbbdb9af45816.jpg" align="right"><br>  This is all a matter of development in the near future. <br>  Now the application is available on Google.Play in the current version.  It is free, because the main goal in its creation was to explore the depths of Android.  For those interested in the <b><a href="https://play.google.com/store/apps/details%3Fid%3Dcom.vulkan.guardian">link to google.play</a></b> . <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/215693/">https://habr.com/ru/post/215693/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215683/index.html">Sketch.app site design. Part 2.1: we suggest beauty</a></li>
<li><a href="../215685/index.html">Configuring Digium Phones via DPMA Module in Elastix</a></li>
<li><a href="../215687/index.html">How to handle IA-32 code or Simics decoder features</a></li>
<li><a href="../215689/index.html">When the uninterruptible power supply system may cause an interruption or a ‚ÄúStory of several accidents‚Äù</a></li>
<li><a href="../215691/index.html">Automation of test infrastructure in the Search</a></li>
<li><a href="../215695/index.html">Browser 3D game with native Mozilla performance</a></li>
<li><a href="../215697/index.html">Localization of console games: between the controller and gamepad</a></li>
<li><a href="../215701/index.html">The logic of thinking. Part 11. Dynamic neural networks. Associativity</a></li>
<li><a href="../215703/index.html">Free seminar "Building fault-tolerant systems and the development of large projects"</a></li>
<li><a href="../215747/index.html">Building a business with Acronis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>