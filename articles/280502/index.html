<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Open vSwitch with DPDK to transfer data between virtual machines with virtualization of network functions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Data Plane Development Kit (DPDK) provides high-performance packet processing libraries and user-space drivers. Starting with Open vSwitch (OVS) v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Open vSwitch with DPDK to transfer data between virtual machines with virtualization of network functions</h1><div class="post__text post__text-html js-mediator-article">  The Data Plane Development Kit (DPDK) provides high-performance packet processing libraries and user-space drivers.  Starting with <a href="">Open vSwitch (OVS) version 2.4,</a> we have the opportunity to use the vHost optimized with DPDK path in OVS.  DPDK support was available from OVS version 2.2. <br><br>  The use of DPDK in OVS provides significant advantages in terms of performance.  As in other applications using DPDK, network bandwidth (the number of transmitted network packets) increases dramatically, with a significant reduction in delays.  In addition, the performance of some of the most important OVS segments has been optimized using the DPDK packet processing libraries. <br><br>  In this document, we will look at configuring OVS with DPDK for use between virtual machines.  Each port will be connected to a separate virtual machine.  Then we run a simple iperf3 bandwidth test and compare the performance with the operation of the OVS configuration without DPDK, in order to evaluate what advantages we get in OVS with DPDK. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/e47/305/047/e473050476014998a5fc6beb4a0e5a65.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Open vSwitch can be installed using standard package installers on common Linux * distributions.  DPDK support is not enabled by default, so before proceeding, you need to build an Open vSwitch with DPDK. <br><br>  Detailed instructions for installing and using OVS with DPDK can be found <a href="">here</a> .  In this document, we will look at the main steps and, in particular, the scenario of using custom DPDK vhost-user ports. <br><br><h1>  <font color="#0071c5">Requirements for OVS and DPDK</font> </h1><br>  Before compiling DPDK and OVS, make sure that all <a href="http://dpdk.org/doc/guides/linux_gsg/sys_reqs.html">necessary requirements are met</a> . <br><br>  Software development packages in standard Linux distributions usually meet most of these requirements.  For example, on yum (or dnf based) distributions, you can use the following command to install: <br><br><pre><code class="bash hljs">yum install <span class="hljs-string"><span class="hljs-string">"@Development Tools"</span></span> automake tunctl kernel-tools <span class="hljs-string"><span class="hljs-string">"@Virtualization Platform"</span></span> <span class="hljs-string"><span class="hljs-string">"@Virtualization"</span></span> pciutils hwloc numactl</code> </pre> <br>  In addition, make sure that the qemu component of version v2.2.0 or later is installed on the system as <a href="">described</a> in the <a href="">DPDK vhost-user Prerequisites</a> document. <br><br><h1>  <font color="#0071c5">Build the target DPDK environment for OVS</font> </h1><br>  To build OVS with DPDK, you need to download the source DPDK code and prepare the destination environment.  For more information about using DPDK, see <a href="http://www.dpdk.org/doc/guides/linux_gsg/index.html">here</a> .  The main actions are shown in the following code snippet: <br><br><pre> <code class="bash hljs">curl -O http://dpdk.org/browse/dpdk/snapshot/dpdk-2.1.0.tar.gz tar -xvzf dpdk-2.1.0.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> dpdk-2.1.0 <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> DPDK_DIR=`<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>` sed <span class="hljs-string"><span class="hljs-string">'s/CONFIG_RTE_BUILD_COMBINE_LIBS=n/CONFIG_RTE_BUILD_COMBINE_LIBS=y/'</span></span> -i config/common_linuxapp make install T=x86_64-ivshmem-linuxapp-gcc <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> x86_64-ivshmem-linuxapp-gcc EXTRA_CFLAGS=<span class="hljs-string"><span class="hljs-string">"-g -Ofast"</span></span> make -j10</code> </pre><br><h1>  <font color="#0071c5">Build OVS with DPDK</font> </h1><br>  If you have a DPDK destination environment assembled, you can download the latest OVS source code and build with DPDK support enabled.  Standard documentation for building OVS with DPDK is available <a href="">at</a> .  Here we consider only the basic steps. <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/openvswitch/ovs.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ovs <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> OVS_DIR=`<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>` ./boot.sh ./configure --with-dpdk=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DPDK_DIR</span></span></span><span class="hljs-string">/x86_64-ivshmem-linuxapp-gcc/"</span></span> CFLAGS=<span class="hljs-string"><span class="hljs-string">"-g -Ofast"</span></span> make <span class="hljs-string"><span class="hljs-string">'CFLAGS=-g -Ofast -march=native'</span></span> -j10</code> </pre><br>  So, we have a fully assembled OVS with DPDK support enabled.  All standard OVS utilities are located in the $ OVS_DIR / utilities / folder, and the OVS database is located in the $ OVS_DIR / ovsdb / folder.  We use these utilities for further action. <br><br><h1>  <font color="#0071c5">Creating the OVS database and starting the ovsdb-server</font> </h1><br>  Before starting the main OVS process ‚Äúovs-vswitchd‚Äù, you need to initialize the OVS database and start the ovsdb-server.  The following commands show how to clean up and create a new OVS database and an ovsdb_server instance. <br><br><pre> <code class="bash hljs">pkill -9 ovs rm -rf /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/var/run/openvswitch rm -rf /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/openvswitch/ rm -f /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/openvswitch/conf.db mkdir -p /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/openvswitch mkdir -p /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/var/run/openvswitch <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$OVS_DIR</span></span> ./ovsdb/ovsdb-tool create /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/openvswitch/conf.db ./vswitchd/vswitch.ovsschema ./ovsdb/ovsdb-server --remote=punix:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/var/run/openvswitch/db.sock --remote=db:Open_vSwitch,Open_vSwitch,manager_options --pidfile --detach ./utilities/ovs-vsctl --no-wait init</code> </pre><br><h1>  <font color="#0071c5">Configure the host and network adapters to use OVS with DPDK</font> </h1><br>  DPDK requires the host operating system to support ultra-large memory pages, and polled mode (PMD) DPDK user-space drivers must be enabled for network adapters. <br>  To enable extra large memory pages and use the VFIO user-space driver, add the following parameters in GRUB_CMDLINE_LINUX to / etc / default / grub, then run the grub update and reboot the system: <br><br><pre> <code class="bash hljs">default_hugepagesz=1G hugepagesz=1G hugepages=16 hugepagesz=2M hugepages=2048 iommu=pt intel_iommu=on isolcpus=1-13,15-27 grub2-mkconfig -o /boot/grub2/grub.cfg reboot</code> </pre><br>  Depending on the amount of available memory in the system, you can configure the number and type of extra-large pages.  The isolcpus option allows you to isolate certain CPUs from the Linux scheduler, so they can be ‚Äúpinned down‚Äù by DPDK based applications. <br>  After rebooting the system, check the kernel command line and the selected extra-large pages, as shown below. <br><br><img src="https://habrastorage.org/files/d59/c15/0b2/d59c150b228144afb11df00e2a1ba1af.png"><br><br>  Now you need to connect the file system of extra large pages and load the vfio-pci user space driver. <br><pre> <code class="bash hljs">mkdir -p /mnt/huge mkdir -p /mnt/huge_2mb mount -t hugetlbfs hugetlbfs /mnt/huge mount -t hugetlbfs none /mnt/huge_2mb -o pagesize=2MB modprobe vfio-pci cp <span class="hljs-variable"><span class="hljs-variable">$DPDK_DIR</span></span>/tools/dpdk_nic_bind.py /usr/bin/. dpdk_nic_bind.py --status dpdk_nic_bind.py --<span class="hljs-built_in"><span class="hljs-built_in">bind</span></span>=vfio-pci 05:00.1</code> </pre><br>  The following screen capture shows sample output for the above commands. <br><br><img src="https://habrastorage.org/files/8ba/3eb/d31/8ba3ebd317e1449c993d1b8cd5877006.png"><br><br>  If the intended use case only concerns data transfer between virtual machines and physical network adapters are not used, then you can skip the above steps for vfio-pci. <br><br><h1>  <font color="#0071c5">Run ovs-vswitchd</font> </h1><br>  So, the OVS database is configured, the host is configured to use OVS with DPDK.  Now you should start the main process ovs-vswitchd. <br><br><pre> <code class="bash hljs">modprobe openvswitch <span class="hljs-variable"><span class="hljs-variable">$OVS_DIR</span></span>/vswitchd/ovs-vswitchd --dpdk -c 0x2 -n 4 --socket-mem 2048 -- unix:/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/var/run/openvswitch/db.sock --pidfile --detach</code> </pre><br><h1>  <font color="#0071c5">Creating a bridge and DPDK vhost-user ports for use between virtual machines</font> </h1><br>  In our test sample, we will create a bridge and add two DPDK vhost-user ports.  If desired, you can add the physical network adapter vfio-pci, which we configured earlier. <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$OVS_DIR</span></span>/utilities/ovs-vsctl show <span class="hljs-variable"><span class="hljs-variable">$OVS_DIR</span></span>/utilities/ovs-vsctl add-br br0 -- <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> bridge br0 datapath_type=netdev <span class="hljs-variable"><span class="hljs-variable">$OVS_DIR</span></span>/utilities/ovs-vsctl add-port br0 dpdk0 -- <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Interface dpdk0 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=dpdk <span class="hljs-variable"><span class="hljs-variable">$OVS_DIR</span></span>/utilities/ovs-vsctl add-port br0 vhost-user1 -- <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Interface vhost-user1 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=dpdkvhostuser <span class="hljs-variable"><span class="hljs-variable">$OVS_DIR</span></span>/utilities/ovs-vsctl add-port br0 vhost-user2 -- <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Interface vhost-user2 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=dpdkvhostuser</code> </pre><br>  The following screen capture shows the final OVS configuration. <br><br><img src="https://habrastorage.org/files/6e9/be3/242/6e9be32422514f03a51c21c2b5ff6cb8.png"><br><br><h1>  <font color="#0071c5">Using DPDK vhost-user ports with virtual machines</font> </h1><br>  The description of creating virtual machines is beyond the scope of this document.  After we have two virtual machines (for example, f21vm1.qcow2 and f21vm2.qcow2), the following commands will show how to use the previously created DPDK vhost-user ports. <br><br><pre> <code class="bash hljs">qemu-system-x86_64 -m 1024 -smp 4 -cpu host -hda ~/f21vm1.qcow2 -boot c -<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-kvm -no-reboot -nographic -net none \ -chardev socket,id=char1,path=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/var/run/openvswitch/vhost-user1 \ -netdev <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=vhost-user,id=mynet1,chardev=char1,vhostforce \ -device virtio-net-pci,mac=00:00:00:00:00:01,netdev=mynet1 \ -object memory-backend-file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on \ -numa node,memdev=mem -mem-prealloc qemu-system-x86_64 -m 1024 -smp 4 -cpu host -hda ~/f21vm2.qcow2 -boot c -<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-kvm -no-reboot -nographic -net none \ -chardev socket,id=char1,path=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/var/run/openvswitch/vhost-user2 \ -netdev <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=vhost-user,id=mynet1,chardev=char1,vhostforce \ -device virtio-net-pci,mac=00:00:00:00:00:02,netdev=mynet1 \ -object memory-backend-file,id=mem,size=1024M,mem-path=/dev/hugepages,share=on \ -numa node,memdev=mem -mem-prealloc</code> </pre><br><h1>  <font color="#0071c5">A simple DPDK vhost-user performance test between virtual machines using iperf3</font> </h1><br>  Log on to virtual machines and configure static IP addresses for the network adapters on the same subnet.  Install iperf3 and run a simple network test. <br>  On one virtual machine, run iperf3 in server mode iperf3 -s and start the iperf3 client.  An example of the result is shown in the following screen shot. <br><br><img src="https://habrastorage.org/files/509/a15/534/509a155346394926b883ef9aa9c56f44.png"><br><br><h1>  <font color="#0071c5">Repeat performance test for standard OVS assembly (without DPDK)</font> </h1><br>  In the previous sections, we created and used the OVS-DPDK assembly directly in the $ OVS_DIR folder, without installing it into the system.  To repeat the test for the standard OVS assembly (without DPDK), you can simply install using standard distribution installers.  For example, on systems based on yum (or based on dnf), you can use the following command to install: <br><br><pre> <code class="bash hljs">pkill -9 ovs yum install openvswitch rm -f /etc/openvswitch/conf.db mkdir -p /var/run/openvswitch ovsdb-tool create /etc/openvswitch/conf.db /usr/share/openvswitch/vswitch.ovsschema ovsdb-server --remote=punix:/var/run/openvswitch/db.sock --remote=db:Open_vSwitch,Open_vSwitch,manager_options --pidfile --detach ovs-vsctl --no-wait init ovs-vswitchd unix:/var/run/openvswitch/db.sock --pidfile --detach ovs-vsctl add-br br0 ovs-vsctl show</code> </pre><br>  At this stage, we have a configured fresh OVS database and a running ovs-vswitchd process without DPDK. <br>  For <a href="http://openvswitch.org/support/dist-docs-2.4/INSTALL.KVM.md.txt">instructions</a> on setting up two virtual machines with listening devices for an OVS bridge without DPDK (br0), see the <a href="http://openvswitch.org/support/dist-docs-2.4/INSTALL.KVM.md.txt">instructions</a> .  Then start the virtual machines using the same images that we used before, for example: <br><br><pre> <code class="bash hljs">qemu-system-x86_64 -m 512 -smp 4 -cpu host -hda ~/f21vm1c1.qcow2 -boot c -<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-kvm -no-reboot -nographic -net nic,macaddr=00:11:22:EE:EE:EE -net tap,script=/etc/ovs-ifup,downscript=/etc/ovs-ifdown qemu-system-x86_64 -m 512 -smp 4 -cpu host -hda ~/f21vm1c2.qcow2 -boot c -<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-kvm -no-reboot -nographic -net nic,macaddr=00:11:23:EE:EE:EE -net tap,script=/etc/ovs-ifup,downscript=/etc/ovs-ifdown</code> </pre><br>  Repeat the simple iperf3 performance test that we performed earlier.  Below is an example of the results;  actual results on your system may vary depending on its configuration. <br><br><img src="https://habrastorage.org/files/2c2/633/a10/2c2633a10824471b989f40f65f5c8e47.png"><br><br>  As can be seen in the figure above, when using OVS with DPDK, there is a significant performance increase.  Both performance tests were performed on the same system, the only difference was that in one case the standard OVS assembly was used, and in the other case OVS with DPDK was used. <br><br><h1>  <font color="#0071c5">Conclusion</font> </h1><br>  Open vSwitch version 2.4 supports DPDK, which means a very significant performance boost.  In this article, we showed how to build and use OVS with DPDK.  We looked at setting up a simple OVS bridge with DPDK vhost-user ports for use between virtual machines.  We demonstrated improved performance with the iperf3 test by comparing OVS with DPDK and without DPDK. </div><p>Source: <a href="https://habr.com/ru/post/280502/">https://habr.com/ru/post/280502/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280492/index.html">Xubuntu: I propose to vote for the inclusion of a dark visual theme in the distribution</a></li>
<li><a href="../280494/index.html">Cloud Digest # 3: Data Storage, Security and WordPress</a></li>
<li><a href="../280496/index.html">As I wrote skad. Part Seven</a></li>
<li><a href="../280498/index.html">How to wind the counter Google Analytics or Google hates Kazakhstan</a></li>
<li><a href="../280500/index.html">Predicting attendance of ads by content</a></li>
<li><a href="../280504/index.html">Hosting for a dollar</a></li>
<li><a href="../280506/index.html">Don't miss the online Build conference opening tonight (18:30 MCK)</a></li>
<li><a href="../280508/index.html">DevOps section at the DUMP-2016 conference</a></li>
<li><a href="../280510/index.html">What should be the email-list, and why users unsubscribe from them</a></li>
<li><a href="../280512/index.html">Symfony and command bus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>