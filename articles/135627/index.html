<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XMPP-SMS gateway on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The reason for writing this article was the need to create a program for the Android system, with which you can send order data in the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XMPP-SMS gateway on Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/c2f/383/43f/c2f38343fa4bca52d53fd5d58428e6c5.jpg"><br><br><h5>  Introduction </h5><br>  The reason for writing this article was the need to create a program for the Android system, with which you can send order data in the form of SMS messages to the owners of online stores that an order of goods or services was ordered.  Previously, I used a system including a <a href="http://gprs-modem.ru/TELEOFIS_RX101_USB_GPRS.htm">GSM modem</a> and a program written in C ++, using <a href="http://ru.wikipedia.org/wiki/AT-%25D0%25BA%25D0%25BE%25D0%25BC%25D0%25B0%25D0%25BD%25D0%25B4%25D1%258B">AT commands</a> to communicate with the modem and the <a href="http://camaya.net/gloox/">gloox</a> library to receive messages using the XMPP protocol, on the side of the website used the <a href="http://code.google.com/p/xmpphp/">xmpphp</a> library to send order data.  With such a scheme, it was necessary to keep the computer on all the time, since the order-taking system worked around the clock, respectively, hence the additional power consumption, the noise from the fans at night, and the constant monitoring of the Internet connection. <br><a name="habracut"></a><br>  The main task of the program, which we will create throughout the article, is to receive a message of a certain format using the <a href="http://ru.wikipedia.org/wiki/XMPP">XMPP protocol</a> and then transmit the received data via SMS.  The development <a href="http://www.eclipse.org/">environment</a> will be <a href="http://www.eclipse.org/">Eclipse</a> with the <a href="http://developer.android.com/sdk/eclipse-adt.html">ADT</a> plugin installed and the required <a href="http://developer.android.com/sdk/index.html">SDKs</a> .  <a href="http://code.google.com/p/asmack/">SMACK for Android devices</a> will be used for XMPP <a href="http://code.google.com/p/asmack/">communication</a> . <br><br><h5>  1. Sending SMS </h5><br>  First, we will create the framework of our application, which we will build up with the necessary functionality in the future.  To do this, create in Eclipse, Android Project (Ctrl + N - Android - Android Project) with the following data: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/a9a/275/53d/a9a27553d2352dcc58ee1516c1c5abda.jpg"><br><br>  After creating a new project, we will add the necessary permission (Permission) in the AndroidManifest.xml file for the ability to send SMS messages.  To do this, in the Eclipse development environment, open the AndroidManifest.xml file, go to the Permissions tab, click the ‚ÄúAdd ...‚Äù button, select the ‚ÄúUses Permission‚Äù option in the window that appears, click the ‚ÄúOK‚Äù button, then choose the permission option, find and select from the list select the <b>android.permission.SEND_SMS</b> item, save our actions.  After all the manipulations, the Permissions tab will look like this: <br><br><img src="https://habrastorage.org/storage2/b09/402/bc0/b09402bc0157ce4763163ea585090984.jpg"><br><br>  Now, for example, consider the easiest way to send an SMS message, which you can test in a regular Android emulator.  To do this, create two new virtual devices using Android Virtual Device Manager (Window - AVD Manager) with the following parameters: <br><br><img src="https://habrastorage.org/storage2/e0a/6cb/c8f/e0a6cbc8f7f2d34806d1f40d47457ee2.jpg"><br><br>  In the project we created, in the <b>onCreate</b> method <b>,</b> add the following code: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.blagin.xmppsmsgate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Activity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.telephony.SmsManager; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XMPPSMSGateActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.main); SmsManager sms = SmsManager.getDefault(); sms.sendTextMessage(<span class="hljs-string"><span class="hljs-string">"5556"</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>,<span class="hljs-string"><span class="hljs-string">"Text SMS"</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre> <br><br>  Next, we launch both Android emulators, each of which will have its own number to check sending and receiving SMS messages, when launching and initializing emulators is complete, you need to run our application on the emulator with the number 5554, after the application starts, the emulator with the number 5556 will receive our SMS message . <br><br><img src="https://habrastorage.org/storage2/2c9/3e2/d11/2c93e2d11ea70ff443f2b94dbcc96041.jpg"><br><br>  Sending SMS messages was carried out using the <a href="http://developer.android.com/reference/android/telephony/gsm/SmsManager.html">SmsManager</a> class, which allows the Android system to perform the necessary actions with SMS messages.  To initialize an object of this class, the static method SmsManager.getDefault () was used.  Sending an SMS message is performed using the sendTextMessage method, where the method parameters are: <br><br><blockquote>  <b>destinationAddress</b> - the number to which the message is sent; <br>  <b>scAddress</b> - The number of the SMS center of your cellular operator through which the message is sent, if this parameter has a zero value, then the default number is used; <br>  <b>text</b> - SMS text message; <br>  <b>sentIntent</b> - If not a null value, then a PendingIntent object is sent to this parameter to receive messages about the result of sending the message; <br>  <b>deliveryIntent</b> - If not a null value, then a PendingIntent object is passed to this parameter to receive messages about the result of the message delivery. </blockquote><br>  The Android emulator does an excellent job with the tasks assigned to it, but it has several limitations, for example, it is not possible to check the result of message delivery on it, for this you have to use a real device, which will be done later.  Also, when sending a message using the sendTextMessage method, its length cannot exceed 160 characters.  For longer messages, you must use the sendMultipartTextMessage method, which in turn also allows you to send messages less than 160 characters long. <br>  In the example above, we do not receive notifications about sending an SMS message and its delivery to the recipient, therefore, we will expand the functionality of the application by adding the necessary processing.  To do this, you need to register two receivers of broadcast intentions in the application, which will process the necessary intentions and display the corresponding text messages on the screen. <br><br>  In the resource editor, add a TextView widget to our main application window to display information on the screen. <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LinearLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fill_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fill_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:orientation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vertical"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/textView"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fill_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fill_parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:gravity</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"top|left"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LinearLayout</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Application code after making changes will take the following form: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.blagin.xmppsmsgate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Activity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.PendingIntent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.BroadcastReceiver; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Intent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.IntentFilter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.telephony.SmsManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.TextView; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XMPPSMSGateActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ TextView tv = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; String SENT = <span class="hljs-string"><span class="hljs-string">"SMS_SENT"</span></span>; String DELIVERED = <span class="hljs-string"><span class="hljs-string">"SMS_DELIVERED"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BroadcastReceiver sent = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BroadcastReceiver delivered = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.main); <span class="hljs-comment"><span class="hljs-comment">// TextView      tv = (TextView) findViewById(R.id.textView); //  :  IntentFilter in_sent = new IntentFilter(SENT); sent = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { tv.append(intent.getStringExtra("PARTS")+": "); tv.append(intent.getStringExtra("MSG")+": "); switch(getResultCode()) { case Activity.RESULT_OK: tv.append("SMS \n"); break; case SmsManager.RESULT_ERROR_GENERIC_FAILURE: tv.append(" \n"); break; case SmsManager.RESULT_ERROR_NO_SERVICE: tv.append(" \n"); break; case SmsManager.RESULT_ERROR_NULL_PDU: tv.append("Null PDU\n"); break; case SmsManager.RESULT_ERROR_RADIO_OFF: tv.append(" \n"); break; } } }; registerReceiver(sent, in_sent); //  :  IntentFilter in_delivered = new IntentFilter(DELIVERED); delivered = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { tv.append(intent.getStringExtra("PARTS")+": "); tv.append(intent.getStringExtra("MSG")+": "); switch (getResultCode()) { case Activity.RESULT_OK: tv.append("SMS \n"); break; case Activity.RESULT_CANCELED: tv.append("SMS  \n"); break; } } }; registerReceiver(delivered, in_delivered); SendSMS("_","  &gt; 160 ."); } //  SMS  public void SendSMS(String phone, String message) { SmsManager sms = SmsManager.getDefault(); ArrayList&lt;String&gt; al_message = new ArrayList&lt;String&gt;(); al_message = sms.divideMessage(message); ArrayList&lt;PendingIntent&gt; al_piSent = new ArrayList&lt;PendingIntent&gt;(); ArrayList&lt;PendingIntent&gt; al_piDelivered = new ArrayList&lt;PendingIntent&gt;(); for (int i = 0; i &lt; al_message.size(); i++) { Intent sentIntent = new Intent(SENT); sentIntent.putExtra("PARTS", ": "+i); sentIntent.putExtra("MSG", ": "+al_message.get(i)); PendingIntent pi_sent = PendingIntent.getBroadcast(this, i, sentIntent, PendingIntent.FLAG_UPDATE_CURRENT); al_piSent.add(pi_sent); Intent deliveredIntent = new Intent(DELIVERED); deliveredIntent.putExtra("PARTS", ": "+i); deliveredIntent.putExtra("MSG", ": "+al_message.get(i)); PendingIntent pi_delivered = PendingIntent.getBroadcast(this, i, deliveredIntent, PendingIntent.FLAG_UPDATE_CURRENT); al_piDelivered.add(pi_delivered); } sms.sendMultipartTextMessage(phone, null, al_message, al_piSent, al_piDelivered); } @Override protected void onDestroy() { if(sent != null) unregisterReceiver(sent); if(delivered != null) unregisterReceiver(delivered); super.onDestroy(); } }</span></span></code> </pre> <br><br>  To test the sending of messages and receive a delivery receipt, on a real device, you can use your own cellular number, then you can fully test the application.  The figure below shows sending and receiving a long message. <br><br><img src="http://habrastorage.org/storage2/68e/04e/fbf/68e04efbf35dde1af8177d61f43d20f5.jpg"><br><br><h5>  2. Creating a service to work on the XMPP protocol </h5><br>  Now we need to add the ability to communicate over our protocol XMPP to our application.  For these purposes we will create a service (Service) that will work in the background.  The service, using the SMACK library, will receive and process messages.  Then, using broadcast intentions, the data from the received message will be transmitted to the main class of the application, for display on the screen and then sent via SMS. <br><br>  In order to add a service to our application, you need to define an implementation class for it, to do this, in the Eclipse development environment, right-click the project package name, select New and Class in the menu that appears, as shown in the figure: <br><br><img src="http://habrastorage.org/storage2/cbd/d60/f21/cbdd60f2134bbf9035dd46264e1c13b5.jpg"><br><br>  In the window that appears, fill in the necessary items indicated on the image and click the ‚ÄúFinish‚Äù button: <br><br><img src="http://habrastorage.org/storage2/961/48d/90b/96148d90bd80d60e4f48e6edeec298ba.jpg"><br><br>  After these actions, the implementation of the class appears in the project, then you need to register the service class in the AndroidManifest.xml file, to do this, open the file in the Eclipse development environment, go to the Application tab, and in the Application Nodes section, click the Add button, in the window that appears, select the Service item and press the "OK" button.  After you need to specify the name of the service class, after all the manipulations the Application tab will look like this: <br><br><img src="http://habrastorage.org/storage2/434/d91/7c6/434d917c6fb0ecc859d7db6b031ea9aa.jpg"><br><br>  Now we will add another permission for the application so that it can access the Internet, for this, follow the same steps as above to allow the sending of an SMS message, only this time select <b>android.permission.INTERNET</b> . <br><br>  The next step is to add the SMACK library to the application, download it at <a href="http://code.google.com/p/asmack/">http://code.google.com/p/asmack/,</a> save it in the project folder, then open the project properties, right-click on the project name in the Eclipse development environment in the menu that appears, select Properties.  In the project settings window that appears, select the Java Build Path item in the left list, then click the ‚ÄúAdd External JARs ...‚Äù button, find the previously saved library in the project folder and add it.  After adding an external library, the settings window will look as follows: <br><br><img src="http://habrastorage.org/storage2/5a9/8e3/b5a/5a98e3b5a27a0b9c22db4c9ba9de1e58.jpg"><br><br>  Below is the source code of the service, as seen in the <b>onCreate</b> method, a separate stream is created in which the main work on XMPP communication takes place using the SMACK library.  Received messages, as well as other state of the service are transmitted by sending broadcast intentions. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.blagin.xmppsmsgate; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.Chat; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.ChatManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.ConnectionConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.PacketListener; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.SASLAuthentication; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.XMPPConnection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.filter.AndFilter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.filter.PacketFilter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.filter.PacketTypeFilter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.packet.Message; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.packet.Packet; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jivesoftware.smack.packet.Presence; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Service; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Intent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.IBinder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">XMPPSMSGateService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ConnectionConfiguration connConfig; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> XMPPConnection connection; Thread th = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Intent in = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"SMSGate_Service"</span></span>); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IBinder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent arg0)</span></span></span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;} <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startId)</span></span></span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Service.START_STICKY;} <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); th= <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,<span class="hljs-string"><span class="hljs-string">"The service is started"</span></span>); sendBroadcast(in); connConfig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionConfiguration(<span class="hljs-comment"><span class="hljs-comment">/*domen*/</span></span>,<span class="hljs-number"><span class="hljs-number">5222</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*server*/</span></span>); SASLAuthentication.supportSASLMechanism(<span class="hljs-string"><span class="hljs-string">"PLAIN"</span></span>); connConfig.setCompressionEnabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); connConfig.setSASLAuthenticationEnabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMPPConnection(connConfig); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,<span class="hljs-string"><span class="hljs-string">"Connect to the XMPP server"</span></span>); sendBroadcast(in); connection.connect(); in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,<span class="hljs-string"><span class="hljs-string">"Login into the XMPP server"</span></span>); sendBroadcast(in); connection.login(<span class="hljs-comment"><span class="hljs-comment">/*login*/</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*password*/</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(connection.isConnected()) { in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,<span class="hljs-string"><span class="hljs-string">"SMS Gate online."</span></span>); sendBroadcast(in); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,<span class="hljs-string"><span class="hljs-string">"SMS Gate offline."</span></span>); sendBroadcast(in); } Presence presence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Presence(Presence.Type.available); presence.setStatus(<span class="hljs-string"><span class="hljs-string">"SMS Gate"</span></span>); presence.setPriority(<span class="hljs-number"><span class="hljs-number">30</span></span>); connection.sendPacket(presence); PacketFilter filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AndFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PacketTypeFilter(Message.class)); PacketListener myListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PacketListener() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processPacket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Packet packet)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(packet <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> Message) { Message message = (Message) packet; String messageBody = message.getBody(); String JID = message.getFrom(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(messageBody == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { messageBody = <span class="hljs-string"><span class="hljs-string">""</span></span>; Collection&lt;Message.Body&gt; bodies = message.getBodies(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Message.Body r:bodies){messageBody += r.getMessage();} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(messageBody.equals(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>)){sendMessage(JID,<span class="hljs-string"><span class="hljs-string">"pong"</span></span>);} in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,messageBody); sendBroadcast(in); } } }; connection.addPacketListener(myListener, filter); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(connection.isConnected()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{Thread.sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>);}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e){Log.e(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass().getName(),e.getMessage());} } }<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) { Log.e(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass().getName(),e.getMessage()); in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,<span class="hljs-string"><span class="hljs-string">"ERROR: "</span></span>+e.getMessage()); sendBroadcast(in); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String to, String message)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!message.equals(<span class="hljs-string"><span class="hljs-string">""</span></span>)) { ChatManager chatmanager = connection.getChatManager(); Chat newChat = chatmanager.createChat(to, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{newChat.sendMessage(message);} <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) {Log.e(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass().getName(),e.getMessage());} } } }; th.start(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(connection.isConnected()){connection.disconnect();th = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>;} in.putExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>,<span class="hljs-string"><span class="hljs-string">"The service is stopped"</span></span>); sendBroadcast(in); } }</code> </pre> <br><br>  To process broadcast intentions received from the service, you need to register another receiver of broadcast intentions. To do this, add the following code to the <b>onCreate</b> method of the main application class: <br><br><pre> <code class="java hljs">IntentFilter filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(); filter.addAction(<span class="hljs-string"><span class="hljs-string">"SMSGate_Service"</span></span>); service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BroadcastReceiver() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(intent.getAction().equals(<span class="hljs-string"><span class="hljs-string">"SMSGate_Service"</span></span>)) { String message = intent.getStringExtra(<span class="hljs-string"><span class="hljs-string">"Message"</span></span>); tv.append(message+<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = message.indexOf(<span class="hljs-string"><span class="hljs-string">"@"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(i != -<span class="hljs-number"><span class="hljs-number">1</span></span>) { String phone = message.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(phone.length() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { String text = message.substring(i+<span class="hljs-number"><span class="hljs-number">1</span></span>,message.length()); tv.append(<span class="hljs-string"><span class="hljs-string">"Sending SMS...\n"</span></span>); SendSMS(phone,text); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{<span class="hljs-comment"><span class="hljs-comment">/*phone: 0*/</span></span>} }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{<span class="hljs-comment"><span class="hljs-comment">/*not sms message*/</span></span>} } } }; registerReceiver(service, filter);</code> </pre> <br><br>  As can be seen from the above code, for sending SMS, messages that are of the type number telephone_message_ message are processed, for example: <br><br> <code>5556@ </code> <br> <br>  To start the service, in the main application class, add the line to the <b>onCreate</b> method: <br><pre> <code class="java hljs">startService(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,XMPPSMSGateService.class));</code> </pre> <br>  To stop the service, in the main application class in the <b>onDestroy</b> method, add the line: <br><pre> <code class="java hljs">stopService(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,XMPPSMSGateService.class));</code> </pre> <br>  Now we will try to start the application in the emulator and send a message of a certain type through any IM client.  The result is shown in the image: <br><br><img src="http://habrastorage.org/storage2/541/943/f36/541943f3657f4df6e16605beef20db6a.jpg"><br><br><h5>  Conclusion </h5><br>  This article is an introductory and designed for novice programmers, whom I myself am.  The created application has several disadvantages and limitations, for example, sending an SMS message will be carried out only when the main application window is active.  There is no check for Internet access, as well if Internet access is only via WI-FI, then when the device goes into sleep mode, WI-FI is turned off, to save battery power.  This problem can be avoided by using the <a href="https://market.android.com/details%3Fid%3Dcom.shantz.wifikeepalive">Wi-Fi Keep Alive</a> application or by adding this functionality to the application yourself.  There is no logging of received and sent messages. <br><br>  The scope of application of this application is quite wide, from receiving notifications about the order to creating a full-fledged SMS gateway for processing various data. <br><br>  <a href="">The source code of the application.</a> <br><br><h5>  Bibliography </h5><ol><li>  Alexey Goloshchapov, Google Android.  Programming for mobile devices, 2012 </li><li>  Alexey Goloshchapov, Google Android.  System components and network communications, 2012 </li><li>  <a href="http://habrahabr.ru/blogs/im/127535/">Java XMPP bot using Smack API</a> ( <a href="https://habrahabr.ru/users/esin/" class="user_link">esin</a> ). </li></ol></div><p>Source: <a href="https://habr.com/ru/post/135627/">https://habr.com/ru/post/135627/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135619/index.html">We write our blog with the framework of Fat-Free Framework</a></li>
<li><a href="../135621/index.html">German police sent 440 thousand hidden SMS to spy on citizens</a></li>
<li><a href="../135622/index.html">2011 in the OSM project. Beautiful visualization of edits on the globe</a></li>
<li><a href="../135625/index.html">Java Network Client Development</a></li>
<li><a href="../135626/index.html">On ‚Äúnon-tariffable‚Äù calls from mobile to numbers 8-800-xxxxxxx in Russia</a></li>
<li><a href="../135628/index.html">Collective intelligence of bacteria or swarm intelligence</a></li>
<li><a href="../135629/index.html">Asynchronous data exchange over HTTP</a></li>
<li><a href="../135630/index.html">We control printing with PAM</a></li>
<li><a href="../135633/index.html">Jrebel</a></li>
<li><a href="../135634/index.html">Ensuring clean air when cleaning the matrix of a digital camera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>