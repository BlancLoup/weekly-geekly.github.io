<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ubuntu Russification console in 2016</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For me, it was some revelation to find out that in 2016, in one of the large GNU / Linux distributions, there are problems with localization. Or rathe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ubuntu Russification console in 2016</h1><div class="post__text post__text-html js-mediator-article">  For me, it was some revelation to find out that in 2016, in one of the large GNU / Linux distributions, there are problems with localization.  Or rather, with the localization of the text console.  Who uses text console in 2016?  Do not forget that there are many distributions based on Ubuntu and not all of them use a graphical environment.  I will mention two examples: Ubuntu Server and Clonezilla. <br><br>  The problem looks like this: <br><br><img src="https://habrastorage.org/files/def/b91/9b3/defb919b33cd44f4bb39ffca2902e726.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And is present in the current release of Ubuntu 15.10 and in the beta version of Ubuntu 16.04.  Those who are interested to know the causes of the problem and how you can solve it - I ask for habrakat. <br><a name="habracut"></a><br><h3>  Lyrical introduction </h3><br>  It all started with Clonezilla.  This is such a Linux Live CD / USB with the Clonezilla program for copying discs.  I‚Äôm doing, I mean, a bootable USB flash drive with various utilities and, if possible, I turn on Russification, where possible, because I want to share the flash drive with my colleagues, but they are not all fluent in English.  Just finished setting up GParted Live.  I think everything should be similar - both distros support <a href="http://manpages.ubuntu.com/manpages/oneiric/live-config.7..html">live-config</a> .  I set the parameters for Russification - I add the following values ‚Äã‚Äãto the kernel parameters: <br><br> <code>locales=ru_RU.UTF-8 <br> keyboard-layouts=us,ru <br> keyboard-options=grp:ctrl_shift_toggle,lctrl_shift_toggle <br></code> <br>  The first parameter sets the language in which the system will communicate with us and encoding.  The second parameter sets the keyboard layouts that we will use.  And the third sets the way to switch layouts with CTRL + SHIFT.  In fact, the language and layout can be selected after launching Clonezilla, but you cannot select two layouts and the switching method - there will be only a Russian or only an English keyboard.  These parameters worked correctly in GParted Live and I expect the same behavior from Clonezilla.  But ... after loading, black squares are displayed instead of Russian characters: <br><br><img src="https://habrastorage.org/files/3be/f1d/200/3bef1d20029541389fd57dec50545cc7.png"><br><br>  I remember that Clonezilla offers two branches of the distribution: stable based on Debian and alternative on Ubuntu.  The alternative contains non-free software, such as the firmware (firmware) of some equipment (for example, WiFi-cards), so I downloaded it - for greater versatility. <br><br>  For the sake of jokes, I download a stable version based on Debian, I run it with the Russian locale - everything is displayed correctly. <br><br><img src="https://habrastorage.org/files/498/87c/f7e/49887cf7e9b545bf971f5437fee9c278.png"><br><br>  Suspicions fall on the parent distribution - Ubuntu 15.10.  Just this, I think I switch to the text console (Ctrl + Alt + F1) and run `date`: <br><br><img src="https://habrastorage.org/files/def/b91/9b3/defb919b33cd44f4bb39ffca2902e726.png"><br><br>  Na-ka, says Ubunt. <br><br><h3>  Wrong turn </h3><br>  Common sense suggests - take a stable Clonezilla and work on.  But.  Ahead of the weekend, Dota 2 ‚Äúlet me go‚Äù, and the memory suggests that problems with the localization of the text console in Ubuntu have been around for a long time, they are being solved with varying success, and I still want to figure it out. <br><br>  We google the problem and find that we face a similar one since <a href="http://forum.ubuntu.ru/index.php%3Ftopic%3D173522.0">Ubuntu 11.10</a> .  There are several solutions with different degrees of utility, the most popular is to turn on the FRAMEBUFFER = y option for initramfs and rebuild the initrd with the update-initramfs command.  With the words "just not to think, and ours will take!" I add the line FRAMEBUFFER = y to the end of the file initramfs.conf, update the initrd image and reboot: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> FRAMEBUFFER=y | sudo tee -a /etc/initramfs-tools/initramfs.conf sudo update-initramfs -u sudo reboot</code> </pre><br>  After the reboot, there are no changes, all the same squares instead of Cyrillic.  On the forums, many also complain that this method did not help them. <br><br><h3>  Start over </h3><br>  He rolled back all the changes back, made up his mind.  The <i>console-setup</i> package is responsible for configuring the console in Ubuntu, which stores the settings in / etc / default / console-setup and applies them through the <i>setupcon</i> command.  Settings can be changed simply by editing the file or via <i>dpkg-reconfigure console-setup</i> .  Check console settings: <br><br> <code>cat /etc/default/console-setup <br> ACTIVE_CONSOLES="/dev/tty[1-6]" <br> CHARMAP="UTF-8" <br> CODESET="guess" <br> FONTFACE="Fixed" <br> FONTSIZE="8x16" <br></code> <br>  In the text console, we give the <i>setupcon</i> command.  Even by eye it is clear that the font has changed and now the console displays the Cyrillic alphabet: <br><br><img src="https://habrastorage.org/files/790/74b/720/79074b72015c4e2da038215b85562fef.png"><br><br>  So, the system has everything to display Cyrillic, but when loading these settings do not apply.  Let's see what is inside the <i>console-setup</i> package: <br><br><pre> <code class="bash hljs">mkdir console-setup &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> console-setup apt-get download console-setup dpkg-deb -R *.deb ./</code> </pre><br>  In addition to the two files already mentioned ( <i>console-setup</i> and <i>setupcon</i> ), the file <i>console-font.conf</i> installed in / etc / init / is of interest.  This file is the systemd script, the linux bootstrap system, replacing system v init.  Look at the contents: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># console-font - set console font # # Set the console font, in case the similar udev rule races with Plymouth # and thus fails to do it. description "set console font" start on starting plymouth-splash task exec /lib/udev/console-setup-tty fbcon</span></span></code> </pre><br>  Judging by the title and description, this is similar to what is needed - setting the console font when the system boots.  The task of installing the font is shifted to the script / lib / udev / console-setup-tty.  I will give the most interesting parts of this script: <br><br><pre> <code class="bash hljs">... <span class="hljs-comment"><span class="hljs-comment"># Based on setupcon, but stripped down for use in a udev rule. ... . /etc/default/console-setup ... if [ "$1" = fbcon ]; then # Technically we have to wait for /dev/tty[1-6] to appear; but these are # created in vty_init, so I think it will always be early enough. If # I'm wrong, then the -w test will fail and we end up with the wrong # fonts on some virtual consoles; the user can run setupcon to fix it. for console in $ACTIVE_CONSOLES; do if [ -w "$console" ]; then setup_font "$console" fi done else if [ -w "$1" ]; then setup_unicode "$1" setup_font "$1" setup_keyboard_mode "$1" fi fi</span></span></code> </pre><br>  I have so far missed all the functions that are defined inside the script to draw attention to the most important.  The first comment says that the script is based on <i>setupcon</i> , but truncated to match the udev rule.  Let's say.  Below is the inclusion of the configuration file (. / Etc / default / console-setup).  Next comes the check of the first parameter passed to the script, just with this parameter (fbcon) the script is called from /etc/init/console-font.conf.  For each active console (listed in / etc / default / console-setup), a check is made for the ability to write to it and, for each console, the function <i>setup_font</i> is <i>called</i> .  At the same time, the author of the script writes that by the time the script is called the console should be created, and if not, the test for writing to the console will not work and this console will not be configured.  And the user himself can call <i>setupcon</i> later.  Take note of this and consider the <i>setup_font</i> function from the / lib / udev / console-setup-tty file: <br><br><pre> <code class="bash hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup_font</span></span></span></span> () { <span class="hljs-comment"><span class="hljs-comment"># Set the font and ACM. setfont will silently do nothing for a console # in graphics mode. SETFONT_ARGS= if [ "$FONT" ]; then FONT="/etc/console-setup/${FONT##*/}" FONT="${FONT%.gz}" else FONT="/etc/console-setup/$CODESET-$FONTFACE$FONTSIZE.psf" fi if [ -f "$FONT" ]; then SETFONT_ARGS="${SETFONT_ARGS:+$SETFONT_ARGS }$FONT" fi if [ "$ACM" ]; then ACM="/etc/console-setup/${ACM##*/}" ACM="${ACM%.gz}" else ACM="/etc/console-setup/$CHARMAP.acm" fi if [ -f "$ACM" ]; then SETFONT_ARGS="${SETFONT_ARGS:+$SETFONT_ARGS }-m $ACM" fi if [ "$SETFONT_ARGS" ]; then setfont -C "$1" $SETFONT_ARGS fi }</span></span></code> </pre><br>  Vooot.  Here it is a joint.  The $ FONT variable is not set, the string works. <br><br><pre> <code class="bash hljs">FONT=<span class="hljs-string"><span class="hljs-string">"/etc/console-setup/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CODESET</span></span></span><span class="hljs-string">-</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONTFACE</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONTSIZE</span></span></span><span class="hljs-string">.psf"</span></span></code> </pre><br><br>  I recall the console settings: <br> <code>CHARMAP="UTF-8" <br> CODESET="guess" <br> FONTFACE="Fixed" <br> FONTSIZE="8x16" <br></code> <br>  The variables $ CODESET, $ FONTFACE, $ FONTSIZE are taken directly from the configuration file and are no longer changed.  It turns out that FONT = "/ etc / console-setup / guess-Fixed8x16.psf".  Let's see what fonts we have in / etc / console-setup /: <br><br><pre> <code class="bash hljs">ls /etc/console-setup/*.psf* /etc/console-setup/Uni2-Fixed16.psf.gz</code> </pre><br>  Thus, the script incorrectly handles CODESET = "guess".  He had to "guess" about the character set used.  FONTSIZE = ‚Äú8x16‚Äù is also incorrectly processed, probably the largest of the digits or the last digit should remain.  But that's not all ... Our font is compressed and has the extension .gz.  As it turned out, the <i>setfont</i> command, which is called further, will itself add the .gz extension if it does not find the * .psf file and loads the font.  But check for the presence of a file named $ FONT <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONT</span></span></span><span class="hljs-string">"</span></span> ];</code> </pre><br>  and the variable $ SETFONT_ARGS will remain empty - respectively, the block that directly sets the font, <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SETFONT_ARGS</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> setfont -C <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-variable"><span class="hljs-variable">$SETFONT_ARGS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br>  will not be executed. <br><br>  Knowing this information, we can adjust to the system and manually set $ CODESET = "Uni2" and <br>  $ FONTSIZE = "16" or, instead, set the variable $ FONT = "Uni2-Fixed16.psf".  In addition, we need to unzip the font file: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/console-setup sudo gunzip -k Uni2-Fixed16.psf.gz</code> </pre><br>  After the reboot, the font will be installed, but when changing the font through <i>dpkg-reconfigure console-setup,</i> we will have to make corrections again manually. <br><br><h3>  We continue the conversation </h3><br>  We recall the <i>setupcon</i> script, which was mentioned in the comments and on which / lib / udev / console-setup-tty is based.  Look what's inside: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># setupcon -- setup the font and keyboard on the Linux console ‚Ä¶ ########################################################################### ### INITIALIZATION AND DEFAULT VALUES ########################################################################### ‚Ä¶ # CODESET [ "$CODESET" != guess ] || CODESET='' if [ -z "$CODESET" ]; then case "$CHARMAP" in UTF-8) CODESET=Uni2;; ARMSCII-8) CODESET=Armenian ;; CP1251) CODESET=CyrSlav ;; CP1255) CODESET=Hebrew ;; CP1256) CODESET=Arabic ;; GEORGIAN-ACADEMY) CODESET=Georgian ;; GEORGIAN-PS) CODESET=Georgian ;; IBM1133) CODESET=Lao ;; ISIRI-3342) CODESET=Arabic ;; ISO-8859-1) CODESET=Lat15 ;; ISO-8859-2) CODESET=Lat2 ;; ISO-8859-3) CODESET=Lat38 ;; ISO-8859-4) CODESET=Lat7 ;; # sometimes Lat15 ISO-8859-5) CODESET=CyrSlav ;; ISO-8859-6) CODESET=Arabic ;; ISO-8859-7) CODESET=Greek ;; ISO-8859-8) CODESET=Hebrew ;; ISO-8859-9) CODESET=Lat15 ;; ISO-8859-10) CODESET=Lat15 ;; ISO-8859-11) CODESET=Thai ;; ISO-8859-13) CODESET=Lat7 ;; ISO-8859-14) CODESET=Lat38 ;; ISO-8859-15) CODESET=Lat15 ;; ISO-8859-16) CODESET=Lat2 ;; KOI8-R) CODESET=CyrKoi ;; KOI8-U) CODESET=CyrKoi ;; TIS-620) CODESET=Thai ;; VISCII) CODESET=Vietnamese ;; *) if [ "$do_font" ]; then echo Unsupported charmap $CHARMAP &gt;&amp;2 exit 1 fi ;; esac if [ "$kernel" = freebsd ]; then # 512 character fonts are not supported on FreeBSD case "$CODESET" in Uni*|Vietnamese|Arabic|Ethiopian) CODESET=Lat15 ;; esac fi fi ‚Ä¶ # FONTSIZE if [ -z "$FONTSIZE" -o "$FONTSIZE" = guess ]; then FONTSIZE=16 fi case "$FONTSIZE" in 8x*) FONTSIZE=${FONTSIZE#*x} ;; *x8) FONTSIZE=${FONTSIZE%x*} ;; *x*) a=${FONTSIZE%x*} b=${FONTSIZE#*x} if [ "$a" -lt "$b" ]; then FONTSIZE=${b}x${a} fi ;; esac</span></span></code> </pre><br>  The script contains code for Linux and FreeBSD, everything that relates to BSD can be safely omitted.  I left only the most interesting - processing $ CODESET and $ FONTSIZE.  Just in this script there is a handling of the situation when $ CODESET is not set or has the value 'guess'.  In this case, $ CODESET takes a value depending on $ CHARMAP.  In our case, $ CODESET = Uni2. <br><br>  $ FONTSIZE is also checked for an unspecified value or 'guess' and is hard-coded to '16', if so.  If $ FONTSIZE is given as 8x * or * x8, then the 'x' sign and the eight is discarded, and only one digit remains (the height of the font).  For example, it was '8x14' - '14' will remain, and from '15x8' will be '15'.  If $ FONTSIZE is given as two digits '* x *': <br><br><pre> <code class="bash hljs">*x*) a=<span class="hljs-variable"><span class="hljs-variable">${FONTSIZE%x*}</span></span> b=<span class="hljs-variable"><span class="hljs-variable">${FONTSIZE#*x}</span></span></code> </pre>  (a is the first digit, b is the second), then the larger digit is rearranged forward: <br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$a</span></span></span><span class="hljs-string">"</span></span> -lt <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$b</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> FONTSIZE=<span class="hljs-variable"><span class="hljs-variable">${b}</span></span>x<span class="hljs-variable"><span class="hljs-variable">${a}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br>  For example, it was '10x20' - it became '20x10', and '22x11' would not change.  Let's see how the fonts available in the system are called: <br><br><pre> <code class="bash hljs">ls /usr/share/consolefonts/ ‚Ä¶ /usr/share/consolefonts/Uni2-Fixed13.psf.gz /usr/share/consolefonts/Uni2-Fixed14.psf.gz ‚Ä¶ /usr/share/consolefonts/Uni2-Terminus22x11.psf.gz /usr/share/consolefonts/Uni2-Terminus24x12.psf.gz ‚Ä¶ /usr/share/consolefonts/Uni2-TerminusBold28x14.psf.gz /usr/share/consolefonts/Uni2-TerminusBold32x16.psf.gz ‚Ä¶</code> </pre><br>  Converge.  Now, if we add such processing of the $ CODESET and $ FONTSIZE parameters to the script / lib / udev / console-setup-tty, and also add to this script a check for the existence of a compressed * .psf.gz file (and at the same time * .acm. gz): <br><br><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONT</span></span></span><span class="hljs-string">"</span></span> ] || [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONT</span></span></span><span class="hljs-string">.gz"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> SETFONT_ARGS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SETFONT_ARGS:+$SETFONT_ARGS }</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONT</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ACM</span></span></span><span class="hljs-string">"</span></span> ] || [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ACM</span></span></span><span class="hljs-string">.gz"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> SETFONT_ARGS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SETFONT_ARGS:+$SETFONT_ARGS }</span></span></span><span class="hljs-string">-m </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ACM</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br>  then the script will work correctly. <br><br><h3>  Warm giblets </h3><br>  We continue to gut scripts.  We are looking for, from where (from which package) legs of / lib / udev / console-setup-tty grow: <br><br><pre> <code class="bash hljs">sudo apt-get install apt-file apt-file update apt-file search /lib/udev/console-setup-tty keyboard-configuration: /lib/udev/console-setup-tty</code> </pre><br>  Download and unpack the <i>keyboard-configuration</i> package: <br><br><pre> <code class="bash hljs">apt-get download keyboard-configuration dpkg-deb -R keyboard-configuration_1.108ubuntu9_all.deb ./</code> </pre><br>  We look in which scripts the settings file / etc / default / console-setup is used: <br><br><pre> <code class="bash hljs">grep -rm 1 etc/default/console-setup ./ ./lib/udev/console-setup-tty:. /etc/default/console-setup ./usr/share/doc/keyboard-configuration/README.Debian:(/etc/default/keyboard and /etc/default/console-setup) perhaps it will ./usr/share/apport/package-hooks/source_console-setup.py: report, <span class="hljs-string"><span class="hljs-string">'/etc/default/console-setup'</span></span>, <span class="hljs-string"><span class="hljs-string">'ConsoleSetup'</span></span>) ./usr/share/initramfs-tools/scripts/panic/console_setup:[ -r /etc/default/console-setup ] || <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 ./usr/share/initramfs-tools/scripts/init-top/console_setup:[ -r /etc/default/console-setup ] || <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 ./usr/share/initramfs-tools/hooks/console_setup:[ -r /etc/default/console-setup ] || <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 ./DEBIAN/config:OLDCONFIGFILE=/etc/default/console-setup</code> </pre><br>  Of these, interest is only: <br><br><pre> <code class="bash hljs">./lib/udev/console-setup-tty ./usr/share/initramfs-tools/scripts/panic/console_setup ./usr/share/initramfs-tools/scripts/init-top/console_setup ./usr/share/initramfs-tools/hooks/console_setup</code> </pre><br>  All of them contain code that is similar to the one that we have sorted out above ‚Äî from / lib / udev / console-setup-tty, without correctly processing $ CODESET and $ FONTSIZE.  And these two files <br><br><pre> <code class="bash hljs">./usr/share/initramfs-tools/scripts/panic/console_setup ./usr/share/initramfs-tools/scripts/init-top/console_setup</code> </pre><br>  differ only in one line: <br> <code>OPTION=FRAMEBUFFER <br></code> <br>  A familiar option, I thought ... Three scripts of interest to us are located in the <i>initramfs-tools</i> folder.  The <i>initramfs-tools</i> package is responsible for building the <i>initrd</i> image, which is loaded into memory when the kernel is loaded and is used by it while the main file system is not available.  The <i>initrd</i> usually contains kernel modules necessary for it to work on our hardware and for mounting file systems, as well as initialization scripts and their configuration files.  The image is <i>assembled by the update-initramfs script</i> , which ultimately calls the <i>mkinitramfs</i> script.  As always, let's see what‚Äôs inside <i>mkinitramfs</i> : <br><br><pre> <code class="bash hljs">‚Ä¶ CONFDIR=<span class="hljs-string"><span class="hljs-string">"/etc/initramfs-tools"</span></span> ... . <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CONFDIR}</span></span></span><span class="hljs-string">/initramfs.conf"</span></span> ‚Ä¶ <span class="hljs-comment"><span class="hljs-comment"># add existant boot scripts for b in $(cd /usr/share/initramfs-tools/scripts/ &amp;&amp; find . \ -regextype posix-extended -regex '.*/[[:alnum:]\._-]+$' -type f); do option=$(sed '/^OPTION=/!d;$d;s/^OPTION=//;s/[[:space:]]*$//' "/usr/share/initramfs-tools/scripts/${b}") [ -z "${option}" ] || eval test -n \"\${$option}\" -a \"\${$option}\" != \"n\" || continue [ -d "${DESTDIR}/scripts/$(dirname "${b}")" ] \ || mkdir -p "${DESTDIR}/scripts/$(dirname "${b}")" cp -p "/usr/share/initramfs-tools/scripts/${b}" \ "${DESTDIR}/scripts/$(dirname "${b}")/" done</span></span></code> </pre><br>  Here everything looks quite difficult, I will try to show with examples.  This block goes through all the files in / usr / share / initramfs-tools / scripts / and subfolders, and searches inside them for a line containing 'OPTION ='.  For example, the / usr / share / initramfs-tools / scripts / init-top / console_setup file has the string <br><br> <code>OPTION=FRAMEBUFFER <br></code> <br>  If 'OPTION' is missing or not specified, the file (script) is copied to the <i>initrd</i> .  If 'OPTION' is present, take the value of this option as the name of the variable and check whether it is set and not equal to 'n'.  In our example, the variable $ FRAMEBUFFER is checked.  We set this variable in FRAMEBUFFER = y at the very beginning, in the file <i>initramfs.conf</i> .  Since the value of the FRAMEBUFFER variable is not used in the scripts related to <i>setup-console</i> , it acts as a trigger and we can set it to any value, not necessarily 'y'.  Even 'no' or 'none' will work in the same way as 'y'.  So, if FRAMEBUFFER is defined and not equal to 'n', the script will be placed in the <i>initrd</i> image.  There are 8 such scripts: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/share/initramfs-tools/scripts grep -rl FRAMEBUFFER ./ ./init-premount/brltty ./panic/plymouth ./init-bottom/plymouth ./init-top/keymap ./init-top/framebuffer ./init-top/console_setup ./init-top/brltty ./init-top/plymouth</code> </pre><br>  These scripts start and configure the framebuffer - roughly speaking, the text console is translated into graphical mode.  After that, it becomes possible to draw images and non-standard fonts in it.  That's just <i>console_setup</i> and installs the font for the console.  Probably due to the fact that the user can choose a non-standard font, this script is tied to the start of the framebuffer and without the set parameter 'FRAMEBUFFER = y' is not added to the <i>initrd</i> . <br><br>  Thus, when activating the framebuffer, the console will also be configured with the font installed, but at an earlier stage. <br><br>  But back to our scripts from the keyboard-configuration <br><br><pre> <code class="bash hljs">./lib/udev/console-setup-tty ./usr/share/initramfs-tools/scripts/panic/console_setup ./usr/share/initramfs-tools/scripts/init-top/console_setup ./usr/share/initramfs-tools/hooks/console_setup</code> </pre><br>  The script ... / init-top / console_setup is copied into the <i>initrd</i> image with the 'FRAMEBUFFER = y' parameter set. <br><br>  The script ... / panic / console_setup is always copied to the <i>initrd</i> , since it does not contain the specified 'OPTION' variable.  Scripts from the <i>panic</i> directory are called by the <i>panic</i> function from the <i>init</i> script (which includes functions from the / usr / share / initramfs-tools / scripts / functions file).  The very same <i>panic</i> function is called when the init <i>init</i> script cannot continue execution (no root filesystem, etc. were found).  So, the script ... / panic / console_setup is designed to configure the console in <i>panic</i> mode in order to display messages in the user's native encoding. <br><br>  The script ... / hooks / console_setup is called from the <i>mkinitramfs</i> script, when creating an <i>initrd</i> image: <br><br><pre> <code class="bash hljs">... CONFDIR=<span class="hljs-string"><span class="hljs-string">"/etc/initramfs-tools"</span></span> ... run_scripts_optional /usr/share/initramfs-tools/hooks run_scripts_optional <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${CONFDIR}</span></span></span><span class="hljs-string">"</span></span>/hooks</code> </pre><br>  This script is responsible for copying the files needed to configure the console (font file, font conversion table (acm) and keyboard layout file (keymap)) to the <i>initrd</i> .  Accordingly, even if we correct init-top / console_setup, but we forget to make changes to hooks / console_setup, the console will not be configured at this stage due to the lack of necessary files. <br><br><h3>  Make corrections </h3><br>  Now, knowing how to configure the console and where errors are made, you can make edits to the code.  Download the source code for the <i>keyboard-configuration</i> package, and also download all dependencies for rebuilding the package: <br><br><pre> <code class="bash hljs">apt-get <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> keyboard-configuration sudo apt-get build-dep keyboard-configuration</code> </pre><br>  But instead of <i>keyboard-configuration</i> , we downloaded the <i>console-setup</i> package, from which, as it turned out, several deb-files are assembled, including <i>console-setup</i> and <i>keyboard-configuration</i> .  Go to the source root, and look at which files use the FONT variable: <br><br><pre> <code class="bash hljs">grep -rl \<span class="hljs-variable"><span class="hljs-variable">$FONT</span></span> ./ ./debian/font-switch ./debian/console-setup.config ./debian/console-setup.postinst ./debian/console-setup.initramfs-hook ./debian/console-setup.initramfs-top ./console-setup-tty ./setupcon</code> </pre><br>  After studying them, it is clear that we are only interested in <br><br><pre> <code class="bash hljs">./debian/console-setup.initramfs-hook ./debian/console-setup.initramfs-top ./console-setup-tty ./setupcon</code> </pre><br>  The first three need to be corrected, and the last one will serve as a donor, since it contains the code that processes $ CODESET and $ FONTSIZE. <br>  The fix is ‚Äã‚Äãto add the following code: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># CODESET [ "$CODESET" != guess ] || CODESET='' if [ -z "$CODESET" ]; then case "$CHARMAP" in UTF-8) CODESET=Uni2;; ARMSCII-8) CODESET=Armenian ;; CP1251) CODESET=CyrSlav ;; CP1255) CODESET=Hebrew ;; CP1256) CODESET=Arabic ;; GEORGIAN-ACADEMY) CODESET=Georgian ;; GEORGIAN-PS) CODESET=Georgian ;; IBM1133) CODESET=Lao ;; ISIRI-3342) CODESET=Arabic ;; ISO-8859-1) CODESET=Lat15 ;; ISO-8859-2) CODESET=Lat2 ;; ISO-8859-3) CODESET=Lat38 ;; ISO-8859-4) CODESET=Lat7 ;; # sometimes Lat15 ISO-8859-5) CODESET=CyrSlav ;; ISO-8859-6) CODESET=Arabic ;; ISO-8859-7) CODESET=Greek ;; ISO-8859-8) CODESET=Hebrew ;; ISO-8859-9) CODESET=Lat15 ;; ISO-8859-10) CODESET=Lat15 ;; ISO-8859-11) CODESET=Thai ;; ISO-8859-13) CODESET=Lat7 ;; ISO-8859-14) CODESET=Lat38 ;; ISO-8859-15) CODESET=Lat15 ;; ISO-8859-16) CODESET=Lat2 ;; KOI8-R) CODESET=CyrKoi ;; KOI8-U) CODESET=CyrKoi ;; TIS-620) CODESET=Thai ;; VISCII) CODESET=Vietnamese ;; *) ;; esac fi # FONTSIZE if [ -z "$FONTSIZE" -o "$FONTSIZE" = guess ]; then FONTSIZE=16 fi case "$FONTSIZE" in 8x*) FONTSIZE=${FONTSIZE#*x} ;; *x8) FONTSIZE=${FONTSIZE%x*} ;; *x*) a=${FONTSIZE%x*} b=${FONTSIZE#*x} if [ "$a" -lt "$b" ]; then FONTSIZE=${b}x${a} fi ;; esac</span></span></code> </pre><br>  in each of the files after connecting the configuration file and checking, for example: <br><br><pre> <code class="bash hljs">... [ -r /etc/default/console-setup ] || <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 . /etc/default/console-setup [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ACTIVE_CONSOLES</span></span></span><span class="hljs-string">"</span></span> ] || <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 <span class="hljs-comment"><span class="hljs-comment"># CODESET [ "$CODESET" != guess ] || CODESET='' if [ -z "$CODESET" ]; then ...</span></span></code> </pre><br>  You also need to add a check for compressed files: <br><br><pre> <code class="bash hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONT</span></span></span><span class="hljs-string">"</span></span> ] || [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONT</span></span></span><span class="hljs-string">.gz"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> SETFONT_ARGS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SETFONT_ARGS:+$SETFONT_ARGS }</span></span></span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$FONT</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ACM</span></span></span><span class="hljs-string">"</span></span> ] || [ -f <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ACM</span></span></span><span class="hljs-string">.gz"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> SETFONT_ARGS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${SETFONT_ARGS:+$SETFONT_ARGS }</span></span></span><span class="hljs-string">-m </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ACM</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span></code> </pre><br>  After making the changes, we can rebuild the package - go to the source root and execute: <br><br> <code>dpkg-buildpackage -uc -b <br></code> <br>  Install the fixed package and prohibit updates to it, otherwise Ubuntu will replace it with the current (uncorrected) package from the repository: <br><br><pre> <code class="bash hljs">sudo dpkg -i keyboard-configuration_*.deb sudo apt-mark hold keyboard-configuration</code> </pre><br>  Everything, now when booting the OS, the text console will be correctly configured. <br><br>  Download the patch and the corrected package on the page with a <a href="https://bugs.launchpad.net/ubuntu/%2Bsource/console-setup/%2Bbug/1565542">bug report</a> on the lunchpad.  There you can also increase the priority of the error by registering and clicking on ‚ÄúThis bug affects me‚Äù. <br><br>  <b>Updated 04/20/2016:</b> <br>  Today, 04/20/2016, one day before the release, the fix was included first in the proposed and then in the release branch of Ubuntu Xenial. <br>  For this we had to make some effort.  In particular, create a branch of the <a href="https://code.launchpad.net/~eugenenuke/ubuntu/wily/console-setup/fix-for-1565542">console-setup</a> package on launchpad, make corrections to it and <a href="https://code.launchpad.net/~eugenenuke/ubuntu/wily/console-setup/fix-for-1565542/%2Bmerge/291433">propose</a> this branch for merging with the release one.  Also, I looked at <a href="https://launchpad.net/~cyphermox">who</a> last downloaded the console-setup package and sent him a request to review the error and fixes.  After 2 weeks, the corrected package was reviewed, approved and accepted for release.  Thank you, Mathieu Trudel-Lapierre! </div><p>Source: <a href="https://habr.com/ru/post/281170/">https://habr.com/ru/post/281170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281158/index.html">Cloud commercial object-oriented business application for a paid toilet or thinking about architecture</a></li>
<li><a href="../281160/index.html">Expanded PHPixie Project Skeleton with Authentication and Admin Panel</a></li>
<li><a href="../281162/index.html">Architectural Patterns in iOS</a></li>
<li><a href="../281164/index.html">Collecting Checkpoint Firewall Logs (OPSEC LEA)</a></li>
<li><a href="../281168/index.html">How to hack thousands of printers in the Russian Federation and print everything you want</a></li>
<li><a href="../281172/index.html">Welcome to Moscow Atlassian Meetup April 26</a></li>
<li><a href="../281176/index.html">His name is Bot. Statsbot</a></li>
<li><a href="../281178/index.html">RAML 1.0: review of innovations</a></li>
<li><a href="../281180/index.html">Lists of actions: simple, flexible, extensible AI</a></li>
<li><a href="../281184/index.html">Seven things you need to know a novice programmer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>