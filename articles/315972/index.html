<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protection of virtual machines located in the data center</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the age of cloud technologies, when each user has his own cloud for storing photos, and companies rent servers for cloud computing, the question ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protection of virtual machines located in the data center</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/e20/739/a3c/e20739a3c429493aaed59b56ef375191.jpg"></div><br>  In the age of cloud technologies, when each user has his own cloud for storing photos, and companies rent servers for cloud computing, the question arises about the confidentiality of stored information.  And if users can trust the cloud or the use of crypto containers to protect stored data, companies are worse off.  Since not only the data warehouse is transferred to the clouds, but also the calculations themselves. <br>  Protection of virtual machines is particularly affected, since in the event of a host compromise, it will not be difficult to gain access to the VM.  Until recently, none of the hypervisors, whether VMware, Xen, Hyper-V, provided any significant technologies to protect the VM. <br><a name="habracut"></a><br>  And if the attacker gets physical access to the server, only disk encryption can save, and not only in all cases.  Of course, when renting a server, a part of the security measures takes over the data center.  But in this case, you need to trust the administrators of the data center. <br><br>  With the release of Windows Server 2016, Microsoft decided to pay more attention to the security of the host and the virtual infrastructure.  You can now isolate VMs from a Hyper-V host administrator.  And using virtual TPM, it became possible to encrypt VM data using bitlocker. <br><br>  Thus, using new technologies, you can place virtual machines on uncontrolled servers or in corporate data centers, but with an increased level of security, differentiating the roles of physical and virtual access. <cut>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <b>Used technologies</b> </h4><br>  <b>Shielded VM</b> - technology isolating the virtual machine from the host.  Protects VMs from accidental or intentional actions of the host administrator and from malicious software. <br>  Shielded VM requires Host Guardian Service (HGS) server, which issues VM access keys and checks the health of the Hyper-V host. <br><br>  HGS supports two types of certification: <br><br><ol><li>  TPM-trusted certification - the verification is based on the TPM identifier, the OS boot sequence and the code integrity policy.  This way you can be sure that only approved code is working on the host. </li><li>  Admin-trusted certification - validation is based on membership in an Active Directory security group. </li></ol><br>  <i>HGS work pattern</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/fb5/8d6/470/fb58d64708c94466abaacdacd8a9e4dc.png"></div><br>  When you start a virtual machine, the secure host is certified by the HGS server, which decides on the transfer of access keys to the virtual machine. <br><br>  Admin-trusted certification is advisable to use within the enterprise when it is necessary to isolate access to the VM from administrators. <br><br>  TPM-trusted attestation is better to use when hosting a VM on a leased server, in order to ensure data and VM isolation from Data Center employees. <br><br>  Communication between the HGS server and the secure host is carried out via the http (https) protocol.  HTTPS is not required to ensure secure communication, but if you want to enable HTTPS, you will need an additional certificate.  In the case of AD attestation, you must additionally configure a one-way domain trust. <br><br>  <b>Virtual Secure Mode (VSM)</b> is a virtualization-based technology that allows you to isolate security-critical operations in a mini-OS. <br><br>  Two other technologies work on VSM: <br><br><ol><li>  Device Guard - check of UEFI firmware data and kernel mode drivers (code integrity monitoring). </li><li>  Credential Guard - user authentication process isolation (LSA). </li></ol><br>  <i>How VSM works</i> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/57c/934/88e/57c93488efdf439eacc8f2623d1521bb.png" height="300"></div><br><br>  The main OS runs in a virtual environment.  And the hypervisor acts as a host OS, thereby limiting access to RAM.  As a result, the malware running on the host, even with administrative rights, will not be able to access the VSM memory.  Also, such a structure should protect against attacks on DMA ports. <br><br><h4>  <b>About the organization Shielded VM</b> </h4><br>  Ordering a Shielded VM means that the Hyper-V host and the HGS server are on the data center side (as organized in Microsoft Azure).  In this case, you can create a shielded virtual machine yourself or using the template provided. <br><br>  By creating a Shielded VM, the customer independently on his PC unwraps and configures the VM, and then encrypts the key with the key issued by the Data Center.  After transferring the VM to the Data Center. <br><br>  In the second case, the customer creates only a PDK file that protects the VM created from the template.  The PDK file links the template file with the HGS server.  But you need to make sure that there is no malware in the template. <br><br>  The first method looks more secure, since the VM data file gets to the host in an already encrypted form.  In any case, the access keys to the VM do not reach the data center administrators in the open form. <br><br>  The only place to be attacked was the HGS server.  Because: <br><br><ul><li>  The HGS administrator can lower the security policy requirements. </li><li>  An attacker with administrative rights can try to get access keys. </li><li>  HGS requires AD to work, and there is no requirement for the mandatory presence of TPM, therefore, the keys are most likely to be stored in clear text. </li></ul><br>  Based on this, the idea was to verify the ability of the Shielded VM to work under conditions where the HGS server is located in its infrastructure.  This will further protect the virtual machines.  Also, this method can be used if the Data Center does not provide the Shielded VM service.  The disadvantage of this approach is that you have to independently administer this structure. <br><br>  There may be a question about the replacement of the HGS server by the administrator of the hypervisor - for this you just need to specify a new address.  Protection against this is implemented quite simply, the VM created is encrypted using the public key of the HGS server, so another HGS server will not be able to issue keys to launch it. <br><br>  You should also understand that the Shielded VM technology encrypts only the configuration files of the virtual machine.  The vhdx file remains unencrypted.  To encrypt it, you need to enable vTPM, and encrypt the disk with a bitlocker. <br><br>  The combination of new technologies provides reliable protection: <br><br><ul><li>  human factor eliminated; </li><li>  keys are transmitted in encrypted form; </li><li>  servers are protected by new technologies that provide code integrity checks; </li><li>  white list of allowed applications; </li><li>  VM isolation from host. </li></ul><br>  This all protects very well against malware targeted at the Hyper-V host and provides access to the VM only to the owner, protecting it from the actions of administrators or anyone who has received administrative rights. <br><br><h5>  <b>Hyper-V and HGS server requirements</b> </h5><br>  Requirements are indicated for the use of TPM certification.  AD certification is less demanding, but it provides much less protection. <br><br>  <b>Hgs:</b> <br><ul><li>  Windows Server 2016 </li></ul><br>  <b>Hyper-V:</b> <br><ul><li>  Windows Server 2016 Datacenter Edition </li><li>  UEFI Secure Boot </li><li>  TPM v2 </li><li>  IOMMU (VT-d) </li></ul><br><h4>  <b>How to setup</b> </h4><br>  For example, an option will be considered: you have rented a dedicated server and want to secure it.  TPM certification will be used.  The connection between the host and the HGS will be via the http protocol.  If the HGS server does not have a white IP, you will need to forward port 80 or use reverse proxy. <br><br><h4>  <b>Adding and configuring HGS server roles</b> </h4><br><h5>  <b>Install HGS server and create domain</b> </h5><br>  <i>Install-WindowsFeature -Name HostGuardianServiceRole -IncludeManagementTools -Restart</i> <br><br>  HGS requires a domain to work.  It can be connected to an existing domain, but it is recommended to create a separate domain for increased security.  Before executing the following command, you must make sure that the computer is not connected to the domain. <br><br><pre><code class="hljs perl">$adminPassword = ConvertTo-SecureString -AsPlainText <span class="hljs-string"><span class="hljs-string">'&lt;password&gt;'</span></span> -Force Install-HgsServer -HgsDomainName <span class="hljs-string"><span class="hljs-string">'relecloud.com'</span></span> -SafeModeAdministratorPassword $adminPassword -Restart</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/6e4/eb8/81f/6e4eb881f2494604b4ba2885021a02b5.png"></div><br><br><h5>  <b>Creating self-signed certificates</b> </h5><br>  Self-signed certificates were created for the test, but for a real environment it is better to use PKI. <br><br><pre> <i><code class="hljs php">$certificatePassword = ConvertTo-SecureString -AsPlainText <span class="hljs-string"><span class="hljs-string">'&lt;password&gt;'</span></span> -Force $signingCert = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SelfSignedCertificate -DnsName <span class="hljs-string"><span class="hljs-string">"signing.relecloud.com"</span></span> Export-PfxCertificate -Cert $signingCert -Password $certificatePassword -FilePath <span class="hljs-string"><span class="hljs-string">'C:\signingCert.pfx'</span></span> $encryptionCert = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-SelfSignedCertificate -DnsName <span class="hljs-string"><span class="hljs-string">"encryption.relecloud.com"</span></span> Export-PfxCertificate -Cert $encryptionCert -Password $certificatePassword -FilePath <span class="hljs-string"><span class="hljs-string">'C:\encryptionCert.pfx'</span></span></code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/b99/1bd/816/b991bd816fc74a18b4afc82f1998e32d.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/fcb/ca1/010/fcbca1010b864398b5219ff062bb3065.png"></div><br><h5>  <b>HGS server initialization</b> </h5><br>  Specify encryption and signature certificates.  Choose the method of certification. <br><br><pre> <i><code class="hljs perl">$certificatePassword = ConvertTo-SecureString -AsPlainText <span class="hljs-string"><span class="hljs-string">'&lt;password&gt;'</span></span> -Force Initialize-HgsServer -HgsServiceName <span class="hljs-string"><span class="hljs-string">'&lt;HgsServiceName&gt;'</span></span> -SigningCertificatePath <span class="hljs-string"><span class="hljs-string">'C:\signingCert.pfx'</span></span> -SigningCertificatePassword $certificatePassword -EncryptionCertificatePath <span class="hljs-string"><span class="hljs-string">'C:\encryptionCert.pfx'</span></span> -EncryptionCertificatePassword $certificatePassword [-TrustActiveDirectory | -TrustTPM]</code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/f6d/668/1e9/f6d6681e90a440fb971bb950c3b4e9b0.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9e9/468/323/9e946832310246aeb3b4e8d921e05382.png"></div><br><br><h4>  <b>Adding a secure Hyper-V host</b> </h4><br><h5>  <b>Get TPM ID</b> </h5><br>  This procedure must be performed for each protected host. <br><br><pre> <i><code class="hljs pgsql">(<span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-PlatformIdentifier -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;HostName&gt;'</span></span>).InnerXml | <span class="hljs-keyword"><span class="hljs-keyword">Out</span></span>-file &lt;<span class="hljs-type"><span class="hljs-type">Path</span></span>&gt;&lt;HostName&gt;.xml -<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span> UTF8</code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/0af/091/edd/0af091edd7e7476f850b92c64576585a.png"></div><br>  Add the resulting file to the HGS server <br><br><pre> <i><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>-HgsAttestationTpmHost -<span class="hljs-type"><span class="hljs-type">Path</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Path</span></span>&gt;&lt;Filename&gt;.xml -<span class="hljs-type"><span class="hljs-type">Name</span></span> &lt;HostName&gt; -Force</code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/9f2/931/19f/9f293119f71844a699adeaf76a735fd3.png"></div><br><br><h5>  <b>Create and apply the Code Integrity Policy</b> </h5><br>  When creating a policy, all installed programs are scanned and added to the white list.  Before creating a policy, you must make sure that in the system: <br><br><ul><li>  There are no viruses and malware. </li><li>  The necessary software is installed and it is trustworthy. </li></ul><br>  It is recommended that you first test the policy in audit mode.  In this case, the executable file prohibited by the policy will be displayed in the log. <br><br>  Scanning will take some time. <br><br><pre> <i><code class="hljs tex">New-CIPolicy -Level FilePublisher -Fallback Hash -FilePath 'C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temp</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HW</span></span></span></span>1CodeIntegrity.xml' -UserPEs ConvertFrom-CIPolicy -XmlFilePath 'C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temp</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HW</span></span></span></span>1CodeIntegrity.xml' -BinaryFilePath 'C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temp</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HW</span></span></span></span>1CodeIntegrity.p7b'</code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/306/521/d5d/306521d5d8134a68a224391e123dbf19.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/dbc/c3e/c9e/dbcc3ec9e3dd4d8d9eb007d57619b34e.png"></div><br>  The .p7b file must be renamed to SIPolicy.p7b and copied to the <b>C: \ Windows \ System32 \ CodeIntegrity \ SIPolicy.p7b folder</b> <br><br>  Reboot the computer and check the operation of the system under the planned typical load.  After successful verification of the system, disable the audit mode <br><br><pre> <i><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-RuleOption -FilePath <span class="hljs-string"><span class="hljs-string">'C:\temp\HW1CodeIntegrity.xml'</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">Option</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">Delete</span></span> ConvertFrom-CIPolicy -XmlFilePath <span class="hljs-string"><span class="hljs-string">'C:\temp\HW1CodeIntegrity.xml'</span></span> -BinaryFilePath <span class="hljs-string"><span class="hljs-string">'C:\temp\HW1CodeIntegrity_enforced.p7b'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>-Item -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;Path to HW1CodeIntegrity\_enforced.p7b&gt;'</span></span> -Destination <span class="hljs-string"><span class="hljs-string">'C:\Windows\System32\CodeIntegrity\SIPolicy.p7b'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Restart</span></span>-Computer</code></i> </pre> <br>  If several identical hosts are to be protected, the policy can be created only once. <br><br>  It is recommended to leave the source XML file in order to change the policy in case of need not to re-scan. <br><br>  When policy is enabled, you need to be careful about updating or adding kernel-mode drivers, as this may prevent the system from booting. <br><br><h5>  <b>We register policy on HGS server</b> </h5><br><pre> <i><code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>-HgsAttestationCIPolicy -<span class="hljs-type"><span class="hljs-type">Path</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Path</span></span>&gt; -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;PolicyName&gt;'</span></span></code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/1da/635/4f6/1da6354f617341ba873e4b6771728090.png"></div><br><br><h5>  <b>Creating a TPM baseline policy</b> </h5><br>  This policy is based on the PCR registers (Platform Configuration Registers) located in the TPM module.  They store the integrity of system metrics, starting with loading the BIOS and ending the system.  If the boot order is changed, for example, by a rootkit, it will appear in the PCR registers. <br><br>  A policy is created for a class of identical hardware hosts.  Before creating it, you must have Hyper-V installed. <br><br><pre> <i><code class="hljs pgsql">Install-WindowsFeature Hyper-V, HostGuardian -IncludeManagementTools -<span class="hljs-keyword"><span class="hljs-keyword">Restart</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-HgsAttestationBaselinePolicy -<span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-string"><span class="hljs-string">'HWConfig1.tcglog'</span></span></code></i> </pre> <br>  For this command, you must enable Secure Boot, IOMMU (VT-d), Virtualization Based Security. <br><br>  You can use the -SkipValidation flag to allow the command to execute, but it will not fix the error. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/104/dd2/026/104dd20264f54ef28b60803a36d3a692.png"></div><br><br><h5>  <b>Add TCGlog file to HGS server</b> </h5><br><pre> <i><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>-HgsAttestationTpmPolicy -<span class="hljs-type"><span class="hljs-type">Path</span></span> &lt;Filename&gt;.tcglog -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;PolicyName&gt;'</span></span></code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/e1e/96c/7fb/e1e96c7fbc2a453f904103e21e879bf6.png"></div><br><br><h4>  <b>Checking the status of the HGS server</b> </h4><br>  At this point, setting up the HGS server ends.  To check the work performed we will carry out diagnostics. <br><br><pre> <i><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-HgsTrace -RunDiagnostics</code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/3ad/0d6/6b1/3ad0d66b1e984610a48a6165daa80853.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9af/e36/f54/9afe36f54c3346a898e2e8ecc1d45f0d.png"></div><br><br><h4>  <b>We connect the Hyper-V host to the HGS server</b> </h4><br>  To connect the protected host to the HGS server, simply enter the URL address of the server. <br><br><pre> <i><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-HgsClientConfiguration -AttestationServerUrl <span class="hljs-string"><span class="hljs-string">'http://&lt;FQDN&gt;/Attestation'</span></span> -KeyProtectionServerUrl <span class="hljs-string"><span class="hljs-string">'http://&lt;FQDN&gt;/KeyProtection'</span></span></code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/429/2db/9c3/4292db9c3b3e4a0296bbb145d80df2a8.png"></div><br><br>  When properly configured, it should be: <br><br><ul><li>  IsHostGuarded: true </li><li>  AttestationStatus: passed </li></ul><br>  If something is configured incorrectly, the reason will be indicated in AttestationStatus. <br><br><h4>  <b>Creating a shielded virtual machine</b> </h4><br>  We get the HGS server description file, which is needed to bind the VM to the server. <br><br><pre> <i><code class="hljs pgsql">Invoke-WebRequest http://&lt;"HGSServer"&gt;FQDN&gt;/KeyProtection/service/metadata/<span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-07</span></span>/metadata.xml -OutFile C:\HGSGuardian.xml</code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/47b/167/8f7/47b1678f7c2a4ca08176760b0b676dca.png"></div><br>  You need to create VMs on a separate machine running Windows Server 2016, which is not configured to use HGS. <br><br>  We create a new VM of the second generation, install the OS on it, configure RDP and check its performance, encrypt it with a Bitlocker. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/287/740/065/28774006500740acb50c4cbfb5184ce7.png" height="300"></div><br><br><h5>  <b>VM screening</b> </h5><br>  Set the name of VM <br><br><pre> <i><code class="hljs perl">$VMName = <span class="hljs-string"><span class="hljs-string">'SVM'</span></span></code></i> </pre> <br>  Turn off the VM <br><br><pre> <i><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">Stop</span></span>-VM ‚ÄìVMName $VMName</code></i> </pre> <br>  Create an owner certificate <br><br><pre> <i><code class="hljs php">$Owner = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-HgsGuardian ‚ÄìName <span class="hljs-string"><span class="hljs-string">'Owner'</span></span> ‚ÄìGenerateCertificates</code></i> </pre> <br>  Import server certificate <br><br><pre> <i><code class="hljs perl">$Guardian = Import-HgsGuardian -Path <span class="hljs-string"><span class="hljs-string">'C:\HGSGuardian.xml'</span></span> -Name <span class="hljs-string"><span class="hljs-string">'TestFabric'</span></span> ‚ÄìAllowUntrustedRoot</code></i> </pre> <br>  Create Key Protector <br><br><pre> <i><code class="hljs php">$KP = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-HgsKeyProtector -Owner $Owner -Guardian $Guardian -AllowUntrustedRoot</code></i> </pre> <br>  Turn on screening <br><pre> <i><code class="hljs perl">Set-VMKeyProtector ‚ÄìVMName $VMName ‚ÄìKeyProtector $KP.RawData Set-VMSecurityPolicy -VMName $VMName -Shielded $true</code></i> </pre> <br>  Turn on vTPM in the virtual machine <br><br><pre> <i><code class="hljs perl">Enable-VMTPM -VMName $VMName</code></i> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/b71/a3d/09a/b71a3d09a4af425d8e865e121c9d969a.png"></div><br>  After setting up and enabling protection in the VM, it must be moved to a guarded host.  To do this, export the machine, transfer the received files to the host, and import it into the Hyper-V console. <br><br>  At this stage, the configuration is completed, the VM is shielded. <br><br><h5>  <b>We check the work of Shielded VM</b> </h5><br>  When you try to connect to the VM via the Hyper-V console, we will see the message: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/143/1c1/92f/1431c192fcfa4691adac67077c5b1737.png" height="300"></div><br>  Also, in the VM settings, we will see a warning about the impossibility of changing the protection settings: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/ba6/6a3/52f/ba66a352f7414546888e221e1884d910.png" height="400"></div><br>  The virtual machine partition is protected by BitLocker: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0a8/451/151/0a8451151ad74ba1b848549ac668db57.png" height="300"></div><br>  Thus, Shielded VM was configured, which provides a higher level of protection for virtual machines.  If you have any questions, welcome to the comments. <br><br>  <a href="http://servilon.ru/stati/">More articles on Servilon</a> </cut></div><p>Source: <a href="https://habr.com/ru/post/315972/">https://habr.com/ru/post/315972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315962/index.html">The release of CLion 2016.3: improved support for C11, C ++ 11 and C ++ 14, changes in working with the CMake design model and much more</a></li>
<li><a href="../315964/index.html">About types of used routers on MSK-IX and W-IX</a></li>
<li><a href="../315966/index.html">Create a simple VR demo with the Unreal Engine</a></li>
<li><a href="../315968/index.html">How we made a bot for the bank "Opening"</a></li>
<li><a href="../315970/index.html">The technique of total prescale in the lighting algorithm for a 2D 2D tile game</a></li>
<li><a href="../315974/index.html">A person. Guido Van Rossum - Python Creator</a></li>
<li><a href="../315976/index.html">The train coming late: Announcement of the JPoint 2017 Java Conference</a></li>
<li><a href="../315978/index.html">As I wrote the visualization system for the stand</a></li>
<li><a href="../315982/index.html">Information on the threshold of immortality</a></li>
<li><a href="../315984/index.html">How we reduced staff over Wi-Fi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>