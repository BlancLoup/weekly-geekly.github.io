<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Strace</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I thought about the title for a minute, so I didn‚Äôt think of anything ... 
 Strace. Probably not the person who would not hear about strace. If someon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Strace</h1><div class="post__text post__text-html js-mediator-article">  I thought about the title for a minute, so I didn‚Äôt think of anything ... <br>  Strace.  Probably not the person who would not hear about strace.  If someone has not heard, then strace is a utility that tracks system calls, which is a translation mechanism that provides the interface between the process and the operating system (kernel).  These calls can be intercepted and read.  This allows you to better understand what the process is trying to do at a given time.  By intercepting these challenges, we can achieve a better understanding of the behavior of processes, especially if something goes wrong.  The functionality of the operating system to track system calls is called ptrace.  Strace calls ptrace and reads the behavior of the process, returning a report.  Details can be found in the <a href="http://en.wikipedia.org/wiki/Strace">wiki</a> or the <a href="http://man7.org/linux/man-pages/man1/strace.1.html">official man</a> .  Actually, well, it's certainly about Linux.  In other OS, its counterparts. <br>  So, for me personally, strace is like a last resort.  When all the logs have already been viewed, all the debug and verbose keys are turned on, and the cause of the problems has not been found, I <s>pull strace out of wide pants</s> .  There is one thing, strace is a tool that is not at all a silver bullet, which will immediately show and tell everything.  To work with strace requires the presence of certain knowledge and the wider and deeper this knowledge, the greater the likelihood of finding a problem. <br>  The Internet is full of introductory articles that describe examples of running strace.  In this article I will show private problems and their solution using strace. <br><a name="habracut"></a><br>  <b>The first case.</b>  The KVM virtual machine <i>does</i> not start with the <i>vhost = on</i> setting for network interfaces enabled.  If you omit this parameter, the virtual machine starts successfully. <br>  So for starters, I cut off all unnecessary parameters and left only the required options and parameters for creating a network interface.  This is necessary not to increase the already volumetric output of strace: <br>  # qemu-system-x86_64 -m 4096 -netdev tap, ifname = tap90, id = tap90, vhost = on -device virtio-net-pci, netdev = tap90, mac = 08: 77: D1: 00: 90: 90 <br>  qemu-system-x86_64: -netdev tap, ifname = tap90, id = tap90, vhost = on: <br>  qemu-system-x86_64: -netdev tap, ifname = tap90, id = tap90, vhost = on: <b>Device 'tap' could not be initialized</b> <br><br>  So, we run a virtual machine with strace and analyze the output.  I intend to omit most of the output and show only the part by which it is possible to determine the cause of the problem. <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># strace -f qemu-system-x86_64 -m 4096 -netdev tap,ifname=tap90,id=tap90,vhost=on -device virtio-net-pci,netdev=tap90,mac=08:77:D1:00:90:90 ... open("/dev/vhost-net", O_RDWR) = -1 ENOMEM (Cannot allocate memory) write(2, "qemu-system-x86_64:", 19qemu-system-x86_64:) = 19 write(2, " -netdev", 8 -netdev) = 8 write(2, " tap,ifname=tap90,id=tap90"..., 65 tap,ifname=tap90,id=tap90,vhost=on) = 65 write(2, ": ", 2: ) = 2 write(2, "vhost-net requested but could no"..., 48vhost-net requested but could not be initialized) = 48 write(2, "\n", 1 ) = 1 write(2, "qemu-system-x86_64:", 19qemu-system-x86_64:) = 19 write(2, " -netdev", 8 -netdev) = 8 write(2, " tap,ifname=tap90,id=tap90"..., 65 tap,ifname=tap90,id=tap90,vhost=on) = 65 write(2, ": ", 2: ) = 2 write(2, "Device 'tap' could not be initia"..., 37Device 'tap' could not be initialized) = 37 write(2, "\n", 1 ) = 1</span></span></code> </pre> <br>  As you can see, the error occurs in the <i>open ()</i> call when you try to open the device <i>/ dev / vhost-net</i> .  After that, error messages are printed that were observed with a simple start of the virtual machine. <br>  As a workaround, we had to reset page cache and buffers through running <i>echo 3&gt; / proc / sys / vm / drop_caches,</i> after which the virtual machine started up successfully.  Then some of the machines were transferred to other hosts, but this is another story. <br><br>  <b>The second case.</b>  And again, the virtual machine and looking ahead, I will say that here again is a memory issue.  By experience, it became clear that the virtual machine does not start with a large value of allocated memory.  In this case, <i>-m 10240</i> .  If you specify smaller values, the machine starts.  In this case, the free memory on the server is more than 10GB.  And again we uncover strace.  In the example below, I omit the entire list of virtual machine startup options and some of the unnecessary strace output. <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># strace -f qemu-system-x86_64 -m 10240 ... open(process_vm_readv: Bad address 0x7eff1ccf40b8, O_RDONLY) = 25 fstat(25, process_vm_readv: Bad address {...}) = 0 mmap(NULL, 26244, PROT_READ, MAP_SHARED, 25, 0) = 0x7eff1e74c000 close(25) = 0 futex(0x7eff1cf31900, FUTEX_WAKE_PRIVATE, 2147483647) = 0 mprotect(0x7eff0c021000, 24576, PROT_READ|PROT_WRITE) = -1 ENOMEM (Cannot allocate memory) mmap(NULL, 134217728, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7efc72bfd000 munmap(0x7efc72bfd000, 20983808) = 0 munmap(0x7efc78000000, 46125056) = 0 mprotect(0x7efc74000000, 163840, PROT_READ|PROT_WRITE) = -1 ENOMEM (Cannot allocate memory) munmap(0x7efc74000000, 67108864) = 0 mmap(NULL, 32768, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = -1 ENOMEM (Cannot allocate memory) mprotect(0x7eff0c021000, 24576, PROT_READ|PROT_WRITE) = -1 ENOMEM (Cannot allocate memory) mmap(NULL, 134217728, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7efc72bfd000 munmap(0x7efc72bfd000, 20983808) = 0 munmap(0x7efc78000000, 46125056) = 0 mprotect(0x7efc74000000, 163840, PROT_READ|PROT_WRITE) = -1 ENOMEM (Cannot allocate memory) munmap(0x7efc74000000, 67108864) = 0 write(2, process_vm_readv: Bad address 0x7eff0c00e000, 77 (process:10928): GLib-ERROR **: gmem.c:230: failed to allocate 131072 bytes) = 77 --- SIGTRAP {si_signo=SIGTRAP, si_code=SI_KERNEL, si_value= int=487903808, ptr=0x7eff1d14d240}} --- &lt;... syscall_16 resumed&gt; ) = ? &lt;unavailable&gt; +++ killed by SIGTRAP +++ Trace/breakpoint trap</span></span></code> </pre><br>  And again already known Cannot allocate memory, but already in <i>mprotect ()</i> .  We are looking for and find what limits us sysctl key <i>vm.overcommit_memory</i> with a value of 2. Change to 0 and the machine starts successfully. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>The third case.</b>  There is some process that works for some time, then suddenly begins to consume CPU resources.  Load average rises from 0.5 to 1.5 (in the system, and this is a virtual machine with only 2 virtual processors).  Latency increases, service responsiveness drops.  When restarting the process, after some time the situation repeats.  The time elapsed since the start and before the failure is always different.  So, we connect strace to the process at the moment when the process starts to behave incorrectly.  And here we see a lot of messages like: <br><pre> <code class="bash hljs">ppoll([{fd=10, events=POLLIN|POLLPRI}], 1, {0, 90000000}, NULL, 8) = 1 ([{fd=10, revents=POLLIN}], left {0, 90000000}) rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0 epoll_wait(10, {{EPOLLIN, {u32=57661216, u64=57661216}}}, 4096, 0) = 1 rt_sigprocmask(SIG_SETMASK, ~[SEGV VTALRM RTMIN RT_1], NULL, 8) = 0 accept(15, 0x7ffff8f46af0, [16]) = -1 EMFILE (Too many open files)</code> </pre><br>  The <i>accept ()</i> system call fails with the error "EMFILE (Too many open files)".  We look at the process limits in <i>/ proc / pid / limits</i> and check the number of open files with <i>lsof</i> . <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep files /proc/12345/limits Max open files 1024 1024 files # lsof -nPp 12345 |wc -l 1086</span></span></code> </pre><br>  The limit of open files is 1024, and the current number of files opened by the process, slightly exceeds the limit value.  Everything is clear here, first with the help of <i>prlimit we</i> increase the limit value of the running process, and then we fix the limits on completely through editing <i>/etc/security/limits.conf</i> . <br><br>  <b>The fourth case</b> .  There should be a small digression.  Here we look at the <i>pgBouncer - PostgreSQL binding</i> .  The application works with the database through pgBouncer, i.e.  connects to it, pgBouncer issues a connection to the database from the pool, the application does its work, disconnects, and the connection returns to the pool and remains until issued to the next client. <br>  So the problem is, in the application log and in the postgres log, messages began to appear that transactions in the database cannot update / delete / insert data, because  transaction is in READ ONLY mode. <br>  During the search, several hypotheses were put forward, one of them later proved to be correct.  The client connecting to the puller sets the session to READ ONLY mode.  After disconnecting the client, this setting sticks to the server connection and lives with it until pgBouncer forcibly completes this connection.  If you specify server_reset_query = DISCARD ALL in the pgBouncer settings, then when disconnected, all session-based settings will be reset.  Thus, someone put up a READ ONLY session, it was saved and then this connection got to other clients.  In general, DISCARD ALL was a temporary solution while looking for the culprit.  The search was long and the suspicions lay on the application, but the developers assured that they checked all the places in the code and did not reveal any problem areas ... <br>  We get strace, connect to pgBouncer and wait. <br>  Catch by keyword READ ONLY.  And the output is saved in a separate log.  Since after the discovery will have to delve into it. <br>  So it took some time and here it is: <br><pre> <code class="bash hljs">recvfrom(10, <span class="hljs-string"><span class="hljs-string">"Q\0\0\0:SET SESSION CHARACTERISTICS AS TRANSACTION READ ONLY;\0"</span></span>, 2048, 0, NULL, NULL) = 59 sendto(11, <span class="hljs-string"><span class="hljs-string">"Q\0\0\0:SET SESSION CHARACTERISTICS AS TRANSACTION READ ONLY;\0"</span></span>, 59, 0, NULL, 0) = 59 sendto(10, <span class="hljs-string"><span class="hljs-string">"C\0\0\0\10SET\0Z\0\0\0\5T"</span></span>, 15, 0, NULL, 0) = 15</code> </pre><br>  We are waiting for some more time (we catch other requests of the same client), turn off strace and open our log. <br>  Here the most important descriptor numbers, in particular, the descriptor number 10 (note the <b>recvfrom (10</b> ). You need to find who opened these descriptors that preceded the captured message, some <i>grep</i> and here it is. <i>Accept ()</i> system call ( <b>accept (...) = 10</b> ) opens the same descriptor number 10. <br><pre> <code class="bash hljs">accept(8, {sa_family=AF_INET, sin_port=htons(58952), sin_addr=inet_addr(<span class="hljs-string"><span class="hljs-string">"192.168.10.1"</span></span>)}, [16]) = 10 getpeername(10, {sa_family=AF_INET, sin_port=htons(58952), sin_addr=inet_addr(<span class="hljs-string"><span class="hljs-string">"192.168.10.1"</span></span>)}, [16]) = 0 getsockname(10, {sa_family=AF_INET, sin_port=htons(6432), sin_addr=inet_addr(<span class="hljs-string"><span class="hljs-string">"192.168.10.10"</span></span>)}, [16]) = 0</code> </pre><br>  In a conversation with the developers, it turned out that the address 192.168.10.1 belongs to the VPN server through which the developers were connected.  After conducting educational conversations and the adoption of organizational measures, the problem no longer manifested itself. <br><br>  That's it.  Thank you all for your attention. </div><p>Source: <a href="https://habr.com/ru/post/215577/">https://habr.com/ru/post/215577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215559/index.html">Valve has unveiled the source for the Direct3D translator in OpenGL</a></li>
<li><a href="../215567/index.html">When the star goes out: an interview with Jim Weirich</a></li>
<li><a href="../215569/index.html">Secure Active Directory management. Part 1</a></li>
<li><a href="../215573/index.html">We lift the domain controller on Ubuntu Server</a></li>
<li><a href="../215575/index.html">Sir Tim Berners-Lee: The World Wide Web is 25 years old. Keep it free and open.</a></li>
<li><a href="../215581/index.html">As I bought, I finished and set up a Chinese 3D printer Wanhao Duplicator 4</a></li>
<li><a href="../215585/index.html">Network detectives: looking for the causes of traffic surges and load</a></li>
<li><a href="../215587/index.html">About the correct work of BA in a financial institution</a></li>
<li><a href="../215591/index.html">Automate the installation of many apk files on Android</a></li>
<li><a href="../215597/index.html">The note. On the lag of information progress from technological</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>