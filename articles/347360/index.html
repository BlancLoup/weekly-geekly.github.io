<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we built the data infrastructure in Wish</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I came to Wish 2.5 years ago, things were going great in the company. Our application was in the top in iOS and Android stores and sold more than 2 mi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we built the data infrastructure in Wish</h1><div class="post__text post__text-html js-mediator-article">  I came to Wish 2.5 years ago, things were going great in the company.  Our application was in the top in iOS and Android stores and sold more than 2 million products a day. <br><br>  Few people believed that you could build a big business by selling cheap goods.  However, using the data, Wish was able to challenge these doubts.  Data analytics has always been in our blood. <br><br>  But when our business began to grow at a tremendous pace, we were not ready for this, we discovered many problems with analytics.  Each team within the company began to need urgent support in working with data and lost a lot of things in its field of activity.  At that time, our analytical capabilities were still in its infancy and could not satisfy the ever-increasing demand. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this post, I will talk about the lessons we have learned during this time, and also sign for the right path for companies looking for ways to scale their analytical functions. <br><br><img src="https://habrastorage.org/webt/do/ny/cs/donycsoabedo1blgyjdrgd6q45q.jpeg"><br><a name="habracut"></a><br>  There were many problems, primarily with access to data.  The only ones who could extract data and build reports were the engineers working on the product, and since the data infrastructure was completely raw, we could not hire analysts to help.  As a result, the execution of data queries and report building could take weeks. <br><br>  Over the next 2 years, we worked tirelessly to build analytics in the company.  We have built a data pipeline from scratch that allows engineers, analysts and data scientists to perform ETL processes reliably and safely for their work.  The data warehouse was collected in <a href="https://aws.amazon.com/ru/redshift/">Redshift</a> and <a href="https://cloud.google.com/bigquery/">BigQuery</a> with core tables that support secondary tables used by analysts.  We also deployed the BI <a href="https://looker.com/">Looker</a> platform, which is now used as a company‚Äôs data source, which means more than 200 employees on three continents. <br><br>  To date, more than 30 people at Wish are engaged in analytics.  This year we plan to double their number.  We are confident that now our processes and systems are well scalable, which means we are ready for future challenges. <br><br><h3>  Break the foundation and build a new one. </h3><br>  Let's start with the early days.  When I came to the company, it was quite obvious that we had huge problems with the way we work with the data: <br><br><img src="https://habrastorage.org/webt/9q/3v/o9/9q3vo9ocjl3wlzcn6rbidpo9ehm.jpeg"><br>  <sub>Initial data system</sub> <br><br>  First, the creation of data queries was nightmarish, despite the fact that by that time our <a href="https://www.mongodb.com/">MongoDB</a> clusters were one of the largest in the world (top 3).  In order to ensure reliability, our infrastructure team has disabled aggregation requests in Mongo, that is, data aggregation should now be performed on the client side (in the Python script).  Instead of simple SUM and GROUP BY SQL queries, we wrote code in a Python script, which in turn processed each of the millions of documents, storing the results in a dictionary that contains other dictionaries.  Needless to say, such requests were hard to write, and they started forever. <br><br>  The data pipeline situation was not much better.  The system was too simple, and there were no key functions in it that would allow managing a huge number of ETL tasks, for example, there were problems with dependency management.  The flow of failures and errors practically did not stop, and as a result, the whole working day had to be devoted to the fight against them. <br><br>  Obviously, it was necessary to redo the infrastructure, move the pipeline data to a more scalable and reliable platform, and also build a separate data warehouse for analysts to speed up the creation of queries and reports. <br><br>  The fact that I was one of only two employees in a company with a focus on analytics made the task much more complicated.  I was torn between supporting the current pipeline, creating a huge number of reports and data requests, and still needed to find time to restructure the infrastructure.  Thus, I periodically switched from data engineering to analytical tasks and vice versa, that is, I dealt with two areas at the same time, each of which requires special skills and thinking style.  Trying to be in time everywhere, I'm not sure that I did well with both. <br><br>  Finally, we managed to hire our first, serious data analysts, and that saved us.  We were lucky that they were technically savvy enough to write ad-hoc requests for MongoDB and work with our reports in Python.  They were also experienced enough to deal with undocumented and new data sources.  This means that they could take on some of the responsibilities that I was under. <br><br>  Over the next year, we built infrastructure on Wish.  While analysts were engaged in processing data requests from all over the company, I could concentrate on building a new system. <br><br>  It is impossible to imagine that someone from our pair ‚ÄúI am a team of analysts‚Äù stretched out in the company for a long time, do not be different.  Two problems we worked on: data extraction / building of reports and improvement of infrastructure were complex in their own way and required so different kinds of skills that each of us could not be good enough to do the work of the other. <br><br>  The main thing that needs to be learned from this part is that when creating a team for working with data, you must have both a data engineer and an analyst (s).  Without at least one analyst, the data engineer will drown in creating reports and extracting data, and without a data engineer, analysts, in turn, will fail with the number of queries from various complex data sources.  As a result, both must be experienced and patient while waiting for a decent system to be built. <br><br>  In the next two parts, I will talk in more detail about the challenges that analysts and engineers will meet, and how to handle them. <br><br><h3>  What is it like: come to us as one of the first data scientist? </h3><br><img src="https://habrastorage.org/webt/gz/v_/hf/gzv_hfuz9dcniwjubnichw6bway.jpeg"><br><br>  Being one of the first analysts on Wish meant taking on a huge amount of reports and data queries.  Let's start with the reports. <br><br>  Report generation is a system from Python scripts that generated HTML emails at regular intervals.  There were thousands of them, and they covered various systems and functions within the company. <br><br>  Ensuring that the scripts work, and the reports are sent on a schedule is a full-time job.  It is hard to process data and take into account all possible errors: typos, missing or incomplete data, display problems - all this daily hindered the normal sending of reports.  During the week there was simply not enough time to correct all the accumulated errors, so it was necessary to sort them by importance and correct only the most serious ones. <br><br>  Of course, simply maintaining the system was not enough.  The growth of the company has led to an increase in demand for new reports.  In addition, we only hired a new operations director, which means that all of our customer service reports needed to be redone.  We also launched new programs for sellers, such as Wish Express with 7-day delivery, and each of them required its own set of reports. <br><br>  Also, in addition to reports, the analyst had to somehow cope with the incessant flow of data requests from the entire company.  From experience, we knew that the rate of receipt of these requests is growing exponentially, so one of the main tasks was to prioritize the most important requests and screening unnecessary ones. <br><br>  Sure, it was hard.  The analyst has always been tempted to do something hastily in order to cope with the enormous amount of work, which led to errors and, consequently, a decrease in confidence in him. <br><br>  Thus, to succeed in this role, two skills are needed: <br><br><ul><li>  To be able to understand the system and make quality calculations. </li><li>  Deal with an incredible amount of data requests. </li></ul><br>  Below we will discuss these two skills in detail: why they are so difficult in the early stages and how to overcome these difficulties. <br><br><h3>  How not to send bad data </h3><br><img src="https://habrastorage.org/webt/uu/7k/wi/uu7kwiulwyyln5zak_0o-efqdyy.jpeg"><br>  <sub>Send bad data &lt;do nothing &lt;send good data</sub> <br><br>  Inexperienced analysts often try to create data queries without fully understanding how it works.  For example, let's say that we received a request to receive the current share of the returned goods.  The naive way is to find orders in the data model and see if they have a ‚ÄúReturned‚Äù field.  Then, filtering all the data for a certain period of time by this criterion, we can calculate this share: # returns / # orders.  Then we send this number. <br><br>  After some time, the answer comes from the authorities: now it is necessary to find out how the share of returned goods for goods with and without delivery confirmation differs.  Being the same naive analyst will use the same approach, find a separate data model for tracking orders and see that there is a ‚ÄúConfirmed delivery time‚Äù field that can be attached to orders from the first data model using the order id key. <br>  Finally, we write the same query as before, but with the condition of presence / absence of delivery confirmation time, in order to get two metrics: <br><br><ul><li>  The proportion of orders with delivery confirmation: X%. </li><li>  Percentage of orders without delivery confirmation: Y%. </li></ul><br>  Then we send.  It's pretty simple. <br><br>  However, did you notice a mistake? <br><br>  For Wish, cancellation of an order is also considered a return of the goods, and since cancellation means that the goods have not yet been delivered, such orders will always be in the second group - orders without confirmation of delivery.  As a result, the second metric will be greatly overestimated, which can lead to incorrect management decisions. <br><br>  This example is not invented, it really happened (fortunately, we quickly noticed an error).  Now I know from experience that every time I walked the fast path and worked with queries without understanding the system itself, I ended up sending the wrong numbers. <br><br>  To successfully avoid such traps, experience is needed.  Always working with a new metric or data source with which the analyst is not familiar, he must spend additional time understanding the data and the system itself.  And the first analysts in the company had to do this every time, since any new task meant working with unfamiliar data. <br><br>  Experienced analysts understand where there is no need to hurry, even under conditions of tremendous pressure and urgency. <br><br><h3>  How to cope with a huge number of requests </h3><br><img src="https://habrastorage.org/webt/xg/he/48/xghe481vxxouurdm0vl0cfs23mg.jpeg"><br>  <sub>Workload of analysts in startups</sub> <br><br>  Earlier in Wish, we were just a group of analysts and engineers who were supposed to support a business with a turnover of several million dollars a year.  The point here is not even in the number of people, we could be 20, and we still could not cope with a huge amount of data.  Therefore, we had to correctly prioritize, concentrate on the most important tasks and set aside everything else. <br><br>  Of course, easier said than done.  Why is one request more important than another?  Are all the bugs fixed before sending the request?  Which department needs help first?  To answer these questions, each request is evaluated according to two criteria: <br><br><ol><li>  The degree of influence of the request on the company. </li><li>  The amount of work needed to complete it. </li></ol><br>  First, before starting work on a request, it is necessary to assess its impact, that is, to think about how this task will affect the company.  For example, relevant questions: what areas of our business this task affects and what is the size of these areas?  What is the possible benefit?  What is the probability of successful completion of the task?  Is this important in terms of company strategy? <br><br>  Answering these questions, we compare the assessment of the importance of the task with the amount of work on its implementation.  We approximately imagined how much this or that task takes: fixing a bug takes from half to a full day, a report from 2 days to a week, and an ad-hoc data request takes half a day. <br><br>  Using this framework, we on Wish have prioritized incoming requests as follows: <br><br><ul><li>  Most often, <b>fixing bugs is</b> most important.  If someone asks to fix something, then most likely this is some useful feature.  Fixing a bug, we will improve the work of the company.  Moreover, this is quite fast, so this task has a very large ratio of importance to the volume of work. </li><li>  To <b>work with reports</b> need to be approached more carefully.  Adding a new metric to a report or creating a new one really helps shareholders make better decisions? </li><li>  Then there are <b>system improvements</b> , such as consolidating reports or allocating frequent settlements to a separate pipeline, as they have a good effect on business in the medium term, but have little effect in the short term.  Therefore, these tasks should be postponed until it threatens the functioning of the entire system. </li><li>  Finally, tasks <b>with no clear goal</b> have the lowest priority.  For example, when shareholders are not sure which problem needs to be solved, and just want to get data for analysis.  Such tasks need to be addressed last, since they rarely affect the operation of a business and most often require you to return to them several times. </li></ul><br>  Also, if the request has an impact on the business, but it requires more effort than necessary, then most often we cut some requirements from the task.  So, if the metric is too hard to count, then we simply remove it from the query. <br><br>  Thus, ranking the tasks in order of importance and focusing on tasks that require less effort to achieve greater results, we were able to achieve a lot in conditions of a critical lack of time. <br><br>  Summing up this part: data requests are hard to process, and they arrive at an incredible speed.  Even making everything perfect, sooner or later you will burn.  No analyst can hold such a pace for long enough. <br><br>  That is why it was necessary to take up data engineering.  We needed a quality infrastructure. <br><br><h3>  What is it like: come to us as one of the first data engineers? </h3><br><img src="https://habrastorage.org/webt/do/ny/cs/donycsoabedo1blgyjdrgd6q45q.jpeg"><br><br>  The MVP (Minimum Viable Product) data infrastructure consists of: <br><br><ul><li>  Data Pipeline to transfer data. </li><li>  Data warehouses, which is tailored to the needs of analysts. </li><li>  BI platform, with which analysts can quickly visualize data. </li></ul><br>  The presence of all these elements will lead to a significant increase in efficiency.  Creating a data source specifically for business analytics at Wish led to the fact that one request was 5-7 times less time to go.  It also allowed us to reduce the technical skills requirements of new analysts, which greatly accelerated hiring.  Now they could pump some skills later, if necessary. <br><br>  Implementing all this is not just an engineering problem.  So, we needed to convince shareholders of buying a ready-made BI platform, since the corporate culture of Wish is aimed at developing all that is needed on its own. <br><br>  Below I will describe how we developed infrastructure step by step, and what lessons I learned from this. <br><br><h3>  How we rebuilt the pipeline data </h3><br><img src="https://habrastorage.org/webt/jo/nk/pz/jonkpz8ik7eqzeov_jy0najaeuu.jpeg"><br><br>  As already mentioned, the existing Pipeline on Wish could not cope, so its restructuring was the primary task.  As a base framework, we chose Luigi - ETL tool, which is better in several aspects: <br><br><ul><li>  The current pipeline used cron-s to determine dependencies.  This method does not shine with elegance and causes many problems.  Luigi has built-in dependency management. </li><li>  Also, the problem with the old pipeline is that its errors lead to a waste of time due to manual restarts.  In turn, Luigi is idempotent, that is, remembers which tasks were successfully completed and restarts only the failed ones. </li><li>  Finally, in order to do all the work for the day, the pipeline took more than 24 hours, while Luigi has a scheduler that does not allow one ETL request to be run twice at the same time.  Consequently, we can distribute this request across several machines and halve the time of the program. </li></ul><br>  As a result, in 2 months I transferred more than 200 ETL jobs from the old system to the new one along with several cron scripts. <br><br>  Here is what I managed to take out for myself from this project: <br><br><ul><li>  Do not try to change a bunch of things at the same time. </li><li>  Changing the infrastructure, do not try to change the logic of the business. </li><li>  Automate code testing with validation scripts. </li></ul><br>  Also, the main risk when refactoring code is that you can get even more new bugs.  Transferring more than 200 job-s to the new platform, it was necessary to carefully check the system for the presence of bugs, otherwise everything would have collapsed. <br><br>  Thus, the easiest way is to gradually make small changes that are automatically checked for bugs.  Fundamental changes should be avoided until the project is fully ready.  In our case, this means: skip / block pipelines, comparing the result of their work with the old system. <br><br>  The new platform based on Luigi was quite primitive, but it worked and managed to cope with errors on its own, and this is exactly what we needed: a system that we can rely on, building the rest of the infrastructure. <br><br><h3>  Creating a data warehouse </h3><br><img src="https://habrastorage.org/webt/5s/6e/w4/5s6ew46isczflni4w5l1ocjrwi0.jpeg"><br><br>  Data storage is a database that allows you to write and run analytic queries more quickly.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usually it includes tables that are easier to understand. </font><font style="vertical-align: inherit;">For example, one of the most commonly used tables in our repository is called </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">merch_merchanttransaction</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Each line in it contains all the necessary analytics information about the order. </font><font style="vertical-align: inherit;">Instead of spending hours writing join-s in MongoDB, to retrieve the order + its id + information about the return of the goods, it was now possible to write queries to one table, which contains all the data about the order, spending a few minutes on it.</font></font><br><br>     ,       ,       . -,              . -,   ,     ,     ,        . <br><br>      3 .      ,     -      . <br><br>       Redshift.     Hive ( <a href="https://www.treasuredata.com/">TreasureData</a> )    ,           .  TreasureData    Redshift,      ,          Redshift . <br><br><h3>  BI  </h3><br><img src="https://habrastorage.org/webt/_n/ta/lx/_ntalxcv3zrt0vclczlqntlqd5c.jpeg"><br><br>          Python ,     HTML.       : <br><br><ul><li>       Python ,        . </li><li>          ,   ,         BI .         . </li></ul><br>    ,    : <br><br><ul><li>        ‚Äî    ,    . </li><li>    ,   ,  ,      ,     . </li><li>           -  .   -     ,   . </li></ul><br>     ,    BI-,       . <br><br>        .      :     CTO,      BI-,         ,    ( )   . ,    ‚Äî  ,       . <br><br>   ,        ,           Looker.         2 .       : <br><br><ol><li>       ( )  ,     Looker,         . </li><li>       -. </li><li>     ‚Äî    ,    . </li><li>   Looker   ,        (4 ). </li><li>   4 ,        (20 ). </li><li>   CTO  ,    ROI ,        Looker. </li></ol><br>      ,    ,   ,      ,   .   ,  , ,            ,  -      . <br><br><img src="https://habrastorage.org/webt/9q/3v/o9/9q3vo9ocjl3wlzcn6rbidpo9ehm.jpeg"><br> <sub>  </sub> <br><br>  ,  Looker,         Wish. ,   ,         , , ,    ,     . <br><br>      ,    ,      data engineering-  Wish! </div><p>Source: <a href="https://habr.com/ru/post/347360/">https://habr.com/ru/post/347360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347348/index.html">LittleFS is a compact and economical file system for ARM microcontrollers comprising mbed os. Fast start</a></li>
<li><a href="../347350/index.html">Style Tips. How to write a readable React code</a></li>
<li><a href="../347352/index.html">Interaction of C # and C ++ cross-platform</a></li>
<li><a href="../347354/index.html">Learn OpenGL. Lesson 4.5 - Framebuffer</a></li>
<li><a href="../347358/index.html">Unit tests. Quick start - effective result (with examples in C ++)</a></li>
<li><a href="../347362/index.html">Avito in the Russian-speaking PostgreSQL community: open 2018, remember 2017</a></li>
<li><a href="../347364/index.html">The book "Angular and TypeScript. Website building for professionals ¬ª</a></li>
<li><a href="../347366/index.html">The third invasion of the Martians</a></li>
<li><a href="../347368/index.html">Call Tracing Anatomy: Setup Guide</a></li>
<li><a href="../347370/index.html">Creating a chain of behaviors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>