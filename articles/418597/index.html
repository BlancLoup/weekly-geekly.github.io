<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Functions for documenting PostgreSQL databases. Part three</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the third part of the article, which describes user functions for working with system catalogs: pg_class, pg_attribute, pg_constraints, etc. 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Functions for documenting PostgreSQL databases. Part three</h1><div class="post__text post__text-html js-mediator-article">  This is the third part of the article, which describes user functions for working with system catalogs: pg_class, pg_attribute, pg_constraints, etc. <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zc/rx/ta/zcrxta08dnfat5cqpgid4lyq7by.png"></div><br>  This part of the article discusses functions that return the <b>characteristics of sequences, inherited tables</b> , and the <b>special characteristics of table attributes</b> . <br><a name="habracut"></a><br><p>  <b>see also</b> <br>  <b><a href="https://habr.com/post/415575/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/415575/">Part One</a> ;</b> <br>  <b><a href="https://habr.com/post/415897/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/415897/">Part Two</a> ;</b> <br>  <b><a href="https://habr.com/post/419749/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/419749/">The end (part four)</a> .</b> <br><br>  The first half of the article contains comments on the implementation of functions.  In the second, the source code of the functions.  For those readers who are interested only in the source code, we suggest that you go straight to the <a href="https://habr.com/ru/post/418597/">Appendix</a> . <br><br></p><h3>  The structure of the function that returns a list of characteristics of table sequences </h3><br><img src="https://habrastorage.org/webt/i6/dw/f_/i6dwf_jd0ofjr-vqmeide0l1vws.png"><br>  <i>Fig.</i>  <i>2. Functions on which the function admtf_Table_Sequences depends</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>Table 11. Assignment of functions.</strong> <br><br><table width="95" border="1"><tbody><tr><th width="5">  No </th><th width="10">  Title </th><th width="40">  Purpose </th></tr><tr><td width="5">  one </td><td width="10">  admtf_Sequence_Features </td><td width="40">  The function returns a list of table sequence characteristics. </td></tr><tr><td width="5">  2 </td><td width="10">  admtf_Table_Sequences </td><td width="40">  The function returns a list of database table sequences and their characteristics. </td></tr></tbody></table><br><h3>  Function <b>admtf_Sequence_Features</b> - list of database sequence characteristics </h3><br><a name="tfSeqF_def"></a><p>  The function admtf_Sequence_Features returns a list of sequence characteristics (SEQUENCE) of a database.  <a href="https://habr.com/ru/post/418597/">Source code can be viewed and downloaded here</a> . </p><br><p>  The function <b>admtf_Sequence_Features</b> returns a list of sequence characteristics ( <b>SEQUENCE</b> ) of a database. </p>  . <br><p>  As parameters, the function takes the name of the sequence ( <b>a_SequenceName</b> ) and the name of the circuit within which the sequence is created ( <b>a_SchemaName</b> ). </p><br><p>  The need for the <b>admtf_Sequence_Features</b> function arose from the fact that the main characteristics of a sequence are actually stored in a table whose name matches the sequence name, and the data is extracted from it using the <b>SELECT statement</b> .  In this case, the name of the sequence, the name of the scheme and commentary to the sequence are stored in the <b>pg_class</b> , <b>pg_namespace</b> and <b>pg_description directories</b> . </p><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> kr_road_network_vertices_pgr_id_seq;</code> </pre> <br><p>  <b><i>Remark 6</i></b> </p><br><p>  In version 10, <b>PostgreSQL</b> divided the characteristics of a sequence and the characteristics of its states.  For this purpose, the <b>pg_sequence</b> directory with sequence characteristics is entered, containing the initial value ( <b>start_value</b> ), increment ( <b>increment_by</b> ) and maximum value ( <b>max_value</b> ) of the sequence.  The last value returned by the sequence ( <b>last_value</b> ) was left in the ‚Äútable‚Äù with the name of the sequence. </p><p></p><p>  <strong>The end of the remark.</strong> </p><br><p>  The representation of each sequence as an analogue of the table, I think, is dictated by the need to store the last used value of the sequence ( <b>last_value</b> ), which is a characteristic of the state of the sequence, but not the sequence as such. </p><br><p>  The sequence entry in the <b>pg_class</b> directory differs from the table entry by the value of the relation type (relkind = <font color="red">'S'</font> ). </p><br><p>  In order to extract the characteristics of an arbitrary sequence, you have to use dynamic SQL. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT last_value,start_value,increment_by,max_value FROM '</span></span>|| <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName)||<span class="hljs-string"><span class="hljs-string">'.'</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SequenceName) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_SequenceLastValue,v_SequenceStartValue, v_SequenceIncrementBy,v_SequenceMaxValue ;</code> </pre><br><br>  <strong>Table 12. Result of execution of the function admtf_Sequence_Features ('public', 'kr_road_network_vertices_pgr_id_seq').</strong> <br><br><table width="25"><tbody><tr><th width="5">  Title </th><th width="5">  Comment </th><th width="10">  Current </th><th width="5">  Start </th><th width="5">  Increment </th><th width="10">  the end </th></tr><tr><td width="15">  kr_road_network <br>  _vertices_pgr_id <br>  _seq </td><td width="20">  Sequence </td><td width="10">  138023 </td><td width="5">  one </td><td width="5">  one </td><td width="10">  9223372036854775807 </td></tr></tbody></table><br><h3>  The function admtf_Table_Sequences a list of sequences of a database table and their characteristics </h3><br><a name="tfTableS_def"></a><p>  The function <b>admtf_Table_Sequences</b> returns a list of sequences ( <b>SEQUENCE</b> ) of a database table, generating the values ‚Äã‚Äãof its fields, and the characteristics of these sequences.  <a href="https://habr.com/ru/post/418597/">The source code can be viewed and downloaded here</a> , and <a href="https://habr.com/ru/post/418597/">here is the version of the function in which the cursor is not used</a> . </p><br><p>  As parameters, the function takes the name of the source table ( <b>a_TableName</b> ) and the name of the schema within which the table is created ( </p><p>  a_SchemaName </p>  ). <br><img src="https://habrastorage.org/webt/io/cc/ib/ioccibem_rgf_rjzsnmd5va1xt0.png"><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pseq.relname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceName,snsp.nspname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceSchemaName, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(dsc.description,<span class="hljs-string"><span class="hljs-string">',    '</span></span> ||da.attname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceDescription, d.depType <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DependcyType,da.attname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AttributeName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_depend d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class pseq <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.objid = pseq.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace snsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.relnamespace=snsp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.refobjid = tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace=nsp.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute da <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> da.attrelid= d.refobjid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> da.attnum= d.refobjsubid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(nsp.nspname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(tbl.relname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableOID) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pseq.relkind = <span class="hljs-string"><span class="hljs-string">'S'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pseq.relname;</code> </pre><br></div></div><br><p>  The description of a separate sequence is a collection of entries in <b>pg_class</b> , describing it as a physical relation, and a conditional table with the name of the sequence containing data on the specific characteristics of the sequence </p><br><p>  Information about the relationship between the sequence and the source table is stored in the <b>pg_depend</b> system directory. </p><br><br>  <strong>Table 13. Attributes of the <b>pg_depend</b> directory required to implement the function.</strong> <br><table width="25"><tbody><tr><th width="5">  Title </th><th width="5">  Description </th></tr><tr><td width="10">  objid </td><td width="20">  Sequence OID in pg_class directory </td></tr><tr><td width="10">  objsubid </td><td width="20">  This field is zero. </td></tr><tr><td width="10">  refobjid </td><td width="20">  The OID of the table, in which fields the sequence is used. </td></tr><tr><td width="10">  refobjsubid </td><td width="20">  The attribute number of the table, the values ‚Äã‚Äãof which are populated using the sequence </td></tr></tbody></table><br><p>  Additionally, the function accesses the data in the <b>pg_namespace</b> and <b>pg_description</b> directories in order to extract the schemas and comments of both the sequence and the source table. </p><br><p>  To determine the attribute of a table whose values ‚Äã‚Äãare filled using a sequence, the function refers to the <b>pg_attribute</b> directory by the condition: <b>attrelid = refobjid AND attnum = refobjsubid</b> .  (In this condition, the names of the <b>pg_depend</b> attributes of the directory are indicated to the right of the equal sign). </p><br><p>  The special characteristics of the table sequences are retrieved in a loop by calling the function <b>admtf_Sequence_Features</b> .  The cycle is used because more than one sequence can be assigned to fill in the table fields. </p><br>  <strong>Table 14. Result of execution of the function admtf_Table_Sequences ('public', 'kr_road_network_vertices_pgr').</strong> <br><br><table width="25"><tbody><tr><th width="5">  Title </th><th width="5">  Comment </th><th width="5">  Start </th><th width="5">  Increment </th><th width="10">  the end </th><th width="10">  Field </th></tr><tr><td width="15">  kr_road_network <br>  _vertices_pgr_id <br>  _seq </td><td width="20">  A sequence that generates id field values </td><td width="5">  one </td><td width="5">  one </td><td width="10">  9223372036854775807 </td><td width="10">  id </td></tr></tbody></table><br><a name="tfTableS_woc_def"></a><h4>  Version without cursor </h4><br><p>  In a <b>PostgreSQL</b> environment that has a version less than 10, it‚Äôs most likely impossible to implement the function <b>admtf_Table_Sequences</b> without using a cursor. <br>  But the happy owners of version 10 may well do without a cursor, because  they have the <b>pg_sequence</b> directory at their disposal.  In this case, all characteristics of the sequence can be retrieved with a single <b>SELECT statement</b> . </p><br><p>  In the above implementation of the function, using the window function <b>RANK () OVER (PARTITION BY pseq.relname)</b> , the sequence number of the sequence used to populate the original table is calculated. </p><br><img src="https://habrastorage.org/webt/1z/qa/r7/1zqar7uba-68o2ya1l_o37ph5jc.png"><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RANK</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pseq.relname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceNo, pseq.relname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceName,snsp.nspname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceSchemaName, <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(dsc.description,<span class="hljs-string"><span class="hljs-string">',    '</span></span> ||da.attname) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceDescription, seq.seqstart <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceStartValue,seq.seqincrement <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceIncrementBy, seq.seqmax <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> SequenceMaxValue, d.depType <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DependcyType,da.attname <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> AttributeName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_depend d <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class pseq <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.objid = pseq.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_sequence seq <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> seq.seqrelid= pseq.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace snsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.relnamespace=snsp.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pseq.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.refobjid = tbl.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nsp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace=nsp.oid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_attribute da <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> da.attrelid= d.refobjid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> da.attnum= d.refobjsubid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(nsp.nspname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(tbl.relname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableOID) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> pseq.relkind = <span class="hljs-string"><span class="hljs-string">'S'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> pseq.relname;</code> </pre><br></div></div><br><p>  <strong>Remark 7</strong> </p>  . <br><p>  This version of the function does not return the last value generated by the sequence ( <b>last_value</b> ). </p><p></p><p>  <strong>The end of the remark.</strong> </p><br><h3>  Function admtf_Table_InheritanceChildrens - a list of characteristics of inherited tables </h3><br><a name="tfTableIC_def"></a><p>  The <b>admtf_Table_InheritanceChildrens</b> function returns a list of the inherited table characteristics ( <b>INHERITS</b> ) of a database table.  <a href="https://habr.com/ru/post/418597/">Source code can be viewed and downloaded here</a> . </p><br><p>  As parameters, the function takes the name of the source table ( <b>a_TableName</b> ) and the name of the schema within which the table is created ( <b>a_SchemaName</b> ). </p><br><p>  The description of a separate inherited table is in an entry in <b>pg_class</b> .  But to search for inherited tables by the name of the source table, you have to use the system catalog <b>pg_depend</b> . </p><br>  <strong>Table 15. Attributes of the <b>pg_depend</b> directory required to implement the function.</strong> <br><table width="25"><tbody><tr><th width="5">  Title </th><th width="5">  Description </th></tr><tr><td width="10">  objid </td><td width="20">  OID of the inherited table in the pg_class directory </td></tr><tr><td width="10">  refobjid </td><td width="20">  OID source table </td></tr></tbody></table><br><img src="https://habrastorage.org/webt/pa/ew/kl/paewklf4g7qvftdb99sss0efwqc.png"><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rtbl.relname,rnspc.nspname,rdsc.description,rtbl.relnatts::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtbl.relchecks::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtbl.relhaspkey,rtbl.relhasindex,rtbl.relhassubclass, rtbl.reltuples::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_depend dp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dp.refobjid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class rtbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.OID=dp.objid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace rnspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.relnamespace = rnspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description rdsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.oid=rdsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rdsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(nspc.nspname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(tbl.relname)=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableOID) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rtbl.relkind = <span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rtbl.relname;</code> </pre><br></div></div><br><p>  Additionally, the function accesses the data in the <b>pg_namespace</b> and <b>pg_description</b> directories in order to extract the schemas and comments for both the inherited and the source table. </p><br>  <strong>Table 16. Result of execution of the function admtf_Table_InheritanceChildrens ('public', 'np_house').</strong> <br><br><table width="95" border="1"><tbody><tr><th width="10">  Title </th><th width="20">  Comment </th><th width="5">  Attributes </th><th width="5">  ?  primary key </th><th width="5">  ?  indexes </th><th width="5">  ?  descendants </th><th width="5">  Number of records </th></tr><tr><td width="10">  np_house 04201 000000 </td><td width="20">  Houses in settlements (Achinsky district) </td><td width="5">  15 </td><td width="5">  f </td><td width="5">  f </td><td width="5">  f </td><td width="5">  5651 </td></tr><tr><td width="10">  np_house 4208 000000 </td><td width="20">  Houses in settlements (Bogotolsky district) </td><td width="5">  15 </td><td width="5">  f </td><td width="5">  f </td><td width="5">  f </td><td width="5">  4314 </td></tr></tbody></table><br><p>  The number of records in the child table is selected from the reltuple attribute of the pg_class directory.  Although this value often coincides exactly with the actual number of records in the table, it is still an estimated value.  This means there may be a desire to get the exact value as a result.  For example, as shown in the figure. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT COUNT(*) FROM '</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName)||<span class="hljs-string"><span class="hljs-string">'.'</span></span>||<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableName) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_TableNumberOfRowCalc;</code> </pre><br><p>  But, first, in order to execute this statement in the text, the function <b>admtf_Table_InheritanceChildrens</b> will have to use a cursor. </p><br><p>  Secondly, I would like the function to allow the output of both the estimated and the exact number of table entries. </p><br><p>  Therefore, the function has one more optional parameter - the mode of obtaining the number of records in the table ( <b>a_Mode</b> ), which takes the values ‚Äã‚Äã‚Äúestimated‚Äù ( <font color="red">estimate</font> ) or ‚Äúexactly‚Äù. </p><br><a name="fnTableRC_def"></a><br><p>  Additionally, the function <a href="https://habr.com/ru/post/418597/">admfn_Table_RowCount</a> , which returns the exact number of table entries, is created, and in the list of returned <b>SELECT</b> values, the reltuple attribute is replaced with the following construction. </p><br><img src="https://habrastorage.org/webt/3f/t_/xf/3ft_xftbnboqxguantdpivkdtva.png"><br><div class="spoiler">  <b class="spoiler_title">source code operator in the figure</b> <div class="spoiler_text"><pre> <code class="sql hljs">CASE WHEN a_Mode = 'exactly' THEN admfn_Table_RowCount(rnspc.nspname,rtbl.relname) ELSE reltuples <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br><p>  As a result, the function returns the estimated value of the ‚Äúnumber of table entries‚Äù indicator, if the <b>a_Mode</b> parameter <b>does</b> not <b>specify the</b> requirement to return an exact value. </p><br><h3>  The structure of the function that returns a list of table attribute characteristics </h3><br><img src="https://habrastorage.org/webt/hi/du/at/hiduatp-_vtmifufs_u53_roz2q.png"><br>  <i>Fig.</i>  <i>3. Functions that admtf_Attribute_Features Calls</i> <br><img src="https://habrastorage.org/webt/ip/3e/rx/ip3erx3a2sj9_kkoeriysoppfom.png"><br><div class="spoiler">  <b class="spoiler_title">text version of the table in the figure</b> <div class="spoiler_text">  <strong>Table 17. Assignment of functions.</strong> <br><br><table width="95" border="1"><tbody><tr><th width="5">  No </th><th width="10">  Title </th><th width="40">  Purpose </th></tr><tr><td width="5">  one </td><td width="10">  admtf_Attribute_PKFeatures </td><td width="40">  The function returns the indication of the presence of an attribute in the primary key (PRIMARY KEY), as well as some of its characteristics as part of this key. </td></tr><tr><td width="5">  2 </td><td width="10">  admtf_Attribute_FKFeatures </td><td width="40">  The function returns an indication of the presence of an attribute in the foreign key (FOREIGN KEY), as well as some of its characteristics as part of this key. </td></tr><tr><td width="5">  3 </td><td width="10">  admtf_Attribute_Features </td><td width="40">  The function returns a list of table attribute characteristics. </td></tr></tbody></table><br></div></div><br><h3>  Function <b>admtf_Attribute_PKFeatures</b> - - is there an attribute in the primary key </h3><br><a name="tfAttPK_def"></a><br><p>  The function <b>admtf_Attribute_PKFeatures</b> returns a sign of the presence of a table attribute in the primary key (PRIMARY KEY) of the table, and, if present, what is its sequence number in this key, since  primary key can be composite. <br>  <a href="https://habr.com/ru/post/418597/">Source code can be viewed and downloaded here</a> . </p><br><p>  As parameters, the function takes the OID of the source table ( <b>a_TableOID</b> ) and the sequence number of the required attribute in it ( <b>a_AttributeNo</b> ). </p><br><p>  The function extracts the necessary data from the <b>pg_constraint</b> directory <b>entry</b> containing the constraints (CONSTRAINT) of the source table, including the primary key constraint.  The OID of the table you are <b>looking for</b> is stored in the <b>conrelid</b> field, the description of the primary key is stored in the record in which the contype field contains the value <font color="red">'' p '</font> </p>  . <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_PKAttributeList,rs_isAttributePK conkey,<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[a_AttributeNo]&lt;@conkey <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.contype=<span class="hljs-string"><span class="hljs-string">'p'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> c.conrelid=a_TableOID;</code> </pre><br><p>  The <b>conkey</b> field of the <b>entry</b> thus found contains an array of attribute sequence numbers that make up the primary key.  Therefore, in order to check the presence of the source attribute in the primary key, it suffices to calculate the logical expression <b>ARRAY [a_AttributeNo] &lt;@ conkey</b> . </p><br><p>  If the attribute is present in the primary key, then its sequence number is calculated further in the loop. </p><br><h3>  Function <b>admtf_Attribute_FKFeatures</b> - is there an attribute in the foreign key </h3><br><a name="tfAttFK_def"></a><br><p>  The function <b>admtf_Attribute_FKFeatures</b> returns an indication of the presence of a table attribute in one or more foreign keys (FOREIGN KEY) of the table, and, if present, its serial numbers in these keys, since  foreign key can be composite. <br><br>  <a href="https://habr.com/ru/post/418597/">Source code can be viewed and downloaded here</a> . </p><br><p>  As parameters, the function takes the OID of the source table ( <b>a_TableOID</b> ) and the sequence number of the required attribute in it ( <b>a_AttributeNo</b> ). </p><br><p>  The function extracts the necessary data from the <b>pg_constraint</b> directory <b>entry</b> containing the constraints (CONSTRAINT) of the source table, including, but not limited to, foreign key constraints.  The OID of the table you are <b>looking for</b> is stored in the <b>conrelid</b> field, the primary key description is stored in the record in which the contype field contains the value <font color="red">'' f '</font> </p>  . <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_constraint c <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c.contype=<span class="hljs-string"><span class="hljs-string">'f '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> c.conrelid=a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[a_AttributeNo]&lt;@conkey <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> c.oid;</code> </pre><br><p>  The <b>conkey</b> field of the <b>entry</b> thus found contains an array of attribute sequence numbers that make up the foreign key.  Therefore, in order to check the presence of the source attribute in the foreign key, it suffices to calculate the logical expression <b>ARRAY [a_AttributeNo] &lt;@ conkey</b> . </p><br><p>  If the attribute is present in the foreign key, then later in the loop an array of its ordinal numbers is formed in the foreign keys containing it.  Additionally, two more arrays are formed from the names of the tables and their attributes that are referenced by the original attribute in the foreign keys containing it. </p><br><p>  Table names are extracted from the <b>pg_class</b> directory <b>entry</b> by identifier (OID) extracted from the confrelid field of the foreign key entry. </p><br><p>  To get the name of an attribute of an external table, use an array of sequence numbers from the field </p><p>  confkey </p>  (it differs from the above array by the letter ‚Äú <b>f</b> ‚Äù in the name).  From this array is extracted the ordinal number of the attribute of the external table, which corresponds to the external attribute.  By this ordinal number of the attribute of the external table and its OID, located in the pg_attribute directory, there is an entry describing the attribute and its name is extracted. <br><h3>  Function <b>admtf_Attribute_Features</b> - a list of characteristics of the attribute table </h3><br><a name="tfAttF_def"></a><p>  The function <b>admtf_Attribute_Features</b> returns a list of the following characteristics of a table attribute.  <a href="https://habr.com/ru/post/418597/">Source code can be viewed and downloaded here</a> . </p><br><img src="https://habrastorage.org/webt/tu/bz/me/tubzmeucr-nzriafiuufgbv31ew.png"><br><div class="spoiler">  <b class="spoiler_title">Text version of the table in the figure</b> <div class="spoiler_text"><table width="95" border="1"><tbody><tr><th width="5">  No </th><th width="10">  Title </th><th width="10">  Type of </th><th width="40">  Purpose </th></tr><tr><td width="5">  one </td><td width="10">  AttributeName </td><td width="10">  name </td><td width="40">  The name of the source attribute. </td></tr><tr><td width="5">  2 </td><td width="10">  UserTypeName </td><td width="10">  VARCHAR (256) </td><td width="40">  Custom Attribute Type </td></tr><tr><td width="5">  3 </td><td width="10">  Typename </td><td width="10">  VARCHAR (256) </td><td width="40">  Base type of source attribute </td></tr><tr><td width="5">  four </td><td width="10">  isNotNULL </td><td width="10">  Boolean </td><td width="40">  ?  Null value valid </td></tr><tr><td width="5">  five </td><td width="10">  isAttributePK </td><td width="10">  Boolean </td><td width="40">  ?  participation in PK </td></tr><tr><td width="5">  6 </td><td width="10">  ColumnPKNo </td><td width="10">  SMALLINT </td><td width="40">  Attribute ordinal number in PK </td></tr><tr><td width="5">  7 </td><td width="10">  Description </td><td width="10">  TEXT </td><td width="40">  Original attribute comment </td></tr><tr><td width="5">  eight </td><td width="10">  isAttributeFK </td><td width="10">  Boolean </td><td width="40">  ?  participation in FK </td></tr><tr><td width="5">  9 </td><td width="10">  FKeyName </td><td width="10">  name [] </td><td width="40">  An array of names of the constraints of the table in which the foreign key is defined </td></tr><tr><td width="5">  ten </td><td width="10">  Columnfkno </td><td width="10">  SMALLINT [] </td><td width="40">  An array of attribute sequence numbers in the table's foreign keys </td></tr><tr><td width="5">  eleven </td><td width="10">  FKTableName </td><td width="10">  name [] </td><td width="40">  Array of tables referenced by foreign keys </td></tr><tr><td width="5">  12 </td><td width="10">  FKTableColumnName </td><td width="10">  name [] </td><td width="40">  Array of attribute names in external tables corresponding to the source attribute </td></tr></tbody></table><br></div></div><br><p>  As parameters, the function takes the OID of the source table ( <b>a_TableOID</b> ) and the sequence number of the required attribute in it ( <b>a_AttributeNo</b> ). <br>  The values ‚Äã‚Äãof the <b>AttributeName</b> and <b>isNotNULL fields</b> are extracted from the <b>pg_attribute</b> directory <b>entry</b> corresponding to the values ‚Äã‚Äãof the input parameters. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> attr.attname, attr.attnotnull <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_attribute <span class="hljs-keyword"><span class="hljs-keyword">attr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> attr.attrelid =a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> attr.attnum=a_AttributeNo; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rs_isAttributePK,rs_ColumnPKNo <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> admtf_Attribute_PKFeatures (a_TableOID,a_AttributeNo); <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rs_isAttributeFK,rs_FKeyName,rs_ColumnFKNo, rs_FKTableName,rs_FKTableColumnName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> admtf_Attribute_FKFeatures (a_TableOID,a_AttributeNo);</code> </pre><br><p>  The values ‚Äã‚Äãof the <b>isAttributePK</b> and <b>ColumnPKNo fields are</b> returned by the function <b>admtf_Attribute_PKFeatures</b> . </p><br><p>  The values ‚Äã‚Äãof the fields <b>isAttributeFK</b> , <b>FKeyName</b> , <b>ColumnFKNo</b> , <b>FKTableName</b> , <b>FKTableColumnName are</b> returned by the function <b>admtf_Attribute_FKFeatures</b> . </p><br><p>  Calling the function <b>admtf_Attribute_Features ((SELECT OID FROM pg_class WHERE relname = 'street'), 2 :: SMALLINT)</b> will result in the following result. </p><br>  <strong>Table 18. The result of the function execution admtf_Attribute_Features</strong> <br><table width="95" border="1"><tbody><tr><th width="10">  AttributeName </th><th width="10">  UserTypeName </th><th width="10">  Typename </th><th width="10">  isNotNULL </th><th width="10">  isAttributePK </th><th width="10">  ColumnPKNo </th></tr><tr><td width="10">  localityid </td><td width="10">  localityid </td><td width="10">  integer </td><td>  integer </td><td>  integer </td><td width="2">  integer </td></tr></tbody></table><br><br><table width="95" border="1"><tbody><tr><th width="10">  Description </th><th width="10">  isAttributeFK </th><th width="10">  FKeyName </th><th width="10">  Columnfkno </th><th width="10">  FKTableName </th><th width="10">  FKTableColumnName </th></tr><tr><td width="10">  ID of the settlement </td><td width="10">  t </td><td width="10">  {fk_street_locality} </td><td>  {2} </td><td>  {locality} </td><td width="2">  {localityid} </td></tr></tbody></table><br><a name="Script2"></a><h2>  APPENDIX 1. Scripts </h2><br><a name="tfSeqF"></a><h3>  Create function admtf_Sequence_Features </h3><br>  <a href="https://habr.com/ru/post/418597/">Comments on the source code of the function can be found here.</a> <br><div class="spoiler">  <b class="spoiler_title">function code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Sequence_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     ,   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Sequence_Features (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rs_SequenceDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>,rs_NumberOfAttribute <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>,rs_SequenceLastValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, rs_SequenceStartValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,rs_SequenceIncrementBy <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,rs_SequenceMaxValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_SequenceKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'S'</span></span>; v_SequenceOID OID; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceStartValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceIncrementBy BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceMaxValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceLastValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceNumberOfRowCalc INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">--************************************************************************ BEGIN SELECT INTO rs_SequenceName,rs_SequenceDescription,rs_NumberOfAttribute tbl.relname, COALESCE(dsc.description,'') AS r_SequenceDescription, tbl.relnatts::INTEGER,tbl.relchecks::INTEGER,tbl.relhaspkey, tbl.relhasindex,tbl.relhassubclass,tbl.reltuples::INTEGER FROM pg_class tbl INNER JOIN pg_namespace nspc ON tbl.relnamespace = nspc.oid LEFT OUTER JOIN pg_Description dsc ON tbl.oid=dsc.objoid AND dsc.objsubid=0 WHERE nspc.nspname=LOWER(a_SchemaName) AND tbl.relkind=c_SequenceKind AND tbl.relname =LOWER(a_SequenceName); IF FOUND THEN EXECUTE 'SELECT last_value,start_value,increment_by,max_value FROM '||LOWER(a_SchemaName)||'.'||LOWER(a_SequenceName) INTO v_SequenceLastValue,v_SequenceStartValue, v_SequenceIncrementBy,v_SequenceMaxValue ; RETURN QUERY SELECT rs_SequenceName,rs_SequenceDescription, rs_NumberOfAttribute,v_SequenceLastValue, v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue; END IF; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Sequence_Features(a_SchemaName NAME,a_SequenceName NAME) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Sequence_Features (a_SchemaName VARCHAR(256),a_SequenceName VARCHAR(256)); /****************************************************************************/ /*     ,   */ /****************************************************************************/ CREATE OR REPLACE FUNCTION admtf_Sequence_Features (a_SchemaName VARCHAR(256) default 'public', /*     */ a_SequenceName VARCHAR(256) default NULL /*   */ ) RETURNS TABLE (rs_SequenceName VARCHAR(256),rs_SequenceDescription TEXT, rs_NumberOfAttribute INTEGER,rs_SequenceLastValue BIGINT, rs_SequenceStartValue BIGINT,rs_SequenceIncrementBy BIGINT, rs_SequenceMaxValue BIGINT) AS $BODY$ DECLARE c_SequenceKind CONSTANT CHAR:='S'; --******************************************************** BEGIN RETURN QUERY SELECT sf.rs_SequenceName::VARCHAR(256), sf.rs_SequenceDescription::TEXT, sf.rs_NumberOfAttribute::INTEGER, sf.rs_SequenceLastValue::BIGINT, sf.rs_SequenceStartValue::BIGINT, sf.rs_SequenceIncrementBy::BIGINT, sf.rs_SequenceMaxValue::BIGINT FROM admtf_Sequence_Features(a_SchemaName::NAME,a_SequenceName::NAME) sf; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Sequence_Features(a_SchemaName VARCHAR(256),a_SequenceName VARCHAR(256)) IS '    ,  '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Sequence_Features('public'::VARCHAR(255),'k_dorogi_dijkstra_seq_seq'::VARCHAR(255)); SELECT * FROM admtf_Sequence_Features('public'::NAME,'kr_road_network_vertices_pgr_id_seq'::NAME);</span></span></code> </pre><br></div></div><br><a name="tfTableS"></a><br><h3>  Create function admtf_Table_Sequences </h3><br>  <a href="https://habr.com/ru/post/418597/">Comments on the source code of the function can be found here.</a> <br><div class="spoiler">  <b class="spoiler_title">function code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*********************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (r_SequenceNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_SequenceSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_SequenceDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, r_SequenceStartValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_SequenceIncrementBy <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, r_SequenceMaxValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_DependType <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefTableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_RefTableSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefAttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_TableOID <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>;<span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_Sequence RECORD;<span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceOID INTEGER;<span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_SequenceName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceSchemaName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceStartValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceIncrementBy BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceMaxValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_DependcyType NAME; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_AttributeName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_SequenceNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_Delimiter CONSTANT VARCHAR(2):=','; <span class="hljs-comment"><span class="hljs-comment">--********************************************************************* BEGIN v_SequenceNumber:=0; FOR v_Sequence IN SELECT pseq.relname AS SequenceName, snsp.nspname AS SequenceSchemaName, COALESCE(dsc.description,',    '||da.attname) AS SequenceDescription, d.depType AS DependcyType,da.attname AS AttributeName FROM pg_depend d INNER JOIN pg_class pseq ON d.objid = pseq.oid INNER JOIN pg_namespace snsp ON pseq.relnamespace=snsp.oid LEFT OUTER JOIN pg_Description dsc ON pseq.oid=dsc.objoid AND dsc.objsubid=0 INNER JOIN pg_class tbl ON d.refobjid = tbl.oid INNER JOIN pg_namespace nsp ON tbl.relnamespace=nsp.oid INNER JOIN pg_attribute da ON da.attrelid= d.refobjid AND d.refobjsubid=da.attnum WHERE tbl.relkind = 'r' AND pseq.relkind = 'S' AND LOWER(nsp.nspname)=LOWER(a_SchemaName) AND LOWER(tbl.relname)=LOWER(a_TableName) ORDER BY pseq.relname LOOP v_SequenceNumber:=v_SequenceNumber+1; v_SequenceName:=v_Sequence.SequenceName; v_SequenceSchemaName:=v_Sequence.SequenceSchemaName; v_DependcyType:=v_Sequence.DependcyType; v_AttributeName:=v_Sequence.AttributeName; v_SequenceDescription:=v_Sequence.SequenceDescription; SELECT INTO v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue rs_SequenceStartValue,rs_SequenceIncrementBy, rs_SequenceMaxValue FROM admtf_Sequence_Features(v_SequenceSchemaName,v_SequenceName); RETURN QUERY SELECT v_SequenceNumber,v_SequenceName, v_SequenceSchemaName,v_SequenceDescription, v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue,v_DependcyType, a_TableName,a_SchemaName,v_AttributeName; END LOOP; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName NAME, a_TableName NAME) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Table_Sequences (a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)); /**********************************************************************/ /*    ,     */ /**********************************************************************/ CREATE OR REPLACE FUNCTION admtf_Table_Sequences (a_SchemaName VARCHAR(256) default 'public', /*     */ a_TableName VARCHAR(256) default NULL /*   */ ) RETURNS TABLE (r_SequenceNumber SMALLINT,r_SequenceName VARCHAR(256), r_SequenceSchemaName VARCHAR(256),r_SequenceDescription TEXT, r_SequenceStartValue BIGINT,r_SequenceIncrementBy BIGINT, r_SequenceMaxValue BIGINT,r_DependType VARCHAR(256), r_RefTableName VARCHAR(256),r_RefTableSchemaName VARCHAR(256), r_RefAttributeName VARCHAR(256)) AS $BODY$ DECLARE c_Delimiter CONSTANT VARCHAR(2):=','; --****************************************************** BEGIN RETURN QUERY SELECT ts.r_SequenceNumber::SMALLINT, ts.r_SequenceName::VARCHAR(256), ts.r_SequenceSchemaName::VARCHAR(256) , ts.r_SequenceDescription::TEXT, ts.r_SequenceStartValue::BIGINT, ts.r_SequenceIncrementBy::BIGINT, ts.r_SequenceMaxValue::BIGINT, ts.r_DependType::VARCHAR(256), ts.r_RefTableName::VARCHAR(256), ts.r_RefTableSchemaName::VARCHAR(256), ts.r_RefAttributeName::VARCHAR(256) FROM admtf_Table_Sequences(a_SchemaName::NAME,a_TableName::NAME) ts; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Table_Sequences('public'::VARCHAR(255),'kr_road_network_vertices_pgr'::VARCHAR(255)); SELECT * FROM admtf_Table_Sequences('public'::NAME,'kr_road_network_vertices_pgr'::NAME);</span></span></code> </pre><br></div></div><br><a name="tfTableS_woc"></a><h3>   admtf_Table_Sequences   (PostgreSQL 10) </h3><br> <a href="https://habr.com/ru/post/418597/">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*********************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    ,     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/**********************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_Sequences (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (r_SequenceNumber <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,r_SequenceName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_SequenceSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_SequenceDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, r_SequenceStartValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_SequenceIncrementBy <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>, r_SequenceMaxValue <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>,r_DependType <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefTableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,r_RefTableSchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>, r_RefAttributeName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_TableOID <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_Sequence RECORD; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceOID INTEGER; <span class="hljs-comment"><span class="hljs-comment">/* OID */</span></span> v_SequenceName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceSchemaName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceStartValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_SequenceIncrementBy BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SequenceMaxValue BIGINT; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_DependcyType NAME; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> v_AttributeName NAME; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_SequenceNumber SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_Delimiter CONSTANT VARCHAR(2):=','; <span class="hljs-comment"><span class="hljs-comment">--****************************************************************** BEGIN v_SequenceNumber:=0; FOR v_Sequence IN SELECT pseq.relname AS SequenceName, snsp.nspname AS SequenceSchemaName, COALESCE(dsc.description,',    '||da.attname) AS SequenceDescription, d.depType AS DependcyType,da.attname AS AttributeName FROM pg_depend d INNER JOIN pg_class pseq ON d.objid = pseq.oid INNER JOIN pg_namespace snsp ON pseq.relnamespace=snsp.oid LEFT OUTER JOIN pg_Description dsc ON pseq.oid=dsc.objoid AND dsc.objsubid=0 INNER JOIN pg_class tbl ON d.refobjid = tbl.oid INNER JOIN pg_namespace nsp ON tbl.relnamespace=nsp.oid INNER JOIN pg_attribute da ON da.attrelid= d.refobjid ND d.refobjsubid=da.attnum WHERE tbl.relkind = 'r' AND pseq.relkind = 'S' AND LOWER(nsp.nspname)=LOWER(a_SchemaName) AND LOWER(tbl.relname)=LOWER(a_TableName) ORDER BY pseq.relname LOOP v_SequenceNumber:=v_SequenceNumber+1; v_SequenceName:=v_Sequence.SequenceName; v_SequenceSchemaName:=v_Sequence.SequenceSchemaName; v_DependcyType:=v_Sequence.DependcyType; v_AttributeName:=v_Sequence.AttributeName; v_SequenceDescription:=v_Sequence.SequenceDescription; SELECT INTO v_SequenceStartValue,v_SequenceIncrementBy,v_SequenceMaxValue rs_SequenceStartValue,rs_SequenceIncrementBy,rs_SequenceMaxValue FROM admtf_Sequence_Features(v_SequenceSchemaName,v_SequenceName); RETURN QUERY SELECT v_SequenceNumber,v_SequenceName, v_SequenceSchemaName,v_SequenceDescription, v_SequenceStartValue,v_SequenceIncrementBy, v_SequenceMaxValue,v_DependcyType, a_TableName,a_SchemaName,v_AttributeName; END LOOP; RETURN; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName NAME, a_TableName NAME) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Table_Sequences (a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)); /**********************************************************************/ /*    ,     */ /**********************************************************************/ CREATE OR REPLACE FUNCTION admtf_Table_Sequences (a_SchemaName VARCHAR(256) default 'public', /*     */ a_TableName VARCHAR(256) default NULL /*   */ ) RETURNS TABLE (r_SequenceNumber SMALLINT,r_SequenceName VARCHAR(256), r_SequenceSchemaName VARCHAR(256),r_SequenceDescription TEXT, r_SequenceStartValue BIGINT,r_SequenceIncrementBy BIGINT, r_SequenceMaxValue BIGINT,r_DependType VARCHAR(256), r_RefTableName VARCHAR(256),r_RefTableSchemaName VARCHAR(256), r_RefAttributeName VARCHAR(256)) AS $BODY$ DECLARE c_Delimiter CONSTANT VARCHAR(2):=','; --******************************************************* BEGIN RETURN QUERY SELECT ts.r_SequenceNumber::SMALLINT, ts.r_SequenceName::VARCHAR(256), ts.r_SequenceSchemaName::VARCHAR(256), ts.r_SequenceDescription::TEXT, ts.r_SequenceStartValue::BIGINT, ts.r_SequenceIncrementBy::BIGINT, ts.r_SequenceMaxValue::BIGINT, ts.r_DependType::VARCHAR(256), ts.r_RefTableName::VARCHAR(256), ts.r_RefTableSchemaName::VARCHAR(256), ts.r_RefAttributeName::VARCHAR(256) FROM admtf_Table_Sequences(a_SchemaName::NAME,a_TableName::NAME) ts; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_Sequences(a_SchemaName VARCHAR(256), a_TableName VARCHAR(256)) IS '  ,    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Table_Sequences('public'::VARCHAR(255), 'kr_road_network_vertices_pgr'::VARCHAR(255)); SELECT * FROM admtf_Table_Sequences('public'::NAME, 'kr_road_network_vertices_pgr'::NAME);</span></span></code> </pre><br></div></div><br><a name="fnTableRC"></a><br><h3>   admfn_Table_RowCount </h3><br> <a href="https://habr.com/ru/post/418597/">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admfn_Table_RowCount (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>); <span class="hljs-comment"><span class="hljs-comment">/******************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/******************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admfn_Table_RowCount (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>,<span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_TableNumberOfRowCalc <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> v_Found BOOLEAN; <span class="hljs-comment"><span class="hljs-comment">--*********************************************************** BEGIN IF a_SchemaName ~ E'^[a-z_0-9]+$' AND a_TableName ~ E'^[a-z_0-9]+$' THEN EXECUTE 'SELECT count(*) FROM ' ||a_SchemaName ||'.'|| a_TableName INTO v_TableNumberOfRowCalc; ELSE SELECT INTO v_Found true FROM pg_class tbl INNER JOIN pg_namespace nspc ON tbl.relnamespace = nspc.oid WHERE tbl.relkind='r' AND tbl.relname=a_TableName AND nspc.nspname=a_SchemaName; IF FOUND THEN EXECUTE 'SELECT count(*) FROM ' || CASE WHEN a_SchemaName ~ E'^[a-z_0-9]+$' THEN a_SchemaName ELSE quote_ident(a_SchemaName) END ||'.'|| CASE WHEN a_TableName ~ E'^[a-z_0-9]+$' THEN a_TableName ELSE quote_ident(a_TableName) END INTO v_TableNumberOfRowCalc; ELSE SELECT INTO v_Found true FROM pg_class tbl INNER JOIN pg_namespace nspc ON tbl.relnamespace = nspc.oid WHERE tbl.relkind='r' AND LOWER(tbl.relname)= LOWER(a_TableName) AND nspc.nspname=LOWER(a_SchemaName); IF FOUND THEN EXECUTE 'SELECT count(*) FROM ' || a_SchemaName ||'.'||a_TableName INTO v_TableNumberOfRowCalc; END IF; END IF; END IF; RETURN v_TableNumberOfRowCalc; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admfn_Table_RowCount(a_SchemaName NAME,a_TableName NAME) IS '    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION;BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admfn_Table_RowCount (a_SchemaName VARCHAR(256),a_TableName VARCHAR(256)); /********************************************************************/ /*       */ /********************************************************************/ CREATE OR REPLACE FUNCTION admfn_Table_RowCount (a_SchemaName VARCHAR(256) default 'public',/*     */ a_TableName VARCHAR(256) default NULL /*   */ ) RETURNS BIGINT AS $BODY$ DECLARE v_TableNumberOfRowCalc BIGINT; /*  */ --********************************************************* BEGIN RETURN admfn_Table_RowCount(a_SchemaName::NAME,a_TableName::NAME); END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admfn_Table_RowCount(a_SchemaName VARCHAR(256),a_TableName VARCHAR(256)) IS '    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECt admfn_Table_RowCount('public'::NAME,'Street'::NAME); SELECt admfn_Table_RowCount('public'::VARCHAR(256),'Street'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><a name="tfTableIC"></a><h3>   admtf_Table_InheritanceChildrens </h3><br> <a href="https://habr.com/ru/post/418597/">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Table_InheritanceChildrens (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_Mode <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)); <span class="hljs-comment"><span class="hljs-comment">/************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-comment"><span class="hljs-comment">/************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_InheritanceChildrens (a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'public'</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_Mode <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-string"><span class="hljs-string">'estimate'</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,rs_TableDescription <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, rs_NumberOfAttribute <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>,rs_NumberOfChecks <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rs_hasPKey <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_hasIndex <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>, rs_hasSubClass <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_NumberOfRow <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_TableKind <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>:=<span class="hljs-string"><span class="hljs-string">'r'</span></span>; c_ExactlyMode CONSTANT VARCHAR(10):='exactly'; c_EstimateMode CONSTANT VARCHAR(10):='estimate'; v_TableOID OID; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_SchemaName NAME; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_TableName NAME; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TableDescription TEXT; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_TableNumberOfRowCalc INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_InheritanceRECORD RECORD; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_InheritanceOID OID; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">QUERY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rtbl.relname,rdsc.description,rtbl.relnatts::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtbl.relchecks::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>,rtbl.relhaspkey,rtbl.relhasindex, rtbl.relhassubclass, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> a_Mode=c_ExactlyMode <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> admfn_Table_RowCount(rnspc.nspname,rtbl.relname)::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> rtbl.reltuples::<span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class tbl <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace nspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.relnamespace = nspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description dsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> dsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_depend dp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> tbl.oid=dp.refobjid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_class rtbl <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.OID=dp.objid <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace rnspc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.relnamespace = rnspc.oid <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_Description rdsc <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rtbl.oid=rdsc.objoid <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rdsc.objsubid=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> nspc.nspname=<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_SchemaName) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relkind=c_TableKind <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> rtbl.relkind=c_TableKind <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> tbl.relname =<span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(a_TableName) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rtbl.relname; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> plpgsql; <span class="hljs-keyword"><span class="hljs-keyword">COMMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Table_InheritanceChildrens(a_SchemaName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_TableName <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span>,a_Mode <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-string"><span class="hljs-string">'    '</span></span>; <span class="hljs-comment"><span class="hljs-comment">--ROLLBACK TRANSACTION; COMMIT TRANSACTION; BEGIN TRANSACTION; DROP FUNCTION IF EXISTS admtf_Table_InheritanceChildrens (a_SchemaName VARCHAR(256),a_TableName VARCHAR(256),a_TableName NAME,a_Mode VARCHAR(10)); /************************************************************************/ /*       */ /************************************************************************/ CREATE OR REPLACE FUNCTION admtf_Table_InheritanceChildrens (a_SchemaName VARCHAR(256) default 'public',/*     */ a_TableName VARCHAR(256) default NULL,/*   */ a_Mode VARCHAR(10) default 'estimate' /*     */ ) RETURNS TABLE (rs_TableName VARCHAR(256),rs_TableDescription TEXT, rs_NumberOfAttribute INTEGER,rs_NumberOfChecks INTEGER, rs_hasPKey BOOLEAN,rs_hasIndex BOOLEAN, rs_hasSubClass BOOLEAN,rs_NumberOfRow INTEGER) AS $BODY$ DECLARE c_TableKind CONSTANT CHAR:='r'; BEGIN RETURN QUERY SELECT tic.rs_TableName::VARCHAR(256),tic.rs_TableDescription::TEXT, tic.rs_NumberOfAttribute::INTEGER,tic.rs_NumberOfChecks::INTEGER, tic.rs_hasPKey::BOOLEAN,tic.rs_hasIndex::BOOLEAN, tic.rs_hasSubClass::BOOLEAN,tic.rs_NumberOfRow::INTEGER FROM admtf_Table_InheritanceChildrens(a_SchemaName::NAME, a_TableName::NAME,a_Mode::VARCHAR(10)) tic; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Table_InheritanceChildrens(a_SchemaName VARCHAR(256),a_TableName VARCHAR(256),a_Mode VARCHAR(10)) IS '    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Table_InheritanceChildrens('public'::NAME,'np_house'::NAME); SELECT * FROM admtf_Table_InheritanceChildrens('public'::VARCHAR(256),'np_house'::VARCHAR(256));</span></span></code> </pre><br></div></div><br><a name="tfAttPK"></a><h3>   admtf_Attribute_PKFeatures </h3><br> <a href="https://habr.com/ru/post/418597/">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Attribute_PKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>,a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/***************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        . */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,          */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/***************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Attribute_PKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_isAttributePK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_PKeyName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>,rs_ColumnPKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> C_PKAttributeList_NDims <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_PKAttributeList SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> v_PKAttributeIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_PKAttributeLBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_PKAttributeUBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">--********************************************************************** BEGIN rs_isAttributePK:=false; rs_ColumnPKNo:=NULL; SELECT INTO rs_PKeyName,v_PKAttributeList,rs_isAttributePK conname,conkey,ARRAY[a_AttributeNo]&lt;@conkey FROM pg_constraint c WHERE c.contype='p' and c.conrelid=a_TableOID; IF FOUND AND rs_isAttributePK THEN --      v_PKAttributeLBound:=array_lower(v_PKAttributeList,C_PKAttributeList_NDims); v_PKAttributeUBound:=array_upper(v_PKAttributeList,C_PKAttributeList_NDims); v_PKAttributeIndx:=v_PKAttributeLBound; WHILE v_PKAttributeIndx &lt;= v_PKAttributeUBound AND a_AttributeNo&lt;&gt;v_PKAttributeList[v_PKAttributeIndx] LOOP v_PKAttributeIndx:=v_PKAttributeIndx+1; END LOOP; IF v_PKAttributeIndx&lt;=v_PKAttributeUBound THEN rs_ColumnPKNo:=v_PKAttributeIndx; END IF; END IF; RETURN QUERY SELECT rs_isAttributePK,rs_PKeyName,rs_ColumnPKNo; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Attribute_PKFeatures(a_TableOID OID,a_AttributeNo SMALLINT) IS '              '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Attribute_PKFeatures((SELECT OID FROM pg_class WHERE relname='street'),3::SMALLINT);</span></span></code> </pre><br></div></div><br><a name="tfAttFK"></a><h3>   admtf_Attribute_FKFeatures </h3><br> <a href="https://habr.com/ru/post/418597/">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Attribute_FKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>,a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*        . */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   ,         */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   . */</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Attribute_FKFeatures (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rs_isAttributeFK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rs_FKeyName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rs_ColumnFKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],rs_FKTableName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rs_FKTableColumnName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> C_FKAttributeList_NDims <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKAttributeList SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> v_RefAttributeList SMALLINT[]; <span class="hljs-comment"><span class="hljs-comment">/*     , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKAttributeIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_RefAttributeListIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKAttributeLBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_FKAttributeUBound INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> v_FKConstraintIndx INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKeyName name; <span class="hljs-comment"><span class="hljs-comment">/*   , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FKTableName name; <span class="hljs-comment"><span class="hljs-comment">/*  ,     */</span></span> v_FKTableColumnName name; <span class="hljs-comment"><span class="hljs-comment">/*    , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_RefAttributeNo SMALLINT; <span class="hljs-comment"><span class="hljs-comment">/*     , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_Constraint pg_constraint%ROWTYPE; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  (CONSTRANT) */</span></span> <span class="hljs-comment"><span class="hljs-comment">--****************************************************************************************************** BEGIN rs_isAttributeFK:=false; rs_ColumnFKNo:=NULL; v_FKConstraintIndx:=0; FOR v_Constraint IN SELECT * FROM pg_constraint c WHERE c.contype='f' and c.conrelid=a_TableOID AND ARRAY[a_AttributeNo]&lt;@conkey ORDER BY c.oid LOOP v_FKConstraintIndx:=v_FKConstraintIndx+1; rs_isAttributeFK:=true; v_FKeyName:=v_Constraint.conname; v_FKAttributeList:=v_Constraint.conkey; v_RefAttributeList:=v_Constraint.confkey; v_FKAttributeLBound:=array_lower(v_FKAttributeList,C_FKAttributeList_NDims); v_FKAttributeUBound:=array_upper(v_FKAttributeList,C_FKAttributeList_NDims); v_FKAttributeIndx:=v_FKAttributeLBound; WHILE v_FKAttributeIndx &lt;= v_FKAttributeUBound AND a_AttributeNo&lt;&gt;v_FKAttributeList[v_FKAttributeIndx] LOOP v_FKAttributeIndx:=v_FKAttributeIndx+1; END LOOP; rs_FKeyName[v_FKConstraintIndx]:=v_FKeyName; rs_ColumnFKNo[v_FKConstraintIndx]:=v_FKAttributeIndx; SELECT INTO v_FKTableName ftbl.relname FROM pg_class ftbl WHERE ftbl.oid=v_Constraint.confrelid; rs_FKTableName[v_FKConstraintIndx]:=v_FKTableName; v_RefAttributeNo:=v_RefAttributeList[v_FKAttributeIndx]; v_FKTableColumnName:=NULL; SELECT INTO v_FKTableColumnName attname FROM pg_attribute a WHERE a.attrelid=v_Constraint.confrelid AND a.attnum=v_RefAttributeNo; rs_FKTableColumnName[v_FKConstraintIndx]:=v_FKTableColumnName; END LOOP; RETURN QUERY SELECT rs_isAttributeFK,rs_FKeyName,rs_ColumnFKNo, rs_FKTableName,rs_FKTableColumnName; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Attribute_FKFeatures(a_TableOID OID,a_AttributeNo SMALLINT) IS '              '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Attribute_FKFeatures((SELECT OID FROM pg_class WHERE relname='street'),4::SMALLINT);</span></span></code> </pre><br></div></div><br><a name="tfAttF"></a><br><h3>   admtf_Attribute_Features </h3><br> <a href="https://habr.com/ru/post/418597/">       .</a> <br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> admtf_Attribute_Features (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>,a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>); <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/****************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> admtf_Attribute_Features (a_TableOID <span class="hljs-keyword"><span class="hljs-keyword">OID</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> a_AttributeNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span><span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rsa_AttributeName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>,rsa_UserTypeName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),rsa_TypeName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>),rsa_isNotNULL <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rsa_isAttributePK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>, rsa_ColumnPKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>,rsa_Description <span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>,rsa_isAttributeFK <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span>,rsa_FKeyName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rsa_ColumnFKNo <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>[],rsa_FKTableName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[],rsa_FKTableColumnName <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>[]) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_Return_Error <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> := <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-comment"><span class="hljs-comment">--********************************************************************* BEGIN SELECT INTO rsa_AttributeName,rsa_UserTypeName,rsa_TypeName, rsa_isNotNULL,rsa_Description attr.attname, CASE WHEN COALESCE(typ.typbasetype,0)&gt;0 THEN typ.typname::VARCHAR(100) ELSE ''END AS r_UserTypeName, FORMAT_TYPE(COALESCE(NULLIF(typ.typbasetype,0),typ.oid), COALESCE(NULLIF(typ.typtypmod,-1),attr.atttypmod))::VARCHAR(256) AS r_TypeName, attr.attnotnull AS r_isNotNULL, dsc.description AS r_Description FROM pg_attribute attr LEFT OUTER JOIN pg_type typ ON attr.atttypid=typ.oid LEFT OUTER JOIN pg_type btyp ON typ.typbasetype=btyp.oid LEFT OUTER JOIN pg_description dsc ON dsc.objoid=attr.attrelid AND dsc.objsubid=attr.attnum WHERE attr.attrelid =a_TableOID AND attr.attnum=a_AttributeNo; SELECT INTO rsa_isAttributePK,rsa_ColumnPKNo rs_isAttributePK,rs_ColumnPKNo FROM admtf_Attribute_PKFeatures(a_TableOID,a_AttributeNo); SELECT INTO rsa_isAttributeFK,rsa_FKeyName,rsa_ColumnFKNo,rsa_FKTableName, rsa_FKTableColumnName rs_isAttributeFK,rs_FKeyName, rs_ColumnFKNo,rs_FKTableName,rs_FKTableColumnName FROM admtf_Attribute_FKFeatures(a_TableOID,a_AttributeNo); RETURN QUERY SELECT rsa_AttributeName,rsa_UserTypeName,rsa_TypeName,rsa_isNotNULL, rsa_isAttributePK,rsa_ColumnPKNo,rsa_Description,rsa_isAttributeFK, rsa_FKeyName,rsa_ColumnFKNo,rsa_FKTableName,rsa_FKTableColumnName; END $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION admtf_Attribute_Features(a_TableOID OID,a_AttributeNo SMALLINT) IS '   '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM admtf_Attribute_Features ((SELECT OID FROM pg_class WHERE relname='street'),2::SMALLINT);</span></span></code> </pre><br></div></div><br><h3>  see also </h3><br>  <b><a href="https://habr.com/post/415575/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/415575/">Part One</a> ;</b> <br>  <b><a href="https://habr.com/post/415897/">Functions for documenting PostgreSQL databases.</a></b> <b><a href="https://habr.com/post/415897/"> </a> .</b> <br>  <b><a href="https://habr.com/post/419749/">Functions for documenting PostgreSQL databases.</a></b>  <b><a href="https://habr.com/post/419749/">The end (part four)</a> .</b> </div><p>Source: <a href="https://habr.com/ru/post/418597/">https://habr.com/ru/post/418597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418585/index.html">Building a local map of the robot</a></li>
<li><a href="../418587/index.html">New 3CX clients for Android and iOS with the OPUS and PUSH codec on multiple devices</a></li>
<li><a href="../418589/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ324 (July 23 - 29, 2018)</a></li>
<li><a href="../418591/index.html">Bug Bounty Kyivstar: reward for admin access to Jira, AWS, Apple, Google Developer, Bitbucket services - $ 50</a></li>
<li><a href="../418593/index.html">Not all wireless headphones are equally useful or a few words about the problem of codecs.</a></li>
<li><a href="../418599/index.html">5 data sources that turn APM data into application performance analytics</a></li>
<li><a href="../418601/index.html">The whole truth about the RTOS. Article # 7. Nucleus SE: introduction</a></li>
<li><a href="../418603/index.html">Matrix PowerWatch smart watches that never need to be charged</a></li>
<li><a href="../418605/index.html">Analysts: Microsoft's capitalization could reach $ 1 trillion</a></li>
<li><a href="../418607/index.html">Choosing a vendor in corporate Wi-Fi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>