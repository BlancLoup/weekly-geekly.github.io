<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing the background process on Apache Cordova</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Two years ago I became interested in mobile development for Android. Then I wrote a simple application for parsing websites. The program code was writ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing the background process on Apache Cordova</h1><div class="post__text post__text-html js-mediator-article"><p>  Two years ago I became interested in mobile development for Android.  Then I wrote a simple application for parsing websites.  The program code was written in Java.  It is a very powerful language, but for writing simple, lightweight applications that do not perform complex tasks, its object-oriented paradigm seemed to me not too helpful.  At that time, I was just starting to get familiar with JavaScript.  Initially, he attracted me with his simplicity, then I began to open up more and more opportunities in him.  I was familiar with HTML5 and CSS3, creating fun web pages for fun. </p><a name="habracut"></a><br><p>  Once I learned about Apache Cordova - a framework that allows you to write mobile applications in HTML, CSS and JavaScript.  I immediately installed it. </p><br><p>  Working with Cordova was really convenient.  However, judging by the number of topical articles on the Internet, the framework has not yet received widespread use.  Although it is implemented, for example, the Wikipedia mobile application. </p><br><p>  I believe that this is due to the lack of functionality of the standard Cordova API.  To work with Bluetooth, speech recognition and synthesis, camera, etc.  plugins are required.  Plug-ins can be written for one or several platforms in their native language. </p><br><p>  For the needs of the developers were written thousands of plug-ins that are publicly available.  I was pleased until the moment when I needed to create an application that even after its closure would send a push notification to the user after a certain period of time.  On Android, this function is implemented through a background process.  A plug-in for creating something like this was not found.  The <a href="https://github.com/katzer/cordova-plugin-background-mode">https://github.com/katzer/cordova-plugin-background-mode</a> plugin allowed to run a background process that stopped as soon as the application was closed. </p><br><p>  The forums claimed that it was impossible to create a full-fledged background process on Cordova.  But who prevents you from writing your own plugin for these needs?  After several days of work, I managed to write a plugin and an application that, when it started, started sending notifications to the user every 5 seconds. </p><br><p>  On the way to create an application and a plugin, I want to tell in this post. <habracut></habracut></p><br><h3>  Installing Cordova and running the application </h3><br><p>  Before installing Cordova, be sure to install the Android SDK, Apache Ant and Java. </p><br><p>  Then add them to the system path: </p><br><p> <strong>On Windows:</strong> Type <strong>"Control Panel"</strong> in the search.  Click on <strong>Advanced system settings</strong> .  Click <strong>Environment Variables</strong> .  Under <strong>Environment Variables,</strong> select the PATH environment variable.  Click <strong>Edit</strong> . <br>  Add to the end of the line <code>;C:\Development\adt-bundle\sdk\platform-tools;C:\Development\adt-bundle\sdk\tools;%JAVA_HOME%\bin;%ANT_HOME%\bin</code> . </p><br><p>  <strong>On Mac / Linux:</strong> open .bash_profile with the open <code>~/.bash_profile</code> command.  Add the system variables there: <code>export PATH=${PATH}:/Development/adt-bundle/sdk/platform-tools:/Development/adt-bundle/sdk/tools</code> .  Add paths for Java and Apache Ant if there are none. </p><br><p>  Be sure to specify your path to the folders. </p><br><ol><li><p>  From <a href="https://nodejs.org/en/download/">https://nodejs.org/en/download/, we</a> install Node.js, which allows translating JavaScript into native codes.  The platform contains the npm package manager, with which we will install Cordova. </p><br></li><li><p>  Open a command prompt or terminal and install Cordova <br> <code>npm install -g cordova</code> </p> <br></li><li>  Create a new project: </li></ol><br><p> <code>cordova create MyApp com.app.myapp MyApp</code> </p> <br><p>  The first argument is the name of the folder where the application codes and files will be stored.  In this case, it is MyPluginApp. <br>  The second argument is the name of the application package, its unique identifier. <br>  The third argument is the name of the application that will be visible to the user.  Usually the same as the folder name. </p><br><p>  Do not forget to go to the application folder: </p><br><p>  <code>cd MyApp</code> </p><br><ol><li>  Add the platform on which the application will run.  In my case, this is Android. </li></ol><br><p> <code>cordova platform add android</code> </p> <br><ol><li>  Now we will launch our first Cordova application% </li></ol><br><p> <code>cordova run android</code> </p> <br><p><img src="https://habrastorage.org/files/7a0/417/423/7a0417423345485eaf459864e394906a.png" alt="image"></p><br><h3>  Writing a plugin </h3><br><p>  Now we will create a plugin that will conduct the API to the Service class, which is responsible for the background process. </p><br><p>  To write a plugin, you need to create a regular folder.  Create it in the same directory as the application folder.  Let's call it MyPlugin. </p><br><p>  Any plugin contains a plugin.xml file.  Create and add it to the plugin folder. </p><br><p>  <strong>plugin.xml:</strong> </p><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.phonegap.com/ns/plugins/1.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.example.myplugin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>MyPlugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">engines</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">engine</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cordova"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&gt;=3.4.0"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">engines</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">asset</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"www/MyPlugin.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/MyPlugin.js"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">js-module</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"www/MyPlugin.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyPlugin"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clobbers</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyPlugin"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ,     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">js-module</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config-file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"res/xml/config.xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">parent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/*"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyPlugin"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">param</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android-package"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.example.plugin.MyPlugin"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   java- --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">feature</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config-file</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config-file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AndroidManifest.xml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">parent</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/manifest/application"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.example.plugin.MyService"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    () --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config-file</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">framework</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.android.support:support-v4:+"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ,   java- --&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  java- --&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source-file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"src/android/MyPlugin.java"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target-dir</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"src/com/example/plugin/"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- java-,  Service --&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source-file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"src/android/MyService.java"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">target-dir</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"src/com/example/plugin/"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  This file contains information about the plugin, files and libraries necessary for its operation, as well as API features.  As you can see, we refer to one javascript and two java files.  So create them! </p><br><p>  Add the www folder to the MyPlugin folder and create the MyPlugin.js file there.  There we will describe the functions with which the application can interact with the native code.  That is, this file will serve as a kind of guide between the JavaScript code of the application developer and the Java code of the plugin developer. </p><br><p>  <strong>MyPlugin.js:</strong> </p><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { <span class="hljs-attr"><span class="hljs-attr">runBackground</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">successCallback, errorCallback</span></span></span><span class="hljs-function">) </span></span>{ cordova.exec(successCallback, errorCallback, <span class="hljs-string"><span class="hljs-string">"MyPlugin"</span></span>, <span class="hljs-string"><span class="hljs-string">"runBackground"</span></span>, []) } }</code> </pre> <br><p>  The plugin has one single runBackground function that runs the background process that sends notifications.  As arguments, we give it a function, which is called in the case of successful execution of a command, and a function that reports an error.  Next comes the class name of the native code to which the command will be sent and the name of the command itself.  At the end, an array of additional arguments follows, which we will not touch. </p><br><p>  Finally, let's get down to working with native code.  Create a folder src / android inside MyPlugin.  There will be two Java-classes: MyPlugin.java and MyService.java. </p><br><p>  <strong>MyPlugin.java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.plugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.cordova.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json.JSONArray; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json.JSONException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.Toast; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Notification; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.NotificationManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Intent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.app.NotificationCompat; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyPlugin</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CordovaPlugin</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String action, JSONArray data, CallbackContext callbackContext)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JSONException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action.equals(<span class="hljs-string"><span class="hljs-string">"runBackground"</span></span>)) { Context context = cordova.getActivity().getApplicationContext(); Intent service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(context, MyService.class); context.startService(service); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } }</code> </pre> <br><p>  First, libraries are imported, including org.apache.cordova. *, Which allows you to interact with a Cordova-based application.  Further we can meet Notification and NotificationManager - libraries for working with notifications.  For the sake of the NotificationCompat library, we added the line <code>&lt;framework src="com.android.support:support-v4:+" /&gt;</code> to plugin.xml. </p><br><p>  As soon as the application calls any function of the plugin, the execute method is executed, to which the <code>action</code> string is passed.  Depending on the value of this string, different sets of actions are performed.  In our plugin, <code>action</code> can take only one value - runBackground.  An object of our background process is created and called. </p><br><p>  <strong>MyService.java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.example.plugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.cordova.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Notification; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.NotificationManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Service; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Intent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Handler; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.IBinder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.content.Context; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Handler; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.support.v4.app.NotificationCompat; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span></span>{ Handler mHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startId)</span></span></span><span class="hljs-function"> </span></span>{ mHandler.postDelayed(ToastRunnable, <span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> START_STICKY; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IBinder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } Runnable ToastRunnable = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Context context = getApplicationContext(); NotificationManager mNotificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE); NotificationCompat.Builder mBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotificationCompat.Builder(context) .setSmallIcon(context.getApplicationInfo().icon) .setWhen(System.currentTimeMillis()) .setContentTitle(<span class="hljs-string"><span class="hljs-string">"It works!"</span></span>) .setTicker(<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>) .setContentText(<span class="hljs-string"><span class="hljs-string">"Text"</span></span>) .setNumber(<span class="hljs-number"><span class="hljs-number">1</span></span>) .setAutoCancel(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); mNotificationManager.notify(<span class="hljs-string"><span class="hljs-string">"App Name"</span></span>, <span class="hljs-number"><span class="hljs-number">228</span></span>, mBuilder.build()); mHandler.postDelayed( ToastRunnable, <span class="hljs-number"><span class="hljs-number">5000</span></span>); } }; }</code> </pre> <br><p>  This class is an ordinary Service.  When the service starts, its <code>onStartCommand</code> method returns START_STICKY.  Thanks to this, even after the application is closed, the process continues.  To send push notifications every 5 seconds, a Runnable thread was created, which is called by the handler every 5 seconds.  In the body of the stream, a notification is created and sent. </p><br><h3>  Add a plugin to the application </h3><br><p>  Go to the application directory and add our plugin: </p><br><p>  <code>cordova plugin add ../MyPlugin</code> . </p><br><p>  Then go to www / js / index.js and rewrite the onDeviceReady method as follows: </p><br><pre> <code class="javascript hljs">onDeviceReady: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ app.receivedEvent(<span class="hljs-string"><span class="hljs-string">'deviceready'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> failure = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ alert(<span class="hljs-string"><span class="hljs-string">"Error calling MyPlugin"</span></span>); } MyPlugin.runBackground(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{}, failure); }</code> </pre> <br><p>  Through the MyPlugin object, the runBackground function is called, to which we pass a function, which is called in case of an error, and an empty function if everything is successful.  This function has been left empty, since the confirmation of a successful call from us is already sending a push notification. </p><br><h3>  Conclusion </h3><br><p>  Now we have a working app that sends push notifications every 5 seconds even after we close it. </p><br><p><img src="https://habrastorage.org/files/dfb/077/7c5/dfb0777c52154ccb97e25634922ea3de.png" alt="image"></p><br><p><img src="https://habrastorage.org/files/708/188/936/70818893627a42a487938d7c4c711c94.png" alt="image"></p><br><p>  I want to say that this is just a framework for creating useful applications.  So, for example, you can remind a person that it's time to go for a run (not every 5 seconds, of course).  In any case, this example shows that Cordova using plug-ins is not inferior in functionality to native applications. </p><br><p>  The source code of the application and the plugin can be downloaded from the links: <a href="https://drive.google.com/open%3Fid%3D0B-Jynwu0iBezcVptaEJNeXFlY0k">the application itself</a> , the <a href="https://drive.google.com/open%3Fid%3D0B-Jynwu0iBezUmluQUxFVFpqa00">plugin</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282914/">https://habr.com/ru/post/282914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282902/index.html">Delphi. What does TDictionary</a></li>
<li><a href="../282906/index.html">Administrators of groups in vk have always been in the public domain.</a></li>
<li><a href="../282908/index.html">Virtual IT Infrastructure: Pros and Cons</a></li>
<li><a href="../282910/index.html">NB-IoT: narrow band - broad prospects</a></li>
<li><a href="../282912/index.html">We send data from Arduino to Azure IoT Hub</a></li>
<li><a href="../282916/index.html">IMAPSync. Transfer mail between servers</a></li>
<li><a href="../282918/index.html">Performance Indicators: KVM vs. Xen</a></li>
<li><a href="../282922/index.html">Work with WAV files using PHP</a></li>
<li><a href="../282924/index.html">Test Gradle Plugins Correctly</a></li>
<li><a href="../282926/index.html">About Modbus and Intel Edison Protocol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>