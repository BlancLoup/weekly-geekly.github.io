<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basic troubleshooting in VMware vSphere or what to do if VM slows down</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Something recently technical articles about virtualization (and not only about virtualization) are coming down to the format ‚Äúin the new version such ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basic troubleshooting in VMware vSphere or what to do if VM slows down</h1><div class="post__text post__text-html js-mediator-article">  Something recently technical articles about virtualization (and not only about virtualization) are coming down to the format ‚Äúin the new version such feature is expected‚Äù.  It seems that the analysis of mechanisms and the description of experience, problems and solutions are of interest only to foreign experts.  On the other hand, there is such a problem with the experts - if you study something, it becomes elementary and is taken for granted, so much so that writing about it is somehow silly.  Especially if it was already described by someone somewhere.  Sometime  In some language.  The following is the fruit of the consolidation of personal notes, initially intended for personal ordering of thoughts, but after arranging a considerable amount of text, I thought that it might be useful to someone. <br><br>  A typical problem of ‚Äúvirtualizers‚Äù is the owner of the service, the customer or the user complains that his virtual machine is ‚Äúslowing down‚Äù.  Since virtualization involves the consolidation of a large number of VMs based on a single set of hardware resources, oversubscription (overprovision ‚Äî when we assume that servers do not require the maximum of their resources at the same time, which means, for example, we can not push 10 servers of 4 GB in 40 GB GB of RAM, and 15, using Dynamic Memory), and in addition, servers can slow down due to errors in software components and their settings, then every time you have to decide what to grab and where to look first.  Especially if there is no diagnostic information provided with such a capacious description of the problem as the ‚Äúcar slows down‚Äù, as it often happens.  Under the cut a small guide for this case. <a name="habracut"></a><br>  Of course, everything depends on the specificity of the implementation of a specific infrastructure, but practice shows that in most cases the following sequence of analysis of VM subsystems makes sense: <br><br><img src="https://habrastorage.org/files/91a/580/1df/91a5801dfdab40e1b305e6a5c53bfe3f.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Discs. </li><li>  CPU. </li><li>  RAM. </li><li>  Network </li></ol>  . <br><br>  In practice, it almost never reaches the 4th stage, after the third (and even after the first) it makes sense to run (or request) a parallel diagnostics of the guest OS, but the disks should be checked right away - the most significant part of performance complaints is related to them.  Unless, of course, you have an All-Flash array. <br><br>  And now a little more on each item. <br><br><h4>  1. Disks (storage subsystem) </h4><br>  The key indicator here is Latency.  Delay response time.  It consists of a large number of intermediate elements and depends on a large number of factors.  This includes the response time of the hypervisor, the signal transit time through cables and intermediate devices (switches, adapters and controllers), the time spent in queues on all these devices, if the load on them exceeds the norm, and some other details, such as equipment damage.  However, leaving the nuances for the advanced diagnostics required in rare cases, we can distinguish a simple general indicator - the delay time from VM to disk. <br><br>  Diagnostic Tools: <br><br><h5>  Performance tab </h5><br>  (Performance tab in vSphere Client and performance counters). <br><br><img src="https://habrastorage.org/files/488/9d9/f6b/4889d9f6bc83424092f564a9c0d0b1a2.png"><br><br>  The most commonly used Disk group counters: <br><br>  <i>Highest Latency</i> - the norm up to 10-15 ms.  If regularly higher, you need to change something, although one-time peaks are not terrible; <br>  <i>Average write requests per second</i> ; <br>  <i>Average read requests per second</i> . <br><br>  The most commonly used counters of the Virtual Disk group: <br><br>  <i>Read / Write latency</i> ; <br>  <i>Average number of outstanding read / write requests</i> - the number of simultaneous IO requests (if their number stays above 30 in total per datastor or per server, this will lead to additional delays); <br><br><h5>  ESXTop </h5><br>  Console utility ESX / ESXi.  Provides a whole bunch of diagnostic information about an individual ESXi.  Basic usage information can be obtained by pressing h after running the utility. <br><br><img src="https://habrastorage.org/files/e74/6ff/ceb/e746ffceb9a74b6195e7086d64c4a303.png"><br><br>  In terms of diagnosing the disk subsystem, the context of virtual disks will be useful (press v) and the context of HBA adapters (press d).  In the latter case, you should pay attention to the following indicators: <br><br>  <i>KAVG</i> (Kernel Latency Avg) - hypervisor response time (the norm is up to 1 ms); <br>  <i>DAVG</i> (Device Latency Avg) - response time from HBA to disks (the norm is 10-15ms); <br>  <i>GAVG</i> (Guest Latency Avg) - response time for the guest system = the sum of KAVG and DAVG <br><br>  By the way, in the same area of ‚Äã‚Äãresearch, you should immediately check if VM has a snapshot.  And even a few.  They can be a problem not only in performance, but also in the failures of backup operations, cloning and migration. <br><br><h4>  2. Processor </h4><br>  Here, an indicator similar in importance to disk delays is CPU Ready.  Also pay attention to Used, Wait and Co-Stop.  You can also monitor via the Performance Tab or ESXtop. <br><br>  <i>CPU Ready</i> (% RDY) -% of the time when the VM is ready to perform some calculations, but the physical processors are currently busy with other processes (system or other VMs) and the virtual machine vCPUs are in standby mode.  The norm is a value up to 10%.  With the growth of this indicator above 40%, a high probability of failures and freezes of the guest OS develops.  The cause of forced downtime can be: <br><br><ul><li>  intensive consumption of processor resources by a large number of VMs, and the total number of vCPU significantly exceeds the number of logical cores (oversubscription). </li><li>  The presence of oversized VMs (virtual machines with a large number of underloaded vCPUs, for example, if the machine has 16 cores, each of which runs at 1-20% of power).  The problem here is that with a large number of vCPUs, the hypervisor scheduler has to synchronize their work, which leads to periodic freezing of some cores or even the entire machine, until the total number of logical cores corresponding to the number of vCPUs required for a certain operation is released.  The mechanism is called Co-Stop, and the corresponding counter will grow in this case.  This is the main argument against tamping the virtual machine with virtual processors (the second argument is NUMA, but it is beyond the scope of the article).  Better 2 cores loaded at 80% than eight cores at 20% each.  In most cases. </li><li>  If CPU usage for a virtual machine is limited at the level of the Resource Pool or the machine itself.  Upon reaching a certain threshold, the machine will not receive processor resources and will accumulate CPU Ready.  In this case, the value of the Max-Limited counter (% ML) will increase. </li></ul><br><br>  <i>Wait</i> (% WAIT) -% of the time during which the VM waits for the end of some VMkernel activity.  Most often this is disk IO activity.  High indicators of this counter can speak about insufficiently fast response from the datastor.  Also, the problem may be caused by incorrect operation of USB or COM ports or virtual CD / DVD-drives, in which the currently missing ISO is mounted. <br><br>  <i>Used</i> (% USED) -% of the time during which the machine actually worked.  If it is near zero, then the machine simply stands or is redesigned by processors.  If it is about 100 (for each vCPU), then either it is undersized, or something is stuck in it (if it still doesn‚Äôt respond at the same time), or now some kind of quarterly report is being shoved there.  This indicator is worth studying when thinking about ‚Äúwhether to give VMs more processors to work faster?‚Äù.  If it has 4 cores and none is involved by more than 50%, then 8 cores will most likely not accelerate it.  It may even slow down (see CPU Ready). <br><br>  The diagnostic tools are the same. <br><br><h5>  Performance tab </h5><br><img src="https://habrastorage.org/files/8b2/3b4/72d/8b23b472dda541bfab1520d09bfc856c.png"><br><br>  Conveniently, you can see the data not only for the machine as a whole, but also for each core.  In addition, statistics are available for the period.  However, the information is provided not in percent, but in milliseconds.  Since the data is not collected in real-time, but for a certain interval, it shows how much exactly the mc processor was in one or another state.  You can convert to percents by dividing the value by the length of the interval and multiplying by 100%. <br><br>  Example: in the figure a diagram with an interval of 20 seconds (real-time), that is, 20 000 ms.  That is, the average CPU Ready will be 50288/20000 * 100% = 251.44%.  Since the machine has 4 cores, not just one, we divide the result by 4 and we get almost 63%.  The car suffers a lot.  And all because it lies on the third level of nesting Resource Pools with low shares on each. <br><br>  Once again, the conversion formula: <i>&lt;CPUReady value&gt; / &lt;statistics interval in ms&gt; / &lt;vCPU number&gt; * 100%</i> .  It turns out 5% for 1000 ms for one core. <br><br><h5>  ESXTop </h5><br><img src="https://habrastorage.org/files/5f9/411/7f2/5f94117f26fc48b4aa00da227683eca4.png"><br><br>  Here the value is indicated immediately in%.  Only it is indicated immediately in the sum for all cores, so do not be afraid of numbers greater than 100. Divide by the number of vCPU machines. <br><br><h4>  3. RAM </h4><br>  The basic diagnosis here is simple - yes or no.  If there is a balooning fact, then the host lacks memory and guest OS processes suffer because the paging file is actively used.  If there is a swapping fact at the hypervisor level, it is necessary to take urgent measures - a machine caught in a swap falls into a coma in 100% of cases (at least in my practice).  The above facts allow to determine such counters as <br><br>  <i>Balloon</i> (MCTLSZ) - the amount of memory pulled by the baloon driver from the guest OS. <br><br>  <i>Swapped</i> (SWCUR) is the amount of memory placed in .vswp (that is, on the hard disk). <br><br><h4>  4. Network </h4><br>  For problems to be at the network level, in the case of complaints about a separate virtual machine, I remember in my practice only one case - when VDI used some kind of cheap webcam that drove an uncompressed video stream and scored 100 MB / s. <br><br>  It is worth monitoring such counters: <br><br>  <i>Transmit Dropped Packets</i> (% DRPTX) - the number (or percentage in the case of esxtop) of sent packets that have been dropped; <br><br>  <i>Receive Dropped Packets</i> (% DRPRX) - The number (percentage) of received packets dropped. <br><br>  A non-zero value that occurs on a regular basis indicates incorrect operation of network devices or incorrect configuration. <br><br>  For basic diagnostics, covering more than half (perhaps up to 90%) of requests or their own needs in diagnostics and testing, this is enough. </div><p>Source: <a href="https://habr.com/ru/post/259087/">https://habr.com/ru/post/259087/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259075/index.html">Creating AUX input for Kenwood GX806EF2 radio with i2c bus grab</a></li>
<li><a href="../259077/index.html">Encryption of personal correspondence. Friday post</a></li>
<li><a href="../259081/index.html">24 hours PASS - review of the SQL conference reports</a></li>
<li><a href="../259083/index.html">Online development event for Windows 10, June 10, from industry veterans</a></li>
<li><a href="../259085/index.html">John Forbes Nash died</a></li>
<li><a href="../259089/index.html">How large companies organize the Common Customer Service Center (SSC)</a></li>
<li><a href="../259093/index.html">How we modernized the portal yota.ru</a></li>
<li><a href="../259095/index.html">Sexy primes, "slow python" or how I fought against the wall of misunderstanding</a></li>
<li><a href="../259099/index.html">Visualization of sound on a 6E1P lamp</a></li>
<li><a href="../259101/index.html">Yandex research - true or fiction?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>