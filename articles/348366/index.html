<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Personal experience with Firebase Cloud Firestore</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Recently, I increasingly use Firebase in my projects: it is very convenient to do without actually writing the server part. I want to share som...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Personal experience with Firebase Cloud Firestore</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/me/am/hi/meamhiogfwjj_nxvow2pstzj1h4.jpeg" align="left">  Hello!  Recently, I increasingly use Firebase in my projects: it is very convenient to do without actually writing the server part.  I want to share some experience on the frontend side.  In this case, it is Angular, so the official <a href="https://github.com/angular/angularfire2">AngularFire</a> library is <a href="https://github.com/angular/angularfire2">used</a> .  I‚Äôll note in advance that Android is better with libraries and the implementation of Firebase capabilities, as it seemed to me. <a name="habracut"></a></p><br><h4 id="bolshe-kasaemo-firestore">  More about Firestore </h4><br><p> The first is offline data.  It is enabled by default in Android and iOS, but it is disabled for the web, and this was not surprising.  I absolutely didn‚Äôt like this opportunity today, since the data was not updated (but should have been) even after the page was reloaded, and there are no clear controls (at least in the documentation) for cleaning or updating them.  They are stored in IndexedDB, they can be manually cleared, however, the firebase is constantly connected to the database.  Those.  almost the only way for a user to delete (== clear in this case) only at the beginning of the page loading, when the firebase is not yet initialized.  Therefore, I solved the problem by clicking on the <code>window.location.href += '?clear';</code>  , then after reloading the page in the main html file by executing such a high-priority script: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (</span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.location.href.indexOf(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'?clear'</span></span></span><span class="javascript">) !== </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">-1</span></span></span><span class="javascript">) { </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.history.replaceState(</span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">null</span></span></span><span class="javascript">, </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">null</span></span></span><span class="javascript">, </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.location.pathname); </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> request = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.indexedDB.deleteDatabase(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"firestore/[DEFAULT]/your-project/main"</span></span></span><span class="javascript">); request.onsuccess = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Cleared cache successfully"</span></span></span><span class="javascript">); }; request.onerror = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Couldn't clear cache"</span></span></span><span class="javascript">); }; request.onblocked = </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Couldn't clear cache due to the operation being blocked"</span></span></span><span class="javascript">); }; } </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">else</span></span></span><span class="javascript"> { </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">console</span></span></span><span class="javascript">.log(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"Missing clear cache"</span></span></span><span class="javascript">); } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- root     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  It works, but I will not say that it solves the main problems, since synchronization is just awfully implemented. </p><br><p>  Secondly, do not use <code>valueChanges</code> for collection and document, since in 99% of cases metadata is necessary (it turns out).  It is hard to memorize the uid of a document in any of its fields;  the best way is to use <code>snapshotChanges</code> with a map to get a direct uid, like here for Angular: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.store.collection&lt;any&gt;(<span class="hljs-string"><span class="hljs-string">"yourCollection"</span></span>, ref =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ref.orderBy(<span class="hljs-string"><span class="hljs-string">"yourFiled"</span></span>); }).snapshotChanges() .map(actions =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actions.map(action =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { _uid: action.payload.doc.id, ...action.payload.doc.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>() }; }); })</code> </pre> <br><p>  I would also like to note that collections and documents are independent of each other, i.e.  when you select a document, you will not receive its subcollections: these are separate data, and this is done simply for the convenience of data presentation (one of the main differences from the Realtime Database). <br>  Here when designing the database, take into account the document size limit of 1 MB.  And if there can be a lot of data (of some kind of array), then we need to put them in the subcollection. </p><br><h4 id="bolshe-kasaemo-angular">  More about Angular </h4><br><p>  An important question was about saving the document so as not to overwrite other fields.  Actually, I found this solution: </p><br><pre> <code class="hljs coffeescript"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.store.collection(collection) .doc(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ref .set(object, { merge: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }) .<span class="hljs-keyword"><span class="hljs-keyword">then</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showSnackbar(<span class="hljs-string"><span class="hljs-string">" "</span></span>)) .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showSnackbar(<span class="hljs-string"><span class="hljs-string">"   "</span></span>); }); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ,  showSnackbar       showSnackbar = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.snackbar.open(message, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, { duration: <span class="hljs-number"><span class="hljs-number">1000</span></span> }); };</code> </pre> <br><p>  To save Firebase resources (thanks to the excellent implementation of Offline Data), I store the data in the <code>ReplaySubject</code> buffer.  Everything is good, but it is impossible to clear it when updating data, so you have to recreate it: </p><br><pre> <code class="hljs kotlin">clearDocuments() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._documents.complete(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._documents = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._documents = new ReplaySubject(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._refresh.next(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br><p>  Here _refresh is <code>BehaviorSubject</code> , switchMap is perfectly combined with it: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.service._refresh.asObservable() .switchMap(() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.items.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.service._documents.asObservable(); }) .subscribe(document =&gt; { });</code> </pre> <br><h4 id="nebolshoe-lichnoe-vpechatlenie">  Small personal impression </h4><br><p>  I have had experience with the Realtime Database and will say that the Firestore is a more advanced repository, although it may have its drawbacks.  Even in terms of working in the console (it happened by mistake to delete the root node of the Realtime Database) <br>  There is no online emulator of rules in the Firestore (no one has canceled the actual tests), so I use the <code>firestore-security-tests</code> library for testing.  It works great, only, this type of <code>get(/databases/$(database)/documents/info/app).data.version</code> not supported. <br>  I hope with the release of Firestore everything will change for the better. </p><br><h4 id="dopolnenie">  Addition </h4><br><p>  It‚Äôs impossible to connect Firebase with admin rights for the internal site (and because of this you have to hardcod with the rules, the only good thing is that you can specify the signature of the application certificate and so on in the console).  There is a solution for Node.js, but somehow it was not possible to implement it yet.  Can anyone have this experience? </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/348366/">https://habr.com/ru/post/348366/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348356/index.html">Transition from AngularJS to Angular: goals, plans and rules for transferring elements (1/3)</a></li>
<li><a href="../348358/index.html">10 Gigabit Ethernet: Newbie Tips</a></li>
<li><a href="../348360/index.html">OpenVPN OSPF between two servers, multiple tunnels</a></li>
<li><a href="../348362/index.html">Where in Siberia to talk about IT</a></li>
<li><a href="../348364/index.html">BitPaymer (FriedEx) coder created by Dridex banker trojan authors</a></li>
<li><a href="../348368/index.html">Dynamic font size change throughout an Android application using Configuration.fontScale</a></li>
<li><a href="../348374/index.html">Translation of the book "Social Architecture": Chapter 5. Design, development, innovation</a></li>
<li><a href="../348376/index.html">pdbe is an assistant to the built-in python debugger and debugging process</a></li>
<li><a href="../348378/index.html">VDOM do it yourself</a></li>
<li><a href="../348380/index.html">8-bit computer with BASIC and VGA-out on the Arduino</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>