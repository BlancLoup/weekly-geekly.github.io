<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RaZberry - smart home based on Z-Wave and Raspberry Pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many are trying to build a "smart home" with their own hands. When choosing a system, it is necessary to take into account not only the range and cost...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RaZberry - smart home based on Z-Wave and Raspberry Pi</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/728/703/9d1/7287039d17e53e1494151a7cef791c42.jpg" align="left" alt="Raspberri Pi with RaZberry extention board"><img src="https://habrastorage.org/getpro/habr/post_images/b51/0a9/3cc/b510a93cc9de5643b54cbad7bffe6b68.jpg" align="right">  Many are trying to build a "smart home" with their own hands.  When choosing a system, it is necessary to take into account not only the range and cost of end devices, but also the capabilities of the controller.  Most controllers are immediately ready to work out of the box, but represent limited capabilities.  However, it is often the flexibility and possibility of easy integration that is the fundamental criterion in the selection. <br><br>  And so, the long-awaited ‚ÄúLego cube‚Äù for automation systems based on Z-Wave technology, which has the desired flexibility and at the same time great functionality and low price, appeared. <br><br>  The RaZberry expansion card for the Raspberry Pi turns the most popular and cheap mini-computer into a Z-Wave home automation controller. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  RaZberry is a three-in-one solution: <br><ul><li>  Z-Wave ZM3102 Transceiver Board </li><li>  firmware for ZM3102, extending the capabilities of standard stick firmware </li><li>  Z-Way software </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/785/5ca/4a9/7855ca4a9bfa6d8256cb25357c9e134c.png" alt="Razberry" align="right"><br><h5>  Iron </h5><br>  In Linux, RaZberry is visible as com-port / dev / ttyAMA0.  The board essentially consists of a ZM3102 transceiver, an EEPROM memory for storing Z-Wave network data, a PCBA antenna, and a UART foot connector for the Raspberry Pi GPIO.  Only Vcc, Gnd, TX and RX feet are really used.  The rest of the legs are not used to work the board and only help to fix it more tightly.  In theory, these legs can be used for other needs. <br><br><h5>  Firmware </h5><br>  The board provides an interface fully compatible with Sigma Designs Serial API, which makes it possible to use not only the supplied Z-Way software, but also any other software for Z-Wave (Open Z-Wave, LinuxMCE, FHEM or self-written), as well as cloud service Z -Cloud (see <a href="http://code.google.com/p/z-cloud/wiki/WikiRaspberryInstallationHowto">instructions</a> ).  The board also provides an extension of the Sigma Designs Serial API protocol from Z-Wave.Me, which is necessary for the operation of the Z-Way software. <br><br>  The firmware also allows you to update yourself via UART, which will not only fix possible bugs in the future, but also change the firmware version from the one installed by default (SDK 4.54.01) to the older 5.03, which does not have the useful features of NWI, Explorer Frame and Random HomeId, but including SUC / SIS functionality.  (For attentive: yes, I was not mistaken, 4&gt; 5;) <br><br><h5>  Software </h5><br>  Z-Way is installed on top of the Raspbian wheezy by running the command <br> <code><a href="http://razberry.z-/"></a> wget ‚Äêq ‚ÄêO ‚Äê razberry.z-wave.me/install | sudo bash</code> <br> <br>  The installation script will install the Z-Way into / opt / z-way-server, set the script to start in /etc/init.d/Z-Way, add it to the auto launch and configure the ttyAMA0 port.  After rebooting (to apply kernel settings for ttyAMA0 ‚Äî by default, Raspbian uses UART for the console) the server is ready for operation.  In the browser, open <code><a href="http://ip_of_raspberry/"></a> IP_OF_RASPBERRY:8083</code>  <code><a href="http://ip_of_raspberry/"></a> IP_OF_RASPBERRY:8083</code> and start building a Z-Wave network. <br><br>  Consider in more detail the bundled Z-Way software with RaZberry.  It consists of several parts: <br><ul><li>  libzway library - the basis of the Z-Wave engine, providing a C API for simple work with Z-Wave (depends on pthreads, zlib, openssl) </li><li>  library libzwayjs - binding between C and JavaScript engine of Google V8.  Provides a simple JS API for working with the Z-Wave network (depends on libv8 and libzway) </li><li>  library libzwayhttp - HTTP service for serving external clients, including user interfaces.  Provides JSON API (depends on libmicrohttpd, openssl, libzwayjs and libzway) </li><li>  main.cpp - binding for running all services together, reading configs and command line parameters </li></ul><br>  This structure allows the use of different levels of integration with the components of the Z-Way.  For projects where performance is important, a C-level API is available (there are header files for libzway included), for projects where operational development is needed, it is easier to use the JS API.  It is important that both interfaces have a similar structure, which allows you to simply port the code from JavaScript to C after rapid prototyping. <br><br>  Next, I will describe the JavaScript API level and show you how to create simple automation rules.  Interface level C will remain outside the scope of this article.  It is worth noting that the syntax in the Z-Way JavaScript engine on the server side is made by analogy with what was implemented for the Z-Cloud client-side - see the <a href="http://en.z-wave.me/content/z-way-api">Z-Cloud API description</a> .  For further reading, it is assumed that the reader is already familiar with the features of the Z-Wave protocol (see the <a href="http://habrahabr.ru/post/163387/">detailed description of the Z-Wave protocol</a> ). <br><br>  Everything related to Z-Wave in the namespace JavaScript is located in the global zway object, which provides a complete tree of data and methods over Z-Wave devices. <br><br>  The child controller object contains data specific to the Z-Wave controller, as well as a list of devices.  Each device contains a data structure (data), as well as a list of device channels (instances).  Each channel has a list of Z-Wave Command Classes supported by the device.  On the Command Class there are methods for calling functions (Set, Get, ...), as well as a data tree (data) where all information about the Class is stored. <br><br>  Graphically, this can be illustrated like this (picture from the documentation): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/384/896/81e/38489681ec333e27ffbfc6391386c6f0.png"><br><br>  The API structure is asynchronous and is divided into two parts: <br><ul><li>  sending commands and requests </li><li>  receiving state change events </li></ul><br>  Commands are <code>zway.devices[2].instances[0].commandClasses.Basic.Set(0)</code> by requests of the form <code>zway.devices[2].instances[0].commandClasses.Basic.Set(0)</code> (this example will turn off the light).  The .Get () function will send a value request to the device.  <code>zway.devices[2].RequestNodeNeighbourUpdate()</code> will ask the device to update its neighbors, and the <code>zway.AddNodeToNetwork(1)</code> command <code>zway.AddNodeToNetwork(1)</code> start the process of adding a new device to the network.  In more detail all the commands are described in the documentation on the <a href="http://razberry.z-wave.me/docs.php">documentation</a> page of the <a href="http://razberry.z-wave.me/docs.php">project RaZberry</a> .  Each request can add two additional parameters: callback functions for successful and unsuccessful sending. <br><br>  Teams are queued to send the appropriate packages.  Sending is carried out through Sigma Designs Serial API, implemented on the RaZberry expansion board.  All Z-Wave magic is hidden under this level of abstraction: for battery powered devices, these packages are marked as awaiting awakening, a preliminary key exchange is in progress for encryption, to save battery power and time on air, some packages are joined together and much more ... As in any protocol , Z-Wave has a lot of its cockroaches, all of which are under the Z-Way API carpet and do not crawl out. <br><br>  All data received from devices is recorded in a data tree belonging to a device or a Command Class.  Each element of the data tree has attributes value (element value), updateTime, and invalidateTime (timestamp update dates and value obsolescence), name (name).  The tree structure is also described in detail in the documentation.  To receive notifications about changes in tree values, there is an event subscription system.  The bind function for each element of the tree allows you to bind the callback function to change data. <br><br> <code>zway.devices[2].instances[0].commandClasses.Basic.data.level.bind(function (type[, arg]) {}, [arg, [watchChildren=false]]);</code> <br> <br>  The optional arg argument passed to bind will be passed to the callback function and will be useful for passing additional parameters to separate different events that have a common callback handler.  The watchChildren (true or false) parameter allows you to track not only changes to this element of the tree, but also children.  The this object in the callback function is the element of the data tree on which the bind runs: this.value is the value, this.updateTime is the date of the last update, etc.  The type argument contains the bit mask of the type of change (changed, updated, deleted, obsolete, ... - all values ‚Äã‚Äãare described in detail in ZDefsPublic.h, which is included in the software package). <br><br>  Similarly, there is a bind function on the global zway object, which allows you to track changes in the arrays of devices, instances and commandClasses: <br><br> <code>zway.bind(function(type, nodeId, instanceId, commandClassId) {}, [mask = 0xffff])</code> <br> <br>  The type argument indicates the nature of the change (a device / channel / command class has been added / deleted or a data tree file has been saved to disk (ZDDX file). The nodeId triplet, instanceId, commandClassId indicates a modified object. <br><br>  Unbind can unsubscribe from events. <br><br>  To simplify the syntax, you can omit the words <i>commandClasses</i> , <i>instances [0]</i> (exactly zero channel!), <i>.Value</i> ( <code>level == 0</code> similar to <code>level.value == 0</code> , but with JSON serialization without .value, the entire tree element with its attributes will be serialized , and not just the value). <br><br>  It should be noted that the zway global object is native in v8, i.e.  This is not an ordinary JavaScript object: it can only change the data of tree elements.  All other changes in the tree are ignored. <br><br>  Here are some examples: <br><br>  Running shell commands when a Basic Set event controller receives from other devices on the network (for example, a switch is associated with a controller with channel 1 using MultiChannelAssociation) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instanceId = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctrlNodeId = zway.controller.data.nodeId.value; <span class="hljs-comment"><span class="hljs-comment">// Get controler Node Id if (zway.devices[ctrlNodeId] &amp;&amp; zway.devices[ctrlNodeId].instances[instanceId]) { // Check that instance object exists var basicCC = zway.devices[ctrlNodeId].instances[instanceId].Basic; if (basicCC) { // check that Basic exists basicCC.data.level.bind(function() { // bind to Basic level value system("echo " + this.value); }); } }</span></span></code> </pre><br><br>  Automatic shutdown of the dimmer light 10 seconds after switching on (for the relay, use SwitchBinary instead of SwitchMultilevel).  (Here it is assumed that the device is able to send reports and is associated with the controller) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nodeId = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instanceId = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _tmr = <span class="hljs-literal"><span class="hljs-literal">null</span></span> zway.devices[nodeId].instances[instanceId].SwitchMultilevel.data.level.bind(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> node = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = args[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_tmr) { clearTimeout(_tmr); } _tmr = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { _tmr = setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ zway.devices[nodeId].instances[instanceId].SwitchMultilevel.Set(<span class="hljs-number"><span class="hljs-number">0</span></span>); _tmr = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }, <span class="hljs-number"><span class="hljs-number">10</span></span>*<span class="hljs-number"><span class="hljs-number">1000</span></span>); } });</code> </pre><br><br>  (here it is worth noting that to run this code several times you need to enter the _tmr array for each device / channel) <br><br><h5>  Execute javascript code </h5><br>  Where to embed this javascript code?  There are several ways to execute this code: <br><ul><li>  Write the code to a file and put it on the Raspberry Pi SD card in the / opt / z-way-server / [your folder] folder.  Further this code can be executed from automation / main.js: executeFile (pathToJavaScriptFile). </li><li>  You can also register your own javascript file in config.xml instead of the native razberry file. </li><li>  Send it over HTTP via the Z-Way JSON API </li></ul><br><br><h5>  Now we will describe the Z-Way HTTP / JSON API </h5><br>  This interface to the Z-Way server uses the HTTP protocol and the JSON format for data transfer.  Using it is not difficult to create your own graphical interface for the automation server. <br><br>  Commands are encoded directly in the URL request, and the answers come in the usual JSON ajaxera format. <br><br>  The request <i>/ ZWaveAPI / Data / &lt;timestamp&gt;</i> provides a JSON structure for the complete update tree from the time &lt;timestamp&gt;.  She has a look <br> <code>{ <br> path1: object1, <br> path2: object2, <br> ... <br> updateTime: &lt;timestamp&gt; <br> } <br></code> <br>  Here pathN is the path to the changed element of the tree, objectN is the new value of this element.  updateTime - update generation time (you need to specify it in the next request in order to receive updates) <br><br>  If you request <i>/ ZWaveAPI / Data / 0</i> , the server will return the full data structure. <br><br>  Query <i>/ ZWaveAPI / Run / &lt;cmd&gt;</i> runs the JavaScript code <code>zway.&lt;cmd&gt;</code> .  This request is similar to the more general / JS / Run / and is designed to be compatible with the Z-Cloud API service. <br><br>  The query <i>/ JS / Run / &lt;cmd&gt;</i> executes the &lt;cmd&gt; in the v8 engine and returns in JSON the result of the execution of this command. <br><br>  Other commands are described in the documentation. <br><br>  A few examples: <br><ul><li> <code><a href="http://localhost/"></a> localhost:8083/ZWaveAPI/Run/devices[2].SwitchMultilvel.data.level.value</code>  <code><a href="http://localhost/"></a> localhost:8083/ZWaveAPI/Run/devices[2].SwitchMultilvel.data.level.value</code> - returns the last brightness level received from the device (it is necessary to send SwitchMultilevel.Get () before reading) </li><li> <code><a href="http://localhost/"></a> localhost:8083/ZWaveAPI/Run/devices[3].instances[1].SensorMultilvel.data.level.value</code>  <code><a href="http://localhost/"></a> localhost:8083/ZWaveAPI/Run/devices[3].instances[1].SensorMultilvel.data.level.value</code> - returns the last sensor value received from the device (it is necessary to read SensorMultilevel.Get () before reading) </li><li> <code><a href="http://localhost/"></a> localhost:8083/ZWaveAPI/Run/devices[2].Basic.Set(0)</code>  <code><a href="http://localhost/"></a> localhost:8083/ZWaveAPI/Run/devices[2].Basic.Set(0)</code> - turns off the device </li></ul><br><br>  Recall that <i>instances [0]</i> , <i>commandClasses</i> and <i>value</i> can be omitted. <br><br>  <b>!</b>  <b>Do not forget that some characters must be explicitly encoded before sending (url encode): for example, + {}.</b> <br><br>  Together with the software comes a basic interface for the browser.  He also uses the Z-Way JSON API to interact with the server.  Its code is convenient to use to learn how the API works.  An extension to jQuery to track tree updates received by the query <i>/ ZWaveAPI / Data / &lt;timestamp&gt;</i> may also be useful <i>.</i> <br><br>  This is how the interaction of different layers of the system looks like (picture from the documentation): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/11f/c91/9df/11fc919df915d1a919877d89c90ca423.png"><br><br>  After some time, it is planned to write JS scripts for automation intended for ordinary users (the billet curves are already in the automation folder).  They can be used in conjunction with the user's own scripts, i.e.  You can already start writing your own scripts and using them in your projects. <br><br><h5>  Where to get? </h5><br>  Raspberry Pi are sold on <a href="http://ru.rsdelivers.com/campaigns/microsites/raspberry-pi.aspx">RS components</a> or <a href="http://ru.farnell.com/raspberry-pi">Farnell</a> sites. <br>  The RaZberry board and other Z-Wave equipment is available in the <a href="http://rus.z-wave.me/shop/z-waveme-razberry/">online store Z-Wave.Me</a> and others. <br><br><h5>  It's time to automate! </h5><br>  I am sure that RaZberry will be a convenient solution for building low-cost automation systems based on Z-Wave. </div><p>Source: <a href="https://habr.com/ru/post/174825/">https://habr.com/ru/post/174825/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174807/index.html">ThL W8 - a harmonious combination of price and quality</a></li>
<li><a href="../174809/index.html">Christopher Marlo about Habroz</a></li>
<li><a href="../174817/index.html">Microsoft has advanced in jQuery 2.0 support for creating applications for Windows 8</a></li>
<li><a href="../174819/index.html">The 8th edition of the OpenGL Programming Guide has been released.</a></li>
<li><a href="../174821/index.html">Game: Loading a foreign language into the brain</a></li>
<li><a href="../174827/index.html">Review of inexpensive in-channel SoundMAGIC headphones (models ES18 and PL11)</a></li>
<li><a href="../174835/index.html">The digest of news from the world of mobile development for the last week ‚Ññ8 (March 25 - 31, 2013)</a></li>
<li><a href="../174839/index.html">Salamandra Robotica II - amphibious robot that swims in water and crawls on the ground</a></li>
<li><a href="../174845/index.html">AN / FSQ-7 - the most removable computer in history</a></li>
<li><a href="../174847/index.html">Tronsmart Prometheus - media player with Android 4.2 on board</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>