<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VPC statistics service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will discuss what components are used to collect, process and store the metrics of virtual machines, and give examples of how to c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VPC statistics service</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/e8/6a/59e86ae8ebd81680139549.png"><br><br>  In this article, we will discuss what components are used to collect, process and store the metrics of virtual machines, and give examples of how to configure the use of these components in a VPC project. <br><br>  For obtaining metrics and their primary processing, the component <a href="https://docs.openstack.org/ceilometer/latest/" rel="nofollow noopener noreferrer">OpenStack Ceilometer is responsible</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For a long time, it was the only component of OpenStack providing all the basic telemetry capabilities. <br><br>  In the future, the developers have divided the functions of the Ceilometer between several products: <br><br><ul><li>  <a href="https://docs.openstack.org/aodh/latest/" rel="nofollow noopener noreferrer">Aodh</a> - alert service; </li><li>  <a href="http://gnocchi.xyz/index.html" rel="nofollow noopener noreferrer">Gnocchi</a> - storage service of aggregated measurements; </li><li>  <a href="https://docs.openstack.org/panko/latest/" rel="nofollow noopener noreferrer">Panko</a> - <a href="https://docs.openstack.org/panko/latest/" rel="nofollow noopener noreferrer">event</a> storage service; </li><li>  <a href="https://docs.openstack.org/ceilometer/latest/" rel="nofollow noopener noreferrer">Ceilometer</a> is a measurement collection service. </li></ul><br>  Aodh and Panko will remain outside the scope of this article. <br><a name="habracut"></a><br><h2>  Measurement Collection - OpenStack Ceilometer </h2><br>  Ceilometer can collect measurements about the use of CPU, RAM, network interfaces, disks, temperature values ‚Äã‚Äãfrom various sources: <br><br><ul><li>  directly from hypervisors ( <a href="https://www.linux-kvm.org/page/Main_Pag" rel="nofollow noopener noreferrer">KVM</a> , <a href="https://technet.microsoft.com/en-us/library/mt169373(v%3Dws.11).aspx" rel="nofollow noopener noreferrer">Hyper-V</a> , <a href="https://xenserver.org/" rel="nofollow noopener noreferrer">XEN</a> , <a href="https://www.vmware.com/" rel="nofollow noopener noreferrer">VMware</a> ); </li><li>  from the message queue ( <a href="https://www.rabbitmq.com/" rel="nofollow noopener noreferrer">RabbitMQ</a> , <a href="http://zeromq.org/" rel="nofollow noopener noreferrer">ZeroMQ</a> , <a href="https://kafka.apache.org/" rel="nofollow noopener noreferrer">Kafka</a> ); </li><li>  by polling other OpenStack components through the REST API; </li><li>  by polling equipment using SNMP or IPMI protocols. </li></ul><br>  Previously, Ceilometer also provided an API for working with collected dimensions, metrics, and resources.  But since the release of <a href="https://docs.openstack.org/releasenotes/ceilometer/ocata.html" rel="nofollow noopener noreferrer">OpenStack Ocata, the</a> corresponding functionality has been removed from this component, since the main backend for the Ceilometer has become <a href="http://gnocchi.xyz/" rel="nofollow noopener noreferrer">Gnocchi</a> , which has its own full-featured API for working with all these objects. <br><br>  We tried using the Ceilometer from the <a href="https://www.openstack.org/software/juno/" rel="nofollow noopener noreferrer">OpenStack Juno</a> release a few years ago. <br><br>  Our first version of the billing for the <a href="https://selectel.ru/services/cloud/vpc/" rel="nofollow noopener noreferrer">VPC</a> project sent reports to it, where they were available to service programs and users authorized by the standard <a href="https://docs.openstack.org/keystone/latest/" rel="nofollow noopener noreferrer">OpenStack Keystone</a> token. <br><br>  The main backends for Ceilometer at that time were SQL database and <a href="https://www.mongodb.com/what-is-mongodb" rel="nofollow noopener noreferrer">MongoDB</a> .  Unfortunately, both options after six months of use ceased to cope with the load.  This was due to the fact that the structure of the collected data was too loose, not indexed and too detailed. <br><br>  Each measurement was stored in its original form, without any aggregations or changes.  On large amounts of data, simple operations of sampling measurements for a specified time period began to take a very long time and the service became impossible to use. <br><br>  To overcome architectural problems, in 2014, a team of telemetry service developers for OpenStack founded a new project called Gnocchi.  A detailed description of the causes and the chosen solution can be found in the review article on the blog of the main developer of Gnocchi - Julien Dunge: <a href="https://julien.danjou.info/blog/2014/openstack-ceilometer-the-gnocchi-experiment" rel="nofollow noopener noreferrer">OpenStack Ceilometer and the Gnocchi experiment</a> . <br><br><h2>  Ceilometer architecture </h2><br>  The architecture of Ceilometer is clearly shown in the diagram: <br><img src="https://habrastorage.org/webt/59/e8/6a/59e86ae92e5de823069141.png"><br>  On each host where the hypervisor is installed, there is a component of the <a href="https://docs.openstack.org/ceilometer/latest/install/install-compute-ubuntu.html" rel="nofollow noopener noreferrer">Ceilometer Agent Compute</a> , which collects data from virtual machines.  The collected data is then transmitted to the central <a href="https://docs.openstack.org/ceilometer/latest/install/install-base-ubuntu.html" rel="nofollow noopener noreferrer">Ceilometer Agent Notification</a> agent via a message queue. <br><br>  If you need to collect data on the loading of physical hosts, then you can install and use an SNMP agent on them.  In this case, the data will be collected by the central agent <a href="https://docs.openstack.org/ceilometer/latest/install/install-base-ubuntu.html" rel="nofollow noopener noreferrer">Ceilometer Agent Central</a> . <br><br>  After processing, this data will be transferred to the Ceilometer Agent Notification Agent, which will send it to the selected backend for storage. <br><br>  Another central agent, the Ceilometer Agent Notification, can collect information about events from other OpenStack components while listening to a message queue.  This can be useful if you want to monitor and save information about creating, changing or deleting servers, disks or ports. <br><br>  Until recently (and more precisely, before the release of <a href="https://releases.openstack.org/ocata/" rel="nofollow noopener noreferrer">OpenStack Ocata</a> , which took place in February of this year), along with Ceilometer Agent Notification and Ceilometer Agent Central, it was necessary to install another component on the control hosts - Ceilometer Collector. <br><br>  Now this component is no longer used.  All of its functions are performed by the Ceilometer Agent Notification. <br><br><h2>  Ceilometer Setup </h2><br>  The main configuration files of the Ceilometer are: <br><br><ul><li>  <strong>ceilometer.conf</strong> - a file that describes all the basic parameters of Ceilometer (logging, using message queue, authentication, coordination of Ceilometer processes, etc.); </li><li>  <strong>pipeline.yaml</strong> - a file that describes what information and where it should be collected from; </li><li>  <strong>gnocchi_resources.yaml</strong> - a description of the correspondence between Ceilometer and Gnocchi objects (we will discuss this later). </li></ul><br>  The template file <b>ceilometer.conf</b> with all available options can be downloaded or generated using the official documentation: <a href="https://docs.openstack.org/ceilometer/latest/configuration/index.html" rel="nofollow noopener noreferrer">Ceilometer Configuration Options</a> . <br><br>  The file <b>pipeline.yaml</b> is required to be filled in by yourself. <br>  Example: <br><br><pre><code class="python hljs">--- sources: <span class="hljs-comment"><span class="hljs-comment">#  - interval: 600 #    () meters: #   - memory.usage #      () - memory.resident # ,      () name: memory_meters #    sinks: #    - memory.sink #    - interval: 600 #    () meters: #   - disk.device.read.bytes #       - disk.device.write.bytes #       name: disk_meters #    sinks: #    - disk_sink #    sinks: #   - name: memory_sink #    (  "memory_meters") publishers: #   ,      - gnocchi:// #    Gnocchi - name: disk_sink #    (  "memory_meters") publishers: #      - gnocchi:// #    Gnocchi (    )</span></span></code> </pre> <br>  In this file, we can additionally specify transformations for the collected data.  For example, we can convert all obtained values ‚Äã‚Äãof <strong>memory.usage</strong> and <strong>memory.resident metrics</strong> from megabytes to kilobytes.  At the same time, we rename these metrics and add units of measurement to them. <br><br>  To do this, we need to edit the <strong>memory_sink</strong> consumer <strong>in the</strong> following way: <br><br><pre> <code class="python hljs">sinks: - name: memory_sink transformers: - name: <span class="hljs-string"><span class="hljs-string">"unit_conversion"</span></span> <span class="hljs-comment"><span class="hljs-comment">#    unit_conversion parameters: source: map_from: name: "memory\\.(usage|resident)" #   target: map_to: name: "memory.\\1.kilobytes" #   scale: "volume * 1024.0" #    unit: "KB" #    publishers: - gnocchi://</span></span></code> </pre><br>  Detailed information about the format of this file and the application of other transformations can be found in the official documentation: <a href="https://docs.openstack.org/ceilometer/latest/admin/telemetry-data-pipelines.html" rel="nofollow noopener noreferrer">Data processing and pipelines</a> . <br><br>  Next we look at the Gnocchi project, which allows you to store collected measurements in an aggregated form and provides an API for working with them. <br><br><h2>  Data Storage - Gnocchi </h2><br>  The Gnocchi project is a time series database (time-series database). <br>  It should be noted that, in early May 2017, the developers of Gnocchi <a href="https://julien.danjou.info/blog/2017/gnocchi-independence" rel="nofollow noopener noreferrer">decided to bring</a> this project out of the OpenStack infrastructure. <br><br>  The codebase was moved to <a href="https://github.com/gnocchixyz/gnocchi/" rel="nofollow noopener noreferrer">GitHub</a> , and the <a href="https://guides.github.com/features/issues/" rel="nofollow noopener noreferrer">GitHub Issues</a> mechanism is used as a bugtracker.  One of the main reasons is the desire to position Gnocchi not only as a backend to Ceilometer, but as a more versatile product suitable for other solutions.  For example, the Gnocchi repository already has a <a href="https://github.com/gnocchixyz/collectd-gnocchi" rel="nofollow noopener noreferrer">plugin</a> for saving data from <a href="https://collectd.org/" rel="nofollow noopener noreferrer">Collectd</a> and a <a href="https://github.com/gnocchixyz/grafana-gnocchi-datasource" rel="nofollow noopener noreferrer">plugin</a> for plotting graphs in <a href="https://grafana.com/grafana" rel="nofollow noopener noreferrer">Grafana</a> . <br><br>  Consider the device and features of Gnocchi in more detail. <br><br><h2>  Gnocchi Architecture </h2><br><img src="https://habrastorage.org/webt/59/e8/6a/59e86ae953f1d610474780.png"><br>  Gnocchi consists of 2 main components: <br><br><ul><li>  <strong>API</strong> , through which data is saved and updated (for example, from a Ceilometer, or manually), as well as receiving aggregated data; </li><li>  <strong>Metricd</strong> is a daemon that processes just received and not yet sorted data, and saves it in the required form to the selected storage ( <a href="http://ceph.com/" rel="nofollow noopener noreferrer">Ceph</a> , <a href="https://redis.io/" rel="nofollow noopener noreferrer">Redis</a> , <a href="https://docs.openstack.org/swift/latest/" rel="nofollow noopener noreferrer">OpenStack Swift</a> or to the local file system). </li></ul><br>  Starting with version 3.1, Gnocchi introduced support for various types of repositories for processed and raw data.  This separation allows you to place ‚Äúhot‚Äù non-aggregated data on fast storage (for example, Redis, whose support appeared in Gnocchi version 4.0), and save the data in an aggregated form to a more reliable, scalable backend (for example, Ceph, which was still in the most first version of Gnocchi). <br><br>  In addition to direct data storage, Gnocchi additionally requires a SQL database, where metrics indices and their metadata are stored.  You can use MySQL or PostgreSQL for this.  Gnocchi uses its own approach to the preservation of measurements, since all these technologies do not provide the ability to store data in the form of time series. <br><br><h3>  Saving data in Gnocchi </h3><br><img src="https://habrastorage.org/webt/59/e8/6a/59e86ae9270c7779106805.png"><br>  When new data is received, the values ‚Äã‚Äãare not saved in their original form.  Instead, they are aggregated using the methods selected by the user (in our example - methods minimum, maximum, average) and saved with the specified accuracy (in our example - 3600 seconds), in accordance with the established archival policy. <br><br>  We can create an archive policy using the <a href="https://github.com/gnocchixyz/python-gnocchiclient" rel="nofollow noopener noreferrer">python-gnocchiclient</a> console client.  For example, create a policy named <strong>memory_policy</strong> , which contains 3 aggregation methods ‚Äî minimum, maximum, and average, and 2 definitions of how the data will be stored.  The first definition says that we will store data with an accuracy of 1 hour for 7 days.  The second says that we will store data with an accuracy of 1 day for 1 year. <br><br>  In addition, let us specify the value of the back window equal to 72, which will allow us to save not only the metrics created now, but also the old, for some reason, hung metrics for a period of not more than 72 days. <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># gnocchi archive-policy create memory_policy \ &gt; -b 72 \ &gt; -m min -m max -m mean \ &gt; -d 'granularity:1h,timespan:7d' \ &gt; -d 'granularity:1d,timespan:365d'</span></span></code> </pre><br>  In response, we will receive a description of the created policy: <br><pre> <code class="python hljs">+---------------------+-------------------------------------------------------------------------+ | Field | Value | +---------------------+-------------------------------------------------------------------------+ | aggregation_methods | max, min, mean | | back_window | <span class="hljs-number"><span class="hljs-number">72</span></span> | | definition | - points: <span class="hljs-number"><span class="hljs-number">168</span></span>, granularity: <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>, timespan: <span class="hljs-number"><span class="hljs-number">7</span></span> days, <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> | | | - points: <span class="hljs-number"><span class="hljs-number">365</span></span>, granularity: <span class="hljs-number"><span class="hljs-number">1</span></span> day, <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>, timespan: <span class="hljs-number"><span class="hljs-number">365</span></span> days, <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> | | name | memory_policy | +---------------------+-------------------------------------------------------------------------+</code> </pre><br>  Note that for the definitions, the points value was also automatically calculated.  This value is calculated by the formula: <br>  <strong>Points = Timespan / Granularity</strong> <br><br>  It is required to calculate the space that the values ‚Äã‚Äãof stored metrics will occupy. <br>  Gnocchi developers <a href="http://gnocchi.xyz/stable_4.0/running.html" rel="nofollow noopener noreferrer">suggest</a> using the following formula to calculate the required space: <br>  <strong>Size (in bytes) = 8 * points * aggregation methods</strong> <br><br>  This formula is a calculation of the place for the worst case, since the information is always stored in a compressed form.  Using this formula, we can calculate the amount of space for the memory_policy archive policy.  For the first definition (accuracy 1 hour for 7 days) we get 4032 bytes: <br>  <strong>4032 (byte) = 8 * 168 * 3</strong> <br><br>  And for the second definition (accuracy 1 day throughout the year) we get 8760 bytes: <br>  <strong>8760 (byte) = 8 * 365 * 3</strong> <br><br>  The resulting values ‚Äã‚Äãrepresent the used space for one metric stored according to the <strong>memory_policy</strong> policy. <br>  If we, for example, start collecting 2 metrics - memory.usage and memory.resident for 2000 virtual machines, then we will need: <br>  <strong>2000 * 2 * 4032 (byte) = 16.128 MB (for 7 days)</strong> <strong><br></strong>  <strong>2000 * 2 * 8760 (byte) = 35.04 MB (for 1 year)</strong> <br><br><h3>  Gnocchi Resources </h3><br>  All metrics stored in Gnocchi belong to some resources.  A resource is an abstract object that can contain several metrics and can also have additional fields described in the type of this resource. <br>  The relationship of objects metric - resource - type of resource looks like this: <br><img src="https://habrastorage.org/webt/59/e8/6a/59e86ae8ebdab961895227.png"><br>  For example, we have a set of resources like <strong>instance_memory</strong> .  Each resource of this type will contain the metrics <strong>memory.usage</strong> and <strong>memory.resident</strong> . <br>  If we collect metrics from 2000 virtual machines, the number of <strong>instance_memory</strong> resources will also be equal to 2000. <br>  For such resources, it may be useful to store additional information, for example, the host name of the hypervisor running the virtual machine or the identifier of the operating system image (stored in the <a href="https://docs.openstack.org/glance/latest/" rel="nofollow noopener noreferrer">OpenStack Glance</a> service) from which the virtual machine was created. <br><br>  Create the <strong>instance_memory</strong> resource type using the console command.  Let's <strong>specify the</strong> described additional <strong>host</strong> fields, <strong>image_ref</strong> , to store the host name and image identifier, while making the <strong>host</strong> field mandatory: <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># gnocchi resource-type create instance_memory \ &gt; -a host:string:true:min_length=0:max_length=255 \ &gt; -a image_ref:string:false:min_length=0:max_length=255</span></span></code> </pre><br>  In response, we will receive a description of the created resource type: <br><br><pre> <code class="python hljs">+----------------------+-----------------------------------------------------------+ | Field | Value | +----------------------+-----------------------------------------------------------+ | attributes/host | max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, min_length=<span class="hljs-number"><span class="hljs-number">0</span></span>, required=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, type=string | | attributes/image_ref | max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, min_length=<span class="hljs-number"><span class="hljs-number">0</span></span>, required=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, type=string | | name | instance_memory | | state | active | +----------------------+-----------------------------------------------------------+</code> </pre><br>  Similarly, create the <strong>instance_cpu</strong> and <strong>instance_disk</strong> resource types.  The first one will have the same additional fields as the <strong>instance_memory</strong> , and the second one will have an <strong>instance_id</strong> field indicating the server id to which the drive is connected: <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># gnocchi resource-type create instance_cpu \ &gt; -a host:string:true:min_length=0:max_length=255 \ &gt; -a image_ref:string:false:min_length=0:max_length=255 +----------------------+-----------------------------------------------------------+ | Field | Value | +----------------------+-----------------------------------------------------------+ | attributes/host | max_length=255, min_length=0, required=True, type=string | | attributes/image_ref | max_length=255, min_length=0, required=False, type=string | | name | instance_cpu | | state | active | +----------------------+-----------------------------------------------------------+ controller:~# gnocchi resource-type create instance_disk \ &gt; -a instance_id:uuid:true +------------------------+--------------------------+ | Field | Value | +------------------------+--------------------------+ | attributes/instance_id | required=True, type=uuid | | name | instance_disk | | state | active | +------------------------+--------------------------+</span></span></code> </pre><br>  Now let's look at how we can begin to save the Ceilometer metrics in Gnocchi, using the created resource types. <br><br><h2>  Ceilometer + Gnocchi Configuration </h2><br>  In order for the Ceilometer to start using Gnocchi as a backend, you need: <br><br>  1. Add the <strong>meter_dispatchers</strong> option to the <strong>ceilometer.conf</strong> file: <br><br><pre> <code class="python hljs">[DEFAULT] meter_dispatchers = gnocchi</code> </pre><br>  2. Create a file <strong>gnocchi_resources.yaml</strong> , which describes the correspondence between Ceilometer metrics and Gnocchi resource types, and also indicates the additional fields of resource types: <br><br><pre> <code class="python hljs">--- resources: - resource_type: instance_memory <span class="hljs-comment"><span class="hljs-comment">#      metrics: - 'memory.usage' #       - 'memory.resident' #        attributes: host: resource_metadata.instance_host #      image_ref: resource_metadata.image_ref #      - resource_type: instance_disk #      metrics: - 'disk.device.read.bytes' #        - 'disk.device.write.bytes' #        attributes: instance_id: resource_metadata.instance_id #   id   - resource_type: instance_cpu #      metrics: - 'cpu_util' #       attributes: host: resource_metadata.instance_host #      image_ref: resource_metadata.image_ref #     </span></span></code> </pre><br>  After starting the Ceilometer, the data collection and sending to Gnocchi will begin (provided that it was configured according to the <a href="http://gnocchi.xyz/stable_4.0/install.html" rel="nofollow noopener noreferrer">documentation</a> ). <br><br>  You can monitor the processing status of new data and save it in an aggregated form to the selected storage using the command: <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># gnocchi status +-----------------------------------------------------+-------+ | Field | Value | +-----------------------------------------------------+-------+ | storage/number of metric having measures to process | 93 | | storage/total number of measures to process | 93 | +-----------------------------------------------------+-------+</span></span></code> </pre><br>  In the above output, you can see that now the Gnocchi-metricd processes process 93 measurements distributed over 93 metrics. <br><br>  With this command, you can see if the Gnocchi-metricd component is coping with incoming metrics. <br><br>  The processing speed will directly depend on the number of Gnocchi-metricd processes and the performance of the selected data warehouse. <br><br><h2>  Display aggregated information </h2><br>  After the resulting measurements are processed and stored, it will be possible to access the resources and measurements of Gnocchi. <br><br>  Let's output resources with the <strong>instance_memory</strong> type, limit the output to three resources, and display only 4 columns - the resource identifier of the resource itself, its type, the hostname of the virtual machine and the identifier of its image: <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># gnocchi resource list --type instance_memory --limit 3 --column id --column type --column host --column image_ref +--------------------------------------+-----------------+-----------+--------------------------------------+ | id | type | host | image_ref | +--------------------------------------+-----------------+-----------+--------------------------------------+ | 945ad3cc-2617-4b19-a681-5a1cb96d71e1 | instance_memory | compute00 | 3456e843-b7fe-42be-8c4c-0c7d1c2d09c7 | | e33c895f-e38a-4f8e-be07-8fe0d7c8275f | instance_memory | compute02 | 27bbfeb7-0706-4d11-bb59-f98d6b08dc1c | | 023fed66-3fdd-43b6-b02e-325da55b62cc | instance_memory | compute04 | f0f5e0aa-4615-462e-8340-b8258aae90e2 | +--------------------------------------+-----------------+-----------+--------------------------------------+</span></span></code> </pre><br>  <strong>Let's</strong> display columns with metrics and type for the resource <strong>945ad3cc-2617-4b19-a681-5a1cb96d71e1</strong> : <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># gnocchi resource show --column metrics --column type 945ad3cc-2617-4b19-a681-5a1cb96d71e1 +---------+-------------------------------------------------------+ | Field | Value | +---------+-------------------------------------------------------+ | metrics | memory.resident: f56b76ad-5ce8-49fe-975f-6e5da412df31 | | | memory.usage: aa757f46-52b9-40de-898c-524dfe29b7bc | | type | sel_instance | +---------+-------------------------------------------------------+</span></span></code> </pre><br>  Let's look at the average values ‚Äã‚Äãfor measurements of the metric <strong>aa757f46-52b9-40de-898c-524dfe29b7bc</strong> , in the range of 12:00 - 18:00 for the date of August 25, 2017, and with an accuracy of one hour: <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># gnocchi measures show --aggregation mean --granularity 3600 --start 2017-08-25T12:00 --stop 2017-08-25T18:00 aa757f46-52b9-40de-898c-524dfe29b7bc +---------------------------+-------------+---------------+ | timestamp | granularity | value | | +---------------------------+-------------+---------------+ | 2017-08-25T12:00:00+00:00 | 3600.0 | 2231.75 | | 2017-08-25T13:00:00+00:00 | 3600.0 | 2238.66666667 | | 2017-08-25T14:00:00+00:00 | 3600.0 | 2248.58333333 | | 2017-08-25T15:00:00+00:00 | 3600.0 | 2259.08333333 | | 2017-08-25T16:00:00+00:00 | 3600.0 | 2240.41666667 | | 2017-08-25T17:00:00+00:00 | 3600.0 | 2249.66666667 | +---------------------------+-------------+---------------+</span></span></code> </pre><br>  Aggregated information can be obtained not only with the help of the console utility, but also through the REST API.  Consider a few examples: <br><br>  Getting the values ‚Äã‚Äãof <strong>memory.usage</strong> metrics for a resource of type <strong>instance_memory</strong> , with an accuracy of 24 hours, starting from 08.28.2017 <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># curl -XGET \ &gt; -H 'Content-Type: application/json' \ &gt; -H 'X-Auth-Token: KEYSTONE_TOKEN' \ &gt; 'controller:8041/v1/resource/instance_memory/684f5b56-2c06-485a-ae1a-66ab5c4175fb/metric/memory.usage/measures?start=2017-08-28&amp;granularity=86400' \ &gt; | python -m json.tool [ [ "2017-08-28T00:00:00+00:00", 86400.0, 2645.9444444444443 ], [ "2017-08-29T00:00:00+00:00", 86400.0, 2671.625 ], [ "2017-08-30T00:00:00+00:00", 86400.0, 2681.5438596491226 ] ]</span></span></code> </pre><br>  Search for a resource with an <strong>instance_memory</strong> type created after August 29, 2017, with the value ‚Äúcompute19‚Äù in the <strong>host</strong> field: <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># curl -XPOST \ &gt; -H 'Content-Type: application/json' \ &gt; -H 'X-Auth-Token: KEYSTONE_TOKEN' \ &gt; 'controller:8041/v1/search/resource/instance_memory \ &gt; -d '{ &gt; "and": [ &gt; { &gt; "=": { &gt; "host": "compute19" &gt; } &gt; }, &gt; { &gt; "&gt;": { &gt; "started_at": "2017-08-29" &gt; } &gt; } &gt; ] &gt; }' \ &gt; | python -m json.tool [ { "created_by_project_id": "99288fd3d178459f808c1e8bc2cf9e49", "created_by_user_id": "7dd0582d38aa471bbe8995f63a1293a9", "creator": "7dd0582d38aa471bbe8995f63a1293a9:99288fd3d178459f808c1e8bc2cf9e49", "ended_at": null, "host": "compute19", "id": "9052e237-ad17-47be-8aa5-10aacbf6717f", "image_ref": "e12ef13d-783c-4030-9251-ad2c8e270453", "metrics": { "memory.resident": "365db8ce-f4f7-4e59-ac9f-03dcdfe81195", "memory.usage": "084157b7-09d3-45e7-a869-fad62062025a" }, "original_resource_id": "9052e237-ad17-47be-8aa5-10aacbf6717f", "project_id": "99288fd3d178459f808c1e8bc2cf9e49", "revision_end": null, "revision_start": "2017-08-30T20:35:19.214598+00:00", "started_at": "2017-08-30T20:35:19.214577+00:00", "type": "instance_memory", "user_id": "7dd0582d38aa471bbe8995f63a1293a9" } ]</span></span></code> </pre><br>  Getting aggregation by the maximum values ‚Äã‚Äãof <strong>memory.resident</strong> metrics with up to one hour accuracy for virtual machines running on the <strong>compute19</strong> host;  metrics are systematized by project identifiers: <br><br><pre> <code class="python hljs">controller:~<span class="hljs-comment"><span class="hljs-comment"># curl -XPOST \ &gt; -H 'Content-Type: application/json' \ &gt; -H 'X-Auth-Token: KEYSTONE_TOKEN' \ &gt; 'controller:8041/v1/aggregation/resource/instance_memory/metric/memory.resident&amp;aggregation=max&amp;granularity=3600&amp;groupby=project_id' \ &gt; -d '{ &gt; "=": { &gt; "host": "compute19" &gt; } &gt; }' \ &gt; | python -m json.tool [ { "group": { "project_id": "eef577b17cfe4432b7769d0078dbb625" }, "measures": [ [ "2017-08-29T09:00:00+00:00", 3600, 735 ], [ "2017-08-30T11:00:00+00:00", 3600, 949 ] ] }, { "group": { "project_id": "b998dbbb9b02474c9dc49ffc289eae8c" }, "measures": [ [ "2017-08-29T09:00:00+00:00", 3600, 612 ], [ "2017-08-30T11:00:00+00:00", 3600, 642 ] ] } ]</span></span></code> </pre><br>  Other examples of using the REST API are available in the <a href="http://gnocchi.xyz/master/rest.html" rel="nofollow noopener noreferrer">official documentation</a> . <br><br><h2>  Statistics in the VPC service </h2><br>  We currently use the described components in the <a href="https://selectel.ru/services/cloud/vpc/" rel="nofollow noopener noreferrer">VPC</a> service. <br><br>  The following metrics for virtual machines are available to users: <br><br><ul><li>  processor utilization,% ( <strong>cpu_util</strong> ); </li><li>  memory usage, in MB ( <strong>memory.usage</strong> ). </li></ul><br>  Disk metrics: <br><br><ul><li>  the number of bytes / c to read and write ( <strong>disk.device.read.bytes</strong> , <strong>disk.device.write.byte</strong> s); </li><li>  the number of read and write requests per second ( <strong>disk.device.read.requests</strong> , <strong>disk.device.write.requests</strong> ). </li></ul><br>  And metrics for network interfaces: <br><br><ul><li>  the number of bits / c of incoming and outgoing traffic ( <strong>network.incoming.bits</strong> , <strong>network.outgoing.bits</strong> ); </li><li>  the number of incoming and outgoing traffic packets per second ( <strong>network.incoming.packets</strong> , <strong>network.outgoing.packets</strong> ). </li></ul><br>  All data can be obtained either through the REST API or the console client Gnocchi, or as embedded graphs in the server control panel. <br><br><h3>  CPU usage graphs </h3><br><img src="https://habrastorage.org/webt/59/e8/6a/59e86ae95d1c9605674871.png"><br><br><h3>  RAM Charts </h3><br><img src="https://habrastorage.org/webt/59/e8/6a/59e86ae9d802a545747019.png"><br><br><h3>  Disk load charts </h3><br><img src="https://habrastorage.org/webt/59/e8/6a/59e86aea0a761630875367.png"><br><br><h3>  Network Interface Load Charts </h3><br><img src="https://habrastorage.org/webt/59/e8/6a/59e86aea2477f054085111.png"><br><br><h2>  Conclusion </h2><br>  In this article, we looked at two components for collecting, storing, and displaying statistics about OpenStack objects. <br><br>  If you have any questions, welcome to comments. <br><br>  If you would be interested in trying gnocchi as a service to which you could write your own data - write us about it. <br><br>  We would also be happy if you share your own experience using a Ceilometer or Gnocchi. </div><p>Source: <a href="https://habr.com/ru/post/340054/">https://habr.com/ru/post/340054/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340042/index.html">OSSIM + SEC</a></li>
<li><a href="../340044/index.html">7 conclusions self-taught programmer for 1 year</a></li>
<li><a href="../340048/index.html">Why DataScientists do not use errors of the first and second kind</a></li>
<li><a href="../340050/index.html">Why a Python Networker? Part two</a></li>
<li><a href="../340052/index.html">Not on TK</a></li>
<li><a href="../340060/index.html">20 best books for product and project managers</a></li>
<li><a href="../340062/index.html">Due to which Tarantool is so optimal</a></li>
<li><a href="../340064/index.html">What is DFD (data flow diagrams)</a></li>
<li><a href="../340066/index.html">How to hack more than 17,000 sites in one night</a></li>
<li><a href="../340068/index.html">Microsoft has demonstrated a working fuel-powered data center</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>