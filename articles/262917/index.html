<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another way to prepare one-page applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Authors of the article: Boris Soldovskiy SoldovskijBB , Shevtsov Sergey s_shevtsov . 

 Greetings to all who read this post! We are a team of front-en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another way to prepare one-page applications</h1><div class="post__text post__text-html js-mediator-article">  Authors of the article: Boris Soldovskiy <a href="http://habrahabr.ru/users/soldovskijbb/" class="user_link">SoldovskijBB</a> , Shevtsov Sergey <a href="http://habrahabr.ru/users/s_shevtsov/" class="user_link">s_shevtsov</a> . <br><br>  Greetings to all who read this post!  We are a team of front-end developers Targetix.  In this article we will tell you about how the client part of the <a href="http://hybrid.ru/">Hybrid</a> service is arranged - a web interface for interacting with our <abbr title="Centralized platform for the automatic purchase of advertising">TradingDesk</abbr> and <abbr title="Demand side platform">DSP</abbr> . <br><br> <a href="http://habrahabr.ru/company/targetix/blog/262917/"><img src="https://habrastorage.org/files/804/690/2f8/8046902f89d14f4aaf45ae1b3e784921.png" alt="Picture to attract attention"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Introduction </h1><br>  Even before we started working on Hybrid, when our client application development department was formed and possible options for implementing these applications were discussed, under the influence of trends, the choice fell on single-page applications that attracted the fact that with this approach there is no need to constantly load the same content, You can quickly manipulate the display of the page and, if desired, organize offline work.  In addition, minimal dependence on back-end development groups.  Over time, this approach has taken shape and is used for many of our web interfaces. <br><br>  The framework of our applications is based on AMD modules that allow you to limit the scope, reuse the code and make it structured.  For example, we have the module of the page and the module of some popup-window, and in the module of the popup-window some widget-module is used.  At the same time, the popup-window module can be used on several pages.  In this and similar cases it is convenient to use AMD modules, and the RequireJS library helps us in connecting and managing dependencies. <br><br>  Knockout.js is used to display data - a library that implements the <abbr title="Model-View-ViewModel">mvvm-pattern</abbr> and allows you to dynamically change pages thanks to the template engine and the observed variables. <br><a name="habracut"></a><br><h1>  Application structure </h1><br>  If you look at the structure of the application, it is divided into categories according to the purpose of the modules: third-party libraries from third parties, user interface pages, service scripts and utilities.  Some modules are loaded when the application starts, while others are loaded by events from user actions (click, scroll, hashchange). <br><br> <a href=""><img src="https://habrastorage.org/files/689/aa2/aec/689aa2aec9e7459bad06970ecc4d9002.png" align="right" alt="Application structure"></a>  <b>content</b> <br>  Static content, such as images, styles, fonts - everything is like at all. <br><br>  <b>pages</b> <br>  User interface modules, i.e.  pages, pop-ups and embedded widgets directly interacting with the user. <br><br>  <b>scripts</b> <br>  The remaining modules of our application: <br><br>  <b>controllers</b> <br>  A set of modules that provide other modules with a connection to the back-end, in essence, is a layer for working with data, basically each controller works with one set of entities.  For example, NotificationController for working with notifications has methods such as getAll, getUnread, setReadDate. <br><br>  <b>model</b> <br>  These are modules-objects with a set of properties characterizing entities that are used when sending data to the server. <br><br>  <b>viewmodel</b> <br>  The view model is a binding on the model, which, reacting to user actions, changes the model, performs validation and other auxiliary operations. <br><br>  <b>service</b> <br>  It is difficult to unambiguously describe the purpose of these modules, let's look at one of them - the queryManager.  It is a set of methods for working with AJAX, such as GET, POST, DELETE and others, but in addition it inserts a general top-level error handler into requests, concatenates URLs based on config data and request parameters, implements a caching mechanism in localStorage and allows you to track the status of the request and its progress.  It is mainly not used directly and is intended for controllers. <br><br>  <b>plugins</b> <br>  This directory has another level of nesting, but it does not make sense to consider them in more detail.  They contain third-party libraries: RequireJS, jQuery, Knockout and others, as well as our utilities such as dateUtils for working with dates and time. <br><br><h1>  Application architecture </h1><br>  To clearly demonstrate the principle of the application, we decided to describe the processes occurring in it from the moment it is opened in the browser to the moment when the user starts working with it.  It can be schematically depicted as follows (beginning at the bottom left): <br><br> <a href=""><img src="https://habrastorage.org/files/bce/522/91f/bce52291f1a74bfbb8bdf1d6cda716e1.png" alt="Application architecture"></a> <br><br>  It will hardly be clear to the naked eye what is depicted here, although we have added a legend, but let's take it in order. <br><br>  <b>index.html</b> <br>  Of course, the first thing on the page is to connect all the styles and fonts, which will later be used in all possible elements of the user interface.  Below on the page there is a block in which user interface modules will later be substituted.  The next script in our chain is connected. <br><br><div class="spoiler">  <b class="spoiler_title">listing index.html</b> <div class="spoiler_text"><pre><code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Hybrid<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"content-type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"X-UA-Compatible"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IE=edge"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"viewport"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"shortcut icon"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image/x-icon"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/panel/content/images/favicon.ico"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/panel/content/css/basic.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">media</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"screen"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/panel/content/css/campaign.css"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/panel/content/css/font-face.css"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/panel/content/css/media.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">media</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"only screen and (max-width: 1690px)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"custom-scrollbar"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-bind</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"template: { html: html, data: data }"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/panel/scripts/appconfig.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"appconfig-script"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  <b>appconfig.js, require.js and init.js</b> <br>  As you can see, judging by the legend, these blocks are designated as AMD modules, but in fact these are the most common scripts that are loaded by the browser and executed, it is just easier to display the dependencies and stages of execution. <br>  The first one declares a global object that contains methods that return links to the back-end, a login page, a link to a CDN, as well as a field containing an anticash key, which is subsequently added to all GET requests.  The first AJAX request is made to receive some configuration information from the server: whether to use minified scripts or their debug version, what logs to write to the console, whether to display server errors in the interface, and so on.  It is at this moment that the back-end finds out about the client and determines whether authorization is needed or the user is already in the system. <br><br><div class="spoiler">  <b class="spoiler_title">listing appconfig.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.ReJS = {}; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.ReJS.Config = {}; <span class="hljs-comment"><span class="hljs-comment">//#region  url ReJS.CoreAPI = function (url) { return window.location.protocol + '//' + window.location.host + '/core/' + url; }; ReJS.LoginUrl = function (url) { return window.location.protocol + '//' + window.location.host + '/login/' + url; }; ReJS.CDN = function (url) { return ReJS.Config.cdnUrl + "/" + url; }; //#endregion //#region    var query = new XMLHttpRequest(); query.open('GET', ReJS.CoreAPI('metadata/getconfig'), false); query.setRequestHeader('Content-Type', 'application/json'); query.setRequestHeader('Accept', '*/*'); query.send(null); if (query.status == 200) { ReJS.Config = JSON.parse(query.responseText); ReJS.Tail = ReJS.Config.isMinJs ? ".min" : ""; } if (query.status == 401) { window.location = ReJS.LoginUrl("login?ReturnUrl=%2f") + window.location.hash; } //#endregion //#region   ReJS.AntiCahceKey = "bust=46446348"; //#endregion //#region    ReJS.DebugConfig = { route: true, state: true, stateCache: true, stateOnError: true, stateOnCallBackError: true, stateIncorrectQuery: true, stateLoadingState: true, resourceLoad: true, modalEvent: true, poolingEnables: true, showErrors: true, consoleLogging: function (flag) { this.route = flag; this.state = flag; this.stateCache = flag; this.stateOnError = flag; this.stateOnCallBackError = flag; this.stateIncorrectQuery = flag; this.stateLoadingState = flag; this.resourceLoad = flag; this.modalEvent = flag; }, poolingSwitch: function (flag) { this.poolingEnables = flag; }, displayErrors: function (flag) { this.showErrors = flag; } }; ReJS.DebugConfig.consoleLogging(ReJS.Config.isConsoleLogging); ReJS.DebugConfig.displayErrors(ReJS.Config.isDisplayErrors); ReJS.DebugConfig.poolingSwitch(ReJS.Config.isPoolingSwitch); //#endregion //#region     var startdrawtag = document.getElementById("appconfig-script"); var qwerty1tag = document.createElement("script"); qwerty1tag.setAttribute("src", '/panel/scripts/plugins/core/require' + ReJS.Tail + '.js'); qwerty1tag.setAttribute("data-main", '/panel/scripts/init' + ReJS.Tail); startdrawtag.parentElement.appendChild(qwerty1tag); //#endregion</span></span></code> </pre><br></div></div><br>  In the first case, it redirects to the login page, in the second, the script continues to run, during which another script is added to index.html that runs the chain of AMD modules - require.js, and its <i>data-main</i> attribute indicates the configuration file for it - init.js.  It configures the paths to modules and dependencies for non-AMD modules, eventually the first real module is connected. <br><br><div class="spoiler">  <b class="spoiler_title">init.js listing</b> <div class="spoiler_text"><pre> <code class="javascript hljs">requirejs.config({ <span class="hljs-attr"><span class="hljs-attr">enforceDefine</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">catchError</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">waitSeconds</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-attr"><span class="hljs-attr">min</span></span>: ReJS.Tail, <span class="hljs-attr"><span class="hljs-attr">urlArgs</span></span>: ReJS.AntiCahceKey, <span class="hljs-attr"><span class="hljs-attr">baseUrl</span></span>: <span class="hljs-string"><span class="hljs-string">"/panel/scripts/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">paths</span></span>: { <span class="hljs-comment"><span class="hljs-comment">//jquery 'jquery': 'plugins/jquery/jquery', 'jquery-ui-custom': 'plugins/jquery/jquery-ui', 'jquery-cropit': 'plugins/jquery/jquery-cropit', 'jquery-datepicker': 'plugins/jquery/jquery-datepicker', 'jquery-scrollTo': 'plugins/jquery/jquery-scrollTo', 'jquery-stickytableheaders': 'plugins/jquery/jquery-stickytableheaders', //knockout 'knockout': 'plugins/knockout/knockout-3-1-0', 'knockout-mapping': 'plugins/knockout/knockout.mapping', 'knockout-custom-bindings': 'plugins/knockout/knockout.custombindings', 'knockout-both-template': 'plugins/knockout/knockout.bothtemplate', 'knockout-validation': 'plugins/knockout/knockout.validation', 'knockout-validation-rules': 'plugins/knockout/knockout.validation.rules' // etc... }, shim: { 'underscore': { exports: '_' }, 'routie': { exports: 'routie' }, 'browser-detect': { exports: 'bowser' } // etc... } }); // AMD is here !!! define(["appstart"], function () { });</span></span></code> </pre><br></div></div><br>  <b>appstart.js</b> <br>  At this stage, our application begins to overgrow with meat: jQuery loads and initializes its $, Knockout prepares to insert the first page into its template, our global object is clogged, browser compatibility is checked, the messaging system between the ‚ÄúinnerMessage‚Äù modules starts, and a series of requests begins for account data and not only on the server. <br><br>  It's time to make a small digression regarding the interface of the application itself, it is based on the <abbr title="Model-View-ViewModel">mvvm-patern</abbr> , as already mentioned, which is provided by Knockout, and we will call the template or page that dynamically put it in the markup using a template or a page. <br>  The template consists of a bunch of .html and .js files: <br><br><div class="spoiler">  <b class="spoiler_title">listing state.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">"knockout"</span></span>, <span class="hljs-string"><span class="hljs-string">"controller/advertisers/adLibraryController"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ko, map, adLibraryController</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; self.ads = ko.observableArray([]); <span class="hljs-comment"><span class="hljs-comment">//   self.onRender = function () { //     }; self.onLoad = function (loadComplete) { //       adLibraryController.GetAll(function (data) { // data = [{'name': ''}, ...] //   self.ads(data); //   loadComplete(); }); } } } );</span></span></code> </pre><br></div></div><br>  The role of the onRender, onLoad and loadComplete functions will become clear later when we consider the state object. <br><br><div class="spoiler">  <b class="spoiler_title">listing state.html</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-bind</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"foreach: $self.ads"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-bind</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text: name"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  A bunch of variables from the markup script provides the same Knockout template mechanism, which was slightly upgraded so that the same state can be used as a template.  Returning to our script, this is exactly where it happens.  After completion of the operations described above, a page with a module loader is formed (listing line 83). <br><br><div class="spoiler">  <b class="spoiler_title">listing appstart.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">"jquery"</span></span>, <span class="hljs-string"><span class="hljs-string">"knockout"</span></span>, <span class="hljs-string"><span class="hljs-string">"state/page"</span></span>, <span class="hljs-string"><span class="hljs-string">"browser-detect"</span></span>, <span class="hljs-string"><span class="hljs-string">"service/queryManager"</span></span>, <span class="hljs-string"><span class="hljs-string">"underscore"</span></span>, <span class="hljs-string"><span class="hljs-string">"knockout-both-template"</span></span>, <span class="hljs-string"><span class="hljs-string">"knockout-custom-bindings"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$, ko, PageState, browserDetect, QM, _</span></span></span><span class="hljs-function">) </span></span>{ ReJS.Root = {}; ReJS.RootState = {}; ReJS.RouteObject = {<span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span>}; <span class="hljs-comment"><span class="hljs-comment">//    innerMessage //    : // ReJS.innerMessage({example: true}); // //  : // ReJS.innerMessage(function (message) { // if (message &amp;&amp; message.example) { // ... // } // }) ReJS.innerMessageListeners = []; ReJS.innerMessage = function (message) { if (typeof (message) == "function") { ReJS.innerMessageListeners.push(message); } else { for (var i = 0; i &lt; ReJS.innerMessageListeners.length; i++) { ReJS.innerMessageListeners[i](message); } } }; //    if ((browserDetect.msie &amp;&amp; browserDetect.version &lt; 10) || (browserDetect.chrome &amp;&amp; browserDetect.version &lt; 18) || (browserDetect.firefox &amp;&amp; browserDetect.version &lt; 10.0) || (browserDetect.safari &amp;&amp; browserDetect.version &lt; 5) || (browserDetect.opera &amp;&amp; browserDetect.version &lt; 12.0)) { new PageState({ file: "unsupport", onLoad: function (pageInfo, state) { ko.applyBindings(state); state.onRender(); }, onError: ReJS.preLoadError }); } else { loadMetadata(); } //  metadata function loadMetadata() { $.when( QM.ajaxGet({ url: "metadata/getenums", success: function (recvddata) { // } }), QM.ajaxGet({ url: "metadata/getmodules", success: function (recvddata) { // } }), QM.ajaxGet({ url: "metadata/getaccountinfo", success: function (recvddata) { // } }) ).done(function () { new PageState({ file: "loader", onLoad: function (pageInfo, state) { ko.applyBindings(state); // &lt;&lt; --- loader.js state.onRender(); }, onError: ReJS.preLoadError }); } ); } } );</span></span></code> </pre><br></div></div><br>  <b>loader.js</b> <br>  Cold start - that is, loading the main modules: controllers, models, pages, utilities and other data, the relevance of which is unlikely to change during the session of the application, and their presence will save the application from unnecessary loads in the future, which favorably affects the responsiveness of the interface. <br><br><div class="spoiler">  <b class="spoiler_title">listing loader.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">"knockout"</span></span>, <span class="hljs-string"><span class="hljs-string">"stateManager/pages"</span></span>, <span class="hljs-string"><span class="hljs-string">"stateManager/shared"</span></span>, <span class="hljs-string"><span class="hljs-string">"stateManager/popup"</span></span>, <span class="hljs-string"><span class="hljs-string">"stateManager/menu"</span></span>, <span class="hljs-string"><span class="hljs-string">"dateUtils"</span></span>, <span class="hljs-string"><span class="hljs-string">"service/queryManager"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ko, SMPages, SMShared, SMPopup, SMMenu, dateUtils, QM</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     var self = this; //   ,    var totalProgress = SMPages.pageListCount + SMPopup.popupListCount + SMShared.molulListCount + SMMenu.menuModulListCount; //    var currentProgress = 0; //     var nextProgress = function () { ++currentProgress; console.log("totalProgress ==&gt; ", totalProgress); console.log("currentProgress ++&gt; ", currentProgress); if (currentProgress == totalProgress) { loadComplete(); } }; // ,  c metadata    var loadComplete = function () { ReJS.isLoadInterface = true; ko.applyBindings(SMShared.shared.Root.state); SMShared.shared.Root.state.onShow(); }; //   self.onRender = function () { //    SMShared.loadModul(nextProgress); SMMenu.loadMenuModul(nextProgress); SMPages.loadPages(nextProgress); SMPopup.loadPopup(nextProgress); } }; } );</span></span></code> </pre><br></div></div><br>  While the user is watching the splash screen, the following mechanisms in our chain come into action. <br><br>  <b>stateManager.js, state.js, and text.js</b> <br>  The time has come to consider <i>state</i> in more detail.  This is an AMD module whose task is to load two components of a template: a script and its markup into the corresponding <i>data</i> and <i>html</i> fields. <br>  After the script is downloaded and executed in the <i>data</i> field, we will already have a javascript object, and thanks to the text.js extension for require.js, the markup is downloaded as text and placed in the <i>html</i> field. <br><br><div class="spoiler">  <b class="spoiler_title">listing state.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">"knockout"</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ko</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     var self = this; // ,           self.data = ko.observable(null); //js self.html = ko.observable(null); //html self.onRender = function () { self.data().onRender(); }; self.onLoad = function (params) { // (2) self.data().onLoad(params); // (3) }; // ,    : js  text var dataPrefix = "/panel/modules"; var textPrefix = "text!/panel/modules"; //          var dataSource = ""; var textSource = ""; // ,     ;     modulInfo var pageName = ""; var pageType = ""; //    options     var dir = options.dir ? options.dir : ""; var file = options.file ? options.file : ""; pageName = dir + file; dataSource = dataPrefix + "/" + dir + "/" + file + "/" + file + ReJS.Tail + ".js"; textSource = textPrefix + "/" + dir + "/" + file + "/" + file + ".html"; require([dataSource, textSource], function (data, html) { var data = typeof data === "function" ? new data() : data; //  javascript     data self.data(data); //  html     html self.html(html); //    var pageInfo = { "pageFile": file, "pageDir": dir, "pageName": pageName }; //        if (options.onLoad &amp;&amp; typeof options.onLoad === "function") { options.onLoad(pageInfo, self); // (1) } // errback,  ,  requirejs. }, function (err) { console.log('!ERR ' + file); //     if (err.requireModules) { for (var reqmod in err.requireModules) { console.log('&gt;&gt;&gt;' + err.requireModules[reqmod]); } } //        if (options.onError &amp;&amp; typeof options.onError === "function") { options.onError(options); } }); }; });</span></span></code> </pre><br></div></div><br>  The only argument in the state constructor is an option object that has an <i>onLoad</i> (1) method; it should be noted that state itself also has an <i>onLoad</i> (2) method, which calls the corresponding <i>onLoad</i> (3) method on the <i>data</i> object. <br>  To understand this confusion, let's look at the code stateManager.js <br><br><div class="spoiler">  <b class="spoiler_title">listing stateManager.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define([<span class="hljs-string"><span class="hljs-string">"state/page"</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PageState</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> StateManager = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; self.modules = [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'campaigns'</span></span>, <span class="hljs-attr"><span class="hljs-attr">dir</span></span>: <span class="hljs-string"><span class="hljs-string">"advertiser/pages"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'adlibrary'</span></span>, <span class="hljs-attr"><span class="hljs-attr">dir</span></span>: <span class="hljs-string"><span class="hljs-string">"advertiser/pages"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'audience'</span></span>, <span class="hljs-attr"><span class="hljs-attr">dir</span></span>: <span class="hljs-string"><span class="hljs-string">"advertiser/pages"</span></span> } ]; <span class="hljs-comment"><span class="hljs-comment">//   self.pages = []; //    self.loadPages = function (loadComplete) { //     for (var i = 0; i &lt;self.modules.length; i++) { var module = self.modules[i]; (function (module) { new PageState({ file: module.name, dir: module.dir, onLoad: function (pageInfo, state) { // (1) //     for (var j = 0; j &lt; self.modules.length; j++) { //  ,    if (self.modules[j]['name'] == pageInfo.pageFile &amp;&amp; self.modules[j]['dir'] == pageInfo.pageDir) { //        self.pages[pageInfo.pageName] = { 'name': pageInfo.pageName, // name -    'state': state, // state -     knockout  'pageName':self.modules[j]['name'] // pageName -   }; } } state.onLoad(loadComplete); // (2) } }); })(module); } } }; return new StateManager(); });</span></span></code> </pre><br></div></div><br>  In this module, in a loop through the list of pages, the PageState (one of the variants of the state) is created in the <i>loadPages</i> method, which has a <i>loadComplete</i> argument, which is a function of <i>nextProgress</i> from loader.js. <br><br>  For clarity on the steps: <br><ol><li>  loader.js calls the stateManager.js method <i>loadModul</i> with an argument in the form of the <i>nextProgress</i> function, knowing the number of which calls and the number of loaded modules, we can track the progress of their loading. </li><li>  stateManager.js in the PageState constructor passes an argument as an object containing along with the name of the template files and the path to them the <i>onLoad</i> (1) method. </li><li>  state.js, in turn, after completing loading the template, calls the <i>onLoad</i> (1) method from the argument, passing in it a link to itself and other information about the template. </li><li>  stateManager.js puts the resulting template into an array with loaded templates and calls <i>onLoad</i> (2) on the <i>state</i> object, passing in a function reference from the first clause ( <i>nextProgress</i> ). </li><li>  state.js calls the onLoad (3) chain on the <i>data</i> object with forwarding arguments. </li><li>  Now the template module can immediately call <i>loadComplete</i> (it‚Äôs <i>nextProgress</i> from loader.js) in its onLoad handler, or it can send a request to the server to get the data needed by this template.  Thus, in the process of cold start, the modules for their work receive the necessary data. </li></ol><br>  After loading the necessary pages and modules, loader.js prepares the main <b>root</b> page (master page), which contains a set of various other widgets and is intended to interact directly with the user, essentially being the first working screen of the application.  In other words - the user interface is created and the application is ready to work. <br><br>  The state of the interface is saved for the user, both in localStorage and on the server, that is, such settings as selected dates, selected filters, table columns, and so on.  These settings are also loaded during the cold start process and are applied to each specific page when it is initialized. <br><br>  The idea with templates was spied in an article on the habre <a href="http://habrahabr.ru/post/154003/">‚ÄúWriting a complex application on knockoutjs‚Äù</a> dated October 8, 2012.  It is unlikely that the author suspected that his ideas live a full life in our applications, for which he thanks. <br><br>  <b>routie.js</b> <br>  This library as a module is connected to root and monitors the URL change, or rather its hash part, which, in turn, is changed by other code from the application, for example, when clicking a button or link.  In response to this, we can initiate a change in the state of the application by replacing or substituting new templates. <br><br>  A few words about the <i>onRender</i> method is called after the template has been applied to the application's markup, which means the end of the data-bind attribute initialization used by Knockout for binding to the observable fields. <br><br><h2>  Conclusion </h2><br>  This architecture turned out to be flexible, convenient, easily expandable and used in several of our projects, albeit in a slightly modified form.  For example, in our other project, the interface is based on tabs and routing based on a URL is missing, and modules have additional tab-specific functions, such as onOpen, onClose, onActive, onDeactive along with onLoad and loadComplete. <br>  Thanks to the modular approach, we can as a puzzle collect a page from different modules: you can connect any widget to each page, be it a jQuery UI or Kendo UI. <br><br>  Thank you for reading this mess to the end! </div><p>Source: <a href="https://habr.com/ru/post/262917/">https://habr.com/ru/post/262917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262901/index.html">Unity Integration with Google Spreadsheets</a></li>
<li><a href="../262903/index.html">Rendering in MAPS.ME</a></li>
<li><a href="../262905/index.html">DIY Roaming</a></li>
<li><a href="../262911/index.html">Cat Recognition Service</a></li>
<li><a href="../262913/index.html">Bichrome interface in the new browser assembly Vivaldi 1.0.228.3</a></li>
<li><a href="../262921/index.html">CocoaHeads July 24th at Rambler & Co</a></li>
<li><a href="../262925/index.html">Configuring Replication in Mysql 5.6</a></li>
<li><a href="../262927/index.html">Automatic generation of API doc via Annotations or how to come to API documentation</a></li>
<li><a href="../262929/index.html">Automate web application testing using Selenium WebDriver, Python, and Behave</a></li>
<li><a href="../262933/index.html">"Ra-a-avnyayus, quietly!". We align the data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>