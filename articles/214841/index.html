<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>5 ways to compare two byte arrays. Comparative Testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a result of profiling my software, I concluded that it is necessary to optimize the buffer comparison function. 
 Since The CLR does not provide a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>5 ways to compare two byte arrays. Comparative Testing</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/941/929/19a/94192919a1033325f1288b924df37577.jpg" align="left" alt="stopwatch">  As a result of profiling my software, I concluded that it is necessary to optimize the buffer comparison function. <br>  Since  The CLR does not provide a standard way to compare two pieces of memory, then the function was quickly written on its own (if only it worked). <br>  Googling the phrase ‚ÄúBest Way to Compare Byte Arrays in .Net‚Äù, I was confused: in most cases people suggested using either LINQ or Enumerable.SequenceEqual (), which is practically the same thing.  Even on StackOverflow, this was the most popular answer.  Those.  catastrophic popular delusion of the form: <br><br>  ‚ÄúCompiler \ run-time environment will not be worrying about performance.‚Äù <a href="http://stackoverflow.com/questions/43289/comparing-two-byte-arrays-in-net">From here.</a> <br><br>  It was the first time that led me to write this post. <br>  I conducted a comparative test of five ways to compare buffers available from C #, and based on the test results, I gave recommendations on how to choose one. <br>  In addition, I decompiled some functions, and analyzed the code generated by the JIT compiler for the x86 configuration, and also compared the machine code generated by the JIT compiler with the machine code of the CRT function of a similar purpose. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Prehistory </h4><br>  Having written another utility and having achieved its efficiency, I launched the profiler and saw that a huge percentage of the time it takes to compare byte arrays. <br>  The CompareByteArrays () function was on a critical path, and we had to do something about it. <br>  I did not see the algorithmic solution to the performance problem: the algorithms were chosen in advance, and I didn‚Äôt have any ideas on how to reduce the final complexity. <br>  The search results on the World Wide Web were not very pleased: there were no comparisons of the speed of the methods, but how these figures were obtained, what data and under what conditions no one bothered to write. <br>  I had my own assumptions about who and under what conditions would be faster.  I decided to check. <br>  The results were interesting, so the thought of posting here has finally matured. <br><br><h3>  What and what I tested </h3><br><h4>  the main thing </h4><br>  The code was compiled and run on a Windows 7 x64 machine with all the latest updates for .Net 4.0 Client Profile, i.e.  with Microsoft Visual Studion 2010 default settings, and only for x86 configuration, i.e.  This is a 32-bit code.  Firstly, because most of the code I come across is written for 32-bit systems.  Secondly, I believe that for .Net, performance in this configuration is extremely important.  In particular, because a huge amount of existing components is written for 32-bit, and no one will rewrite them, and you need to interact with them, i.e.  they will determine the configuration of the final application.  Secondly, an extremely small number of applications really need 64 bits - the required bit depth is determined primarily by memory requirements and the target platform.  Modern 64-bit x86-compatible processors hardware support 32-bit tasks [1] [2].  It is logical that Windows x64 uses this feature by executing 32-bit code directly [3].  Compiling a 32-bit application into 64 bits multiplies the memory necessary for it and decreases its performance, because the compiler options do not change the processor‚Äôs TLB size, the first level cache does the same, and the pointer size doubles, which in turn also aligns the data modifies [4]. <br><br><h4>  Data size </h4><br>  In my original task, it was necessary to compare byte arrays with a size of 16 bytes and sizes from 1 to 4 * 1024 bytes.  16 bytes - the size of the MD5, 4 Kb - the size of the standard memory page in Windows, so it was chosen for the I / O buffer. <br>  However, I tested the comparison on blocks from 1 byte to 1/2 megabyte, for the simple reason that hashes are not only 16 bytes in size, but also 4, and even 2 bytes (CRC16, CRC32), and memory pages are not only 4 kilobytes, but also 2 MB [2] and even 4 MB.  The results shown on the 1/2 MB blocks turned out to be sufficient to draw a conclusion about working with large blocks, besides my time is not infinite (in the process of testing the computer is better not to touch, so as not to take time from the described process). <br><br>  Based on the results of the first runs, I found it sufficient to compare methods on 25 different sizes of test data.  To do this, I built a testing cycle so that the first test set consisted of 1-byte arrays, and at each next step the size of the test arrays multiplied by the same factor. <br><br>  Parameters were set by constants in the code: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CountArrays = <span class="hljs-number"><span class="hljs-number">128</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    private const int StartArraySize = 1; //    private const int MaxArraySize = 512 * 1024; //    private const int StepsCount = 25; //  private const int MeasurementsCount = 10; // </span></span></code> </pre> <br><br>  The main testing cycle looked like this: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> sizeMultiplier = <span class="hljs-number"><span class="hljs-number">1</span></span>; DoInvestigationStep(sizeMultiplier); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MaxMultiplier = MaxArraySize / StartArraySize; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stepMmltiplier = Math.Pow( MaxMultiplier, <span class="hljs-number"><span class="hljs-number">1</span></span> / (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)StepsCount ); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> step = <span class="hljs-number"><span class="hljs-number">1</span></span>; step &lt;= StepsCount; step++) { sizeMultiplier = Math.Pow(stepMmltiplier, (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) step); DoInvestigationStep(sizeMultiplier); }</code> </pre><br><br>  The size of the array at each step was calculated like this: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arraySize = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) (StartArraySize * p_SizeMultiplier);</code> </pre><br><br><h3>  Tested methods </h3><br><br><h4>  Using the System.Collections.IStructuralEquatable Interface </h4><br>  This is a relatively new way for C #, it appeared only in .NET 4, so it was of particular interest to me: I was curious how slow it was. <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ByteArrayCompareWithIStructuralEquatable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesRight</span></span></span><span class="hljs-function">)</span></span> { IStructuralEquatable eqa1 = p_BytesLeft; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> eqa1.Equals(p_BytesRight, StructuralComparisons.StructuralEqualityComparer); }</code> </pre><br><br><h4>  LINQ, more specifically, Enumerable. SequenceEqual () </h4><br>  This is one of the simplest methods, the easiest to implement.  In addition, it is the most popular method. <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ByteArrayCompareWithSequenceEqual</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesRight</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p_BytesLeft.SequenceEqual(p_BytesRight); }</code> </pre><br><br><h4>  PInvoke, for CRT memcmp () function </h4><br>  Theoretically, this should be the fastest way, but it turned out that this is not always the case: the overhead of interacting with the platform eats quite a long time, and this method in some cases loses its appeal. <br>  Here I bring it in the form as I found it on SO.  It was in this form that I tested it. <br>  On PInvoke.net, it looks a little different. <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">DllImport(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"msvcrt.dll"</span></span></span><span class="hljs-meta">, CallingConvention = CallingConvention.Cdecl)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">memcmp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesRight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p_Count</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ByteArrayCompareWithPInvoke</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesRight</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Validate buffers are the same length. // This also ensures that the count does not exceed the length of either buffer. return p_BytesLeft.Length == p_BytesRight.Length &amp;&amp; memcmp(p_BytesLeft, p_BytesRight, p_BytesLeft.Length) == 0; }</span></span></code> </pre><br><br><h4>  Head-on.  Those.  direct comparison of bytes in the for (;;) loop </h4><br>  This is the most obvious way to compare two arrays, which is why it is of interest. <br>  Initially, the method did not seem too fast, but it turned out that for many situations it is quite acceptable. <br><br>  By the way, one of the variations of this method of comparison was used in the <a href="http://support.microsoft.com/kb/307020">article</a> from the CLR Manufacturers themselves, moreover in the text in which I needed it. <br>  Apparently, their users dokanali such issues. <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ByteArrayCompareWithSimplest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesLeft, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] p_BytesRight</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_BytesLeft.Length != p_BytesRight.Length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length = p_BytesLeft.Length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p_BytesLeft[i] != p_BytesRight[i]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br><br><h4>  Optimized unsafe-method from Khafor Stefanson </h4><br>  The author of the method claims that this optimized method makes the comparison by blocks of 64 bits for the largest possible part of the array, assuming that the beginning of the array is aligned with the QWORD boundary.  It will also work if there is no QWORD alignment, but at a lower speed. <br>  However, in a 32-bit comparison environment, blocks of 64 bits can be achieved only with the help of an assembler: 32-bit general-purpose registers, and the compiler uses them when generating machine code. <br>  So, how this method works efficiently depends on how it is compiled.  In my case - not exactly 64 bits. <br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">// Copyright (c) 2008-2013 Hafthor Stefansson // Distributed under the MIT/X11 software license // Ref: http://www.opensource.org/licenses/mit-license.php. private static unsafe bool UnsafeCompare(byte[] a1, byte[] a2) { if (a1 == null || a2 == null || a1.Length != a2.Length) return false; fixed (byte* p1 = a1, p2 = a2) { byte* x1 = p1, x2 = p2; int l = a1.Length; for (int i = 0; i &lt; l / 8; i++, x1 += 8, x2 += 8) if (*((long*) x1) != *((long*) x2)) return false; if ((l &amp; 4) != 0) { if (*((int*) x1) != *((int*) x2)) return false; x1 += 4; x2 += 4; } if ((l &amp; 2) != 0) { if (*((short*) x1) != *((short*) x2)) return false; x1 += 2; x2 += 2; } if ((l &amp; 1) != 0) if (*((byte*) x1) != *((byte*) x2)) return false; return true; } }</span></span></code> </pre><br><br><h3>  Testing method </h3><br><h4>  Test set </h4><br>  In order to bring the testing conditions as close as possible to the combat ones and to exclude the ‚Äújam‚Äù of the test data in the processor cache (as much as possible with memory), it was decided to generate a lot of test arrays and compare them with each other, i.e.  each array with each. <br><br>  A ‚Äújagged‚Äù array was selected as the test set (in the original documentation - ‚ÄúJagged Array‚Äù).  There were several alternatives, for example, <code>List&lt;byte[]&gt;</code> and <code>LinkedList&lt;byte[]&gt;</code> , but the alternatives did not suit the access time to the element, although the array in .NET does not shine here: the CLR in any case checks the index for the output beyond the array boundaries , even if it is an array with zero base. <br><br>  The test data was generated in such a way that all the arrays were different, and the different element of the array was exactly in the middle. <br><div class="spoiler">  <b class="spoiler_title">Test data generation</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrepareTestData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p_ArraySize</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; CountArrays; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[p_ArraySize]; byteArray[p_ArraySize / <span class="hljs-number"><span class="hljs-number">2</span></span>] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (i &amp; <span class="hljs-number"><span class="hljs-number">0x000000ff</span></span>); s_arrays[i] = byteArray; } }</code> </pre><br></div></div><br><br><h4>  Making comparisons </h4><br>  Since all arrays were supposed to be compared with all, the general view of the method, the execution time of which was measured, is two nested loops over all the arrays of the set, and the test method is called inside them.  The essence of what is happening can be expressed by the code: <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; CountArrays; i++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; CountArrays; j++) Compare( s_arrays[i], s_arrays[j] );</code> </pre><br>  However, there is one ‚Äúbut‚Äù: if you do not use the result of ‚Äúcalculations‚Äù in any way, then the CLR has the full right to not ‚Äúcalculate‚Äù itself.  I came across this before when I experimented with C ++.  With the included optimization ‚Äú-O3‚Äù it was very difficult to measure anything, because  time after time it turned out to be zero.  Therefore, it was decided to exclude such a scenario from the very beginning, so that the result of the comparison function ‚Äúaccumulated‚Äù and returned, and was analyzed at the topmost level. <br><div class="spoiler">  <b class="spoiler_title">Comparison without ignoring the result</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; CountArrays; i++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; CountArrays; j++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = Compare( s_arrays[i], s_arrays[j] ); result = result &amp;&amp; tmp; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Analysis of the comparison result</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stubLocalVar = p_omparisonMethod(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stubLocalVar) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException();</code> </pre><br></div></div><br><br>  Since the comparison methods are 5, and the template described above is common, it seems logical to define a common, ‚Äútemplate‚Äù method and pass the comparison method to it.  In this way: <br><div class="spoiler">  <b class="spoiler_title">Wrong function call method</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithExternalMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; p_Method</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; CountArrays; i++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; CountArrays; j++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = p_Method( s_arrays[i], s_arrays[j] ); result = result &amp;&amp; tmp; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br></div></div><br>  This method, of course, eliminates copying / pasting and reduces the likelihood of error, but at the same time creates unnecessary call indirectness and eliminates inlining, which, in turn, leads to loss of measurement accuracy, especially considering that there are many calls.  That is why I had to create five practically identical methods: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithUnsafeMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithSimplestMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithSequenceEqualMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithPInvokeMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithIStructuralEquatableMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre><br>  However, a higher level, I could already apply the template method. <br><br>  From the code below, it can be seen that the MeasureComparisonTime () function, in which the execution time of the comparison method is measured, takes as a parameter a delegate of type Func.  Its execution time is measured. <br><br><div class="spoiler">  <b class="spoiler_title">Measurement Functions</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMinimalMesuredValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p_MeasurementNumber, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p_PreviousValue, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p_MeasuredValue</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = p_MeasurementNumber == <span class="hljs-number"><span class="hljs-number">0</span></span> ? p_MeasuredValue : Math.Min(p_PreviousValue, p_MeasuredValue); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MeasureComparisonTime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; p_Method, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p_PreviousTime, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> p_MeasurementNumber</span></span></span><span class="hljs-function">)</span></span> { GC.Collect(); GC.Collect(); s_stopwatch.Start(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stubLocalVar = p_Method(); s_stopwatch.Stop(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stubLocalVar) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = GetMinimalMesuredValue(p_MeasurementNumber, p_PreviousTime, s_stopwatch.ElapsedTicks); s_stopwatch.Reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br></div></div><br><br><h4>  Measurement Technique </h4><br>  The time was measured using a standard stopwatch ( <a href="http://msdn.microsoft.com/ru-ru/library/system.diagnostics.stopwatch(v%3Dvs.110).aspx">System.Diagnostics.Stopwatch class</a> ), which is based on <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644904(v%3Dvs.85).aspx">QueryPerformanceCounter ()</a> .  Naturally, they were interested not in milliseconds, but in ticks: in the case of tiny arrays, all measurements in milliseconds would be zero.  There was also an idea to use my ‚Äúbicycle‚Äù based on RDTSC [6], but, first, the first few runs showed that the current methodology is quite accurate, and second, a warning about the need to use <a href="http://msdn.microsoft.com/en-us/library/system.diagnostics.processthread.processoraffinity(v%3Dvs.110).aspx%2522">ProcessThread.ProcessorAffinity</a> , which appeared in recent documentation, suggests that the basis of the work of this class is the above-mentioned CPU clock counter.  All measurements were repeated 10 times, and the best time was taken.  The number 10 was chosen experimentally, as giving fairly accurate results with minimal time. <br><div class="spoiler">  <b class="spoiler_title">All-measurement function</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MeasurementsResults </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoMeasurements</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { MeasurementsResults result; result.SimplestTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; result.SequenceEqualTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; result.PInvokeTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; result.IStructuralEquatableTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; result.UnsafeTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> measurementNumber = <span class="hljs-number"><span class="hljs-number">0</span></span>; measurementNumber &lt; MeasurementsCount; measurementNumber++) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"   {0}"</span></span>, measurementNumber); result.SimplestTime = MeasureComparisonTime(CompareArraysWithSimplestMethod, result.SimplestTime, measurementNumber); result.SequenceEqualTime = MeasureComparisonTime(CompareArraysWithSequenceEqualMethod, result.SequenceEqualTime, measurementNumber); result.PInvokeTime = MeasureComparisonTime(CompareArraysWithPInvokeMethod, result.PInvokeTime, measurementNumber); result.IStructuralEquatableTime = MeasureComparisonTime(CompareArraysWithIStructuralEquatableMethod, result.IStructuralEquatableTime, measurementNumber); result.UnsafeTime = MeasureComparisonTime(CompareArraysWithUnsafeMethod, result.UnsafeTime, measurementNumber); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br></div></div><br><br><h3>  Measurement results and first conclusions </h3><br>  Before the start of the experiment, I had some idea what method would be the winner, and which the outsider, but the results still surprised me.  My predictions were not entirely correct. <br><table cellspacing="2" cellpadding="5"><tbody><tr><th>  Best time (tiki) </th><th>  Array size (bytes) </th><th>  unsafe </th><th>  Head-on </th><th>  PInvoke </th><th>  SequenceEqual </th><th>  Istructuralequatable </th></tr><tr><td>  276 <br></td><td>  one <br></td><td>  1.7 <br></td><td>  one <br></td><td>  6 <br></td><td>  10.5 <br></td><td>  55 <br></td></tr><tr><td>  276 <br></td><td>  one <br></td><td>  1.7 <br></td><td>  one <br></td><td>  6.3 <br></td><td>  10.1 <br></td><td>  55.7 <br></td></tr><tr><td>  325 <br></td><td>  2 <br></td><td>  1,3 <br></td><td>  one <br></td><td>  5.3 <br></td><td>  eleven <br></td><td>  95.2 <br></td></tr><tr><td>  374 <br></td><td>  four <br></td><td>  1.1 <br></td><td>  one <br></td><td>  4.8 <br></td><td>  11.4 <br></td><td>  121.3 <br></td></tr><tr><td>  413 <br></td><td>  eight <br></td><td>  one <br></td><td>  1,3 <br></td><td>  five <br></td><td>  14.1 <br></td><td>  181.2 <br></td></tr><tr><td>  412 <br></td><td>  13 <br></td><td>  one <br></td><td>  1.7 <br></td><td>  4.7 <br></td><td>  17.5 <br></td><td>  252.5 <br></td></tr><tr><td>  490 <br></td><td>  23 <br></td><td>  one <br></td><td>  2.3 <br></td><td>  3.7 <br></td><td>  22.1 <br></td><td>  364.8 <br></td></tr><tr><td>  554 <br></td><td>  39 <br></td><td>  one <br></td><td>  3.4 <br></td><td>  3.5 <br></td><td>  30.1 <br></td><td>  535.9 <br></td></tr><tr><td>  691 <br></td><td>  67 <br></td><td>  one <br></td><td>  4.3 <br></td><td>  2.9 <br></td><td>  39.1 <br></td><td>  727.5 <br></td></tr><tr><td>  887 <br></td><td>  114 <br></td><td>  one <br></td><td>  5.6 <br></td><td>  2.4 <br></td><td>  50.3 <br></td><td>  964.1 <br></td></tr><tr><td>  1212 <br></td><td>  194 <br></td><td>  one <br></td><td>  4.6 <br></td><td>  2.1 <br></td><td>  61.5 <br></td><td>  1190.9 <br></td></tr><tr><td>  1875 <br></td><td>  328 <br></td><td>  one <br></td><td>  4.8 <br></td><td>  1.8 <br></td><td>  65,8 <br></td><td>  1295.8 <br></td></tr><tr><td>  2897 <br></td><td>  556 <br></td><td>  one <br></td><td>  five <br></td><td>  1.6 <br></td><td>  71.5 <br></td><td>  1416.9 <br></td></tr><tr><td>  4565 <br></td><td>  942 <br></td><td>  one <br></td><td>  5.3 <br></td><td>  1.4 <br></td><td>  76.3 <br></td><td>  1521.1 <br></td></tr><tr><td>  7711 <br></td><td>  1595 <br></td><td>  one <br></td><td>  5.2 <br></td><td>  1,3 <br></td><td>  76.2 <br></td><td>  1521.2 <br></td></tr><tr><td>  12482 <br></td><td>  2702 <br></td><td>  one <br></td><td>  5.4 <br></td><td>  1,3 <br></td><td>  79.4 <br></td><td>  1593,6 <br></td></tr><tr><td>  20692 <br></td><td>  4576 <br></td><td>  one <br></td><td>  5.5 <br></td><td>  1.2 <br></td><td>  81.2 <br></td><td>  1626.2 <br></td></tr><tr><td>  34369 <br></td><td>  7750 <br></td><td>  one <br></td><td>  5.6 <br></td><td>  1.2 <br></td><td>  82,8 <br></td><td>  1657.1 <br></td></tr><tr><td>  58048 <br></td><td>  13124 <br></td><td>  one <br></td><td>  5.6 <br></td><td>  1.2 <br></td><td>  82.9 <br></td><td>  1661.9 <br></td></tr><tr><td>  97511 <br></td><td>  22226 <br></td><td>  one <br></td><td>  5.6 <br></td><td>  1.2 <br></td><td>  83.6 <br></td><td>  1677.3 <br></td></tr><tr><td>  173805 <br></td><td>  37640 <br></td><td>  one <br></td><td>  5.4 <br></td><td>  1.1 <br></td><td>  79.5 <br></td><td>  1585.7 <br></td></tr><tr><td>  295989 <br></td><td>  63743 <br></td><td>  one <br></td><td>  5.3 <br></td><td>  1.1 <br></td><td>  79.3 <br></td><td>  1574.9 <br></td></tr><tr><td>  588797 <br></td><td>  107949 <br></td><td>  one <br></td><td>  4.6 <br></td><td>  1.1 <br></td><td>  67.5 <br></td><td>  1340.9 <br></td></tr><tr><td>  1010768 <br></td><td>  182811 <br></td><td>  one <br></td><td>  4.6 <br></td><td>  1.1 <br></td><td>  67 <br></td><td>  1340.4 <br></td></tr><tr><td>  1705668 <br></td><td>  309590 <br></td><td>  one <br></td><td>  4.6 <br></td><td>  1.1 <br></td><td>  67.3 <br></td><td>  1334.1 <br></td></tr><tr><td>  2885452 <br></td><td>  524287 <br></td><td>  one <br></td><td>  4.6 <br></td><td>  1.1 <br></td><td>  67.3 <br></td><td>  1329.1 <br></td></tr></tbody></table><br><br>  The results surprised by the following: <br>  First: the CRT function simply has to be well optimized, and I expected that at a certain stage (the size of the test array) its speed would override the overhead of the platform call, but this did not happen.  Later I repeated the tests with much larger arrays, but even on 1.5 megabytes the unsafe code was faster. <br><br>  Second: I guessed that IStructuralEquatable would be slow, but the numbers just struck me: I definitely did not expect this. <br><br><h3>  Diazassemblirovanie and analysis of individual functions </h3><br>  Such a serious difference between unsafe and Simplest on large arrays (I expected no more than two or three times overweight) suggests that with optimization of cycles and references to array elements in .Net, not everything is as smooth as the .Net supporters say.  Accordingly, I did not deny myself the pleasure to look at the results of the work of JIT'er, i.e.  directly generated machine code. <br><br><h4>  Analysis of the CompareArraysWithSimplestMethod () function </h4><br>  For this, Thread.Sleep (60 * 1000) was inserted at the beginning of the method;  after launching the release build, I hooked up to the OllyDebug process.  Such a cunning move was needed in order not to ruin the optimization of the CLR by any means - to see the picture as it is. <br><br><img src="http://files.rsdn.ru/67254/ByteArrayCompareWithSimplest.png" alt="Screenshot of the debugger window with arrows"><br><br>  Going down the call stack from ntdll.NtDelayExecution () and SleepEx (), I found my function and, after studying it carefully, was once again unpleasantly surprised.  What I really did not like here: <br><ol><li>  Instead of a single RngChkFail check (for the entire cycle at once), the CLR does this check for each index !!! </li><li>  The cycle remained in the form in which I wrote it: the compiler did not ‚Äúunroll‚Äù it. </li><li>  Therefore, the comparison remained single byte, although the CLR was quite capable of optimizing it, for example, by making a comparison of 4 bytes each (register size). </li><li>  Instead of a single return with a single epilogue and clearing the stack, the CLR copied them three times, making the code ‚Äúswelled‚Äù.  In fact, the machine code repeats the C # code almost one to one.  In this regard, the question arises: did he even optimize the code?  Can he do this? </li><li>  Probably due to the previous item (swollen code), the function was not inline. </li></ol><br><br><h4>  UnsafeCompare () function analysis </h4><br>  The result of the decompilation of this function kindled my curiosity and suggested an idea about the other functions.  I decided to compare the CRT function and the unsafe option.  At first I decided to look at the unsafe option.  To do this, I did the same operations as for the first function, except that Thread.Sleep () inserted not into the function itself, but before calling it.  This could hardly affect the essence of what is happening, but somewhat simplified decompilation: the unsafe-function is clearly more complicated than the first. <br><div class="spoiler">  <b class="spoiler_title">Place insert Thread.Sleep ()</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithUnsafeMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; CountArrays; i++) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; CountArrays; j++) { Thread.Sleep( <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmp = UnsafeCompare(s_arrays[i], s_arrays[j]);</code> </pre><br></div></div><br><br>  Of interest is also the first half of this function, i.  until the call to UnsafeCompare ().  It, as well as the first one, demonstrates that any reference to an element of an array causes an index check to occur in the array boundaries.  I highlighted this in the listing. <br><div class="spoiler">  <b class="spoiler_title">CPU Disasm CompareArraysWithUnsafeMethod</b> <div class="spoiler_text"><pre> <code class="hljs perl">;Address Hex <span class="hljs-keyword"><span class="hljs-keyword">dump</span></span> Command Comments <span class="hljs-number"><span class="hljs-number">001</span></span>B0B88 <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebp ;   <span class="hljs-number"><span class="hljs-number">001</span></span>B0B89 <span class="hljs-number"><span class="hljs-number">8</span></span>BEC mov ebp, esp <span class="hljs-number"><span class="hljs-number">001</span></span>B0B8B <span class="hljs-number"><span class="hljs-number">57</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi <span class="hljs-number"><span class="hljs-number">001</span></span>B0B8C <span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> esi <span class="hljs-number"><span class="hljs-number">001</span></span>B0B8D <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx <span class="hljs-number"><span class="hljs-number">001</span></span>B0B8E BF <span class="hljs-number"><span class="hljs-number">01000000</span></span> mov edi, <span class="hljs-number"><span class="hljs-number">1</span></span> ; result = true; <span class="hljs-number"><span class="hljs-number">001</span></span>B0B93 <span class="hljs-number"><span class="hljs-number">33</span></span>DB <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> ebx, ebx ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-number"><span class="hljs-number">001</span></span>B0B95 <span class="hljs-number"><span class="hljs-number">33</span></span>F6 <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi ; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-number"><span class="hljs-number">001</span></span>B0B97 B9 <span class="hljs-number"><span class="hljs-number">60</span></span>EA000<span class="hljs-number"><span class="hljs-number">0</span></span> mov ecx, 0EA6<span class="hljs-number"><span class="hljs-number">0</span></span> ; Thread.Sleep( <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span> ); <span class="hljs-number"><span class="hljs-number">001</span></span>B0B9C E8 0CFBC161 call clr.ThreadNative::Sleep <span class="hljs-number"><span class="hljs-number">001</span></span>B0BA1 <span class="hljs-number"><span class="hljs-number">8</span></span>B15 A8337A03 mov edx, [s_arrays] ; EDX &lt;-- s_arrays <span class="hljs-number"><span class="hljs-number">001</span></span>B0BA7 <span class="hljs-number"><span class="hljs-number">3</span></span>B5A <span class="hljs-number"><span class="hljs-number">04</span></span> cmp ebx, [edx+<span class="hljs-number"><span class="hljs-number">4</span></span>] ; Compare(s_arrays.Length,  ) (<span class="hljs-number"><span class="hljs-number">1</span></span>) !!! <span class="hljs-number"><span class="hljs-number">001</span></span>B0BAA <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> jae short stub_CLR.JIT_RngChkFail <span class="hljs-number"><span class="hljs-number">001</span></span>B0BAC <span class="hljs-number"><span class="hljs-number">8</span></span>B4C9A 0C mov ecx, [ebx*<span class="hljs-number"><span class="hljs-number">4</span></span>+edx+0C] ; ECX &lt;-- s_arrays[i] <span class="hljs-number"><span class="hljs-number">001</span></span>B0BB<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>B72 <span class="hljs-number"><span class="hljs-number">04</span></span> cmp esi, [edx+<span class="hljs-number"><span class="hljs-number">4</span></span>] ; Compare(s_arrays.Length,  ) (<span class="hljs-number"><span class="hljs-number">2</span></span>) !!! <span class="hljs-number"><span class="hljs-number">001</span></span>B0BB3 <span class="hljs-number"><span class="hljs-number">73</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> jae short stub_CLR.JIT_RngChkFail <span class="hljs-number"><span class="hljs-number">001</span></span>B0BB5 <span class="hljs-number"><span class="hljs-number">8</span></span>B54B2 0C mov edx, [esi*<span class="hljs-number"><span class="hljs-number">4</span></span>+edx+0C] ; EDX &lt;-- s_arrays[j] <span class="hljs-number"><span class="hljs-number">001</span></span>B0BB9 FF15 F038140<span class="hljs-number"><span class="hljs-number">0</span></span> call near UnsafeCompare</code> </pre><br></div></div><br><br>  The result of the function decompilation turned out to be quite large and did not fit on one screen, so I did not give a screenshot of the debager window.  Since it is tedious and unproductive to read a large, solid listing, here I bring it in logically unified chunks, accompanying each piece with a brief comment. <br><div class="spoiler">  <b class="spoiler_title">UnsafeCompare (). ParametersChecking</b> <div class="spoiler_text"><pre> <code class="hljs perl">;a1 ========&gt; ECX ;a2 ========&gt; EDX ;Address Hex <span class="hljs-keyword"><span class="hljs-keyword">dump</span></span> Command Comments <span class="hljs-number"><span class="hljs-number">001</span></span>B0BF8 <span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebp ;   <span class="hljs-number"><span class="hljs-number">001</span></span>B0BF9 <span class="hljs-number"><span class="hljs-number">8</span></span>BEC mov ebp, esp <span class="hljs-number"><span class="hljs-number">001</span></span>B0BFB <span class="hljs-number"><span class="hljs-number">57</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ;     , , ,  <span class="hljs-number"><span class="hljs-number">001</span></span>B0BFC <span class="hljs-number"><span class="hljs-number">56</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> esi ;     <span class="hljs-number"><span class="hljs-number">001</span></span>B0BFD <span class="hljs-number"><span class="hljs-number">53</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; <span class="hljs-number"><span class="hljs-number">001</span></span>B0BFE <span class="hljs-number"><span class="hljs-number">83</span></span>EC 0C <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esp</span></span></span><span class="hljs-function">, 0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">C</span></span></span><span class="hljs-function"> </span></span>;       <span class="hljs-number"><span class="hljs-number">3</span></span>*sizeof(DWORD), ..  <span class="hljs-number"><span class="hljs-number">3</span></span>  <span class="hljs-number"><span class="hljs-number">001</span></span>B0C01 <span class="hljs-number"><span class="hljs-number">33</span></span>C<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> eax, eax ; (!) <span class="hljs-number"><span class="hljs-number">001</span></span>B0C03 <span class="hljs-number"><span class="hljs-number">8945</span></span> F<span class="hljs-number"><span class="hljs-number">0</span></span> mov [ebp-<span class="hljs-number"><span class="hljs-number">10</span></span>], eax ; var1 &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> (!) <span class="hljs-number"><span class="hljs-number">001</span></span>B0C06 <span class="hljs-number"><span class="hljs-number">8945</span></span> EC mov [ebp-<span class="hljs-number"><span class="hljs-number">14</span></span>], eax ; var2 &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> (!) <span class="hljs-number"><span class="hljs-number">001</span></span>B0C09 <span class="hljs-number"><span class="hljs-number">85</span></span>C9 test ecx, ecx ; Compare(a1, null) <span class="hljs-number"><span class="hljs-number">001</span></span>B0C0B <span class="hljs-number"><span class="hljs-number">74</span></span> 0C je short return1 <span class="hljs-number"><span class="hljs-number">001</span></span>B0C0D <span class="hljs-number"><span class="hljs-number">85</span></span>D2 test edx, edx ; Compare(a2, null) <span class="hljs-number"><span class="hljs-number">001</span></span>B0C0F <span class="hljs-number"><span class="hljs-number">74</span></span> 08 je short return1 <span class="hljs-number"><span class="hljs-number">001</span></span>B0C11 <span class="hljs-number"><span class="hljs-number">8</span></span>B41 <span class="hljs-number"><span class="hljs-number">04</span></span> mov eax, [ecx+<span class="hljs-number"><span class="hljs-number">4</span></span>] ; eax &lt;-- a1.Length <span class="hljs-number"><span class="hljs-number">001</span></span>B0C14 <span class="hljs-number"><span class="hljs-number">3</span></span>B42 <span class="hljs-number"><span class="hljs-number">04</span></span> cmp eax, [edx+<span class="hljs-number"><span class="hljs-number">4</span></span>] ; Compare(eax, a2.Length) <span class="hljs-number"><span class="hljs-number">001</span></span>B0C17 <span class="hljs-number"><span class="hljs-number">74</span></span> 0A je short argsIsValid return1: <span class="hljs-number"><span class="hljs-number">001</span></span>B0C19 <span class="hljs-number"><span class="hljs-number">33</span></span>C<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> eax, eax ; result &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">001</span></span>B0C1B <span class="hljs-number"><span class="hljs-number">8</span></span>D65 F4 lea esp, [ebp-0C] <span class="hljs-number"><span class="hljs-number">001</span></span>B0C1E <span class="hljs-number"><span class="hljs-number">5</span></span>B <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebx <span class="hljs-number"><span class="hljs-number">001</span></span>B0C1F <span class="hljs-number"><span class="hljs-number">5</span></span>E <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> esi <span class="hljs-number"><span class="hljs-number">001</span></span>B0C2<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> edi <span class="hljs-number"><span class="hljs-number">001</span></span>B0C21 <span class="hljs-number"><span class="hljs-number">5</span></span>D <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebp <span class="hljs-number"><span class="hljs-number">001</span></span>B0C22 C3 ret argsIsValid: ;   </code> </pre><br></div></div><br><br>  In accordance with the fastcall calling convention, which follows the .NET Framework [7] [8], the first and second parameters are in the ecx and edx registers, in order from left to right.  In the above listing, the sequential check of input parameters is clearly visible, it almost uniquely corresponds to the code in C # <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a1 == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || a2 == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || a1.Length != a2.Length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre><br>  However, the highlighted lines deserve special attention: their purpose is unclear and they confuse.  To understand what it is and why it might be needed, I had to run another experiment, during which I wrote the simplest unsafe function in C #, which uses the fixed clause and the pointer call, and carried out similar actions with it. <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsafe</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">func1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] param1</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">fixed</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>* p = param1) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *p; } }</code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Dizasm simplest unsafe function</b> <div class="spoiler_text"><pre> <code class="hljs ruby">;param1 ========&gt; ECX Address Hex dump Command Comments $ ==&gt; <span class="hljs-number"><span class="hljs-number">55</span></span> push ebp ;   $+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>BEC mov ebp, esp $+<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> push eax ; (!) $+<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span>C<span class="hljs-number"><span class="hljs-number">0</span></span> xor eax, eax ; (!) $+<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">8945</span></span> FC mov [ebp-<span class="hljs-number"><span class="hljs-number">4</span></span>], eax ; var1 &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> (!) $+<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span>C9 test ecx, ecx ; Compare(param1, null) $+B <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> je short param_is_null $+D <span class="hljs-number"><span class="hljs-number">8379</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> cmp dword ptr [ecx+<span class="hljs-number"><span class="hljs-number">4</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> ; Compare(param1.Length, <span class="hljs-number"><span class="hljs-number">0</span></span>) $+<span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> jne short not_zero_len <span class="hljs-symbol"><span class="hljs-symbol">param_is_null:</span></span> $+<span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span>D2 xor edx, edx $+<span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">8955</span></span> FC mov [ebp-<span class="hljs-number"><span class="hljs-number">4</span></span>], edx ; var1 &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> $+<span class="hljs-number"><span class="hljs-number">18</span></span> EB 0C jmp short ret_1 <span class="hljs-symbol"><span class="hljs-symbol">not_zero_len:</span></span> $+<span class="hljs-number"><span class="hljs-number">1</span></span>A <span class="hljs-number"><span class="hljs-number">8379</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> cmp dword ptr [ecx+<span class="hljs-number"><span class="hljs-number">4</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> $+<span class="hljs-number"><span class="hljs-number">1</span></span>E <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> jbe short call.JIT_RngChkFail $+<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>D49 08 lea ecx, [ecx+<span class="hljs-number"><span class="hljs-number">8</span></span>] ; ecx &lt;-- param1.BufferPointer $+<span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">894</span></span>D FC mov [ebp-<span class="hljs-number"><span class="hljs-number">4</span></span>], ecx ; var1 &lt;-- ecx <span class="hljs-symbol"><span class="hljs-symbol">ret_1:</span></span> $+<span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>B45 FC mov eax, [ebp-<span class="hljs-number"><span class="hljs-number">4</span></span>] ; eax &lt;-- var1 $+<span class="hljs-number"><span class="hljs-number">29</span></span> 0FB60<span class="hljs-number"><span class="hljs-number">0</span></span> movzx eax, byte ptr [eax] ; eax &lt;-- *eax $+<span class="hljs-number"><span class="hljs-number">2</span></span>C <span class="hljs-number"><span class="hljs-number">8</span></span>BE5 mov esp, ebp ;   $+<span class="hljs-number"><span class="hljs-number">2</span></span>E <span class="hljs-number"><span class="hljs-number">5</span></span>D pop ebp $+<span class="hljs-number"><span class="hljs-number">2</span></span>F C3 ret call.<span class="hljs-symbol"><span class="hljs-symbol">JIT_RngChkFail:</span></span> $+<span class="hljs-number"><span class="hljs-number">30</span></span> E8 B3BDC861 call clr.JIT_RngChkFail $+<span class="hljs-number"><span class="hljs-number">35</span></span> CC int3</code> </pre><br></div></div><br><br>  From the above listing, it becomes clear that as a result of JIT compilation, the variable in the fixed statement must be pushed onto the stack, regardless of the availability of general-purpose registers.  This is well seen from the fact that the eax register was saved on the stack, was not used in the future and, therefore, was free and available for operations (up to offset 0x26 from the beginning of the function), but the stack variable by offset was used for storing temporary data [ ebp-4] (let's call it var1).  The variable is immediately initialized by zero, despite the fact that later this value is not used, but simply erased.  For example, at offset 0x15, zero is entered again in var1, despite the fact that zero is already stored there by this time. <br><br>  Thus, it becomes clear that the selected lines in the listing UnsafeCompare.CPU Disasm.ParametersChecking do not carry any special meaning; this is just a side effect of the compilation.  It also becomes apparent from the above listing that the array is checked in the fixed expression in three stages: first, the array is checked for null equality, then its length is checked for equality to zero (the jne command analyzes only ZF), and only then for equality to zero and the negative value ( jbe checks both ZF and CF).  From my point of view, it is very strange that the last two actions were not merged into one, and all the more strange that the cmp command is executed twice, because the conditional transition does not reset the flags.  Among other things, I am sincerely grateful to those of you who read this line, because it means that I did not try in vain, and my excavation in assembly listings was not in vain. <br><br>  The experiment greatly simplifies further code analysis. <br><br><div class="spoiler">  <b class="spoiler_title">The fixed sentence from the CompareArraysWithUnsafeMethod () function</b> <div class="spoiler_text"><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">argsIsValid</span></span>: 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C23</span></span> 8379 04 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ecx+4]</span></span>, 0 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Compare</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Length</span></span>, 0)       001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C27</span></span> 75 07 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jne</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1Len_NonZero</span></span> ;   001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C29</span></span> 33<span class="hljs-selector-tag"><span class="hljs-selector-tag">C0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C2B</span></span> 8945 <span class="hljs-selector-tag"><span class="hljs-selector-tag">F0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-10]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">var1</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> 0 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C2E</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EB</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1Len_Zero</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1Len_NonZero</span></span>: 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C30</span></span> 8379 04 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ecx+4]</span></span>, 0 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Compare</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Length</span></span>, 0)  ()     001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C34</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">F86</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">B5000000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jbe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.JIT_RngChkFail</span></span> ;     001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C3A</span></span> 8<span class="hljs-selector-tag"><span class="hljs-selector-tag">D41</span></span> 08 <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ecx+8]</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.BufferPointer</span></span> 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C3D</span></span> 8945 <span class="hljs-selector-tag"><span class="hljs-selector-tag">F0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-10]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">var1</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a1Len_Zero</span></span>: 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C40</span></span> 837<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> 04 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[edx+4]</span></span>, 0 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Compare</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">a2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Length</span></span>, 0)       001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C44</span></span> 75 07 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jne</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a2Len_NonZero</span></span> ;   001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C46</span></span> 33<span class="hljs-selector-tag"><span class="hljs-selector-tag">D2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C48</span></span> 8955 <span class="hljs-selector-tag"><span class="hljs-selector-tag">EC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-14]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">var2</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> 0 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C4B</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">EB</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">short</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">part3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a2Len_NonZero</span></span>: 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C4D</span></span> 837<span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> 04 00 <span class="hljs-selector-tag"><span class="hljs-selector-tag">cmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[edx+4]</span></span>, 0 ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Compare</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">a2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Length</span></span>, 0)  ()     001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C51</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">F86</span></span> 98000000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">jbe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.JIT_RngChkFail</span></span> ;     001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C57</span></span> 8<span class="hljs-selector-tag"><span class="hljs-selector-tag">D52</span></span> 08 <span class="hljs-selector-tag"><span class="hljs-selector-tag">lea</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[edx+8]</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">a2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.BufferPointer</span></span> 001<span class="hljs-selector-tag"><span class="hljs-selector-tag">B0C5A</span></span> 8955 <span class="hljs-selector-tag"><span class="hljs-selector-tag">EC</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-14]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">var2</span></span> &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">--</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span></code> </pre><br></div></div><br><br>  The compiler did not present any surprises here, i.e.  compilation algorithm gives easily predictable results.  For example, variables initialized in the fixed clause are in any case placed on the stack. <br>  Initializing variables inside a fixed block: <br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">part3</span></span>: ; <span class="hljs-type"><span class="hljs-type">ECX</span></span> &lt;======= a1 ; <span class="hljs-type"><span class="hljs-type">EDX</span></span> &lt;======= a2.<span class="hljs-type"><span class="hljs-type">BufferPointer</span></span> ; var1 &lt;======= a1.<span class="hljs-type"><span class="hljs-type">BufferPointer</span></span> ; var2 &lt;======= a2.<span class="hljs-type"><span class="hljs-type">BufferPointer</span></span> <span class="hljs-number"><span class="hljs-number">001</span></span>B0C5D <span class="hljs-number"><span class="hljs-number">8</span></span>B45 <span class="hljs-type"><span class="hljs-type">F0</span></span> mov eax, [ebp<span class="hljs-number"><span class="hljs-number">-10</span></span>] ; eax &lt;-- var1 <span class="hljs-number"><span class="hljs-number">001</span></span>B0C60 <span class="hljs-number"><span class="hljs-number">8</span></span>BF0 mov esi, eax ; esi &lt;-- eax <span class="hljs-number"><span class="hljs-number">001</span></span>B0C62 <span class="hljs-number"><span class="hljs-number">8</span></span>B45 <span class="hljs-type"><span class="hljs-type">EC</span></span> mov eax, [ebp<span class="hljs-number"><span class="hljs-number">-14</span></span>] ; eax &lt;-- var2 <span class="hljs-number"><span class="hljs-number">001</span></span>B0C65 <span class="hljs-number"><span class="hljs-number">8</span></span>BF8 mov edi, eax ; edi &lt;-- eax <span class="hljs-number"><span class="hljs-number">001</span></span>B0C67 <span class="hljs-number"><span class="hljs-number">8</span></span>B41 <span class="hljs-number"><span class="hljs-number">04</span></span> mov eax, [ecx+<span class="hljs-number"><span class="hljs-number">4</span></span>] ; eax &lt;-- a1.<span class="hljs-type"><span class="hljs-type">Length</span></span> <span class="hljs-number"><span class="hljs-number">001</span></span>B0C6A <span class="hljs-number"><span class="hljs-number">8945</span></span> <span class="hljs-type"><span class="hljs-type">E8</span></span> mov [ebp<span class="hljs-number"><span class="hljs-number">-18</span></span>], eax ; var3 &lt;-- eax</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialization of variables inside the fixed block is curious because it well demonstrates the principle by which the JIT compiler generates code. </font><font style="vertical-align: inherit;">It is clearly seen here that instead of direct transfer of values ‚Äã‚Äãfrom stack variables to index registers, values ‚Äã‚Äãare first placed in a battery register. </font><font style="vertical-align: inherit;">Maybe this is some secret magical meaning, but it looks like (sending to eax) just as an extra action.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 byte loop</font></font></b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-number"><span class="hljs-number">001B</span></span>0C6D <span class="hljs-number"><span class="hljs-number">33</span></span>C9 xor ecx, ecx ;   &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0C6F <span class="hljs-number"><span class="hljs-number">8B</span></span>D8 mov ebx, eax ; ebx &lt;-- a1.Length <span class="hljs-number"><span class="hljs-number">001B</span></span>0C71 <span class="hljs-number"><span class="hljs-number">85</span></span>DB test ebx, ebx <span class="hljs-number"><span class="hljs-number">001B</span></span>0C73 <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> jns <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> ebx_greaterZero <span class="hljs-number"><span class="hljs-number">001B</span></span>0C75 <span class="hljs-number"><span class="hljs-number">83</span></span>C3 <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> ebx, <span class="hljs-number"><span class="hljs-number">7</span></span> ;  ,  <span class="hljs-number"><span class="hljs-number">7</span></span> ebx_greaterZero: <span class="hljs-number"><span class="hljs-number">001B</span></span>0C78 C1FB <span class="hljs-number"><span class="hljs-number">03</span></span> sar ebx, <span class="hljs-number"><span class="hljs-number">3</span></span> ; ebx &lt;-- a1.Length / <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0C7B <span class="hljs-number"><span class="hljs-number">85</span></span>DB test ebx, ebx <span class="hljs-number"><span class="hljs-number">001B</span></span>0C7D <span class="hljs-number"><span class="hljs-number">7</span></span>E <span class="hljs-number"><span class="hljs-number">1</span></span>D jle <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fourBytesComparing for8_body: <span class="hljs-number"><span class="hljs-number">001B</span></span>0C7F <span class="hljs-number"><span class="hljs-number">8B</span></span>06 mov eax, [esi] <span class="hljs-number"><span class="hljs-number">001B</span></span>0C81 <span class="hljs-number"><span class="hljs-number">8B</span></span>56 <span class="hljs-number"><span class="hljs-number">04</span></span> mov edx, [esi+<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-number"><span class="hljs-number">001B</span></span>0C84 <span class="hljs-number"><span class="hljs-number">3B</span></span>57 <span class="hljs-number"><span class="hljs-number">04</span></span> cmp edx, [edi+<span class="hljs-number"><span class="hljs-number">4</span></span>] <span class="hljs-number"><span class="hljs-number">001B</span></span>0C87 <span class="hljs-number"><span class="hljs-number">75</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> jne <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> setResult_jumpReturn <span class="hljs-number"><span class="hljs-number">001B</span></span>0C89 <span class="hljs-number"><span class="hljs-number">3B</span></span>07 cmp eax, [edi] <span class="hljs-number"><span class="hljs-number">001B</span></span>0C8B <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> je <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> for8_increment setResult_jumpReturn: <span class="hljs-number"><span class="hljs-number">001B</span></span>0C8D <span class="hljs-number"><span class="hljs-number">33</span></span>C0 xor eax, eax ; result &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0C8F EB <span class="hljs-number"><span class="hljs-number">56</span></span> jmp <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> return2 ; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> for8_increment: <span class="hljs-number"><span class="hljs-number">001B</span></span>0C91 <span class="hljs-number"><span class="hljs-number">41</span></span> inc ecx <span class="hljs-number"><span class="hljs-number">001B</span></span>0C92 <span class="hljs-number"><span class="hljs-number">83</span></span>C6 <span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> esi, <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0C95 <span class="hljs-number"><span class="hljs-number">83</span></span>C7 <span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edi, <span class="hljs-number"><span class="hljs-number">8</span></span> for8_expression: <span class="hljs-number"><span class="hljs-number">001B</span></span>0C98 <span class="hljs-number"><span class="hljs-number">3B</span></span>D9 cmp ebx, ecx <span class="hljs-number"><span class="hljs-number">001B</span></span>0C9A ^ <span class="hljs-number"><span class="hljs-number">7F</span></span> E3 jg <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> for8_body</code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The loop structure is rather trivial, for example, the loop counter is traditionally located in ecx, the limit value of the counter is located in ebx, which is also traditional. What is remarkable here is that the first check of the condition of the loop is located immediately after the initialization and looks different from the main condition of the loop. It is also obvious that miracles do not happen, and the REX prefix is ‚Äã‚Äãnot available either in Protected Mode or Compatible Mode, i.e. Comparison of QWORD blocks is impossible, therefore blocks of DWORD size are compared. However, it is clear from the code that, before performing comparisons, the corresponding parts of the first array are loaded into the eax and edx registers, i.e. The JIT compiler attempted to produce machine code as closely as possible with the source code.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is striking is that the compiler here did not use the CMPSD string instruction, namely, its ‚Äúshort‚Äù form, which compares DWORD blocks placed at the addresses esi and edi, setting the corresponding flags. In this case, the size of the machine code would be several times smaller: the mov command here is 2 and 3 bytes in size, the cmp command is 2 and 3 bytes, and the size of each CMPSD command (in short form) would be only 1 byte, i.e. . for two teams only 2 bytes. This suggests that the JIT compiler does not want to optimize the code. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the listed listings it is obvious that a couple of commands, the first of which is transfer to eax, is a pattern that the compiler follows strictly. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An attempt to compare blocks with the size of DWORD, is performed, if such a volume remains:</font></font><br><pre> <code class="hljs cs">fourBytesComparing: <span class="hljs-number"><span class="hljs-number">001B</span></span>0C9C F745 E8 <span class="hljs-number"><span class="hljs-number">0400000</span></span> test dword ptr [ebp<span class="hljs-number"><span class="hljs-number">-18</span></span>], <span class="hljs-number"><span class="hljs-number">00000004</span></span> ; ZF &lt;-- (var3 &amp; <span class="hljs-number"><span class="hljs-number">4</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0CA3 <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> je <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> length_lowerThenFour <span class="hljs-number"><span class="hljs-number">001B</span></span>0CA5 <span class="hljs-number"><span class="hljs-number">8B</span></span>06 mov eax, [esi] <span class="hljs-number"><span class="hljs-number">001B</span></span>0CA7 <span class="hljs-number"><span class="hljs-number">3B</span></span>07 cmp eax, [edi] <span class="hljs-number"><span class="hljs-number">001B</span></span>0CA9 <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> je <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> dwords_equals ;   ,     <span class="hljs-number"><span class="hljs-number">001B</span></span>0CAB <span class="hljs-number"><span class="hljs-number">33</span></span>C0 xor eax, eax <span class="hljs-number"><span class="hljs-number">001B</span></span>0CAD EB <span class="hljs-number"><span class="hljs-number">38</span></span> jmp <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> return2 dwords_equals: <span class="hljs-number"><span class="hljs-number">001B</span></span>0CAF <span class="hljs-number"><span class="hljs-number">83</span></span>C6 <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> esi, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0CB2 <span class="hljs-number"><span class="hljs-number">83</span></span>C7 <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edi, <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An attempt to compare blocks the size of WORD, is performed, if such a volume remains: </font></font><br><pre> <code class="hljs objectivec">length_lowerThenFour: <span class="hljs-number"><span class="hljs-number">001</span></span>B0CB5 F745 E8 <span class="hljs-number"><span class="hljs-number">0200000</span></span> test dword ptr [ebp<span class="hljs-number"><span class="hljs-number">-18</span></span>], <span class="hljs-number"><span class="hljs-number">00000002</span></span> ; ZF &lt;-- (var3 &amp; <span class="hljs-number"><span class="hljs-number">2</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">001</span></span>B0CBC <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> je <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> length_lowerThenTwo <span class="hljs-number"><span class="hljs-number">001</span></span>B0CBE <span class="hljs-number"><span class="hljs-number">0</span></span>FBF06 movsx eax, word ptr [esi] <span class="hljs-number"><span class="hljs-number">001</span></span>B0CC1 <span class="hljs-number"><span class="hljs-number">66</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>B07 cmp ax, [edi] <span class="hljs-number"><span class="hljs-number">001</span></span>B0CC4 <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> je <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> words_equals ;   ,     <span class="hljs-number"><span class="hljs-number">001</span></span>B0CC6 <span class="hljs-number"><span class="hljs-number">33</span></span>C0 xor eax, eax <span class="hljs-number"><span class="hljs-number">001</span></span>B0CC8 EB <span class="hljs-number"><span class="hljs-number">1</span></span>D jmp <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> return2 words_equals: <span class="hljs-number"><span class="hljs-number">001</span></span>B0CCA <span class="hljs-number"><span class="hljs-number">46</span></span> inc esi <span class="hljs-number"><span class="hljs-number">001</span></span>B0CCB <span class="hljs-number"><span class="hljs-number">46</span></span> inc esi <span class="hljs-number"><span class="hljs-number">001</span></span>B0CCC <span class="hljs-number"><span class="hljs-number">47</span></span> inc edi <span class="hljs-number"><span class="hljs-number">001</span></span>B0CCD <span class="hljs-number"><span class="hljs-number">47</span></span> inc edi</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An attempt to compare blocks of size BYTE, is performed if such a volume remains: </font></font><br><pre> <code class="hljs cs">length_lowerThenTwo: <span class="hljs-number"><span class="hljs-number">001B</span></span>0CCE F745 E8 <span class="hljs-number"><span class="hljs-number">0100000</span></span> test dword ptr [ebp<span class="hljs-number"><span class="hljs-number">-18</span></span>], <span class="hljs-number"><span class="hljs-number">00000001</span></span> ; ZF &lt;-- (var3 &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0CD5 <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">0B</span></span> je <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0CE2 <span class="hljs-number"><span class="hljs-number">001B</span></span>0CD7 <span class="hljs-number"><span class="hljs-number">0F</span></span>B606 movzx eax, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [esi] <span class="hljs-number"><span class="hljs-number">001B</span></span>0CDA <span class="hljs-number"><span class="hljs-number">3</span></span>A07 cmp al, [edi] <span class="hljs-number"><span class="hljs-number">001B</span></span>0CDC <span class="hljs-number"><span class="hljs-number">74</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> je <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> <span class="hljs-number"><span class="hljs-number">001B</span></span>0CE2 ;   ,     <span class="hljs-number"><span class="hljs-number">001B</span></span>0CDE <span class="hljs-number"><span class="hljs-number">33</span></span>C0 xor eax, eax <span class="hljs-number"><span class="hljs-number">001B</span></span>0CE0 EB <span class="hljs-number"><span class="hljs-number">05</span></span> jmp <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> return2 <span class="hljs-number"><span class="hljs-number">001B</span></span>0CE2 B8 <span class="hljs-number"><span class="hljs-number">01000000</span></span> mov eax, <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Return result and throw exception: </font></font><br><pre> <code class="hljs perl">return2: <span class="hljs-number"><span class="hljs-number">001</span></span>B0CE7 <span class="hljs-number"><span class="hljs-number">8</span></span>D65 F4 lea esp, [ebp-0C] <span class="hljs-number"><span class="hljs-number">001</span></span>B0CEA <span class="hljs-number"><span class="hljs-number">5</span></span>B <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebx <span class="hljs-number"><span class="hljs-number">001</span></span>B0CEB <span class="hljs-number"><span class="hljs-number">5</span></span>E <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> esi <span class="hljs-number"><span class="hljs-number">001</span></span>B0CEC <span class="hljs-number"><span class="hljs-number">5</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> edi <span class="hljs-number"><span class="hljs-number">001</span></span>B0CED <span class="hljs-number"><span class="hljs-number">5</span></span>D <span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> ebp <span class="hljs-number"><span class="hljs-number">001</span></span>B0CEE C3 ret JIT_RngChkFail: <span class="hljs-number"><span class="hljs-number">001</span></span>B0CEF E8 C4B1DB61 call clr.JIT_RngChkFail <span class="hljs-number"><span class="hljs-number">001</span></span>B0CF4 CC int3</code> </pre><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CRT analysis of memcmp () function </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This function is also of interest because it does not simply compare two buffers, but clarifies the relationship between them, which means that it is more complicated than those previously considered. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After hooking up the debager, I found out that C: \ Windows \ SysWOW64 \ msvcrt.dll version 7.0.7601.17744 was loaded into the memory of the process at the base address 0x76C20000. </font></font><br><br><img src="http://files.rsdn.ru/67254/msvcrt_module.png" alt="  "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is an important clarification, since the code of different versions of libraries can be very different, since </font><font style="vertical-align: inherit;">they can be compiled with different compiler options, and even more so, different compilers.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first glance at the dissected function confused me a little: firstly, before the standard prologue, at the very beginning of the function, there was a strange instruction, and secondly, the size of this function is amazing. </font><font style="vertical-align: inherit;">The presence of ‚Äúlong‚Äù jumps was striking, besides, the switch with 32 cases is frightening. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strange instruction:</font></font><br><pre> <code class="hljs swift">76C37975 . 8BFF mov edi, edi ; &lt;--(!)    <span class="hljs-type"><span class="hljs-type">INT</span></span> msvcrt.memcmp(buf1,buf2,<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>) 76C37977 . <span class="hljs-number"><span class="hljs-number">55</span></span> push ebp 76C37978 . 8BEC mov ebp, esp</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It copies the register to itself without updating any flags, i.e. </font><font style="vertical-align: inherit;">the result of its execution is zero, just like nop, but 2 bytes in size. </font><font style="vertical-align: inherit;">Having run through the code in the debugger window, I found that many other functions started in the same way. </font><font style="vertical-align: inherit;">Thanks to Raymond Chen's blog, an explanation was found quickly. </font><font style="vertical-align: inherit;">This is really an analogue of nop.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's a hot-patch point. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The MOV EDI, EDI instruction is a NOP, it can be updated on the fly. </font><font style="vertical-align: inherit;">It will be replaced by the JMP $ -5 instruction. </font><font style="vertical-align: inherit;">If you want to go through the address space. </font></font><br> <a href="http://blogs.msdn.com/b/oldnewthing/archive/2011/09/21/10214405.aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">blogs.msdn.com/b/oldnewthing/archive/2011/09/21/10214405.aspx</font></font></a> <br></blockquote><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Long jumps and a very large switch</font></font></b> <div class="spoiler_text"><pre> <code class="hljs perl">Address Hex <span class="hljs-keyword"><span class="hljs-keyword">dump</span></span> Command Comments <span class="hljs-number"><span class="hljs-number">75</span></span>A9797C . <span class="hljs-number"><span class="hljs-number">8</span></span>B7D <span class="hljs-number"><span class="hljs-number">10</span></span> mov edi, [ebp+<span class="hljs-number"><span class="hljs-number">10</span></span>] ; edi &lt;-- <span class="hljs-keyword"><span class="hljs-keyword">length</span></span> <span class="hljs-number"><span class="hljs-number">75</span></span>A9797F . <span class="hljs-number"><span class="hljs-number">8</span></span>BC7 mov eax, edi <span class="hljs-number"><span class="hljs-number">75</span></span>A97981 . <span class="hljs-number"><span class="hljs-number">83</span></span>E8 <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function">, 0 </span></span>; <span class="hljs-number"><span class="hljs-number">75</span></span>A97984 . 0F84 E707010<span class="hljs-number"><span class="hljs-number">0</span></span> je msvcrt.zeroResult_GoReturn ; (<span class="hljs-keyword"><span class="hljs-keyword">length</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>)=&gt; {result &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;} (!)      ;    ;    <span class="hljs-number"><span class="hljs-number">75</span></span>A979BC . <span class="hljs-number"><span class="hljs-number">83</span></span>FF <span class="hljs-number"><span class="hljs-number">1</span></span>F cmp edi, <span class="hljs-number"><span class="hljs-number">1</span></span>F ; Switch (cases <span class="hljs-number"><span class="hljs-number">1</span></span>..<span class="hljs-number"><span class="hljs-number">1</span></span>F, <span class="hljs-number"><span class="hljs-number">32</span></span>. exits) <span class="hljs-number"><span class="hljs-number">75</span></span>A979BF . <span class="hljs-number"><span class="hljs-number">77</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>B ja short msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97A1C <span class="hljs-number"><span class="hljs-number">75</span></span>A979C1 . FF24BD <span class="hljs-number"><span class="hljs-number">1</span></span>F8AA975 jmp near [edi*<span class="hljs-number"><span class="hljs-number">4</span></span>+msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98A1F] ; (!)       (!)      ;    ;    <span class="hljs-number"><span class="hljs-number">75</span></span>A98A1F . <span class="hljs-number"><span class="hljs-number">1</span></span>C7AA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97A1C ; (<span class="hljs-number"><span class="hljs-number">00</span></span>)   ,  jump     <span class="hljs-number"><span class="hljs-number">75</span></span>A98A23 . E88AA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AE8 ; (<span class="hljs-number"><span class="hljs-number">01</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A27 . CA8AA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98ACA ; (<span class="hljs-number"><span class="hljs-number">02</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A2B . <span class="hljs-number"><span class="hljs-number">8</span></span>C8BA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98B8C ; (<span class="hljs-number"><span class="hljs-number">03</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A2F . 0A7AA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97A0A ; (<span class="hljs-number"><span class="hljs-number">04</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A33 . 088FA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98F08 ; (<span class="hljs-number"><span class="hljs-number">05</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A37 . B88AA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB8 ; (<span class="hljs-number"><span class="hljs-number">06</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A3B . <span class="hljs-number"><span class="hljs-number">758</span></span>BA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98B75 ; (<span class="hljs-number"><span class="hljs-number">07</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A3F . F479A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A979F4 ; (08) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A43 . <span class="hljs-number"><span class="hljs-number">238</span></span>FA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98F23 ; (09) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A47 . <span class="hljs-number"><span class="hljs-number">9</span></span>F8AA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98A9F ; (0A) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A4B . A18BA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98BA1 ; (0B) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A4F . DE79A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A979DE ; (0C) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A53 . <span class="hljs-number"><span class="hljs-number">3</span></span>A8FA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98F3A ; (0D) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A57 . FD8AA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AFD ; (0E) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A5B . ED8EA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98EED ; (0F) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A5F . C879A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A979C8 ; (<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A63 . <span class="hljs-number"><span class="hljs-number">518</span></span>FA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98F51 ; (<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A67 . BA8EA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98EBA ; (<span class="hljs-number"><span class="hljs-number">12</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A6B . <span class="hljs-number"><span class="hljs-number">6</span></span>A98A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9986A ; (<span class="hljs-number"><span class="hljs-number">13</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A6F . <span class="hljs-number"><span class="hljs-number">8990</span></span>A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99089 ; (<span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A73 . CD98A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A998CD ; (<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A77 . D58EA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98ED5 ; (<span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A7B . <span class="hljs-number"><span class="hljs-number">8598</span></span>A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99885 ; (<span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A7F . <span class="hljs-number"><span class="hljs-number">1899</span></span>A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99918 ; (<span class="hljs-number"><span class="hljs-number">18</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A83 . E898A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A998E8 ; (<span class="hljs-number"><span class="hljs-number">19</span></span>) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A87 . <span class="hljs-number"><span class="hljs-number">698</span></span>FA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98F69 ; (<span class="hljs-number"><span class="hljs-number">1</span></span>A) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A8B . <span class="hljs-number"><span class="hljs-number">9</span></span>D98A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9989D ; (<span class="hljs-number"><span class="hljs-number">1</span></span>B) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A8F . <span class="hljs-number"><span class="hljs-number">3399</span></span>A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99933 ; (<span class="hljs-number"><span class="hljs-number">1</span></span>C) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A93 . <span class="hljs-number"><span class="hljs-number">00</span></span>99A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9990<span class="hljs-number"><span class="hljs-number">0</span></span> ; (<span class="hljs-number"><span class="hljs-number">1</span></span>D) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A97 . <span class="hljs-number"><span class="hljs-number">848</span></span>FA975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98F84 ; (<span class="hljs-number"><span class="hljs-number">1</span></span>E) <span class="hljs-number"><span class="hljs-number">75</span></span>A98A9B . B598A975 dd msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A998B5 ; (<span class="hljs-number"><span class="hljs-number">1</span></span>F)   </code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Due to the large laboriousness of analyzing the entire function, it was decided not to disassemble it completely, besides, two things were of interest: </font></font><br><br><ul><li>    (overhead)  ¬´¬ª  (PInvoke) </li><li>     . </li></ul><br><br><h5>        </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To estimate the overhead of a function call, it was decided to trace the code from the managed code to the beginning of the function itself. To do this, a breakpoint was set at the beginning of the function, and after returning from Thread.Sleep () a trace was started. However, the result of the first tracing attempt was unsuccessful: the trace log was too large (about 100 thousand lines), which probably indicated that DllMain () was executed, there was also a possibility that some CLR code was captured, JIT compiler code. What exactly was performed there, I did not clarify: it was not of interest, because Such a start code is executed only once and almost does not affect the overall picture. To exclude this code, I inserted another memcmp () call before calling Thread.Sleep () and re-traced it.As a result, he received a little more than a hundred lines.</font></font><br><br><img src="http://files.rsdn.ru/67254/tracing_to_msvcrt.png" alt="  "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Part of the trace log: </font></font><br><pre> <code class="hljs sql">main 00480AEA <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-number"><span class="hljs-number">0031</span></span>C19C ESP=<span class="hljs-number"><span class="hljs-number">0016</span></span>F368 ;    main clr.628C3B5F <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> near [eax+<span class="hljs-number"><span class="hljs-number">14</span></span>] ESP=<span class="hljs-number"><span class="hljs-number">0016</span></span>F248 ; (1) ;    main 00480B87 mov eax, [ebp-1C] EAX=00313880 main 00480B8A mov eax, [eax+14] EAX=0031391C main 00480B8D mov ecx, [eax] ECX=75A97975 ; (2) main 00480B8F push dword ptr [ebp+0C] ESP=0016F328 main 00480B92 push dword ptr [ebp+8] ESP=0016F324 main 00480B95 push edi ESP=0016F320 main 00480B96 push dword ptr [ebp-10] ESP=0016F31C main 00480B99 mov dword ptr [ebp-2C], 0 main 00480BA0 mov [ebp-28], esp main 00480BA3 mov dword ptr [ebp-24], 480BB0 main 00480BAA mov byte ptr [ebx+8], 0 main 00480BAE <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ecx ESP=<span class="hljs-number"><span class="hljs-number">0016</span></span>F318 ; (3) main msvcrt.memcmp mov edi, edi <span class="hljs-comment"><span class="hljs-comment">-------- Logging stopped</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From the above log, it is clear that, firstly, at least one indirect call occurs on the way to the function, and secondly, the CLR retrieves the address of the final function from some data structure, i.e. </font><font style="vertical-align: inherit;">the challenge has considerable indirectness and leaves the transition prediction block no hope of fulfilling its mission. </font><font style="vertical-align: inherit;">This makes senseless the removal of such functions beyond the limits of the managed code in the event that they do not process large portions of data at a time and do not require a large computation time.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Evaluation of the main function code </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the best, least resource-intensive case, the function will detect the difference in the first byte and return the result. In this case, the function will spend the least time. In the worst case, the function compares the whole arrays and does not detect differences. Obviously, in the second case, the data will be compared by blocks in a loop. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since disassembling and analyzing the function as a whole in a reasonable time is not possible, to evaluate the executed code, it was decided to make two traces, and to evaluate both these cases using the trace log. To analyze the best case, first, the test data generation function was modified so that all arrays differed from the first byte, and second, the function that compared all arrays was modified, so that in the first iteration of the loop different arrays were compared .</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modified array comparison function</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompareArraysWithPInvokeMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = CountArrays - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) <span class="hljs-comment"><span class="hljs-comment">//    for (int j = 0; j &lt; CountArrays; j++) { var tmp = ByteArrayCompareWithPInvoke(s_arrays[i], s_arrays[j]); result = result &amp;&amp; tmp; } return result; }</span></span></code> </pre><br></div></div><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First tracing (best case)</font></font></b> <div class="spoiler_text"><pre> <code class="hljs django"><span class="xml"><span class="xml">main msvcrt.memcmp mov edi, edi main msvcrt.75A97977 push ebp ESP=0041EC74 main msvcrt.75A97978 mov ebp, esp EBP=0041EC74 main msvcrt.75A9797A push esi ESP=0041EC70 main msvcrt.75A9797B push edi ESP=0041EC6C main msvcrt.75A9797C mov edi, [ebp+10] EDI=00080000 ; edi </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">--</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">count</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A9797F</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edi</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EAX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00080000</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edi</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97981</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sub</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> == </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0)</span></span></span></span><span class="xml"><span class="hljs-tag"> {</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">result</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag">;} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97984</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">je</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.zeroResult_GoReturn</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A9798A</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dec</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EAX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0007FFFF</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A9798B</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">je</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A98C10</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97991</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dec</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EAX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0007FFFE</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97992</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">je</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A9E610</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97998</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dec</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EAX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0007FFFD</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97999</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">je</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A9E5DF</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A9799F</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dec</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EAX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0007FFFC</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979A0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">je</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A98BD2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979A6</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ecx</span></span></span></span><span class="xml"><span class="hljs-tag">, [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebp</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0C</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ECX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">034C53B8</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ecx</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buf1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979A9</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">, [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebp</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">8</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EAX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">05C41038</span></span></span></span><span class="xml"><span class="hljs-tag"> ; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buf2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979AC</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">push</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC68</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979AD</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">push</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">20</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC64</span></span></span></span><span class="xml"><span class="hljs-tag"> ;        </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979AF</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pop</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EDX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00000020,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC68</span></span></span></span><span class="xml"><span class="hljs-tag"> ;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">--------------------------------</span></span></span></span><span class="xml"><span class="hljs-tag">   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979B0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cmp</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edi</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A979B2</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">jae</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A993A7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A993A7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag">, [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">4241403F</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A993A9</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cmp</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag">, [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ecx</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A993AB</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">jne</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA80E7</span></span></span></span><span class="xml"><span class="hljs-tag"> ;   </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA80E7</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">movzx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">byte</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ptr</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0000003F</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA80EA</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">movzx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">byte</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ptr</span></span></span></span><span class="xml"><span class="hljs-tag"> [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ecx</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EBX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00000001</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA80ED</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sub</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0000003E</span></span></span></span><span class="xml"><span class="hljs-tag"> ;      </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">DWORD</span></span></span></span><span class="xml"><span class="hljs-tag">' </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA80EF</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">jne</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA8178</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA8178</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">xor</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EBX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00000000</span></span></span></span><span class="xml"><span class="hljs-tag"> ;     </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA817A</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">test</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA817C</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setg</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bl</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EBX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00000001</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA817F</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">lea</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag">, [</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag">+</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx-1</span></span></span></span><span class="xml"><span class="hljs-tag">] </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA8183</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00000001</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA8185</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">test</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75AA8187</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">jne</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A98AB1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A98AB1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mov</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">eax</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EAX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00000001</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A98AB3</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">jmp</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97A1E</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97A1E</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pop</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebx</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EBX</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">00852AE0,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC6C</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.return1</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pop</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">edi</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC70,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EDI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">034C53B8</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97A20</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pop</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">esi</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC74,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">034C53B0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97A21</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pop</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ebp</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC78,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">EBP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041ECC4</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">main</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">msvcrt.75A97A22</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ret</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ESP</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0041EC7C</span></span></span></span></span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first thing that catches your eye here is that the handling of special cases, i.e. </font><font style="vertical-align: inherit;">cases when the count parameter is within [0..4], made quite unusual. </font><font style="vertical-align: inherit;">It remains to be seen whether this is the result of the compilation of the switch clause or whether a local variable was actually created there, which was decremented at each step of the check. </font><font style="vertical-align: inherit;">However, the debug information asserts that it was a switch after all. </font><font style="vertical-align: inherit;">From the point of view of optimization, this is quite a reasonable action, since </font><font style="vertical-align: inherit;">The loop does not initialize.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second thing that immediately caught my eye was a very unusual way of putting the number 0x20 in the edx register (via the stack). This is very similar to a compilation artifact, and clearly indicates that the function was not written in assembler. A man would not have written this, because this makes no sense: the stack is in memory, and calls to it are always slower than to registers. I would venture to suggest that this is an inline artifact.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After detecting the difference of double words in the buffers, a transition is made to the address 0x75AA8178, where the first bytes from the source buffers are loaded into the esi and ebx registers at the addresses where the difference was detected. </font><font style="vertical-align: inherit;">This is followed by the calculation of the difference between these bytes, and, if no differences are found, the next bytes are loaded, and so on for the whole double word. </font><font style="vertical-align: inherit;">It is noteworthy that the result does not depend on the number of the byte in which the difference is found. </font><font style="vertical-align: inherit;">This is evident from the fact that the code for generating the result for the last byte in the DWORD is completely identical to the code for a similar purpose for the first byte given above in the first trace trace.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential comparison of double word bytes</font></font></b> <div class="spoiler_text"><pre> <code class="hljs perl">;Address Hex <span class="hljs-keyword"><span class="hljs-keyword">dump</span></span> Command Comments <span class="hljs-number"><span class="hljs-number">75</span></span>AA80E7 &gt; 0FB63<span class="hljs-number"><span class="hljs-number">0</span></span> movzx esi, byte ptr [eax] <span class="hljs-number"><span class="hljs-number">75</span></span>AA80EA . 0FB619 movzx ebx, byte ptr [ecx] <span class="hljs-number"><span class="hljs-number">75</span></span>AA80ED . <span class="hljs-number"><span class="hljs-number">2</span></span>BF3 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ebx</span></span></span><span class="hljs-function"> </span></span>;      DWORD<span class="hljs-string"><span class="hljs-string">' 75AA80EF .- 0F85 83000000 jne msvcrt.75AA8178 ;       ebx 75AA80F5 &gt; 0FB670 01 movzx esi, byte ptr [eax+1] 75AA80F9 . 0FB659 01 movzx ebx, byte ptr [ecx+1] 75AA80FD . 2BF3 sub esi, ebx 75AA80FF .- 0F84 1EF9FEFF je msvcrt.75A97A23 ;    75A97A23 &gt; 0FB670 02 movzx esi, byte ptr [eax+2] 75A97A27 . 0FB659 02 movzx ebx, byte ptr [ecx+2] 75A97A2B . 2BF3 sub esi, ebx 75A97A2D .- 74 15 je short msvcrt.75A97A44 ;    75A97A44 &gt; 0FB670 03 movzx esi, byte ptr [eax+3] 75A97A48 . 0FB659 03 movzx ebx, byte ptr [ecx+3] 75A97A4C . 2BF3 sub esi, ebx 75A97A4E .- 0F84 5F190000 je msvcrt.75A993B3 ;  -   75A97A54 . 33DB xor ebx, ebx ;     ebx 75A97A56 . 85F6 test esi, esi 75A97A58 . 0F9FC3 setg bl 75A97A5B . 8D5C1B FF lea ebx, [ebx+ebx-1] 75A97A5F . 8BF3 mov esi, ebx 75A97A61 .- E9 4D190000 jmp msvcrt.75A993B3 ;    75A993B1 . |33F6 xor esi, esi 75A993B3 &gt; |85F6 test esi, esi 75A993B5 .-|0F85 F6F6FFFF jne msvcrt.75A98AB1</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Duplication of the code is not good, but not terrible, but a consistent comparison of bytes is not the best way to compare double words, especially since the byte number does not affect the result. Thus, it is already clear that this code is somewhat strange, perhaps because the source code is even more strange.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First look at the second trace log: 8 double words are compared in one iteration of the cycle, and this is good: it is clear that the cycle has been expanded, and on the other hand, after each comparison, absolutely identical useless code goes: register esi is entered 0 and the contents of register esi are analyzed . </font><font style="vertical-align: inherit;">I have no assumptions about why this was done, however, there is an assumption about how this could happen: firstly, it is very similar to the result of the work of some macro that formed the assembler code, and secondly, it seems that the Microsoft C compiler is not as good as I thought about it before.</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Second trace (loop only)</font></font></b> <div class="spoiler_text"><pre> <code class="hljs perl">;--------------------------------   main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A979B<span class="hljs-number"><span class="hljs-number">0</span></span> cmp edi, edx main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A979B2 jae msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993A7 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993A7 mov esi, [eax] ESI=<span class="hljs-number"><span class="hljs-number">00000000</span></span> main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993A9 cmp esi, [ecx] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993AB jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>AA80E7 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993B1 <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993B3 test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993B5 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993BB mov esi, [eax+<span class="hljs-number"><span class="hljs-number">4</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993BE cmp esi, [ecx+<span class="hljs-number"><span class="hljs-number">4</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993C1 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>AA811F main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993C7 <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993C9 test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A?<span class="hljs-number"><span class="hljs-number">993</span></span>CB jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993D1 mov esi, [eax+<span class="hljs-number"><span class="hljs-number">8</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993D4 cmp esi, [ecx+<span class="hljs-number"><span class="hljs-number">8</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993D7 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97A9A main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993DD <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993DF test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993E1 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993E7 mov esi, [eax+0C] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993EA cmp esi, [ecx+0C] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993ED jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97B1F main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993F3 <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993F5 test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993F7 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A993FD mov esi, [eax+<span class="hljs-number"><span class="hljs-number">10</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9940<span class="hljs-number"><span class="hljs-number">0</span></span> cmp esi, [ecx+<span class="hljs-number"><span class="hljs-number">10</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99403 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97BA4 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99409 <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9940B test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9940D jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99413 mov esi, [eax+<span class="hljs-number"><span class="hljs-number">14</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99416 cmp esi, [ecx+<span class="hljs-number"><span class="hljs-number">14</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99419 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97C29 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9941F <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99421 test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99423 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99429 mov esi, [eax+<span class="hljs-number"><span class="hljs-number">18</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9942C cmp esi, [ecx+<span class="hljs-number"><span class="hljs-number">18</span></span>] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9942F jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>AA1172 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99435 <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99437 test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99439 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9943F mov esi, [eax+<span class="hljs-number"><span class="hljs-number">1</span></span>C] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99442 cmp esi, [ecx+<span class="hljs-number"><span class="hljs-number">1</span></span>C] main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99445 jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A97CFC main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9944B <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9944D test esi, esi main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A9944F jne msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A98AB1 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99455 add eax, edx EAX=<span class="hljs-number"><span class="hljs-number">031353</span></span>B8 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99457 add ecx, edx ECX=<span class="hljs-number"><span class="hljs-number">031353</span></span>B8 main msvcrt.<span class="hljs-number"><span class="hljs-number">75</span></span>A99459 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edi</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EDI</span></span></span><span class="hljs-function">=0007</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FFE0</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msvcrt</span></span></span><span class="hljs-function">.75</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">A9945B</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jmp</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">msvcrt</span></span></span><span class="hljs-function">.75</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">A979B0</span></span></span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is noteworthy that on large volumes of test data, this code showed a result ~ 10% worse than the code using unsafe. </font><font style="vertical-align: inherit;">It is clear that most of the time when comparing data arrays is spent on reading operations from memory, which is much slower than the processor cache and, especially, the registers. </font><font style="vertical-align: inherit;">But such a serious difference, which was given only by operations with the registers of the processor, says that compiler optimizations are extremely important. </font><font style="vertical-align: inherit;">I would venture to suggest that testing on a weaker processor, for example, on a processor with a lower clock frequency, would make a much more significant difference.</font></font><br><br><h3>  findings </h3><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If you need to quickly compare small (7 bytes or less) arrays, we take the most obvious way (byte-by-byte comparison in the loop), the large ones are unsafe, and everything else is from the evil one. </font></font></li><li>  .Net  CLR   .    ,  JIT-  ,  ,  CLR ¬´¬ª     .  It is not true.   JIT-    ,      .    ‚Äî  C++-  Intel,        ,         (AMD  Intel)    . </li><li>  C-RunTime  ,     ,       C- ‚Äì MS VC.    ¬´     ¬ª (http://rsdn.ru/article/optimization/optimization.xml): ¬´     ,   ,          ¬ª. </li></ol><br><br><h3>  Bibliography </h3><br><ol><li> <a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">Intel¬Æ 64 and IA-32 Architectures Software Developer Manuals</a> .CHAPTER 2. Intel ¬Æ 64 Architecture </li><li> <a href="http://amd-dev.wpengine.netdna-cdn.com/wordpress/media/2012/10/24592_APM_v11.pdf">AMD64 Architecture Programmer's Manual Volume 1</a> : Application Programming CHAPTER 1 Long Mode </li><li> <a href="http://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-optimization-manual.html">Intel¬Æ 64 and IA-32 Architectures Optimization Reference Manual</a> . CHAPTER 3. Alignment <br></li><li> Windows Internals, Sixth Edition, Part 1, CHAPTER 5 Processes, Threads, and Jobs </li><li> Windows Internals, Sixth Edition, Part 2, CHAPTER 10. Memory Management </li><li> Intel¬Æ 64 and IA-32 Architectures Software Developer Manuals. CHAPTER 17. TIME-STAMP COUNTER </li><li> <a href="http://msdn.microsoft.com/en-us/magazine/cc163791.aspx">MSDN Magazine 2005, May: Drill Into .NET Framework Internals to See How the CLR Creates Runtime Objects</a> </li><li> Joe Duffy, Professional .NET Framework 2.0 (Programmer to Programmer). Chapter 3: Inside the CLR, Just-In-Time (JIT) Compilation </li></ol><br><hr><br><br><h3>   21.03.2014 4:37 </h3><br><ul><li>   ,  ¬´CRL¬ª. </li><li>       (  ),           MSDN. </li><li>   . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Last time I posted incorrect source codes in the comments. </font><font style="vertical-align: inherit;">The fact is that in the process of experiments, about which I did not write, or wrote partially, the sources were not suitable for obtaining the results from the article.</font></font> For example: <br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Some calls in the method were commented out </font></font><code>DoMeasurements()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><code>      result.SequenceEqualTime = result.IStructuralEquatableTime = result.PInvokeTime;</code> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method </font></font><code>PrepareTestData(int p_ArraySize)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generated arrays that differ from the first byte.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Constants were set so that the starting array size was 512 * 1024, and the array was only 64. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method was </font></font><code>CompareArraysWithPInvokeMethod()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">also modified so that the different arrays are compared first. </font><font style="vertical-align: inherit;">Although this, in theory, should not have a strong impact on the final data.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, this led to the fact that those who downloaded and launched them could not repeat the results from the article. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I put the corrected sorts </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here.</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> While I was working on correcting typos and errors, </font></font><a href="https://habrahabr.ru/users/saladin/" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saladin</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> corrected and put the sorts on </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , so you can not download, but just watch.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Updated on 3/25/2014 6:37 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By popular demand, I researched </font></font><code>RtlCompareMemory()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before studying the function code, I tested it by first setting the </font></font><a href="http://msdn.microsoft.com/en-us/library/system.security.suppressunmanagedcodesecurityattribute(v%3Dvs.110).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SuppressUnmanagedCodeSecurity</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> attribute </font><font style="vertical-align: inherit;">for the function </font></font><code>memcmp()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and it is </font></font><code>RtlCompareMemory()</code> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">curious that the system function that </font></font><a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff561778(v%3Dvs.85).aspx"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">can be called</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from both user-mode and kernel-mode turned out to be slower than the function from the CRT set.</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If both blocks of memory are resident. Callers of RtlCompareMemory can be running at any IRQL </font></font></blockquote><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Results under the cut</font></font></b> <div class="spoiler_text"><pre> <code class="dos hljs">    Unsafe MemCMP RtlCompareMemory   <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">279</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">003</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">008</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">278</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">003</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">008</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">325</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">006</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">374</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">009</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">422</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">007</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">426</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">006</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">490</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">006</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">560</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">54</span></span> <span class="hljs-number"><span class="hljs-number">622</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">003</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">802</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">147</span></span> <span class="hljs-number"><span class="hljs-number">1092</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">003</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">242</span></span> <span class="hljs-number"><span class="hljs-number">1571</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">003</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">398</span></span> <span class="hljs-number"><span class="hljs-number">2328</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">657</span></span> <span class="hljs-number"><span class="hljs-number">3664</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1082</span></span> <span class="hljs-number"><span class="hljs-number">5519</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1782</span></span> <span class="hljs-number"><span class="hljs-number">8554</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">2936</span></span> <span class="hljs-number"><span class="hljs-number">13520</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">4837</span></span> <span class="hljs-number"><span class="hljs-number">21771</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">002</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7967</span></span> <span class="hljs-number"><span class="hljs-number">35464</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">13124</span></span> <span class="hljs-number"><span class="hljs-number">58073</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">21618</span></span> <span class="hljs-number"><span class="hljs-number">96457</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">35610</span></span> <span class="hljs-number"><span class="hljs-number">167952</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">58656</span></span> <span class="hljs-number"><span class="hljs-number">285282</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">005</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">96617</span></span> <span class="hljs-number"><span class="hljs-number">534712</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">159146</span></span> <span class="hljs-number"><span class="hljs-number">924569</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">262143</span></span> <span class="hljs-number"><span class="hljs-number">1520968</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">001</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">004</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the screenshot with the debugger windows, the library version</font></font></b> <div class="spoiler_text"><img src="//habrastorage.org/files/f3e/6e3/e30/f3e6e3e304c04cf59a897e1f7063f0aa.png"><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function turned out to be surprisingly small, it is all here, under the cut. </font><font style="vertical-align: inherit;">The function actively uses string comparison operations with the repetition prefix ( </font></font><code>cmps*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Memory comparison is in direct order. </font><font style="vertical-align: inherit;">This is determined by the DF flag, which is reset by the command </font></font><code>cld</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The size and simplicity of this function suggests that it was written in assembler, although I am not sure about that. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The algorithm for the operation of string comparison operations is extremely simple, for example, comparison of DWORDs in the forward direction, given by this command:</font></font><br><pre> <code class="hljs 1c">repe cmpsd ;   <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ecx  DWORD';</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on JAVA can be represented as follows: </font></font><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( ( <span class="hljs-number"><span class="hljs-number">0</span></span> != ecx ) &amp; ( <span class="hljs-number"><span class="hljs-number">0</span></span> == Compare( (DWORD) RAM[esi], (DWORD) RAM[edi] ) ) ) { --ecx; edi += <span class="hljs-number"><span class="hljs-number">4</span></span>; esi += <span class="hljs-number"><span class="hljs-number">4</span></span>; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Almost the same can be represented by the alignment of words and bytes. </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dizasm with comments under the cut</font></font></b> <div class="spoiler_text"><pre> <code class="hljs cpp"> push esi ;      push edi cld ; DF &lt;-- <span class="hljs-number"><span class="hljs-number">0</span></span> mov esi, [esp+<span class="hljs-number"><span class="hljs-number">0</span></span>C] ; esi &lt;-- Source1 mov edi, [esp+<span class="hljs-number"><span class="hljs-number">10</span></span>] ; edi &lt;-- Source2 mov ecx, [esp+<span class="hljs-number"><span class="hljs-number">14</span></span>] ; ecx &lt;-- SIZE_T shr ecx, <span class="hljs-number"><span class="hljs-number">2</span></span> ; ecx &lt;-- (ecx &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) (    <span class="hljs-number"><span class="hljs-number">4</span></span>) jz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> smaller_4 ; repe cmpsd ;    ecx  DWORD'; jne <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> not_zero ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ZF ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> not_zero; smaller_4: mov ecx, [esp+<span class="hljs-number"><span class="hljs-number">14</span></span>] ; ecx &lt;-- SIZE_T <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ecx, <span class="hljs-number"><span class="hljs-number">00000003</span></span> ; ecx &amp;= <span class="hljs-number"><span class="hljs-number">3</span></span> jz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> return_SIZE_T ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( ZF ) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> return_SIZE_T; repe cmpsb ;     jne <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> found_difference return_SIZE_T: mov eax, [esp+<span class="hljs-number"><span class="hljs-number">14</span></span>] ; eax &lt;-- SIZE_T pop edi ;    pop esi ret <span class="hljs-number"><span class="hljs-number">0</span></span>C ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> eax not_zero: sub esi, <span class="hljs-number"><span class="hljs-number">4</span></span> ; esi -= <span class="hljs-number"><span class="hljs-number">4</span></span> sub edi, <span class="hljs-number"><span class="hljs-number">4</span></span> ; edi -= <span class="hljs-number"><span class="hljs-number">4</span></span> mov ecx, <span class="hljs-number"><span class="hljs-number">4</span></span> ; ecx -= <span class="hljs-number"><span class="hljs-number">4</span></span> repe cmpsb ;     found_difference: dec esi ; --esi sub esi, [esp+<span class="hljs-number"><span class="hljs-number">0</span></span>C] ; esi &lt;-- (esi - Source1) mov eax, esi ; eax &lt;-- esi pop edi ;    pop esi ret <span class="hljs-number"><span class="hljs-number">0</span></span>C ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> eax</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/214841/">https://habr.com/ru/post/214841/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214827/index.html">Show Sound # 6 - Podcast about audio equipment, components, formats and technologies</a></li>
<li><a href="../214831/index.html">Evernote for Android received support for handwritten notes</a></li>
<li><a href="../214833/index.html">What do gamedevs have in common with astronautics or work with PHP iterators?</a></li>
<li><a href="../214837/index.html">OrientDB - a simple example of working with graphs for beginners.</a></li>
<li><a href="../214839/index.html">Using GPIO from Python on Raspberry Pi</a></li>
<li><a href="../214847/index.html">MMORPG without unnecessary details</a></li>
<li><a href="../214849/index.html">Why does the robot have ears? (survey: do you need OpenTod)</a></li>
<li><a href="../214851/index.html">How to lose capital</a></li>
<li><a href="../214853/index.html">Startup Negotiations with the investor "amateur"</a></li>
<li><a href="../214855/index.html">Updated Opera for Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>