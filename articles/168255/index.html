<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embed your code in the process address space</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intro 

 Implementing your code (dynamically) into other processes is quite an interesting thing. It can serve both for good and for evil. Although th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embed your code in the process address space</h1><div class="post__text post__text-html js-mediator-article"><h5>  Intro </h5><br><br>  Implementing your code (dynamically) into other processes is quite an interesting thing.  It can serve both for good and for evil.  Although the concept of ‚Äúevil‚Äù, in some places, is very abstract in the information world, I cannot draw an exact line between what is ‚Äúbad‚Äù and what is ‚Äúgood‚Äù, especially if it concerns the implementation of the code ... <br><br>  In this article we will create your own injector DLL.  I think everyone knows what it is.  This method of implementing third-party code is quite popular and convenient. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will write DLL Injector in C ++ in Microsoft Visual Studio 2010. You can use any tool you like to create a dynamic link library.  I chose CodeGear RAD Studio 2009, the language of Delphi (Object Pascal), to create the library. <br><br>  <u>How does the DLL injection work?</u> <br><br>  The scheme of this method is simple: <br><blockquote>  1) search and obtain a descriptor of the desired process <br>  2) memory allocation in the process and the subsequent recording of the path in the DLL at the address where the memory allocation occurred <br>  3) create a new thread in the virtual space of the process, the handle of which was received. <br></blockquote><br><br><a name="habracut"></a><br><br>  <b>Start by creating a DLL.</b> <br><br>  As I said, the Delphi language will be used for this purpose: <br><br><img src="https://habrastorage.org/storage2/333/60c/d01/33360cd01c8110d8fc8180d096dc5042.png"><br><br>  Now we will add some resources to the DLL, namely, the form and buttons for managing: <br><br><img src="https://habrastorage.org/storage2/c7a/7a4/b92/c7a7a4b92ebd5f480f73ec6b5d7da26c.png"><br><br>  The DLL itself consists of only a few lines of code that will display the created form.  You can also delete all comments for more convenient visual perception of the code: <br><br><img src="https://habrastorage.org/storage2/d3c/4de/282/d3c4de2821d7be56bbe8241ab7b45ae7.png"><br><br>  Now we program the interface of the form DLL.  There are two buttons on the form.  The first will ‚Äúkill‚Äù the parent process (that is, the process in the virtual space of which a thread was created, in which, in turn, the DLL code is executed).  The second is to draw 10 squares of 25x25px in the context of all application windows belonging to the process: <br><br><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Button1Click</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Sender: TObject)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _curr_process:DWORD; p_handle: THANDLE; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">//    _curr_process:=GetCurrentProcessId(); p_handle:=OpenProcess(PROCESS_ALL_ACCESS,false,_curr_process); TerminateProcess(p_handle,4); end; var dw:DWORD; // PID   procedure drawGroup(h:HWND); var canvas:TBitMap; rect:TRect; x,y:integer; i: Integer; begin //  10  for i := 1 to 10 do begin canvas:=TBitMap.Create(); canvas.Canvas.Handle:=GetDC(h); //    randomize; canvas.Canvas.Brush.Color:=rgb(random(255),random(255),random(255)); GetWindowRect(h,rect); x:=random(rect.Right-rect.Left-25); y:=random(rect.Bottom-rect.Top-25); canvas.Canvas.Rectangle(x,y,x+25,y+25); end; end; function func(h:HWND):BOOL; stdcall; var pid:DWORD; begin GetWindowThreadProcessId(h,pid); //     ,     : if(pid=dw) then drawGroup(h); result:=true; end; procedure TForm1.Button2Click(Sender: TObject); begin //     // (     ) dw:=GetCurrentProcessId(); EnumWindows(@func,0); //   end;</span></span></code> </pre> <br><br>  <u>The source code of the interface part can be found <a href=""><b>here</b></a> .</u> <br><br>  It's all quite simple. <br>  So, the dynamic library is written.  Now we compile it and at the output we get a compiled file with the extension ".dll", which can be renamed for convenience.  <u>I rename the library to "inj.dll".</u> <br><br>  The creation of the DLL is complete. <br>  It remains only to copy our DLL`ku in the system directory of Windows, so that any application can find it only by one name. <br><br>  <b>We turn to the development of the injector.</b>  Go to Visual Studio and create an Empty Project (File-&gt; New-&gt; Project-&gt; Visual C ++ -&gt; General-&gt; Empty Project).  All development will be made on "pure" WinApi. <br><br>  First of all, we will create a simple visual interface: a form, a button and a text field.  It will look something like this: <br><br><img src="https://habrastorage.org/storage2/62e/ba6/4eb/62eba64eba82f1fa17337aa0c2bfc017.png"><br><br>  As you can see, this application has a minimal design and simplest interface.  It contains two text fields for entering the name of the process (or a specific part of it) into which you want to inject the DLL and for entering the name of the DLL itself.  The button, respectively, starts the injection process. <br><br>  <u>To inject a DLL into the process address space, the following WinApi functions will be needed:</u> <br><br>  <i><u>To search for the desired process:</u></i> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682489(v%3Dvs.85).aspx">CreateToolHelp32SnapShot</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684834(v%3Dvs.85).aspx">Process32First</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684836(v%3Dvs.85).aspx">Process32Next</a> <br><br>  <i><u>For inject:</u></i> <br><br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms684320(v%3Dvs.85).aspx">Openprocess</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms683212(v%3Dvs.85).aspx">GetProcAddress</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366890(v%3Dvs.85).aspx">VirtualAllocEx</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms681674(v%3Dvs.85).aspx">WriteProcessMemory</a> <br>  <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682437(v%3Dvs.85).aspx">CreateRemoteThread</a> <br><br>  So, let's think about how to actually organize the ‚Äúsmart‚Äù architecture of the application, which would be understandable and simple. <br>  I suggest starting with click click processing :) <br><br><pre> <code class="cpp hljs">MSG msg; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (GetMessage(&amp;msg,<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">// Button Click if(msg.hwnd==button &amp;&amp; msg.message==WM_LBUTTONUP) { // Getting Process Name GetWindowText(edit_proc,buff,sizeof(buff)); strncpy(_p_name,buff,BUFF); // Getting DLL Name ZeroMemory(buff,sizeof(buff)); GetWindowText(edit_dll,buff,BUFF); strncpy(_dll_name,buff,BUFF); // Start Injection StartInjection(); }</span></span></code> </pre><br><br>  Ok, then go to the implementation of the function <blockquote>  StartInjection (); </blockquote>  which is used to search for a process by its name: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartInjection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Searching of Process PROCESSENTRY32 pe; HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS,0); if(snapshot==INVALID_HANDLE_VALUE) { ShowMessage("SnapShot Failed."); return 0; } pe.dwSize = sizeof(PROCESSENTRY32); int curr = Process32First(snapshot,&amp;pe); while(curr) { CharLowerBuff(pe.szExeFile,lstrlen(pe.szExeFile)); if(strstr(pe.szExeFile,_p_name)) {pid = pe.th32ProcessID; break;} curr = Process32Next(snapshot,&amp;pe); } if(pid==NULL) { ShowMessage("Searching of process failed."); return 0; } bool result = Inject(); if(result==false) { ShowMessage("Injection failed."); return 0; } }</span></span></code> </pre><br><br>  Finally, the final injection function <blockquote>  Inject () </blockquote>  : <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Injection bool Inject() { if(pid==NULL) return false; //    HANDLE process = OpenProcess(PROCESS_ALL_ACCESS,false,pid); if(process==NULL) return false; // ""       //  DLL      LPVOID fp = (LPVOID)GetProcAddress(GetModuleHandle("kernel32.dll"),"LoadLibraryA"); if(fp==NULL) return false; //     strlen(_dll_name)   //      . LPVOID alloc = (LPVOID)VirtualAllocEx(process,0,strlen(_dll_name), MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE); if(alloc==NULL) return false; //    DLL   BOOL w = WriteProcessMemory(process,(LPVOID)alloc,_dll_name,strlen(_dll_name),0); if(w==NULL) return false; //  ""     //       DLL. HANDLE thread = CreateRemoteThread(process,0,0,(LPTHREAD_START_ROUTINE)fp,(LPVOID)alloc,0,0); if(thread==NULL) return false; CloseHandle(process); return true; }</span></span></code> </pre><br><br>  <u>The full code of the injector can be found <a href=""><u><b>here</b></u></a> .</u> <br><br>  Testing injector performance: <br><br><img src="https://habrastorage.org/storage2/eae/5a2/aa9/eae5a2aa958e245d282a046a08ded645.png"><br><br>  At first we inject ourselves.  When you click on the ‚ÄúDraw‚Äù button, 10 squares are drawn.  When you click on ‚ÄúCrash it!‚Äù, The ‚Äúparent‚Äù process is completed immediately.  Now we will try to inject into something more serious, for example, in the Mozilla Firefox browser.  To do this, you need to change only the name of the process in the first text field and click on the button: <br><br><img src="https://habrastorage.org/storage2/132/477/daf/132477dafc6edd0459fc3a352c5b262d.png"><br><br>  As you can see, the injection was successful.  Squares are drawn in all windows belonging to the parent browser process.  When you click on the "Crash it!" Button, Mozilla FireFox immediately closes. <br><br><h5>  <b>Outro</b> </h5><br><br>  Why do we need it at all?  After all, our main goal is hacking (games, software).  So in the future we, for sure, will use this injector to introduce our code into another address space.  Thanks to this, you can save a lot of time, effort and nerves :) <br><br>  <b>Good luck!</b> </div><p>Source: <a href="https://habr.com/ru/post/168255/">https://habr.com/ru/post/168255/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../16824/index.html">Interactive Internet Universe</a></li>
<li><a href="../168241/index.html">The helicopter weighing 16 grams entered service with the British army.</a></li>
<li><a href="../168249/index.html">Backup to "Cloud Storage"</a></li>
<li><a href="../168251/index.html">An overview of image compression tools</a></li>
<li><a href="../168253/index.html">For IBShnikov</a></li>
<li><a href="../168257/index.html">Perfect letter to investor</a></li>
<li><a href="../168259/index.html">Lecture videos of the entire course of the first Yandex Interface Development School</a></li>
<li><a href="../168261/index.html">API based IT job opener widget</a></li>
<li><a href="../168263/index.html">Reminiscence - an elegant platformer for Windows Phone</a></li>
<li><a href="../168265/index.html">Kotlin M5 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>