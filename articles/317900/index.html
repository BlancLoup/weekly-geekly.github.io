<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Check Umbraco source code again</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Time is implacable. It would seem that only recently we announced the release of a static analyzer for C # code, checked the first projects and starte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Check Umbraco source code again</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fed/057/0cb/fed0570cbf254481b176ed573e653acf.png" align="left">  Time is implacable.  It would seem that only recently we announced the release of a static analyzer for C # code, checked the first projects and started writing articles about it.  And now a whole year has passed from that moment.  A year of painstaking and complex work to improve the analyzer performance, add new diagnostic rules, collect false positives statistics and eliminate their causes, interact with users and solve a host of other issues.  A year of many small and big victories on the difficult but incredibly interesting path we have chosen.  It's time to re-check the project, the first to come to us for research using the new C # analyzer a year ago - Umbraco. <br><a name="habracut"></a><br><br><h2>  Introduction </h2><br>  An <a href="http://www.viva64.com/ru/b/0357/">article by</a> my colleague Andrei Karpov was devoted to searching for errors in the <a href="https://umbraco.com/">Umbraco</a> project.  All this year, the project continued to develop, and to date contains about 3,340 files with the extension ".cs", which is approximately 425 KLOC (at the time of the check by Andrei, the project contained 3,200 files with the extension ".cs" and 400 KLOC, respectively). <br><br>  During the first check in Umbraco, relatively few errors were found, which, nevertheless, were interesting enough to write an article about it and draw the first conclusions about the quality of the workings of the new C # analyzer.  The more interesting now, when the analyzer has got dozens of new diagnostic rules and improved error finding mechanisms, retest the Umbraco project and compare the results with those obtained in November 2015.  For verification, I used the latest version of the Umbraco source code, which, as before, is available for download on the <a href="https://github.com/umbraco/Umbraco-CMS">GitHub</a> portal, as well as the latest version of the <a href="http://www.viva64.com/ru/pvs-studio-download/">PVS-Studio 6.11</a> analyzer <a href="http://www.viva64.com/ru/pvs-studio-download/">.</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, 508 warnings were received.  Of these, the first level is 71, the second is 358, the third is 79: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/253/6c6/ce1/2536c6ce1457420092c16e6c07a76484.png"></div><br>  The total density of suspicious sites (the number of warnings per KLOC) is 1.12.  This is a good indicator, corresponding to approximately one warning per thousand lines of code.  But warnings do not mean real mistakes.  For any static analyzer, a certain percentage of false positives is normal.  Also, warnings can often be received that are very similar to real errors, but when studying by the author of the code it turns out that this is not the case.  To save time, I will not consider warnings with a Low level, since there is usually a high percentage of false positives. <br><br>  I analyzed the warnings issued by PVS-Studio and revealed about 56% of false positives at the High and Meduim levels.  The remaining warnings contain very suspicious constructions that you should carefully look at, as well as real errors in the code. <br><br>  What can be said about the quality of the analyzer, compared with the test of 2015?  The first thing that catches your eye is that almost none of the warnings described in the previous article were detected.  I want to believe that the authors of the project Umbraco drew attention to the article by Andrew and corrected the errors cited there.  Although, of course, the project is in continuous development and errors could be corrected in the course of everyday work.  One way or another, there are almost no old mistakes.  But there are many new ones!  I will give the most interesting of them. <br><br><h2>  Test results </h2><br>  <b>Potential division by zero</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3064/">V3064</a> Potential division by zero.  Consider inspecting denominator 'maxWidthHeight'.  ImageHelper.cs 154 <br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3064/">V3064</a> Potential division by zero.  Consider inspecting denominator 'maxWidthHeight'.  ImageHelper.cs 155 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ResizedImage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateThumbnail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maxWidthHeight &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fx = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)image.Size.Width / maxWidthHeight; <span class="hljs-comment"><span class="hljs-comment">// &lt;= var fy = (float)image.Size.Height / maxWidthHeight; // &lt;= .... } .... }</span></span></code> </pre> <br>  The above code snippet contains two possible errors at once, although the second will never happen.  The <i>if</i> block condition allows the <i>maxWidthHeight</i> variable to be zero, which acts as a divider within the block.  In general, such a code can work normally for quite a long time, and therein lies its danger.  Based on the name of the <i>maxWidthHeight</i> variable, it can be concluded that its value is not likely to be zero.  Well, if you still will?  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ResizedImage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateThumbnail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (maxWidthHeight &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fx = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)image.Size.Width / maxWidthHeight; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fy = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)image.Size.Height / maxWidthHeight; .... } .... }</code> </pre> <br>  The case when the <i>maxWidthHeight</i> variable is zero must be processed separately. <br><br>  <b>Annoying typo</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3080/">V3080</a> Possible null dereference.  Consider inspecting the 'context.Request'.  StateHelper.cs 369 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HasCookies { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = HttpContext; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; context.Request != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= context.Request.Cookies != null &amp;&amp; context.Response != null &amp;&amp; context.Response.Cookies != null; } }</span></span></code> </pre> <br>  A typo was made: instead of the <i>&amp;&amp;</i> operator, use <i>&amp;.</i>  The <i>context.Request.Cookies! = Null</i> condition will be checked regardless of the result of checking the previous <i>context.Request</i> condition <i>! = Null</i> .  This will inevitably lead to access via a null reference if the <i>context.Request</i> variable is <i>null</i> .  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> HasCookies { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = HttpContext; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; context.Request != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; context.Request.Cookies != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; context.Response != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; context.Response.Cookies != <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre> <br>  <b>Late equality test for null</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3027/">V3027</a> The variable 'rootDoc' was used in the same logical expression.  publishRootDocument.cs 34 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rootDoc.Text.Trim() == documentName.Trim() &amp;&amp; <span class="hljs-comment"><span class="hljs-comment">// &lt;= rootDoc != null &amp;&amp; rootDoc.ContentType != null) .... }</span></span></code> </pre> <br>  The variable <i>rootDoc ‚Äã‚Äãis</i> checked for <i>null</i> equality already after using <i>rootDoc.Text</i> for access.  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rootDoc != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; rootDoc.Text.Trim() == documentName.Trim() &amp;&amp; rootDoc.ContentType != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) .... }</code> </pre> <br>  <b>Negative character index in the string</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3057/">V3057</a> The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the second argument.  ContentExtensions.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CultureInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCulture</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pos = route.IndexOf(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); domain = pos == <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : domainHelper.DomainForNode( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(route.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, pos)), current) <span class="hljs-comment"><span class="hljs-comment">// &lt;= .UmbracoDomain; .... }</span></span></code> </pre> <br>  The <i>route</i> string is searched for the character '/', after which the index is assigned to the variable <i>pos</i> .  The author took into account the possibility of finding the character at the beginning of the line ( <i>pos == 0)</i> , but did not take into account the probability of its absence: in this case, the variable <i>pos</i> will receive the value -1.  This will throw an exception when the <i>pos</i> variable is later used to extract the substring <i>route.Substring (0, pos)</i> .  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CultureInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCulture</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pos = route.IndexOf(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); domain = (pos &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : domainHelper.DomainForNode( <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(route.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, pos)), current) .UmbracoDomain; .... }</code> </pre> <br>  Similar warnings: <br><br><ul><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the first argument.  DefaultUrlProvider.cs 81 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the second argument.  DefaultUrlProvider.cs 84 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the first argument.  DefaultUrlProvider.cs 126 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the second argument.  DefaultUrlProvider.cs 127 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the first argument.  PublishedContentCache.cs 147 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the second argument.  PublishedContentCache.cs 148 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the second argument.  ContentFinderByNiceUrlAndTemplate.cs 35 </li><li>  V3057 The 'Substring' function for the '-9' value while non-negative value is expected.  Inspect the second argument.  requestModule.cs 187 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the second argument.  Action.cs 134 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the first argument.  LegacyShortStringHelper.cs 130 </li><li>  V3057 The 'Substring' function could receive the '-1' value while non-negative value is expected.  Inspect the second argument.  StringExtensions.cs 573 </li></ul><br>  <b>Time is money</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3057/">V3057</a> The 'DateTime' constructor receives the '0' value while positive value is expected.  Inspect the second argument.  DateTimeExtensions.cs 24 <br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3057/">V3057</a> The 'DateTime' constructor receives the '0' value while positive value is expected.  Inspect the third argument.  DateTimeExtensions.cs 24 <br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3057/">V3057</a> The 'DateTime' constructor receives the '0' value while positive value is expected.  Inspect the third argument.  DateTimeExtensions.cs 26 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DateTime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TruncateTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DateTime dt, DateTruncate truncateTo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (truncateTo == DateTruncate.Year) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(dt.Year, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;= x2 if (truncateTo == DateTruncate.Month) return new DateTime(dt.Year, dt.Month, 0); // &lt;= .... }</span></span></code> </pre> <br>  This small code fragment contains 3 errors at once, which are also detected by the diagnostic rule <a href="http://www.viva64.com/ru/w/V3057/">V3057</a> .  All errors are related to incorrect initialization of the object of the <i>DateTime</i> class, the constructor of which has the form: <i>public DateTime (int year, int month, int day).</i>  In this case, the parameters <i>year</i> , <i>month,</i> and <i>day</i> cannot take values ‚Äã‚Äã&lt;1. Otherwise, the exception will be thrown <i>ArgumentOutOfRangeException.</i>  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DateTime </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TruncateTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DateTime dt, DateTruncate truncateTo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (truncateTo == DateTruncate.Year) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(dt.Year, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (truncateTo == DateTruncate.Month) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(dt.Year, dt.Month, <span class="hljs-number"><span class="hljs-number">1</span></span>); .... }</code> </pre> <br>  <b>Erroneous condition</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3125/">V3125</a> The 'ct' object was used after it was verified against null.  Check lines: 171, 163. ContentTypeControllerBase.cs 171 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> TContentType PerformPostSave&lt;....&gt;(....) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctId = Convert.ToInt32(....); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctId &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; ct == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpResponseException(HttpStatusCode.NotFound); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((....) &amp;&amp; (ctId == <span class="hljs-number"><span class="hljs-number">0</span></span> || ct.Alias != contentTypeSave.Alias)) <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }</span></span></code> </pre> <br>  Due to the condition <i>(ctId&gt; 0 &amp;&amp; ct == null)</i> in this code fragment there is a probability of subsequent access via a null link.  The exception <i>HttpResponseException</i> will be thrown only when both parts of the condition are met simultaneously.  In the case, if the variable <i>ctId</i> is &lt;= 0, regardless of the value of the variable <i>ct</i> , the work will continue.  And the error must be corrected in the second condition, where <i>ct</i> is used <i>.</i>  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> TContentType PerformPostSave&lt;....&gt;(....) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ctId = Convert.ToInt32(....); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctId &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; ct == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpResponseException(HttpStatusCode.NotFound); .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((....) &amp;&amp; (ctId == <span class="hljs-number"><span class="hljs-number">0</span></span> || (ct != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; ct.Alias != contentTypeSave.Alias))) .... }</code> </pre> <br>  Similar warnings: <br><br><ul><li>  V3125 The '_repo' object was used after it was verified against null.  Check lines: 104, 78. Installer.aspx.cs 104 </li><li>  V3125 The 'docRequest.RoutingContext.UmbracoContext' it was verified against null.  Check lines: 57, 39. ContentFinderByIdPath.cs 57 </li><li>  V3125 The 'User' object has been verified against null.  Check lines: 90, 80. config.cs 90 </li><li>  V3125 The '_repo' object was used after it was verified against null.  Check lines: 254, 247. installedPackage.aspx.cs 254 </li><li>  V3125 The 'node.NiceUrl' object was used against it.  Check lines: 917, 912. NodeExtensions.cs 917 </li><li>  V3125 The 'dst' object was used after it was verified against null.  Check lines: 58, 55. DataEditorSetting.cs 58 </li><li>  V3125 The 'result' object has been verified against null.  Check lines: 199, 188. DefaultPreValueEditor.cs 199 </li><li>  V3125 The 'result' object has been verified against null.  Check lines: 241, 230. usercontrolPrevalueEditor.cs 241 </li></ul><br>  <b>Formatting error</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3025/">V3025</a> Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Format items not used: {1}.  Arguments not used: 1st.  HtmlHelperRenderExtensions.cs 938 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IHtmlString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnableCanvasDesigner</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> noPreviewLinks = <span class="hljs-string"><span class="hljs-string">@"&lt;link href=""{1}"" type= ""text/css"" rel=""stylesheet"</span></span> <span class="hljs-string"><span class="hljs-string">" data-title="</span></span><span class="hljs-string"><span class="hljs-string">"canvasdesignerCss"</span></span><span class="hljs-string"><span class="hljs-string">" /&gt;"</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) result = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(noPreviewLinks, cssPath) + <span class="hljs-comment"><span class="hljs-comment">// &lt;= Environment.NewLine; .... }</span></span></code> </pre> <br>  The <i>noPreviewLinks</i> format <i>string</i> does not contain the qualifier '{0}' for the first <i>cssPath</i> argument of the <i>string.Format</i> method.  As a result of executing this code, an exception will be thrown.  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IHtmlString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnableCanvasDesigner</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> noPreviewLinks = <span class="hljs-string"><span class="hljs-string">@"&lt;link href=""{0}"" type= ""text/css"" rel=""stylesheet"</span></span> <span class="hljs-string"><span class="hljs-string">" data-title="</span></span><span class="hljs-string"><span class="hljs-string">"canvasdesignerCss"</span></span><span class="hljs-string"><span class="hljs-string">" /&gt;"</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) result = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(noPreviewLinks, cssPath) + Environment.NewLine; .... }</code> </pre> <br>  Similar warnings: <br><br><ul><li>  V3025 Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Format items not used: {1}.  Arguments not used: 1st.  HtmlHelperRenderExtensions.cs 946 </li><li>  V3025 Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Arguments not used: path.  requestModule.cs 204 </li><li>  V3025 Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Arguments not used: Alias.Replace ("", "").  Template.cs 382 </li><li>  V3025 Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Arguments not used: Alias.Replace ("", "").  Template.cs 387 </li><li>  V3025 Incorrect format.  A different number of formatted items is expected while calling 'Format' function.  Arguments not used: this.Value.ClientID.  SliderPrevalueEditor.cs 221 </li></ul><br>  <b>The late check for equality is null.</b>  <b>Again</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3095/">V3095</a> The 'dataset' object was used against null.  Check lines: 48, 49. ImageCropperBaseExtensions.cs 48 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ImageCropData </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCrop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imageCropDatas = dataset.ToArray(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (dataset == null || imageCropDatas.Any() == false) return null; .... }</span></span></code> </pre> <br>  Unlike the <a href="http://www.viva64.com/ru/w/V3027/">V3027</a> diagnostics, where a late check for <i>null</i> was found within one condition, here we are dealing with an attempt to access a null reference in another statement.  The variable <i>dataset is</i> first converted to an array, and only after that it is checked for <i>null</i> equality.  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ImageCropData </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCrop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> imageCropDatas = dataset?.ToArray(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (imageCropDatas == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || !imageCropDatas.Any()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; .... }</code> </pre> <br>  Similar warnings: <br><br><ul><li>  V3095 The 'display.PropertyEditor' object was verified against null.  Check lines: 30, 43. ContentPropertyDisplayConverter.cs 30 </li><li>  V3095 The 'typedSource' object was used before it was verified against null.  Check lines: 164, 198. DynamicQueryable.cs 164 </li><li>  V3095 The 'attempt. Result' object was used before it was verified against null.  Check lines: 90, 113. DynamicPublishedContent.cs 90 </li><li>  V3095 The 'actionExecutedContext' object was used against it.  Check lines: 47, 76. FileUploadCleanupFilterAttribute.cs 47 </li><li>  V3095 The 'type' object was used against it.  Check lines: 92, 96. assemblyBrowser.aspx.cs 92 </li><li>  V3095 The 'httpContext' object was used before it was verified against null.  Check lines: 235, 237. UmbracoContext.cs 235 </li><li>  V3095 The 'dst' object was used against it.  Check lines: 53, 55. DataEditorSetting.cs 53 </li><li>  V3095 The '_val' object was used against it.  Check lines: 46, 55. CheckBoxList.cs 46 </li><li>  V3095 The '_val' object was used against it.  Check lines: 47, 54. ListBoxMultiple.cs 47 </li><li>  V3095 The 'databaseSettings.ConnectionString' object was verified against null.  Check lines: 737, 749. DatabaseContext.cs 737 </li><li>  V3095 The 'path' object was used against it.  Check lines: 101, 112. IOHelper.cs 101 </li></ul><br>  <b>Logical error</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3022/">V3022</a> Expression 'name! = "Min" ||  name! = "Max" 'is always true.  Probably the '&amp;&amp;' operator should be used here.  DynamicPublishedContentList.cs 415 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Aggregate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name != <span class="hljs-string"><span class="hljs-string">"Min"</span></span> || name != <span class="hljs-string"><span class="hljs-string">"Max"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { throw new ArgumentException( "Can only use aggregate min or max methods on properties which are datetime"); } .... }</span></span></code> </pre> <br>  As follows from the message in the exception, the <i>name</i> variable can take only one of the values ‚Äã‚Äã‚ÄúMin‚Äù <b>or</b> ‚ÄúMax‚Äù.  In this case, the condition for the release of this exception should be the simultaneous inequality of the <i>name</i> variable ‚ÄúMin‚Äù <b>and</b> ‚ÄúMax‚Äù.  And in the above code snippet, an exception will be thrown for any <i>name</i> value.  The corrected version of this construction is: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Aggregate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (name != <span class="hljs-string"><span class="hljs-string">"Min"</span></span> &amp;&amp; name != <span class="hljs-string"><span class="hljs-string">"Max"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException( <span class="hljs-string"><span class="hljs-string">"Can only use aggregate min or max methods on properties which are datetime"</span></span>); } .... }</code> </pre> <br>  In the Umbraco code, another 32 similar potentially unsafe constructions were found (although they may turn out to be just superfluous checks).  I will give some of them: <br><br><ul><li>  V3022 Expression 'macro == null' is always false.  MacroController.cs 91 </li><li>  V3022 Expression 'p. Value == null' is always false.  ImageCropperPropertyEditor.cs 216 </li><li>  V3022 Expression 'loginPageObj! = Null' is always true.  ProtectPage.aspx.cs 93 </li><li>  V3022 Expression 'dictionaryItem! = Null' is always true.  TranslateTreeNames.cs 19 </li><li>  V3022 Expression '! IsPostBack' is always true.  EditUser.aspx.cs 431 </li><li>  V3022 Expression 'result. View! = Null' is always false.  ControllerExtensions.cs 129 </li><li>  V3022 Expression 'string.IsNullOrEmpty (UmbracoSettings.TEMP_FRIENDLY_XML_CHILD_CONTAINER_NODENAME) == false' is always.  NotFoundHandlers.cs 128 </li><li>  V3022 Expression 'mem! = Null' is always true.  ViewMembers.aspx.cs 96 </li><li>  V3022 Expression 'dtd! = Null' is always true.  installedPackage.aspx.cs 213 </li><li>  V3022 Expression 'jsonReader.TokenType == JSONToken.EndArray &amp;&amp; jsonReader.Value == null' is always false.  JSON.cs 263 </li></ul><br>  <b>Strange cycle condition</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3022/">V3022</a> Expression '! Stop' is always true.  template.cs 229 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Control </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseStringBuilder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!stop) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { .... } .... }</span></span></code> </pre> <br>  Another suspicious design detected by the <a href="http://www.viva64.com/ru/w/V3022/">V3022</a> diagnostic.  The variable <i>stop is</i> not used inside a <i>while</i> block.  Inside the block there is a fairly large code snippet, about 140 lines, so I will not list it.  Here are the search results for the <i>stop</i> variable: <br><br><p><img src="https://habrastorage.org/files/5cc/79b/a15/5cc79ba1546944eb87f66bd79cfe985a.png"></p><br>  Probably, the cycle is not infinite, as inside it contains a <i>break</i> , as well as exception handling blocks.  However, the loop looks very strange and may contain a potential error. <br><br>  <b>Infinite recursion</b> <br><br>  <b>PVS-Studio analyzer warning</b> : <a href="http://www.viva64.com/ru/w/V3110/">V3110</a> Possible infinite recursion inside 'Render' method.  MenuSplitButton.cs 30 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.Web.UI.HtmlTextWriter writer</span></span></span><span class="hljs-function">)</span></span> { writer.Write(<span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Render(writer); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Render(writer); <span class="hljs-comment"><span class="hljs-comment">// &lt;= writer.Write("&lt;div class='btn-group&gt;"); }</span></span></code> </pre> <br>  Most likely, the specified code fragment contains an error associated with the creation of an infinite recursion.  After calling the <i>Render</i> method of the base class, a recursive call to the overloaded <i>Render</i> method ‚Äúby analogy‚Äù is made.  Most likely, the <i>this.Render</i> method should contain some condition for exiting recursion.  In this case, it is difficult to draw an unambiguous conclusion about the correct version of this design. <br><br><h2>  Conclusion </h2><br>  So, a re-check of the Umbraco project showed that PVS-Studio has made significant progress in detecting both potentially dangerous and erroneous constructions in C # code.  The analyzer again proved its effectiveness.  Of course, you should not check the projects at intervals once a year, because the maximum effect of static analysis is achieved with its regular use.  This allows you to correct errors in a timely and efficient manner, preventing them from leaking into the assembly system or to users. <br><br>  Use static analysis!  And so that anyone could do this, we added the possibility of <a href="http://www.viva64.com/ru/b/0457/">free</a> use to our analyzer.  Good luck to you in the fight against errors and the perfect code! <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0461/"><img src="https://habrastorage.org/files/8d2/41b/5bf/8d241b5bf34747169141ed7c1997143b.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Sergey Khrenov.  <a href="http://www.viva64.com/en/b/0461/">Re-analysis of Umbraco code</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/317900/">https://habr.com/ru/post/317900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317884/index.html">Transaction Isolation Levels with PostgreSQL Examples</a></li>
<li><a href="../317886/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ241 (December 12 - 18, 2016)</a></li>
<li><a href="../317892/index.html">SwiftLint - clean and tidy iOS project</a></li>
<li><a href="../317894/index.html">Alameda, Bower and NPM integration in the CleverStyle Framework</a></li>
<li><a href="../317896/index.html">WPF - Floppy Pages</a></li>
<li><a href="../317904/index.html">How to fill out and sign documents automatically using DocuSign</a></li>
<li><a href="../317906/index.html">Telegram-bot for the system administrator</a></li>
<li><a href="../317908/index.html">How IT professionals work. Maxim Lapshin, Founder of Flussonic</a></li>
<li><a href="../317910/index.html">How Yandex taught the machine to create translations for rare languages</a></li>
<li><a href="../317912/index.html">As we on Habr√© survey about CRM conducted: results</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>