<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django auto-completion multiple choice field</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr. 
 In my last article I described the technology for creating a custom field for entering tags in Django. Now I would like to share a ready-m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django auto-completion multiple choice field</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr. <br>  In my last <a href="http://habrahabr.ru/post/176807/">article</a> I described the technology for creating a custom field for entering tags in Django.  Now I would like to share a ready-made and more or less universal solution that implements the multiple choice field with AJAX auto-completion.  The difference of this field from that described in the previous article is that it allows you only to select items from the directory, but not to create new ones.  A wonderful jQuery-plugin <a href="http://ivaynberg.github.io/select2/">Select2</a> will be responsible for the front-end part.  The solution will be in the form of a separate Django application. <br><a name="habracut"></a><br><br><h4>  Widget </h4><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.forms.widgets <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Widget <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.utils.safestring <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mark_safe <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.template.loader <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> render_to_string <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InfiniteChoiceWidget</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Widget)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">'''Infinite choice widget, based on Select2 jQuery-plugin (http://ivaynberg.github.io/select2/)'''</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Media</span></span></span><span class="hljs-class">:</span></span> js = ( settings.STATIC_URL + <span class="hljs-string"><span class="hljs-string">"select2/select2.js"</span></span>, ) css = { <span class="hljs-string"><span class="hljs-string">'all'</span></span>: (settings.STATIC_URL + <span class="hljs-string"><span class="hljs-string">'select2/select2.css'</span></span>,) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data_model, multiple=False, disabled=False, attrs=None)</span></span></span><span class="hljs-function">:</span></span> super(InfiniteChoiceWidget, self).__init__(attrs) self.data_model = data_model self.multiple = multiple self.disabled = disabled <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, value, attrs=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mark_safe(render_to_string(<span class="hljs-string"><span class="hljs-string">"infinite_choice_widget.html"</span></span>, {<span class="hljs-string"><span class="hljs-string">"disabled"</span></span>: self.disabled, <span class="hljs-string"><span class="hljs-string">"multiple"</span></span>: self.multiple, <span class="hljs-string"><span class="hljs-string">"attrs"</span></span>: attrs, <span class="hljs-string"><span class="hljs-string">"app_name"</span></span>: self.data_model._meta.app_label, <span class="hljs-string"><span class="hljs-string">"model_name"</span></span>: self.data_model.__name__, <span class="hljs-string"><span class="hljs-string">"input_name"</span></span>: name, <span class="hljs-string"><span class="hljs-string">"current_value"</span></span>: value <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>, }) )</code> </pre> <br>  The widget's constructor accepts the model class, the multiple and disabled flags, which are responsible, respectively, for the selection multiplicity and the field activity.  In the Media subclass, the scripts and styles of Select2 are connected.  The script that initializes the Select2 plugin will be described in the infinite_choice_widget.html template. <br><pre> <code class="html hljs xml">{% load url from future %} {#    django 1.5 #} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"hidden"</span></span></span><span class="hljs-tag"> {% </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">,</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">in</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">attrs.iteritems</span></span></span><span class="hljs-tag"> %} {{</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">}}=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{value}}"</span></span></span><span class="hljs-tag"> {% </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endfor</span></span></span><span class="hljs-tag"> %} </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{input_name}}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{current_value}}"</span></span></span><span class="hljs-tag"> /&gt;</span></span> {# Settings for Select2 #} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> $(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"#{{attrs.id}}"</span></span></span><span class="javascript">).select2({ </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">multiple</span></span></span><span class="javascript">: {{multiple|yesno:</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"true,false"</span></span></span><span class="javascript">}}, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">formatInputTooShort</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">input, min</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">",  "</span></span></span><span class="javascript"> + (min - input.length) + </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"   "</span></span></span><span class="javascript">; }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">formatSearching</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"..."</span></span></span><span class="javascript">; }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">formatNoMatches</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"  "</span></span></span><span class="javascript">; }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">minimumInputLength</span></span></span><span class="javascript">: </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">3</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">initSelection</span></span></span><span class="javascript"> : </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">element, callback</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ $.ajax({ </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">url</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"{% url 'infinite_choice_data' app_name model_name %}"</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">type</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'GET'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">dataType</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'json'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">data</span></span></span><span class="javascript">: {</span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">ids</span></span></span><span class="javascript">: element.val()}, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">success</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">data, textStatus, xhr</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ callback(data); }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">error</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function">(</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">xhr, textStatus, errorThrown</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ callback({}); } }); }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">ajax</span></span></span><span class="javascript">: { </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">url</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"{% url 'infinite_choice_data' app_name model_name %}"</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">dataType</span></span></span><span class="javascript">: </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'json'</span></span></span><span class="javascript">, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">data</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">term, page</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">return</span></span></span><span class="javascript"> {</span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">term</span></span></span><span class="javascript">: term, </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// search term page_limit: 10 }; }, results: function (data, page) { return {results: data}; } } }); {% if disabled %} $("#{{attrs.id}}").select2("disable"); {% endif %} </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The central object here is hidden input, in which the identifiers of the selected options will be stored.  And already on it, the Select2 plugin is set on by #id. <br>  Let's run through the parameters of the plugin. <br><ul><li>  <b>multiple</b> - turns on / off the possibility of multiple selection </li><li>  <b>formatInputTooShort</b> - returns a string indicating how many characters are left to enter before auto-completion is triggered. </li><li>  <b>formatSearching</b> - a string indicating that the search is in progress </li><li>  <b>formatNoMatches</b> - a string shown from despair ... </li><li>  <b>minimumInputLength</b> - the minimum number of characters entered to trigger auto-completion </li><li>  <b>initSelection</b> - if, when loading a page in a hidden field, there are some selected elements, then this function makes an AJAX request to the server to search for displayable names for these elements. </li><li>  <b>ajax</b> - sends the entered text and gets a list of objects {id: ..., title: ...}, in which the title starts with the entered text.  <b>term</b> - the entered string to search for entries, <b>page_limit</b> - the number of displayed found options. </li></ul><br>  Please note that the URL that the data is requested for is the name of the application and the model name from this application.  This is done to universalize the processing view: the view does not have to be clear about the model from which the data is taken, we will tell it to it every time. <br>  At the end, we tell the plugin to be inactive if the widget passed disabled = True. <br><br><h4>  Presentation for autocompletion </h4><br>  As I said, the view must be universal and it does not need to know which model to take the data from.  There is a standard way to get a model class by the well-known application name and the model class name, we use it by passing these strings to the view. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Http404, HttpResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_model <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">infinite_choice_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, app_name, model_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">'''Returns data for infinite choice field'''</span></span> data = [] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> request.is_ajax(): <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Http404 model = get_model(app_name, model_name) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'term'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.GET: term = request.GET[<span class="hljs-string"><span class="hljs-string">'term'</span></span>] page_limit = request.GET[<span class="hljs-string"><span class="hljs-string">'page_limit'</span></span>] data = model.objects.filter(title__startswith=term)[:int(page_limit)] json_data = json.dumps([{<span class="hljs-string"><span class="hljs-string">"id"</span></span>: item.id, <span class="hljs-string"><span class="hljs-string">"text"</span></span>: unicode(item.title)} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'ids'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.GET: id_list = request.GET[<span class="hljs-string"><span class="hljs-string">'ids'</span></span>].split(<span class="hljs-string"><span class="hljs-string">','</span></span>) items = model.objects.filter(pk__in=id_list) json_data = json.dumps([{<span class="hljs-string"><span class="hljs-string">"id"</span></span>: item.id, <span class="hljs-string"><span class="hljs-string">"text"</span></span>: item.title} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> items]) response = HttpResponse(json_data, content_type=<span class="hljs-string"><span class="hljs-string">"application/json"</span></span>) response[<span class="hljs-string"><span class="hljs-string">'Cache-Control'</span></span>] = <span class="hljs-string"><span class="hljs-string">'max-age=86400'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response</code> </pre><br>  The django.db.models.get_model function returns the model class.  Further, depending on the query variables, either variants starting with the term string are selected from the model, or variants with id equal to those passed in the variable ids.  The second case occurs when the plug-in is initialized with the previously entered data. <br>  I added a Cache-Control header in response, with a cache data lifetime of 24 hours.  This is so as not to pull the base of the same type of requests.  It helps a lot when using a field with huge KLADR / FIAS type directories. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And this is what the urls.py entry looks like for our view. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf.urls <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> patterns, url <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> views <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> infinite_choice_data urlpatterns = patterns(<span class="hljs-string"><span class="hljs-string">''</span></span>, url(<span class="hljs-string"><span class="hljs-string">r'^(?P&lt;app_name&gt;[\w\d_]+)/(?P&lt;model_name&gt;[\w\d_]+)/$'</span></span>, view=infinite_choice_data, name=<span class="hljs-string"><span class="hljs-string">'infinite_choice_data'</span></span>), )</code> </pre><br><br><h4>  Form field </h4><br>  As you know, the form field in django serves mainly to validate the data entered into it.  Our field class will look like this: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.forms <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> fields <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f_fields <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.core.exceptions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ValidationError <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.core <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> validators <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.utils.translation <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ugettext_lazy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> _ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InfiniteChoiceField</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(f_fields.Field)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">'''Infinite choice field'''</span></span> default_error_messages = { <span class="hljs-string"><span class="hljs-string">'invalid_choice'</span></span>: _(<span class="hljs-string"><span class="hljs-string">u'Select a valid choice. %(value)s is not one of the available choices.'</span></span>), } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data_model, multiple=False, disabled=False, widget_attrs=None, **kwargs)</span></span></span><span class="hljs-function">:</span></span> self.data_model = data_model self.disabled = disabled self.multiple = multiple widget = InfiniteChoiceWidget(data_model, multiple, disabled, widget_attrs) super(InfiniteChoiceField, self).__init__(widget=widget, **kwargs) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_python</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> validators.EMPTY_VALUES: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.multiple: values = value.split(<span class="hljs-string"><span class="hljs-string">','</span></span>) qs = self.data_model.objects.filter(pk__in=values) pks = set([i.pk <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> qs]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> values: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> int(val) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pks: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValidationError(self.error_messages[<span class="hljs-string"><span class="hljs-string">'invalid_choice'</span></span>] % {<span class="hljs-string"><span class="hljs-string">'value'</span></span>: val}) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> qs <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.data_model.objects.get(pk=value) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> self.data_model.DoesNotExists: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValidationError(self.error_messages[<span class="hljs-string"><span class="hljs-string">'invalid_choice'</span></span>] % {<span class="hljs-string"><span class="hljs-string">'value'</span></span>: value}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, value)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> value <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> hasattr(value, <span class="hljs-string"><span class="hljs-string">'__iter__'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> self.multiple: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">u','</span></span>.join(unicode(v.pk) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unicode(value.pk)</code> </pre><br>  I did not inherit from ModelMultipleChoiceField, since it works with the queryset, and we need to work with the model. <br>  The constructor initializes the widget with the passed model, multiple and disabled flags, and specific attributes. <br>  The to_python method receives as value either a single id or several id on a single line separated by commas and processes it depending on the multiple flag.  In both cases, the presence of the selected id in the model is checked. <br>  The prepare_value method prepares initialization data for display: if a single model instance is passed in the initial field parameter, then it returns the id of this instance as a string;  if a list of instances or a QuerySet is passed, then returns a string with id separated by a comma. <br><br><h4>  Conclusion </h4><br>  The field is ready for use.  The application can be downloaded <a href="https://bitbucket.org/pokidovea/infinitechoicefield/">here</a> .  Using the field is very easy: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> forms <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> infinite_choice_field <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InfiniteChoiceField <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ChoiceModel <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestForm</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(forms.Form)</span></span></span><span class="hljs-class">:</span></span> choice = InfiniteChoiceField(ChoiceModel, multiple=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, disabled=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, required=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, initial=ChoiceModel.objects.filter(id__in=(<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>)))</code> </pre><br>  where ChoiceModel is an arbitrary view model <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChoiceModel</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> title = models.CharField(max_length=<span class="hljs-number"><span class="hljs-number">100</span></span>, verbose_name=<span class="hljs-string"><span class="hljs-string">"Choice title"</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> verbose_name = <span class="hljs-string"><span class="hljs-string">'ChoiceModel'</span></span> verbose_name_plural = <span class="hljs-string"><span class="hljs-string">'ChoiceModels'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__unicode__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.title</code> </pre><br>  It remains to not forget to connect the application in settings.py, <br><pre> <code class="python hljs">INSTALLED_APPS = ( <span class="hljs-string"><span class="hljs-string">'django.contrib.auth'</span></span>, <span class="hljs-string"><span class="hljs-string">'django.contrib.contenttypes'</span></span>, <span class="hljs-string"><span class="hljs-string">'django.contrib.sessions'</span></span>, <span class="hljs-string"><span class="hljs-string">'django.contrib.sites'</span></span>, <span class="hljs-string"><span class="hljs-string">'django.contrib.messages'</span></span>, <span class="hljs-string"><span class="hljs-string">'django.contrib.staticfiles'</span></span>, <span class="hljs-string"><span class="hljs-string">'infinite_choice_field'</span></span>, ... }</code> </pre><br>  import urls <br><pre> <code class="python hljs">urlpatterns = patterns(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-comment"><span class="hljs-comment"># Examples: # url(r'^$', 'habr_test.views.home', name='home'), url(r'^', include('core.urls')), url(r'^infinite_choice_data/', include('infinite_choice_field.urls')), # Uncomment the next line to enable the admin: url(r'^admin/', include(admin.site.urls)), )</span></span></code> </pre><br>  and display the static form of the TestForm in the template <br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Test InfiniteChoiceField<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> {{test_form.media}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">&gt;</span></span> {{test_form}} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/177929/">https://habr.com/ru/post/177929/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177907/index.html">There is an idea, but there is no knowledge: we create an application from idea to release, with zero knowledge of the code</a></li>
<li><a href="../177909/index.html">Practical application of a universal electronic card (UEC) in the city and the Internet. Part 3</a></li>
<li><a href="../177915/index.html">My Boot Camp - wherever I want, I put it there</a></li>
<li><a href="../177917/index.html">NASA has made it possible for everyone to follow the fate of Voyager 1</a></li>
<li><a href="../177921/index.html">Video interview from Silicon Valley. Max Skibinsky - serial entrepreneur, business angel and incubator mentor 500 Startups</a></li>
<li><a href="../177931/index.html">Stephen Wolfram Mathematical Analysis of Social Networks</a></li>
<li><a href="../177933/index.html">How I translated Leisure Suit Larry</a></li>
<li><a href="../177937/index.html">Ubuntu 13.04 Raring Ringtail Release</a></li>
<li><a href="../177939/index.html">VIZIO. Low cost laptop with Full HD IPS screen</a></li>
<li><a href="../177947/index.html">As we Cisco Phone with Asterisk SIP were friends</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>