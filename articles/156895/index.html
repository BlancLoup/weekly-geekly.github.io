<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The first experience in the study of malware under Microsoft Windows</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Many probably know this feeling of fear for their USB flash drive, plugging it into an ‚Äúalien‚Äù computer. Moreover, if it is impossible ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The first experience in the study of malware under Microsoft Windows</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Many probably know this feeling of fear for their USB flash drive, plugging it into an ‚Äúalien‚Äù computer.  Moreover, if it is impossible to see what is happening in the operating system of this computer because of the rights of the user, and indeed this computer is of ‚Äúpublic access‚Äù (the audience in an educational institution).  And even more lousy feeling when fears are justified: in addition to writing on a flash drive, the virus modifies the data on it in a certain way, and it is crooked. <br>  I ran into this too.  And having gotten a sample of the virus on a bogus flash drive, I decided to figure out what else he does and what is the essence of his work, and most importantly, how to expel this infection from computers and ‚Äúinfected‚Äù flash drives. <br>  The article will be useful to those who are interested in the field of software analysis, regardless of qualifications and skills (experts can write in the comments about their experience). <br><br><a name="habracut"></a><br><h4>  Analysis of visible actions collection of information </h4><br>  Even before copying the sample to a USB flash drive, I knew what was happening with such flash drives: <br><ul><li>  An executable file (.exe) is thrown into the RECYCLER folder (weight: <b>79160</b> bytes, MD5: <b>4fd40d4acdd4c0bb657c7db329035c6a</b> ); </li><li>  All folders are hidden.  It is impossible to return the old attributes through the folder properties; </li><li>  The autorun.inf file is copied to the root with a link in it to the file from RECYCLER </li><li>  Labels are created with folder icons and their names from the root.  Shortcuts indicate the same executable file. </li></ul><br>  It is not at all difficult to write a program that would restore folders and delete the malware, which was done fairly quickly: <br><ul><li>  A recursive directory traversal was performed using FindFirstFile / FindNextFile; </li><li>  If the current file was a folder, the attributes were reset to FILE_ATTRIBUTE_NORMAL; </li><li>  All exe-files were deleted from the RECYCLER folder. </li></ul><br>  Unfortunately, this method of struggle is inefficient and annoying, because  after each pair it was necessary to clean the flash drive again.  Therefore, I decided to see what happens on the virtual machine and, accordingly, write an antidote. <br><br><h4>  Examining a file on a VM </h4><br>  As a VM, Windows XP SP3 on Virtual Box was used.  By the way, the analysis itself on the VM indicates the absence of any AntiVM-functions.  To analyze the malware, I used quite standard software for this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  PEid </li><li>  Olly debugger </li><li>  Wireshark </li><li>  Resource Hacker </li><li>  AVZ </li><li>  Rootkit revealer </li><li>  Process Monitor </li><li>  Process explorer </li><li>  Autoruns </li></ul><br>  So, first of all I decided to see what the file is packed with.  PEiD showed: <br><br><img src="https://habrastorage.org/storage2/32a/1d5/c73/32a1d5c7396c7aaf283fedf04f8189a9.png" alt="image"><br><br>  It was naive of course to believe that the file was not packed with anything, and after opening the file in Resource Hacker, the guesses were confirmed: <br><br><img src="https://habrastorage.org/storage2/844/5fc/eb9/8445fceb9d7a9950459e007e180e37aa.png"><br><br>  Encrypted resources (possibly a key to decompress, data, or just junk).  In any case, the innocent file is no longer similar.  I am not strong in disassembling, so I didn‚Äôt particularly suspect in ollydbg: I made sure that there was no anti-debugging (at least during installation to the system, there are no readable lines except for the ‚Äú993‚Äù already caught my eye, and the file is still encrypted). <br><br>  The most common installation paths are: the file is copied to CSIDL_APPDATA under the static name <b>Kmlslc.exe</b> , the startup key is ‚ÄúKmlslc‚Äù in <b>HKEY_CURRENT_USER \ Software \ Microsoft \ Windows \ CurrentVersion \ Run</b> .  After that, the launched file is deleted (most likely it deletes the vmononos already installed on the system, and the path is passed through the command line argument). <br>  By network traffic, you can say that it is a bot.  The malware accesses wipmania.com to obtain an external IP address, after which it tries to access several sites by domain names, and bypassing the default firewall: <br><br><img src="https://habrastorage.org/storage2/86a/4f1/94d/86a4f194d2b0d085ab1ac560520b6267.png"><br><br>  By the way, when writing the corresponding domains to the hosts file, the bot does not attempt to opt out.  In addition, the functions HttpSendRequest, InternetWriteFile, URLDownloadToFile, send to analyze traffic and ban anti-virus updates, go to sites, for example, kaspersky.ru, virustotal.com, etc., are intercepted. <br><br>  After installing the autorun key in the system, the Autoruns simply did not see it, and there was no Kmlslc.exe in the process list.  Plus, the file was not visible on the disk.  After scanning the system using RootkitRevealer, it turned out that access to the registry and directories are intercepted, modifying the output of information.  Quite a common technique.  The following functions are intercepted for implementation: CopyFile, CreateFile, MoveFile, LdrLoadDll, NtEnumerateValueKey, NtQueryDirectoryFile, NtResumeThread, RegCreateKeyEx, RegCreateKeyEx, GetAddrInfo. <br><br><img src="https://habrastorage.org/storage2/3b5/772/124/3b57721240118de9f82e3f2ca79015a6.png"><br><br>  By banal filter settings in Procmon, it became clear that the malware had injected interceptor code into a trusted process (explorer.exe).  From the logs it is clear that the code periodically tries to check the existence of the file. <br><br><img src="https://habrastorage.org/storage2/84d/dd0/6dc/84ddd06dcd4ae59a7b9873f69bed282b.png"><br><br>  Guided by the principle ‚ÄúWhy not?‚Äù I tried to erase the file via DeleteFile.  To my surprise, the function ended successfully, and the embedded code, after accessing the file, began to throw out FILE_NOT_FOUND instead of SUCCESS.  It made me think that nothing was implemented in the embedded code, except for WinAPI interception.  Unfortunately, I do not know how to program hooks yet, but I know that AVZ does an excellent job with this.  After restarting the PC, the OS can be considered clean of this malware. <br><br><h4>  Conclusion </h4><br>  What conclusions can be drawn from the above?  Despite the interception of the API, checking domain names before withdrawing and other techniques, the malware still has a number of shortcomings, against the background of which the advantages make little sense: <br><ul><li>  Static names when installed in the system; </li><li>  Lack of protection against deletion. </li></ul><br>  Analyzing the pros and cons, we can assume that at least two people were involved in development: one crypto (or the third was doing it) and implemented WinAPI interception, the second wrote copying a file to a USB flash drive installation in the system and communicating with the admin panel (or gate). <br>  After researching malicious activity, an antidote was written.  <a href="http://www.sendspace.com/file/j3l4ry">Sources</a> </div><p>Source: <a href="https://habr.com/ru/post/156895/">https://habr.com/ru/post/156895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../156879/index.html">Internationalization of the local django project</a></li>
<li><a href="../156887/index.html">QEMU on FreeBSD-9.0-RELEASE-amd64</a></li>
<li><a href="../156889/index.html">Installing LivestreetCMS on MODX Revolution from the package in 10 clicks</a></li>
<li><a href="../156891/index.html">About the arbitration court, EDS and international jurisdiction</a></li>
<li><a href="../156893/index.html">German copyright holders worried about analog hole</a></li>
<li><a href="../156901/index.html">Russian AI Cup 2012</a></li>
<li><a href="../156903/index.html">Vector graphics on scattered curves</a></li>
<li><a href="../156905/index.html">New Brief: Samsung and Google launch Nexus 10 for sale</a></li>
<li><a href="../156907/index.html">Nokia Drive 3.0 and My Routes service</a></li>
<li><a href="../156909/index.html">Electronic fingerprinting using Internet browser</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>