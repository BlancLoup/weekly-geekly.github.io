<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Air Native Extensions (ANE) Development for OS X</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all habouiers. I would like to share the experience of creating native extensions for OS X. 

 AIR is simply amazing in its cross-platform en...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Air Native Extensions (ANE) Development for OS X</h1><div class="post__text post__text-html js-mediator-article">  Hello to all habouiers.  I would like to share the experience of creating native extensions for OS X. <br><br>  AIR is simply amazing in its cross-platform environment.  While it does not come to the use of some unique chips for the platform.  I faced this problem when I was given the task of turning a browser flash-game into a desktop for OS X. I did all this using the AIR environment in a few hours and I will not describe this process, since in Google for this The topic is full of information.  The most interesting thing began when it became necessary to connect various Apple services to the game, such as GameCenter, In-App-Purchase, etc.  And here I am faced with difficulties.  The fact is that there are a lot of ready-made ANEs, including free ones.  But the trouble is that all these solutions work only for iOS.  For OS X, there is neither the fact that ready-made libraries, but even information on the creation of these libraries had to be collected bit by bit from a couple of Internet resources of many years ago, constantly bumping into some kind of pitfalls or even icebergs. <br><br>  Now I want to collect all the accumulated knowledge and experience in one place and share with you in order to at least a little reduce the pain that you have to go through, if you decide to create native libraries for poppy too.  Although after the four developed extensions for OS X, they do not seem to be so complicated and tricky. <br><a name="habracut"></a><br>  So.  For work, I used: <br>  AIR 16; <br>  Flex 4.6.0; <br>  Adobe Flash Builder 4.6 or IntelliJ IDEA 14 (Flash Builder was used to write the library, although the same can be done in IntelliJ IDEA. But I developed the project in IntelliJ IDEA. There‚Äôs a matter of taste, I suppose); <br>  Xcode 6.1.1; <br>  OS X Yosemite (10.10.1); 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I will divide the whole process of creating ANE into 3 parts. <br><br><h4>  Part one.  Objective c </h4><br>  I think it is more logical to start creating native extensions with writing the native code itself, although in any case, you will most likely have to return to changing the native code more than once. <br><br>  We start by creating a new project in Xcode.  File -&gt; New -&gt; Project ... (Cmd + Shift + N).  Next, select OX X -&gt; Framework &amp; Library -&gt; Cocoa Framwork. <br><br><img src="https://habrastorage.org/files/2b1/ad5/388/2b1ad5388e0040ae9800074ef74cec04.png"><br><br>  We invent a name for our framework.  The name can be any, further, it will not be used in any way in our future native library. <br><br><img src="https://habrastorage.org/files/4dc/8f6/8fb/4dc8f68fb88e4a2d82c195774488c346.png"><br><br>  After that we have an empty project with one header file. <br><br><img src="https://habrastorage.org/files/123/387/303/123387303c374d0ebd11a89f7c3ce603.png"><br><br>  If the native library is planned for the implementation of simple single functions that somehow must be performed in Objective-C, then we can do without the header file using only the implementation file (* .m).  But I will describe the work with a full-fledged class. <br><br>  Before writing code, you need to add the Adobe AIR.framework library to your project.  Click the right button on the project, and select Add files to "...".  I hope you already have a fresh version of the AIR environment, because it is in it that the library that we need is stored.  You can find it here: ../AIR_FOLDER/runtimes/air/mac/Adobe AIR.framework. <br><br>  After this, the project will look something like this: <br><br><img src="https://habrastorage.org/files/ac9/041/49a/ac904149a3384cb49fb7b48a8e29c6e2.png"><br><br>  You also need to install a 32-bit target platform (i386) for the project (not for the target).  At the time of this writing, Adobe AIR.framework worked only for 32-bit platforms.  In the same project settings in Build Settings, we search for automatic reference, and set Objective-C Automatic Reference Counting to No. <br><br><img src="https://habrastorage.org/files/da1/1e6/099/da11e609940a4b8a814697f707ba7ec7.png"><img src="https://habrastorage.org/files/b28/307/4e5/b283074e5d93472ab44cf4587921dbb4.png"><br><br>  I am also changing the paths of the output files so that they are in the same place as the source.  Who is more convenient. <br><br><img src="https://habrastorage.org/files/120/cc1/2b3/120cc12b30de4847b4a944f3f08eb900.png"><br><br>  First of all, we need to define initializers of the context and the library itself (optionally, finalizers can also be defined). <br><br>  First, we define the context initializer.  It will be called, oddly enough, when the context is initialized in the as3 part, but more on that later.  It is very important, when using several native libraries in a project, to call initializers with unique names.  The context initializer also defines the functions that will be available from the as3 code. <br><br>  So.  We declare the context initializer as follows: <br><br><pre><code class="objectivec hljs">FREContext AirCtx = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   void MyAwesomeNativeExtensionContextInitializer(void* extData, const uint8_t* ctxType, FREContext ctx, uint32_t* numFunctionsToTest, const FRENamedFunction** functionsToSet) { NSLog(@"[MyANE.Obj-C] Entering ContextInitinalizer()"); *numFunctionsToTest = 1; // ,     as3 .        .    -  . FRENamedFunction* func = (FRENamedFunction*) malloc(sizeof(FRENamedFunction) * *numFunctionsToTest); func[0].name = (const uint8_t*) "initLibrary"; //  ,         as3. func[0].functionData = NULL; //  NULL.        NULL. func[0].function = &amp;init; //   FREObject()  ojbective-c  //   // func[n].name = (const uint8_t*) "name"; // func[n].functionData = data; // func[n].function = &amp;function; *functionsToSet = func; AirCtx = ctx; NSLog(@"[MyANE.Obj-C] Exiting ContextInitinalizer()"); }</span></span></code> </pre> <br>  It should be noted that the NSLog function, which displays a message in the console, will also output a message in the form of a trace in the IDE console, in which you are developing the main project. <br><br>  Now we define the initializer of the library itself.  In it we will indicate a link to the contextizer and context finalizer.  We will use it later when building the library: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MyAwesomeNativeExtensionInitializer(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>** extDataToSet, FREContextInitializer* ctxInitializerToSet, FREContextFinalizer* ctxFinalizerToSet ) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"[MyANE.Obj-C] Entering ExtInitializer()"</span></span>); *extDataToSet = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; *ctxInitializerToSet = &amp;MyAwesomeNativeExtensionContextInitializer; <span class="hljs-comment"><span class="hljs-comment">//   *ctxFinalizerToSet = &amp;MyAwesomeNativeExtensionContextFinalizer; //  () NSLog(@"[MyANE.Obj-C] Exiting ExtInitializer()"); }</span></span></code> </pre><br>  Next, we describe our only function available from the action script code.  Inside this function, we can call various native Objective-C methods, including using the iOS SDK: <br><br><pre> <code class="objectivec hljs">FREObject (init) (FREContext context, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* functionData, uint32_t argc, FREObject argv[]){ <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"[MyANE.Obj-C] Hello World!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }</code> </pre><br>  For convenience, you can use the directive: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define DEFINE_ANE_FUNCTION(fn) FREObject (fn)(FREContext context, void* functionData, uint32_t argc, FREObject argv[])</span></span></code> </pre><br>  Using the directive described above, the function can be defined much simpler and shorter: <br><br><pre> <code class="objectivec hljs">DEFINE_ANE_FUNCTION(init){ <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"[MyANE.Obj-C] Hello World!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; }</code> </pre><br>  Making the build (Command + B).  As a result, in the path that we indicated at the very beginning, a framework would appear, with a name identical to the name that we indicated, again at the beginning. <br><br>  The simplest Objective-C library is ready.  The only thing she can do is output a string in the trace.  But to demonstrate the work will come down.  Now we need to create the second half of our ANE - AS3 library. <br><br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">MyANE.h</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Adobe AIR/Adobe AIR.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> //! Project version number for MyANE. FOUNDATION_EXPORT double MyANEVersionNumber; //! Project version string for MyANE. FOUNDATION_EXPORT const unsigned char MyANEVersionString[]; @interface MyANE : NSObject @end</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">MyANE.m</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MyANE.h"</span></span></span><span class="hljs-meta"> #define DEFINE_ANE_FUNCTION(fn) FREObject (fn)(FREContext context, void* functionData, uint32_t argc, FREObject argv[]) @implementation MyANE @end FREContext AirCtx = nil; DEFINE_ANE_FUNCTION(init){ NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[MyANE.Obj-C] Hello World!"</span></span></span><span class="hljs-meta">); return nil; } void MyAwesomeNativeExtensionContextInitializer(void* extData, const uint8_t* ctxType, FREContext ctx, uint32_t* numFunctionsToTest, const FRENamedFunction** functionsToSet) { NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[MyANE.Obj-C] Entering ContextInitinalizer()"</span></span></span><span class="hljs-meta">); *numFunctionsToTest = 1; FRENamedFunction* func = (FRENamedFunction*) malloc(sizeof(FRENamedFunction) * *numFunctionsToTest); func[0].name = (const uint8_t*) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"initLibrary"</span></span></span><span class="hljs-meta">; func[0].functionData = NULL; func[0].function = &amp;init; *functionsToSet = func; AirCtx = ctx; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[MyANE.Obj-C] Exiting ContextInitinalizer()"</span></span></span><span class="hljs-meta">); } void MyAwesomeNativeExtensionContextFinalizer(FREContext ctx) { } void MyAwesomeNativeExtensionInitializer(void** extDataToSet, FREContextInitializer* ctxInitializerToSet, FREContextFinalizer* ctxFinalizerToSet ) { NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[MyANE.Obj-C] Entering ExtInitializer()"</span></span></span><span class="hljs-meta">); *extDataToSet = NULL; *ctxInitializerToSet = &amp;MyAwesomeNativeExtensionContextInitializer; *ctxFinalizerToSet = &amp;MyAwesomeNativeExtensionContextFinalizer; NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"[MyANE.Obj-C] Exiting ExtInitializer()"</span></span></span><span class="hljs-meta">); } void MyAwesomeNativeExtensionFinalizer(void* extData) { }</span></span></code> </pre><br></div></div><br></div></div><br><br><h4>  Part two.  Action script </h4><br>  To create a library on Action Script, you can use any IDE with the ability to develop in ActionScript.  But I used the IDE standard for such purposes - Flash Builder. <br><br>  Creating a library is very simple: File -&gt; New -&gt; Flex Library Project. <br><br>  We call our library, and we will definitely connect the Adobe AIR libraries.  In essence, we do this for a single class that will allow us to work with the context. <br><br><img src="https://habrastorage.org/files/65e/887/4ae/65e8874ae8544b668717dba6f15b6723.png"><br><br>  Immediately create a new ActionScript class (it is possible, and even more convenient to create it in the package by default), inheriting it from flash.events.EventDispatcher (in general, you can inherit from anything, but you can not inherit at all, but the EventDispatcher class will allow an instance of dispatch events, which is very useful when working with the iOS SDK, where some of the requested data (GC friends list, IAP list available) does not come immediately).  This will be our main class, which we will use when working with the library. <br><br>  In the beginning, we need to get an ex-instance of the context.  This is done as follows: <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> extCtx:ExtensionContext = ExtensionContext.createExtensionContext(<span class="hljs-string"><span class="hljs-string">"my.awesome.native.extension"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre><br>  The static createExtensionContext method creates an ExtensionContext instance.  Here we must pass the id of our extension, in this case ‚Äúmy.awesome.native.extension‚Äù, as well as the context type.  The type must be specified only in the case of several library implementations.  If a single implementation is planned, then null can be passed as a type. <br><br>  Only one (singleton) instance of the context of the same specific type can be used in the project at a time.  Personally for me, after a heap of native extensions created, there was no need for a multiple implementation of this extension itself.  So in this case, having a single implementation, we will have, in principle, one instance for the whole ANE.  Therefore, the constructor must be called once, and in the future just to get the already created object. <br><br>  The easiest way to do this is to refer to a certain static function that will return an instance of the object, or create a new one through the constructor, if there is none. <br><br>  To begin with we will describe the designer (which we will never call from the project): <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _instance:MyANE; <span class="hljs-comment"><span class="hljs-comment">//    private var extCtx:ExtensionContext; //  public function MyANE(target:IEventDispatcher=null) { if (!_instance) { if (this.isSupported) { extCtx = ExtensionContext.createExtensionContext("my.awesome.native.extension", null); //   if (extCtx != null) { trace('[MyANE.AS3] extCtx is okay'); } else { trace('[MyANE.AS3] extCtx is null.'); } } _instance = this; } else { throw Error('[MyANE.AS3] This is a singleton, use getInstance, do not call the constructor directly'); //  ,     } }</span></span></code> </pre><br>  You also need to check that ANE is trying to run on a Mac. <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isSupported</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:Boolean </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Capabilities.manufacturer.indexOf(<span class="hljs-string"><span class="hljs-string">'Macintosh'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>; }</code> </pre><br>  Now we will describe the function to which we will access each time we need to get an instance of our library. <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:MyANE </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _instance != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? _instance : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyANE(); }</code> </pre><br>  At this stage, we have completed initialization.  You can now use methods from Objective-C.  You can call a function from the native code using the class method of the call context instance (), which as an argument must pass one of the function names specified in the context initializer in the native code, as well as the function parameters.  In this example, we have described only one function with the name "initLibrary".  It does not accept any parameters, well, we will not pass anything. <br><br><pre> <code class="actionscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:void </span></span>{ extCtx.call(<span class="hljs-string"><span class="hljs-string">"initLibrary"</span></span>); }</code> </pre><br>  Save the project.  The library is automatically compiled, and by default, placed in the bin directory, in the root of the project. <br>  Thus, we have provided the most basic functionality.  Now you can go to the last part. <br><br><div class="spoiler">  <b class="spoiler_title">Source</b> <div class="spoiler_text"><pre> <code class="actionscript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">package</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> flash.events.EventDispatcher;</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> flash.events.IEventDispatcher;</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> flash.external.ExtensionContext;</span></span> <span class="hljs-meta"><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span></span></span><span class="hljs-meta"> flash.system.Capabilities;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyANE</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventDispatcher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _instance:MyANE; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> extCtx:ExtensionContext; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyANE</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(target:IEventDispatcher=null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_instance) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isSupported) { extCtx = ExtensionContext.createExtensionContext(<span class="hljs-string"><span class="hljs-string">"my.awesome.native.extension"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (extCtx != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { trace(<span class="hljs-string"><span class="hljs-string">'[MyANE.AS3] extCtx is okay'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { trace(<span class="hljs-string"><span class="hljs-string">'[MyANE.AS3] extCtx is null.'</span></span>); } } _instance = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Error(<span class="hljs-string"><span class="hljs-string">'[MyANE.AS3] This is a singleton, use getInstance, do not call the constructor directly'</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isSupported</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:Boolean </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Capabilities.manufacturer.indexOf(<span class="hljs-string"><span class="hljs-string">'Macintosh'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:MyANE </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _instance != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? _instance : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyANE(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:void </span></span>{ extCtx.call(<span class="hljs-string"><span class="hljs-string">"initLibrary"</span></span>); } }</code> </pre><br></div></div><br><br><h4>  Part Three  Build a library </h4><br>  Finally, we have 2 pieces of the native library.  All you need is to combine them into a full ANE. <br><br>  First we need a descriptor in which we describe our extension.  It will be the following * .xml file: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://ns.adobe.com/air/extension/3.9"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>my.awesome.native.extension<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">versionNumber</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">versionNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platforms</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MacOS-x86"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">applicationDeployment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nativeLibrary</span></span></span><span class="hljs-tag">&gt;</span></span>MyANE.framework<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nativeLibrary</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">initializer</span></span></span><span class="hljs-tag">&gt;</span></span>MyAwesomeNativeExtensionInitializer<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">initializer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">finalizer</span></span></span><span class="hljs-tag">&gt;</span></span>MyAwesomeNativeExtensionFinalizer<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">finalizer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">applicationDeployment</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"default"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">applicationDeployment</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platform</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">platforms</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extension</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Here: <br>  id is the id of the sub-area, which must match the id that we specified when creating the context instance in the as3 part. <br>  nativeLibrary - compiled framework from Objective-C <br>  initializer, finalizer - the initializer and finalizer of the library (not the context), which was also described in the Ojbective-C part. <br><br>  It is also recommended to do an implementation for the default platform in which the native code is missing.  Well, follow the recommendations, it is not difficult. <br><br>  The last piece of our library is ready, and now we can proceed to the assembly.  And here begins the most interesting. <br><br>  For convenience, I would advise you to make a separate folder for the assembly, otherwise it will be just confusion and porridge, which is already enough here.  I use the following folder structure: <br><br><img src="https://habrastorage.org/files/bb0/c45/25d/bb0c4525df4f41c4b0d667e47435be96.png"><br>  where <br><ul><li>  _out is the build folder itself. <br><ul><li>  default - implementation for the default platform <br><ul><li>  library.sfw - swf obtained by unarchiving the collected as3 part </li></ul></li><li>  mac - implementation for the mac platform <br><ul><li>  library.sfw - swf obtained by unarchiving the collected as3 part </li><li>  MyANE.framework - assembled Objective-C part </li></ul></li><li>  extension.xml - an extension handle </li><li>  MakeANE.sh - just a script to quickly build the library </li></ul></li><li>  ActionScript3 and Objective-C are project library parts folders. </li></ul><br>  Separately by library.sfw.  Yes, this is a piece of a library piece, which should be separate, but at the same time, the as3 piece assembled is also necessary for us.  To get it, you need to unzip the collected as3 library as a normal zip-archive (saving this same as3 library). <br><br>  Now all we need is to build the extension using the AIR Developer Tool (ADT).  You can find it here: ../AIR_FOLDER/bin/adt <br><br>  To build, I use the following script (from the _out folder): <br>  AIR_FOLDER / bin / adt -package -target ane MyANE.ane extension.xml -swc ../ActionSript3/bin/MyANE.swc -platform MacOS-x86 -C mac.  -platform default -C default. <br><br>  Now we have a ready MyANE.ane file, which is the compiled native library.  But even this is not the end.  This fun begins when we try to use the native library in an OS X project.  Again, there are a lot of tutorials and various FAQs for iOS, but as it turned out, OS X needs to perform other rituals with a tambourine, and not only. <br><br><h4>  Part last.  Integration of the native library into the project </h4><br>  So, we have a hand-written library.  Here it is, ready * .ane file.  Take it and use it.  But no.  In order to use the native library in OS X during development, it is not needed.  But of course, our efforts were not in vain.  We just need to do the following (I will describe the process for IntelliJ IDEA, but for Flash Builder the process is similar, in some cases even easier): <br><br><ol><li>  Unzip the * .ane file as a normal zip archive into a folder that has the name exactly as the id of our extension + .ane at the end.  In our case, it will be "my.awesome.native.extension.ane".  This folder is better to copy to the new directory inside the project.  For example, I have this libs-ane, which already contains unzipped extensions. </li><li>  In IntelliJ IDEA, in the project settings, we DO NOT add this directory depending. </li><li>  In another directory inside the project, add the collected as3 library.  I have this directory called libs-swc. </li><li>  This directory is already added to the project dependencies.  The type of connection is Merged. </li><li>  In the ADL startup parameters, you must add the following option -extdir / ABSOLUTE_PATH_TO_PROJECT / libs-ane.  In IntelliJ IDEA, these parameters are found in Run-&gt; Edit Configurations-&gt; AIR Debug Launcher Options. <br><img src="https://habrastorage.org/files/82c/c8f/e2a/82cc8fe2a0ab4505b239ae0582674ed0.png"></li><li>  In the project descriptor, add the id of the native extension in the extensions block <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensionID</span></span></span><span class="hljs-tag">&gt;</span></span>my.awesome.native.extension<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensionID</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></li></ol><br>  Now we can use native extensions when debugging.  But there is something else.  As you probably know, in the iOS SDK there are a number of classes that will work correctly only when they are launched from the Finder.  To do this, using the same IntelliJ IDEA, you can build a native bundle and use it.  But the problem is that the previous method of integrating the native extension will not allow us to assemble the bundle.  But the assembly can still be useful to us, so we need to work a little more.  Remember our * .ane?  So now it is his time. <br><br><ol><li>  All * .ane needs to be added to the next separate directory, again inside the project.  I have this folder called anes. <br>  In IntelliJ IDEA, in the project settings we also add this directory depending.  The type of connection will become ANE and cannot be changed (that is why it is impossible to simultaneously assemble a bundle and work in debug mode).  In the future, for debugging, we remove this directory from the dependencies, and to add a bundle, we add it. </li><li>  But in any case, we need anes to be an external library.  To do this, I use an additional build-config.xml file, in which I describe additional build parameters.  In this build-config.xml, you must specify the anes directory as the path of the external library.  The simplest option might look like this: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">flex-config</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target-player</span></span></span><span class="hljs-tag">&gt;</span></span>16.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target-player</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">swf-version</span></span></span><span class="hljs-tag">&gt;</span></span>23<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">swf-version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">compiler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">external-library-path</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path-element</span></span></span><span class="hljs-tag">&gt;</span></span>${flexlib}/libs/player/{targetPlayerMajorVersion}.{targetPlayerMinorVersion}/playerglobal.swc<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path-element</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path-element</span></span></span><span class="hljs-tag">&gt;</span></span>anes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path-element</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">external-library-path</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">as3</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">as3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">library-path</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path-element</span></span></span><span class="hljs-tag">&gt;</span></span>libs-swc<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path-element</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">library-path</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">compiler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">flex-config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  To use an additional build-config file, you need to add it in the project settings.  Project Structure -&gt; Additional compiler configuration file. <br><br><img src="https://habrastorage.org/files/837/b7b/e77/837b7be774ed45fbae76f8447169a2ff.png"><br><br>  Well, or even easier all the same in the Additional compiler options, you can add a parameter: "-external-library-path path-element anes" <br><br><img src="https://habrastorage.org/files/d76/881/2d1/d768812d18eb43a2ae3e4e31dffb1893.png"></li></ol><br><br>  Now you can build a native bundle.  This is done simply Build-&gt; Package AIR Application.  I use * .app as my goal. <br><br><img src="https://habrastorage.org/files/3e9/39c/eca/3e939cecab114a8f81d69f567f8594a3.png"><br><br>  Well, at the output we get a ready-made, native bundle, with a working project that ANE will use. <br><br>  That's all.  Thank you for your attention, I hope this article will be useful for someone.  This is my first article on Habr√©, so I would really like to hear constructive criticism and advice on how to improve the article.  Also I will definitely answer questions in the comments, and, if possible, supplement the article. <br><br>  If there is interest in this topic, I would also like to tell about the exchange of various data between as3 and native code, about events and much more (although this is already more general concepts for which to find information is a little easier). </div><p>Source: <a href="https://habr.com/ru/post/252217/">https://habr.com/ru/post/252217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252201/index.html">Monitoring for the poor or SAR + MySQL + Gnuplot</a></li>
<li><a href="../252209/index.html">Simple do-it-yourself cooling pad for laptop</a></li>
<li><a href="../252211/index.html">Galvanization of a corpse: how was it possible to revive a beaten HDD to store anything unnecessary</a></li>
<li><a href="../252213/index.html">The Seventh Annual Microsoft Research Summer School in Machine Learning and Intelligence - Cooperation with ACM Europe</a></li>
<li><a href="../252215/index.html">Full C ++ website and some couch analytics</a></li>
<li><a href="../252219/index.html">Browsers from Russian IT companies: an unbiased review attempt</a></li>
<li><a href="../252221/index.html">Cloudmouse closes</a></li>
<li><a href="../252223/index.html">Complete energy autonomy or how to survive with solar panels in the outback (part 2.5. Practical)</a></li>
<li><a href="../252227/index.html">Site security audit - identifying risks and threats</a></li>
<li><a href="../252229/index.html">Vladimir Ivanov, Oracle - Deep immersion in invokedynamic</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>