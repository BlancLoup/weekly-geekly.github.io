<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home ‚Äúcloud‚Äù server at 10 watts? Completely!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to users of Habr. 

 Today I want to tell you about a home web server that simultaneously perfectly performs the functions of a home media cente...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home ‚Äúcloud‚Äù server at 10 watts? Completely!</h1><div class="post__text post__text-html js-mediator-article">  Hello to users of Habr. <br><br>  Today I want to tell you about a home web server that simultaneously perfectly performs the functions of a home media center (mp3, ip-tv, video, uPnP, etc.). <br><br>  It all started with the fact that for some time I used the HP MicroServer N36L server with RAID5 for 4 terabytes (3x2GB HDD WD Green + 8 Gb ECC RAM) for internal needs, with virtual machines on the vBox in Oracle, which is not bad in principle, but its the constant buzzing worried family members in the sense of knowingly eating kilowatts per year (if you are interested, I will tell about it in one of the following posts). <br>  In addition, I wanted something more modern, with the possibility of using it as a full-fledged media center with a direct connection to the TV. <br><a name="habracut"></a><br>  After a long search and comparison, I chose the currently relevant device on the RK3188 chipset: K-R42, 4-core CPU, 2GB of RAM and 4GB of flash memory (although 8GB was proudly indicated on the box) graphically by the Mali400 kernel on android 4.2.2. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Of course, everything described below is also suitable for other similar devices that are connected via HDMI to the TV, but for me a significant advantage in choosing was the availability of a full-fledged housing for normal heat exchange, an optical SPDIF connector for sound and a modern chipset. <br><br>  The cost of K-R42 ranges around $ 90-120 (geekbuying.com, aliexpress.com with shipping), which is more expensive than 2 core sticks / boxes, but comparable to many others on the same RK3188 chipset. <br><br>  It should be noted that as a media center, it works with a bang: the current XBMC 12.2 Frodo is currently installed and started without any problems, the control from the console is quite smooth and there are no special problems with this.  Thanks to the external antenna, the wireless connection is very stable, it heats up in the process of work not so much, but it is noticeably warm under load. <br><br><h4>  1. We put Linux. </h4><br>  What - I didn‚Äôt have much difference, but for simplicity I chose Debian wheezy. <br><br>  Unfortunately, there are no working drivers for the Mali400 in order to get a full-fledged 3D graphics acceleration, so there are no options yet - you need to use the chroot environment instead of reflashing the device completely to Linux (the corresponding manuals are already on the network). <br>  Fortunately for this, under the android there is a wonderful app: Linux Deploy, giving a choice of any of the existing mainstream distributions. <br><br>  I will not describe in detail, the installation is rather trivial: just run the application, select the desired configuration and press start. <br>  After inserting an 8GB microSD card in the media box, I chose to install the SD card section without a graphical environment (there is of course an option for those who want to get a graphic desktop via VNC), Debian was installed, with SSH autoload and sudo- <b>android</b> user with a password <b>changeme</b> . <br><br>  Go through SSH for further configuration: <br><br> <code>ssh android@&lt;ip-of-the-box&gt;</code> <br> <br><hr><br><br><h4>  2. Users and other ... </h4><br>  The android user password is naturally worth changing from <b>changeme</b> to something more recent: <br><br> <code>passwd</code> <br> <br>  and also for root, disable the ability to login over SSH in / etc / ssh / sshd_config: <br><br> <code>sudo nano /etc/ssh/sshd_config</code> <br> <pre> <code class="bash hljs">PermitRootLogin yes ‚Üí PermitRootLogin no</code> </pre><br><br>  if you need to create your full user, then <br><br> <code>sudo adduser username</code> <br> <br>  and do not forget to add it to the groups in which the user ‚Äúandroid‚Äù is present: <br><br> <code>sudo adduser username aid_system aid_radio aid_bluetooth aid_graphics aid_input aid_audio aid_camera aid_log aid_compass aid_mount aid_wifi aid_adb aid_install aid_media aid_dhcp aid_sdcard_rw aid_vpn aid_keystore aid_usb aid_drm aid_available aid_gps aid_media_rw aid_mtp aid_drmrpc aid_nfc aid_sdcard_r aid_shell aid_cache aid_diag aid_net_bt_admin aid_net_bt aid_inet aid_net_raw aid_net_admin aid_net_bw_stats aid_net_bw_acct</code> <br> <br>  Otherwise, your new user may not have access to some devices / Internet, etc. <br>  Necessary groups can always be viewed by <br><br> <code>groups android</code> <br> <br>  Now let's update the newly installed system: <br><pre> <code class="bash hljs">sudo apt-get update sudo apt-get dist-upgrade</code> </pre><br><br>  install the task manager: <br><br> <code>sudo apt-get install cron</code> <br> <br>  To provide access to our server from the outside, we register on some DynDNS site (dyn.com, noip.com, etc.), and install the client to update our dynamic IP address (I used ddclient): <br><br> <code>sudo apt-get install ddclient</code> <br> <br>  Here is an example ddclient configuration: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># Configuration file for ddclient generated by debconf # # /etc/ddclient.conf protocol=dyndns2 use=web, web=checkip.dyndns.com/, web-skip='IP Address' server=www.dyndns.com login=myserveruser password='mydyndnspassword' myserver.dyndns.org</span></span></code> </pre><br><br>  On the router, you must allow Port Forwarding from the Internet for ports 22 (SSH), 80 (HTTP), 443 (HTTPS) on the IP of our ‚Äúmicro‚Äù server. <br><br><hr><br><br><h4>  3. We put LAMP </h4><br>  Here everything is rather trivial: <br><pre> <code class="bash hljs">sudo apt-get update sudo apt-get install apache2 mysql-server php5 php5-curl php5-gd php5-mysql php-apc</code> </pre><br><br>  For the convenience of further settings, we set the graphic panel (webmin) <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp wget http://prdownloads.sourceforge.net/webadmin/webmin_1.660_all.deb sudo dpkg -i webmin_1.660_all.deb sudo apt-get -f install sudo service webmin start</code> </pre><br>  <i>(In order to save webmin resources, I manually launch all the time only when needed)</i> <br><br>  Now you can go to <i>https: // &lt;ip-of-the-box&gt;: 10,000</i> with android user and customize everything your heart desires. <br><br>  If this is not done yet, restart the web server to activate all the modules we have installed: <br><br> <code>sudo service apache2 restart</code> <br> <br><hr><br><br><h4>  4. Autoload </h4><br>  In order for our daemon services to automatically load in the chroot environment when our box starts, the script /etc/init.d/myscrypt is provided in Linux Deploy <br><br>  My looks like this: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh case "$1" in start) /bin/mount -a /etc/init.d/mysql start /etc/init.d/apache2 start /etc/init.d/ddclient start /etc/init.d/cron start ;; stop) /etc/init.d/apache2 stop /etc/init.d/mysql stop /etc/init.d/ddclient stop /etc/init.d/cron stop /bin/umount /mnt/usb ;; *) echo "Usage: $0 {start|stop}" ;; esac</span></span></code> </pre><br><br>  When the media player is ‚Äúturned off‚Äù from the console, the device instead of completely shutting down goes into standby mode (many people in the network consider this feature a disadvantage, but in our case is an undeniable advantage!), While all the running services continue to work.  The processor load is about 5%, and only one core out of 4! <br><br><hr><br><br><h4>  5. Install ownCloud </h4><br>  The fifth stable version of this cloud service can already be quite comfortable to use.  The owncloud installation is described in great detail on the official page ( <a href="http://doc.owncloud.org/server/5.0/admin_manual/">http://doc.owncloud.org/server/5.0/admin_manual/</a> ), here I will give the main steps regarding our installation: <br><br><ul><li>  We create a database, for example through a webmin panel, and a user for this database with full rights to it. </li><li>  Installing owncloud.  At the moment there is a repository, which greatly simplifies the process: </li></ul><br><pre> <code class="bash hljs">sudo <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'deb http://download.opensuse.org/repositories/isv:ownCloud:community/Debian_7.0/ /'</span></span> &gt;&gt; /etc/apt/sources.list.d/owncloud.list sudo apt-get update sudo apt-get install owncloud</code> </pre><br><br>  Now we go in the browser on <br><br>  http: // &lt;ip-of-the-box&gt; / owncloud / <br><br>  and finish customizing your owncloud: enter MySQL database data. <br><br>  In case the installer complains about the inability to use .htaccess, <br>  change the / etc / apache2 / sites-enabled / 000-default AllowOverride file to All: <br><br> <code>sudo nano /etc/apache2/sites-enabled/000-default</code> <br> <pre> <code class="bash hljs"> &lt;Directory /var/www/&gt; ‚Ä¶ AllowOverride None ‚Üí AllowOverride All ‚Ä¶ &lt;/Directory&gt;</code> </pre><br>  as well as in the / etc / apache2 / sites-enabled / default-ssl file, if you intend to use owncloud with SSL: <br><br> <code>sudo nano /etc/apache2/sites-enabled/default-ssl</code> <br> <pre> <code class="bash hljs">&lt;Directory /var/www/&gt; ‚Ä¶ AllowOverride None ‚Üí AllowOverride All ‚Ä¶ &lt;/Directory&gt;</code> </pre><br><br>  and restart the webserver: <br><br> <code>sudo service apache2 restart</code> <br> <br>  Further customization of owncloud usually causes no problems and is described in detail in the administrator‚Äôs manual. <br><br><h5>  5.1 If there is not enough space </h5><br>  The size of the ‚Äúcloud‚Äù storage with the described installation is limited by the free space on the SD card.  A convenient way to increase the amount of available space is to transfer your owncloud / data folder to an external USB-HDD. <br><br>  To do this, format any external USB drive (for example, its first partition) as ext4, and specify its mount point in / etc / fstab: <br><pre> <code class="bash hljs">sudo mkdir /mnt/usb_hdd sudo chmod a+rwx /mnt/usb_hdd sudo nano /etc/fstab</code> </pre><br><pre> <code class="bash hljs">‚Ä¶ /dev/block/sda1 /mnt/usb_hdd ext4 noatime,acl,user_xattr 1 1 ‚Ä¶</code> </pre><br><br>  Mount disk <br><br> <code>mount /mnt/usb_hdd</code> <br> <br>  and transfer owncloud / data to it: <br><pre> <code class="bash hljs">sudo mv /var/www/owncloud/data /mnt/usb_hdd/ sudo ln -s /mnt/usb_hdd/data /var/www/owncloud/data</code> </pre><br><br>  Now our storage capacity is limited only by free space on an external USB drive. <br><br><hr><br><br><h4>  6. Backup by plan </h4><br>  Easily and quickly, with the help of duplicity, a regular backup is organized on an external server, if desired, also with encryption. <br>  If the main file server is located on the same network as me and supports wake-on-lan, then this process can be fully automated (including the start of the file server). <br><br> <code>sudo apt-get install wakeonlan duplicity</code> <br> <br>  We will create a folder for backups (for example / media / backup / owncloud) on the file server 192.168.0.2 with the MAC address 33: d0: ab: dd: 11: c1, <br>  for which the local user user1 has write access. <br><br>  Setting up passwordless access for the root user via SSH to the file server: <br><pre> <code class="bash hljs">sudo su ssh-keygen -t rsa (  ,   ) ssh-copy-id -i .ssh/id_rsa.pub user1@192.168.0.2 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br><br>  now we make tasks for the task manager in the crontab: <br><br> <code>sudo crontab -e</code> <br> <pre> <code class="bash hljs">49 23 * * * /usr/bin/wakeonlan 33:d0:ab:dd:11:c1 0 0 * * sun /usr/bin/duplicity full --no-encryption --volsize 100 --exclude /tmp --exclude /proc --exclude /sys / rsync://user1@192.168.0.2//media/backup/owncloud 0 0 * * 1-6 /usr/bin/duplicity --no-encryption --volsize 100 --exclude /tmp --exclude /proc --exclude /sys / rsync://user1@192.168.0.2//media/backup/owncloud 0 1 * * sun /usr/bin/duplicity remove-all-but-n-full 2 --force rsync://user1@192.168.0.2//media/backup/owncloud</code> </pre><br><br>  According to this plan, we will back up our entire chroot environment, complete on Sundays, incremental on other days, with the removal of old records.  If the file server is sleeping, it will be woken up in advance over the network (of course, if it supports this feature). <br><br><hr><br><br>  Well, we have both a working media center and a web server with cloud storage. <br>  Constructive criticism and suggestions are welcome. </div><p>Source: <a href="https://habr.com/ru/post/198492/">https://habr.com/ru/post/198492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198482/index.html">Top Ten Console Commands</a></li>
<li><a href="../198484/index.html">Task management system Track Task</a></li>
<li><a href="../198486/index.html">The new law on SORM. To chat is useless, to run away too. Must fight!</a></li>
<li><a href="../198488/index.html">Responsive Design and IE8</a></li>
<li><a href="../198490/index.html">Ubuntu Birthday</a></li>
<li><a href="../198498/index.html">ICANN gave the green light to delegate two new zones: ONLINE and SITE</a></li>
<li><a href="../198504/index.html">[Translation] 6 misconceptions in the methodology "Lean Startup" ("Lean Startup")</a></li>
<li><a href="../198506/index.html">Gartner Gartner technology maturity cycle - when introducing a new system in the enterprise</a></li>
<li><a href="../198510/index.html">New PhpStorm 7: outside the language</a></li>
<li><a href="../198512/index.html">In the footsteps of Cousteau, or the New Odyssey for Russian crowdfunding</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>