<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart polivalka flower on the microcontroller Attiny13A</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, habra users. Sometimes in life there are times when you want to do something with your own hands. Programming and electronics are a very fun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart polivalka flower on the microcontroller Attiny13A</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5f8/657/203/5f8657203e70473ea7c4099d8c8ae13b.jpg" alt="image"><br><br>  Good day, habra users.  Sometimes in life there are times when you want to do something with your own hands.  Programming and electronics are a very fun way to spend time, and a flower irrigation system can even be beneficial.  I tried to make everything easy and detailed to explain each stage.  I hope it will be useful and exciting for both readers and those who decide to pamper themselves and do something like that. <br><br>  I bring to your attention a device for automatic watering of flowers based on the Attiny13a microcontroller, details under the cut. <br><a name="habracut"></a><br><h6>  Let's start with the technical specifications </h6><br><ul><li>  We make a device that can water indoor plants without human intervention for at least 5 days. </li><li>  The device must take into account the soil moisture. </li><li>  The cost of the device should not exceed 1000r. </li></ul><br><h6>  Selection of element base </h6><br><blockquote>  I blinded him from what was </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The choice of microcontroller was obvious, I had <b>Attiny13A</b> , and took it, he has 1K of memory for the program, but oh well, that‚Äôs enough.  I got it for 115 rubles in a retail electronics store. <br><br>  Attiny13A <a href="http://www.getchip.net/wp-content/uploads/ATTiny13.pdf">datasheet</a> <br><br><img src="https://habrastorage.org/files/0d3/130/18a/0d313018a04045b5a2aed1f75102b399.jpg"><br><br>  Figure 1 (Attiny13A microcontroller) <br><br>  The microcontroller contains the main logic of operation. <br><br>  <i>For analog sensor:</i> <br>  Pause between watering 3 hours, if the signal from the humidity sensor is reduced (to 2V or even 1B), the duration of the break is reduced, the minimum break is 1 hour.  The watering cycle is 6-12 seconds, the first 6 seconds watering will be in any case, then when the signal from the humidity sensor 3B is exceeded, watering stops, or lasts 12 seconds if the humidity is not reached.  When you press the button (reset), watering occurs right now. <br><br>  <i>For a sensor with a comparator (high signal at low humidity):</i> <br>  Pause between watering 3 hours, if the signal from the humidity sensor is above 3V, the duration of the break is reduced, the minimum break is 1 hour.  The watering cycle is 6-12 seconds, the first 6 seconds watering will be in any case, then when the signal from the humidity sensor is less than 3V decreases, watering stops, or lasts 12 seconds if the humidity is not reached.  When you press the button (reset), watering occurs right now. <br><br><hr><br>  ULN2003A <br><br><img src="https://habrastorage.org/files/1d9/e49/d98/1d9e49d986d44d7cb43372ba1ec019ad.jpg"><br><br>  Figure 2 (ULN2003A chip) <br>  Build Darlington transistors is needed in order to control the relay and flashing LED.  On the controller, the current from the legs is very small, 20mA, maybe even less, and the relay needs 100mA and protection from the inductive load of the diode with this circuit will be unnecessary, since  inside everything is already provided.  Bought for 20 rubles. <br><br>  Soil moisture sensor (5V power supply, threshold output), 150r <br><br><img src="https://habrastorage.org/files/136/413/4dd/1364134dd2f54b259a48c179f3d95f66.jpg"><br><br>  Figure 3 (soil moisture sensor with comparator) <br><br>  It works like this: we tighten the resisor, adjust to the desired humidity. <br>  If the humidity is above the threshold, it gives a low level, if lower, then high. <br><br>  Soil moisture sensor (5V power supply, analog output), 230 rub. <br><br><img src="https://habrastorage.org/files/811/c08/fd6/811c08fd6cba4e319c72722056b3000f.jpg"><br><br>  Figure 3_1 (soil moisture sensor analog) <br><br>  And this one works like this: it produces an analog signal from small at low humidity, to large at high (maximum 4.2V at 5V power supply, current consumption 35mA). <br><br>  There are also those whose relay from the comparator is triggered. <br><br><hr><br>  A relay with a control voltage of 5V 200mW, switching current DC 5A 12V or more, I used this one - TR99-5VDC-SB-CD.  90 rub. <br><br><img src="https://habrastorage.org/files/c48/e7c/cd4/c48e7ccd43084d459410dd90a27fd333.jpg"><br><br>  Figure 4 (relay TR99-5VDC-SB-CD) <br><br>  (DC-DC 6-36V / 5V 2000mA and power supply for 12V 5A) or a battery from a 4.2V phone with constantly switched on charging.  For power, I used the Philips x100 phone, which crashed the screen, the usb wire - miniusb is suitable for charging it.  This is the most expensive item, the phone cost 1200r new, but since  from it you only need a charging function, then you can buy much used on the market for 300 rubles. <br><br>  Be careful, the controller and the pump can discharge the battery to 3V, the phone at 3.2V and below will think that the battery is dead and the phone will stop charging it. <br><br>  Instead of a phone, you can connect a charging controller, with it the discharge is not terrible, it even charges the battery discharged to 0. Such a thing costs 59 rubles to dx, well, you still need the battery. <br><br><img src="https://habrastorage.org/files/d98/836/1f4/d988361f4171499eb4e9bc085410b83e.jpg"><br><br>  Figure 5 (Charger for lithium batteries 1A) <br><br><hr><br>  Button, when clicked, emergency watering will occur. <br><br><img src="https://habrastorage.org/files/b46/0a1/061/b460a10614dc47bca5549f7c057e1b8c.jpg"><br><br>  Figure 6 (button) <br><br>  Diode for protection against improper inclusion (optional). <br>  Condensers to taste (3300 microfarads for battery operation of a mobile phone, so that when the motor is switched on, the drawdown does not reboot it, 0.1-200 microfarads in parallel with each consumer to suppress interference). <br><br>  Resistors (10k for podletyki power supply Reset, 0,2k-0,3k current-limited and the most common for the LED). <br><br><hr><br>  Glass washer pump for VAZ (the cheapest, together with a straw, a stick and clamps for fastening the straw, a water tank).  Here there is one important point, before throwing into the water, you need all the holes through which water can get to the tank or contacts, cover it with sealant, leaving only those through which water enters and leaves.  You can quit so, of course, it will even work, but it will last longer if sealed. <br><br><img src="https://habrastorage.org/files/83b/6a1/99e/83b6a199ef2d4d30a338371d009df0e2.jpg"><br><br>  Figure 7 (VAZ washer pump in a yellow bucket with water) <br><br><hr><br><br>  The board is a mock-up, or with ready-made paths and holes for the parts.  If someone draws a board and puts it in the comments, it will be great, I used the layout. <br><br><img src="https://habrastorage.org/files/3f7/e8d/402/3f7e8d4021b74a11a8fd6802ee5703bf.jpg"><br><br>  Figure 8 (layout) <br><br>  To program the controller, you will need software: PonyProg2000, LPT programmer (or another one), hex firmware, which is attached. <br><br>  If there is a desire to correct the source and compile your hex, then you will need another compiler, for example CV AVR. <br><br><hr><br><br><h6>  Work order </h6><br>  First you need to prepare the controller for programming, for this you need to bring the legs for programming on the programmer, according to the controller datasheet and lpt programmer. <br><br>  Like this: <br><br><img src="https://habrastorage.org/files/717/ff2/ff1/717ff2ff1d8443948f58c928a6ba1ae1.png"><br><br>  Figure 9 (controller legs for programming) <br><br><img src="https://habrastorage.org/files/1da/9d0/694/1da9d0694706425f8aa72d4f14f59ec0.jpg"><br><br>  Figure 9_1 (general view of the programmer) <br><br><img src="https://habrastorage.org/files/9f1/163/a7c/9f1163a7c84b401ca2f683b60793d918.jpg"><br><br>  Figure 10 (lpt programmer) <br><br><div class="spoiler">  <b class="spoiler_title">The program for the controller in C (version with analog humidity sensor 0-5V)</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> F_CPU 1200000UL #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;tiny13a.h&gt; #include &lt;delay.h&gt; #define PUMP PORTB.0 //   #define LED PORTB.1 //   #define MIN_WORKSEC 6 //     #define WORKSEC 12 //     #define DELAYSEC 10800 //       #define ADC_VREF_TYPE 0x00 // Read the AD conversion result unsigned int read_adc(unsigned char adc_input) { ADMUX=adc_input | (ADC_VREF_TYPE &amp; 0xff); // Delay needed for the stabilization of the ADC input voltage delay_us(10); // Start the AD conversion ADCSRA|=0x40; // Wait for the AD conversion to complete while ((ADCSRA &amp; 0x10)==0); ADCSRA|=0x10; return ADCW; } // Declare your global variables here void main(void) { // Declare your local variables here int i=0, led_delay=0; float humidity=0; unsigned int flagreset=0; if(MCUSR==0x02) { flagreset=1; } MCUSR = 0x00; // Crystal Oscillator division factor: 8 #pragma optsize- CLKPR=0x80; CLKPR=0x03; #ifdef _OPTIMIZE_SIZE_ #pragma optsize+ #endif // Input/Output Ports initialization // Port B initialization // Func5=In Func4=In Func3=In Func2=In Func1=Out Func0=Out // State5=T State4=T State3=T State2=T State1=0 State0=0 PORTB=0x00; DDRB=0x03; // Timer/Counter 0 initialization // Clock source: System Clock // Clock value: Timer 0 Stopped // Mode: Normal top=FFh // OC0A output: Disconnected // OC0B output: Disconnected TCCR0A=0x00; TCCR0B=0x00; TCNT0=0x00; OCR0A=0x00; OCR0B=0x00; // External Interrupt(s) initialization // INT0: Off // Interrupt on any change on pins PCINT0-5: Off GIMSK=0x00; MCUCR=0x00; // Timer/Counter 0 Interrupt(s) initialization TIMSK0=0x04; // Analog Comparator initialization // Analog Comparator: Off ACSR=0x80; ADCSRB=0x00; // ADC initialization // ADC Clock frequency: 75,000 kHz // ADC Bandgap Voltage Reference: Off // ADC Auto Trigger Source: Free Running // Digital input buffers on ADC0: On, ADC1: On, ADC2: On, ADC3: On DIDR0&amp;=0x03; DIDR0|=0x00; ADMUX=ADC_VREF_TYPE &amp; 0xff; ADCSRA=0xA1; ADCSRB&amp;=0xF8; // Global enable interrupts #asm("sei") while (1) { PUMP=0; LED=1; delay_ms(5000); LED=0; if(flagreset == 1) { PUMP=1; for(i=0; i&lt;WORKSEC; i++) { delay_ms(1000); if(i&gt;MIN_WORKSEC) { humidity = read_adc(2)/204; if(humidity&gt;3) { PUMP=0; } } } PUMP=0; flagreset=0; } led_delay = (DELAYSEC - 60)/12; for(i=0; i&lt;(DELAYSEC/12); i++) { humidity = read_adc(2)/204; delay_ms(1000); LED=0; if(i&gt;led_delay) { LED=1; } else { LED=0; } if(humidity&lt;1) { delay_ms(3000); } else if(humidity&lt;2) { delay_ms(5000); } else if(humidity&lt;3) { delay_ms(8000); } else { delay_ms(10000); } delay_ms(150); LED=1; delay_ms(25); LED=0; delay_ms(150); LED=1; delay_ms(50); LED=0; delay_ms(100); if(humidity&lt;2) { LED=1; delay_ms(150); LED=0; } else { delay_ms(550); } } LED=0; PUMP=1; for(i=0; i&lt;WORKSEC; i++) { humidity = read_adc(2)/204; delay_ms(1000); if(i&gt;MIN_WORKSEC) { if(humidity&gt;3) { PUMP=0; } } } PUMP=0; }; }</span></span></span></span></code> </pre> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">hex for ponyprog2000</b> <div class="spoiler_text"> <code>:0E00000009C0FECFFDCFFCCFFBCFFACFF9CF6A <br> :10000E00F8CFF7CFF6CFF894EE27ECBBE5BFF8E1CB <br> :10001E00A4B7A77FA4BFF1BDE1BD8DE0A2E0ED9333 <br> :10002E008A95E9F780E4A0E6ED938A95E9F7EFE982 <br> :10003E00EDBFC0E70DC0E881E7B984E08A95F1F71E <br> :10004E00369A349BFECF349AE4B1F5B121960895D9 <br> :10005E002497E0E0E883E983EA83EB83AFD020E0E6 <br> :10006E0030E040E050E0E4B7E23011F441E050E01F <br> :10007E00E0E0E4BFE0E8E6BDE3E0E6BDE0E0E8BBDB <br> :10008E00E3E0E7BBE0E0EFBDE3BFE2BFE6BFE9BD03 <br> :10009E00EBBFE5BFE4E0E9BFE0E8E8B9E0E0E3B9D3 <br> :1000AE00E4B3E370E4BBE4B3E4BBE0E0E7B9E1EA58 <br> :1000BE00E6B9E3B1E87FE3B97894C098C19AE8E86D <br> :1000CE00F3E17FD0C198E1E0F0E0E417F507C1F469 <br> :1000DE00C09A74D00C30E0E01E077CF475D0073067 <br> :1000EE00E0E01E073CF073D07FD080D009F008F41A <br> :1000FE0001C0C0980F5F1F4FEDCFC09840E050E099 <br> :10010E002FE733E05BD00438E3E01E07F4F55FD051 <br> :10011E005BD0C1982017310714F4C19A01C0C19861 <br> :10012E0063D0E0E0F0E060E87FE3BED018F4E8EBE7 <br> :10013E00FBE00DC061D018F4E8E8F3E108C054D03C <br> :10014E0055D018F4E0E4FFE102C0E0E1F7E2FA93E3 <br> :10015E00EA935CD058D0C19AE9E1F0E032D0C19870 <br> :10016E0052D0C19AE2E3F0E02CD0C198E4E6F0E080 <br> :10017E0028D042D020F4C19A46D0C19803C0E6E2FE <br> :10018E00F2E01FD00F5F1F4FBECFC198C09A16D09E <br> :10019E000C30E0E01E077CF41AD016D00730E0E0F9 <br> :1001AE001E0734F021D022D009F008F401C0C09807 <br> :1001BE000F5F1F4FEDCFC09880CFFFCF00E010E054 <br> :1001CE000895FA93EA9322C0E8EEF3E0FACFE2E064 <br> :1001DE00EA9331DFAE2FBF2FECECF0E092D0662722 <br> :1001EE00772734D0A8D00895A1D00895E0E0F0E0AC <br> :1001FE0060E470E459D00895F7DFE0E0F0E060E0ED <br> :10020E0070E452D00895E6E9F0E0DBCFE991F99180 <br> :10021E00309639F08CE291E00197F1F7A89531977D <br> :10022E00C9F7089550E8572711F45F932BC05F3F2D <br> :10023E0031F0660F000C57956795752F08955F93F3 <br> :10024E0000200AF02BC024C0689401C0E8943097B7 <br> :10025E0060407040B1F0002426F0772312F4009431 <br> :10026E0043D0172E7EE1112032F07A95EE0FFF1F4C <br> :10027E00661F111CF9CFEF2FF62F612D5F93D2DF82 <br> :10028E005F910895EE27FF27662777275F910895E0 <br> :10029E00EFEFFFEF6FE77FEF5F910895EFEFFFEF67 <br> :1002AE006FE77FE75F91089599239AF0772342F0E5 <br> :1002BE00971748F029F4AE17BF07860720F031F0E4 <br> :1002CE00989488940895989408940895189488940E <br> :1002DE0008957723C2F7971798F3A9F7EA17FB0744 <br> :1002EE00680788F399F3ECCFF09560957095E195DA <br> :1002FE00FF4F6F4F7F4F08956F2F660F660B762F50 <br> :10030E0008950024112490E1AA0FBB1F001C111C9C <br> :10031E000E1A1F0A18F40E0E1F1E01C0A1609A9528 <br> :10032E0099F7EA2FFB2FA02DB12D0895A881B98141 <br> :10033E008A819B810895E883F9836A837B8308957C <br> :00000001FF <br></code> <br></div></div><br><br>  Then you can assemble a circuit of polivalki, the capacitors on the diagram are not indicated, they are placed next to the consumers between the ground and the power: <br><br><img src="https://habrastorage.org/files/48b/27b/1de/48b27b1de05b4c2fa3862445d0f9b003.jpg"><br><br>  Figure 11 (diagram in the proteus) <br><br>  Somehow like this: <br><br><img src="https://habrastorage.org/files/0b0/3b7/643/0b03b7643f934992bb8e9404159cef4c.jpg"></div><p>Source: <a href="https://habr.com/ru/post/233769/">https://habr.com/ru/post/233769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../233755/index.html">How to create an interesting game setting? Level One: Text</a></li>
<li><a href="../233761/index.html">Databases and NoSQL (Chapter 4 of the book "Scalable and high-performance web applications")</a></li>
<li><a href="../233763/index.html">Automatic sex detection by name</a></li>
<li><a href="../233765/index.html">"Venture squared", or 13: 0 in favor of the investor</a></li>
<li><a href="../233767/index.html">Is there a difference - to work in an outsourcing or in a grocery company? Opinions from Yandex in Nizhny Novgorod</a></li>
<li><a href="../233773/index.html">Implementing gesture sequences in Unity 3D using the TouchScript library</a></li>
<li><a href="../233775/index.html">iNew V8 - special, but not perfect</a></li>
<li><a href="../233777/index.html">Alfa Camp 2014: 94 participants implement their ideas in 5 weeks and present them to investors</a></li>
<li><a href="../233779/index.html">Fly6: HD DVR and LED bike light in one package</a></li>
<li><a href="../233781/index.html">Looking for the perfect hub</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>