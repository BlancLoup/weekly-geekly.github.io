<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL101: Why restoring from a backup is slower than creating it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SQLskills launches new record placement initiative with basic knowledge, we called it SQL101. We will write about things that, as we often see, are do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL101: Why restoring from a backup is slower than creating it</h1><div class="post__text post__text-html js-mediator-article">  SQLskills launches new record placement initiative with basic knowledge, we called it SQL101.  We will write about things that, as we often see, are done incorrectly, technologies that are used incorrectly, and many misunderstandings that lead to serious problems.  If you want to find all the records in this series, check out the link <a href="http://sqlskills.com/help/SQL101">SQLskills.com/help/SQL101</a> (English). <br><br>  One of the questions that I constantly get asked is why it takes longer to restore a database from a full backup than to create a full backup.  The answer is that the recovery process almost always requires more work. <br><a name="habracut"></a><br>  Creating a full backup includes the following main stages: <br><br><ol><li>  Create a checkpoint. </li><li>  Reading all the data used from the data files (technically, reading all the placed extents, no matter how many of the 8 pages in the extent are actually used). </li><li>  Reading the transaction log from the beginning of the oldest uncommitted transaction from the initial checkpoint to the moment when the second stage was completed.  This is necessary so that the database can be restored to a consistent state at the point in time belonging to the backup period (see <a href="http://www.sqlskills.com/blogs/paul/2008/01/31/MoreOnHowMuchTransactionLogAFullBackupIncludes.aspx">this article</a> (English) for a detailed explanation). </li><li>  (Optionally testing the checksums of all pages, optionally performing backup compression and optionally encrypting the backup). </li></ol><br>  Recovery from a full backup includes the following main stages: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Creating data files (and filling them with zeros if <a href="https://www.sqlskills.com/blogs/kimberly/instant-initialization-what-why-and-how/">instant initialization of files is</a> not allowed (English, a <a href="https://habrahabr.ru/post/270699/">good alternative in Russian</a> ). </li><li>  Copy data from backup to data files. </li><li>  Creating a transaction log file and filling it with zeros.  The transaction log file must always be filled with zeros when it is created (see <a href="https://www.sqlskills.com/blogs/paul/search-engine-qa-24-why-cant-the-transaction-log-use-instant-initialization/">this article</a> (English) for a detailed explanation). </li><li>  Copy transaction log from backup to log file. </li><li>  Starting a database crash recovery. </li><li>  (Optional testing of the checksums of all pages during the second phase, unpacking, if the backup was compressed, decryption, if the backup was encrypted.) </li></ol><br>  Stage 3 is often the longest stage in recovery, and it is proportional to the size of the transaction log.  This process is carried out in a separate stage, instead of being performed in parallel with stage 1-2, and for in-depth study, see the <a href="https://blogs.msdn.microsoft.com/sql_server_team/sql-server-mysteries-the-case-of-the-not-100-restore/">recent entry in the</a> Bob Ward <a href="https://blogs.msdn.microsoft.com/sql_server_team/sql-server-mysteries-the-case-of-the-not-100-restore/">blog</a> . <br><br>  Stage 5 can be the longest stage in the recovery process if there were long uncommitted transactions in the backup creation process.  And it may be even longer if there are a large number of virtual log files (thousands) in the transaction log, since they greatly slow down the rollback mechanism of uncommitted transactions. <br><br>  Here is a list of things you can do to ensure quick recovery from a full backup: <br><br><ul><li>  Ensure that instant file initialization is enabled for the instance of SQL Server that performs the restore operation to avoid wasting time filling in zero any data files that should be created.  This can save hours of downtime for very large data files. </li><li>  If possible - restore over existing database - do not delete existing files.  This avoids the need to create and potentially fill with zeros the full amount of files, especially transaction log files.  Be very careful when using this item, as the existing database will be hopelessly destroyed as soon as the recovery process starts overwriting it. </li><li>  Consider using backup compression, it can speed up operations and create and restore backups, and save disk space and storage costs. </li><li>  Consider using multiple backup files, each on a separate volume.  SQL Server recognizes this situation and will use parallel write (one thread per volume) for file records when creating a backup and reading during the restore process - speeding up all processes.  If you have multiple database files, similar I / O parallelization will occur - providing even more acceleration. </li><li>  Try to avoid long transactions, as they will take a long time in the rollback process. </li><li>  Manage your transaction log so that you do not have too many virtual log files, so that if there are transactions that require a rollback, the rollback is as fast as possible.  See <a href="https://www.sqlskills.com/blogs/paul/important-change-vlf-creation-algorithm-sql-server-2014/">this blog entry</a> (English) for a detailed explanation. </li></ul><br>  Hope this was helpful! </div><p>Source: <a href="https://habr.com/ru/post/329814/">https://habr.com/ru/post/329814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329804/index.html">Git: many useful and different hooks</a></li>
<li><a href="../329806/index.html">Co-marketing as a way to monetize mobile applications</a></li>
<li><a href="../329808/index.html">Porting MIPSfpga to other cards and integrating peripherals into the system. Part 1</a></li>
<li><a href="../329810/index.html">Organization of events - a niche for IT solutions</a></li>
<li><a href="../329812/index.html">Comparison of contextual advertising automation services (part 2)</a></li>
<li><a href="../329816/index.html">Job prospects for Java programmers</a></li>
<li><a href="../329820/index.html">11 things I learned while reading the flexbox specification</a></li>
<li><a href="../329824/index.html">IT conference "Promotion": Saturday with benefits</a></li>
<li><a href="../329826/index.html">How IBM Watson cognitive system learns and answers questions. Part 1</a></li>
<li><a href="../329828/index.html">Courses Computer Science Club, spring 2017, part two</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>