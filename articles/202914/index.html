<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Report on the launch of programs on users' computers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 The report that the user runs on his computer is extremely important. From many points of view. Especially in terms of information security. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Report on the launch of programs on users' computers</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  The report that the user runs on his computer is extremely important.  From many points of view.  Especially in terms of information security. <br>  Information about the launch of programs on users' computers is stored in the security log.  Of course, considered the Windows environment.  I did not find a ready solution in the Internet, so I made my implementation. <br>  The script runs on the server.  At the output we have a set of files with reports on the launch of programs. <br>  Picture to attract attention: <br><img src="https://habrastorage.org/getpro/habr/post_images/155/a2c/8a1/155a2c8a1d1b836b72d51769a2c1191d.png"><br><a name="habracut"></a><br>  The basic idea is this.  Current security log events are saved in the evt file on the client computer.  The file is copied to the server, where information from it is uploaded to SQL Server.  Then a SQL query generates a report and saves it to a file. <br>  Now how this is implemented. <br>  You must create the Log, Logs, CheckComps, Logi_ForReports, and Computer folders.  I have folders on drive F. In the Log folder, create a list.txt file with a list of computers that need to be checked.  Each computer name with a new line.  I created 2 files list.txt and list7.txt for XP and sevens, respectively.  In the Computer folder create the file is_computer_online_listComps.vbs <br><div class="spoiler">  <b class="spoiler_title">The contents of the is_computer_online_listComps.vbs file:</b> <div class="spoiler_text"><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">resume</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsFileName <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsRunCmd <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gix <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> giy <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> giz <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsFileName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsOS = <span class="hljs-string"><span class="hljs-string">"XP"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsFileName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsOS = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gsFileName = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">"   "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"F:\Log\list.txt"</span></span>) gsOS = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">"  :"</span></span> &amp; VBNewLine &amp; <span class="hljs-string"><span class="hljs-string">"'XP' -  Windows 2000/XP"</span></span> &amp; VBNewLine &amp; <span class="hljs-string"><span class="hljs-string">"'7' -  Windows 7"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"XP"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> gsOS = <span class="hljs-built_in"><span class="hljs-built_in">uCase</span></span>(gsOS) wscript.echo <span class="hljs-string"><span class="hljs-string">"gsOS: "</span></span> &amp; gsOS <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">inStr</span></span>(gsOS, <span class="hljs-string"><span class="hljs-string">"XP"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-built_in"><span class="hljs-built_in">inStr</span></span>(gsOS, <span class="hljs-string"><span class="hljs-string">"7"</span></span>) = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">MsgBox</span></span> <span class="hljs-string"><span class="hljs-string">"    !"</span></span>, vbInformation, <span class="hljs-string"><span class="hljs-string">""</span></span> Wscript.Quit <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"   : "</span></span> &amp; gsFileName <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objFSO = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objTextFileOpen = objFSO.OpenTextFile(gsFileName, <span class="hljs-number"><span class="hljs-number">1</span></span>) gix = <span class="hljs-number"><span class="hljs-number">0</span></span> giy = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> WshShell = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"WScript.Shell"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> until objTextFileOpen.AtEndOfStream gsComputerName = objTextFileOpen.Readline giy = giy + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> objTextFileOpen.Close wscript.echo <span class="hljs-string"><span class="hljs-string">" : "</span></span> &amp; giy <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objTextFileOpen = objFSO.OpenTextFile(gsFileName, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> until objTextFileOpen.AtEndOfStream gsComputerName = objTextFileOpen.Readline gix = gix + <span class="hljs-number"><span class="hljs-number">1</span></span> giz = gix * <span class="hljs-number"><span class="hljs-number">100</span></span> giz = giz / giy giz = <span class="hljs-built_in"><span class="hljs-built_in">Round</span></span>(giz, <span class="hljs-number"><span class="hljs-number">1</span></span>) giOst = giy - gix <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fuPing(gsComputerName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> wscript.echo gsComputerName &amp; VBTab &amp; <span class="hljs-string"><span class="hljs-string">" : "</span></span> &amp; giOst &amp; <span class="hljs-string"><span class="hljs-string">", : "</span></span> &amp; giz &amp; <span class="hljs-string"><span class="hljs-string">"%"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">inStr</span></span>(gsOS, <span class="hljs-string"><span class="hljs-string">"XP"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsRunCmd = <span class="hljs-string"><span class="hljs-string">"f:\Computer\is_computer_online.bat "</span></span> &amp; gsComputerName &amp; <span class="hljs-string"><span class="hljs-string">" y"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> <span class="hljs-built_in"><span class="hljs-built_in">inStr</span></span>(gsOS, <span class="hljs-string"><span class="hljs-string">"7"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsRunCmd = <span class="hljs-string"><span class="hljs-string">"f:\Computer\is_computer_online7.bat "</span></span> &amp; gsComputerName &amp; <span class="hljs-string"><span class="hljs-string">" y"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> WshShell.Run gsRunCmd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> giOst &lt;&gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WScript.Sleep <span class="hljs-number"><span class="hljs-number">180000</span></span> <span class="hljs-comment"><span class="hljs-comment">' !     180   . end if else wscript.echo gsComputerName &amp; VBTab &amp; " : " &amp; giOst &amp; ", : " &amp; giz &amp; "%. ." end if loop objTextFileOpen.Close WScript.Echo " !" function fuPing(NetworkDevice) lBoo = false set objPING = GetObject("winmgmts:{impersonationLevel=impersonate}")._ ExecQuery ("select * from Win32_PingStatus where address ='" &amp; NetworkDevice &amp; "'") For Each PING In objPing if PING.StatusCode = 0 then 'WScript.Echo "*  " &amp; NetworkDevice &amp; "  !" lBoo = true else 'WScript.Echo "*    ." end if next fuPing = lBoo end function</span></span></code> </pre> <br></div></div><br>  The check procedure is started with a bat file.  A link to it can be made, for example, on the desktop. <br><div class="spoiler">  <b class="spoiler_title">bat file</b> <div class="spoiler_text"><pre> <code class="dos hljs">cscript //nologo "f:\Computer\is_computer_online_listComps.vbs" %<span class="hljs-number"><span class="hljs-number">1</span></span> %<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br></div></div><br>  The main script is_computer_online_listComps.vbs reads the list of computers from a text file and runs a report generation bat file for each.  For XP, it is the is_computer_online.bat file, for 7 it is is_computer_online7.bat. <br>  <em>Note.</em> <br>  On the server, you need to install <a href="http://www.microsoft.com/en-us/download/details.aspx%3Fid%3D24659">logparser</a> . <br>  Everything described should work on the administrator‚Äôs computer.  Only need to install Microsoft SQL SERVER 2008 NATIVE CLIENT and Microsoft SQL Server 2008 Command Line Utilities.  But I did not check. <br><br><h3>  XP computer unit </h3><br>  Bat file: <br><div class="spoiler">  <b class="spoiler_title">is_computer_online.bat</b> <div class="spoiler_text"><pre> <code class="dos hljs">cscript //nologo "f:\Computer\is_computer_online.vbs" %<span class="hljs-number"><span class="hljs-number">1</span></span> %<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br></div></div><br>  Bat-file runs the script.  The script saves the security log events to an evt-file and starts the main batch file mo2csv.bat. <br><div class="spoiler">  <b class="spoiler_title">is_computer_online.vbs</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">resume</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsComputerName <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsUseLogFile <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsLogFilename <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gbFlag <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsTableName <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsCompName <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsRunCmd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsComputerName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsUseLogFile = <span class="hljs-string"><span class="hljs-string">"n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsComputerName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsUseLogFile = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gsComputerName = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) gsUseLogFile = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">" log-  ?"</span></span> &amp; VBNewline &amp; <span class="hljs-string"><span class="hljs-string">"[y/n]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*   "</span></span> &amp; gsComputerName gsLogFilename = <span class="hljs-string"><span class="hljs-string">"f:\Log\"</span></span> &amp; gsComputerName &amp; <span class="hljs-string"><span class="hljs-string">".log"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lCase</span></span>(gsUseLogFile) = <span class="hljs-string"><span class="hljs-string">"y"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gbFlag = <span class="hljs-literal"><span class="hljs-literal">false</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*   "</span></span> &amp; gsLogFilename <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objFSO = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> objFSO.FileExists(gsLogFilename) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*   . ..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileWriteLog = objFSO.OpenTextFile(gsLogFilename, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span>) objTextFileWriteLog.writeLine <span class="hljs-string"><span class="hljs-string">"n"</span></span> objTextFileWriteLog.close WScript.Echo <span class="hljs-string"><span class="hljs-string">"*  ."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileOpen = objFSO.OpenTextFile(gsLogFilename, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> until objTextFileOpen.AtEndOfStream record = <span class="hljs-built_in"><span class="hljs-built_in">trim</span></span>(objTextFileOpen.Readline) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> record = <span class="hljs-string"><span class="hljs-string">"n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*    ."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fuPing(gsComputerName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gbFlag = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fuBackup(gsComputerName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WScript.Sleep <span class="hljs-number"><span class="hljs-number">15000</span></span> <span class="hljs-comment"><span class="hljs-comment">' &lt;- 15     fuUploadEvents gsComputerName wscript.sleep 10000 end if end if elseif record = "y" then WScript.Echo "*    " &amp; gsComputerName &amp; "    ." else WScript.Echo "*     " &amp; gsComputerName &amp; "  log-." end if loop objTextFileOpen.close if gbFlag then set objTextFileWriteLog = objFSO.OpenTextFile(gsLogFilename, 2, True) objTextFileWriteLog.writeLine "y" objTextFileWriteLog.close WScript.Echo "*    ." end if else 'if fuPing(gsComputerName) then if fuBackup(gsComputerName) then WScript.Sleep 15000 ' &lt;- 15     fuUploadEvents gsComputerName wscript.sleep 10000 end if 'end if end if wscript.sleep 1000 function fuPing(NetworkDevice) lBoo = false set objPING = GetObject("winmgmts:{impersonationLevel=impersonate}")._ ExecQuery ("select * from Win32_PingStatus where address ='" &amp; NetworkDevice &amp; "'") For Each PING In objPing if PING.StatusCode = 0 then WScript.Echo "*  " &amp; NetworkDevice &amp; "  !" lBoo = true else WScript.Echo "*    ." end if next fuPing = lBoo end function function fuBackup(lsComputername) lsEvtBackupFilename = "c:\" &amp; lsComputername &amp; ".evt" lsEvtBackupFilenameRemote = "\\" &amp; lsComputername &amp; "\c$\" &amp; lsComputername &amp; ".evt" lbFlag = false set lObjFSO = CreateObject("Scripting.FileSystemObject") if lObjFSO.FileExists(lsEvtBackupFilenameRemote) then WScript.Echo "*    .  ..." lbFlag = true else Wscript.Echo "*   ..." Set objWMIService = GetObject("winmgmts:{impersonationLevel=impersonate,(Backup)}!\\" &amp; lsComputername &amp; "\root\cimv2") Set colLogFiles = objWMIService.ExecQuery ("Select * from Win32_NTEventLogFile where LogFileName='Security'") For Each objLogfile in colLogFiles errBackupLog = objLogFile.BackupEventLog(lsEvtBackupFilename) If errBackupLog = 0 Then Wscript.Echo "*    ." lbFlag = true Else Wscript.Echo "*    ." End If Next end if fuBackup = lbFlag end function function fuUploadEvents(lsComputername) WScript.Echo "*    ..." gsCompName = lCase(lsComputername) gsTableName = fuGetTableName(gsCompName) gsTableName = uCase(gsTableName) gsOutputFilename = "f:\Computer\" &amp; gsCompName &amp; ".csv" gsOutputFilenameSQL = "f:\Computer\" &amp; gsCompName &amp; "_sql.csv" Set WshShell = CreateObject("WScript.Shell") gsRunCmd = "f:\Computer\mo2csv.bat " &amp; gsCompName &amp; " " &amp; gsOutputFilename &amp; " " &amp; gsOutputFilenameSQL &amp; " " &amp; gsTableName WScript.Echo "*  : '" &amp; gsRunCmd &amp; "'" WshShell.Run gsRunCmd end function function fuGetTableName(lsCompName) lsTmp = lsCompName if InStr(lsTmp, "-") then lsTmp = Replace(lsTmp, "-", "_") end if fuGetTableName = lsTmp end function</span></span></code> </pre><br></div></div><br>  mo2csv.bat does the following: <br><ul><li>  It takes the evt-file from the remote computer to the server. </li><li>  Converts evt file to evtx. </li><li>  It uploads only the start / stop program events from the evtx file to the text csv file. </li><li>  The information from the text file downloads to SQL Server. </li><li>  Backs up the original evt-file to the Logi_ForReports folder (all of a sudden the user will erase his log, and we have a copy). </li><li>  Deletes a temporary evtx file. </li><li>  Generates and executes sql query to SQL Server. </li><li>  Removes temporary files (in the case of debugging or to study the work of the script, this section can be commented out). </li><li>  Moves reports to the CheckComps folder. </li></ul><br><div class="spoiler">  <b class="spoiler_title">mo2csv.bat</b> <div class="spoiler_text"><pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off @<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WDate=<span class="hljs-variable"><span class="hljs-variable">%date:~-10%</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *       %<span class="hljs-number"><span class="hljs-number">1</span></span> (Windows XP)... <span class="hljs-built_in"><span class="hljs-built_in">move</span></span> \\<span class="hljs-variable"><span class="hljs-variable">%1\c$\%</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>.evt f:\Logs\ @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *   evt   evtx... wevtutil epl f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evt f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evtx /lf:true @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *        . : f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evtx, : %<span class="hljs-number"><span class="hljs-number">2</span></span> LogParser.exe file:"f:\Computer\get_info_from_log.sql"?source=f:\Logs\<span class="hljs-variable"><span class="hljs-variable">%1.evtx+output_file=%</span></span><span class="hljs-number"><span class="hljs-number">2</span></span> -i:EVT -o:TSV -headers:ON -oSeparator:tab -oTsFormat:"dd.MM.yyyy hh:mm:ss" -fileMode:<span class="hljs-number"><span class="hljs-number">1</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *    %<span class="hljs-number"><span class="hljs-number">2</span></span>.  %<span class="hljs-number"><span class="hljs-number">3</span></span>... cscript F:\Computer\update_csvFile_forSQLCheck.vbs %<span class="hljs-number"><span class="hljs-number">2</span></span> %<span class="hljs-number"><span class="hljs-number">3</span></span> //NoLogo @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *       SQL Server. : %<span class="hljs-number"><span class="hljs-number">3</span></span>,  %<span class="hljs-number"><span class="hljs-number">4</span></span>... LogParser.exe file:"f:\Computer\get_info_from_log_2SQL.sql"?source=<span class="hljs-variable"><span class="hljs-variable">%3+output_file=%</span></span><span class="hljs-number"><span class="hljs-number">4</span></span> -i:TSV -headerRow:ON -iSeparator:tab -iTsFormat:"dd.MM.yyyy hh:mm:ss" -o:SQL -server:"SQL-SRV\SEC" -database:quickly -driver:"SQL Server" -createTable:ON @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *     ... <span class="hljs-built_in"><span class="hljs-built_in">move</span></span> f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evt f:\Logi_ForReports\<span class="hljs-variable"><span class="hljs-variable">%1_%</span></span>WDate%_sec.evt @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  .    'f:\Logi_ForReports\<span class="hljs-variable"><span class="hljs-variable">%1_%</span></span>WDate%_sec.evt' @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *   evtx ... <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evtx @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  sql-... cscript "F:\Computer\create_SQL_full.vbs" %<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> //nologo @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  sql-... SQLCMD.EXE -S SQL-SRV\SEC -d quickly -E -<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>.sql -o "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .csv" -W -R -s ";" -w <span class="hljs-number"><span class="hljs-number">4000</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *    ... cscript F:\Computer\update_result_file.vbs "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .csv" //nologo @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *   ... <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>.sql <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> %<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> %<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>_dbg.txt <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .csv" @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  -... <span class="hljs-built_in"><span class="hljs-built_in">move</span></span> "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .xls" "f:\CheckComps\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .xls" @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> on</code> </pre>  <em>Note</em> <br>  Perhaps, in the batch file you will need to replace SQLCMD.EXE with ‚Äúc: \ Program Files \ Microsoft SQL Server \ 100 \ Tools \ Binn \ SQLCMD.EXE‚Äù, and LogParser.exe with ‚Äúc: \ Program Files (x86) \ Log Parser 2.2 \ LogParser.exe "(or" c: \ Program Files \ Log Parser 2.2 \ LogParser.exe "). <br>  Server name with SQL Server SQL-SRV, SEC instance name and database name quickly.  Replace with your own. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">get_info_from_log.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> RecordNumber <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eventid <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> eId, TimeGenerated <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Tg, resolve_sid(<span class="hljs-keyword"><span class="hljs-keyword">sid</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> UserName, computername <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Computer, EXTRACT_TOKEN(Strings, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> image_unique_id, EXTRACT_TOKEN(Strings, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'|'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> %output_file% <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">source</span></span>% <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ((EventID <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-number"><span class="hljs-number">592</span></span>; 593)) and (TO_UPPERCASE(resolve_sid(sid)) &lt;&gt; 'NT AUTHORITY\NETWORK SERVICE') and (TO_UPPERCASE(resolve_sid(sid)) &lt;&gt; 'NT AUTHORITY\SYSTEM')) and TimeGenerated &gt;= TO_TIMESTAMP('01.03.2011 00:00:00','dd.MM.yyyy hh:mm:ss') order by recordnumber asc</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">get_info_from_log_2SQL.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> %output_file% <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">source</span></span>%</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">update_csvFile_forSQLCheck.vbs</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">On</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Resume</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsSimbolSplitFields <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> sgSimbolSplitAdmin <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gbInsideBlock <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gIx <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gbDebug <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gbWriteString <span class="hljs-keyword"><span class="hljs-keyword">Dim</span></span> gArrBlock_admin gsSimbolSplitFields = vbTab sgSimbolSplitAdmin = <span class="hljs-string"><span class="hljs-string">";"</span></span> gbInsideBlock = <span class="hljs-literal"><span class="hljs-literal">false</span></span> gbIERuning = <span class="hljs-literal"><span class="hljs-literal">false</span></span> gbIE = <span class="hljs-literal"><span class="hljs-literal">false</span></span> giBlockPlus = <span class="hljs-number"><span class="hljs-number">0</span></span> giIEPlus = <span class="hljs-number"><span class="hljs-number">0</span></span> gsDateBlock = <span class="hljs-string"><span class="hljs-string">"01.01.2011 00:00:00"</span></span> TgBlockStop = <span class="hljs-string"><span class="hljs-string">"01.01.2011 00:00:00"</span></span> idBlockStop = <span class="hljs-string"><span class="hljs-string">""</span></span> gIx = <span class="hljs-number"><span class="hljs-number">0</span></span> gArrBlock_admin = <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span> (sgSimbolSplitAdmin &amp; sgSimbolSplitAdmin, _ sgSimbolSplitAdmin &amp; sgSimbolSplitAdmin, _ sgSimbolSplitAdmin &amp; sgSimbolSplitAdmin, _ sgSimbolSplitAdmin &amp; sgSimbolSplitAdmin) gbDebug = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment">'gbDebug = false if Wscript.Arguments.Count = 1 then sgFilename = Wscript.Arguments(0) sgFilenameOut = fuRemoveExtention(sgFilename) &amp; "_sql.csv" gsLogFilename = fuRemoveExtention(sgFilename) &amp; "_dbg.txt" elseif Wscript.Arguments.Count = 2 then sgFilename = Wscript.Arguments(0) sgFilenameOut = Wscript.Arguments(1) gsLogFilename = fuRemoveExtention(sgFilename) &amp; "_dbg.txt" elseif Wscript.Arguments.Count = 3 then sgFilename = Wscript.Arguments(0) sgFilenameOut = Wscript.Arguments(1) gsLogFilename = Wscript.Arguments(2) else sgFilename = InputBox("  ", "", "f:\comp-6475.csv") sgFilenameOut = InputBox("  ", "", fuRemoveExtention(sgFilename) &amp; "_sql.csv") gsLogFilename = InputBox("  ", "", fuRemoveExtention(sgFilename) &amp; "_dbg.txt") end if Set objFSO = CreateObject("Scripting.FileSystemObject") if not objFSO.FileExists(sgFilename) then wscript.echo "    , !" Wscript.Quit end if Set objTextFileOpen = objFSO.OpenTextFile(sgFilename, 1) Set objTextFileWrite = objFSO.CreateTextFile(sgFilenameOut, True) if gbDebug then if not objFSO.FileExists(gsLogFilename) then set objTextFileWriteLog = objFSO.OpenTextFile(gsLogFilename, 8, True) else set objTextFileWriteLog = objFSO.CreateTextFile(gsLogFilename, True) end if end if Do Until objTextFileOpen.AtEndOfStream record = trim(objTextFileOpen.Readline) gIx = gIx + 1 gbWriteString = true fuPrint gIx &amp; ". '" &amp; record &amp; "'" if InStr(record, gsSimbolSplitFields) then arr = Split(record, gsSimbolSplitFields) id = arr(0) eId = arr(1) Tg = arr(2) UserName = arr(3) Computer = arr(4) image_unique_id = arr(5) image = arr(6) if InStr(lCase(image), "explorer.exe") then if eId = "592" then gbBlockBegin = true gbBlockEnd = false giBlockPlus = giBlockPlus + 1 fuPrint "explorer.exe " else gbBlockBegin = false gbBlockEnd = true giBlockPlus = giBlockPlus - 1 if giBlockPlus &lt; 0 then giBlockPlus = 0 end if fuPrint "explorer.exe " end if else gbBlockBegin = false gbBlockEnd = false end if if InStr(lCase(image), "iexplore.exe") then gbIE = true fuPrint "  iexplore.exe" if eId = "592" then fuPrint "iexplore.exe " giIEPlus = giIEPlus + 1 gbIERuning = true if giIEPlus = 1 then image_unique_idIEStart = image_unique_id end if else fuPrint "iexplore.exe " giIEPlus = giIEPlus - 1 gbIERuning = false end if else gbIE = false fuPrint "  iexplore.exe" end if if gIx = 1 then objTextFileWrite.WriteLine record &amp; gsSimbolSplitFields &amp; "CompStart" fuPrint " , " elseif gIx = 2 then fuPrint " " if gbBlockBegin then fuPrint " , " gbInsideBlock = true gsDateBlock = Tg gsUserNameBlockStart = UserName image_unique_idBlockStart = image_unique_id objTextFileWrite.WriteLine record &amp; gsSimbolSplitFields &amp; gsDateBlock end if idPrev = id eIdPrev = eId TgPrev = Tg UserNamePrev = UserName ComputerPrev = Computer image_unique_idPrev = image_unique_id imagePrev = image else 'fuPrint " " '--  explorer.exe if gbBlockBegin then fuPrint " explorer.exe ( ‚Ññ " &amp; giBlockPlus &amp; ")" if giBlockPlus = 1 then giDiff = DateDiff("s", CDate(TgBlockStop), CDate(Tg)) if giDiff &gt; 9 then if Len(idBlockStop) &gt; 0 then fuPrint "   explorer.exe.    " record_convert_prev = idBlockStop &amp; gsSimbolSplitFields &amp; _ eIdBlockStop &amp; gsSimbolSplitFields &amp; _ TgBlockStop &amp; gsSimbolSplitFields &amp; _ UserNameBlockStop &amp; gsSimbolSplitFields &amp; _ ComputerBlockStop &amp; gsSimbolSplitFields &amp; _ image_unique_idBlockStart &amp; gsSimbolSplitFields &amp; _ imageBlockStop &amp; gsSimbolSplitFields &amp; _ gsDateBlock fuPrint record_convert_prev objTextFileWrite.WriteLine record_convert_prev end if gsDateBlock = Tg fuPrint "  : '" &amp; gsDateBlock &amp; "'" image_unique_idBlockStart = image_unique_id fuPrint "  : '" &amp; image_unique_idBlockStart &amp; "'" gsUserNameBlockStart = UserName fuPrint "  : '" &amp; gsUserNameBlockStart &amp; "'" else fuPrint "  explorer.exe!          ." gbWriteString = false end if gbInsideBlock = true else if lCase(gsUserNameBlockStart) = lCase(UserName) then fuPrint "gsUserNameBlockStart: '" &amp; gsUserNameBlockStart &amp; "', UserName: '" &amp; UserName &amp; "'" fuPrint " . ,    .          " record_convert_prev = "999" &amp; gsSimbolSplitFields &amp; _ "593" &amp; gsSimbolSplitFields &amp; _ Tg &amp; gsSimbolSplitFields &amp; _ UserName &amp; gsSimbolSplitFields &amp; _ Computer &amp; gsSimbolSplitFields &amp; _ image_unique_idBlockStart &amp; gsSimbolSplitFields &amp; _ "C:\WINDOWS\explorer.exe" &amp; gsSimbolSplitFields &amp; _ gsDateBlock fuPrint record_convert_prev objTextFileWrite.WriteLine record_convert_prev giBlockPlus = 1 gsDateBlock = Tg fuPrint "  : '" &amp; gsDateBlock &amp; "'" image_unique_idBlockStart = image_unique_id fuPrint "  : '" &amp; image_unique_idBlockStart &amp; "'" else 'fuPrint "gsUserNameBlockStart: '" &amp; gsUserNameBlockStart &amp; "', UserName: '" &amp; UserName &amp; "'" fuPrint "  . ,   explorer.      " gArrBlock_admin(giBlockPlus-2) = image_unique_id &amp; sgSimbolSplitAdmin &amp; UserName &amp; sgSimbolSplitAdmin &amp; Tg fuPrint gArrBlock_admin(giBlockPlus-2) 'gsDateBlock_admin = Tg objTextFileWrite.WriteLine record &amp; gsSimbolSplitFields &amp; Tg gbWriteString = false end if end if end if '--  explorer.exe if gbBlockEnd then fuPrint " explorer.exe (  " &amp; giBlockPlus &amp; ")" if giBlockPlus = 0 then fuPrint "  ,   " idBlockStop = id eIdBlockStop = eId TgBlockStop = Tg UserNameBlockStop = UserName ComputerBlockStop = Computer image_unique_idBlockStop = image_unique_id imageBlockStop = image gbInsideBlock = false giIEPlus = 0 ' &lt;--      IE else fuPrint "   ,    ,    " for giY = 0 to UBound(gArrBlock_admin) arrA = Split(gArrBlock_admin(giY), sgSimbolSplitAdmin) gsImage_unique_id_A = arrA(0) gsUserName_A = arrA(1) gsTg_A = arrA(2) if gsImage_unique_id_A = image_unique_id then gsDateBlock_admin = gsTg_A end if next objTextFileWrite.WriteLine record &amp; gsSimbolSplitFields &amp; gsDateBlock_admin gbWriteString = false end if end if '--    if gbInsideBlock then if gbIE then if (((gbIERuning) and (giIEPlus = 1)) or ((not gbIERuning) and (giIEPlus = 0))) then fuPrint " IE " record_convert_prev = id &amp; gsSimbolSplitFields &amp; _ eId &amp; gsSimbolSplitFields &amp; _ Tg &amp; gsSimbolSplitFields &amp; _ UserName &amp; gsSimbolSplitFields &amp; _ Computer &amp; gsSimbolSplitFields &amp; _ image_unique_idIEStart &amp; gsSimbolSplitFields &amp; _ image &amp; gsSimbolSplitFields &amp; _ gsDateBlock fuPrint record_convert_prev objTextFileWrite.WriteLine record_convert_prev else fuPrint "   IE! gbIERuning: " &amp; gbIERuning &amp; ", giIEPlus: " &amp; giIEPlus record_convert_prev = id &amp; gsSimbolSplitFields &amp; _ eId &amp; gsSimbolSplitFields &amp; _ Tg &amp; gsSimbolSplitFields &amp; _ UserName &amp; gsSimbolSplitFields &amp; _ Computer &amp; gsSimbolSplitFields &amp; _ image_unique_idIEStart &amp; gsSimbolSplitFields &amp; _ image &amp; gsSimbolSplitFields &amp; _ gsDateBlock fuPrint record_convert_prev end if else if gbWriteString then fuPrint "       " fuPrint record &amp; gsSimbolSplitFields &amp; gsDateBlock objTextFileWrite.WriteLine record &amp; gsSimbolSplitFields &amp; gsDateBlock else fuPrint "   ,     " end if end if else fuPrint "    .  " end if '--        idPrev = id eIdPrev = eId TgPrev = Tg UserNamePrev = UserName ComputerPrev = Computer image_unique_idPrev = image_unique_id imagePrev = image end if end if fuPrint "----------------------------------------------" Loop objTextFileWrite.Close objTextFileOpen.Close if gbDebug then objTextFileWriteLog.close end if WScript.Echo "" WScript.Echo "*   ." function fuRemoveExtention(lsFilename) lRes = lsFilename if InStr(lsFilename, ".") then lRes = Left(lsFilename, Len(lsFilename)-4) end if fuRemoveExtention = lRes end function function fuGetDateFromFullDate(lsFullDate) lRes = lsFullDate if InStr(lsFullDate, " ") then lArr = Split(lsFullDate, " ") lsDate = lArr(0) lsTime = lArr(1) lRes = lsDate end if fuGetDateFromFullDate = lRes end function function fuGetTimeFromFullDate(lsFullDate) lRes = lsFullDate if InStr(lsFullDate, " ") then lArr = Split(lsFullDate, " ") lsDate = lArr(0) lsTime = lArr(1) lRes = lsTime end if fuGetDateFromFullDate = lRes end function function fuPrint(lsStr) 'if gbDebug then ' wscript.echo lsStr 'end if if gbDebug then objTextFileWriteLog.writeLine lsStr end if fuPrint = true end function</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">create_SQL_full.vbs</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsComputerName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsSQLtype = <span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsComputerName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsSQLtype = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gsComputerName = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) gsSQLtype = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">" sql-?"</span></span> &amp; VBNewline &amp; <span class="hljs-string"><span class="hljs-string">"[1 - , 2 - , 3 - ]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objFSO = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> gsSQLtype = <span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> fuCreateSQLFile gsComputerName, <span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> gsSQLtype = <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> fuCreateSQLFile gsComputerName, <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> gsSQLtype = <span class="hljs-string"><span class="hljs-string">"3"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> fuCreateSQLFile gsComputerName, <span class="hljs-string"><span class="hljs-string">"1"</span></span> fuCreateSQLFile gsComputerName, <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> fuGetTableName(lsCompName) lsTmp = lsCompName <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">InStr</span></span>(lsTmp, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> lsTmp = <span class="hljs-built_in"><span class="hljs-built_in">Replace</span></span>(lsTmp, <span class="hljs-string"><span class="hljs-string">"-"</span></span>, <span class="hljs-string"><span class="hljs-string">"_"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fuGetTableName = lsTmp <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> fuCreateSQLFile(lsComputerName, lsSQLtype) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> lsSQLtype = <span class="hljs-string"><span class="hljs-string">"1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> lsTemplateFilename = <span class="hljs-string"><span class="hljs-string">"f:\Computer\template-short.sql"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> gsSQLtype = <span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> lsTemplateFilename = <span class="hljs-string"><span class="hljs-string">"f:\Computer\template-full.sql"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> lsLogFilename = <span class="hljs-string"><span class="hljs-string">"f:\Computer\"</span></span> &amp; lsComputerName &amp; <span class="hljs-string"><span class="hljs-string">"-"</span></span> &amp; lsSQLtype &amp; <span class="hljs-string"><span class="hljs-string">".sql"</span></span> lsTableName = fuGetTableName(lsComputerName) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> objFSO.FileExists(lsLogFilename) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileWriteLog = objFSO.OpenTextFile(lsLogFilename, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileWriteLog = objFSO.OpenTextFile(lsLogFilename, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objTextFileOpen = objFSO.OpenTextFile(lsTemplateFilename, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> until objTextFileOpen.AtEndOfStream record = objTextFileOpen.Readline <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">InStr</span></span>(record, <span class="hljs-string"><span class="hljs-string">"WARNING__TABLE_NAME_FOR_CHANGE"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> record = <span class="hljs-built_in"><span class="hljs-built_in">Replace</span></span>(record, <span class="hljs-string"><span class="hljs-string">"WARNING__TABLE_NAME_FOR_CHANGE"</span></span>, lsTablename) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> objTextFileWriteLog.writeLine record <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> objTextFileOpen.Close objTextFileWriteLog.Close <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">template-short.sql</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">PERCENT</span></span> Computer <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], UserName <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], image <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> , start_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], stop_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) / <span class="hljs-number"><span class="hljs-number">3600</span></span>)) + <span class="hljs-string"><span class="hljs-string">':'</span></span> + dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) % <span class="hljs-number"><span class="hljs-number">3600</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>)) + <span class="hljs-string"><span class="hljs-string">':'</span></span> + dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) % <span class="hljs-number"><span class="hljs-number">3600</span></span> % <span class="hljs-number"><span class="hljs-number">60</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> r.Computer, r.UserName, r.image_unique_id, r.image, r.Tg <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> start_time, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(s.Tg) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> stop_time <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eId, Tg, UserName, Computer, image_unique_id, image <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.WARNING__TABLE_NAME_FOR_CHANGE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (eId = <span class="hljs-number"><span class="hljs-number">592</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (Tg &gt; <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(DATETIME, <span class="hljs-string"><span class="hljs-string">'2013-01-01 00:00:00.000'</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eId, Tg, UserName, Computer, image_unique_id, image <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.WARNING__TABLE_NAME_FOR_CHANGE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (eId = <span class="hljs-number"><span class="hljs-number">593</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> r.image_unique_id = s.image_unique_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.image = s.image <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.id &lt; s.id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.Tg &lt;= s.Tg <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> r.UserName, r.Computer, r.image_unique_id, r.image, r.Tg) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DERIVEDTBL <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">update_result_file.vbs</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsFileName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsFileNameRes = fuRemoveExtention(gsFileName) &amp; <span class="hljs-string"><span class="hljs-string">".xls"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsFileName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsFileNameRes = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gsFileName = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) gsFileNameRes = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, fuRemoveExtention(gsFileName) &amp; <span class="hljs-string"><span class="hljs-string">".xls"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> sgSimbolSplit = <span class="hljs-string"><span class="hljs-string">";"</span></span> gsSimbolSplitFields = vbTab <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objFSO = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> objTextFileOpen = objFSO.OpenTextFile(gsFileName, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> objFSO.FileExists(gsFileName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> wscript.echo <span class="hljs-string"><span class="hljs-string">"    , !"</span></span> objTextFileOpen.Close Wscript.Quit <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> objFSO.FileExists(gsFileNameRes) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileWriteRes = objFSO.OpenTextFile(gsFileNameRes, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileWriteRes = objFSO.CreateTextFile(gsFileNameRes, <span class="hljs-literal"><span class="hljs-literal">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> until objTextFileOpen.AtEndOfStream record = objTextFileOpen.Readline <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-built_in"><span class="hljs-built_in">InStr</span></span>(record, <span class="hljs-string"><span class="hljs-string">"--------"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Len</span></span>(record) = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">InStr</span></span>(record, <span class="hljs-string"><span class="hljs-string">" "</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">InStr</span></span>(record, <span class="hljs-string"><span class="hljs-string">"rows affected"</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">'wscript.echo " : '" &amp; record &amp; "'" else if InStr(record, sgSimbolSplit) then recordRes = Replace(record, sgSimbolSplit, gsSimbolSplitFields) else recordRes = record end if objTextFileWriteRes.writeLine recordRes end if loop objTextFileWriteRes.Close objTextFileOpen.Close WScript.Echo " !   " &amp; gsFileNameRes function fuRemoveExtention(lsFilename) lRes = lsFilename if InStr(lsFilename, ".") then lRes = Left(lsFilename, Len(lsFilename)-4) end if fuRemoveExtention = lRes end function</span></span></code> </pre><br></div></div><br><br><h3>  Block work with computers with seven </h3><br>  Bat file: <br><div class="spoiler">  <b class="spoiler_title">is_computer_online7.bat</b> <div class="spoiler_text"><pre> <code class="dos hljs">cscript //nologo "f:\Computer\is_computer_online7.vbs" %<span class="hljs-number"><span class="hljs-number">1</span></span> %<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br></div></div><br>  Bat-file runs the script.  The script saves the security log events to the evt-file and runs the main mo7.bat batch file. <br><div class="spoiler">  <b class="spoiler_title">is_computer_online7.vbs</b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> <span class="hljs-keyword"><span class="hljs-keyword">resume</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsComputerName <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsUseLogFile <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsLogFilename <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gbFlag <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsTableName <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsCompName <span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> gsRunCmd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsComputerName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsUseLogFile = <span class="hljs-string"><span class="hljs-string">"n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> Wscript.Arguments.Count = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gsComputerName = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">0</span></span>) gsUseLogFile = Wscript.Arguments(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> gsComputerName = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) gsUseLogFile = <span class="hljs-built_in"><span class="hljs-built_in">InputBox</span></span>(<span class="hljs-string"><span class="hljs-string">" log-  ?"</span></span> &amp; VBNewline &amp; <span class="hljs-string"><span class="hljs-string">"[y/n]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*   "</span></span> &amp; gsComputerName <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lCase</span></span>(gsUseLogFile) = <span class="hljs-string"><span class="hljs-string">"y"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> gbFlag = <span class="hljs-literal"><span class="hljs-literal">false</span></span> gsLogFilename = <span class="hljs-string"><span class="hljs-string">"f:\Log\"</span></span> &amp; gsComputerName &amp; <span class="hljs-string"><span class="hljs-string">".log"</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*   "</span></span> &amp; gsLogFilename <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objFSO = <span class="hljs-built_in"><span class="hljs-built_in">CreateObject</span></span>(<span class="hljs-string"><span class="hljs-string">"Scripting.FileSystemObject"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> objFSO.FileExists(gsLogFilename) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*   . ..."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileWriteLog = objFSO.OpenTextFile(gsLogFilename, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-literal"><span class="hljs-literal">True</span></span>) objTextFileWriteLog.writeLine <span class="hljs-string"><span class="hljs-string">"n"</span></span> objTextFileWriteLog.close WScript.Echo <span class="hljs-string"><span class="hljs-string">"*  ."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> objTextFileOpen = objFSO.OpenTextFile(gsLogFilename, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> until objTextFileOpen.AtEndOfStream record = <span class="hljs-built_in"><span class="hljs-built_in">trim</span></span>(objTextFileOpen.Readline) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> record = <span class="hljs-string"><span class="hljs-string">"n"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WScript.Echo <span class="hljs-string"><span class="hljs-string">"*    ."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fuPing(gsComputerName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">'fuListInstalledSoftware gsComputerName gbFlag = true if fuBackup(gsComputerName) then WScript.Sleep 15000 ' &lt;- 15     fuUploadEvents gsComputerName wscript.sleep 10000 end if end if elseif record = "y" then WScript.Echo "*    " &amp; gsComputerName &amp; "    ." else WScript.Echo "*     " &amp; gsComputerName &amp; "  log-." end if loop objTextFileOpen.close if gbFlag then set objTextFileWriteLog = objFSO.OpenTextFile(gsLogFilename, 2, True) objTextFileWriteLog.writeLine "y" objTextFileWriteLog.close WScript.Echo "*    ." 'MsgBox " " &amp; gsComputerName &amp; "  !", vbInformation, "" end if else 'if fuPing(gsComputerName) then if fuBackup(gsComputerName) then WScript.Sleep 15000 ' &lt;- 15     fuUploadEvents gsComputerName wscript.sleep 60000 end if 'end if end if wscript.sleep 1000 function fuPing(NetworkDevice) lBoo = false set objPING = GetObject("winmgmts:{impersonationLevel=impersonate}")._ ExecQuery ("select * from Win32_PingStatus where address ='" &amp; NetworkDevice &amp; "'") For Each PING In objPing if PING.StatusCode = 0 then WScript.Echo "*  " &amp; NetworkDevice &amp; "  !" lBoo = true else WScript.Echo "*    ." end if next fuPing = lBoo end function function fuBackup(lsComputername) lsEvtBackupFilename = "c:\" &amp; lsComputername &amp; ".evt" lsEvtBackupFilenameRemote = "\\" &amp; lsComputername &amp; "\c$\" &amp; lsComputername &amp; ".evt" lbFlag = false 'WScript.Echo "* lsEvtBackupFilename: " &amp; lsEvtBackupFilename 'WScript.Echo "* lsEvtBackupFilenameRemote: " &amp; lsEvtBackupFilenameRemote set lObjFSO = CreateObject("Scripting.FileSystemObject") if lObjFSO.FileExists(lsEvtBackupFilenameRemote) then WScript.Echo "*    .  ..." lbFlag = true else Wscript.Echo "*   ..." Set objWMIService = GetObject("winmgmts:{impersonationLevel=impersonate,(Backup)}!\\" &amp; lsComputername &amp; "\root\cimv2") Set colLogFiles = objWMIService.ExecQuery ("Select * from Win32_NTEventLogFile where LogFileName='Security'") For Each objLogfile in colLogFiles errBackupLog = objLogFile.BackupEventLog(lsEvtBackupFilename) If errBackupLog = 0 Then Wscript.Echo "*    ." lbFlag = true Else Wscript.Echo "*    ." End If Next end if fuBackup = lbFlag end function function fuUploadEvents(lsComputername) WScript.Echo "*    ..." gsCompName = lCase(lsComputername) gsTableName = fuGetTableName(gsCompName) gsTableName = uCase(gsTableName) Set WshShell = CreateObject("WScript.Shell") gsRunCmd = "f:\Computer\mo7.bat " &amp; gsCompName &amp; " " &amp; gsTableName WScript.Echo "*  : '" &amp; gsRunCmd &amp; "'" WshShell.Run gsRunCmd end function function fuGetTableName(lsCompName) lsTmp = lsCompName if InStr(lsTmp, "-") then lsTmp = Replace(lsTmp, "-", "_") end if fuGetTableName = lsTmp end function</span></span></code> </pre><br></div></div><br>  mo7.bat does the following: <br><ul><li>  It takes the evt-file from the remote computer to the server. </li><li>  Converts evt file to evtx. </li><li>  Information from evtx-file uploads to SQL Server. </li><li>  Backs up the original evt-file to the Logi_ForReports folder (all of a sudden the user will erase his log, and we have a copy). </li><li>  Deletes a temporary evtx file. </li><li>  Generates and executes sql query to SQL Server. </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Removes temporary files (in the case of debugging or to study the work of the script, this section can be commented out). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Moves reports to the CheckComps folder. </font></font></li></ul><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mo7.bat</font></font></b> <div class="spoiler_text"><pre> <code class="dos hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off @<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> WDate=<span class="hljs-variable"><span class="hljs-variable">%date:~-10%</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *       %<span class="hljs-number"><span class="hljs-number">1</span></span> (Windows <span class="hljs-number"><span class="hljs-number">7</span></span>)... <span class="hljs-built_in"><span class="hljs-built_in">move</span></span> \\<span class="hljs-variable"><span class="hljs-variable">%1\c$\%</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>.evt f:\Logs\ @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *   evt   evtx... wevtutil epl f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evt f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evtx /lf:true @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *       . : f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evtx LogParser.exe file:"f:\Computer\get_info_from_log7.sql"?source=f:\Logs\<span class="hljs-variable"><span class="hljs-variable">%1.evtx+output_file=%</span></span><span class="hljs-number"><span class="hljs-number">2</span></span> -i:EVT -o:SQL -server:"SQL-SRV\SEC" -database:quickly -driver:"SQL Server" -createTable:ON @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *     ... <span class="hljs-built_in"><span class="hljs-built_in">move</span></span> f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evt f:\Logi_ForReports\<span class="hljs-variable"><span class="hljs-variable">%1_%</span></span>WDate%_sec.evt @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  .    'f:\Logi_ForReports\<span class="hljs-variable"><span class="hljs-variable">%1_%</span></span>WDate%_sec.evtx' @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  sql-... cscript "F:\Computer\create_SQL_full7.vbs" %<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> //nologo @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  sql-... SQLCMD.EXE -S SQL-SRV\SEC -d quickly -E -<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>.sql -o "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .csv" -W -R -s ";" -w <span class="hljs-number"><span class="hljs-number">4000</span></span> @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *    ... cscript F:\Computer\update_result_file7.vbs "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .csv" //nologo @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *   ... <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> f:\Logs\%<span class="hljs-number"><span class="hljs-number">1</span></span>.evtx <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span>.sql <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .csv" @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *    . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  -... <span class="hljs-built_in"><span class="hljs-built_in">move</span></span> "f:\Computer\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .xls" "f:\CheckComps\%<span class="hljs-number"><span class="hljs-number">1</span></span>.  .xls" @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> *  . @<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> on</code> </pre>  <em>Note</em> <br> ,     SQLCMD.EXE   ¬´c:\Program Files\Microsoft SQL Server\100\Tools\Binn\SQLCMD.EXE¬ª,  LogParser.exe  ¬´c:\Program Files (x86)\Log Parser 2.2\LogParser.exe¬ª ( ¬´c:\Program Files\Log Parser 2.2\LogParser.exe¬ª). <br>    SQL Server' SQL-SRV,   SEC    quickly.   . <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get_info_from_log7.sql</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> RecordNumber <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eventid <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> eId, TimeGenerated <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Tg, <span class="hljs-comment"><span class="hljs-comment">--resolve_sid(sid) as UserName, EXTRACT_TOKEN(Strings, 1, '|') as UserName, computername as Computer, EXTRACT_TOKEN(Strings, 4, '|') as image_id, EXTRACT_TOKEN(Strings, 5, '|') as image, EXTRACT_TOKEN(Strings, 6, '|') as name into %output_file% FROM %source% where (EventID in (4688;4689)) and ( (TO_UPPERCASE(resolve_sid(sid)) &lt;&gt; 'NT AUTHORITY\NETWORK SERVICE') and (TO_UPPERCASE(resolve_sid(sid)) &lt;&gt; 'NT AUTHORITY\SYSTEM')) and TimeGenerated &gt;= TO_TIMESTAMP('01.01.2013 00:00:00','dd.MM.yyyy hh:mm:ss') order by recordnumber desc</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">create_SQL_full7.vbs</font></font></b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'on error resume next if Wscript.Arguments.Count = 1 then gsComputerName = Wscript.Arguments(0) gsSQLtype = "1" elseif Wscript.Arguments.Count = 2 then gsComputerName = Wscript.Arguments(0) gsSQLtype = Wscript.Arguments(1) else gsComputerName = InputBox(" ", "", "") gsSQLtype = InputBox(" sql-?" &amp; VBNewline &amp; "[1 - , 2 - , 3 - ]", "", "1") end if set objFSO = CreateObject("Scripting.FileSystemObject") if gsSQLtype = "1" then fuCreateSQLFile gsComputerName, "1" elseif gsSQLtype = "2" then fuCreateSQLFile gsComputerName, "2" elseif gsSQLtype = "3" then fuCreateSQLFile gsComputerName, "1" fuCreateSQLFile gsComputerName, "2" end if function fuGetTableName(lsCompName) lsTmp = lsCompName if InStr(lsTmp, "-") then lsTmp = Replace(lsTmp, "-", "_") end if fuGetTableName = lsTmp end function sub fuCreateSQLFile(lsComputerName, lsSQLtype) if lsSQLtype = "1" then lsTemplateFilename = "f:\Computer\template-short7.sql" elseif gsSQLtype = "2" then lsTemplateFilename = "f:\Computer\template-full7.sql" end if lsLogFilename = "f:\Computer\" &amp; lsComputerName &amp; "-" &amp; lsSQLtype &amp; ".sql" lsTableName = fuGetTableName(lsComputerName) 'WScript.Echo "*   " &amp; lsComputerName 'WScript.Echo "*   " &amp; lsTableName 'WScript.Echo "*   sql- " &amp; lsLogFilename if not objFSO.FileExists(lsLogFilename) then set objTextFileWriteLog = objFSO.OpenTextFile(lsLogFilename, 8, True) else set objTextFileWriteLog = objFSO.OpenTextFile(lsLogFilename, 2, True) end if Set objTextFileOpen = objFSO.OpenTextFile(lsTemplateFilename, 1) do until objTextFileOpen.AtEndOfStream record = objTextFileOpen.Readline if InStr(record, "WARNING__TABLE_NAME_FOR_CHANGE") then record = Replace(record, "WARNING__TABLE_NAME_FOR_CHANGE", lsTablename) end if objTextFileWriteLog.writeLine record loop objTextFileOpen.Close objTextFileWriteLog.Close end sub</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">template-short7.sql</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">PERCENT</span></span> Computer <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], UserName <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], program <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> , start_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], stop_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) / <span class="hljs-number"><span class="hljs-number">3600</span></span>)) + <span class="hljs-string"><span class="hljs-string">':'</span></span> + dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) % <span class="hljs-number"><span class="hljs-number">3600</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>)) + <span class="hljs-string"><span class="hljs-string">':'</span></span> + dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) % <span class="hljs-number"><span class="hljs-number">3600</span></span> % <span class="hljs-number"><span class="hljs-number">60</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> r.Computer, s.UserName, r.programID, r.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> R_ID, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(s.id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> S_ID, r.program, r.Tg <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> start_time, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(s.Tg) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> stop_time <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eId, Tg, UserName, Computer, image_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> programID, image <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> program <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.WARNING__TABLE_NAME_FOR_CHANGE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (eId = <span class="hljs-number"><span class="hljs-number">4688</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (Tg &gt; <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(DATETIME, <span class="hljs-string"><span class="hljs-string">'2013-01-01 00:00:00.000'</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%.scr'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eId, Tg, UserName, Computer, image <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> programID, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> program <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.WARNING__TABLE_NAME_FOR_CHANGE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (eId = <span class="hljs-number"><span class="hljs-number">4689</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%.scr'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> r.programID = s.programID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.program = s.program <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.UserName = s.UserName <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.id &lt;= s.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> r.Computer, s.UserName, r.programID, r.id, r.program, r.Tg) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DERIVEDTBL <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">PERCENT</span></span> Computer <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], UserName <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], program <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> , start_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], stop_time <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [ ], dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) / <span class="hljs-number"><span class="hljs-number">3600</span></span>)) + <span class="hljs-string"><span class="hljs-string">':'</span></span> + dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) % <span class="hljs-number"><span class="hljs-number">3600</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>)) + <span class="hljs-string"><span class="hljs-string">':'</span></span> + dbo.FU_GET_FULL_QTY_TEST(<span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">DATEDIFF</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SECOND</span></span>, start_time, stop_time) % <span class="hljs-number"><span class="hljs-number">3600</span></span> % <span class="hljs-number"><span class="hljs-number">60</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> r.Computer, s.UserName, r.programID, r.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> R_ID, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(s.id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> S_ID, r.program, r.Tg <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> start_time, <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(s.Tg) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> stop_time <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eId, Tg, UserName, Computer, image_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> programID, image <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> program <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.WARNING__TABLE_NAME_FOR_CHANGE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (eId = <span class="hljs-number"><span class="hljs-number">4688</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (Tg &gt; <span class="hljs-keyword"><span class="hljs-keyword">CONVERT</span></span>(DATETIME, <span class="hljs-string"><span class="hljs-string">'2013-01-01 00:00:00.000'</span></span>, <span class="hljs-number"><span class="hljs-number">102</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> image <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%.scr'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, eId, Tg, UserName, Computer, image <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> programID, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> program <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.WARNING__TABLE_NAME_FOR_CHANGE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (eId = <span class="hljs-number"><span class="hljs-number">4689</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%.scr'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> r.programID = s.programID <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.program = s.program <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> r.id &lt;= s.id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> r.Computer, s.UserName, r.programID, r.id, r.program, r.Tg) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DERIVEDTBL2 <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">update_result_file7.vbs</font></font></b> <div class="spoiler_text"><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'on error resume next if Wscript.Arguments.Count = 1 then gsFileName = Wscript.Arguments(0) gsFileNameRes = fuRemoveExtention(gsFileName) &amp; ".xls" elseif Wscript.Arguments.Count = 2 then gsFileName = Wscript.Arguments(0) gsFileNameRes = Wscript.Arguments(1) else gsFileName = InputBox("  ", "", "") gsFileNameRes = InputBox(" ", "", fuRemoveExtention(gsFileName) &amp; ".xls") end if sgSimbolSplit = ";" gsSimbolSplitFields = vbTab Set objFSO = CreateObject("Scripting.FileSystemObject") Set objTextFileOpen = objFSO.OpenTextFile(gsFileName, 1) if not objFSO.FileExists(gsFileName) then wscript.echo "    , !" objTextFileOpen.Close Wscript.Quit end if if not objFSO.FileExists(gsFileNameRes) then set objTextFileWriteRes = objFSO.OpenTextFile(gsFileNameRes, 8, True) else set objTextFileWriteRes = objFSO.CreateTextFile(gsFileNameRes, True) end if do until objTextFileOpen.AtEndOfStream record = objTextFileOpen.Readline if ((InStr(record, "--------")) or (Len(record) = 0) or (InStr(record, " ")) or (InStr(record, "rows affected"))) then 'wscript.echo " : '" &amp; record &amp; "'" else if InStr(record, sgSimbolSplit) then recordRes = Replace(record, sgSimbolSplit, gsSimbolSplitFields) else recordRes = record end if objTextFileWriteRes.writeLine recordRes end if loop objTextFileWriteRes.Close objTextFileOpen.Close WScript.Echo " !   " &amp; gsFileNameRes function fuRemoveExtention(lsFilename) lRes = lsFilename if InStr(lsFilename, ".") then lRes = Left(lsFilename, Len(lsFilename)-4) end if fuRemoveExtention = lRes end function</span></span></code> </pre><br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On SQL Server, you need to create the FU_GET_FULL_QTY_TEST function: </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FU_GET_FULL_QTY_TEST</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [quickly] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-comment"><span class="hljs-comment">/****** Object: UserDefinedFunction [dbo].[FU_GET_FULL_QTY_TEST] Script Date: 12/03/2013 13:03:43 ******/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [dbo].[FU_GET_FULL_QTY_TEST] (@short_qty <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @retMsg <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @retMsg = @short_qty <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">len</span></span>(@short_qty) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @retMsg = <span class="hljs-string"><span class="hljs-string">'0'</span></span> + @retMsg <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> (@retMsg) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Archive with scripts can be </font></font><a href="http://yadi.sk/d/ZHTqZWsFDjEfW"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">downloaded here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I know, it seems a lot of batch files and scripts. </font><font style="vertical-align: inherit;">But it‚Äôs enough to set up once and use later</font></font><br><br>  Update. <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Security log settings for saving program start / stop events and event numbers </font></font></h4><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For XP </font></font></h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EventID 592 to create a process, 593 to complete. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audit settings.</font></font><br><pre> <code class="dos hljs">secedit /configure /cfg c:\XP\secsetup.inf /db secsetup.sdb /verbose /overwrite /quiet</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A piece from the secsetup.inf file: </font></font><br><pre> <code class="dos hljs">[Event Audit] ; <span class="hljs-number"><span class="hljs-number">0</span></span> -  ; <span class="hljs-number"><span class="hljs-number">1</span></span> -   ; <span class="hljs-number"><span class="hljs-number">2</span></span> -   ; <span class="hljs-number"><span class="hljs-number">3</span></span> -    AuditSystemEvents = <span class="hljs-number"><span class="hljs-number">3</span></span> AuditLogonEvents = <span class="hljs-number"><span class="hljs-number">3</span></span> AuditObjectAccess = <span class="hljs-number"><span class="hljs-number">3</span></span> AuditPrivilegeUse = <span class="hljs-number"><span class="hljs-number">3</span></span> AuditPolicyChange = <span class="hljs-number"><span class="hljs-number">3</span></span> AuditAccountManage = <span class="hljs-number"><span class="hljs-number">3</span></span> AuditProcessTracking = <span class="hljs-number"><span class="hljs-number">3</span></span> AuditAccountLogon = <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For 7 </font></font></h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EventID 4688 to create a process, 4689 to complete. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Audit settings. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For Russian:</font></font><br><pre> <code class="dos hljs">auditpol.exe /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /category:" " /subcategory:" " /success:enable /failure:enable auditpol.exe /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /category:" " /subcategory:" " /success:enable /failure:enable</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For English: </font></font><br><pre> <code class="dos hljs">auditpol.exe /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /category:"Detailed Tracking" /subcategory:"Process Creation" /success:enable /failure:enable auditpol.exe /<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /category:"Detailed Tracking" /subcategory:"Process Termination" /success:enable /failure:enable</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of course, if there is a domain, the audit settings should be specified in the domain policies. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And who does how to report on the launch of programs on users' computers? </font><font style="vertical-align: inherit;">Share it.</font></font></div><p>Source: <a href="https://habr.com/ru/post/202914/">https://habr.com/ru/post/202914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202904/index.html">Budget VDS for training and development</a></li>
<li><a href="../202906/index.html">Livejack blackjack</a></li>
<li><a href="../202908/index.html">Automatic spell checker, model Noisy Channel</a></li>
<li><a href="../202910/index.html">Automatic testing of iOS applications</a></li>
<li><a href="../202912/index.html">Electronic devices can be used in flight in the USA and Europe.</a></li>
<li><a href="../202918/index.html">November's new items in Opera: version for tablets and synchronization</a></li>
<li><a href="../202922/index.html">We extract gold from old electronics</a></li>
<li><a href="../202924/index.html">Escape from the ‚ÄúOthers‚Äù column: local brands increase market share</a></li>
<li><a href="../202926/index.html">Microprocessor software simulation. Transmission</a></li>
<li><a href="../202928/index.html">TC MUK announced pre-holiday discount on the course VMware Vsphere Fast Track</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>