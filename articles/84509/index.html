<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introducing the libevent library on the example of creating a simple Web image server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will show how to use the libevent library to write a simple Web server that will issue jpeg image files at the request of clients. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introducing the libevent library on the example of creating a simple Web image server</h1><div class="post__text post__text-html js-mediator-article"> In this article, I will show how to use the <a href="http://www.monkey.org/~provos/libevent/">libevent</a> library to write a simple Web server that will issue jpeg image files at the request of clients. <br><br>  The <i>libevent</i> library provides programmers with access to the cross-platform asynchronous network API.  Based on this library, you can create high-performance network applications.  For example, <i>libevent is</i> used in such well-known applications as <a href="http://memcached.org/">Memcached</a> (distributed caching system) and <a href="http://www.torproject.org/">TOR</a> (distributed anonymous network). <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Download server code <a href="">here</a> . <br><br>  <b>Let's start the code review with the main () function:</b> <br><br> <code><a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"></a> <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"></a> 75:int main (int argc, char *argv[]) <br> 76:{ <br> 77: struct event_base *ev_base; <br> 78: struct evhttp *ev_http; <br> 79: <br> 80: if (argc != 3) { <br> 81:     printf ("Usage: %s host port\n", argv[0]); <br> 82:     exit (1); <br> 83: } <br> 84: <br> 85: ev_base = event_init (); <br> 86: <br> 87: ev_http = evhttp_new (ev_base); <br> 88: if (evhttp_bind_socket (ev_http, argv[1], (u_short)atoi (argv[2]))) { <br> 89:     printf ("Failed to bind %s:%s\n", argv[1], argv[2]); <br> 90:     exit (1); <br> 91: } <br> 92: evhttp_set_cb (ev_http, "/img", http_img_cb, NULL); <br> 93: <br> 94: event_base_dispatch (ev_base); <br> 95: <br> 96: return 0; <br> 97:}</code> <br> <br>  Our Web server will take two parameters from the command line: the IP address and port that the server will listen on.  Lines 80-83 check the number of parameters passed from the command line.  Do not forget that the first element of the <i>argv []</i> array is always the name of the application itself. <br><br>  Line 85 initializes the <i>libevent</i> library, returns a pointer to the " <i>struct event_base</i> " data structure.  In all further calls to the library functions of the <i>libevent</i> , this variable will have to be passed. <br><br>  From 87 to 92 lines, an HTTP server is created, and a function is called that initializes the tapping on the address transmitted on the command line.  If suddenly this address is already being listened by some other application or we do not have rights to occupy this address (forget that ports up to 1024 can only be occupied by an application running as root), the program displays a message on the screen and terminates.  Next, we set the callback function for the "/ img" URI. <br><br>  The entire library of <i>libevent is</i> built on the basis of the so-called "callback" functions (callback functions), they work as follows: suppose we want that when an event occurs ("event" is English. "Event", hence the name of the library ) our function was called.  To do this, we use the <i>libevent</i> API, register our function for a specific event (this could be a timer event, socket readiness to receive data, request a URI, etc.).  Later, upon the occurrence of this event, our function is called, which receives all the necessary parameters. <br><br>  Line 94 starts the event loop.  In our example, the cycle will be executed an infinite number of times, since we have not provided for the completion of the HTTP server.  In order to exit this cycle and shut down the server, you will need to press CTRL + C in the console. <br><br>  <b>Now consider the processing of the "/ img" HTTP request:</b> <br><br> <code><a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"></a> 13:static void http_img_cb (struct evhttp_request *request, void *ctx) <br> 14:{ <br> 15: struct evbuffer *evb; <br> 16: int fd; <br> 17: const char *fname; <br> 18: struct stat stbuf; <br> 19: int total_read_bytes, read_bytes; <br> 20: struct evkeyvalq uri_params; <br> 21: <br> 22: evb = evbuffer_new (); <br> 23: <br> 24: printf ("Request from: %s:%d URI: %s\n", request-&gt;remote_host, request-&gt;remote_port, request-&gt;uri); <br> 25: <br> 26: evhttp_parse_query (request-&gt;uri, &amp;uri_params); <br> 27: fname = evhttp_find_header (&amp;uri_params, "name"); <br> 28: <br> 29: if (!fname) { <br> 30:     evbuffer_add_printf (evb, "Bad request"); <br> 31:     evhttp_send_reply (request, HTTP_BADREQUEST, "Bad request", evb); <br> 32:     evhttp_clear_headers (&amp;uri_params); <br> 33:     evbuffer_free (evb); <br> 34:     return; <br> 35: }</code> <br> <br>  Stork 13 declares the "callback" function <i>http_img_cb ().</i>  When the function is called, it, as an argument, is passed a pointer to a <i>struct evhttp_request</i> structure, which contains all the necessary information about the HTTP request and a pointer to user data.  In our example, the variable " <i>ctx</i> " is not used. <br>  Line 22 initializes a variable of type " <i>struct evbuffer</i> *". <br><br>  In <i>libevent,</i> the ‚Äú <i>struct evbuffer</i> ‚Äù structure is the main type for working with Input / Output data (‚ÄúI / O‚Äù).  The API for working with ‚Äú <i>struct evbuffer</i> ‚Äù allows you to efficiently read, write and search data. <br><br>  Line 26 calls the <i>libevent</i> function ‚Äú <i>evhttp_parse_query</i> ()‚Äù, which takes the string URI and returns a list with the values ‚Äã‚Äã‚Äúkey‚Äù ‚Üí ‚Äúvalue‚Äù from the URI parameters.  For example, if the request ‚Äúhttp: // serverIP: port / img? Aa = bb &amp; cc = dd‚Äù <i>occurred</i> and called the function ‚Äú <i>evhttp_parse_query (request-&gt; uri, &amp; uri_params)</i> ‚Äù, then ‚Äúuri_params‚Äù will contain ‚Äúaa‚Äù ‚Üí ‚Üí pairs bb "," cc "‚Üí" dd ".  The <i>libevent</i> API contains several functions for working with the ‚Äú <i>struct evkeyvalq</i> ‚Äù type. <br><br>  Line 27 calls one of these functions, which takes a pointer to a <i>struct evkeyvalq</i> structure and a key string.  The function returns the key value or " <i>NULL</i> " if such a key is not found.  In our case, we will accept the key "name" in the URI parameters, which will contain the name of the required file. <br><br>  Lines 29-35 verify that the ‚Äúname‚Äù key is specified in the URI parameters.  If it is not specified, we, using the ‚Äú <i>evhttp_send_reply</i> ()‚Äù function, <i>send</i> the response to the client with the HTTP code 400 and the message for the user ‚ÄúBad request‚Äù.  Next, we call the function ‚Äú <i>evhttp_clear_headers</i> ()‚Äù to clear the list ‚Äúkey‚Äù ‚Üí ‚Äúvalue‚Äù and the function ‚Äú <i>evbuffer_free</i> ()‚Äù to release the memory occupied by the structure ‚Äú <i>struct evbuffer</i> ‚Äù and exit the function. <br><br>  The function ‚Äú <i>evhttp_send_reply</i> ()‚Äù is the main way of sending HTTP messages to clients, in parameters it accepts a pointer to the structure ‚Äú <i>struct evhttp_request</i> ‚Äù, HTTP code (there are several predefined constants with HTTP codes in <i>libevent</i> ), a string with a short text message for the browser and a pointer to structure " <i>struct evbuffer</i> " - this data will be directly displayed to the client. <br><br> <code>37: if ((fd = open (fname, O_RDONLY)) &lt; 0) { <br> 38:     evbuffer_add_printf (evb, " File %s not found", fname); <br> 39:     evhttp_send_reply (request, HTTP_NOTFOUND, "File not found", evb); <br> 40:     evhttp_clear_headers (&amp;uri_params); <br> 41:     evbuffer_free (evb); <br> 42:     return; <br> 43: } <br> 44: if (fstat (fd, &amp;stbuf) &lt; 0) { <br> 45:     evbuffer_add_printf (evb, "File %s not found", fname); <br> 46:     evhttp_send_reply (request, HTTP_NOTFOUND, "File not found", evb); <br> 47:     evhttp_clear_headers (&amp;uri_params); <br> 48:     evbuffer_free (evb); <br> 49:     close (fd); <br> 50:     return; <br> 51: }</code> <br> <br>  Lines 37-51 open the file for reading.  The file name is taken from the parameter "name".  Next, the function ‚Äú <i>fstat</i> ()‚Äù is called, which returns various system information about the file.  If an error occurred in any of the functions, then we send the response to the client with the HTTP code 404 and the message ‚ÄúFile not found‚Äù for the user, release the memory and exit the function. <br><br> <code>53: total_read_bytes = 0; <br> 54: while (total_read_bytes &lt; stbuf.st_size) { <br> 55:     read_bytes = evbuffer_read (evb, fd, stbuf.st_size); <br> 56:     if (read_bytes &lt; 0) { <br> 57:         evbuffer_add_printf (evb, "Error reading file %s", fname); <br> 58:         evhttp_send_reply (request, HTTP_NOTFOUND, "File not found", evb); <br> 59:         evhttp_clear_headers (&amp;uri_params); <br> 60:         evbuffer_free (evb); <br> 61:         close (fd); <br> 62:         return; <br> 63:     } <br> 64:     total_read_bytes += read_bytes; <br> 65: }</code> <br> <br>  Lines 53-65 read data from an open file into a <i>struct evbuffer</i> structure.  The function ‚Äú <i>evbuffer_read</i> ()‚Äù takes in the parameters a pointer to the structure ‚Äú <i>struct evbuffer</i> ‚Äù, the descriptor of the open file, and how many bytes to read.  The function returns the number of bytes read from the file.  It is possible that the file is too large and cannot be considered as a single call of ‚Äú <i>evbuffer_read</i> ()‚Äù, then we cycle check the number of bytes already read with the file size obtained from the call of ‚Äú <i>fstat</i> ()‚Äù and, if necessary, repeat reading. <br><br> <code>66: evhttp_add_header (request-&gt;output_headers, "Content-Type", "image/jpeg"); <br> 67: evhttp_send_reply (request, HTTP_OK, "HTTP_OK", evb); <br> 68: <br> 69: evhttp_clear_headers (&amp;uri_params); <br> 70: evbuffer_free (evb); <br> 71: close (fd); <br> 72:}</code> <br> <br>  Lines 66-72 send the contents of the file to the client with the HTTP code 200. Pre-adding the header ‚ÄúContent-Type: image / jpeg‚Äù to the HTTP response, this is necessary so that the client's browser correctly displays the contents of the picture.  After that, we release the memory, close the file and exit the function. <br><br>  <b>Build and test.</b> <br><br>  Copy to the current directory a couple of jpeg images and remember the file names. <br><br>  To compile this code, you need to install the <i>libevent</i> version 1.4.XX library on your computer (replace XX with the latest available version).  On some Linux distributions, you will need to install the ‚Äú <i>libevent-dev</i> ‚Äù package. Examples: <br>  for Gentoo: <code>emerge libevent</code> <br>  for Ubuntu: <code>aptitude install libevent-dev</code> <br><br>  After the library is installed, save the program code to the main.c file and you can try to compile: <br> <code>gcc main.c -o web_server -levent</code> <br> <br>  If there were no errors, then the web_server file will appear in your current directory.  Run it with the parameters IP address and port, for example: <br> <code>./web_server 127.0.0.1 8090</code> <br> <br>  Now, on your machine, open any browser and enter the following URL: <code><a href="http://127.0.0.1:8090/img%3Fname%3D%25D0%25B8%25D0%25BC%25D1%258F_jpeg_%25D0%25BA%25D0%25B0%25D1%2580%25D1%2582%25D0%25B8%25D0%25BD%25D0%25BA%25D0%25B8"></a> http://127.0.0.1:8090/img?name=_jpeg_</code> <br>  Should seem a picture.  Hooray, you just created a web server! <br><br>  <b>A little about security.</b> <br>  The web server in this form is not suitable for use on the Internet, since there is no check for which file is being accessed.  Suppose you can send such a request: " <code><a href=""></a> http://serverIP:port/img?name=/etc/passwd</code>  <code><a href=""></a> http://serverIP:port/img?name=/etc/passwd</code> "and the file with the list of users of the system will be sent to the client.  I deliberately omitted safety considerations, as this is the topic of a whole separate article.  I can only advise that it is completely safe to run such a Web server in a ‚Äú <i>chroot</i> ‚Äù environment, after having compiled it with the ‚Äú <i>-static</i> ‚Äù flag. <br><br>  <b>What's next.</b> <br>  Perhaps, I will soon write a sequel about the development of a simple Web-server, where I will show how you can cache image files.  Just recently I started writing an article where I want to tell you how to organize the interaction between the server and the Flash client using the binary protocol and the <i>libevent</i> API. <br>  There are many different interesting things that can be done using the <i>libevent</i> API.  The main thing that distinguishes the development of programs using <i>libevent</i> is the simplicity and at the same time the efficiency and speed of the execution of the programs obtained.  Be sure to read the book <a href="http://www.wangafu.net/~nickm/libevent-book/TOC.html">Learning Libevent</a> .  Successful coding! <br><br>  PS Code light for some reason is not displayed; / </div><p>Source: <a href="https://habr.com/ru/post/84509/">https://habr.com/ru/post/84509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../84504/index.html">Air trade: a new round</a></li>
<li><a href="../84505/index.html">Turning HTC Hero into HTPC</a></li>
<li><a href="../84506/index.html">NOMOBILE.RU at MWC-2010. Second day</a></li>
<li><a href="../84507/index.html">Structuring Aspects 2</a></li>
<li><a href="../84508/index.html">Russian commercial applications on Facebook</a></li>
<li><a href="../84510/index.html">KDE Project Announces Javascript Widget Design Contest</a></li>
<li><a href="../84511/index.html">Vancouver 2010 Winter Olympics Playable</a></li>
<li><a href="../84517/index.html">Twitter Reactions or what is Twitter twittering about this page?</a></li>
<li><a href="../84518/index.html">Significantly reduce the noise level from the computer in 3 minutes</a></li>
<li><a href="../84520/index.html">Player IconBit HDS41L - modernization of the cooling system</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>