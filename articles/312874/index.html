<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Package for working with Firebird in Laravel</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! In the last article, I talked about how you can add support for Firebird in Laravel. At that moment I did not know about the existence of the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Package for working with Firebird in Laravel</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/58a/d6a/892/58ad6a89257741fc805ae36d811346d5.png" alt="firebird-logo" align="left" width="250">  Hi Habr!  In the last <a href="https://habrahabr.ru/post/311446/">article,</a> I talked about how you can add support for Firebird in Laravel.  At that moment I did not know about the existence of the <a href="https://github.com/jacquestvanzuydam/laravel-firebird">jacquestvanzuydam / laravel-firebird package</a> and added Firebird support from scratch.  This was done through the modification of the Laravel core files, for which I was rightly criticized.  Looking at the jacquestvanzuydam / laravel-firebird package, I realized that its capabilities do not suit me, and decided to expand it. <br><br>  In this article I want to describe the main functional differences between my <a href="https://github.com/sim1984/laravel-firebird">sim1984 / laravel-firebird</a> package and the jacquestvanzuydam / laravel-firebird package. <br><a name="habracut"></a><br><h2>  Auto-increment column support </h2><br>  The most important disadvantage of the original package is the lack of support for auto-increment columns in the migration.  In my package, support for auto-increment columns is implemented in two ways.  The first method is classic for Firebird.  In this method, when creating an auto-increment column, a sequence (generator) and a BEFORE INSERT trigger are automatically created.  The following PHP script <br><br><pre><code class="php hljs">Schema::create(<span class="hljs-string"><span class="hljs-string">'users'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blueprint $table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;increments(<span class="hljs-string"><span class="hljs-string">'id'</span></span>); $table-&gt;string(<span class="hljs-string"><span class="hljs-string">'name'</span></span>); $table-&gt;string(<span class="hljs-string"><span class="hljs-string">'email'</span></span>)-&gt;unique(); $table-&gt;string(<span class="hljs-string"><span class="hljs-string">'password'</span></span>); $table-&gt;rememberToken(); $table-&gt;timestamps(); });</code> </pre> <br>  will generate and execute the following SQL statements 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"email"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"remember_token"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), <span class="hljs-string"><span class="hljs-string">"created_at"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, <span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">"users_email_unique"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-string"><span class="hljs-string">"email"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> <span class="hljs-string"><span class="hljs-string">"seq_users"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> <span class="hljs-string"><span class="hljs-string">"tr_users_bi"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> ACTIVE <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (NEW.<span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> NEW.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">NEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-string"><span class="hljs-string">"seq_users"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br>  The second method works starting with Firebird 3.0.  In this case, the IDENTITY field is used instead of a sequence and a trigger.  The following PHP script <br><br><pre> <code class="php hljs"> Schema::create(<span class="hljs-string"><span class="hljs-string">'users'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blueprint $table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;useIdentity(); <span class="hljs-comment"><span class="hljs-comment">// only Firebird 3.0 $table-&gt;increments('id'); $table-&gt;string('name'); $table-&gt;string('email')-&gt;unique(); $table-&gt;string('password'); $table-&gt;rememberToken(); $table-&gt;timestamps(); });</span></span></code> </pre><br>  Generates and executes the following SQL statements. <br><br><pre> <code class="sql hljs"> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GENERATED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"email"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"remember_token"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), <span class="hljs-string"><span class="hljs-string">"created_at"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, <span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">"users_email_unique"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-string"><span class="hljs-string">"email"</span></span>);</code> </pre><br><h2>  INSERT support ... RETURNING </h2><br>  The Firebird \ Schema \ Grammars \ FirebirdGrammar grammar is expanded by the compileInsertGetId method, which is intended for building an INSERT query with the return of the identifier of the newly added string. <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Compile an insert and get ID statement into SQL. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Illuminate\Database\Query\Builder $query * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $values * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $sequence * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileInsertGetId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Builder $query, $values, $sequence)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_null($sequence)) { $sequence = <span class="hljs-string"><span class="hljs-string">'id'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;compileInsert($query, $values) . <span class="hljs-string"><span class="hljs-string">' returning '</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;wrap($sequence); }</code> </pre><br>  It was found out here that INSERT ... RETURNING does not work through PDO driver with Fireird 3.0.  Previously, it was manifested as <a href="https://bugs.php.net/bug.php%3Fid%3D72931">https://bugs.php.net/bug.php?id=72931</a> .  On the last snapshot, the behavior has changed and now the driver produces an SQLSTATE [HY000] error: General error: -502 Cursor is not open.  Obviously, PDO can only return data from cursors (indirectly hinted at by the PDOStatement :: fetch () method).  Interestingly, this worked in firebird 2.5.  So in the API, which must be compatible, somewhere there have been changes that have affected the performance. <br><br>  I decided to trick the PDO by reworking the query so that the cursor would return.  To do this, we wrap our INSERT ... RETURNING operator into an anonymous PSQL block (EXECUTE BLOCK).  There is one unpleasant feature.  The fact is that in order to support the named parameters, the PDO does the replacement of all variables of the form: VARNAME with ‚Äú?‚Äù.  This spoils the contents of the body of the anonymous block.  Such a replacement would work correctly if it were made only between the keywords EXECUTE BLOCK and AS.  Another way is to replace the marker variables, as it is done in some other components of access.  Unfortunately the PDO does not have the ability to change the variable token.  Therefore, I had to find a way to avoid the ‚Äú:‚Äù symbol inside the block body.  Since this should be done only for Firebird 3.0, I allocated a separate FirebirdGrammar30 grammar for it, and added a special method to determine the version of Firebird.  In addition, a separate grammar will allow us to better use the new features of Firebird 3.0.  I will give a code that fixes a bug with INSERT ... RETURNING <br><br><pre> <code class="php hljs"> <span class="hljs-comment"><span class="hljs-comment">/** * Fix PDO driver bug for 'INSERT ... RETURNING' * See https://bugs.php.net/bug.php?id=72931 * Reproduced in Firebird 3.0 only * Remove when the bug is fixed! * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> \Illuminate\Database\Query\Builder $query * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $values * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $sequence * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $sql */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fixInsertReturningBug</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Builder $query, $values, $sequence, $sql)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* * Since the PDO Firebird driver bug because of which is not executed * sql query 'INSERT ... RETURNING', then we wrap the statement in * the block and execute it. PDO may not recognize the colon (:) within * a block properly, so we will not use it. The only way I found * buyout perform a query via EXECUTE STATEMENT. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array(reset($values))) { $values = [$values]; } $table = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;wrapTable($query-&gt;from); $columns = array_map([<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, <span class="hljs-string"><span class="hljs-string">'wrap'</span></span>], array_keys(reset($values))); $columnsWithTypeOf = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($columns <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $column) { $columnsWithTypeOf[] = <span class="hljs-string"><span class="hljs-string">" {$column} TYPE OF COLUMN {$table}.{$column} = ?"</span></span>; } $ret_column = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;wrap($sequence); $columns_str = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;columnize(array_keys(reset($values))); $new_sql = <span class="hljs-string"><span class="hljs-string">"EXECUTE BLOCK (\n"</span></span>; $new_sql .= implode(<span class="hljs-string"><span class="hljs-string">",\n"</span></span>, $columnsWithTypeOf); $new_sql .= <span class="hljs-string"><span class="hljs-string">")\n"</span></span>; $new_sql .= <span class="hljs-string"><span class="hljs-string">"RETURNS ({$ret_column} TYPE OF COLUMN {$table}.{$ret_column})\n"</span></span>; $new_sql .= <span class="hljs-string"><span class="hljs-string">"AS\n"</span></span>; $new_sql .= <span class="hljs-string"><span class="hljs-string">" DECLARE STMT VARCHAR(8191);\n"</span></span>; $new_sql .= <span class="hljs-string"><span class="hljs-string">"BEGIN\n"</span></span>; $new_sql .= <span class="hljs-string"><span class="hljs-string">" STMT = '{$sql}';\n"</span></span>; $new_sql .= <span class="hljs-string"><span class="hljs-string">" EXECUTE STATEMENT (STMT) ({$columns_str})\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$query-&gt;getConnection()-&gt;getPdo()-&gt;inTransaction()) { <span class="hljs-comment"><span class="hljs-comment">// For some unknown reason, there is a ROLLBACK. Probably due to the COMMIT RETAINING. $new_sql .= " WITH AUTONOMOUS TRANSACTION\n"; } $new_sql .= " INTO {$ret_column};\n"; $new_sql .= " SUSPEND;\n"; $new_sql .= "END"; return $new_sql; } /** * Compile an insert and get ID statement into SQL. * * @param \Illuminate\Database\Query\Builder $query * @param array $values * @param string $sequence * @return string */ public function compileInsertGetId(Builder $query, $values, $sequence) { $sql = parent::compileInsertGetId($query, $values, $sequence); // Fix PDO driver bug for 'INSERT ... RETURNING' // See https://bugs.php.net/bug.php?id=72931 $sql = $this-&gt;fixInsertReturningBug($query, $values, $sequence, $sql); return $sql; }</span></span></code> </pre><br><table><tbody><tr><td><h4>  Comment </h4><br>  I absolutely do not like this method.  I hope that in the future the bug will be fixed and this temporary solution can be removed. <br></td></tr></tbody></table><h2>  Work with sequences </h2><br>  Sometimes there is a need to work with a sequence generated not using Laravel migrations, for example, you can work with a ready-made database.  In some cases, the same sequence can be used by several tables.  You can use an arbitrary sequence name in your models using the extended Firebird \ Eloquent \ Model.  In this model, there is an additional property $ sequence that will contain the name of the desired sequence. <br><br>  Example: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Firebird</span></span>\<span class="hljs-title"><span class="hljs-title">Eloquent</span></span>\<span class="hljs-title"><span class="hljs-title">Model</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Customer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** *     * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $table = <span class="hljs-string"><span class="hljs-string">'CUSTOMER'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *    * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $primaryKey = <span class="hljs-string"><span class="hljs-string">'CUSTOMER_ID'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Indicates if the model should be timestamped. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $timestamps = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *       * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $sequence = <span class="hljs-string"><span class="hljs-string">'GEN_CUSTOMER_ID'</span></span>; }</code> </pre><br>  In the base model, the insertAndSetId method is redefined, which does not use INSERT ... RETURNING, but receives the next sequence number and uses it in a normal INSERT query.  The use of this model also makes it possible not to use the not-so-beautiful INSERT solution ... RETURNING in Firebird 3.0. <br><br>  As I said, sequences are completely independent metadata objects in Firebird, so it would be nice to be able to manage them through Laravel migrations.  For this, the Firebird \ Schema \ SequenceBlueprint class was written.  Let's see how this works on the example of such a migration. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Firebird</span></span>\<span class="hljs-title"><span class="hljs-title">Schema</span></span>\<span class="hljs-title"><span class="hljs-title">Blueprint</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Firebird</span></span>\<span class="hljs-title"><span class="hljs-title">Schema</span></span>\<span class="hljs-title"><span class="hljs-title">SequenceBlueprint</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Database</span></span>\<span class="hljs-title"><span class="hljs-title">Migrations</span></span>\<span class="hljs-title"><span class="hljs-title">Migration</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateUsersTable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Run the migrations. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Schema::createSequence(<span class="hljs-string"><span class="hljs-string">'seq_users_id'</span></span>); Schema::create(<span class="hljs-string"><span class="hljs-string">'users'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Blueprint $table)</span></span></span><span class="hljs-function"> </span></span>{ $table-&gt;integer(<span class="hljs-string"><span class="hljs-string">'id'</span></span>)-&gt;primary(); $table-&gt;string(<span class="hljs-string"><span class="hljs-string">'name'</span></span>); $table-&gt;string(<span class="hljs-string"><span class="hljs-string">'email'</span></span>)-&gt;unique(); $table-&gt;string(<span class="hljs-string"><span class="hljs-string">'password'</span></span>); $table-&gt;rememberToken(); $table-&gt;timestamps(); }); Schema::sequence(<span class="hljs-string"><span class="hljs-string">'seq_users_id'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceBlueprint $sequence)</span></span></span><span class="hljs-function"> </span></span>{ $sequence-&gt;increment(<span class="hljs-number"><span class="hljs-number">5</span></span>); $sequence-&gt;restart(<span class="hljs-number"><span class="hljs-number">10</span></span>); }); } <span class="hljs-comment"><span class="hljs-comment">/** * Reverse the migrations. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Schema::dropSequence(<span class="hljs-string"><span class="hljs-string">'seq_users_id'</span></span>); Schema::drop(<span class="hljs-string"><span class="hljs-string">'users'</span></span>); } }</code> </pre><br>  Rolling out such a migration will result in the execution of the following SQL statements: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> <span class="hljs-string"><span class="hljs-string">"seq_users_id"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> ( <span class="hljs-string"><span class="hljs-string">"id"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"email"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">"remember_token"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>), <span class="hljs-string"><span class="hljs-string">"created_at"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span>, <span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">"id"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> <span class="hljs-string"><span class="hljs-string">"users_email_unique"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (<span class="hljs-string"><span class="hljs-string">"email"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> <span class="hljs-string"><span class="hljs-string">"seq_users_id"</span></span> RESTART <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INCREMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>;</code> </pre><br>  Migration rollback will execute the following statements: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> <span class="hljs-string"><span class="hljs-string">"seq_users_id"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">"users"</span></span>;</code> </pre><br><h2>  Advanced configuration options </h2><br>  Our package has added two additional configuration parameters to configure the connection: <br><br><ul><li>  role - the name of the role that will connect to the database; </li><li>  engine_version - version of Firebird.  This optional parameter allows you to not make an additional request to the server to determine the version of Firebird. </li></ul><br>  Example: <br><br><pre> <code class="php hljs"> <span class="hljs-string"><span class="hljs-string">'connections'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'firebird'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'driver'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'firebird'</span></span>, <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; env(<span class="hljs-string"><span class="hljs-string">'DB_HOST'</span></span>, <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>), <span class="hljs-string"><span class="hljs-string">'port'</span></span> =&gt; env(<span class="hljs-string"><span class="hljs-string">'DB_PORT'</span></span>, <span class="hljs-string"><span class="hljs-string">'3050'</span></span>), <span class="hljs-string"><span class="hljs-string">'database'</span></span> =&gt; env(<span class="hljs-string"><span class="hljs-string">'DB_DATABASE'</span></span>, <span class="hljs-string"><span class="hljs-string">'examples'</span></span>), <span class="hljs-string"><span class="hljs-string">'username'</span></span> =&gt; env(<span class="hljs-string"><span class="hljs-string">'DB_USERNAME'</span></span>, <span class="hljs-string"><span class="hljs-string">'BOSS'</span></span>), <span class="hljs-string"><span class="hljs-string">'password'</span></span> =&gt; env(<span class="hljs-string"><span class="hljs-string">'DB_PASSWORD'</span></span>, <span class="hljs-string"><span class="hljs-string">'qw897tr'</span></span>), <span class="hljs-string"><span class="hljs-string">'role'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'RDB$ADMIN'</span></span>, <span class="hljs-string"><span class="hljs-string">'charset'</span></span> =&gt; env(<span class="hljs-string"><span class="hljs-string">'DB_CHARSET'</span></span>, <span class="hljs-string"><span class="hljs-string">'UTF8'</span></span>), <span class="hljs-string"><span class="hljs-string">'engine_version'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3.0.0'</span></span>, ], ],</code> </pre><br><h2>  Features of installation through composer </h2><br>  Since my package is a fork of the <a href="https://github.com/jacquestvanzuydam/laravel-firebird">jacquestvanzuydam / laravel-firebird package</a> , its installation is somewhat different.  As with the installation of the original package, do not forget to set the minimum-stability parameter in composer.json equal to dev.  Next you need to add a link to the repository: <br><br><pre> <code class="javascript hljs"> <span class="hljs-string"><span class="hljs-string">"repositories"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"package"</span></span>, <span class="hljs-string"><span class="hljs-string">"package"</span></span>: { <span class="hljs-string"><span class="hljs-string">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"dev-master"</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"sim1984/laravel-firebird"</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://github.com/sim1984/laravel-firebird"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"git"</span></span>, <span class="hljs-string"><span class="hljs-string">"reference"</span></span>: <span class="hljs-string"><span class="hljs-string">"master"</span></span> }, <span class="hljs-string"><span class="hljs-string">"autoload"</span></span>: { <span class="hljs-string"><span class="hljs-string">"classmap"</span></span>: [<span class="hljs-string"><span class="hljs-string">""</span></span>] } } } ],</code> </pre><br>  Then add the following line to the require parameter: <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"sim1984/laravel-firebird"</span></span>: <span class="hljs-string"><span class="hljs-string">"dev-master"</span></span></code> </pre> <br><h2>  Conclusion </h2><br>  I hope that my package has sufficient functionality for developing applications using Firebird DBMS.  If you have questions and suggestions for improving the package <a href="https://github.com/sim1984/laravel-firebird">sim1984 / laravel-firebird</a> write in a personal, be sure to answer.  In the next article I will discuss how to create a small application using Laravel and Firebird DBMS. </div><p>Source: <a href="https://habr.com/ru/post/312874/">https://habr.com/ru/post/312874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312862/index.html">Banks are adapting the blockchain faster than they could have imagined.</a></li>
<li><a href="../312864/index.html">How to reduce the response time to users in social networks?</a></li>
<li><a href="../312868/index.html">Video chat via browser. WebRTC is easy if there is a library</a></li>
<li><a href="../312870/index.html">How we built our mini data center. Part 3 - Relocation</a></li>
<li><a href="../312872/index.html">Cremes rootkit scan</a></li>
<li><a href="../312876/index.html">Hybrid Android apps for kids</a></li>
<li><a href="../312878/index.html">ASP.NET Core: Creating your first web API using ASP.NET Core MVC and Visual Studio</a></li>
<li><a href="../312880/index.html">Math in javascript</a></li>
<li><a href="../312882/index.html">Anatomy of KD-Trees</a></li>
<li><a href="../312884/index.html">A brief history of the gaming industry by platform</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>