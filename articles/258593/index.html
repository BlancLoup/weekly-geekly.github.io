<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On the issue of programming style</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""If we consider the scale of spiritual values ‚Äã‚Äãin descending order, there are 
 Things In The Order Of Things Exist 
 Things Unpleasant, But Basicall...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On the issue of programming style</h1><div class="post__text post__text-html js-mediator-article"><h1>  "If we consider the scale of spiritual values ‚Äã‚Äãin descending order, there are <br>  Things In The Order Of Things Exist <br>  Things Unpleasant, But Basically Permissible, and Exist <br>  Things that tolerate in no way impossible. "  - Midianin </h1><br>  In the words of the notorious classic "I can not be silent." <br>  Recently I looked at the source texts on the site of a fairly well-known manufacturer and saw the following code <pre><code class="cpp hljs">*(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *)<span class="hljs-number"><span class="hljs-number">0xf80ff000</span></span> &amp;= <span class="hljs-number"><span class="hljs-number">0xffffefff</span></span>;</code> </pre>  Not hoping that these notes will be read in the distant "India" (see note below) (one gets the feeling that they do not know how to read), I would nevertheless like to warn young engineers not to do so. <br><br>  A note from today - I sketched this post more than a month ago, all hands did not reach to bring it to an acceptable form, so I can‚Äôt specify the source, well, yes Inet will help you - there is a little less such code than a lot. <br><a name="habracut"></a><br>  There is a sea of ‚Äã‚Äãliterature in which it is written how one can and should do (well, so who reads it, there are a lot of letters), I highly recommend the MISRA standards, but such software constructs are not even considered there, since they lie on the other side of the border that separates good from evil  But, since such constructions are still encountered, and children can see them (and Ineta‚Äôs correct censorship is still not established), you will probably have to explain once again why this cannot be done. <br><br>  First of all, let us understand what our distant Indian colleagues wanted to make this code fragment (the author is not a chauvinist at all and is ready to admit that the code was written by Chinese, American or Russian programmers, just the Hindu code became a common noun).  Obviously, they wanted to reset bit number 12 (counting from 0) in the word with the hexadecimal address f80ff000.  Most likely, there is a register of some external device, and, most likely, they reset the readiness bit, which, however, is absolutely unimportant.  So, in itself, the operation is not so terrible to push the author to a lengthy post, and, nevertheless, we will begin the debriefing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First of all, in one line 2 magic constants were used at once - for the address and for the data.  It is hard for me to believe that nowhere else in the program will there be a single reference to this register (the way it is, such lines can be seen further on the source code) and therefore the use of the magic constant does not have the slightest justification.  As you know, #define was invented precisely for this purpose, and although lately I have seen quite a few convincing materials about the need to use constants from the enum list instead of it, even the most unfortunate use of define is better than what we see. <br><br>  Further, the data is used not just in the form of a magic constant, but it is clearly a transformed constant, that is, an inversion from a bitmask.  The only argument that I could invent in favor of such a decision is to reduce the compilation time, but this assumption seems to me so vanishingly insignificant as to the reason that it is given solely for theoretical purposes (well, to emphasize the author‚Äôs objectivity and his condescension to human weakness). <br><br>  Well, yes, I forgot one more argument of constant supporters - named constants clutter up the compiler name table and increase the requirements for RAM size at compile time.  I don‚Äôt laugh, I really heard such an argument from a kind of sane person, then it turned out that it was subtle trolling (but a dozen unpleasant seconds brought it to me - could I SO IN wrong person). <br><br>  At this point, we stop trying to justify the authors of such a code (yes, I didn‚Äôt really try) and by the method of successive approximations we go to the normal code. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CsrReg *(unsigned int *)0xf80ff000 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//  , . 127 #define CsrRegReady 0x1000 //   CsrReg &amp;= ~CsrRegReady;</span></span></span></span></code> </pre>  already looks better, and we are not even in the middle of the road, although some will stop there.  What is wrong with this snippet?  First of all, the direct inversion operation, if you are a happy person, you will never miss it when writing.  I'm not so happy (maybe not as attentive and as collected as you are), so I used to miss the tilde, and then run around the code in search of a place of error. <br><br>  Therefore, our macros are all (well, or inline functions, if you switched to pluses) <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RegBitClr(REG,MASK) (REG) &amp;= ~(MASK) RegBitClr(CsrReg,CsrRegReady);</span></span></code> </pre>  (I know that the names of the macros should be written in capital letters, and even understand the arguments in favor of this statement, but I do not accept them - I am an artist, I see that).  In order to understand what is wrong here, it would be nice to see the generated code with optimization turned on for the next fragment. <br><pre> <code class="cpp hljs"> RegBitClr(CsrReg,CsrRegReady); RegBitClr(CsrReg,~CsrRegReady); <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre>  I will not give it, you just have to take my word for it that the first line is ignored, and the second generates a code equivalent to the expression CSrReg = 0.  Indeed, from the point of view of the compiler, in the first line we dropped all the bits except 12, and in the second we dropped it, that is, there would be zero. <br><br>  But in reality, this is absolutely not obvious, since we are dealing with a register, that is, we need a direct indication to the compiler of the changeable nature of the variable and we get <pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CsrAdr (unsigned int *)0xf80ff000 volatile unsigned int * const CsrReg = CsrAdr; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RegBitClr(REG,MASK) *(REG) &amp;= ~(MASK) RegBitClr(CsrReg,CsrRegReady);</span></span></code> </pre>  Everything is almost good here, note that in this variant we can no longer write <pre> <code class="cpp hljs"> RegBitClr(CsrRegReady,CsrReg);</code> </pre>  because the compiler curses us.  Of course, we don‚Äôt have to write like that, this is an incorrect expression, but this post is intended for normal people who make mistakes, programming demigods who never make mistakes can generally do what they want and not think about such boring things as good style. and type checking by the compiler.  ("Only mediocrity needs order, Genius rules over Chaos.") <br><br>  What remained not too successful?  The ability to write something like <pre> <code class="cpp hljs"> RegBitClr(CsrReg,<span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre>  , we agreed that we should avoid magic constants, and it would be better if the compiler pulled us up, but, unfortunately, this is unattainable in C, remember one of the drawbacks of macros in relation to functions - they do not check the parameters.  We cannot switch to a real function, because inline is not a C compiler directive (well, at least, this is in my version of IAR, although I‚Äôve won it like with the help of pragmas ‚Äî crutches, everywhere crutches), but call the real function for resetting a bit would be very expensive, otherwise <pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Reg_t; <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CsrRegBits {CsrRegReady=<span class="hljs-number"><span class="hljs-number">0x1000</span></span>,CsrRegDone=<span class="hljs-number"><span class="hljs-number">0x100</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegBitClr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reg_t Reg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">enum</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CsrBits Mask)</span></span></span><span class="hljs-function"> </span></span>{ *Reg &amp;= ~Mask; }; RegBitClr(CsrReg,CsrRegReady); RegBitClr(CsrReg,~CsrRegReady); <span class="hljs-comment"><span class="hljs-comment">//   RegBitClr(CsrReg,3); //   </span></span></code> </pre>  would be an almost perfect solution. <br><br>  True, you can not write and <pre> <code class="cpp hljs"> RegBitClrf(CsrReg,CsrRegReady | CsrRegDone); <span class="hljs-comment"><span class="hljs-comment">//     RegBitClrf(CsrReg,(enum CsrRegBits)(CsrRegReady | CsrRegDone)); //    </span></span></code> </pre>  Of course, the last line allows you to create unacceptable expressions, but at least you have clearly indicated that you are familiar with the length of the rope.  The only thing I would recommend for such a solution, at least for IAR, is to check the box ‚ÄúTreat all warnings as errors‚Äù to make the control tough. <br><br>  Well and the conclusion - we meanwhile considered only the one-task uninterrupted program.  Imagine that you need to take into account the possibility of interruptions, I will do this by adding two lines to the text of a macro or function, but it‚Äôs hard for me to imagine what the authors of the original fragment will do. <br><br>  An important addition is in the comments one of the users of Habr, namely <a href="http://geektimes.ru/users/pwl/" class="user_link">pwl,</a> offered an absolutely fascinating solution to the problem of type checking, namely, adding a dummy function to the macro with macro arguments, and the compiler checks the type and issues the varning, but the call to the function itself is suppressed because its the result participates in a constant logical expression.  That is, the wolves are fed (we checked the type) and the sheep are intact (the resulting code has not grown).  Many thanks again, this is just what I call a fruitful discussion, it‚Äôs just a pity that I didn‚Äôt think of it myself.  This is the perfect solution. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Reg_t; <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> CsrRegBits {CsrRegReady=<span class="hljs-number"><span class="hljs-number">0x1000</span></span>,CsrRegDone=<span class="hljs-number"><span class="hljs-number">0x100</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestBitClrArg</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Reg_t adr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">enum</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CsrRegBit data)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//   ,      #define RegBitClr(REG,MASK) (*(REG) &amp;= ~(MASK), 1||TestBitClrArg(REG,BIT)) RegBitClr(CsrReg,CsrRegReady); RegBitClr(CsrReg,~CsrRegReady); //   RegBitClr(CsrReg,3); //   </span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/258593/">https://habr.com/ru/post/258593/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258579/index.html">Post reinforced retro</a></li>
<li><a href="../258581/index.html">My experience with Apache Cassandra</a></li>
<li><a href="../258583/index.html">Convert conversations to mp3 - Elastix 2.5 (FreePBX 2.11)</a></li>
<li><a href="../258585/index.html">Smart quest in reality: demons and wiring</a></li>
<li><a href="../258587/index.html">Animation of characters in Blender 3D is just</a></li>
<li><a href="../258595/index.html">The sad state of the sysadmin in the era of containers</a></li>
<li><a href="../258597/index.html">The application that I need</a></li>
<li><a href="../258599/index.html">Using Arduino as a component of Wolfram SystemModeler</a></li>
<li><a href="../258601/index.html">Unique TechTalk with Michael Monti Widenius</a></li>
<li><a href="../258603/index.html">We select the correct Microsoft Azure services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>