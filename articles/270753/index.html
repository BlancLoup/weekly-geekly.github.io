<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>I2P: Signature and EdDSA Signature Verification</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article , the implementation of the Ed25519 curve itself, the addition and multiplication operations by number, the restoration of the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>I2P: Signature and EdDSA Signature Verification</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/269579/">previous article</a> , the implementation of the Ed25519 curve itself, the addition and multiplication operations by number, the restoration of the second coordinate was considered.  This article discusses how to effectively use these operations to digitally sign messages and work in I2P. <br><br><h4>  EdDSA Signature Algorithm </h4><br>  Unlike RSA, where the secret and public key can be used directly, here you have to use a more complex scheme and enter some additional object.  EdDSA conceptually implements the <a href="https://ru.wikipedia.org/wiki/DSA">DSA</a> algorithm, extending it to the case of curves.  The signature is a pair of numbers (R, S), for EdDSA, each is 32 bytes in length, total signature length is 64 bytes.  It is not the data itself that is signed, but the hash of them.  SHA512 is used as a hash function.  Further, in small letters, numbers will be designated, and in capital letters - the corresponding point on the curve, obtained by multiplying the number by the base point B. <br><a name="habracut"></a><br>  Let h be the hash of the message being signed, a the secret key, and A the corresponding public key (A = a * B).  Take a random number r, and calculate R = r * B and s = r + h * a.  The pair (R, s) will be the signature where R is represented by its y coordinate. <br>  When verifying the signature, the recipient knows A and h, and it is necessary to verify the truth (R, s).  For this, the equality is checked: s * B = R + h * A. <br>  Indeed (r + h * a) * B = r * B + h * a * B = R + h * A. <br><img src="https://habrastorage.org/files/0c9/59a/609/0c959a609277402daa88d0d66293e898.png"><br>  Note that s is calculated directly on the basis of the secret key, and not the point generated by it, because errors in the implementation can lead to its immediate compromise.  In particular, the bad choice r.  To avoid this, Bernstein suggests calculating r as a hash from half of the secret key hash combined with the data being signed, but choosing r in some other way will not break the algorithm, that is, the signature values ‚Äã‚Äãthemselves will be different, but the result will be the same.  We will calculate r, as suggested by Bernstein and how it is done in the official I2P. <br><br><h4>  Effective multiplication implementation </h4><br>  For further calculations, we will need the previously unused curve parameter l = <img src="https://habrastorage.org/files/ac5/1d4/470/ac51d447080f4244b0a2a68dc2a1c7ba.jpg">  such that l * b = 0. <br>  From this equality immediately follows that the values ‚Äã‚Äãof the multiplier in front of the point should not exceed l, otherwise it will only lead to an increase in the amount of calculations.  If the multiplier exceeds l, then it should be taken modulo, in particular the value of h, which is a SHA512 hash of 64 bytes in length. <br>  From this, in turn, it follows that the multiplier in the multiplication operation does not exceed 32 bytes and the most significant bit is always zero. <br>  As you can see from the formulas, one multiplication per base point is required for the signature, and two for verification of the signature: one for the base point and the second for the public key. <br>  For a base point, it makes sense to calculate the result of multiplying by different factors in advance.  The simplest is a series (B, 2 * B, 4 * B, 8 * B, ...) of only 255 points, which allows eliminating the doubling operation at each step.  You can go further and expand the factor not in powers of two, but in powers of 16 and for each 4 bits of the multiplier add to the result a calculated point from the array.  For this you need to calculate and store 32 * 2 * 16 points, but this is done once during the whole work.  Thus, multiplication by B reduces to exactly 64 additions and the message is signed quickly.  Here is how it looks in code. <br><pre><code class="cpp hljs">EDDSAPoint res {zero, one}; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> x = e[i] &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 4 low bits if (x &gt; 0) res = Sum (res, Bi16[i*2][x-1], ctx); x = e[i] &gt;&gt; 4; // 4 high bits if (x &gt; 0) res = Sum (res, Bi16[i*2+1][x-1], ctx); }</span></span></code> </pre> <br>  Here Bi16 is an array of 64x16 pixels, and <i>e</i> is a 32-byte multiplier in Little Endian.  Instead of the degrees 16, you can use the decomposition in powers of 256, this will lead to some acceleration, at the same time you will need to store 32 * 256 points. <br>  To verify the signature, you will also need to multiply the public key, although it is the result of multiplying B, the factor is unknown to us, since this is the secret key.  If you apply this method, you will have to keep such an array for each of them, and in I2P there are a lot of public keys - for each node from netdb its own, which are of the order of several thousand, which would lead to unnecessary memory consumption.  Therefore, in order to achieve a work speed comparable to other elliptic curves, it will be necessary to improve the operation of addition. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Addition in homogeneous coordinates </h4><br>  As noted in the <a href="http://habrahabr.ru/post/269579/">previous article</a> , the slowest operation is division with each addition, which can be eliminated by going to homogeneous coordinates.  The implementation becomes less visual, but all the implementations of elliptical cryptography are arranged there.  Instead of the two coordinates of the point (x, y), a third coordinate is entered that stores the common denominator, and instead of x and y their numerators are stored, that is, from the homogeneous coordinates (X, Y, Z), the true coordinates are obtained as (X / Z, Y / Z ).  In addition, the fourth coordinate T = X * Y / Z is introduced.  The coordinates of the result of the addition are calculated by the following formulas: <br>  <i>X = (X1 * Y2 + Y1 * X2) * (Z1 * Z2-d * T1 * T2)</i> <br>  <i>Y = (Y1 * Y2 + X1 * X2) * (Z1 * Z2 + d * T1 * T2)</i> <br>  <i>Z = (Z1 * Z2-d * T1 * T2) * (Z1 * Z2 + d * T1 * T2)</i> <br>  <i>T = (Y1 * Y2 + X1 * X2) * (X1 * Y2 + Y1 * X2)</i> <br>  As can be seen, the laborious operation of exponentiation in the process of addition and multiplication no longer applies. <br>  Another disadvantage of homogeneous coordinates is the complexity of comparing two points: the X and Y coordinates cannot be directly compared - they need to be brought to a common denominator in one way or another, which requires additional calculations.  To verify the signature is required to compare the points. <br><br><h4>  Subtract two curve points </h4><br>  Rewrite the expression to verify the signature s * B = R + h * A in the form R = s * Bh * A. <br>  Then, instead of restoring the X coordinate of the point along the Y coordinate from the signature, you can take the Y coordinate from (s * Bh * A), thereby saving another exponentiation and comparing numbers instead of points.  This method requires a subtraction operation, which is implemented through additions and unary minus, defined as (-X, Y, Z, -T).  Thus, the subtraction operation is performed at the same speed as the addition, and can be used to decompose in powers with negative coefficients, which allows to reduce the memory size by 2 times. <br><br><h4>  I2P Addresses with EdDSA </h4><br>  The length of the I2P address from EdDSA is 391 bytes, the signature type code is 7, denoted in the documentation as EdDSA_SHA512_Ed25519. <br>  The length of the secret and public keys is 32 bytes, the length of the signature is 64 bytes, the first 32 bytes are R in the form of the y coordinate, the second 32 bytes are s. <br>  All numbers are transferred to Little Endian. <br>  Currently EdDSA is the recommended signature type for RouterInfo. <br><br>  Thus, in two articles, a complete and transparent implementation of EdDSA over a library for working with large numbers from the openssl library, operating at high speed and practically used in <a href="https://bitbucket.org/orignal/i2pd">i2pd, is described</a> . </div><p>Source: <a href="https://habr.com/ru/post/270753/">https://habr.com/ru/post/270753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270739/index.html">VoIP Network Security</a></li>
<li><a href="../270741/index.html">New ICQ, or as we received Editors' Choice</a></li>
<li><a href="../270743/index.html">Static analysis of printf-like functions in C using libclang</a></li>
<li><a href="../270745/index.html">Cloud for development companies: how Robots Can Dream made a project for the FINA World Cup 2015</a></li>
<li><a href="../270747/index.html">7 key benefits of Dell technical support</a></li>
<li><a href="../270755/index.html">New version of HP Vertica Excavator (7.2)</a></li>
<li><a href="../270757/index.html">Creating an enterprise - the solution of tomorrow</a></li>
<li><a href="../270759/index.html">Russian AI Cup 2015: race for survival for programmers</a></li>
<li><a href="../270763/index.html">Office Add-Ins for Excel - new features for VBA and VSTO developers</a></li>
<li><a href="../270765/index.html">Sound theory. What you need to know about the sound to work with it. Experience Yandex. Music</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>