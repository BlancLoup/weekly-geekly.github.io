<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Map of Moscow and the whole world for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CHAPTER 1. Ambitions 
 The end of February 2018 



 We, as adherents of the free software and free market ideology, believe that monopoly is bad. 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Map of Moscow and the whole world for Android</h1><div class="post__text post__text-html js-mediator-article"><h3>  CHAPTER 1. Ambitions </h3><br>  <i>The end of February 2018</i> <br><br><img src="https://habrastorage.org/webt/lt/tg/uh/lttguhdjo8ap9vv_i4egmb-7-ma.png"><br><br>  We, as adherents of the free software and free market ideology, believe that monopoly is bad. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A huge number of people need convenient and fast navigation in the subway.  It is strange that there is not a single worthy competitor of the Yandex.Metro application.  We decided to create it ourselves, doing it in our free time as a hobby. <br><br>  Team: at different times from 2 to 4 people. <br><br>  The narration covers only the Android application, due to the fact that it was launched first and all the basic mechanisms were run on it.  Of course, the iOS version is currently available. <br><br><h3>  CHAPTER 2. The route in the darkness </h3><br>  <i>March - June 2018.</i> <br><br>  Need a map.  We take SVG, we push in <a href="https://github.com/MegatronKing/SVG-Android">SVGView</a> , everything is fine.  Lying terribly, but we are joyful.  How to draw separate routes?  Nobody knows. <br><br>  In the SVG format, there is no information about layering, an element belonging to any line, or other information that is critically necessary for constructing a route.  So we came to the use of a database to store all the elements for drawing. <br><br>  In addition, we needed the application to run as quickly as possible.  Using <a href="https://developer.android.com/reference/android/webkit/WebView">WebView</a> immediately disappears, you need a GL-surface.  We decided to try with <a href="https://developer.android.com/reference/android/view/SurfaceView">SurfaceView</a> (opengl surface that can be used as a canvas) - it's not that.  It can make changes inside itself, blinking black, as it is simply poorly implemented and can not withstand the load more than drawing a 20x20 cube.  It can increase, disappearing through time.  We needed a different solution, but one that would not be so far from SurfaceView, since it was fully compatible with the interface. <br><br><img src="https://habrastorage.org/webt/ln/gp/cm/lngpcmo0m8odexmxrwgo9e6wqqk.png" alt="image"><br>  <i>Briefly about driver bugs on Android</i> <br><a name="habracut"></a><br>  We tried the implementation on <a href="https://developer.android.com/reference/android/view/TextureView">TextureView</a> .  And, oh gods, most of the problems are gone.  Despite the fact that TextureView is a SurfaceView on steroids, it is normally implemented without magic bugs and epileptic seizures of the video adapter. <br><br>  We still had errors of synchronization of streams and settings of views in the form of unreadable segmentation errors, but it was already better than a black blinking spot.  Accordingly, any use of the View is not the way it should be, forcing to override almost all the methods of the View itself.  This was especially problematic with TextureView because this component consists of 2 parts: View and Surface.  They can't do without each other, but at the same time they can simply not send the event of the death of a Surface to the Inside View, which is why they have to do manual checks after almost every action. <br><br>  The problems started when we had to increase the view.  Canvas draws everything pixel-by-pixel, so if we specify a size of 400x400, then elements from 0 to 400 will be visible, but not outside.  400 is very small, we really need a map of about 5000x5600 pixels on good devices.  But how to fit 5000x5600 on the screen 1920x1080 (16: 9)? <br><br>  We create a canvas map with size and scale that will increase with screen resolution, and decrease with decreasing screen resolution.  Thus, we solved the problem of very large and crookedly drawn maps on devices with a large screen and too small maps on small screens. <br><br>  When we started testing the card, it turned out that on phones with the same resolution, the map is displayed differently.  Well, in different ways: on one it is displayed, on the second a white / black spot.  Logs lead to a Qualcomm bug tracker to a bug with Adreno 330/300 chips with the 'wontfix' status.  Wonderful. <br><br>  The only way to defeat this bug is to underestimate the size of the card on phones with a certain video chip so that there is no white square instead of a card.  But how do we know the video chip model?  We have to create a 1x1px GLSurfaceView at the start of the application, get information about the video chip from it and only then draw a map. <br><br>  ‚Äú- But it's a crutch.‚Äù Yes, it's a crutch.  This is a galactic crutch, but it's better than cutting out a large number of devices and hoping that Qualcomm will fix the bug of its drivers and send updates to all OEMs so that we can use the card on phones with these curves drivers.  Thanks to our users, we were able to find a solution that works on all devices. <br><br><img src="https://habrastorage.org/webt/q7/id/bi/q7idbi3gu4yrpgt6wnwulawnjua.png" alt="image"><br>  <i>We built, built and finally built!</i> <br><br>  Also a very interesting task was the layering of elements.  Due to the fact that the red branch should be drawn over the green, green over the blue, yellow over the red, etc., we entered the layer numbers, and our (simple at first glance) application became similar to Adobe Photoshop :) <br><br>  We decided on how to draw routes.  Now it was necessary to decide how to find the best among them.  To search for all paths between vertices, we use the Floyd-Worshall algorithm, to find the shortest path, use the Dijkstra algorithm, for alternative paths, the Yen algorithm.  Who are interested in the details, ask questions in the comments. <br><br><h3>  CHAPTER 3. The route in the sun </h3><br>  <i>June - December 2018</i> <br><br>  At this stage, we already knew what to do.  Improve the product.  We drew new maps, added new languages, eliminated bugs, accelerated work, screwed up features, collected user feedback and did not spend a dime on promotion of the application. <br><br>  On June 15, we rolled out our application to the release, complementing it with the St. Petersburg metro map.  On this map we decided to designate reservoirs and bridges.  Somewhat later, Yandex showed a redesign with a similar layout of maps.  Not bad, we thought. <br><br><img src="https://habrastorage.org/webt/lt/cc/ru/ltccruhk789nwccr8yp4xorpos0.jpeg" alt="image"><br><br>  In total, we added 10 cities: St. Petersburg, Barcelona, ‚Äã‚ÄãPrague, Baku, Kazan, Kiev, Minsk, Nizhny Novgorod, Samara, Novosibirsk.  In the development of the metro map of Paris and New York, the plans - the whole world. <br><br>  In July, the backend was deployed to update information about the stations and quickly update maps. <br><br>  In September, we already had a strong product that could be carried to the masses.  At the same time, we met Nikolay, the developer of the application ‚ÄúMetro and MSC - station layouts‚Äù.  In his application, he collected the scheme of stations that allow you to quickly navigate and find the desired output.  Very cool, but this application did not allow to build a route and had an outdated design.  That is why for a wider audience it turned out to be weaker than Yandex. Metro. <br>  We agreed to implement the station schemes in our application, and the company‚Äôs management supported and funded the idea.  It became a feature killer.  Our users were delighted. <br><br>  <i>January - March 2019</i> <br><br>  Having spent about 10 experiments with the application page in google play and having spent 18 (!) Thousand rubles on marketing, we have put the applications in the top 3 google play at the requests of the ‚Äúmetro‚Äù and ‚Äúmetro moscow‚Äù. <br><br>  In March, the iOS version of the application was published, which also successfully ranked in the top 5 app store at the request of the Moscow Metro. <br><br>  <a href="https://redirect.appmetrica.yandex.com/serve/170335547913412359">Download Android: Moscow Metro - station layouts, routes, exits</a> <br>  <a href="https://redirect.appmetrica.yandex.com/serve/674738707823106041">Download iOS: Moscow Metro + station layouts</a> </div><p>Source: <a href="https://habr.com/ru/post/459684/">https://habr.com/ru/post/459684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459672/index.html">Python underline</a></li>
<li><a href="../459674/index.html">Epic Intelligence Intelligence Saga</a></li>
<li><a href="../45968/index.html">widget do it yourself</a></li>
<li><a href="../459680/index.html">In the footsteps of Highload ++ Siberia 2019 - 8 tasks for Oracle</a></li>
<li><a href="../459682/index.html">The quality of data in the repository</a></li>
<li><a href="../459688/index.html">Urbanism in China: fewer hipsters, more science and IT</a></li>
<li><a href="../459692/index.html">As we discovered material modifications that contradict well-established chemical principles</a></li>
<li><a href="../459694/index.html">DataArt Museum. Unpacking and launching Radio-86RK</a></li>
<li><a href="../459698/index.html">How to make Oracle BI 12c make as many session variables as the programmer needs?</a></li>
<li><a href="../4597/index.html">Dancing Belarusian became a star of YouTube</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>