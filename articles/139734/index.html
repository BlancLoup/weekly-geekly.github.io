<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>C # 5 - about async / await from the beginning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the recently released Visual Studio 11 Beta, a new and main feature of the future C # 5 is built-in - asynchronous programming using async / await ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>C # 5 - about async / await from the beginning</h1><div class="post__text post__text-html js-mediator-article">  In the recently released Visual Studio 11 Beta, a new and main feature of the future C # 5 is built-in - asynchronous programming using <strong>async / await</strong> .  About her already written quite a lot of articles, including those in Habr√© - for example, this <a href="http://habrahabr.ru/blogs/net/107498/">series of articles</a> .  However, I didn‚Äôt understand for myself what the essence of the new syntax was until I tried it myself.  This article is an attempt to structure oneself and fully understand this rather interesting tool and share the results with the community, telling about it a little differently.  So let's go ... <br><a name="habracut"></a><br><h1>  Why do you need it? </h1><br>  C # actively developing language in each version of which there are interesting features that really simplify the writing of high-quality and understandable code.  For example, Linq has greatly simplified writing filters for collections and sql queries in code.  Now it's up to asynchrony. <br><br>  And although the framework has already accumulated a fairly large number of ways to write multi-threaded code, from manually creating a stream to the visual component of BackgroundWorker, developing an asynchronous application requires writing a decent amount of infrastructure code that increases as the task becomes more complex.  The main problem of this, in my opinion, is the need to change the state of the user interface from the background thread (which, as we know, cannot be done directly). <br><br>  A new language design async / await solves this problem, allowing not only to run the task in the background thread and execute the code when it is completed, but it does it visually - the code looks almost like synchronous (including exception handling). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Meet: async / await </h1><br>  Generally speaking, keywords do not quite clearly reflect the essence, but as the developers explain it better, no one invented, therefore they are what they are.  Like most entities in programming, the new construct is easiest to understand directly from the code: <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   private void OnButtonClick() { TextBox.Text = new WebClient().DownloadString("http://habrahabr.ru/"); } //   private async void OnButtonClick() { TextBox.Text = await new WebClient().DownloadStringTaskAsync("http://habrahabr.ru/"); }</span></span></code> </pre> <br><br>  And if in the synchronous version everything is simple and clear, then many questions arise with asynchronous.  Strangely enough, let's start with the new method of the WebClient class - <strong>DownloadStringTaskAsync</strong> - this method returns Task &lt;string&gt; and in the new studio is marked as awaitable.  The type of return value is the key moment in this whole story - looking ahead it‚Äôs worth saying that await can only work with functions returning Task and Task &lt;T&gt;. <br>  <b>UPD:</b> as <a href="http://habrahabr.ru/users/jack128/" class="user_link">jack128</a> rightly noted in the comments, await works with any object that has the GetAwaiter () method, thanks to him for the correction. <br><br>  So, the <strong>DownloadStringTaskAsync</strong> method creates a Task task and immediately returns it from a function, while in the background thread the page starts downloading from the requested url.  We are free to work directly with the Task object, manually waiting for the result to be completed: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnButtonClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient().DownloadStringTaskAsync(<span class="hljs-string"><span class="hljs-string">"http://microsoft.com/"</span></span>); task.Wait(); <span class="hljs-comment"><span class="hljs-comment">//     ,    TextBox.Text = task.Result; }</span></span></code> </pre><br><br>  This code, of course, remains synchronous, since we are mainly waiting for the background ... <br><br>  We need a way to work as conveniently and asynchronously with a task (Task &lt;T&gt;), which remains the only ‚Äúthread‚Äù that connects us to the background thread.  And here await appears on the scene - it not only expands Task &lt;T&gt; to T, but also sets the rest of the method to ‚Äúcontinuation‚Äù, which will be executed after the completion of the task and the most important thing in the same thread.  In this case, the OnButtonClick () function will exit and the application will continue to work in its normal mode - responding to user actions. <br><br>  As soon as the background thread finishes its work and returns the result, a ‚Äúcontinuation‚Äù will be performed in the <strong>main thread</strong> , which in this case will set the page content in the text field. <br><br>  It remains to deal with the async keyword - they need to mark the functions in which await will be used.  Everything is simple, and most importantly, the compiler will see that you don‚Äôt forget about it - without letting you compile the program. <br><br><h1>  What it looks like in action </h1><br>  A function can have multiple awaits, which allows you to create asynchronous execution chains: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartButtonClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//       StartButton.IsEnabled = false; //   ,      //       TextBox.Text = await new WebClient().DownloadStringTaskAsync("http://habrahabr.ru/"); StatusLabel.Content = "  ,  "; //           var result = await Task&lt;string&gt;.Factory.StartNew(() =&gt; { Thread.Sleep(5000); //   ... return " "; }); //     StatusLabel.Content = result; StartButton.IsEnabled = true; }</span></span></code> </pre><br><br>  What about exceptions?  Since the developers have promised that the new syntax will be simple and close to synchronous, they could not ignore such an important problem of exception handling.  As promised, exceptions thrown in the background thread can be processed using the classical syntax (as if there is no asynchrony): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartButtonClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { TextBox.Text = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient().DownloadStringTaskAsync(<span class="hljs-string"><span class="hljs-string">"http://not-habrahabr.ru/"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { MessageBox.Show(ex.Message); } }</code> </pre><br><br>  However, with exception handling there is one thing that needs to be understood - since all the code that comes after await is installed at the end and when it is executed is generally unknown, such exception handling will not work: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   !!! private void StartButtonClick(object sender, RoutedEventArgs e) { try { Download(); } catch (Exception ex) { MessageBox.Show(ex.Message); } } private async void Download() { TextBox.Text = await new WebClient().DownloadStringTaskAsync("http://not-habrahabr.ru/"); }</span></span></code> </pre><br><br>  The Download function will return control as soon as the Task with the background thread is created, and then the exit from the StartButtonClick function will be executed ... and only later in the background thread will an exception be generated that the domain name cannot be resolved.  A more detailed explanation can be read <a href="http//www.interact-sw.co.uk/iangblog/2010/11/01/csharp5-async-exceptions">here</a> . <br><br><h1>  Total </h1><br>  In the upcoming .Net 4.5 many classes will be added to support the new syntax - i.e.  There will be many functions returning Task and Task &lt;T&gt;.  And judging by the simplicity of the new syntax, it will be widely used, so a clear understanding of the new language constructions, their actions and scope is necessary. <br><br>  To summarize, the async keyword does not cause the method to run in the background thread (as the name implies), but only notes that there is an await inside the method that works with Task and Task &lt;T&gt; in such a way that the rest of the method await will be executed after completing Task, but in the main thread. <br><br>  Introducing a new syntax, Microsoft offers not just syntactic sugar, but a whole asynchronous programming pattern, including exception handling, interruption of the asynchronous function execution, and information on the progress of execution ... which are already beyond the scope of this article. <br><br>  If there are any vague places, I will try to answer all the questions in the comments. </div><p>Source: <a href="https://habr.com/ru/post/139734/">https://habr.com/ru/post/139734/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139729/index.html">Looking for a nice investor</a></li>
<li><a href="../139730/index.html">Why do people unsubscribe from your newsletter</a></li>
<li><a href="../139731/index.html">Data Mining in football: let's digitize a match and count everyone!</a></li>
<li><a href="../139732/index.html">How I made the most popular election site</a></li>
<li><a href="../139733/index.html">Implementation of the author's autograph session for iBooks</a></li>
<li><a href="../139736/index.html">Annotations in JAVA: syntax overview and creating your own</a></li>
<li><a href="../139737/index.html">Repair L-shaped Magsafe connector</a></li>
<li><a href="../139738/index.html">Comic Contest vs Limited Download: Protect user freedom on tablets and smartphones</a></li>
<li><a href="../139739/index.html">We draw the code from "Matrix" for PHP</a></li>
<li><a href="../139741/index.html">Writing a Japanese crossword service on gae, backbone, underscore, require and also knows what the hell</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>