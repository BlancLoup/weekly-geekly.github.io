<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Keeping recordings of conversations in mp3 in FreePBX / Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now FreePBX is an extremely popular wrapper for Asterisk, which is no less popular as a telephone digital server. A separate plus of such systems is t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Keeping recordings of conversations in mp3 in FreePBX / Asterisk</h1><div class="post__text post__text-html js-mediator-article">  Now FreePBX is an extremely popular wrapper for Asterisk, which is no less popular as a telephone digital server.  A separate plus of such systems is the ability to deploy on low-cost vds-servers (I deploy clients to vds worth 299r / month, 2GB of RAM, 2.8 GHZ processor, 20GB of disk space).  Such a system easily serves 10-20 simultaneous calls, writes audio, allows you to embed the telephone part of a business process into the rest of the logic (interaction with crm, calls from the site / browser, autoinformers based on data in the sub, finding out the search data by caller number for shares seconds, even speech recognition and synthesis!). <br><br>  Everything would be fine, but at ‚Äúabundant‚Äù telephone calls in half a month the disk space ends.  Those same 20GB fly away from some customers in a week!  And the hoster, unfortunately, does not provide fuse on OpenVZ tariffs, which is essential for the operation of ‚Äúrealtime - network file systems,‚Äù like ftpfs. <br><br>  Below is my set of measures to combat the problem.  We will work with the / var / spool / asterisk / monitor directory, where the .wav files lie, carefully arranged asterisk into directories: year, month and day. <br><a name="habracut"></a><br>  Initially, I went from the wrong end - I began to transfer some data to webdav (ya.disk) and ftp.  This was done by a script that was launched once a month according to the crown.  The script left the specified number of months on the server, transferred the rest to the remote resource. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For yandex.disk, he additionally packed the data ‚Äúmonthly‚Äù, which required free space to create an archive.  But, nevertheless, in some places he caught on: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#settings #for disk.yandex.ru YAUSER=login@yandex.ru YAPASSWORD=verystrongpassword MONPATH=/var/spool/asterisk/monitor LASTMONTH=1 #      DIR=astsounds #  ,     #start MONTH=$(date +"%m") for YEAR in $( ls $MONPATH ); do for MONTH in $( ls $MONPATH/$YEAR/ ); do if [ $MONTH -le $(($(date +"%m")-$LASTMONTH)) ] || [ $YEAR -ne $(date +"%Y") ]; then tar -zcvf $MONPATH/$YEAR/$MONTH/$YEAR-$MONTH.tar.gz $MONPATH/$YEAR/$MONTH/ &gt;/dev/null curl -T $MONPATH/$YEAR/$MONTH/$YEAR-$MONTH.tar.gz --user $YAUSER:$YAPASSWORD https://webdav.yandex.ru/$DIR/$YEAR-$MONTH.tar.gz &amp;&amp; rm -f -r $MONPATH/$YEAR/$MONTH &gt;/dev/null fi done #remove old YEAR dir if [ $YEAR -ne $(date +"%Y") ]; then rm -f -r $MONPATH/$YEAR fi done</span></span></code> </pre> <br>  When I wrote a similar script for ftp, I decided not to archive audio.  And it's easier to get, and links can be formed to a third-party resource, for online listening from a CDR report.  Requires lftp utility. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#move audio records to XXX.ru free FTP server #settings FTPSRV=node0.XXXX.ru FTPUSER=username_ftpserver FTPPWD=passwd_ftpserver MONPATH=/var/spool/asterisk/monitor LASTMONTH=1 DIR=recordings #log and cd ftpcommand() { lftp -u $FTPUSER,$FTPPWD -e "$1" $FTPSRV } ftpcommand "mkdir public_http; mkdir public_http/$DIR; quit;" MONTH=$(date +"%m") for YEAR in $( ls $MONPATH ); do for MONTH in $( ls $MONPATH/$YEAR/ ); do if [ $MONTH -le $(($(date +"%m")-$LASTMONTH)) ] || [ $YEAR -ne $(date +"%Y") ]; then echo "saving $YEAR/$MONTH" ftpcommand "mkdir public_http/$DIR/$YEAR; mkdir public_http/$DIR/$YEAR/$MONTH; quit;" for DAY in $( ls $MONPATH/$YEAR/$MONTH/ ); do ftpcommand "mkdir public_http/$DIR/$YEAR/$MONTH/$DAY; quit;" for FILE in $( ls $MONPATH/$YEAR/$MONTH/$DAY ); do ftpcommand "cd /public_http/$DIR/$YEAR/$MONTH/$DAY/; put $MONPATH/$YEAR/$MONTH/$DAY/$FILE; quit;" done done rm -f -r $MONPATH/$YEAR/$MONTH fi done #remove old YEAR dir if [ $YEAR -ne $(date +"%Y") ]; then rm -f -r $MONPATH/$YEAR fi done</span></span></code> </pre><br>  This script was also cast in the monthly crowns. <br><br>  But for some people, as I already wrote, this was not enough.  Data scored disk for the week.  Then the thought came to store everything in mp3.  In fact - the winnings were 4 times.  It will require <b>lame</b> . <br><br>  To begin with, put in / etc / asterisk such a mixmon_mp3.sh script and give it one with the asterisk host: <u>chown asterisk.</u>  <u>mixmon_mp3.sh</u> .  Also give the right to run: <u>chmod + x mixmon_mp3.sh</u> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #convert wav to mp3 asterisk recordings cdrdb="asteriskcdrdb" cdrtable="cdr" astdbuser="asteriskuser" #    astdbuserpass="asteriskuserpassword" #   for i in `find /var/spool/asterisk/monitor -type f -name "$1"` do if [ -e "$i" ]; then file=`basename "$i" .wav`; dir=`dirname "$i"`; lame -h -b 192 "$i" "$dir/$file.mp3"; rm -f "$dir/$file.wav"; sleep 3 mysql --user="$astdbuser" --password="$astdbuserpass" --database="$cdrdb" --execute='UPDATE '$cdrtable' SET recordingfile="'$file'.mp3" WHERE recordingfile="'$file'.wav";'; fi done</span></span></code> </pre><br>  Then, in the FreePBX webmord, in the Settings - Advanced Settings section, we <b>enable Display Readonly Settings</b> and <b>Override Readonly Settings</b> , after which the <b>Post Call Recording Script</b> setting is available in the Developer and Customization section.  There and write the script call line with the parameter: <br><br><pre> <code class="bash hljs">/etc/asterisk/mixmon_mp3.sh ^{CALLFILENAME}.^{MIXMON_FORMAT}</code> </pre><br>  Unfortunately, the variable MIXMON_DIR was empty, so you have to be content with the file name and search it in the monitor directory.  The script finds the file, converts it to mp3, deletes the wav and corrects the entry in the cdr table where the reports are stored.  This is necessary for normal listening and downloading files in a webmord with reports. <br><br>  We will also need to finish the webmord cdr module itself: <br>  / var / www / html / admin / modules / cdr / <br>  cdr_audio.php <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!defined(<span class="hljs-string"><span class="hljs-string">'FREEPBX_IS_AUTH'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'No direct script access allowed'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> * plays recording file */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_REQUEST[<span class="hljs-string"><span class="hljs-string">'cdr_file'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>(<span class="hljs-string"><span class="hljs-string">"crypt.php"</span></span>); $REC_CRYPT_PASSWORD = (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($amp_conf[<span class="hljs-string"><span class="hljs-string">'AMPPLAYKEY'</span></span>]) &amp;&amp; trim($amp_conf[<span class="hljs-string"><span class="hljs-string">'AMPPLAYKEY'</span></span>]) != <span class="hljs-string"><span class="hljs-string">""</span></span>)?trim($amp_conf[<span class="hljs-string"><span class="hljs-string">'AMPPLAYKEY'</span></span>]):<span class="hljs-string"><span class="hljs-string">'TheWindCriesMary'</span></span>; $crypt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Crypt(); $opath = $_REQUEST[<span class="hljs-string"><span class="hljs-string">'cdr_file'</span></span>]; $path = $crypt-&gt;decrypt($opath,$REC_CRYPT_PASSWORD); <span class="hljs-comment"><span class="hljs-comment">// Gather relevent info about file $size = filesize($path); $name = basename($path); $extension = strtolower(substr(strrchr($name,"."),1)); // This will set the Content-Type to the appropriate setting for the file $ctype =''; switch( $extension ) { case "WAV": $ctype="audio/x-wav"; break; case "wav": $ctype="audio/x-wav"; break; #--------------------- case "mp3": $ctype="audio/mpeg"; break; #--------------------- case "ulaw": $ctype="audio/basic"; break; case "alaw": $ctype="audio/x-alaw-basic"; break; case "sln": $ctype="audio/x-wav"; break; case "gsm": $ctype="audio/x-gsm"; break; case "g729": $ctype="audio/x-g729"; break; default: //not downloadable // echo ("&lt;b&gt;404 File not found! foo&lt;/b&gt;"); // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> what to do if none of the above work? break ; } $fp=fopen($path, "rb"); if ($size &amp;&amp; $ctype &amp;&amp; $fp) { header("Pragma: public"); header("Expires: 0"); header("Cache-Control: must-revalidate, post-check=0, pre-check=0"); header("Cache-Control: public"); header("Content-Description: audio file"); header("Content-Type: " . $ctype); header("Content-Disposition: attachment; filename=" . $name); header("Content-Transfer-Encoding: binary"); #--------------------- header("Accept-Ranges: bytes"); header("Connection: close"); header("Content-Length: $size"); header("Content-Range:bytes 0-$size/$size"); header("Content-length: " . $size); #--------------------- $chunksize = 1*(1024*1024); while (!feof($fp)) { $buffer = fread($fp, $chunksize); echo $buffer; ob_flush(); flush(); } fclose($fp); } } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  cdr_play.php <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!defined(<span class="hljs-string"><span class="hljs-string">'FREEPBX_IS_AUTH'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'No direct script access allowed'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@file</span></span></span><span class="hljs-comment"> * popup window for playing recording */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>(<span class="hljs-string"><span class="hljs-string">"crypt.php"</span></span>); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;!DOCTYPE html <span class="hljs-keyword"><span class="hljs-keyword">PUBLIC</span></span> <span class="hljs-string"><span class="hljs-string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span></span> <span class="hljs-string"><span class="hljs-string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span></span>&gt; &lt;html xmlns=<span class="hljs-string"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span>&gt; &lt;head&gt; &lt;TITLE&gt;CDR Viewer&lt;/TITLE&gt; &lt;style type=<span class="hljs-string"><span class="hljs-string">"text/css"</span></span>&gt; .popup_download { color: <span class="hljs-comment"><span class="hljs-comment">#105D90; margin: 5px; font-size: 12px; text-align: left; } &lt;/style&gt; &lt;meta http-equiv="content-type" content="text/html; charset=UTF-8"&gt; &lt;/head&gt; &lt;body&gt; &lt;?php $crypt = new Crypt(); $REC_CRYPT_PASSWORD = (isset($amp_conf['AMPPLAYKEY']) &amp;&amp; trim($amp_conf['AMPPLAYKEY']) != "")?trim($amp_conf['AMPPLAYKEY']):'TheWindCriesMary'; $path = $crypt-&gt;decrypt($_REQUEST['recordingpath'],$REC_CRYPT_PASSWORD); $file = urlencode($crypt-&gt;encrypt($path,$REC_CRYPT_PASSWORD)); if (isset($file)) { #--------------------- echo("&lt;audio controls&gt;\n&lt;source src=\"config.php?skip_astman=1&amp;quietmode=1&amp;handler=file&amp;module=cdr&amp;file=cdr_audio.php&amp;cdr_file=$file\" type=\"audio/mpeg\"&gt;\n&lt;/audio&gt;"); #--------------------- } ?&gt; &lt;/body&gt; &lt;/html&gt;</span></span></code> </pre><br>  Now you can convert existing files to mp3 and put this script in the daytime cron just in case: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #convert wav to mp3 asterisk recordings cdrdb="asteriskcdrdb" cdrtable="cdr" astdbuser="asteriskuser" astdbuserpass="asteriskuserpassword" for i in `find /var/spool/asterisk/monitor -type f -name "*.wav"` do if [ -e "$i" ]; then file=`basename "$i" .wav`; dir=`dirname "$i"`; lame -h -b 192 "$i" "$dir/$file.mp3"; rm -f "$dir/$file.wav"; mysql --user="$astdbuser" --password="$astdbuserpass" --database="$cdrdb" --execute='UPDATE '$cdrtable' SET recordingfile="'$file'.mp3" WHERE recordingfile="'$file'.wav";'; fi done</span></span></code> </pre><br><br>  The process is slow, it is better to run at night.  Now our place is much more economical, listening to reports does not require QuickTime and the file is played to us by the browser through the HTML5 tag. </div><p>Source: <a href="https://habr.com/ru/post/258445/">https://habr.com/ru/post/258445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258433/index.html">We test Chinese iron and find out how cheap and angry it is</a></li>
<li><a href="../258437/index.html">Dagaz: Kicks to common sense (part 7)</a></li>
<li><a href="../258439/index.html">The new issue of the magazine "Radio Annual" number 35 (2015)</a></li>
<li><a href="../258441/index.html">Dynamic Meta Objects (part 1, study)</a></li>
<li><a href="../258443/index.html">Kubernetes Basics</a></li>
<li><a href="../258447/index.html">We manage AB400S Wireless Switch socket without remote control</a></li>
<li><a href="../258449/index.html">How I hacked Starbucks for unlimited coffee</a></li>
<li><a href="../258451/index.html">Two opposite directions VIDEO ANALYTICS: "hard" and "flexible", who is stronger?</a></li>
<li><a href="../258457/index.html">TLS Logjam - FREAK with DH vulnerability</a></li>
<li><a href="../258459/index.html">Subscribe to 72 well-known PHP developers with one click</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>