<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java code optimization in Android Marshmallow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Improving system performance, improving user experience of working with applications: these are the directions in which Android is evolving. In Androi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java code optimization in Android Marshmallow</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/intel/blog/300934/"><img src="https://habrastorage.org/files/596/605/fbf/596605fbf853479ba7dd7c725323f238.jpg" align="left"></a>  Improving system performance, improving user experience of working with applications: these are the directions in which Android is evolving.  In Android Marshmallow you can discover many new features and capabilities.  In particular, we are talking about serious improvements Android Runtime (ART).  They focus on performance, memory consumption and multitasking. <br><br>  New platform release released?  Has the Android virtual machine changed?  Any of these events means that the developer needs to urgently understand the essence of the innovations.  Namely, it is necessary to understand what methods that have made it possible to achieve high performance solutions in the past are no longer so effective.  We need to find new approaches to developing applications that can give the best results.  Almost no one writes about such intricacies, so developers have to figure it all out through trial and error. <br><a name="habracut"></a><br>  Today we will talk about how to write fast and convenient programs, taking into account the features of the updated Android Runtime.  Our tips are aimed at improving performance and improving the quality of machine code that is generated from Java texts.  We will also talk about the features of low-level optimization, which does not always depend on the source Java-code of the application. <br><br><h2>  <font color="#0071c5">Java code, performance enhancement and ART</font> </h2><br>  Android - a system with a rather complex internal structure.  One of its elements is a compiler that converts Java code to machine instructions, for example, devices based on Intel processors.  Android Marshmallow includes an optimizing compiler (Optimizing compiler).  This new compiler optimizes Java applications, creates code that is more productive than the one that was issued by the fast compiler (Quick compiler) in Android Lollipop. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In Marshmallow, almost all applications are prepared for execution using an optimizing compiler.  However, for the methods of the Android System Framework still use the fast compiler.  This is done in order to give Android developers more debugging capabilities. <br><br><h2>  <font color="#0071c5">Accuracy, speed and math libraries</font> </h2><br>  For the organization of floating-point calculations, you can use different implementations of the same operations.  For example, in Java, the Math and StrictMath libraries are available.  They offer different levels of accuracy when performing floating-point calculations.  And, although StrictMath allows to get more predictable results, in most cases the Math library is quite enough.  Here is the method in which the cosine is calculated. <br><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myFunc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) StrictMath.<span class="hljs-built_in"><span class="hljs-built_in">cos</span></span>(x);    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a; }</code> </pre> <br>  Here we used the corresponding method from the StrictMath library, but if the loss of computational accuracy is acceptable for a particular project, Math.cos (x) can be used in a similar situation.  Choosing the right library is worth considering that the Math class is optimized for using the Android Bionic library for Intel architecture.  As a result, operations from Math are performed 3.5 times faster than those from StrictMath. <br><br>  In some situations, of course, can not do without StrictMath, replacing it with Math is undesirable.  But, again, in most cases, it is possible to use Math.  The choice of a specific library is not an abstract search for a compromise between speed and accuracy.  Here you should take into account the requirements of the project as much as possible - from the features of the algorithm and its implementation, to the hardware platform on which you plan to use the application. <br><br><h2>  <font color="#0071c5">Recursive algorithm support</font> </h2><br>  Marshmallow recursive calls are more effective than Lollipop.  When recursive code is written for Lollipop, data from the DEX cache is always loaded.  In Marshmallow, the same thing is taken from the source argument list, and not reloaded from the cache.  Of course, the greater the depth of recursion - the more noticeable the difference in performance between Lollipop and Marshmallow.  However, if the algorithm implemented recursively can be rewritten iteratively, its performance in Marshmallow will be higher. <br><br><h2>  <font color="#0071c5">Elimination of overrun checks for a single array: array.length</font> </h2><br>  Marshmallow's optimizing compiler allows, in some cases, to avoid checking <a href="https://en.wikipedia.org/wiki/Bounds-checking_elimination">for array boundaries</a> (Bound Check Elimination, BCE). <br><br>  Take a look at the empty loop: <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { }</code> </pre> <br>  The variable i is called the <a href="https://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D0%25B4%25D1%2583%25D0%25BA%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B5%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F">inductive variable</a> (Induction Variable, IV).  If such a variable is used to provide access to the array and the cycle goes through all its elements, the check can be omitted if the variable max is explicitly set to the value corresponding to the length of the array. <br><br>  Consider an example in which the code uses the variable size, which plays the role of the maximum value for an inductive variable. <br><br><pre> <code class="hljs matlab">int sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; <span class="hljs-built_in"><span class="hljs-built_in">size</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   sum += array[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; }</code> </pre> <br>  In the example, the index of the element i is compared with the variable size.  Suppose that size is either specified outside the method and passed to it as an argument, or defined somewhere inside the method.  In any of these cases, the compiler will be unable to conclude whether the value in the variable size matches the length of the array.  As a result of this kind of ambiguity, the compiler will have to generate a verification code for the output of the i value beyond the array, which will fall into the executable file and will be executed during each array access operation. <br><br>  We will remake the cycle so that the compiler gets rid of the check for going beyond the array boundaries in the executable code. <br><br><pre> <code class="hljs matlab">int sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; array.<span class="hljs-built_in"><span class="hljs-built_in">length</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   sum += array[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; }</code> </pre> <br><h2>  <font color="#0071c5">Elimination of overrun checks for multiple arrays</font> </h2><br>  In the previous section, we looked at the simplest case of optimization and what should be done in order for the compiler to generate code in which there are no checks that the array is out of range.  However, there are algorithms in which several different arrays having the same length are processed in the same cycle.  For example, if you process two arrays in a loop, the compiler will have to perform a null check for each of them and an exit beyond the bounds. <br><br>  Let us take a closer look at the optimization technique applied to processing in a loop of several arrays.  Often, in order to allow the compiler to optimize the loop, you need to rewrite the code.  Here is the original version. <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; age.<span class="hljs-built_in"><span class="hljs-built_in">length</span></span> ; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   totalAge += age[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>];   totalSalary += salary[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; }</code> </pre> <br>  There is a problem in it.  The program does not check the length of the salary array in any way, as a result there is a risk of getting an exception exceeding the array bounds.  Such a check should be provided, for example, at the entrance to the cycle. <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; age.<span class="hljs-built_in"><span class="hljs-built_in">length</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; salary.<span class="hljs-built_in"><span class="hljs-built_in">length</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   totalAge += age[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>];   totalSalary += salary[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; }</code> </pre> <br>  The Java program now looks much better, but with this approach a check will be made in the machine code to go beyond the bounds of the arrays. <br>  In the above cycle, the programmer works with two one-dimensional arrays: age and salary.  And although an inductive variable is tested by comparing with the lengths of two arrays, the condition here is multiple and the compiler cannot exclude from the executable code the check of the output beyond the boundaries of arrays. <br><br>  Arrays that we access in cycles are data structures that are stored in different memory areas.  As a result, the logical operations performed on their properties are independent.  Rewrite the code, dividing one cycle into two. <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; age.<span class="hljs-built_in"><span class="hljs-built_in">length</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   totalAge += age[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; }         <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>;  &lt; salary.<span class="hljs-built_in"><span class="hljs-built_in">length</span></span>;  <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   totalSalary += salary[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>]; }</code> </pre> <br>  After the separation of the cycles, the optimizing compiler will exclude from the executable code a check for overrun for both the age array and the salary array.  As a result, Java code can be speeded up three to four times. <br><br>  The optimization was successful, but now the function contains two cycles, not one.  Such an approach can lead to an unjustified proliferation of source code sizes.  Depending on the target architecture and loop sizes, or the number of similar optimizations, this can affect the size of the generated executable code. <br><br><h2>  <font color="#0071c5">Methods of multi-threaded programming</font> </h2><br>  In a multithreaded program, care should be taken when working with data structures. <br><br>  Suppose a program runs four identical threads before entering the loop, shown below.  Each of the threads then works with an array of integers called <code>thread_array_sum</code> .  Each thread changes one of the cells in the array, whose address, which is the unique integer identifier of the thread, is specified in the <code>myThreadIdx</code> variable. <br><br><pre> <code class="hljs matlab"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; number_tasks; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   thread_array_sum[myThreadIdx] += doWork(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); }</code> </pre> <br>  The last level Cache (LLC) cache shared by all processor cores is not used in some hardware architectures, for example, in the Intel Atom x5-Z8000 processor line.  Split-LLC is a potential reduction in response time, since for each processor core (or two cores) its own cache is ‚Äúreserved‚Äù.  However, you need to maintain consistency caches.  Therefore, if a thread running on kernel A changes data that a thread running on kernel B never changes, the corresponding lines <a href="https://en.wikipedia.org/wiki/False_sharing">will have to be updated</a> in the cache of kernel B.  This can lead to a drop in performance and problems with kernel scaling. <br><br>  Due to the peculiarities of the cache architecture, if several threads write data to a single array, there is a risk to face a drop in system performance due to the possible high level of cache slip.  In this situation, the programmer should use a local variable to store the results of intermediate calculations, and after they are completed, write the result to an array.  With this approach, the above cycle can be converted: <br><br><pre> <code class="hljs matlab">int tmp = <span class="hljs-number"><span class="hljs-number">0</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span> &lt; number_tasks; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) {   tmp += doWork(<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>); } thread_array_sum[myThreadIdx] += tmp;</code> </pre> <br>  In this case, the element in the <code>thread_array_sum[myThreadIdx]</code> array is not affected within the loop.  The total value resulting from the execution of the <code>doWork()</code> function is stored in an array element outside the loop.  This greatly reduces the potential risk of cache slipping.  A slip may occur with a single reference to the array shown in the last line of code, but this is much less likely. <br><br>  It is not recommended to use shared data structures in loops, unless the values ‚Äã‚Äãstored in them should be available to other streams after the completion of each iteration.  In such cases, it is usually necessary to at least use the fields or variables declared with the volatile keyword, but talking about it is beyond the scope of this article. <br><br><h2>  <font color="#0071c5">Optimized for small memory devices</font> </h2><br>  There are very different, in terms of the amount of RAM and permanent memory, Android device.  Java programs should be written so that they can be optimized regardless of the amount of memory.  So, if the device has low memory, then one of the optimization factors is the size of the code.  This is one of the ART options. <br><br>  In Marshmallow, methods larger than 256 bytes are not precompiled in order to save permanent memory on the device.  Therefore, Java applications that contain frequently used methods of large size will be executed on the interpreter, which will adversely affect performance.  In order to achieve a higher level of application performance in Android Marshmallow, implement frequently used code fragments in the form of small methods so that the compiler can fully optimize them. <br><br><h2>  <font color="#0071c5">findings</font> </h2><br>  Each release of Android is not only a new name, but also new elements of the system and technology.  So it was with KitKat and Lollipop, this also applies to the transition to Marshmallow, which brought significant changes in the compilation of applications. <br><br>  As is the case with Lollipop, ART uses the Ahead-of-Time compilation method, and applications are usually converted to native code during installation.  However, instead of using the quick compiler (Lollipop), Marshmallow uses a new compiler - Optimizing compiler.  Although in some cases the optimizing compiler transfers the work to the old one, the new compiler is the main subsystem for creating binary code from Java-texts on Android. <br><br>  Each compiler has its own features and optimization tools, so each of them can generate different machine code depending on how the Java application is written.  In this article, we talked about a few main features that can be found in Marshmallow, about what developers need to know when creating applications for a new platform. <br><br>  There are many innovations in the optimizing compiler.  Some of them are difficult to show with examples, since most of the improvements are happening, so to speak, ‚Äúunder the hood‚Äù.  What we know is that as the Android compiler matures, one can observe how the technologies underlying it become more and more advanced, it is gradually catching up with other optimizing compilers. <br><br>  The Android compiler is constantly evolving, developers can be sure that the code they write will be well optimized.  So, their applications will delight users with speed and pleasant impressions from interaction with them.  We are sure that the one who will work with such programs will appreciate it. </div><p>Source: <a href="https://habr.com/ru/post/300934/">https://habr.com/ru/post/300934/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../300922/index.html">Happy birthday, Alan Key«É (or how to get +80 to IQ)</a></li>
<li><a href="../300924/index.html">Honor cup</a></li>
<li><a href="../300926/index.html">Report from the RISSPA workshop April 20</a></li>
<li><a href="../300928/index.html">Why is it worth hiring a junior</a></li>
<li><a href="../300930/index.html">How to make a quick web application or 8 tips to developers on code optimization</a></li>
<li><a href="../300936/index.html">Banks need a mobile</a></li>
<li><a href="../300940/index.html">The very personal story of Evan Spiegel, the creator of the Snapchat service - an inside view</a></li>
<li><a href="../300942/index.html">Test aiohttp with a simple chat</a></li>
<li><a href="../300944/index.html">What does the return of Megamind for companies in Habr√© mean</a></li>
<li><a href="../300946/index.html">Template language for the universal signature code analyzer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>