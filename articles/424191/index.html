<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mobile watchman on Raspberry pi (h.264)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The themes of using Raspberry pi for FPV control and motion monitoring in a frame of H.264 vectors are not new. The development does not claim to orig...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mobile watchman on Raspberry pi (h.264)</h1><div class="post__text post__text-html js-mediator-article">  The themes of using Raspberry pi for FPV control and motion monitoring in a frame of H.264 vectors are not new.  The development does not claim to originality, and the time was spent on it relatively little (from July to weekends. Sometimes.). <br><br>  But, probably, my experience (and source codes) will appear to whom be useful. <br><br>  The idea that you need to make a video observation in the apartment, arose after a neighbor said that someone was digging into the door lock. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first thing that was done in a hurry was to install the famous motion program on Raspberry pi zero with a camera v1.3.  In principle, the problem solves.  If arranges the notification through mail and fps = 4-5. <br><br>  But it did not seem interesting.  At hand was a platform with wheels and strapping from old experiments and 18650 batteries from old laptops. <br><br>  The result was a fun mix of mobile video surveillance and motion detection. <br>  Since I have a rented VPS, there were no problems with access from outside (home grid behind NAT).  The battery life is about 4 days if you do not abuse the ride and the headlamp. <br><br>  You can travel around the apartment, remotely controlling both the camera and the platform, and leave it in the ‚Äúwatch‚Äù mode (motion detect) at any desired location. <br><br><img src="https://habrastorage.org/webt/fm/bz/hr/fmbzhriyrbtmqotgwhvk28uexlm.jpeg"><br><br><a name="habracut"></a><h1>  Hardware </h1><br>  All "iron" can be divided into two parts, the first of which does not depend on the second and can be used separately: <br><br><h4>  Video surveillance module </h4><br><ul><li>  Raspberry pi zero </li><li>  USB WiFi Dongle </li><li>  Raspberry pi camera v1.3 </li><li>  2x stepper motors 28BYJ-48 + ULN2003 driver </li></ul><br><h4>  Mobile platform managed via SPI from raspberry </h4><br><ul><li>  4S 16x18650 Li-ion + 4S 30A Li-ion 18650 (BMS) board + DC-DC charging with current and voltage stabilization </li><li>  dc-dc step down converter (15v -&gt; 5v). </li><li>  stm32f103c8t6 board </li><li>  4x gear motors + L298N board </li><li>  12v LED lamp (headlight) + control on IRF3205 (+ smd pnp and npn) </li></ul><br>  The Raspbian image has been set to read only mode.  In this configuration, the raspberry easily experiences unexpected power off, since the SD card is not used for recording at all. <br><br><h1>  Software </h1><br>  The software consists of 3 separate components. <br><h4>  Android app (tested on LG6 Oreo and old Samsung S5 Lollipop) </h4><br>  <b>FPV mode</b> <br><br><ul><li>  Displaying H.264 video stream from the camera at the specified resolution and bitrate </li><li>  Elements control the camera and platform </li><li>  Record video and photo from the stream. </li></ul><br>  <b>Android service mode</b> <br><br><ul><li>  Poll host (with the specified frequency) </li><li>  Upload a photo of the event "motion" in the frame of the event. </li></ul><br><h4>  Python host Raspberry pi (picamera + spidev + RPi.GPIO) </h4><br>  <b>FPV mode</b> <br><br><ul><li>  Broadcast H.264 stream (with the parameters specified by the Android application) </li><li>  receiving control commands for stepper motors and their control. </li><li>  Transmission of control commands via SPI (if enabled) </li></ul><br>  <b>Tracking mode of movement in the frame.</b> <br><br><ul><li>  Motion detection in the frame (according to the parameters specified by the Android application) </li><li>  Receiving requests "is there a movement in the frame" and uploading photos on request </li><li>  Sending to the host (regardless of the application) photo movements in the frame. </li></ul><br>  <b>The simplest firmware on stm32f103</b> <br><br><ul><li>  Receive SPI commands </li><li>  Control the direction of rotation of the wheels and PWM engines. </li><li>  Headlight control. </li></ul><br><h1>  Motion tracking </h1><br>  Tracking by the h.264 vectors was very capricious and prone to false positives.  Very few options for implementing motion detection for H.264 are walking around the network.  I tried them all. <br><br>  The most primitive option is to count the number of vectors whose length exceeds a certain threshold value.  And if some vectors are greater than the threshold, then this is a signal that there is movement in the frame. <br><br>  Alas.  This option is only for demonstration of the principle.  There are too many false positives.  Especially on surfaces of uniform color and texture. <br><br>  All other options either give the same too many false positives, or simply do not pass the performance criterion: ‚Äúmust be processed during the frame time‚Äù. <br><br>  As a result, chose his option.  Though he practically does not give false positives, but requires movement in several frames in a row.  But this is better than false alarms several times a day due to changes in illumination or in general due to incomprehensible ‚Äúmovements‚Äù in the frame according to the ‚Äúsolution‚Äù of the camera.  The topic of reliable detection algorithms for mv H.264 is generally a separate complex topic.  Algorithms require a lot of time for practical debugging and I have tight limits on the execution time. <br><br>  An example of motion vectors (snapshot service modes): <br><br><img src="https://habrastorage.org/webt/ga/14/gv/ga14gvgp-rljxqu7-0cdrrhdvvw.jpeg"><br><br><img src="https://habrastorage.org/webt/ya/yz/sv/yayzsvkjptyuqafxeg3aevdyfhq.jpeg"><br><br>  On events "movement in the frame" generated notifications. <br><br><img src="https://habrastorage.org/webt/7w/of/kf/7wofkfeel3yhp6k-vt4m7sw51pg.jpeg"><br><br>  In principle, for my purposes, it turned out to be enough guaranteed triggering when a human figure moves (&gt; 15% of the frame) for at least 2 seconds.  With such a desensitization of sensitivity, false positives simply did not see at all. <br><br><h3>  Motion control. </h3><br>  Management of the platform "on the tractor."  Those.  control PWM and the direction of rotation of the left and right side.  Control elements (stripes) under the thumbs of both hands.  This turned out to be the most natural for me. <br><br><img src="https://habrastorage.org/webt/bk/qk/fn/bkqkfn7r2qda8cgikzkcw7a8vae.jpeg"><br><br>  Camera control - two strips; touching of which gives the command to turn a certain angle (the farther from the center of the stripe - the greater the angle).  Continuous control as for motors turned out to be inconvenient (again, subjectively for me). <br><br><img src="https://habrastorage.org/webt/_g/jw/bs/_gjwbsyivgtnnknnbohpoexfgqs.jpeg"><br><br><h3>  Lags fpv </h3><br>  Video lags turned out to be relatively small (&lt;1 sec). <br><br>  To control the wheel platform with a maximum speed of 3-4 km / h at 100% PWM lag of 0.6 seconds - this is quite normal and almost not noticed. <br><br>  However, it seems to me that even 0.3 sec lag for, for example, a quadrocopter is a lot. <br><br>  Tests showed that the implementation of translation in python makes a lag somewhere 50-70ms, compared with the issuance of the same H.264 stream through the rapivid.  For me, these 70ms are not fundamental.  But if someone wants to squeeze the maximum, he should take this into account. <br><br>  When working via ‚Äúlocal WiFi‚Äù (phone as access point), the lag is 350.600ms.  But not more than 0.6 seconds and is stable in this range.  Although, 50-70 meters of distance in the open area is only a play.  And at a greater distance WiFi from the phone does not work. <br>  It is worth noting that it is in a very ‚ÄúRF noisy‚Äù environment of apartment buildings, with a lot of WiFi networks in the area. <br><br><img src="https://habrastorage.org/webt/zw/bx/-y/zwbx-yzkmwqb0r8p2flbur5u__o.jpeg"><br><br>  I was surprised by the result in the configuration ‚ÄúWiFi router -&gt; provider over twisted pair -&gt; VPS -&gt; MTC 4G on the phone‚Äù via ssh port forwarding from raspberry to VPS. <br>  The typical log turned out to be even slightly better than through local WiFi (!) <br>  Even on the go in a car or near a large hypermarket, the lag is only 300ms. <br><br>  However, sometimes (quite rarely and not predictably), the lag became up to several seconds.  It helps re-connect.  Probably, these are some features of 4G / MTS / providers in the chain, etc. <br><br><img src="https://habrastorage.org/webt/qm/bb/2v/qmbb2vsylq_qlv66rlpfz2x_d2e.jpeg"><br><br>  After everything worked, there was a desire to connect the audio channel in both directions.  Technically it is possible and not even very difficult.  But I no longer want to mess around with a soldering iron. <br><br>  If there were no ‚Äúextra‚Äù Rasberry pi on hand, then instead of it it would be easier to use the old phone as a video surveillance and platform management host.  The only advantage of the raspberry over the old phone is less weight.  And, maybe, smaller power consumption (did not compare). <br><br>  <a href="https://github.com/mmMikeKn/Rpi-Android-VideoStreamAndMotionDetect"><b>All sources</b></a> </div><p>Source: <a href="https://habr.com/ru/post/424191/">https://habr.com/ru/post/424191/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424177/index.html">Connecting the Grandstream GXW4104 FXO Gateway to 3CX</a></li>
<li><a href="../424183/index.html">October 4, Moscow - Backend Stories 2.0</a></li>
<li><a href="../424185/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ331 (September 17 - 23, 2018)</a></li>
<li><a href="../424187/index.html">Conference DEFCON 22. Adrian Crenshaw. What can ‚Äúburn‚Äù users TOR</a></li>
<li><a href="../424189/index.html">Smart House? Or not smart ???</a></li>
<li><a href="../424193/index.html">International Astronautical Congress - as it was in Australia</a></li>
<li><a href="../424197/index.html">Into the MVPs furnace, we introduce MVPr (minimum viable prototype)</a></li>
<li><a href="../424199/index.html">We build simple GraphQL API server on express and nodeJS</a></li>
<li><a href="../424201/index.html">How machine learning has helped me understand some aspects of early child development.</a></li>
<li><a href="../424203/index.html">Procedural building</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>