<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ansible is not so simple</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have three servers, but I'm not a professional sysadmin. This means that despite the four databases and applications, backups are not conducted anyw...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ansible is not so simple</h1><div class="post__text post__text-html js-mediator-article"> I have three servers, but I'm not a professional sysadmin.  This means that despite the four databases and applications, backups are not conducted anywhere, I come up with any problem on the server, sighing loudly and throwing the plate into the wall, and the operating systems reached EOL there two years ago.  I would be happy to update, but this must be allocated, probably, a week to save and rearrange everything.  Simply forget about <code>yum update</code> and <code>apt-get upgrade</code> . <br><br>  Of course, this is wrong.  I have long been eyeing the chef and Puppet, which I thought would solve all my problems.  But I looked at the configs of familiar projects and put it off.  It is also necessary to study, deal with ruby, fight with numerous, according to reviews, jambs and restrictions.  Two weeks ago, <a href="https://habrahabr.ru/post/343644/">an article by</a> George <a href="https://habrahabr.ru/users/amarao/" class="user_link">amarao</a> became a life-giving kick.  Not even the article itself, but a listing of configuration management systems.  After reading the comments and easy googling, I decided: I'll take Ansible.  Because the python, and no one complains about the problems. <br><br><img src="https://habrastorage.org/webt/or/wx/pl/orwxplwdbhdbygvfexzmuu4yqaa.jpeg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, then I will be the first. <br><a name="habracut"></a><br>  First, I dug a bunch of documentation and textbooks on Ansible, starting with the useless Quick Start video on the official website.  Of course, there are many of them, made for different tasks and written by different people, but one thing unites them: textbooks were made for people who already understand Ansible.  For people with a spherical server in a vacuum, which is enough to suggest that there are roles, modules and tasks.  But I came with a clean slate and collected all the rakes that I found.  I hope this article will help you get around them. <br><br>  From the configuration management systems, I was waiting for miracles, such as automatically updated applications from git.  But it turned out that Ansible is only a way to preserve the sequence of actions when setting up a new server.  You can do in Ansible only what you can do from the console yourself.  There are no miracles. <br><br><h2>  Start.  Vagrant </h2><br>  Task: I do not make a new host, because I want to save ip.  That is, I will clear the droplet through the control panel, then initialize with Ansible.  Plan: write a playbook and debug it on Vagrant. <br><br>  Getting started is very difficult.  All Ansible textbooks begin with a description of inventory, where you need to write the server address.  But what is the ip of the vagrant?  God knows.  The Ansible documentation has instructions on how to run a playbook in Vagrant;  The Vagrant documentation has instructions on how to connect Ansible, and they are not exactly identical.  As a result, I scored on an ip search and took a general one: the minimum <code>Vagrantfile</code> that launches the playbook. <br><br><pre> <code class="ruby hljs">Vagrant.configure(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|config|</span></span> config.vm.box = <span class="hljs-string"><span class="hljs-string">"ubuntu/xenial64"</span></span> config.vm.network <span class="hljs-string"><span class="hljs-string">"forwarded_port"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">guest:</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">host:</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span> <span class="hljs-comment"><span class="hljs-comment">#    ,  : config.ssh.insert_key = false config.vm.provision "ansible" do |ansible| ansible.verbose = "v" ansible.playbook = "playbook.yml" end end</span></span></code> </pre> <br>  I sketched a playbook draft, created role blanks, and launched <code>vagrant up</code> .  Did not take off.  Since the official xenial image is only for VirtualBox, and in Fedora Linux virtualization is through libvirt.  Long remembered the correct command: <code>vagrant up --provider virtualbox</code> .  Then syntax errors in yaml rules (why are there three mandatory hyphens at the beginning?).  Remember that after starting the box to restart Ansible we write <code>vagrant provision</code> . <br><br>  And the first surprise: in the Ubuntu 16.04 box there is no default python!  Wildness for Fedora, where the package manager is written in python.  Ansible, as I found out, uploads its modules to the server and executes them there.  We go to StackOverflow, we find the magic task (more precisely, ten variations of one task and it is not clear how best): <br><br><pre> <code class="hljs sql">- name: <span class="hljs-keyword"><span class="hljs-keyword">Install</span></span> python <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Ansible become: yes <span class="hljs-keyword"><span class="hljs-keyword">raw</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> -e /usr/<span class="hljs-keyword"><span class="hljs-keyword">bin</span></span>/python || (apt -qy <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; apt <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -y python-minimal) <span class="hljs-keyword"><span class="hljs-keyword">register</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">output</span></span> changed_when: output.stdout</code> </pre> <br><h2>  Superuser, become! </h2><br>  Even with the documentation and examples, much is not clear.  I don‚Äôt understand, for example, why Vagrant redefines <code>remote_user</code> , and how it turns out that there is a superuser in each box.  I will run the playbook on a clean server, where there will be only root, and I will need to make my superuser.  But doing it under a vagrant is needed differently than on a clean server, apparently.  In general, it is not clear: will there be two playbooks for staging and production? <br><br>  Or here you are <code>become</code> and <code>become_user</code> : one does not mean the other.  What of this need to be specified in the root playbook, if you constantly need to enable root to configure the server?  I first put <code>become: yes</code> and in every second task I wrote <code>become_user: root</code> .  Then it turned out that without <code>become_user</code> everything also works from root!  Because root is the default value and I, in fact, made <code>sudo -i</code> from the very beginning without being able to let go. <br><br>  Somewhere here, I remembered that I had not updated the system on my laptop for a long time, and launched <code>dnf update</code> .  Continuing to pop up with the playbook.  Vagrant worked, and dnf in the next tab updated VirtualBox.  It seems that it is not necessary to do this, because the next <code>vagrant provision</code> said: ‚Äúeverything broke and I am not guilty.‚Äù  It lacked VirtualBox, which ‚Äú <i>terminated unexpectedly during startup with exit code 1 (0x1)</i> ‚Äù - and even though you are cracking.  The <code>vboxheadless -h</code> command (I'm not a real devops, I googled) showed the error -1912.  On the Internet, one and all answer: reinstall VirtualBox.  Fuck it does not help.  Desperate, I found the xenial box for libvirt and switched to it.  Well, when there is a choice. <br><br>  From some example I copied the call to the apt call with a bunch of parameters, and then I learned that it would be nice to do <code>update_cache=yes</code> as a separate task.  And this task, that's the trouble, all the time returns "changed".  It turned out that you need to register <code>cache_valid_time=3600</code> to check for updates no more than once per hour.  At first I thought to write 86400 (day), but I'm not going to call Ansible in the crown, and let it live once a month. <br><br><h2>  Deploy the database </h2><br>  PostgreSQL installation - five lines in the console or the whole epic in Ansible.  At some point, you need to make <code>become_user: postgres</code> .  And here the box produced a strange error: "It was <i>an unrealized user</i> ."  Remember how Ansible loads modules on the server and starts there?  Well, he downloads them from root or from another superuser, and then the postgres user does not have access to them.  Here is bad luck. <br><br>  StackOverflow to help again: it turns out there are three ways out.  One of them is to make <code>ansible.cfg</code> and write <code>pipelining=True</code> inside (and to solve some other arising problem, I temporarily set <code>pipelining=False</code> ).  The second way out - literally, ‚Äúdo not do this.‚Äù  And the third is the simplest: put the <code>acl</code> package and everything works in a magical way.  Rather, it does not work in another way: " <i>sudo: a password is required</i> ".  Well, what's the deal, where are the passwords here at all, do I enter with the key? <br><br>  It turned out, I go to a virtual machine without a key, a vagrant user.  Which was made before us and for us.  Ansible with <code>become_user</code> , apparently, does <code>sudo -u postgres</code> , but it requires the password of the user vagrant.  There is no password. <br><br>  I'm starting to sort through the options.  <code>become_method: su</code> timed out because the server asks for a password, but Ansible does not understand this.  What he does there is not clear, because <code>sudo su postgres</code> does not ask me for a password.  There is an option in the <code>/etc/sudoers.d/vagrant</code> file <code>/etc/sudoers.d/vagrant</code> write ‚Äú <code>vagrant ALL=(ALL) ...</code> ‚Äù, because the word in brackets will allow you to do <code>sudo -u</code> without a password.  But then the playbook becomes sharpened by Vagrant, and I still have to run it in the sale.  Inaccurately. <br><br>  From hopelessness, I try to remove <code>become</code> .  Postgres expected squeeze: " <i>Peer authentication failed for user" postgres</i> "."  Digging up a stewardess.  New plan: to run a role under the user zverik, who has everything in the world right.  I split the playbook into two: in the first I install the python and make the user, the second I install and configure everything else with <code>remote_user: zverik</code> .  I run.  And again " <i>sudo: a password is required</i> ".  Why?  Well, yes, Vagrant passes the value of <code>remote_user</code> and does not allow it to change.  Well damn. <br><br>  In order to distract himself, he opened a text editor and began writing these notes.  At this point, I have been working with Ansible for a week and a half to two hours, and I have not even created a database in the post-gres.  In the textbooks, it all looks so simple ... I counted the tabs associated with Ansible in firefox: 48 pieces.  Forty eight.  Approximately one sixth of the total. <br><br>  Then I disabled <code>ansible.force_remote_user</code> in Vagrantfile and restarted <code>provision</code> .  Hurray, a new mistake!  Reminds that the user login zverik works only with a certificate.  But I also have a certificate, and <code>vagrant ssh -p</code> works and lets in without a password.  Googled the solution: you need to specify the path to the certificate in <code>ansible.cfg</code> .  It will not work for the same reason as <code>remote_user</code> : Vagrant wins.  This time it's easier to override the main variable: add the ‚Äú <code>ansible_ssh_private_key_file: "{{ lookup('env', 'HOME') }}/.ssh/id_rsa"</code> , and everything works!  Not very nice, but hurray! <br><br>  After I dealt with the users, the writing of the roles went smoothly.  Already ready one role out of six, sixty task.  But starting is more difficult than it seems in the textbooks. <br><br><h2>  Useful stuff </h2><br>  While writing playbooks, you find or google a lot of useful little things.  Some are described in the documentation, some - in the articles (look for "Ansible" on Habr√©).  Here are a few of them. <br><br>  For command execution - only <code>command</code> or <code>shell</code> modules.  The latter, as the documentation writes, only in extreme cases, so forget about redirecting the output and <code>&amp;&amp;</code> .  The result is always "changed", which is bad.  Manage the result with either the <code>creates</code> parameter (more conveniently - in the <code>args</code> block, along with <code>chdir</code> ), or <code>register</code> and <code>changed_when</code> .  It is useful to check the conditions before the execution: first, <code>command + register + changed_when: False</code> reconnaissance, and then with the help of <code>when</code> check the stored stdout to start the command. <br><br>  The fewer <code>command</code> module calls, the better.  Google: there is almost always a module.  For example, I first did <code>command: npm install -g {{ item }}</code> , and then I discovered that you can <code>npm: name={{ item }} global=yes</code> .  A module is always better than a command, because there is no need to check the configuration and because the result of the work will not be in the stdout line, but in a convenient structure. <br><br>  Configuration files are almost always governed by <code>lineinfile</code> , which searches for a line by a regular expression and replaces it with another.  The <code>blockinfile</code> module adds whole blocks of text.  There is a nuance with it: if several tasks are written into one file, then you need to override the <code>marker: # {mark} block name</code> .  Otherwise, everyone will overwrite other blocks. <br><br>  Before modifying PostgreSQL tables, it is convenient to check their status with pg_tables.  For example: <br><br><pre> <code class="hljs swift">command: psql -<span class="hljs-type"><span class="hljs-type">A</span></span> -t -d {{ gisdb }} -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-string"><span class="hljs-string">"SELECT tableowner FROM pg_tables WHERE schemaname = 'public' AND tablename = 'spatial_ref_sys'"</span></span></code> </pre> <br>  Inheritance is our all: if you can, instead of two almost identical tasks, write one with conditional expressions and <code>with_items</code> , then do so.  A group of repetitive tasks with similar parameters are taken into a separate file and called via <code>include_role</code> with <code>vars</code> .  There still has to be about parameterization of roles, but I'm still learning and I have one role. <br><br>  In one of the articles I found advice not to reinvent the bicycle, but to look for suitable roles in the <a href="https://galaxy.ansible.com/explore">Ansible Galaxy</a> catalog.  Indeed, php-fpm and postfix put thousands of people before you, and often there is a well-written role with convenient default values. <br><br>  On the other hand, what's the point of downloading the role of <code>geerlingguy.apache</code> , when <code>apt: pkg=apache2</code> solves all my tasks?  Or, here, I found the role to install osm2pgsql from the sources, and it is 2014 and outdated <code>sudo: yes</code> .  That is, I, of course, recorded <code>roles_path = roles.galaxy:roles</code> in <code>ansible.cfg</code> and made a playbook to install all the roles, but there is nothing to set yet.  Here is what it looks like: <br><br><pre> <code class="hljs cmake">- hosts: localhost vars: galaxy_path: roles.galaxy tasks:   - name: <span class="hljs-keyword"><span class="hljs-keyword">Remove</span></span> old galaxy roles     <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>: path={{ galaxy_path }} state=absent   - name: <span class="hljs-keyword"><span class="hljs-keyword">Install</span></span> Ansible Galaxy roles     local_action: <span class="hljs-keyword"><span class="hljs-keyword">command</span></span> ansible-galaxy <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -r requirements.yml --roles-path {{ galaxy_path }}</code> </pre><br>  And in the <code>requirements.yml</code> write lines for each role from the Galaxy: <br><br><pre> <code class="hljs markdown"><span class="hljs-bullet"><span class="hljs-bullet">- </span></span>src: .</code> </pre> <br>  Have you written a playbook and did it work in Vagrant to the end?  Great, now do <code>vagrant destroy</code> and re-create the box.  Absolutely find several jambs: forgotten sudo, missing mode: 0755 for executable files, missing packages (help <code>dnf provides</code> or <code>apt-file</code> to be installed).  Finally, the most important thing: after the second launch of the <code>vagrant provision</code> should be "changed: 0". <br><br><h3>  *** </h3><br>  Transferring servers to a configuration management system is difficult, no matter what system you choose.  But after the initial rake field, the programming of the playbook arises.  The main thing - do not forget about the goal, so as not to burn out: there, now I have the target OS Ubuntu 16.04, and in a month I will transfer the server to 18.04 without too much difficulty.  And the pleasure of a full-featured server from scratch one by one in the console will help along the way. </div><p>Source: <a href="https://habr.com/ru/post/352616/">https://habr.com/ru/post/352616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352606/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ308 (March 26 - April 1, 2018)</a></li>
<li><a href="../352608/index.html">What we should build Scrum: an interview with Agile-coach Vasily Savunov</a></li>
<li><a href="../352610/index.html">As I did Hot-Spot through Virtual Box</a></li>
<li><a href="../352612/index.html">Virtual server on VPS.house: performance review</a></li>
<li><a href="../352614/index.html">How to solve 90% of NLP tasks: a step-by-step guide to natural language processing</a></li>
<li><a href="../352618/index.html">How to switch to microservices and not break production</a></li>
<li><a href="../352620/index.html">We open the history of the Bolshoi Theater. Part one</a></li>
<li><a href="../352622/index.html">Performance analysis of the drive Intel Optane SSD 750GB</a></li>
<li><a href="../352624/index.html">The Metrix has you ...</a></li>
<li><a href="../352626/index.html">Storage options for cryptographic keys</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>