<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Antispam in Mail.Ru: how a machine recognizes a hacker by his behavior</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bat's post delivery by sashulka 

 E-mail is used to solve a wide range of tasks: we get information about bank accounts, discuss work projects, plan ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Antispam in Mail.Ru: how a machine recognizes a hacker by his behavior</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/bf6/141/51d/bf614151d25e418ebc028491eee91008.jpg"><br>  <a href="http://sashulka.deviantart.com/art/Bat-s-post-delivery-570372073">Bat's post delivery</a> by sashulka <br><br>  E-mail is used to solve a wide range of tasks: we get information about bank accounts, discuss work projects, plan trips and much more, which requires us to exchange valuable information.  Thus, mail contains a lot of important and confidential data.  And of course, our task is to protect them reliably. <br><br>  We are constantly working on systems that provide accounts with several levels of protection and significantly complicate the lives of intruders.  But there is one weak link.  This is a password that can be guessed or, for example, stolen on a third-party service.  More information about password theft and mail security can be found in a <a href="https://habrahabr.ru/company/mailru/blog/169801/">post</a> on this topic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our task is to protect the user's box, even if the attacker has learned the password and can enter the account.  To do this, we have developed a machine learning system that analyzes the behavior in the account and tries to determine who is in it - the owner or hacker. <br><a name="habracut"></a><br><h1>  How to recognize a burglar? </h1><br>  While working on security tasks, we considered the following scenario: an attacker has a login, password, and the ability to successfully authenticate.  In this case, the owner of the box can still work in your account and not suspect anything about hacking.  We faced a question: is it possible to somehow understand that an attacker is acting in the account?  We analyzed many examples of account theft and made sure that hacking almost always involves a change in behavior.  We decided to use behavioral characteristics as signs and on the basis of them to conclude whether the account was hacked or not.  And of course, in solving this problem, we could not do without machine learning. <br><br><h1>  How to describe the behavior? </h1><br>  Different users use email differently.  Someone starts a working day at ten in the morning, enters the mail, deletes mailings, cleans the Spam folder, then goes to Mail.Ru Cloud, and then goes to read Mail.Ru News.  And someone works late in the evening, never deletes letters and conducts correspondence only from mobile devices. <br><br>  To describe this activity use a number of different signs.  For example, user actions (reading and sending letters, deleting, moving between folders), devices from which the user works in the account, his geographical location.  You can also take into account transitions to related services and the time of day, which account for the peak of user activity.  In addition, there are more complex features, such as <i>printed handwriting</i> .  This approach takes into account the speed of typing and the pause between keystrokes.  With the printed handwriting, two people can be distinguished just as if we asked them to write a few sentences on paper. <br><br>  At the system design stage, we decided to start with an analysis of user actions, devices, and geographic location.  In our opinion, this is the minimum required set of features, without which it is difficult to manage, and which is easy to add if in the future new requirements will be imposed on the system. <br><br><h1>  How to build a profile? </h1><br>  The basis of our system is the following principle: each user has his own habits, and any activity in the mail must be compared with these habits.  If the behavior significantly deviates from the patterns that have formed, it is a reason to suspect an account hacking. <br><br>  A set of stable habits is called a profile.  To analyze the behavior in the account, for each user we decided to build: <br><br><ul><li>  account action profile; </li><li>  geographical location profile; </li><li>  profile of devices used. </li></ul><br>  Consider for example the construction of the most complex profile - action profile.  For example, we have a part of the log, from which we want to extract the characteristic habits of the user. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/6f8/d0c/c86/6f8d0cc86fe44751b8656f6843b905d8.png"></div><br><br>  In this example, <i>check</i> is mail checking, <i>read</i> read message, <i>send</i> send message. <br>  In the first step of the algorithm, we will generate all possible combinations of actions that the user can perform in the mail.  Let's call them <i>possible patterns</i> .  Next, you need to check the frequency characteristics of possible patterns.  The most frequent patterns reflect the user's habits.  Those that are rare, habits are not, so we exclude them from further consideration. <br><br>  All possible patterns that match the example of the log in question look like this. <br><br><img src="https://habrastorage.org/files/e4e/151/bb5/e4e151bb5fcc4192b40720da1101adcb.png"><br><br>  In general, a log can be used to build a profile for a long period of time: for several weeks, for example.  During this time, the user has entered the mail many times and solved many problems.  But it is obvious that you need to analyze short-term activity sessions, during which the user solved a specific task: he wrote a letter, cleaned a folder, created filters, and so on. <br><br>  The selection of such sessions is a complex independent task that we wanted to simplify.  We decided to try to cut sessions from the log at random: take any action in the log with equal probability as the beginning of the session, and get its duration using some random variable.  In this case, the session length must satisfy two requirements: <br><br><ul><li>  it must be positive; </li><li>  long sessions should have a small probability, as users solve their problems in the mail for short periods of time. </li></ul><br>  We decided to obtain the desired session lengths using a gamma distribution, since it is its implementations that meet the specified requirements. <br><br>  Thus obtained chains of actions will be referred to as <i>transactions</i> .  If you take a sufficiently large number of transactions, many of them will overlap with the actual sessions of the user's activity, which means that they reflect his behavior in the mailbox.  A sample log sample is provided below. <br><br><img src="https://habrastorage.org/files/91c/0ef/d4a/91c0efd4a44d4b5e9ed35ac803d86dae.png"><br><br>  Thus, we move away from the source log to a set of transactions, and it is this set that we use as the data for building a profile. <br><br>  Now that moment has come when you need to check which of the possible patterns are really user habits and which are not.  Here we need a set of transactions. <br><br>  For each possible pattern, we calculate the <i>level of support</i> .  This is a value that indicates how often a pattern is found in user actions.  To calculate the level of support of a specific pattern, you need to count the number of transactions that contain this pattern, and divide it by the total number of transactions.  Let's try to calculate the level of support for the <i>‚Äúcheck + read‚Äù</i> pattern. <br><br><img src="https://habrastorage.org/files/2ac/3f4/84c/2ac3f484c7f5450d944c2c8dc4ba388d.png"><br><br>  The <i>‚Äúcheck + read‚Äù</i> pattern was met in four transactions, there are ten transactions in total, which means that the support level of this pattern is 0.4. <br><br>  We perform similar calculations for all patterns. <br><br><img src="https://habrastorage.org/files/7aa/792/832/7aa79283205546ab953e5500c92d790b.png"><br><br>  Thus, we obtain the frequency characteristics of each pattern.  The higher the level of support pattern, the more it reflects the user's habit.  The profile includes those patterns whose support level exceeds a certain threshold.  If we take the threshold equal to 0.5, then the <i>‚Äúcheck‚Äù</i> , <i>‚Äúsend‚Äù</i> and <i>‚Äúcheck + send‚Äù</i> patterns will be included in the profile.  They are marked in red in the picture. <br><br>  So we got a set of patterns that characterize familiar to the user actions in the account.  The described approach is called <i>an association rule search algorithm</i> and is used to extract patterns from data. <br><br>  Using the same algorithm, we build a profile of a user-specific geographical area.  But building a profile by device gave an unexpected result.  But more on that later. <br><br>  Now that we know how to build a profile, we need to understand how to compare mail activity with this profile. <br><br><h1>  How to compare actions with a profile? </h1><br>  We got user habits.  Now you need to understand how his activity in the mail matches these habits.  Consider the transaction <i>‚Äúsearch + search + send‚Äù</i> and try to evaluate numerically how it corresponds to the habits profile (in this transaction, <i>‚Äúsearch‚Äù</i> is a search by mail content). <br><br><img src="https://habrastorage.org/files/7e3/930/c01/7e3930c019d34e579d45780903bee49d.png"><br><br>  To calculate the measure of the similarity of a transaction to a profile, you need to check which patterns from the profile it contains, add the support levels of these patterns and divide by the total number of all patterns in the profile.  In this example, the transaction contains only the <i>‚Äúsend‚Äù</i> pattern, which has a support level of 0.7, and the profile contains three patterns.  Then the measure of similarity, which is called the <i>outlier factor</i> (OF), can be calculated like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f29/4c7/a4f/f294c7a4f7ff420b9bbabf74f268c8d4.png"></div><br><br>  where <i>t</i> is the transaction being tested.  But this measure has one drawback - it does not take into account the noise of the transaction. <br><br>  Consider the transaction <i>‚Äúdelete filter + move message + create folder + search + send‚Äù</i> (deleting the filter, moving a message between folders, creating a folder, searching the mail, and sending a letter) and denote it by <i>r</i> .  Obviously, transactions <i>t</i> and <i>r</i> have equal values ‚Äã‚Äãof the outlier factor measure: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/114/cb7/edb/114cb7edbf1644aaace2581ae7a5d02a.png"></div><br><br>  which is not quite true, because transaction <i>r is</i> very noisy with actions that are not in the profile.  To eliminate this drawback, another measure is introduced - the <i>long outlier factor</i> , which reflects how much the transaction is similar to profile patterns in length.  To calculate the long outlier factor, you need to find the pattern of the maximum length that is contained in the transaction, and divide its length by the length of the transaction.  Under the length of the transaction is to understand the number of unique actions that it contains.  Then we get: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/c69/2f1/f3d/c692f1f3d7f74da3b6de58ff04268e0c.png"></div><br><br>  The LOF metric clearly demonstrates that transaction r is much less similar to a profile than transaction <i>t</i> . <br><br>  Further, based on the <i>outlier factor</i> and <i>long outlier factor</i> metrics, we calculate <i>the</i> transaction <i>suspicion index</i> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5af/369/47c/5af36947c3534c36a5fd1015a0ad23f7.png"></div><br><br>  which will take into account the similarity of the transaction with the profile both in content and in the length of the patterns.  The closer the suspicion index is to 1, the stronger the transaction is uncharacteristic for the user.  And the closer its value is to 0, the more the transaction coincides with the profile.  We calculate the suspicion indices for the considered examples: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8cd/567/199/8cd567199e1e4322b6c7063c8e6d1716.png"></div><br><br>  Now we need a threshold with which we could compare the obtained values ‚Äã‚Äãand decide whether the transaction is abnormal or not.  At this stage, you need to return to the set of transactions obtained by sampling the log, and calculate the suspiciousness index for them. <br><br><img src="https://habrastorage.org/files/60f/7f6/b00/60f7f6b0002d41179bdbfcf3df7e68f5.png"><br><br>  For the user, which we consider as an example, a suspiciousness level of 0.6 is the norm.  We can use this value as a boundary value and compare with it the index of suspiciousness of new transactions. <br><br>  For transactions <i>t</i> and <i>r,</i> we obtained suspicion index values ‚Äã‚Äãof 0.6335 and 0.7835, respectively.  Both values ‚Äã‚Äãexceed the threshold of 0.6, which means that we take both transactions as suspicious. <br><br>  Thus, we learned to determine how the user's actions correspond to his habits. <br><br>  If it becomes necessary to analyze a long chain of actions (for example, user behavior per day), then we cut the chain of actions into transactions using the algorithm described above, and then we check each transaction for suspicion.  If the number of suspicious transactions exceeds a certain threshold, then the behavior for the period in question should be considered abnormal. <br><br>  We use the described algorithms to build a profile of user actions and a profile of his geographic location. <br><br><h1>  How to deal with devices? </h1><br>  Using pattern processing algorithms, we have learned how to distinguish familiar to the user actions in the account and its characteristic geographical region.  In the same way, we tried to build a device usage profile.  And they found out that the change of pattern on this basis is not suspicious.  Each person has his own set of devices and certain patterns of their use.  For example, during the day we work in the mail from a laptop, in the evening from a tablet, and on weekends only from a smartphone.  Devices vary depending on the time of day and day of the week, and this is due to the user's preferences. <br><br>  But still this feature turned out to be very valuable.  After analyzing the hacking scripts and comparing them with the behavior of ordinary users, we noticed that the number of devices can tell about hacking.  And we decided to use this feature in the future.  We compare the number of user devices with a certain critical threshold, and on the basis of this, we decide whether this number is characteristic of a cracker or an ordinary user. <br><br><h1>  How to detect hacking? </h1><br>  As a result, for each user, we get three signs: an index of suspicion by action, an index of suspicion by change of geographic location and the number of devices.  At the very beginning we planned to build a classifier over these signs.  Here it is worth noting that the classifier requires additional costs: for it you need to collect a training sample, keep it up to date and fight retraining. <br><br>  Analyzing the test samples, we noticed the following pattern: exceeding the critical thresholds for two signs out of three corresponded with high precision to cracking. <br><br><img src="https://habrastorage.org/files/8d9/f0a/0b0/8d9f0a0b04d444de89cd8cefbee372c8.jpg"><br><br>  Thus, we have the opportunity to use logical rules and abandon the classifier, which greatly simplified the development, debugging and maintenance of the entire system. <br><br><h1>  How to evaluate false positives? </h1><br>  In Antispam there is one very important requirement - we must not harm our users.  Restricting a user to an account that is not actually hacked is something that needs to be avoided by all means.  Therefore, it was necessary to figure out how to track such false alarms of the system and how to keep statistics on them. <br><br>  For this we have developed the following approach.  For example, a significant change in behavior occurred in the account.  We suspected that the account was hacked, and asked the owner to confirm the identity and change the password.  After changing the password, we assume that only the owner and no one else is in the account.  If, however, after restoring access to the account, the same behavior that previously caused us suspicion continues, then we believe that this behavior is now typical for the user and the system has worked falsely.  We include such cases in the statistics for further research, and the user profiles are updated with new behavioral patterns. <br><br><img src="https://habrastorage.org/files/907/20f/9c1/90720f9c10054cf4a3b63c088451ff42.png"><br><br>  How this approach works can be seen by example.  The characteristic behavior of the user in the mail: regular sending letters from a mobile device from Russia.  At a certain point, the behavior changes completely: in the box, mass searches from the Baltics begin with a personal computer.  The behavior analysis system asks the user to change the password.  After changing the password in the account, the search and sending of letters from the Baltic States continue.  In this case, we replenish the user profile with new behavioral patterns, and consider the first actuation of the system as false. <br><br><h1>  results </h1><br>  We developed a machine learning system that attempts to detect hacking by analyzing user behavior in an account.  Of course, it is too early to talk about a complete solution: there is still a lot of work ahead, and we have to solve a lot of puzzles.  But nevertheless, the results that we have now speak about the prospects of this approach, so we plan to develop it in order to make our services even more reliable. <br><br>  PS: The system is called Marshal (abbreviated from Mail.Ru Suspicious Hacking Alert).  We talked about it in detail at Data Fest, which took place at the Moscow office of Mail.Ru Group on March 5 and 6, 2016.  Video presentations and presentations can be found <a href="https://habrahabr.ru/company/mailru/blog/279775/">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/282375/">https://habr.com/ru/post/282375/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282363/index.html">Open DevOps Expert Meeting April 28 at Microsoft Technology Center</a></li>
<li><a href="../282365/index.html">OpenStack transforms data centers</a></li>
<li><a href="../282367/index.html">The book "From data storage to information management"</a></li>
<li><a href="../282369/index.html">The react-router text tutorial, as well as react-router + redux. In Russian</a></li>
<li><a href="../282373/index.html">Another way to bypass the Windows AppLocker</a></li>
<li><a href="../282377/index.html">A little about the "law of Moore"</a></li>
<li><a href="../282379/index.html">Reverse Polish notation: how to cook a hot dog?</a></li>
<li><a href="../282381/index.html">Gaming Digest: March</a></li>
<li><a href="../282383/index.html">Hydra Slayer: kill time and numbers</a></li>
<li><a href="../282385/index.html">5 stages of the API: what we understood by writing two versions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>