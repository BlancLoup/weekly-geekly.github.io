<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimizing JavaScript performance for V8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Daniel Clifford gave a great talk on Google I / O, dedicated to the features of optimizing JavaScript code for the V8 engine. Daniel urged ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimizing JavaScript performance for V8</h1><div class="post__text post__text-html js-mediator-article"><h4>  Foreword </h4><br>  Daniel Clifford gave a great talk on Google I / O, dedicated to the features of optimizing JavaScript code for the V8 engine.  Daniel urged us to strive for greater speed, carefully analyze the differences between C ++ and JavaScript, and write code, keeping in mind how the interpreter works.  I have compiled in this article a summary of the most important points of Daniel's speech, and I will update it as the engine changes. <br><a name="habracut"></a><br><h4>  Top tip </h4><br>  It is very important to give any performance tips in context.  Optimization often becomes an obsessive habit, and deep immersion in the wilds can actually distract from more important things.  You need a holistic view of web application performance - before focusing on these optimization tips, you should analyze your code with tools like <a href="https://developers.google.com/speed/pagespeed/">PageSpeed</a> and first achieve a good overall result.  This will help avoid premature optimization. <br><br>  The best strategy for creating a fast web application is as follows: <br><br><ul><li>  Think of everything before you run into problems. </li><li>  Understand carefully and get to the heart of the problem. </li><li>  Correct only what matters. </li></ul><br>  To stick to this strategy, it is important to understand how V8 optimizes JS, to imagine how everything happens at run time.  It is also important to have the right tools.  In his speech, Daniel devoted more time to developer tools;  In this article, I mainly look at the features of the V8 architecture. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So let's get started. <br><br><h4>  Hidden Classes </h4><br>  At compile time, the type information in JavaScript is very limited: at runtime, types can change, so it is only natural to expect that when compiling it is difficult to make assumptions about them.  The question arises - how in such conditions can you at least get closer to the speed of C ++?  However, V8 manages to create hidden classes for objects at runtime.  Objects that have the same class share the same optimized code. <br><br>  For example: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Point</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(<span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">22</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(<span class="hljs-number"><span class="hljs-number">33</span></span>, <span class="hljs-number"><span class="hljs-number">44</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    p1  p2         p2.z = 55; // !  p1  p2    !</span></span></code> </pre> <br>  As long as the ‚Äú <code>.z</code> ‚Äù property was not added to <code>p2</code> , <code>p1</code> and <code>p2</code> inside the compiler had the same hidden class, and V8 could use the same optimized machine code for both objects.  The less often you change the hidden class, the better the performance will be. <br><br><h5>  Findings: </h5><br><ul><li>  Initialize all the objects in the constructors so that they change as little as possible later on. </li><li>  Always initialize the properties of an object in the same order. </li></ul><br><h4>  Numbers </h4><br>  V8 keeps track of how you use variables, and uses the most efficient view for each type.  Changing the type can be quite expensive, so try not to mix floating-point numbers and integers.  In general, it is better to use integers. <br><br>  For example: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">42</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  31-    var j = 4.2; //        </span></span></code> </pre><br><h5>  Findings: </h5><br><ul><li>  Try to use 31-bit signed integers wherever possible. </li></ul><br><h4>  Arrays </h4><br>  V8 uses two types of internal array representation: <br><br><ul><li>  Real arrays for compact sequential sets of keys. </li><li>  Hash tables in other cases. </li></ul><br><h5>  Findings: </h5><br><ul><li>  You should not force arrays to jump from one category to another. </li><li>  Use continuous indexing starting from 0 (exactly as in C). </li><li>  Do not pre-fill large arrays (containing more than 64K elements) - this will not work. </li><li>  Do not remove elements from arrays (especially numeric). </li><li>  Do not refer to uninitialized or deleted items.  Example: <br><br><pre> <code class="javascript hljs">a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b = <span class="hljs-number"><span class="hljs-number">0</span></span>; b &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; b++) { a[<span class="hljs-number"><span class="hljs-number">0</span></span>] |= b; <span class="hljs-comment"><span class="hljs-comment">//    ! } //vs. a = new Array(); a[0] = 0; for (var b = 0; b &lt; 10; b++) { a[0] |= b; //    !    . }</span></span></code> </pre><br>  Arrays of numbers with double precision work the fastest - the values ‚Äã‚Äãin them are unpacked and stored as elementary types, and not as objects.  Thoughtless use of arrays can lead to frequent unpacking: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(); a[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">77</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   a[1] = 88; a[2] = 0.5; //  ,  a[3] = true; //  , </span></span></code> </pre><br>  It will be much faster like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = [<span class="hljs-number"><span class="hljs-number">77</span></span>, <span class="hljs-number"><span class="hljs-number">88</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>];</code> </pre><br>  In the first example, individual assignments occur sequentially, and at the moment when <code>a[2]</code> takes a value, the compiler converts <code>a</code> into an array of decompressed numbers with double precision, and when <code>a[3]</code> initialized with a non-numeric element, the inverse transformation occurs.  In the second example, the compiler will immediately select the desired type of array. </li></ul><br>  In this way: <br><br><ul><li>  Small fixed arrays are best initialized using an array literal. </li><li>  Fill small arrays (&lt;64K) before use. </li><li>  Do not store non-numeric values ‚Äã‚Äãin numeric arrays. </li><li>  Try to avoid conversions when initializing not through literals. </li></ul><br><h4>  Compiling javascript </h4><br>  Although JavaScript is a dynamic language and was originally interpreted, all modern engines are actually compilers.  Two compilers work in V8 at once: <br><br><ul><li>  A basic compiler that generates code for the entire script. </li><li>  An optimizing compiler that generates very fast code for the ‚Äúhottest‚Äù sites.  This compilation takes longer. </li></ul><br><h4>  Basic compiler </h4><br>  In V8, he is the first to start processing all the code and run it as quickly as possible.  The code generated by it is almost not optimized - the basic compiler makes almost no assumptions about types.  During execution, the compiler uses inline caches, in which code-dependent portions of code are stored.  When this code is run again, the compiler checks the types used in it before selecting the appropriate version of the ready-made code from the cache.  Therefore, operators that can work with different types run slower. <br><br><h5>  Findings: </h5><br><ul><li>  Prefer monomorphic operators polymorphic. </li></ul><br>  An operator is monomorphic if the hidden type of operands is always the same, and polymorphic if it can change.  For example, the second call to <code>add()</code> makes the code polymorphic: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x + y; } add(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">// +  add()  add("a", "b"); // +  add()  </span></span></code> </pre><br><h4>  Optimizing compiler </h4><br>  In parallel with the operation of the basic compiler, the optimizing compiler recompiles the ‚Äúhot‚Äù, that is, those that are often executed, code segments.  It uses type information accumulated in inline caches. <br><br>  The optimizing compiler tries to build functions into the call sites, which speeds up execution (but increases memory consumption) and allows for additional optimizations.  Monomorphic functions and constructors can easily be embedded entirely, and this is another reason why we should strive to use them. <br><br>  You can see what exactly is optimized in your code using the standalone version of the d8 engine: <br><br><pre> <code class="bash hljs">d8 --trace-opt primes.js</code> </pre>  <i>(the names of the optimized functions will be displayed in <code>stdout</code> )</i> <br><br>  Not all functions can be optimized.  In particular, the optimizing compiler skips any functions containing <code>try/catch</code> blocks. <br><br><h5>  Findings: </h5><br>  If you need to use a <code>try/catch</code> , place performance-critical code outside.  Example: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">perf_sensitive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     } try { perf_sensitive() } catch (e) { //    }</span></span></code> </pre><br>  Perhaps the situation will change in the future, and we will be able to compile <code>try/catch</code> blocks with an optimizing compiler.  You can see exactly which functions are ignored by specifying the <code>--trace-bailout</code> when running d8: <br><br><pre> <code class="bash hljs">d8 --trace-bailout primes.js</code> </pre><br><h4>  Deoptimization </h4><br>  Code generated by the optimizing compiler is not always faster.  In this case, the original, non-optimized version is used.  Unsuccessfully optimized code is thrown away, and execution continues from the appropriate place in the code created by the base compiler.  This code may be optimized again soon if circumstances permit.  In particular, changing hidden classes inside an already optimized code leads to de-optimization. <br><br><h5>  Findings: </h5><br><ul><li>  Avoid changing hidden classes in optimized functions. </li></ul><br>  You can see exactly which functions are being deoptimized by running d8 with the <code>--trace-deopt</code> : <br><br><pre> <code class="bash hljs">d8 --trace-deopt primes.js</code> </pre><br><h4>  Other V8 Tools </h4><br>  The above functions can be transferred to Google Chrome at startup: <br><br><pre> <code class="bash hljs">/Applications/Google Chrome.app/Contents/MacOS/Google Chrome<span class="hljs-string"><span class="hljs-string">" --js-flags="</span></span>--trace-opt --trace-deopt --trace-bailout</code> </pre><br>  There is a profiler in d8 too: <br><br><pre> <code class="bash hljs">d8 primes.js --prof</code> </pre><br>  The sampler profiler d8 takes pictures every millisecond and writes to <code>v8.log</code> . <br><br><h4>  Summary </h4><br>  It is important to understand how the V8 engine works in order to write well-optimized code.  And do not forget about the general principles described at the beginning of the article: <br><br><ul><li>  Think of everything before you run into problems. </li><li>  Understand carefully and get to the heart of the problem. </li><li>  Correct only what matters. </li></ul><br>  This means that you have to make sure that it is in JavaScript, using tools such as PageSpeed.  It may be worth getting rid of DOM calls before looking for bottlenecks.  I hope that Daniel‚Äôs speech (and this article) will help you to better understand the work of V8, but do not forget that it is often more useful to optimize the algorithm of the program, rather than adjust to a specific engine. <br><br><h4>  References: </h4><br><ul><li>  Speech by Daniel Clifford ( <a href="http://www.youtube.com/watch%3Fv%3DUJPdhx5zTaw">video</a> ). </li><li>  <a href="http://v8-io12.appspot.com/">Slides</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/154537/">https://habr.com/ru/post/154537/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../154527/index.html">"Technical interview with a human face" Victoria Pridatko</a></li>
<li><a href="../154529/index.html">Silverlight. Practical guide</a></li>
<li><a href="../154531/index.html">AppSurfer: YouTube for Android Applications</a></li>
<li><a href="../154533/index.html">Experience using IP ATC Askozia in our office</a></li>
<li><a href="../154535/index.html">ejabberd: we migrate from mnesia to mysql</a></li>
<li><a href="../154539/index.html">More mobile. Rambler-Mail for smartphones</a></li>
<li><a href="../154541/index.html">Google released a new colorful and educational project - Cultural Institute</a></li>
<li><a href="../154543/index.html">Samsung introduced in Germany GALAXY S III Mini</a></li>
<li><a href="../154545/index.html">Google nexus 7</a></li>
<li><a href="../154547/index.html">Clouds 2012 Award - popular vote</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>