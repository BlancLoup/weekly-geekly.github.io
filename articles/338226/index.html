<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimize web servers for increased bandwidth and reduced latency</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Max Matiukhin, I work on the Badoo SRV team. We at Badoo not only actively write posts to our blog, but also carefully read the blog...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimize web servers for increased bandwidth and reduced latency</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/f58/a65/3ae/f58a653ae2b24ecc83ce21d0332aa5f0.png"></p><br><p>  <em>Hello!</em>  <em>My name is Max Matiukhin, I work on the Badoo SRV team.</em>  <em>We at Badoo not only actively write posts to our blog, but also carefully read the blogs of our colleagues from other companies.</em>  <em>Recently, the guys from Dropbox have posted a smart post about various ways to optimize server applications: from hardware to the application level.</em>  <em>Its author, Alexey Ivanov, gave a huge amount of advice and links to additional sources of information.</em>  <em>Unfortunately, Dropbox does not have a blog on Habr√©, so I decided to translate this post for our readers.</em> </p><a name="habracut"></a><br><p>  This is an extended version of my speech at nginx.conf 2017 in September of this year.  As a senior quality control engineer (SRE) on the Dropbox Traffic team, I am responsible for our Edge network: its reliability, performance, and efficiency.  This is a <a href="https://blogs.dropbox.com/tech/2017/06/evolution-of-dropboxs-edge-network/">proxy-tier-network built on the basis of nginx</a> and intended both for processing delay-sensitive metadata and for transmitting high-bandwidth data.  The system processing tens of gigabits per second and at the same time tens of thousands of transactions sensitive to delays uses various optimizations of efficiency and performance: starting with drivers and interrupts, through the core and TCP / IP stack, and ending with libraries and application-level settings. </p><br><h3 id="poyasneniya">  Explanations </h3><br><p>  In this post we will look at numerous ways to configure web servers and proxies.  Please do not engage in a cargo cult.  Approach this from the standpoint of science, apply optimization one by one, measure the effect and decide whether they are really useful for your work. </p><br><p>  This is not a Linux performance post (although I will often refer to bcc, <a href="https://qmonnet.github.io/whirl-offload/2016/09/01/dive-into-bpf/">eBPF,</a> and perf) and not a comprehensive guide to using performance profiling tools (if you want to learn more about them, read the <a href="http://www.brendangregg.com/linuxperf.html">Brendan Gregg blog</a> ). </p><br><p>  This is also not a post about browser performance.  I will mention client performance in terms of latency optimization, but very briefly.  Want to find out more - read Ilya Grigorik's <a href="https://hpbn.co/">High Performance Browser Networking</a> article. </p><br><p>  And this is not a compilation of TLS best practices.  Although I will mention the TLS libraries and their settings, you and your security team should independently evaluate their performance and the impact on security.  To find out how your servers meet the best practices, you can use the <a href="https://www.ssllabs.com/ssltest/">Qualys SSL Test</a> .  If you want to learn more about TLS in general, subscribe to the <a href="https://www.feistyduck.com/bulletproof-tls-newsletter/">Feisty Duck Bulletproof TLS Newsletter</a> . </p><br><h3 id="struktura-posta">  Post structure </h3><br><p>  We will look at performance / performance optimization at different levels of the system.  Let's start with the lowest hardware-driver level: these settings can be applied to almost any high-loaded server.  Then I will go to the Linux kernel and its TCP / IP stack: you can twist these handles on your mailboxes that actively use TCP.  Finally, we will discuss settings at the level of libraries and applications, which for the most part are applicable to many web servers and in particular to nginx. </p><br><p>  For each optimization area, I will try to clarify the tradeoffs regarding latency / throughput (if any), as well as give monitoring tips and suggestions for settings for different workload levels. </p><br><h3 id="oborudovanie">  Equipment </h3><br><h4 id="processor">  CPU </h4><br><p> For a good asymmetric RSA / EC performance, choose processors with at least AVX2 support ( <code>avx2</code> in <code>/proc/cpuinfo</code> ) and preferably suitable for <a href="https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/large-integer-squaring-ia-paper.pdf">calculations with large integers</a> ( <code>bmi</code> and <code>adx</code> ).  For symmetric encryption, choose AES-NI for AES ciphers and AVX-512 for ChaCha + Poly.  Intel has a <a href="https://software.intel.com/en-us/articles/improving-openssl-performance">comparison of the performance of</a> different generations of processors with OpenSSL 1.0.2, where the impact of these hardware optimizations is considered. </p><br><p>  For tasks where the delay level is important, like routing, it is recommended to reduce the number of NUMA nodes and disable Hyper-Threading.  Tasks requiring high bandwidth are performed more efficiently with more cores using Hyper-Threading (unless there is no cache binding), and in general, NUMA does not play a special role for them. </p><br><p>  If you choose among Intel products, then look at processors with Haswell / Broadwell architecture, and better Skylake.  AMD has impressive performance with EPYC models. </p><br><h4 id="setevaya-karta">  LAN card </h4><br><p>  You need at least 10 Gbps, and better - 25 Gbps.  If you want to transfer through one server with TLS even more, then the settings described here may not be enough - you may have to move TLS-framing to the kernel level ( <a href="https://openconnect.netflix.com/publications/asiabsd_tls_improved.pdf">FreeBSD</a> , <a href="https://netdevconf.org/1.2/papers/ktls.pdf">Linux</a> ). </p><br><p>  As for the software level, look for open-source-drivers with active mailing lists and communities.  This will be a very important factor if (rather ‚Äúwhen‚Äù) you will be engaged in solving problems related to drivers. </p><br><h4 id="pamyat">  Memory </h4><br><p>  Rule of thumb: latency-sensitive tasks require faster memory;  bandwidth sensitive tasks require more memory. </p><br><h4 id="diski">  Discs </h4><br><p>  It all depends on your buffering / caching requirements.  If you need to buffer or cache a lot, then it is better to choose SSD-drives.  Some even install sharpened flash filesystems (usually log-structured), but they do not always show better performance than regular ext4 / xfs. <br>  In any case, do not ruin your flash drives, forgetting to enable TRIM or update the firmware. </p><br><h3 id="operacionnye-sistemy-nizkiy-uroven">  Operating systems: low </h3><br><h4 id="proshivka">  Firmware </h4><br><p>  Use fresh firmware to avoid long and painful detection of failures.  Try to keep current firmware for the processor, motherboard, network cards and SSD drives.  This does not mean that you should always use the latest versions - it is recommended to take the penultimate ones, if they do not contain critical bugs that have been fixed in the latest versions. </p><br><h4 id="drayvery">  Drivers </h4><br><p>  Here you can give the same advice as for the firmware: if possible, use the latest versions, but not the latest.  Try to share kernel upgrades and driver updates.  For example, you can package the drivers with DKMS or precompile them for all kernel versions you use.  Because of this, if something goes wrong after updating the kernel, you will quickly understand what the problem is. </p><br><h4 id="processor-1">  CPU </h4><br><p>  Your best friend is the kernel repository (and the tools that come with it).  In Ubuntu / Debian, you can install the <code>linux-tools</code> package with a set of utilities, but in this post we will only use <code>cpupower</code> , <code>turbostat</code> and <code>x86_energy_perf_policy</code> .  To check processor-related optimizations, you can conduct stress testing of your software using your favorite load generator (for example, <a href="https://github.com/yandex/yandex-tank">Yandex.Tank</a> ).  Here is a presentation on best load testing techniques from nginx developers: <a href="https://pp.nginx.com/thresh/nginxperftest.odp">NGINX Performance testing</a> . </p><br><h4 id="cpupower">  cpupower </h4><br><pre> <code class="hljs perl">$ cpupower frequency-info ... driver: intel_pstate ... available cpufreq governors: performance powersave ... The governor <span class="hljs-string"><span class="hljs-string">"performance"</span></span> may decide which speed to <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> ... boost <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> support: Supported: yes Active: yes</code> </pre> <br><p>  Check if Turbo Boost is turned on, and if you have an Intel processor, make sure that the system works with <code>intel_pstate</code> , and not with <code>acpi-cpufreq</code> or <code>pcc-cpufreq</code> .  If you are still using acpi-cpufreq, upgrade your kernel.  If this is not possible, use the <code>performance</code> mode.  When working with <code>intel_pstate</code> even the powersave mode should be executed with good performance, but you will have to check it yourself. </p><br><p>  As for idle time, to see what is really happening with your processor, you can use <code>turbostat</code> to look directly at MSR processor and extract information about power, frequency and so-called <code>Idle States</code> : </p><br><pre> <code class="hljs mel"># turbostat --debug -P ... Avg_MHz Busy% ... CPU%c1 CPU%c3 CPU%c6 ... Pkg%pc2 Pkg%pc3 Pkg%pc6 ...</code> </pre> <br><p>  Here you can see the real frequency of the processor (yes, <code>/proc/cpuinfo</code> is lying to you), <a href="https://software.intel.com/en-us/articles/power-management-states-p-states-c-states-and-package-c-states">as well as the current state of the core / set of cores</a> . </p><br><p>  If even with the <code>intel_pstate</code> driver <code>intel_pstate</code> processor spends more time on idle time than you thought, you can: </p><br><ul><li>  switch the controller to performance; </li><li>  For better performance, configure <code>x86_energy_perf_policy</code> . </li></ul><br><p>  And for very sensitive tasks, you can: </p><br><ul><li>  use the <code>/dev/cpu_dma_latency</code> ; </li><li>  for UDP traffic use <a href="https://www.netdevconf.org/2.1/papers/BusyPollingNextGen.pdf">busy-polling</a> . </li></ul><br><p>  Learn more about processor power management in general, and P-states in particular, from the presentation of Balancing Power and Performance in the Linux Kernel with LinuxCon Europe 2015. </p><br><h4 id="privyazka-k-processoru">  Binding to the processor </h4><br><p>  You can further reduce latency by tying a thread or process to a CPU.  For example, in nginx there is a directive <code>worker_cpu_affinity</code> , which automatically binds each process of a web server to a specific kernel.  This eliminates the process / thread migration to another kernel, reduces the number of cache misses and errors of memory pages, and also slightly increases the number of instructions in the loop.  All this can be checked through <code>perf stat</code> . </p><br><p>  But the processor binding has a negative effect on performance, since the processes have to wait longer for the processor to be released.  This can be monitored by running the <a href="http://www.brendangregg.com/blog/2016-10-08/linux-bcc-runqlat.html">runqlat</a> on one of your nginx worker's PIDs: </p><br><pre> <code class="hljs markdown">usecs : count distribution 0 -&gt; 1 : 819 | | 2 -&gt; 3 : 58888 |<span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> | 4 -&gt; 7 : 77984 |<span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>| 8 -&gt; 15 : 10529 |<span class="hljs-strong"><span class="hljs-strong">*****</span></span> | 16 -&gt; 31 : 4853 |** | ... 4096 -&gt; 8191 : 34 | | 8192 -&gt; 16383 : 39 | | 16384 -&gt; 32767 : 17 | |</code> </pre> <br><p>  If you notice long tails for many milliseconds, then the servers are probably running too much, besides nginx, and the binding will increase the delay, rather than reduce it. </p><br><h4 id="pamyat-1">  Memory </h4><br><p>  All Memory Management settings are usually highly dependent on the workflow, so I can only give such recommendations: </p><br><ul><li>  set up the <a href="https://www.kernel.org/doc/Documentation/vm/transhuge.txt">Transparent Huge Pages</a> to <code>madvise</code> and turn them on <a href="https://alexandrnikitin.github.io/blog/transparent-hugepages-measuring-the-performance-impact/">only when you are sure of their benefits</a> , otherwise <a href="https://blog.nelhage.com/post/transparent-hugepages/">you can slow down the work greatly</a> , aiming for a 20% reduction in latency; </li><li>  if you use only one NUMA node, then set <code>vm.zone_reclaim_mode  0</code> . </li></ul><br><p>  Modern processors are several separate processors that are connected by a very fast bus and share various resources, starting with the L1 cache on the HT cores and ending with the L3 cache as applied to packets, memory, and PCIe connections within sockets.  This is NUMA: numerous execution and storage modules with a fast data bus. </p><br><p>  A comprehensive description of NUMA and its application is contained in the Frank Denneman article <a href="http://frankdenneman.nl/2016/07/06/introduction-2016-numa-deep-dive-series/">NUMA Deep Dive Series</a> . </p><br><p>  In short, you can: </p><br><ul><li>  <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html">ignore it</a> by turning <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html">it</a> off in the BIOS or executing its software under <code>numactl --interleave=all</code> (so you will get mediocre, but fairly stable performance); </li><li>  opt out of it using single-node servers, <a href="https://code.facebook.com/posts/1711485769063510/facebook-s-new-front-end-server-design-delivers-on-performance-without-sucking-up-power/">as Facebook does with the OCP Yosemite platform</a> ; </li><li>  accept it by optimizing the placement of the processor / memory in the kernel and user spaces. </li></ul><br><p>  Let's consider the third option, since the other two do not need much optimization. </p><br><p>  To use NUMA correctly, you need to treat each of its nodes as a separate server.  Verify topology with <code>numactl --hardware</code> : </p><br><pre> <code class="hljs mel">$ numactl --<span class="hljs-keyword"><span class="hljs-keyword">hardware</span></span> available: <span class="hljs-number"><span class="hljs-number">4</span></span> nodes (<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span>) node <span class="hljs-number"><span class="hljs-number">0</span></span> cpus: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> node <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">32149</span></span> MB node <span class="hljs-number"><span class="hljs-number">1</span></span> cpus: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> node <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">32213</span></span> MB node <span class="hljs-number"><span class="hljs-number">2</span></span> cpus: <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> node <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> MB node <span class="hljs-number"><span class="hljs-number">3</span></span> cpus: <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> node <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> MB node distances: node <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre> <br><p>  What you need to check: </p><br><ul><li>  the number of nodes; </li><li>  the amount of memory for each node; </li><li>  the number of processors for each node; </li><li>  distance between nodes. </li></ul><br><p>  This is a very bad example, because there are four nodes, and memory-free nodes are also attached.  Here you cannot use each node as a separate server without losing half of the cores. </p><br><p>  You can check this with <code>numastat</code> : </p><br><pre> <code class="hljs swift">$ numastat -n -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-type"><span class="hljs-type">Node</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">Node</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">Node</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">Node</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-type"><span class="hljs-type">Total</span></span> -------- -------- ------ ------ -------- <span class="hljs-type"><span class="hljs-type">Numa_Hit</span></span> <span class="hljs-number"><span class="hljs-number">26833500</span></span> <span class="hljs-number"><span class="hljs-number">11885723</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">38719223</span></span> <span class="hljs-type"><span class="hljs-type">Numa_Miss</span></span> <span class="hljs-number"><span class="hljs-number">18672</span></span> <span class="hljs-number"><span class="hljs-number">8561876</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">8580548</span></span> <span class="hljs-type"><span class="hljs-type">Numa_Foreign</span></span> <span class="hljs-number"><span class="hljs-number">8561876</span></span> <span class="hljs-number"><span class="hljs-number">18672</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">8580548</span></span> <span class="hljs-type"><span class="hljs-type">Interleave_Hit</span></span> <span class="hljs-number"><span class="hljs-number">392066</span></span> <span class="hljs-number"><span class="hljs-number">553771</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">945836</span></span> <span class="hljs-type"><span class="hljs-type">Local_Node</span></span> <span class="hljs-number"><span class="hljs-number">8222745</span></span> <span class="hljs-number"><span class="hljs-number">11507968</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">19730712</span></span> <span class="hljs-type"><span class="hljs-type">Other_Node</span></span> <span class="hljs-number"><span class="hljs-number">18629427</span></span> <span class="hljs-number"><span class="hljs-number">8939632</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">27569060</span></span></code> </pre> <br><p>  Also, using <code>numastat</code> you can get memory usage statistics for each node in the <code>/proc/meminfo</code> : </p><br><pre> <code class="hljs mel">$ numastat -m -c Node <span class="hljs-number"><span class="hljs-number">0</span></span> Node <span class="hljs-number"><span class="hljs-number">1</span></span> Node <span class="hljs-number"><span class="hljs-number">2</span></span> Node <span class="hljs-number"><span class="hljs-number">3</span></span> Total ------ ------ ------ ------ ----- MemTotal <span class="hljs-number"><span class="hljs-number">32150</span></span> <span class="hljs-number"><span class="hljs-number">32214</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">64363</span></span> MemFree <span class="hljs-number"><span class="hljs-number">462</span></span> <span class="hljs-number"><span class="hljs-number">5793</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">6255</span></span> MemUsed <span class="hljs-number"><span class="hljs-number">31688</span></span> <span class="hljs-number"><span class="hljs-number">26421</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">58109</span></span> Active <span class="hljs-number"><span class="hljs-number">16021</span></span> <span class="hljs-number"><span class="hljs-number">8588</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">24608</span></span> Inactive <span class="hljs-number"><span class="hljs-number">13436</span></span> <span class="hljs-number"><span class="hljs-number">16121</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">29557</span></span> Active(anon) <span class="hljs-number"><span class="hljs-number">1193</span></span> <span class="hljs-number"><span class="hljs-number">970</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2163</span></span> Inactive(anon) <span class="hljs-number"><span class="hljs-number">121</span></span> <span class="hljs-number"><span class="hljs-number">108</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">229</span></span> Active(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>) <span class="hljs-number"><span class="hljs-number">14828</span></span> <span class="hljs-number"><span class="hljs-number">7618</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">22446</span></span> Inactive(<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>) <span class="hljs-number"><span class="hljs-number">13315</span></span> <span class="hljs-number"><span class="hljs-number">16013</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">29327</span></span> ... FilePages <span class="hljs-number"><span class="hljs-number">28498</span></span> <span class="hljs-number"><span class="hljs-number">23957</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">52454</span></span> Mapped <span class="hljs-number"><span class="hljs-number">131</span></span> <span class="hljs-number"><span class="hljs-number">130</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">261</span></span> AnonPages <span class="hljs-number"><span class="hljs-number">962</span></span> <span class="hljs-number"><span class="hljs-number">757</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1718</span></span> Shmem <span class="hljs-number"><span class="hljs-number">355</span></span> <span class="hljs-number"><span class="hljs-number">323</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">678</span></span> KernelStack <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span></code> </pre> <br><p>  Now consider an example of a simpler topology. </p><br><pre> <code class="hljs mel">$ numactl --<span class="hljs-keyword"><span class="hljs-keyword">hardware</span></span> available: <span class="hljs-number"><span class="hljs-number">2</span></span> nodes (<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span>) node <span class="hljs-number"><span class="hljs-number">0</span></span> cpus: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> node <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">46967</span></span> MB node <span class="hljs-number"><span class="hljs-number">1</span></span> cpus: <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">26</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> node <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">48355</span></span> MB</code> </pre> <br><p>  Since the nodes are mostly symmetric, we can bind an instance of our application to each NUMA node using <code>numactl --cpunodebind=X --membind=X</code> , and then open it on a different port.  Throughput is increased by using both nodes and reducing latency by preserving the locality of the memory. </p><br><p>  You can check the effectiveness of NUMA placement by delaying operations in memory.  For example, using funclatency in BCC, measure the delay of an operation actively using memory, say, memmove. <br>  You can monitor the performance on the kernel side using <code>perf stat</code> , keeping track of the corresponding memory and scheduler events: </p><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">perf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">stat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-e</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sched</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:sched_stick_numa</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">sched</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:sched_move_numa</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">sched</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:sched_swap_numa</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">migrate</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:mm_migrate_pages</span></span>,<span class="hljs-selector-tag"><span class="hljs-selector-tag">minor-faults</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-p</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PID</span></span> ... 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">sched</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:sched_stick_numa</span></span> 3 <span class="hljs-selector-tag"><span class="hljs-selector-tag">sched</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:sched_move_numa</span></span> 41 <span class="hljs-selector-tag"><span class="hljs-selector-tag">sched</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:sched_swap_numa</span></span> 5,239 <span class="hljs-selector-tag"><span class="hljs-selector-tag">migrate</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:mm_migrate_pages</span></span> 50,161 <span class="hljs-selector-tag"><span class="hljs-selector-tag">minor-faults</span></span></code> </pre> <br><p>  The latest portion of NUMA-related optimizations for network loads with active network utilization is dictated by the fact that the network card is a PCIe device, and each device is tied to its own NUMA node;  therefore, some processors will have less delay when accessing the network.  We will discuss possible optimizations in the chapter where the binding of a network card ‚Üí processor will be considered, but for now let's move on to PCI Express. </p><br><h4 id="pcie">  PCIe </h4><br><p>  There is usually no need to delve into <a href="http://www.cirrascale.com/blog/index.php/pci-debugging-101/">solving problems with PCIe</a> , unless some kind of hardware failure occurs.  However, it is worthwhile to at least create ‚Äúbus width‚Äù, ‚Äúbus speed‚Äù and warnings <code>RxErr/BadTLP</code> for your PCIe devices.  This should save you hours of debugging from damaged hardware or faulty PCIe matching.  You can use <code>lspci</code> for this: </p><br><pre> <code class="hljs vhdl"># lspci -s <span class="hljs-number"><span class="hljs-number">0</span></span>a:<span class="hljs-number"><span class="hljs-number">00.0</span></span> -vvv ... LnkCap: <span class="hljs-keyword"><span class="hljs-keyword">Port</span></span> #<span class="hljs-number"><span class="hljs-number">0</span></span>, Speed <span class="hljs-number"><span class="hljs-number">8</span></span>GT/s, <span class="hljs-literal"><span class="hljs-literal">Width</span></span> x8, ASPM L1, <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span> Latency L0s &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>us, L1 &lt;<span class="hljs-number"><span class="hljs-number">16</span></span>us LnkSta: Speed <span class="hljs-number"><span class="hljs-number">8</span></span>GT/s, <span class="hljs-literal"><span class="hljs-literal">Width</span></span> x8, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- ... Capabilities: [<span class="hljs-number"><span class="hljs-number">100</span></span> v2] Advanced <span class="hljs-literal"><span class="hljs-literal">Error</span></span> Reporting UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- ... UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- ... UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- ... CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr- CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+</code> </pre> <br><p>  PCIe can become a bottleneck if you have multiple high-speed devices competing for channel width (for example, when combining a fast network with fast storage), so you may need to physically shard your PCIe devices among processors to get maximum throughput. </p><br><p><img src="https://habrastorage.org/web/ce8/380/931/ce83809313bf4926a93dc6819908741a.png"></p><br><p>  I also advise you to read the article <a href="https://community.mellanox.com/docs/DOC-2496">Understanding PCIe Configuration for Maximum Performance</a> , it discusses the PCIe configuration in more detail, which can be useful at high speeds when packet loss occurs between the card and the OS. </p><br><p>  Intel suggests that sometimes PCIe power management (ASPM) can lead to high latency and, therefore, more packet loss.  You can disable this feature by typing <code>pcie_aspm=off</code> on the kernel command line. </p><br><h4 id="setevaya-karta-1">  LAN card </h4><br><p>  Before we begin, it is worth mentioning that <a href="https://www.intel.com/content/dam/www/public/us/en/documents/reference-guides/xl710-x710-performance-tuning-linux-guide.pdf">Intel</a> and <a href="https://community.mellanox.com/docs/DOC-2489">Mellanox</a> offer their own performance tuning guides, and regardless of the vendor you choose, you should read both materials.  In addition, drivers usually come with their own README and sets of useful utilities. </p><br><p>  You can also search for manuals for your OS.  For example, the <a href="https://access.redhat.com/sites/default/files/attachments/20150325_network_performance_tuning.pdf">Red Hat Enterprise Linux Network Performance Tuning</a> Guide explains many of the optimizations mentioned above.  Cloudflare also has a good article about setting up this <a href="https://blog.cloudflare.com/how-to-achieve-low-latency/">part of the network stack</a> , although for the most part it is about situations where you need low latency. </p><br><p>  During optimization, your best friend will be ethtool. <br>  Note: if you use a fairly fresh kernel (and you should do it!), Then you will also encounter some aspects of your user space.  For example, for network operations, you probably want to use more recent versions of the <code>ethtool</code> packages, <code>iproute2</code> and perhaps <code>iptables/nftables</code> . </p><br><p>  You can get valuable information about what is happening with your network card using <code>ethtool -S</code> : </p><br><pre> <code class="hljs vhdl">$ ethtool -S eth0 | egrep <span class="hljs-symbol"><span class="hljs-symbol">'miss</span></span>|over|drop|lost|fifo' rx_dropped: <span class="hljs-number"><span class="hljs-number">0</span></span> tx_dropped: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>.rx_dropped: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>.tx_dropped_link_down: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>.rx_oversize: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>.arq_overflows: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Consult your network card manufacturer for detailed statistics.  For example, Mellanox has a <a href="https://community.mellanox.com/docs/DOC-2532">separate Wiki article about it</a> . </p><br><p>  As for the kernel, you need to watch <code>/proc/interrupts</code> , <code>/proc/softirqs</code> and <code>/proc/net/softnet_stat</code> .  There are two useful BCC tools here: <code>hardirqs</code> and <code>softirqs</code> .  The goal of your network optimization is to configure the system so that the processor is used to a minimum and packets are not lost. </p><br><h4 id="privyazka-preryvaniy">  Interrupt Binding </h4><br><p>  Usually the settings here begin with the distribution of interrupts across processors.  How exactly this is done depends on your workload: </p><br><ul><li>  for maximum throughput, you can distribute interrupts across all NUMA nodes; </li><li>  To minimize latency, you can limit interrupts to one NUMA node (to do this, you may need to reduce the number of queues in order not to exceed the capabilities of one node (usually you have to halve it with <code>ethtool -L</code> ). </li></ul><br><p>  As a rule, vendors provide scripts for this.  For example, in Intel it is <code>set_irq_affinity</code> . </p><br><h4 id="razmery-kolcevogo-bufera">  Ring Buffer Size </h4><br><p>  Network cards need to exchange information with the kernel.  This is usually done through a data structure called a ‚Äúring‚Äù.  The current / maximum size of this ring can be viewed using <code>ethtool -g</code> : </p><br><pre> <code class="hljs pgsql">$ ethtool -g eth0 Ring parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eth0: Pre-<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> maximums: RX: <span class="hljs-number"><span class="hljs-number">4096</span></span> TX: <span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Current</span></span> hardware settings: RX: <span class="hljs-number"><span class="hljs-number">4096</span></span> TX: <span class="hljs-number"><span class="hljs-number">4096</span></span></code> </pre> <br><p>  With <code>-G</code> you can customize values ‚Äã‚Äãwithin predefined extremes.  Usually, the more, the better (especially if you use interrupt unions), because it gives you better protection from peaks and some problems in the core, which means it reduces the number of dropped packets due to lack of buffer space or missed interrupts.  But there are a couple of cautions: </p><br><ul><li><p>  in older kernels or drivers without <a href="https://lwn.net/Articles/469652/">BQL</a> support <a href="https://lwn.net/Articles/469652/">,</a> high values ‚Äã‚Äãmay refer to a higher bufferbloat on the TX side; </p><br></li><li>  Larger buffers <a href="http://patchwork.ozlabs.org/patch/348793/">increase cache pressure</a> , so if you run into this, try reducing buffers. </li></ul><br><h4 id="obedinenie-preryvaniy">  Interrupt association </h4><br><p>  This mechanism ensures that the kernel notifies new events by merging several messages into one interrupt.  The current settings can be viewed using <code>ethtool -c</code> : </p><br><pre> <code class="hljs swift">$ ethtool -<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> eth0 <span class="hljs-type"><span class="hljs-type">Coalesce</span></span> parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eth0: ... rx-usecs: <span class="hljs-number"><span class="hljs-number">50</span></span> tx-usecs: <span class="hljs-number"><span class="hljs-number">50</span></span></code> </pre> <br><p>  Also, you can stick to static limits (static limits), severely limiting the maximum number of interrupts per second per core, or rely on <a href="https://community.mellanox.com/docs/DOC-2511">automatic hardware-controlled interrupt frequency</a> depending on bandwidth. </p><br><p>  Enabling merge ( <code>-C</code> ) will increase latency and is likely to result in packet loss, so this feature is not recommended for delays sensitive tasks.  But on the other hand, its complete shutdown can lead to throttling of interruptions, and, consequently, a performance limitation. </p><br><h4 id="razgruzki">  Unloading </h4><br><p>  Modern network cards are quite smart and can unload a large part of the work with iron or emulate the unloading in the drivers themselves. </p><br><p>  All possible downloads can be viewed using <code>ethtool -k</code> : </p><br><pre> <code class="hljs vhdl">$ ethtool -k eth0 Features <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eth0: ... tcp-segmentation-offload: <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">generic</span></span>-segmentation-offload: <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">generic</span></span>-receive-offload: <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> large-receive-offload: off [fixed]</code> </pre> <br><p>  All non-configurable offloads are marked with the <code>[fixed]</code> suffix.  <a href="https://lwn.net/Articles/358910/">You can talk about them for a long time</a> , but I will only give a few rules of thumb: </p><br><ul><li>  do not enable LRO ‚Äî use GRO instead; </li><li>  be careful with TSO, as it depends a lot on the quality of your drivers / firmware; </li><li>  Do not enable TSO / GSO on older kernels, because this can lead to excessive bufferbloat. </li></ul><br><h4 id="regulirovanie-paketov">  Packet handling </h4><br><p>  All modern <a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">network cards are optimized for multiprocessor systems,</a> so they distribute packets in virtual queues (usually one per processor).  When this is done hardware, it is called RSS;  when the OS is responsible for balancing packets between processors, it is called RPS (TX-equivalent is called XPS).  If the OS tries to regulate threads to the processors that are currently handling this socket, this is called RFS.  And when iron does it, it's called ‚Äúaccelerated RFS‚Äù or aRFS. </p><br><p>  Here are some good techniques: </p><br><ul><li>  if you use 25 Gbit + hardware, then there are probably enough queues and a huge indirection table to use RSS between all cores (some older cards can only use the first 16 processors); </li><li>  You can try enabling RPS if: </li></ul><br><p>  1) you have more processors than hardware queues, and you want to sacrifice latency in favor of bandwidth; <br>  2) you use internal tunneling (for example, GRE / IPinIP), in which the network card cannot use RSS; </p><br><ul><li>  Do not enable RPS if you have an old enough processor that does not have x2APIC; </li><li>  Binding each processor to its own TX queue via XPS is generally a good idea; </li><li>  The effectiveness of RFS depends a lot on your workload, and also on whether you apply a processor reference. </li></ul><br><h4 id="flow-director-i-atr">  Flow Director and ATR </h4><br><p>  The included Flow Director (or <code>fdir</code> in Intel terminology) <a href="https://software.intel.com/en-us/articles/setting-up-intel-ethernet-flow-director">by default operates in the Application Targeting Routing mode</a> , which implements <strong>aRFS</strong> by sampling packets and adjusting the flows to the processor core, where they appear to be processed.  Statistics can be viewed using <code>ethtool -S:$ ethtool -S eth0 | egrep 'fdir' port.fdir_flush_cnt: 0 ‚Ä¶</code> <code>ethtool -S:$ ethtool -S eth0 | egrep 'fdir' port.fdir_flush_cnt: 0 ‚Ä¶</code> </p><br><p>  Intel ,  <code>fdir</code> <a href="https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/intel-ethernet-flow-director.pdf">    ,</a>      ,   <a href="http://lss.fnal.gov/archive/2010/pub/fermilab-pub-10-309-cd.pdf">     1% </a> ,        TCP.     ,   Flow Director     ,   <code>TCPOFOQueue</code> . </p><br><h3 id="operacionnye-sistemy-setevoy-stek">  :   </h3><br><p>    ,        Linux,    ¬´- sysctl.conf¬ª.           ,    ,    TCP/ IP-      ,      <code>sysctls.conf</code> ,        2.6.18/ 2.6.32. </p><br><p>       : </p><br><ul><li>   <code>/proc/net/snmp and /proc/net/netstat</code>  TCP-   ; </li><li>   ,    <code>ss -n --extended --info</code>      <code>getsockopt(``[TCP_INFO]``)/getsockopt(``[TCP_CC_INFO]``)</code> ; </li><li>  <a href="https://linux.die.net/man/1/tcptrace">tcptrace(1)</a> `  TCP-; </li><li>  RUM- / . </li></ul><br><p>              CDN,  ,  ,  ,  . , <a href="https://www.youtube.com/watch%3Fv%3DgfYYggNkM20">Fastly on LinuxCon Australia</a> .   ,     Linux,  ,  <a href="https://www.youtube.com/channel/UCribHdOMgiD5R3OUDgx2qTg">NetDevConf</a>  <a href="https://lwn.net/Articles/719388/">Netconf</a> . </p><br><p>        PackageCloud    Linux,    ,      ,    ¬´¬ª : </p><br><ul><li> <a href="https://blog.packagecloud.io/eng/2016/06/22/monitoring-tuning-linux-networking-stack-receiving-data/">Monitoring and Tuning the Linux Networking Stack: Receiving Data</a> ; </li><li> <a href="https://blog.packagecloud.io/eng/2017/02/06/monitoring-tuning-linux-networking-stack-sending-data/">Monitoring and Tuning the Linux Networking Stack: Sending Data</a> . </li></ul><br><p>     : <strong>  </strong> !     ,       IW10 ( <a href="https://developers.google.com/speed/protocols/Increasing_TCPs_Initial_Window_IETF78.pdf"> 2010</a> ) ‚Äì     ,     TSO, FQ, pacing, TLP  RACK.          , , <a href="https://workshop.netfilter.org/2013/wiki/images/2/2a/DaveM_route_cache_removed_nfws2013.pdf"> </a> , <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/%3Fid%3Dc3fc7ac9a0b978ee8538058743d21feef25f7b33"> </a> , <a href="https://lwn.net/Articles/542629/"><code>SO_REUSEPORT</code></a>  <a href="https://kernelnewbies.org/LinuxVersions"> </a> . </p><br><h4 id="obzor">  Overview </h4><br><p>         Linux   <a href="https://netdevconf.org/1.2/papers/bbr-netdev-1.2.new.new.pdf">Making Linux TCP Fast</a> .             . TCP-       : </p><br><p><img src="https://habrastorage.org/web/5ac/a0c/9ca/5aca0c9caed84e7085c330414719ec1c.png"></p><br><h4 id="fair-queueing-i-pacing"> Fair queueing  pacing </h4><br><p> Fair queueing    ¬´¬ª      TCP-,       . Pacing,   ,       ,  Congestion Control,       ,     . </p><br><p>   ,  <code>fair queueing</code>  <code>pacing</code>   Linux  <code>fq qdisc</code> .     BBR ( <a href="https://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git/commit/%3Fid%3D218af599fa635b107cfe10acf3249c4dfe5e4123">,  </a> ),       CUBIC,  15‚Äì20%-   ,  ,         ( <code>loss-based CCs</code> ).        (&lt;3.19),  <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/%3Fid%3D9878196578286c5ed494778ada01da094377a686">    ACKs</a>   / RPCs. </p><br><h4 id="avtomaticheskiy-vybor-razmera-tso-i-tsq">    TSO  TSQ </h4><br><p>        TCP-,  ,        . </p><br><h4 id="upravlenie-peregruzkami">   </h4><br><p> CC-    ‚Äì  ,         . -     : <a href="https://lwn.net/Articles/645015/"><code>tcp_cdg</code></a> ( <a href="http://caia.swin.edu.au/">CAIA</a> ), <a href="https://lwn.net/Articles/650325/"><code>tcp_nv</code></a> (Facebook)  <a href="https://lwn.net/Articles/701149/"><code>tcp_bbr</code></a> (Google).       ,  ,             (delay),    . </p><br><p> BBR ‚Äì    ,         .         ,         RTT   .   ,      -. </p><br><p>     BBR   Edge PoP     : </p><br><p><img src="https://habrastorage.org/web/b8c/0ca/519/b8c0ca5190c847038ea89aca985dc2cd.png"><br> <em>   TCP BBR  Tokyo PoP:  x ‚Äî ,  y ‚Äî    </em> </p><br><p>      .       ‚Äî      p90+  (    -),   ,        .           FQ/ pacing ,       , ,   ,  ¬´ TCP¬ª. </p><br><p>       BBR,  <a href="https://blog.apnic.net/2017/05/09/bbr-new-kid-tcp-block/"> APNIC     </a> (   loss-based- ).       <a href="https://groups.google.com/forum/">   bbr-dev</a> (     ).        ,      <a href="https://datatracker.ietf.org/rg/iccrg/about/">Internet Congestion Control Research Group</a> . </p><br><h4 id="ack-obrabotka-i-obnaruzhenie-propadaniya-paketov"> ACK-     </h4><br><p>       (loss detection).         .  TCP      <a href="https://lwn.net/Articles/542642/">TLP</a>  <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/%3Fid%3Deb9fae328faff9807a4ab5c1834b19f34dd155d4">RACK</a> ,   ( FACK  ER) .    ,         . </p><br><h4 id="prioritizaciya-polzovatelskogo-prostranstva-i-hol">     HOL </h4><br><p> API    (userspace socket API)    ,        .     (,  HTTP/2)     <a href="https://en.wikipedia.org/wiki/Head-of-line_blocking">Head-of-Line </a>   h2-.  <a href="https://insouciant.org/tech/prioritization-only-works-when-theres-pending-data-to-prioritize">  </a>    <a href="https://lwn.net/Articles/560082/"></a>    <code>sysctl net.ipv4.tcp_notsent_lowat</code> .    ,          (  <code>epoll</code>     ).      HTTP/2-,        ,     . </p><br><h4 id="sysctls"> Sysctls </h4><br><p>       ,      sysctls.   ,      : </p><br><ul><li> <code>net.ipv4.tcp_tw_recycle=1</code> : <a href="https://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux">  </a> ‚Äî    NAT    ,     ,    ; </li><li> <code>net.ipv4.tcp_timestamps=0</code> :       ,        . ,      ,   <a href="https://lwn.net/Articles/277219/">    SACK-  syncookie</a> . </li></ul><br><p>    : </p><br><ul><li> <code>net.ipv4.tcp_slow_start_after_idle=0</code> :      (slow start)     ,  ¬´¬ª    RTO,    ; </li><li> <code>net.ipv4.tcp_mtu_probing=1</code> : <a href="https://blog.cloudflare.com/ip-fragmentation-is-broken/">   ICMP-¬´ ¬ª    </a> (   ); </li><li> <code>net.ipv4.tcp_rmem, net.ipv4.tcp_wmem</code> :   ,    BDP;   ,  <a href="https://blog.cloudflare.com/the-story-of-one-latency-spike/"> ‚Äì   </a> ; </li><li> <code>echo 2 &gt; /sys/module/tcp_cubic/parameters/hystart_detect</code> :    FQ+CUBIC,     <a href="https://groups.google.com/forum/"> </a>    tcp_cubic   . </li></ul><br><p>  ,   RFC- (  )   ,  curl,   <a href="https://github.com/bagder/I-D/blob/gh-pages/">TCP Tuning for HTTP</a> ,        ,      HTTP. </p><br><h3 id="uroven-prilozheniya-sredniy-uroven">  :   </h3><br><h4 id="instrumentariy">  Tools </h4><br><p>       ,     .     , ,      <code>perf</code> , <code>bcc</code>   . </p><br><p>          .                <code>perf top</code> , <a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html">on-CPU flame-</a>  ad hoc-  <code>funclatency</code>  <code>bcc</code> . </p><br><p><img src="https://habrastorage.org/web/f58/a65/3ae/f58a653ae2b24ecc83ce21d0332aa5f0.png"></p><br><h4 id="instrumentariy-dlya-kompilirovaniya">    </h4><br><p>     - ,       ,    ,    -. </p><br><p>  ,          (, <code>-fstack-protector-strong</code>  <code>SafeStack</code> ).     ,        ,     (, <a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a>  <a href="https://clang.llvm.org/docs/index.html"></a> ). </p><br><h3 id="sistemnye-biblioteki">   </h3><br><p>      glibc,      <a href="https://sourceware.org/git/%3Fp%3Dglibc.git%3Ba%3Dcommit%3Bh%3D72276d6e8843db6df5971b06787f0a5e39bda138"> </a>    <code>-lc</code> , <code>-lm</code> , <code>-lrt</code>   .  :  ,    <a href="https://bugs.launchpad.net/ubuntu/%2Bsource/glibc/%2Bbug/1663280"> </a> . </p><br><h4 id="zlib"> zlib </h4><br><p>     -.     ,   ,     <code>zlib</code>  <code>perf top</code> , : </p><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">perf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">top</span></span> ... 8<span class="hljs-selector-class"><span class="hljs-selector-class">.88</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">longest_match</span></span> 8<span class="hljs-selector-class"><span class="hljs-selector-class">.29</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">deflate_slow</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.90</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">compress_block</span></span></code> </pre> <br><p>       : <a href="https://github.com/jtkukunas/zlib">Intel</a>  <a href="https://blog.cloudflare.com/cloudflare-fights-cancer/">Cloudflare</a> ,     <a href="https://github.com/Dead2/zlib-ng">zlib-ng</a> ,   zlib-,          . </p><br><h4 id="malloc">  malloc </h4><br><p>             .     .     Lua  FFI    ,    ,       - .        <a href="https://github.com/jemalloc/jemalloc">jemalloc</a>  <a href="https://github.com/gperftools/gperftools">tcmalloc</a> . </p><br><p>   malloc   : </p><br><ul><li>    nginx   ,         glibc   ; </li><li>  <a href="https://github.com/jemalloc/jemalloc/wiki/Use-Case:-Introspection-Via-mallctl*%2528%2529"></a> , <a href="https://github.com/jemalloc/jemalloc/wiki/Use-Case:-Heap-Profiling"></a>  <a href="https://github.com/jemalloc/jemalloc/wiki/Use-Case:-Basic-Allocator-Statistics"> </a> . </li></ul><br><p>    nginx          Lua,     <code>perf top</code>  <code>PCRE</code> .   ,  <code>PCRE</code>  <code>JIT</code> ,      nginx  <code>pcre_jit on;</code>  . </p><br><p>      flame-    <code>funclatency</code> : </p><br><pre> <code class="hljs erlang-repl"># funclatency /srv/nginx-bazel/sbin/nginx:ngx_http_regex_exec -u ... usecs : count distribution <span class="hljs-number"><span class="hljs-number">0</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">1159</span></span> |********** | <span class="hljs-number"><span class="hljs-number">2</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">3</span></span> : <span class="hljs-number"><span class="hljs-number">4468</span></span> |****************************************| <span class="hljs-number"><span class="hljs-number">4</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">7</span></span> : <span class="hljs-number"><span class="hljs-number">622</span></span> |***** | <span class="hljs-number"><span class="hljs-number">8</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">15</span></span> : <span class="hljs-number"><span class="hljs-number">610</span></span> |***** | <span class="hljs-number"><span class="hljs-number">16</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">31</span></span> : <span class="hljs-number"><span class="hljs-number">209</span></span> |* | <span class="hljs-number"><span class="hljs-number">32</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">63</span></span> : <span class="hljs-number"><span class="hljs-number">91</span></span> | |</code> </pre> <br><h4 id="tls"> TLS </h4><br><p>    TLS     CDN,  TLS-    .               . </p><br><p>  ,    , ‚Äî  TLS-   : Vanilla <a href="https://www.openssl.org/">OpenSSL</a> , OpenBSD's <a href="https://www.libressl.org/">LibreSSL</a>  <a href="https://boringssl.googlesource.com/boringssl/">BoringSSL</a>  Google. ,     :  ,  OpenSSL   <a href="https://github.com/openssl/openssl/blob/1b3011abb36ff743c05afce1c9f2450d83d09d59/crypto/bn/asm/rsaz-avx2.pl"> </a> ,       ;  BoringSSL   ,  <a href="https://boringssl.googlesource.com/boringssl/%2B/master/crypto/fipsmodule/bn/asm/rsaz-avx2.pl">  </a>       .   ,   -      :  TLS-   ,  AES-NI  SSE  ADX  AVX-512.     . ,    BoringSSL  <code>bssl speed</code> . </p><br><p>         ,    ,    ,      .  ,          - ‚Äî      .   ,   ,    <a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/">Mozilla SSL Configuration Generator</a> . </p><br><h4 id="asimmetrichnoe-shifrovanie">   </h4><br><p>    ‚Äúfront‚Äù- (     ),        TLS-¬´¬ª,  ,         ,   . </p><br><p>          <a href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/">ECDSA</a> ,     ,  RSA.      ,    ¬´¬ª    .  ECDSA          ,      OpenSSL,  ,    <a href="https://blog.cloudflare.com/ensuring-randomness-with-linuxs-random-number-generator/"> </a> (   BoringSSL <a href="https://www.imperialviolet.org/2015/10/17/boringssl.html">    </a> ). </p><br><p>    ,   ‚Äì   ,     4096 RSA     : </p><br><pre> <code class="hljs matlab">$ bssl speed Did <span class="hljs-number"><span class="hljs-number">1517</span></span> RSA <span class="hljs-number"><span class="hljs-number">2048</span></span> signing ... (<span class="hljs-number"><span class="hljs-number">1507.3</span></span> ops/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span>) Did <span class="hljs-number"><span class="hljs-number">160</span></span> RSA <span class="hljs-number"><span class="hljs-number">4096</span></span> signing ... (<span class="hljs-number"><span class="hljs-number">153.4</span></span> ops/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span>)</code> </pre> <br><p>      :     p-224  ECDSA   60%-       p-256: </p><br><pre> <code class="hljs matlab">$ bssl speed Did <span class="hljs-number"><span class="hljs-number">7056</span></span> ECDSA P<span class="hljs-number"><span class="hljs-number">-224</span></span> signing ... (<span class="hljs-number"><span class="hljs-number">6831.1</span></span> ops/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span>) Did <span class="hljs-number"><span class="hljs-number">17000</span></span> ECDSA P<span class="hljs-number"><span class="hljs-number">-256</span></span> signing ... (<span class="hljs-number"><span class="hljs-number">16885.3</span></span> ops/<span class="hljs-built_in"><span class="hljs-built_in">sec</span></span>)</code> </pre> <br><p>  :      . </p><br><p>        OpenTLS,   RSA,   <code>perf top</code>     : ,  AVX2,   ADX (,   Haswell),     AVX2: </p><br><pre> <code class="hljs css"> 6<span class="hljs-selector-class"><span class="hljs-selector-class">.42</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsaz_1024_sqr_avx2</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsaz_1024_mul_avx2</span></span></code> </pre> <br><p>            ADX: </p><br><pre> <code class="hljs css"> 7<span class="hljs-selector-class"><span class="hljs-selector-class">.08</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sqrx8x_internal</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mulx4x_internal</span></span></code> </pre> <br><h4 id="simmetrichnoe-shifrovanie">   </h4><br><p>         ,    ,           .   ,     AES-NI         AES-GCM.      perf top  : </p><br><pre> <code class="hljs css"> 8<span class="hljs-selector-class"><span class="hljs-selector-class">.47</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[.]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">aesni_ctr32_ghash_6x</span></span></code> </pre> <br><p>   /      ,   ,        .     <a href="https://blog.cloudflare.com/do-the-chacha-better-mobile-performance-with-cryptography/">    </a> ,     ,          , , <a href="https://www.imperialviolet.org/2013/10/07/chacha20.html">ChaCha20-Poly1305</a> .   TTLB    . </p><br><p>  BoringSSL    <code>ChaCha20-Poly1305</code> ,   OpenSSL 1.0.2   <a href="https://github.com/cloudflare/sslconfig/blob/master/patches/openssl__chacha20_poly1305_draft_and_rfc_ossl102j.patch"> Cloudflare</a> . BoringSSL   <a href="https://boringssl.googlesource.com/boringssl/%2B/858a88daf27975f67d9f63e18f95645be2886bfb%255E!/">¬´  ¬ª</a> ,      ,    ,   ,      (   <a href="https://github.com/cloudflare/sslconfig/blob/master/conf">cloudflare/sslconfig</a> ): </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssl_ciphers</span></span> <span class="hljs-string"><span class="hljs-string">'[ECDHE-ECDSA-AES128-GCM-SHA256|ECDHE-ECDSA-CHACHA20-POLY1305|ECDHE-RSA-AES128-GCM-SHA256|ECDHE-RSA-CHACHA20-POLY1305]:ECDHE+AES128:RSA+AES128:ECDHE+AES256:RSA+AES256:ECDHE+3DES:RSA+3DES'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_prefer_server_ciphers</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br><h3 id="uroven-prilozheniya-vysokourovnevye-optimizacii">  :   </h3><br><p>            RUM-.     API <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigation_timing_API">Navigation Timing</a>  <a href="https://developer.mozilla.org/en-US/docs/Web/API/Resource_Timing_API">Resource Timing</a> .    ‚Äî TTFB  TTV/ TTI.    ,       ,      . </p><br><h4 id="kompressiya">  Compression </h4><br><p>  nginx     mime.types,       MIME-.    ,      , , , <code>gzip_types</code> .     ,     <code>mime.type</code> s   <code>compressible == true to gzip_types</code>   <a href="https://github.com/js"><code>mime-db</code></a> . </p><br><p>  gzip,   : </p><br><ul><li>     (    <code>gzip_buffers</code> ); </li><li>     TTFB (    <code>gzip_no_buffer</code> ). </li></ul><br><p> ,  HTTP-    gzip:  nginx    <code>ngx_brotli</code> ,     30% ,  <code>gzip</code> . </p><br><p>    ,     :    . </p><br><p>               ,      .  gzip  brotli      <a href="https://blogs.dropbox.com/tech/2017/04/deploying-brotli-for-static-content/">Deploying Brotli for static content</a> . </p><br><p>            :     +     +   .                 ,      TTFB. </p><br><p>         -,    .  - nginx    ,                .   <code>proxy_request_buffering</code>  <code>proxy_buffering</code>       .   ,         <code>client_body_buffer_size</code>  <code>proxy_buffers</code> ,      /     .     ,  <code>proxy_max_temp_file_size</code>  0. </p><br><p>    : </p><br><ul><li>  /     ‚Äî  ,     .    ,           .     ,       ,      .         ,     ,      /  (,    SSD,     ); </li><li>  .     ,    ,     .     ,     -     (   Slow POST/ <a href="https://blog.qualys.com/securitylabs/2012/01/05/slow-read">Slow Read</a> ); </li><li>    <code>X-Accel-Buffering</code>      . </li></ul><br><p>     ,      TTFB  TTLB.   ,       /     ,      . </p><br><h4 id="tls-1"> TLS </h4><br><p>      TLS   ,        nginx.  ,    ,    <a href="https://hpbn.co/">Optimizing for TLS High Performance Browser Networking</a>    <a href="https://www.youtube.com/watch%3Fv%3DiHxD-G0YjiU">Making HTTPS Fast(er)</a>  nginx.conf 2014. ,     ,       -,  ,      ,    <a href="https://wiki.mozilla.org/Security/Server_Side_TLS">Mozilla's Server Side TLS Guide</a> /     ,   . </p><br><p>      : </p><br><ul><li> <a href="https://www.webpagetest.org/">WebPagetest</a> ‚Äî   ; </li><li> <a href="https://www.ssllabs.com/ssltest/index.html">SSL Server Test</a>  <a href="https://github.com/mozilla/tls-observatory">Mozilla TLS Observatory</a> ‚Äî   . </li></ul><br><h4 id="vozobnovlenie-sessii">   </h4><br><p>    DBA, ¬´   ‚Äì ,    ¬ª.    TLS:       RTT,     ¬´¬ª.     : </p><br><ul><li>       (    )        ¬´¬ª (  ).   nginx     <code>ssl_session_tickets</code> .        ,    : </li></ul><br><p> 1)    ,      /   TLS-. ,   : 1)      -; 2)      -      ; <br> 2) PFS      ,   TLS--,      -,           ; <br> 3)      -.     AES-256,    128- -. Nginx  128-  256- ; <br> 4)     - (     ); </p><br><ul><li>   TLS-        (ID).     ssl_session_cache.    ,  PFS   ,       .   -   : </li></ul><br><p> 1)     ~256     ,           ; <br> 2)        .        ,          ,    ,     TLS-  -  <code>ngx_http_lua_module</code> . </p><br><p> ,         ,       .  For example: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ssl_session_tickets</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_timeout</span></span> <span class="hljs-number"><span class="hljs-number">1h</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_ticket_key</span></span> /run/nginx-ephemeral/nginx_session_ticket_curr; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_ticket_key</span></span> /run/nginx-ephemeral/nginx_session_ticket_prev; <span class="hljs-attribute"><span class="hljs-attribute">ssl_session_ticket_key</span></span> /run/nginx-ephemeral/nginx_session_ticket_next;</code> </pre> <br><p>          ,     ,     . </p><br><h4 id="skreplenie-ocsp"> ¬´¬ª OCSP </h4><br><p> ¬´¬ª  OCSP-, : </p><br><ul><li> TLS-¬´¬ª    ,            OCSP; </li><li>    OCSP     ; </li><li>     ,          ,   ,       . </li></ul><br><p>  ¬´¬ª OCSP-        ,     -     <code>ssl_stapling_file</code> : </p><br><pre> <code class="hljs sql">ssl_stapling_file /var/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>/nginx/ocsp/www.der;</code> </pre> <br><h4 id="razmer-tls-zapisi">  TLS- </h4><br><p> TLS     (),       ,     .        TTFB       . </p><br><p>   nginx  16- ,        IW10,    roundtrip.   nginx        <code>ssl_buffer_size</code> : </p><br><ul><li>      , , 4  (      ); </li><li>      16 . </li></ul><br><p>      : </p><br><ul><li>    ; </li><li>    <code>ssl_buffer_size</code>     nginx,    ,          ,      ,   ,     . </li></ul><br><p>   ‚Äî    .  nginx    Cloudflare, <a href="https://blog.cloudflare.com/optimizing-tls-over-tcp-to-reduce-latency/">   </a> .       , ,  ,    . </p><br><h3 id="tls-13">  TLS 1.3 </h3><br><p>  <a href="https://blog.cloudflare.com/tls-1-3-overview-and-q-and-a/">TLS 1.3   </a> ,            TLS ,    ,  : </p><br><ul><li>   <a href="https://tools.ietf.org/html/draft-ietf-tls-tls13-21"></a> ; </li><li> ¬´¬ª 0-RTT  <a href="https://github.com/tlswg/tls13-spec/issues/1001"> ,   </a> ,        ; </li><li>     (, DPI   ),    TLS. </li></ul><br><p> nginx ‚Äî -    .  ,      - .    ,     ,       , <a href="https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/">   nginx     </a> ,    . </p><br><p>       .      , ,     ,       . </p><br><p>   ,  nginx        <code>ngx_process_events_and_timers</code> ,   ‚Äì ,       <code>eventloop stall</code> . </p><br><pre> <code class="hljs erlang-repl"># funclatency <span class="hljs-string"><span class="hljs-string">'/srv/nginx-bazel/sbin/nginx:ngx_process_events_and_timers'</span></span> -m msecs : count distribution <span class="hljs-number"><span class="hljs-number">0</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">3799</span></span> |****************************************| <span class="hljs-number"><span class="hljs-number">2</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">3</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> | | <span class="hljs-number"><span class="hljs-number">4</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">7</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> | | <span class="hljs-number"><span class="hljs-number">8</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">15</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> | | <span class="hljs-number"><span class="hljs-number">16</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">31</span></span> : <span class="hljs-number"><span class="hljs-number">409</span></span> |**** | <span class="hljs-number"><span class="hljs-number">32</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">63</span></span> : <span class="hljs-number"><span class="hljs-number">313</span></span> |*** | <span class="hljs-number"><span class="hljs-number">64</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">127</span></span> : <span class="hljs-number"><span class="hljs-number">128</span></span> |* |</code> </pre> <br><h4 id="aio-i-puly-potokov-vypolneniya"> AIO     </h4><br><p>    <code>eventloop stall</code> ,     ,  / ,        .  /      <code>fileslower</code> : </p><br><pre> <code class="hljs lisp"># fileslower <span class="hljs-number"><span class="hljs-number">10</span></span> Tracing sync read/writes slower than <span class="hljs-number"><span class="hljs-number">10</span></span> ms TIME(<span class="hljs-name"><span class="hljs-name">s</span></span>) COMM TID D BYTES LAT(<span class="hljs-name"><span class="hljs-name">ms</span></span>) FILENAME <span class="hljs-number"><span class="hljs-number">2.642</span></span> nginx <span class="hljs-number"><span class="hljs-number">69097</span></span> R <span class="hljs-number"><span class="hljs-number">5242880</span></span> <span class="hljs-number"><span class="hljs-number">12.18</span></span> <span class="hljs-number"><span class="hljs-number">0002121812</span></span> <span class="hljs-number"><span class="hljs-number">4.760</span></span> nginx <span class="hljs-number"><span class="hljs-number">69754</span></span> W <span class="hljs-number"><span class="hljs-number">8192</span></span> <span class="hljs-number"><span class="hljs-number">42.08</span></span> <span class="hljs-number"><span class="hljs-number">0002121598</span></span> <span class="hljs-number"><span class="hljs-number">4.760</span></span> nginx <span class="hljs-number"><span class="hljs-number">69435</span></span> W <span class="hljs-number"><span class="hljs-number">2852</span></span> <span class="hljs-number"><span class="hljs-number">42.39</span></span> <span class="hljs-number"><span class="hljs-number">0002121845</span></span> <span class="hljs-number"><span class="hljs-number">4.760</span></span> nginx <span class="hljs-number"><span class="hljs-number">69088</span></span> W <span class="hljs-number"><span class="hljs-number">2852</span></span> <span class="hljs-number"><span class="hljs-number">41.83</span></span> <span class="hljs-number"><span class="hljs-number">0002121854</span></span></code> </pre> <br><p>      nginx   /      (   AIO,    AIO  Unix  ,     ,     ,  ).    : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">aio</span></span> threads; <span class="hljs-attribute"><span class="hljs-attribute">aio_write</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br><p>        thread_pool, ,    , ,      ,      .    <a href="https://www.nginx.com/blog/thread-pools-boost-performance-9x/">  </a>  nginx-,    D,        .        <code>eventloop stall</code> ,        /      . </p><br><h4 id="zhurnalirovanie">  Journaling </h4><br><p>      ,     . ,     , ,  <code>ext4slower</code>      / : </p><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">ext4slower</span></span> 10 <span class="hljs-selector-tag"><span class="hljs-selector-tag">TIME</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">COMM</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PID</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">T</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BYTES</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OFF_KB</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">LAT</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">ms</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">FILENAME</span></span> 06<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:26</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:03</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> 69094 <span class="hljs-selector-tag"><span class="hljs-selector-tag">W</span></span> 163070 634126 18<span class="hljs-selector-class"><span class="hljs-selector-class">.78</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">access</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.log</span></span> 06<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:26</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:08</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> 69094 <span class="hljs-selector-tag"><span class="hljs-selector-tag">W</span></span> 151 126029 37<span class="hljs-selector-class"><span class="hljs-selector-class">.35</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.log</span></span> 06<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:26</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:13</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nginx</span></span> 69082 <span class="hljs-selector-tag"><span class="hljs-selector-tag">W</span></span> 153168 638728 159<span class="hljs-selector-class"><span class="hljs-selector-class">.96</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">access</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.log</span></span></code> </pre> <br><p>       buffer   access_log,         .     gzip       ,      / . <br>       /    ,    <a href="http://nginx.org/en/docs/syslog.html">syslog</a> .         nginx. </p><br><h4 id="kesh-otkrytyh-faylov">    </h4><br><p>   <code>open(2)</code>   ,  -  / /  ,        .     ,     <code>ngx_open_cached_file</code> : </p><br><pre> <code class="hljs erlang-repl"># funclatency /srv/nginx-bazel/sbin/nginx:ngx_open_cached_file -u usecs : count distribution <span class="hljs-number"><span class="hljs-number">0</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">10219</span></span> |****************************************| <span class="hljs-number"><span class="hljs-number">2</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">3</span></span> : <span class="hljs-number"><span class="hljs-number">21</span></span> | | <span class="hljs-number"><span class="hljs-number">4</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">7</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span> | | <span class="hljs-number"><span class="hljs-number">8</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">15</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> | |</code> </pre> <br><p>  ,                ,     : </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">open_file_cache</span></span> max=<span class="hljs-number"><span class="hljs-number">10000</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">open_file_cache_min_uses</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">open_file_cache_errors</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>;</code> </pre> <br><p>   <code>open_file_cache</code>   <code>opensnoop</code> ,     ,  ,   <a href="http_core_module.html">  </a> : </p><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta"># opensnoop -n nginx PID COMM FD ERR PATH 69435 nginx 311 0 /srv/site/assets/serviceworker.js 69086 nginx 158 0 /srv/site/</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">/404.html ...</span></span></code> </pre> <br><h3 id="zaklyuchitelnoe-slovo">  Final word </h3><br><p>          -.     ,                . ,   ,   ,   ,     ,    Dropbox Edge Network  ,   /       .      <a href="http://conferences.sigcomm.org/sigcomm/2017/program.html"> </a> ,     <a href="https://research.fb.com/wp-content/uploads/2017/08/sigcomm17-final177-2billion.pdf"></a>  <a href="http://dl.acm.org/citation.cfm%3Fid%3D3098854"></a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/338226/">https://habr.com/ru/post/338226/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338214/index.html">Why in 2017 to write your own engine for mobile games?</a></li>
<li><a href="../338216/index.html">AStA: we collect APK on the device itself</a></li>
<li><a href="../338218/index.html">Broadcast of the conference ‚ÄúHPE Genesis: Future Computing Infrastructure‚Äù</a></li>
<li><a href="../338220/index.html">The philosophy of static code analysis: three simple steps</a></li>
<li><a href="../338222/index.html">How to translate cryptocurrency into another blockchain: a little about sidechains</a></li>
<li><a href="../338228/index.html">In turbo mode. How to build DevOps in 2 months</a></li>
<li><a href="../338230/index.html">Kubernetes 1.8: a review of major innovations</a></li>
<li><a href="../338232/index.html">From surgeon to developer: how to change profession in 40 years?</a></li>
<li><a href="../338236/index.html">ServiceNow Platform: Starter Kit</a></li>
<li><a href="../338238/index.html">Sales at the Unity Asset Store. Personal experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>