<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Russian AI Cup: Participant's Toolkit</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Already 6 years, the annual competition is held Russian AI Cup. During this time, the championship has become a regular audience and many avid partici...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Russian AI Cup: Participant's Toolkit</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ig/8b/5f/ig8b5fabtcczrvxqg0mqloojfnk.png" alt="image"></p><br><p>  Already 6 years, the annual competition is held Russian AI Cup.  During this time, the championship has become a regular audience and many avid participants have a small set of tools and tricks that help them develop.  I participated in this competition 3 times and also got a number of blanks and scripts, which I want to talk about in this article. </p><a name="habracut"></a><br><p>  A small digression about the quality of the code.  Competition sets a tough time frame for writing a strategy, many participants need to continue learning or working, someone uses a competition to learn new programming languages ‚Äã‚Äã- all of this has an extremely negative effect on the readability of the code.  My code is not an exception, and this is one of the reasons why in the article I will explain how to assemble my toolkit, but I will not give you complete solutions.  So... </p><br><h1 id="klass-vektora">  Class vector </h1><br><p>  Even in the 2012 winner‚Äôs <a href="https://habrahabr.ru/post/161333/">article</a> , Mr.Smile wrote that he had taken a vector class from another project, which simulates the physics of the game world for code.  He knew then or not, but among the participants a half joke was born on the half tradition that a vector class should be added to the project from the code of last year‚Äôs competition (it is possible from someone else‚Äôs, if you participate for the first time). </p><br><p>  What is so good and useful this class?  They can imagine the position of the object on the game map, speed, force (for example, friction).  The normalized vector can be used as a direction or angle, etc.  When simulating physics or movement, this class will save you a lot of energy and nerves. </p><br><p>  For the basis of my class, I took the code of one of the participants, who put it in open access (unfortunately, I don‚Äôt remember who and exactly ...).  After that, I expanded the methods I needed and updated the old ones: </p><br><ul><li> I made the fields public and deleted the <code>getX</code> and <code>getY</code> (this is how the code is written more concisely, and I don‚Äôt worry about the extra function calls). </li><li>  Removed the creation of a new vector, with the operations of multiplying by a number, subtracting another vector and the like.  The less intermediate objects are created, the faster everything works, and if you need a new object, then for this you add the <code>copy</code> method.  Writing code becomes more difficult - you need to constantly monitor, so as not to start changing the object that should not be. </li><li>  Added methods for calculating the square of the distance between vectors and changed the calculation of the length (more on this in the next paragraph of the article). </li><li>  Most methods return the vector itself, this allows you to call them in a chain, for example, like this: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">double</span></span> speed = ... Vec2D oldPosition = ... Vec2D position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vec2D(<span class="hljs-number"><span class="hljs-number">1.0</span></span>d, <span class="hljs-number"><span class="hljs-number">0.0</span></span>d).mul(speed).mul(stepsCount).rotate(unit.getAngle()).<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(oldPosition);</code> </pre> </li></ul><br><div class="spoiler">  <b class="spoiler_title">The code that I use (he saw a lot)</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> static java.lang.Math.*; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Vec2D { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> x; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> y; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D() { x = <span class="hljs-number"><span class="hljs-number">0</span></span>; y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D(<span class="hljs-type"><span class="hljs-type">double</span></span> x, <span class="hljs-type"><span class="hljs-type">double</span></span> y) { this.x = x; this.y = y; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D(Vec2D v) { this.x = vx; this.y = vy; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D(<span class="hljs-type"><span class="hljs-type">double</span></span> angle) { this.x = cos(angle); this.y = sin(angle); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Vec2D(this); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(Vec2D v) { x += vx; y += vy; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D sub(Vec2D v) { x -= vx; y -= vy; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(<span class="hljs-type"><span class="hljs-type">double</span></span> dx, <span class="hljs-type"><span class="hljs-type">double</span></span> dy) { x += dx; y += dy; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D sub(<span class="hljs-type"><span class="hljs-type">double</span></span> dx, <span class="hljs-type"><span class="hljs-type">double</span></span> dy) { x -= dx; y -= dy; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D mul(<span class="hljs-type"><span class="hljs-type">double</span></span> f) { x *= f; y *= f; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> length() { // <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hypot(x, y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FastMath.hypot(x, y); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> distance(Vec2D v) { // <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hypot(x - vx, y - vy); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FastMath.hypot(x - vx, y - vy); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> squareDistance(Vec2D v) { <span class="hljs-type"><span class="hljs-type">double</span></span> tx = x - vx; <span class="hljs-type"><span class="hljs-type">double</span></span> ty = y - vy; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tx * tx + ty * ty; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> squareDistance(<span class="hljs-type"><span class="hljs-type">double</span></span> x, <span class="hljs-type"><span class="hljs-type">double</span></span> y) { <span class="hljs-type"><span class="hljs-type">double</span></span> tx = this.x - x; <span class="hljs-type"><span class="hljs-type">double</span></span> ty = this.y - y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tx * tx + ty * ty; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> squareLength() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x * x + y * y; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D reverse() { x = -x; y = -y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D normalize() { <span class="hljs-type"><span class="hljs-type">double</span></span> length = this.length(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length == <span class="hljs-number"><span class="hljs-number">0.0</span></span>D) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IllegalStateException("Can\'t set angle of zero-width vector."); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { x /= length; y /= length; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D length(<span class="hljs-type"><span class="hljs-type">double</span></span> length) { <span class="hljs-type"><span class="hljs-type">double</span></span> currentLength = this.length(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentLength == <span class="hljs-number"><span class="hljs-number">0.0</span></span>D) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> IllegalStateException("Can\'t resize zero-width vector."); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.mul(length / currentLength); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D perpendicular() { <span class="hljs-type"><span class="hljs-type">double</span></span> a = y; y = -x; x = a; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> dotProduct(Vec2D vector) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x * vector.x + y * vector.y; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">double</span></span> angle() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> atan2(y, x); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">boolean</span></span> nearlyEqual(Vec2D potentialIntersectionPoint, <span class="hljs-type"><span class="hljs-type">double</span></span> epsilon) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> abs(x - potentialIntersectionPoint.x) &lt; epsilon &amp;&amp; abs(y - potentialIntersectionPoint.y) &lt; epsilon; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D rotate(Vec2D angle) { <span class="hljs-type"><span class="hljs-type">double</span></span> newX = angle.x * x - angle.y * y; <span class="hljs-type"><span class="hljs-type">double</span></span> newY = angle.y * x + angle.x * y; x = newX; y = newY; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D rotateBack(Vec2D angle) { <span class="hljs-type"><span class="hljs-type">double</span></span> newX = angle.x * x + angle.y * y; <span class="hljs-type"><span class="hljs-type">double</span></span> newY = angle.x * y - angle.y * x; x = newX; y = newY; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> String toString() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> "Vector (" + String.valueOf(x) + "; " + String.valueOf(y) + ")"; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D div(<span class="hljs-type"><span class="hljs-type">double</span></span> f) { x /= f; y /= f; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Vec2D copyFrom(Vec2D position) { this.x = position.x; this.y = position.y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } }</code> </pre></div></div><br><h1 id="rasstoyanie-mezhdu-dvumya-tochkami">  Distance between two points </h1><br><p>  Virtually any strategy in the Russian AI Cup somehow counts the distance between two points (the distance at which you can shoot, the collision of objects, the distance to the target, etc.).  Problems begin when such distances must be calculated hundreds of thousands or millions for 1 tick.  If you run the profiler, you can see that a lot of time is spent on calculating the methods of <code>hypot</code> , <code>sqrt</code> , and in some strategies, <code>sin</code> and <code>cos</code> . </p><br><p><img src="https://habrastorage.org/webt/fc/kt/n5/fcktn5oebvd1ffmujdldnsb0dr8.png"><br>  (For this screenshot, I changed the FastMath.hypot method so that it returns the result of the Math.hypot call) </p><br><p>  There are various ways to solve this problem. </p><br><h3 id="kvadrat-rasstoyaniya-mezhdu-tochkami">  Square distance between points </h3><br><p>  To calculate it, it is not necessary to take the root of the sum of squares of the differences of coordinates, which significantly speeds up the calculations.  But then the result must be compared, for example, with the square of the range of the shot (if we check in a dangerous zone) or with the square of the radius (if we check for a collision with a circle). </p><br><p>  Unfortunately, it is not always possible to use the squared distance, and some calculations require exactly the distance, for example, in some formulas for calculating potential fields. </p><br><h3 id="priblizhennye-vychisleniya">  Approximate calculations </h3><br><p>  You can use not quite (but sufficiently) accurate methods for calculating the distance between points.  How this is implemented, for example, in <a href="">FastMath</a> (hypot method).  You only need to look for ready-made solutions for your programming language. </p><br><h3 id="tablicy-znacheniy">  Value tables </h3><br><p>  In cases where there is no need for greater accuracy, and the limitations on memory are not too great, then it is possible to calculate in advance the function values ‚Äã‚Äãwith a certain step.  This approach works well for <code>sin</code> and <code>cos</code> . </p><br><h1 id="vizualizator">  Visualizer </h1><br><p>  The process of debugging a strategy is quite laborious and complicated, and the ability to draw additional elements on the playing field is crucial.  Unfortunately, this is not so easy to do with the standard visualizer provided by the organizers.  And with the utility, Repeater has to do everything blindly.  In addition, self-written visualizers often support the ability to rewind to make it easier to learn non-standard strategy behavior. </p><br><p>  During the competition there are 2 main approaches to writing a visualizer. </p><br><h3 id="vneshniy">  External </h3><br><p>  A visualizer is a separate application that receives information about what needs to be drawn through sockets or a file. <br>  <strong>Pros:</strong> Versatility.  You can use one visualizer for different programming languages. <br>  <strong>Cons:</strong> Difficult to expand functionality (need to update the API) </p><br><p>  <a href="http://telegram.me/kswaldemar">Telegraph</a> user <a href="http://telegram.me/kswaldemar">@kswaldemar</a> wrote an openGL open-source external visualizer.  You can download it from <a href="https://github.com/kswaldemar/rewind-viewer">github'a</a> .  The visualizer supports rewinding and is able to draw a sufficiently large number of objects.  Other users created clients for it (wrapper over API) for C ++, C #, Java, Python, Ruby, Rust, Swift. </p><br><h3 id="vstroennyy">  Built </h3><br><p>  A visualizer that is embedded in the strategy itself. <br>  <strong>Pros:</strong> It is easy to add a drawing of new things.  You can quickly specialize it in drawing data structures that strategy uses and stores. <br>  <strong>Cons:</strong> It works only within the framework of a single strategy and is very difficult to transfer to other projects. <br>  When changing language, you need to write from scratch. </p><br><p>  I decided to write my last visualizer in the second way, since  it seemed simpler and faster to me.  At the moment, I will not post its source code, because  he is strongly tied to my strategy, and I also do not want participants to distract from the competition trying to figure out how it works. </p><br><div class="spoiler">  <b class="spoiler_title">But boast a screenshot</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bt/du/er/btduerxfgky1k9jfm7xfynuu_by.png"></p></div></div><br><p>  In this case, the drawing is simple enough and performed on top of JPanel, but not everything always works well and quickly. </p><br><p>  Inspired by the <a href="https://www.youtube.com/watch%3Fv%3DvIN5fggSuyw">review</a> from Romka, last year, a couple of weeks before the competition, I wrote an external JavaScript visualizer.  It opened in the browser (it turned out quite well, with the ability to rewind and layers).  The strategy in the course of execution was supposed to generate a json file with logs that was supposed to be loaded into the visualizer.  But the reality turned out to be that the game contained too many objects and lasted 20,000 ticks, which created a huge file with logs that crashed the browser. </p><br><p>  Therefore, if you decide to create a visualizer that renders the games already played by the logs, then you should think about the format in which to store the replay data and whether it is worth your torment.  I decided for myself that it was not worth it. </p><br><h1 id="proksi-dlya-vizualizatora">  Proxy for visualizer </h1><br><p>  The main find for me was a proxy class, intercepting the moves sent by the strategy and returned by the Local Runner / Repeater utility of the state of the world.  Thanks to him, you can not just rewind to review the unusual behavior of the strategy during testing, but also rewind the strategy breakpoint at the right time and debug it in the <em>exact same state</em> it was in when you first viewed the game.  That sounds cool, doesn't it? </p><br><p>  To understand how this works, let's analyze how the language pack is arranged using the example of Java.  The entry point to the application is the <a href="">Runner</a> class.  At the start, a <a href="">RemoteProcessClient</a> object is <a href="">created</a> that reads the state of the world sent by the Local Runner and sends back the actions taken by the strategy ( <a href="">MyStrategy</a> class).  In order to intercept all messages from the server, we need to inherit from the RemoteProcessClient class and override the <code>readPlayerContextMessage</code> and <code>writeMoveMessage</code> .  I note that the class RemoteProcessClient is declared final, but we can change anything, since  On the server, this file will be overwritten by the original (the main thing is not to forget about it while writing the strategy). </p><br><div class="spoiler">  <b class="spoiler_title">VisualizerProxy code without UI</b> <div class="spoiler_text"><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VisualizerProxy</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RemoteProcessClient</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] FPS_LIMITS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[]{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fpsLimitIndex = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentFrame = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> endGameFrame = Integer.MAX_VALUE; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> isRunning = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> processOneFrame = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object runningLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;PlayerContext&gt; frames = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.runningLock) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pause(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.currentFrame = Integer.max(Integer.min(value, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.frames.size()), <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.runningLock.notifyAll(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">play</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isRunning = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.processOneFrame = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isRunning = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.processOneFrame = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toggle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (runningLock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isRunning) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pause(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.play(); runningLock.notifyAll(); } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisualizerProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(host, port); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.createControls(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.addEventsListeners(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createControls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addEventsListeners</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> PlayerContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readPlayerContextMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.startTime = System.nanoTime(); PlayerContext frame = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (frame == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Wait until not paused synchronized (this.runningLock) { while (!this.isRunning &amp;&amp; !this.processOneFrame) { try { this.runningLock.wait(); } catch (InterruptedException e) { e.printStackTrace(); } } this.processOneFrame = false; } if (this.currentFrame &gt;= this.endGameFrame) { // GAME END message show... this.isRunning = false; } else if (this.currentFrame == this.frames.size()) { frame = super.readPlayerContextMessage(); if (frame != null) { this.frames.add(frame); } else { this.endGameFrame = this.currentFrame; } } else { frame = this.frames.get(this.currentFrame); } } assert this.currentFrame &lt; this.frames.size(); return frame; } @Override public void writeMoveMessage(Move move) throws IOException { this.drawer.finishFrame(); this.currentFrame++; if (this.currentFrame == this.frames.size() &amp;&amp; this.currentFrame &lt; this.endGameFrame) { super.writeMoveMessage(move); } long endTime = System.nanoTime(); if (FPS_LIMITS[this.fpsLimitIndex] &gt; 0) { double diff = (1000.0 / FPS_LIMITS[this.fpsLimitIndex]) - (endTime - startTime) / 1000000.0; if (diff &gt; 0) { try { Thread.sleep((long) diff); } catch (InterruptedException e) { e.printStackTrace(); } } } } }</span></span></code> </pre> </div></div><br><p>  I removed components and some features from the UI code to make it more understandable. <br>  Buttons and slider in this case use the <code>setFrame</code> method for rewinding and <code>fpsLimitIndex</code> to set the limit on the number of frames per second.  The basic idea is simple: we return the frames in order, while they are there, if not, then this is either the end of the game, or we request the next frame from Local Runner if we have not saved it before.  There is a pause, which is also automatically set if you start rewinding. </p><br><p>  I will note that in this case it is safe to store all frames, since  RemoteProcessClient each time creates all the objects in a new way, as long as there is enough memory (I run the strategy with the <code>-Xmx1024M</code> flag and there were no problems yet). </p><br><p>  Now, when the state of the world returns to an arbitrary tick, the biggest problem remains - the state of the strategy for this tick.  Many of the decisions of the participants store information about the world, accumulated over the previous tics.  This means that if you receive the state of the world for the last tick, the strategy will not behave exactly the same as last time. </p><br><p>  This is a serious problem, and to solve it, I propose all the states of the strategy, which should be preserved between ticks, to be put into a separate class.  Also, you should add the <code>copy</code> method there, thanks to which we can save the state of the strategy in each of the previous ticks.  Below I greet an example of such a class that stores a random number generator and makes an exact copy of it, so that even random numbers will be the same for each rewind of the same frame (for example, if you use genetic algorithms in the solution). </p><br><div class="spoiler">  <b class="spoiler_title">GameState.java code</b> <div class="spoiler_text"><pre> <code class="hljs ruby">import model.*; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-symbol"><span class="hljs-symbol">TODO:</span></span> REMOVE START import java.lang.reflect.Field; import java.util.concurrent.atomic.AtomicLong; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-symbol"><span class="hljs-symbol">TODO:</span></span> REMOVE <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GameState</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Random</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">random</span></span></span><span class="hljs-class">;</span></span> GameState(Game game, World world) { random = new Random(game.getRandomSeed()); ... } void update(World world) { ... } /<span class="hljs-regexp"><span class="hljs-regexp">/ TODO: REMOVE START GameState(long randomSeed) { random = new Random(randomSeed); } GameState copy() { long theSeed = 0L; try { Field field = Random.class.getDeclaredField("seed"); field.setAccessible(true); AtomicLong scrambledSeed = (AtomicLong) field.get(random); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/this needs to be XOR'd with 0x5DEECE66DL theSeed = scrambledSeed.get(); } catch (Exception e) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/handle exception } return new GameState(theSeed ^ 0x5DEECE66DL); } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ TODO: REMOVE END }</span></span></code> </pre></div></div><br><p>  I suggest monitoring the state of the strategy itself (in order not to write a lot of code).  We will check if we have a state for the current tick, and take it.  If it is not there, or we have received the next tick after the current one, then we leave the old object and save it, in case we return again at this point in time. </p><br><div class="spoiler">  <b class="spoiler_title">MyStrategy.java code</b> <div class="spoiler_text"><pre> <code class="hljs perl">public final class MyStrategy implements Strategy { private boolean initializationRequired = true; private GameState <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> = null; @Override public void move(Player me, World world, Game game, Move move) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (initializationRequired) { initialize(me, world, game); initializationRequired = false; } // TODO: REMOVE START loadState(world.getTickIndex()); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> TODO: REMOVE END state.update(world); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> MAIN LOGIC HERE // TODO: REMOVE START saveState(world.getTickIndex() + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> TODO: REMOVE END } private void initialize(Player me, World world, Game game) { <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> = new GameState(game, world); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> TODO: REMOVE START states = new GameState[world.getTickCount() + <span class="hljs-number"><span class="hljs-number">1</span></span>]; saveState(world.getTickIndex()); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> tick. // TODO: REMOVE END } // TODO: REMOVE START private <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> prevTick = -<span class="hljs-number"><span class="hljs-number">1</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxTick = -<span class="hljs-number"><span class="hljs-number">1</span></span>; private GameState[] states; private void saveState(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tick) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tick &gt; maxTick) { maxTick = tick; states[tick] = state.copy(); } prevTick = tick; } private void loadState(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tick) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prevTick &gt; tick) { <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> = states[tick].copy(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } // RAIC <span class="hljs-number"><span class="hljs-number">2016</span></span> has <span class="hljs-string"><span class="hljs-string">'frozen'</span></span> strategies, so we should handle cases <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> we were frozen <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> some ticks. GameState loadState = null; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> statesBetween = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = prevTick + <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt;= tick; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (states[i] != null) { statesBetween++; loadState = states[i]; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (statesBetween &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> = loadState.copy(); } } // TODO: REMOVE END }</code> </pre> </div></div><br><p>  That's all, it will be necessary only to support the <code>copy</code> method of the GameState class to copy the state of the strategy.  This is the largest of the disadvantages of this decision, because  if you have a lot of data that must be transferred between ticks, then the size of this method can grow greatly and it becomes very difficult to maintain. </p><br><p>  The attentive reader has noticed comments in the code <code>// TODO: REMOVE START</code> and <code>// TODO: REMOVE END</code> .  I marked them with pieces of code for deletion before sending the strategy to the server, since  copying and storing all states for each tick slows down the solution.  Of course, we will not do this with our hands. </p><br><div class="spoiler">  <b class="spoiler_title">Life hacking for IDEA users</b> <div class="spoiler_text"><p>  In order not to confuse TODO data with others, in IDEA you can set different color schemes using a regular expression for todo. </p><br><p><img src="https://habrastorage.org/webt/o4/r2/_4/o4r2_4fjrehdgzffzji4yvgzu4c.png"></p><br><p>  Result: <br><img src="https://habrastorage.org/webt/gk/3y/qs/gk3yqsh-jb3w2cp21taq1zdiwcs.png"></p></div></div><br><h1 id="sborka-posylki">  Build Package </h1><br><p>  If you do not write a strategy in C ++, where there are wonderful IFDEFs, then you will have to somehow remove pieces of code.  For these purposes, a small python script was written, which: </p><br><ul><li>  copies only necessary files with code to a temporary folder, </li><li>  removes marked areas </li><li>  zip archive with date and time </li><li>  copies the cleaned files to the second project (it is used for testing without a visualizer), </li><li>  cleans the temporary folder. <br>  It will only download the zip archive to the site and watch how your bot fights for the right to be the best. </li></ul><br><div class="spoiler">  <b class="spoiler_title">clean_and_pack.py</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> shutil <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> copyfile, rmtree <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> zipfile <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime root_dir = os.path.dirname(__file__) root_path = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(root_dir, <span class="hljs-string"><span class="hljs-string">'..\\src\\main\\java'</span></span>) temp_path = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(root_dir, <span class="hljs-string"><span class="hljs-string">'..\\temp'</span></span>) out_path = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(root_dir, <span class="hljs-string"><span class="hljs-string">'..\\..\\zipped'</span></span>) for_optimization_path = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(root_dir, <span class="hljs-string"><span class="hljs-string">'..\\..\\zipped\\java-cgdk-ru-master\src\main\java'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> os.path.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>(out_path): os.mkdir(out_path) zip_name = <span class="hljs-string"><span class="hljs-string">'strategy_{}.zip'</span></span>.format(datetime.now().strftime("%Y%m%d_%H-%M")) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> zipfile.ZipFile(os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(out_path, zip_name), <span class="hljs-string"><span class="hljs-string">'w'</span></span>, zipfile.ZIP_DEFLATED) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> zipf: queue = [<span class="hljs-string"><span class="hljs-string">''</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> queue: cur_path = queue.pop(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cur_path.startswith(<span class="hljs-string"><span class="hljs-string">'model'</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> entity <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.scandir(os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(root_path, cur_path)): # <span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">some</span></span> files. <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> entity.name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'Strategy.java'</span></span>, <span class="hljs-string"><span class="hljs-string">'Runner.java'</span></span>, <span class="hljs-string"><span class="hljs-string">'Visualizer.java'</span></span>, <span class="hljs-string"><span class="hljs-string">'VisualizerProxy.java'</span></span>, <span class="hljs-string"><span class="hljs-string">'RemoteProcessClient.java'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> entity.is_dir(): queue.append(os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(cur_path, entity.name)) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: new_path = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(temp_path, cur_path) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> os.path.<span class="hljs-keyword"><span class="hljs-keyword">exists</span></span>(new_path): os.mkdir(new_path) new_full_path = os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(new_path, entity.name) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(root_path, cur_path, entity.name), <span class="hljs-string"><span class="hljs-string">'r'</span></span>, encoding="utf8") <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> rd, \ <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(new_full_path, <span class="hljs-string"><span class="hljs-string">'w'</span></span>, encoding="utf8") <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wt, \ <span class="hljs-keyword"><span class="hljs-keyword">open</span></span>(os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(for_optimization_path, cur_path), entity.name), <span class="hljs-string"><span class="hljs-string">'w'</span></span>, encoding="utf8") <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> wtopt: filter_flag = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rd.readlines(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> "TODO: REMOVE START" <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> filter_flag == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, "No clossing remove tag" filter_flag = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> elif "TODO: REMOVE END" <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> filter_flag == <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, "No open remove tag" filter_flag = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> elif filter_flag: wt.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-type"><span class="hljs-type">line</span></span>) # <span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span> clean files <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> another project wtopt.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-type"><span class="hljs-type">line</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> filter_flag == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, "No clossing remove tag" zipf.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(new_full_path, arcname=os.path.<span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(cur_path, entity.name)) rmtree(temp_path)</code> </pre><br><p>  The script will need to specify a directory with the code, a temporary folder and a place where to dump the zip archive and cleaned files.  You may have to create these folders in advance.  But, I hope, I gave the idea. </p><br><p>  IDEA users can add this script as the External Tool and launch via the menu on the right mouse button in the project structure. </p></div></div><br><h1 id="zapusk-mnozhestva-strategiy">  Run a variety of strategies </h1><br><p>  Above, I mentioned a project with code cleared of a visualizer.  In addition to testing, it is also used to generate a jar file that can be run as an adversary in a local runner, for example, using the <code>p2-startup-command</code> parameter.  Or you can use the python script, like this: </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">import subprocess def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_strategy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">filename, port, args=None</span></span></span><span class="hljs-function">): </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">params</span></span></span></span> = [<span class="hljs-string"><span class="hljs-string">'java'</span></span>, <span class="hljs-string"><span class="hljs-string">'-jar'</span></span>, filename, <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, str(port), <span class="hljs-string"><span class="hljs-string">"0000000000000000"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args: <span class="hljs-keyword"><span class="hljs-keyword">params</span></span>.extend(map(str, args)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> subprocess.Popen(<span class="hljs-keyword"><span class="hljs-keyword">params</span></span>)</code> </pre> <br><p>  In this case, in addition to the host, port and side, additional parameters are passed to the strategy at the start.  This can be used to automatically launch strategies with different parameters and check the result (Local Runner generates the file results.txt by default, but the name can be changed in the settings).  Of course, the Local Runner should already be running by the time this function is called. </p><br><p>  The automatic battle of the strategy with itself and the selection of constants on the basis of these battles deserve a separate article, and now let's see how inside the strategy to receive the parameters sent in this way.  You may have already guessed that once again you have to slightly tweak the Runner class, namely, update two methods so that it can take more than 3 parameters per input: </p><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.length &gt;= <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runner(args).run(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runner(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[]{<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"31001"</span></span>, <span class="hljs-string"><span class="hljs-string">"0000000000000000"</span></span>}).run(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Runner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ remoteProcessClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VisualizerProxy(args[<span class="hljs-number"><span class="hljs-number">0</span></span>], Integer.parseInt(args[<span class="hljs-number"><span class="hljs-number">1</span></span>])); token = args[<span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.length &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { Params.INSTANCE.setValues(Arrays.copyOfRange(args, <span class="hljs-number"><span class="hljs-number">3</span></span>, args.length)); } }</code> </pre> <br><p>  <code>Params</code> , in this case, is a singleton with a method for updating default values. </p><br><div class="spoiler">  <b class="spoiler_title">For example such</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Params { INSTANCE; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Params</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> c1 = <span class="hljs-number"><span class="hljs-number">1.0</span></span>d; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> c2 = <span class="hljs-number"><span class="hljs-number">2.0</span></span>d; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setValues</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { c1 = Double.parseDouble(args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); c2 = Double.parseDouble(args[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } }</code> </pre></div></div><br><h1 id="itak">  so </h1><br><p>  The toolkit described above is not exhaustive.  To make life easier, the participants write many utilities, auxiliary scripts, telegram bots and the like.  Of course, this is not a prerequisite for victory, but often allows you to develop your strategy faster and more efficiently, which ultimately increases the number of spectacular bots battles that so many people love. </p><br><p>  Thank you for your attention and success in the competition! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/343006/">https://habr.com/ru/post/343006/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342996/index.html">Goto in ITMO: Botali week. Torn 2 accordions</a></li>
<li><a href="../342998/index.html">"Correct" command structure for DevOps</a></li>
<li><a href="../343000/index.html">Diagnostics of industrial electric motors and generators on the spectrum of current consumption and prevention of accidents</a></li>
<li><a href="../343002/index.html">Review of music software code defects. Part 4. Ardour</a></li>
<li><a href="../343004/index.html">The second wave that covered us. The standard that was waiting</a></li>
<li><a href="../343008/index.html">Development of sustainability strategies</a></li>
<li><a href="../343010/index.html">Renga BIM API</a></li>
<li><a href="../343012/index.html">Scrum is not only in development - we use a flexible methodology in organizing an IT festival for children and parents</a></li>
<li><a href="../343014/index.html">Slight discrepancy</a></li>
<li><a href="../343016/index.html">Ray casting in the web world today</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>