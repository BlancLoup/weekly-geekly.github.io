<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Upload photos to the site using email</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is my first post on Habr√©, so do not judge strictly. 

 Task. 
 Implement the ability to upload photos to a profile or photo event tape via e-mai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Upload photos to the site using email</h1><div class="post__text post__text-html js-mediator-article">  This is my first post on Habr√©, so do not judge strictly. <br><br><h4>  Task. </h4><br>  Implement the ability to upload photos to a profile or photo event tape via e-mail, place them in the specified folder and make a corresponding entry in the database. <br><br><h4>  Algorithm </h4><br>  The user sends an email with photos to the <b>userXXX_eventYYY@mysite.com</b> type <b>address</b> , where eventYYY is the event ID;  userXXX - user ID.  This e-mail address DOES NOT EXIST.  Therefore, all letters sent to non-existent addresses are redirected to image_upload@mysite.com.  Then, when reading mail from this address, parse the headers and find out to which address the letter was originally sent.  Parse the received address, find out where to put the files and who flooded them. <br><a name="habracut"></a><br><h4>  Using PEAR </h4><br>  To work with the POP3 server, the <b>PEAR</b> library was used, in particular the class <b>Net_POP3</b> , which is located in the file <i>path / to / pear / Net / POP3.php</i> .  For its successful work, the class <b>Net_Socket</b> ( <i>path / to / pear / Net / Socket.php</i> ) and, in fact, PEAR.php are required.  All these files are located at <a href="http://pear.php.net/">http://pear.php.net</a> and are available for download. <br>  If you do not have PEAR installed - just copy POP3.php and Socket.php to your folder with libraries and overwrite the paths in them.  The PEAR.php file is in the path / to / pear / folder. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Additional functions </h4><br>  For processing attached files I needed some more functions.  I will not ascribe to themselves their authorship.  They are taken from the site <a href="http://webi.ru/webi_articles/6_12_f.html">http://webi.ru/webi_articles/6_12_f.html</a> and slightly altered (quite a bit). <br>  In my code, they look like this: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">/* START FUNCTIONS BLOCK */</font> <br> <font color="#008000">//     boundary   Content-Type</font> <br> function get_boundary($ctype){ <br> <font color="#0000ff">if</font> (preg_match( <font color="#A31515">'/boundary[ ]?=[ ]?(["]?.*)/i'</font> ,$ctype,$regs)) { <br> $boundary = preg_replace( <font color="#A31515">'/^\"(.*)\"$/'</font> , <font color="#A31515">"\\1"</font> , $regs[1]); <br> <font color="#0000ff">return</font> trim( <font color="#A31515">"--$boundary"</font> ); <br> } <br> } <br> <br> <font color="#008000">//        (,   ..)</font> <br> <font color="#008000">//         ( ),   boundary</font> <br> function split_parts($boundary,$body) { <br> $startpos = strpos($body,$boundary)+strlen($boundary)+2; <br> $lenbody = strpos($body, <font color="#A31515">"\r\n$boundary--"</font> ) - $startpos; <br> $body = substr($body,$startpos,$lenbody); <br> <font color="#0000ff">return</font> explode($boundary. <font color="#A31515">"\r\n"</font> ,$body); <br> } <br> <br> <font color="#008000">//             </font> <br> function fetch_structure($email) { <br> $ARemail = Array(); <br> $separador = <font color="#A31515">"\r\n\r\n"</font> ; <br> $header = trim(substr($email,0,strpos($email,$separador))); <br> $bodypos = strlen($header)+strlen($separador); <br> $body = substr($email,$bodypos,strlen($email)-$bodypos); <br> $ARemail[ <font color="#A31515">"header"</font> ] = $header; <br> $ARemail[ <font color="#A31515">"body"</font> ] = $body; <br> <font color="#0000ff">return</font> $ARemail; <br> } <br> <br> <font color="#008000">//      ,       </font> <br> function decode_header($header) { <br> $headers = explode( <font color="#A31515">"\r\n"</font> ,$header); <br> $decodedheaders = Array(); <br> <font color="#0000ff">foreach</font> ($headers <font color="#0000ff">as</font> $header_item){ <br> $thisheader = trim($header_item); <br> <font color="#0000ff">if</font> (!empty($thisheader)) <br> { <br> <font color="#0000ff">if</font> (!ereg( <font color="#A31515">"^[A-Z0-9a-z_-]+:"</font> ,$thisheader)) <br> $decodedheaders[$lasthead] .= <font color="#A31515">" $thisheader"</font> ; <br> <font color="#0000ff">else</font> { <br> $dbpoint = strpos($thisheader, <font color="#A31515">":"</font> ); <br> $headname = strtolower(substr($thisheader,0,$dbpoint)); <br> $headvalue = trim(substr($thisheader,$dbpoint+1)); <br> <font color="#0000ff">if</font> ($decodedheaders[$headname] != <font color="#A31515">""</font> ) <br> $decodedheaders[$headname] .= <font color="#A31515">"; $headvalue"</font> ; <br> <font color="#0000ff">else</font> <br> $decodedheaders[$headname] = $headvalue; <br> $lasthead = $headname; <br> } <br> } <br> } <br> <font color="#0000ff">return</font> $decodedheaders; <br> } <br> <br> <font color="#008000">//   .</font> <br> <font color="#008000">//              .</font> <br> <font color="#008000">//         .</font> <br> function compile_body($body,$enctype,$ctype) { <br> $enctype = explode( <font color="#A31515">" "</font> ,$enctype); $enctype = $enctype[0]; <br> <font color="#0000ff">if</font> (strtolower($enctype) == <font color="#A31515">"base64"</font> ) <br> $body = base64_decode($body); <br> elseif(strtolower($enctype) == <font color="#A31515">"quoted-printable"</font> ) <br> $body = quoted_printable_decode($body); <br> <font color="#0000ff">if</font> (ereg( <font color="#A31515">"koi8"</font> , $ctype)) $body = convert_cyr_string($body, <font color="#A31515">"k"</font> , <font color="#A31515">"w"</font> ); <br> <font color="#0000ff">return</font> $body; <br> } <br> <font color="#008000">/* END FUNCTIONS BLOCK */</font></font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h4>  Main code (email_upload.php) </h4><br>  Now that everything is ready, it's time to write a script for receiving letters and processing them. <br>  First, create an object $ pop3 and connect to the server. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">$user= <font color="#A31515">'username'</font> ; <br> $pass= <font color="#A31515">'secure'</font> ; <br> $host= <font color="#A31515">'mysite.com'</font> ; <br> $port= <font color="#A31515">"110"</font> ; <br> <br> <font color="#008000">//  </font> <br> $pop3 =&amp; <font color="#0000ff">new</font> Net_POP3(); <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">if</font> (PEAR::isError( $ret= $pop3-&gt;connect($host , $port ) )){ <br> echo <font color="#A31515">"ERROR: "</font> . $ret-&gt;getMessage() . <font color="#A31515">"\n"</font> ; <br> exit(); <br> } <br> <br> <font color="#008000">//   </font> <br> <font color="#0000ff">if</font> (PEAR::isError( $ret= $pop3-&gt;login($user , $pass, <font color="#A31515">'USER'</font> ) )){ <br> echo <font color="#A31515">"ERROR: "</font> . $ret-&gt;getMessage() . <font color="#A31515">"\n"</font> ; <br> exit(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now everything is ready to receive the list of letters and their processing.  This and do <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">$message_list=$pop3-&gt;getListing(); //   .</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Go through all the letters in the cycle: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">foreach</font> ($message_list <font color="#0000ff">as</font> $message){ <br> $filenames[] = array(); <br> <font color="#008000">/* START GET PARSED HEADERS */</font> <br> <font color="#008000">//    </font> <br> $message_id = $message[ <font color="#A31515">'msg_id'</font> ]; <br> <font color="#008000">//  </font> <br> $headers = $pop3-&gt;getParsedHeaders($message_id); <br> <br> $type = $ctype = $headers[ <font color="#A31515">'Content-Type'</font> ]; <br> $ctype = split( <font color="#A31515">";"</font> ,$ctype); <br> $types = split( <font color="#A31515">"/"</font> ,$ctype[0]); <br> $maintype = trim(strtolower($types[0])); <br> $subtype = trim(strtolower($types[1])); <br> <br> <font color="#008000">/* END GET PARSED HEADERS */</font> <br> <font color="#008000">/* START CREATE FILE LOCATION AND SQL DATA*/</font> <br> <br> <font color="#008000">//    </font> <br> $from_user_info = $headers[ <font color="#A31515">'Delivered-To'</font> ]; <br> <br> <font color="#008000">//    </font> <br> preg_match( <font color="#A31515">'/(user[0-9]+)_(event[0-9]+)@mysite.com/'</font> , $from_user_info, $matches); <br> $user_id = str_replace( <font color="#A31515">"user"</font> , <font color="#A31515">""</font> , $matches[1]); <br> $event_id = str_replace( <font color="#A31515">"event"</font> , <font color="#A31515">""</font> , $matches[2]); <br> <br> <font color="#008000">//    </font> <br> $file_location = <font color="#A31515">"/path/to/upload"</font> ; <br> <br> <font color="#008000">//    SQL </font> <br> $table_data = array( <br> <font color="#A31515">'user_id'</font> =&gt; $user_id, <br> <font color="#A31515">'event_id'</font> =&gt; $event_id <br> ); <br> <br> <font color="#008000">/* END CREATE FILE LOCATION AND SQL DATA*/</font> <br> <br> <font color="#008000">/* START GET BODY */</font> <br> <font color="#008000">//   </font> <br> $message_text = htmlspecialchars($pop3-&gt;getBody($message_id)); <br> <br> <font color="#008000">//    (   )</font> <br> <font color="#0000ff">if</font> ($maintype== <font color="#A31515">"multipart"</font> &amp;&amp; ereg($subtype, <font color="#A31515">"signed,mixed,related"</font> )) <font color="#008000">//  </font> <br> { <br> <font color="#008000">//  -  </font> <br> $boundary=get_boundary($headers[ <font color="#A31515">'Content-Type'</font> ]); <br> <br> <font color="#008000">//        </font> <br> $part = split_parts($boundary,$message_text); <br> <br> <font color="#008000">// </font> <br> <font color="#0000ff">foreach</font> ($part <font color="#0000ff">as</font> $part_item){ <br> <font color="#008000">//       </font> <br> $email = fetch_structure($part_item); <br> $header = $email[ <font color="#A31515">"header"</font> ]; <br> $body = $email[ <font color="#A31515">"body"</font> ]; <br> <br> <font color="#008000">//    </font> <br> $headers = decode_header($header); <br> $ctype = $headers[ <font color="#A31515">"Content-Type"</font> ]; <br> $cid = $headers[ <font color="#A31515">"content-id"</font> ]; <br> $Actype = split( <font color="#A31515">";"</font> ,$ctype); <br> $types = split( <font color="#A31515">"/"</font> ,$Actype[0]); <br> $rctype = strtolower($Actype[0]); <br> <br> <font color="#008000">//  ,      </font> <br> $is_download = (ereg( <font color="#A31515">"name="</font> ,$headers[ <font color="#A31515">"content-disposition"</font> ].$headers[ <font color="#A31515">"content-type"</font> ]) || $headers[ <font color="#A31515">"X-Attachment-Id"</font> ] != <font color="#A31515">""</font> || $rctype == <font color="#A31515">"message/rfc822"</font> ); <br> <br> <font color="#0000ff">if</font> ($is_download) { <br> <font color="#008000">//       Content-Type  Content-Disposition</font> <br> $cdisp = $headers[ <font color="#A31515">"content-disposition"</font> ]; <br> $ctype = $headers[ <font color="#A31515">"content-type"</font> ]; <br> $ctype2 = explode( <font color="#A31515">";"</font> ,$ctype); <br> $ctype2 = $ctype2[0]; <br> $Atype = split( <font color="#A31515">"/"</font> ,$ctype); <br> $Acdisp = split( <font color="#A31515">";"</font> ,$cdisp); <br> $fname = $Acdisp[1]; <br> <font color="#0000ff">if</font> (ereg( <font color="#A31515">"filename=\"(.*)\""</font> ,$fname,$regs)) <br> $filename = $regs[1]; <br> <font color="#0000ff">if</font> ($filename == <font color="#A31515">""</font> &amp;&amp; ereg( <font color="#A31515">"name=(.*)"</font> ,$ctype,$regs)) <br> $filename = $regs[1]; <br> $filename = ereg_replace( <font color="#A31515">"\"(.*)\""</font> , <font color="#A31515">"\\1"</font> ,$filename); <br> $filename = ereg_replace( <font color="#A31515">""(.*)""</font> , <font color="#A31515">"\\1"</font> ,$filename); <br> <br> <font color="#008000">//   .</font> <br> $body = compile_body($body,$headers[ <font color="#A31515">"content-transfer-encoding"</font> ],$ctype); <br> <br> <font color="#008000">//    </font> <br> $filename = $file_location.trim($filename); <br> <br> <font color="#008000">//       </font> <br> $filenames[] = $filename; <br> <font color="#008000">//  </font> <br> $ft=fopen($filename, <font color="#A31515">"wb"</font> ); <br> fwrite($ft,$body); <br> fclose($ft); <br> } <br> } <br> } <br> <br> <font color="#008000">//   $filenames[]  $table_data     .</font> <br> $query = <font color="#A31515">"INSERT INTO event_foto(event_id, user_id, image_name) VALUES "</font> ; <br> $total_fotos = count($filenames); <br> $current = 1; <br> <font color="#0000ff">foreach</font> ($filenames <font color="#0000ff">as</font> $file){ <br> $query .= <font color="#A31515">"('$event_id','$user_id','$file')"</font> ; <br> <font color="#0000ff">if</font> ($total_fotos&gt;$current) <br> $query .= <font color="#A31515">", "</font> ; <br> $current++; <br> } <br> mysql_query($query); <br> <font color="#008000">//     </font> <br> $pop3-&gt;deleteMsg($message_id); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br><h4>  the end </h4><br>  Actually everything.  The module is working.  It remains only to hang this file on the CRON (for example, every hour). <br>  Thanks for attention.  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/77304/">https://habr.com/ru/post/77304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../77298/index.html">Rate the idea for a startup</a></li>
<li><a href="../77299/index.html">Sams√∏ (Samso) is fully self-sufficient in energy.</a></li>
<li><a href="../77301/index.html">Pointless "Operating System"</a></li>
<li><a href="../77302/index.html">Perfect Money advertises the company on Youtube while using the Russian version of Windows</a></li>
<li><a href="../77303/index.html">Lars Online (Kiev-Sydney Wave Marathon with Lars Rasmussen)</a></li>
<li><a href="../77305/index.html">Rules of the game in business correspondence</a></li>
<li><a href="../77306/index.html">Not a very brief reminder of the passage of DHL parcel customs clearance</a></li>
<li><a href="../77308/index.html">The form of google search in habr</a></li>
<li><a href="../77313/index.html">Change UserAgent with third-party applications</a></li>
<li><a href="../77314/index.html">Event Tracking with _trackEvent in Google Analytics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>