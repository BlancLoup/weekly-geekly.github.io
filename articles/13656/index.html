<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Performance of MS SQL Server 2000/2005 stored procedures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The situation is considered when stored procedures can degrade query performance. 


 When compiling stored procedures in MS SQL Server 2000, stored p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Performance of MS SQL Server 2000/2005 stored procedures</h1><div class="post__text post__text-html js-mediator-article">  The situation is considered when stored procedures can degrade query performance. <br><br><a name="habracut"></a><br>  When compiling stored procedures in MS SQL Server 2000, stored procedures are placed in a procedural cache, which can increase performance when they are performed by eliminating the need for parsing, optimizing and compiling stored procedure code. <br>  On the other hand, in storing the compiled code of the stored procedure lies pitfalls that can have the opposite effect. <br>  The fact is that compiling a stored procedure compiles the execution plan of those statements that make up the procedure code, respectively, if the compiled stored procedure is cached, then its execution plan is cached, and therefore the stored procedure will not be optimized for the specific situation and query parameters. <br>  Do a little experiment to demonstrate this. <br><br>  <strong>STEP 1</strong> .  Creating a database. <br>  For the experiment we will create a separate database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <em>CREATE DATABASE test_sp_perf</em> <em><br></em>  <em>ON (NAME = 'test_data', FILENAME = 'c: \ temp \ test_data', SIZE = 1, MAXSIZE = 10, FILEGROWTH = 1Mb)</em> <em><br></em>  <em>LOG ON (NAME = 'test_log', FILENAME = 'c: \ temp \ test_log', SIZE = 1, MAXSIZE = 10, FILEGROWTH = 1Mb)</em> <br><br>  <strong>STEP 2.</strong> Creating a table. <br>  <em>CREATE TABLE sp_perf_test (column1 int, column2 char (5000))</em> <br><br>  <strong>STEP 3.</strong> Filling the table with test lines.  Duplicate rows are intentionally added to the table.  10,000 lines with numbers from 1 to 10,000, and 10,000 lines with numbers 50,000. <br><br>  <em>DECLARE @i int</em> <em><br></em>  <em>SET @ i = 1</em> <em><br></em>  <em>WHILE (@i &lt;10,000)</em> <em><br></em>  <em>BEGIN</em> <em><br></em>  <em>INSERT INTO sp_perf_test (column1, column2) VALUES (@ i, 'Test string #' + CAST (@i as char (8)))</em> <em><br></em>  <em>INSERT INTO sp_perf_test (column1, column2) VALUES (50000, 'Test string #' + CAST (@i as char (8)))</em> <em><br></em>  <em>SET @ i = @ i + 1</em> <em><br></em>  <em>END</em> <em><br><br></em>  <em>SELECT COUNT (*) FROM sp_perf_test</em> <em><br></em>  <em>GO</em> <br><br>  <strong>STEP 4.</strong> Creating a nonclustered index.  Since the execution plan is cached along with the procedure, the index will be used in the same way for all calls. <br><br>  <em>CREATE NONCLUSTERED INDEX CL_perf_test ON sp_perf_test (column1)</em> <em><br></em>  <em>GO</em> <br><br>  <strong>STEP 5.</strong> Creating a stored procedure.  The procedure simply performs a SELECT statement with the condition. <br><br>  <em>CREATE PROC proc1 (@param int)</em> <em><br></em>  <em>AS</em> <em><br></em>  <em>SELECT column1, column2 FROM sp_perf_test WHERE column1 = @ param</em> <em><br></em>  <em>GO</em> <br><br>  <strong>STEP 6.</strong> Run the stored procedure.  When you start a vulnerable procedure, a selective parameter is specifically used.  As a result of the procedure, we get 1 line.  The execution plan indicates the use of a non-cluster index, since  The query is selective and this is the best way to extract a string.  A procedure optimized for sampling a single line is stored in the procedural cache. <br><br>  <em>EXEC proc1 1234</em> <em><br></em>  <em>GO</em> <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/d8b/9a8/4ba/d8b9a84ba403ce1bcee75c675658a9c0.jpg" width="450" height="261" hspace="10" vspace="10"><br><br>  <strong>STEP 7.</strong> Run the stored procedure with a non-selective parameter.  The value of 50000 is used as a parameter. Rows with this first column value of about 10,000, respectively, use the nonclustered index and bookmark lookup operation inefficiently, but since the compiled code with the execution plan is stored in the procedure cache, it will be used.  The execution plan shows this, as well as the fact that bookmark lookup was performed for 9999 lines. <br><br>  <em>EXEC proc1 50000</em> <em><br></em>  <em>GO</em> <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/cdb/193/2e7/cdb1932e71737ed25f39c9d31d510252.jpg" width="450" height="325" hspace="10" vspace="10"><br><br>  <strong>STEP 8.</strong> Execute selection of rows with the first field equal to 50000. When executing a separate query, the query is optimized and compiled with a specific value of the first column.  As a result, the query optimizer determines that the field is duplicated many times and decides to use the table scan operation, which in this case is much more efficient than using a nonclustered index. <br><br>  <em>SELECT column1, column2 FROM sp_perf_test WHERE column1 = 50000</em> <em><br></em>  <em>GO</em> <br><br><img src="https://habrastorage.org/getpro/habr/olpictures/914/80d/984/91480d98485f4f475e820cb37fb7a1f3.jpg" width="450" height="313" hspace="10" vspace="10"><br><br>  Thus, we can conclude that the use of stored procedures can not always improve query performance.  You should be very careful about those stored procedures that work with results with a variable number of rows and using different execution plans. <br>  You can use the script to repeat the experiment on your MS SQL server. <br><br></div><p>Source: <a href="https://habr.com/ru/post/13656/">https://habr.com/ru/post/13656/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../136551/index.html">Unhappy hours are not observed. Mode of operation on the site</a></li>
<li><a href="../136552/index.html">Excellent visual video lecture about the essence of SOPA / PIPA and possible problems</a></li>
<li><a href="../136556/index.html">One design or a lot?</a></li>
<li><a href="../136558/index.html">Lectorium recorded almost a thousand lectures in a year.</a></li>
<li><a href="../136559/index.html">Selectel Tour: Flower Center</a></li>
<li><a href="../136561/index.html">System administrators. What are they?</a></li>
<li><a href="../136562/index.html">Zuckerberg: SOPA - badly thought-out bill</a></li>
<li><a href="../136569/index.html">Herringbone on the chart or pulse of the New Year</a></li>
<li><a href="../13657/index.html">Quintura goes to school</a></li>
<li><a href="../136570/index.html">Save the project: the most important questions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>