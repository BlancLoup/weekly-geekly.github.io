<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis and optimization of a single query in EclipseLink</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I decided to put together a few good practices that I learned in two years of working with the ORM framework EclipseLink based on a r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis and optimization of a single query in EclipseLink</h1><div class="post__text post__text-html js-mediator-article">  In this article, I decided to put together a few good practices that I learned in two years of working with the ORM framework EclipseLink based on a real example. <br>  The article is designed for those who have already worked with the framework based on JPA, whether it is Hibernate or OpenJPA. <br><br><a name="habracut"></a><br>  The project, examples of which I will give, is based on Spring. <br><br><h5>  Problem: </h5><br>  The following tables are available. <br><pre><code class="sql hljs">ARTICLES -&gt; Article.java ( ID int, NAME varchar ); ARTICLE_ROLES ( ARTICLE_ID int, ROLE_ID int ); ROLES -&gt; Role.java ( ID int, NAME varchar );</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ROLES is a standard lookup table, with a small number of rows. <br><br>  Accordingly, in the entity Article we define the connection via the JoinTable: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ManyToOne</span></span>(optional = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, targetEntity = Role.class, fetch = FetchType.EAGER, cascade = { CascadeType.MERGE, CascadeType.REFRESH }) <span class="hljs-meta"><span class="hljs-meta">@JoinTable</span></span>(name = <span class="hljs-string"><span class="hljs-string">"ARTICLE_ROLES"</span></span>, joinColumns = {<span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"ARTICLE_ID"</span></span>, referencedColumnName=<span class="hljs-string"><span class="hljs-string">"ID"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>}, inverseJoinColumns = {<span class="hljs-meta"><span class="hljs-meta">@JoinColumn</span></span>(name = <span class="hljs-string"><span class="hljs-string">"ROLE_ID"</span></span>, referencedColumnName = <span class="hljs-string"><span class="hljs-string">"ID"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Role </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRole</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> role; }</code> </pre> <br>  Now we define the query - getAllArticles as follows: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Article. getAllArticles"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT s FROM Article s"</span></span>)</code> </pre> <br>  And after a week with ten thousand articles in the database, we begin to receive complaints about poor performance.  Problem. <br><br><h5>  Problem analysis: </h5><br>  First of all, let's use PerformanceMonitor of EclipseLink to measure how many database queries actually go through JPA. <br>  The easiest way to enable it is through persistence.xml <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">persistence</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"eclipselink.profiler"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PerformanceMonitor"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">persistence-unit</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">persistence</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  But persistence.xml can be common for tests and applications. <br>  But they have different beans.xml.  So for tests it is enough to register in it: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"entityManagerFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jpaPropertyMap"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">map</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entry</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"eclipselink.profiler"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PerformanceMonitor"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">map</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Small note</b> <div class="spoiler_text">  Do not try to enable Profiler through the @PersistenceContext annotation, like this: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PersistenceContext</span></span>(properties={<span class="hljs-meta"><span class="hljs-meta">@PersistenceProperty</span></span>(name=<span class="hljs-string"><span class="hljs-string">"eclipselink.profiler"</span></span>,value=<span class="hljs-string"><span class="hljs-string">"PerformanceMonitor"</span></span>)}) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> EntityManager em;</code> </pre> <br>  This method will not work. <br></div></div><br><br>  Now let's use our profiler in the test. <br><pre> <code class="java hljs">PerformanceMonitor profiler = (PerformanceMonitor)em.unwrap(Session.class).getProfiler();</code> </pre> <br><br>  PerformanceMonitor contains a Map in which it stores all the information, starting with the total number of queries to the database, and ending with the time for each. <br>  We are interested in two specific parameters: Counter: ReadAllQuery and Counter: ReadObjectQuery. <br>  Get them and compare before and after. <br><pre> <code class="java hljs">Long before = profiler.getOperationTimings.get(<span class="hljs-string"><span class="hljs-string">"Counter:ReadAllQuery"</span></span>) + profiler.getOperationTimings.get(<span class="hljs-string"><span class="hljs-string">"Counter:ReadObjectQuery "</span></span>); em.createNamedQuery(<span class="hljs-string"><span class="hljs-string">"Article.getAllArticles"</span></span>).getResultList(); Long after = profiler .getOperationTimings.get(<span class="hljs-string"><span class="hljs-string">"Counter:ReadAllQuery"</span></span>) + profiler.getOperationTimings.get(<span class="hljs-string"><span class="hljs-string">"Counter:ReadObjectQuery "</span></span>);</code> </pre> <br>  To discover that the difference is not 1, as one would expect, but 10001. Oh. <br><br>  The fact is that despite fetch = FetchType.EAGER, when using JoinTable, JPA decides to generate a query for each line in order to get the corresponding Role object. <br><br><h5>  Solution, first version: </h5><br>  Add a Hint indicating JPA how to bring data <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Article. getAllArticles"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT s FROM Article s"</span></span>, hints = { &lt;b&gt;<span class="hljs-meta"><span class="hljs-meta">@QueryHint</span></span>(name = QueryHints. FETCH, value = <span class="hljs-string"><span class="hljs-string">"s.role"</span></span>)&lt;/b&gt;)</code> </pre> <br>  Consider the syntax of this hint. <br>  The part to the daughter must match the alias of the object in the text of the query. <br>  If you mistakenly use another letter, Hint will not work, silently, without throwing an error. <br>  The part after the dot must match the name of the member inside the Article. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Article</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶ Role &lt;b&gt;role&lt;/b&gt;; ‚Ä¶ }</code> </pre> <br>  Everything is fine, now the database reaches exactly one request.  But we suddenly discover that the number returned by the query is now not ten thousand, as before, but only nine.  Problem. <br><br><h5>  Solution, second version. </h5><br>  The fact is that QueryHints.FETCH rewrites the query for using JOINs.  But if in JOIN TABLE there is no corresponding line (the article does not have the necessary role defined), then the main line will not return either. <br>  Fortunately, in this case there is QueryHints.LEFT_FETCH. <br><br>  The final decision will look like this: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@NamedQuery</span></span>(name = <span class="hljs-string"><span class="hljs-string">"Article. getAllArticles"</span></span>, query = <span class="hljs-string"><span class="hljs-string">"SELECT s FROM Article s"</span></span>, hints = { <span class="hljs-meta"><span class="hljs-meta">@QueryHint</span></span>(name = QueryHints.LEFT_FETCH, value = <span class="hljs-string"><span class="hljs-string">"s.role"</span></span>))</code> </pre><br><br>  One query to the database, all objects, without the need to change the text query as such. </div><p>Source: <a href="https://habr.com/ru/post/164495/">https://habr.com/ru/post/164495/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164485/index.html">We follow the comments on the site in the widget "Comments" from VKontakte</a></li>
<li><a href="../164487/index.html">Java multithreading</a></li>
<li><a href="../164489/index.html">Ways of moving computer characters (Part 1)</a></li>
<li><a href="../164491/index.html">Homemade lights on quadrocopter</a></li>
<li><a href="../164493/index.html">Directives in AngularJS</a></li>
<li><a href="../164497/index.html">Online IDE - a tribute to cloud fashion or the inevitability of the development environment?</a></li>
<li><a href="../164499/index.html">Electric field simulation with CUDA</a></li>
<li><a href="../164501/index.html">New Year's IT ball</a></li>
<li><a href="../164507/index.html">Winter tale in your Android'e</a></li>
<li><a href="../164509/index.html">Close 2012</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>