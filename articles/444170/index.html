<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Publish iOS apps on the App Store with GitLab and fastlane</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How GitLab with fastlane collects, signs and publishes iOS apps in the App Store. 


 Recently we had a post on how to quickly build and run an Androi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Publish iOS apps on the App Store with GitLab and fastlane</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/ll/hf/nu/llhfnueb7v4rfqwj9bcdtzdvrr0.jpeg"></p><br><p>  How GitLab with fastlane collects, signs and publishes iOS apps in the App Store. </p><br><p>  Recently we had a <a href="https://about.gitlab.com/2019/01/28/android-publishing-with-gitlab-and-fastlane/">post on how to quickly build and run an Android application</a> with GitLab and <a href="https://fastlane.tools/">fastlane</a> .  Here we will see how to build and run an iOS application and publish it in TestFlight.  Check out how cool <a href="https://www.youtube.com/watch%3Fv%3D325FyJt7ZG8">I am making a change on the iPad Pro with the GitLab Web IDE</a> , taking the build and getting an update of the test version of the application on the same iPad Pro where I developed it. </p><br><p>  Here we take a <a href="https://gitlab.com/jlenny/flappyokr">simple iOS application on Swift</a> , with which I recorded video. </p><a name="habracut"></a><br><h3 id="para-slov-o-konfiguracii-apple-store">  A couple of words about the configuration of the Apple Store </h3><br><p>  We need an app in the App Store, distribution certificates, and an initialization profile to link everything together. </p><br><p>  The most difficult thing here is to set up the rights to sign in the App Store.  I hope you figure it out yourself.  If you are a beginner, I will point out the right direction, but here we will not talk about the intricacies of managing Apple certificates, and besides, they are constantly changing.  This post will help get down to business. </p><br><h3 id="moi-prilozheniya">  My applications </h3><br><p> You need an application in App Store Connect so that you have an ID for the <code>.xcodebuild</code> configuration.  The profile and application ID combine code builds, pricing and availability, and also TestFlight configuration for distributing test applications to users.  Do not do public testing, and private is enough if you have a small group, simple setup and no additional permissions from Apple. </p><br><h3 id="profil-inicializacii">  Initialization profile </h3><br><p>  In addition to the application setup, you need the distribution and development keys of iOS, created in the Certificates, Identifiers &amp; Profiles section in the Apple Developer console.  All these certificates can be combined into an initialization profile. </p><br><p>  Users who will be authenticated need to be able to create certificates, otherwise you will see an error in the <a href="https://docs.fastlane.tools/codesigning/getting-started/">cert and sigh</a> stages. </p><br><h3 id="drugie-varianty">  Other options </h3><br><p>  In addition to this simple method, there are other ways to configure certificates and profiles.  So, if you work differently, you may have to rebuild.  Most importantly, you will need the <code>.xcodebuild</code> configuration, which will point to the necessary files, and the keychain must be available on the build computer for the user under whose name the runner is running.  For digital signatures, we use fastlane, and if there are problems or you want to know more, study their detailed <a href="https://docs.fastlane.tools/codesigning/getting-started/">documentation on digital signatures</a> . </p><br><p>  In this example, I use the <a href="https://docs.fastlane.tools/codesigning/getting-started/">cert and sigh approach</a> , but for real use, the <a href="https://docs.fastlane.tools/codesigning/getting-started/">match is</a> probably better suited. </p><br><h2 id="podgotovka-gitlab-i-fastlane">  GitLab and fastlane preparation </h2><br><h3 id="podgotovka-ci-runner">  CI Runner Preparation </h3><br><p>  After collecting all this data, go to the GitLab runner configuration on a MacOS device.  Unfortunately, making iOS apps is real only on MacOS.  But things can change, and if you wait for progress in this area, watch for projects like <a href="https://github.com/facebook/xcbuild">xcbuild</a> and <a href="https://github.com/saucelabs/isign">isign</a> , and our internal task is <a href="https://gitlab.com/gitlab-org/gitlab-ce/issues/57576">gitlab-ce # 57576</a> . </p><br><p>  Configure a runner is very simple.  Follow the current <a href="https://docs.gitlab.com/runner/install/osx.html">instructions for setting up GitLab Runner on macOS</a> . </p><br><p>  Note.  A runner should use the <code>shell</code> executable.  It is necessary to build iOS on macOS in order to work directly as a user, and not through containers.  If you use the <code>shell</code> , the build and testing is done on behalf of the runner user, right on the build host.  This is not as safe as containers, so it‚Äôs best to scroll <a href="https://docs.gitlab.com/runner/security/">through the security documentation</a> so you don‚Äôt miss anything. </p><br><pre> <code class="plaintext hljs">sudo curl --output /usr/local/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-darwin-amd64 sudo chmod +x /usr/local/bin/gitlab-runner cd ~ gitlab-runner install gitlab-runner start</code> </pre> <br><p>  An Apple keychain must be configured on this host with access to the keys that Xcode needs to build.  The easiest way to test this is to log in as the user who will start the build and try to build manually.  If the system requests access to the keychain, select Always Allow for CI to work.  It may be worth entering and watching the first pair of pipelines, to make sure they no longer ask for a keychain.  The trouble is that Apple does not make it easier for us to work with the automatic mode, but when you adjust it, everything will be fine. </p><br><h3 id="fastlane-init">  fastlane init </h3><br><p>  To use fastlane in a project, run <code>fastlane init</code> .  Just follow the <a href="https://docs.fastlane.tools/getting-started/ios/setup/">instructions for installing and running fastlane</a> , especially in the section on <a href="https://docs.fastlane.tools/getting-started/ios/setup/">Gemfile</a> , because we need a quick and predictable launch through the automatic CI conveyor. </p><br><p>  In the project directory, run these commands: </p><br><pre> <code class="plaintext hljs">xcode-select --install sudo gem install fastlane -NV # Alternatively using Homebrew # brew cask install fastlane fastlane init</code> </pre> <br><p>  fastlane asks for a basic configuration, and then creates a fastlane folder in the project with three files: </p><br><p> <strong><code>1. fastlane/Appfile</code></strong> </p> <br><p>  There is nothing difficult.  Just check that the Apple ID and application ID are correct. </p><br><pre> <code class="plaintext hljs">app_identifier("com.vontrance.flappybird") # The bundle identifier of your app apple_id("your-email@your-domain.com") # Your Apple email address</code> </pre> <br><p> <strong><code>2. fastlane/Fastfile</code></strong> </p> <br><p>  <code>Fastfile</code> defines build steps.  We use a lot of fastlane built-in capabilities, so everything is also clear here.  We create one line that receives certificates, builds and loads it into TestFlight.  You can divide this process into different tasks, if necessary.  All of these operations ( <code>get_certificates</code> , <code>get_provisioning_profile</code> , <code>gym</code> and <code>upload_to_testflight</code> ) are already in fastlane. </p><br><p>  The actions <code>get_certificates</code> and <code>get_provisioning_profile</code> are associated with the <a href="https://docs.fastlane.tools/codesigning/getting-started/">cert and sigh</a> signing approach.  If you use <a href="https://docs.fastlane.tools/codesigning/getting-started/">match</a> or something else, make a change. </p><br><pre> <code class="plaintext hljs">default_platform(:ios) platform :ios do desc "Build the application" lane :flappybuild do get_certificates get_provisioning_profile gym upload_to_testflight end end</code> </pre> <br><p> <strong><code>3. fastlane/Gymfile</code></strong> </p> <br><p>  This is an optional file, but I created it manually to change the default output directory and place the output in the current folder.  This simplifies CI.  If interested, read about the <code>gym</code> and its parameters in the <a href="https://docs.fastlane.tools/actions/gym/">documentation</a> . </p><br><pre> <code class="plaintext hljs">https://docs.fastlane.tools/actions/gym/</code> </pre> <br><p>  Our <strong><code>.gitlab-ci.yml</code></strong> </p><br><p>  So, we have a CI-runner for the project, and we are ready to test the pipeline.  Let's see what we have in <code>.gitlab-ci.yml</code> : </p><br><pre> <code class="plaintext hljs">stages: - build variables: LC_ALL: "en_US.UTF-8" LANG: "en_US.UTF-8" GIT_STRATEGY: clone build: stage: build script: - bundle install - bundle exec fastlane flappybuild artifacts: paths: - ./FlappyBird.ipa</code> </pre> <br><p>  All perfectly!  <a href="https://docs.fastlane.tools/getting-started/ios/setup/">We set the UTF-8 format for fastlane, as required</a> , use the <code>clone</code> strategy with the <code>shell</code> executable so that we have a clean workspace for each build, and simply call <code>flappybuild</code> fastlane, as seen above.  As a result, we get the assembly, signature and deployment of the last assembly in TestFlight. </p><br><p>  We also get the artifact and save it with the assembly.  Note that the <code>.ipa</code> format is a signed ARM executable file that does not run in the simulator.  If you want output for the simulator, simply add the target of the assembly that produces it, and then turn it on in the path to the artifact. </p><br><h3 id="drugie-peremennye-sredy">  Other environment variables </h3><br><p>  There are a couple of environment variables on which everything works. </p><br><p>  <strong><code>FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD</code></strong> and <strong><code>FASTLANE_SESSION</code></strong> </p><br><p>  Authentication for the App Store and download in TestFlight need authentication for fastlane.  To do this, create a password for the application that will be used in CI.  Details <a href="https://docs.fastlane.tools/best-practices/continuous-integration/">here</a> . </p><br><p>  If you have two-factor authentication, create a variable <code>FASTLANE_SESSION</code> (instructions there). </p><br><p>  <strong><code>FASTLANE_USER</code></strong> and <strong><code>FASTLANE_PASSWORD</code></strong> </p><br><p>  In order for <a href="https://docs.fastlane.tools/codesigning/getting-started/">cert and sigh to</a> call the initialization profile and certificates upon request, you need to set the variables <code>FASTLANE_USER</code> and <code>FASTLANE_PASSWORD</code> .  Details <a href="https://docs.fastlane.tools/best-practices/continuous-integration/">here</a> .  This is not necessary if you use another signing method. </p><br><h3 id="v-zaklyuchenie">  Finally </h3><br><p>  You can see how it all works <a href="https://gitlab.com/jlenny/flappyokr">in my simple example</a> . </p><br><p>  I hope this was useful, and I inspired you to work with iOS builds in the GitLab project.  Here are some <a href="https://docs.fastlane.tools/best-practices/continuous-integration/">CI tips</a> for fastlane, just in case.  You may want to use <code>CI_BUILD_ID</code> (for incremental builds) to <a href="https://docs.fastlane.tools/best-practices/continuous-integration/gitlab/">automatically increment the version</a> . </p><br><p>  Another cool feature of fastlane is the <a href="https://docs.fastlane.tools/getting-started/ios/screenshots/">automatic screenshots</a> for the App Store, which are very easy to set up. </p><br><p>  Tell us in the comments about your experience and share ideas on how to improve GitLab for developing iOS applications. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/444170/">https://habr.com/ru/post/444170/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444144/index.html">XXH3: a new record for hashing speed</a></li>
<li><a href="../444148/index.html">BionicSoftHand - safe and flexible robotic arm with artificial intelligence from Festo</a></li>
<li><a href="../444152/index.html">Resuscitation Tester Marcus</a></li>
<li><a href="../444156/index.html">Balanced site indicators. Part 4: External Optimization</a></li>
<li><a href="../444160/index.html">[Habr]: About the "glass ceiling"</a></li>
<li><a href="../444174/index.html">GeekBrains invites beginner designers to an educational game.</a></li>
<li><a href="../444176/index.html">Basic ciphers in plain language</a></li>
<li><a href="../444178/index.html">9 tips for creating indie games from a single developer</a></li>
<li><a href="../444182/index.html">Conditions in Go and their weirdness</a></li>
<li><a href="../444184/index.html">On the prospects of pre-assembled data centers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>