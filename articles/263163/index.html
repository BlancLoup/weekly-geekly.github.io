<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We connect the backup channel of the Internet in a router with firmware dd-wrt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is unpleasant if the provider has an accident and you have internet access at home. It is doubly unpleasant, if at this moment you are far from hom...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We connect the backup channel of the Internet in a router with firmware dd-wrt</h1><div class="post__text post__text-html js-mediator-article">  It is unpleasant if the provider has an accident and you have internet access at home.  It is doubly unpleasant, if at this moment you are far from home and you need to climb on a home computer or NAS.  In my case, MGTS helped me to insure against the fall of the channel, replacing outdated copper with optics, from which I received another Internet channel, and reading various dd-wrt manuals.  If I can‚Äôt help with optics, then I‚Äôll be happy to share my ready-made solution for dd-wrt. <br><br>  The solution is not universal, but it seems to me very simple and on its basis inexperienced users can, if not create their own, then simply expand their horizons and understanding of this popular firmware. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7b5/f48/ae6/7b5f48ae6cdb483bbc266b9db5d12ae9.jpg"></div><br><a name="habracut"></a><br>  I use asus rt-n16 router and firmware from comrade.  Kong 22000 ++.  Internet from the main provider comes to me by cable, all settings are obtained by the router via dhcp.  In the dd-wrt interface, it looks something like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/cd2/dc2/e60/cd2dc2e60312407fad2fc48fd3f6a4c8.png"><br><br>  In fact, everything is the default.  The router's address on the internal network has been changed to 192.168.199.1. <br><br>  Switching channels of the Internet will be performed by a script that we will create in the internal memory of the JFFS2 router, respectively, we need to enable this internal memory.  To do this, in the Administration-Mangement section of the dd-wrt interface, enable the corresponding option: <br><br><img src="https://habrastorage.org/files/fa1/4bd/39a/fa14bd39a1254c60a78bf63861f17d03.png"><br><br>  After enabling JFFS2, the memory needs to be cleared.  To do this, select "Clean JFFS2" and click apply.  You may need to restart the router.  Our task is to ensure that a free space appears in this memory. <br><br>  Now let's log in to the router using telnet.  I use putty for this: <br><br> <code>putty -telnet 192.168.199.1</code> <br> <br>  The username is root, even if you use a different name for the login to the dd-wrt web interface.  The password is the one you use to login to the web interface. <br><br><div class="spoiler">  <b class="spoiler_title">Lyrical digression</b> <div class="spoiler_text">  The first team we enter and my result <br><pre> <code class="hljs pgsql">root@DD-WRT:~# nvram <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> &gt;/dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> size: <span class="hljs-number"><span class="hljs-number">29978</span></span> bytes (<span class="hljs-number"><span class="hljs-number">2790</span></span> left)</code> </pre><br>  As you can see, there are few free bytes in nvram and this is why we will not store our scripts there.  If this memory is exhausted, the router will reboot and restore all dd-wrt configs by default.  Therefore, it is not necessary, for example, to load openvpn certificates in the web interface, because certificates stored via the web interface will be stored in nvram variables.  Openvpn certificates can be stored in jffs2 memory and plugged in the ‚Äúadditional config‚Äù variable of openvpn settings in the following way: <br><img src="https://habrastorage.org/files/516/6aa/4fc/5166aa4fcc054b33b5720d45ba378377.png"><br></div></div><br>  Next step.  We connect the backup cable to the LAN1 port of the router.  In my case, the backup cable comes from the GPON equipment that MGTS supplied.  This equipment distributes the Internet in its local network 192.168.100.0/255.255.255.0.  We will need to ‚Äútear off‚Äù the required port of our router from the other ports and assign it an address from the GPON equipment network, for example, 192.168.100.200. <br><br>  Now the information is specific to a specific piece of hardware, namely, asus rt-n16.  We type the following commands in the terminal and see the answer: <br><pre> <code class="hljs mel">root@DD-WRT:~# nvram show | grep vlan.*port vlan2ports=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> vlan0ports=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>* vlan1ports=<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">29978</span></span> bytes (<span class="hljs-number"><span class="hljs-number">2790</span></span> left) root@DD-WRT:~# nvram show | grep vlan.*hw vlan2hwname=et0 vlan1hwname=et0 vlan0hwname=et0 <span class="hljs-keyword"><span class="hljs-keyword">size</span></span>: <span class="hljs-number"><span class="hljs-number">29978</span></span> bytes (<span class="hljs-number"><span class="hljs-number">2790</span></span> left)</code> </pre><br>  Port groups are combined into velans.  Port 0 is the WAN port of the router, ports 1234 are the ports of the router that correspond (attention!) To the LAN4, LAN3, LAN2, LAN1 ports of the router, that is, port 4 is signed on the case of the LAN1 router.  Port 8 and port 8 * are the processor ports, through them we will see the interfaces in the router.  I don‚Äôt want to go into details, it‚Äôs fundamentally that any vlan should close to the router processor.  Let's tear off the 4th port: <br><pre> <code class="hljs kotlin"><span class="hljs-symbol"><span class="hljs-symbol">root@</span></span>DD-WRT:~# nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlan0ports=<span class="hljs-string"><span class="hljs-string">"1 2 3 5*"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">root@</span></span>DD-WRT:~# nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlan1ports=<span class="hljs-string"><span class="hljs-string">"3 2 1 8*"</span></span></code> </pre><br>  and now let's assign the 4th port to the 3rd v√©lan <br><pre> <code class="hljs kotlin"><span class="hljs-symbol"><span class="hljs-symbol">root@</span></span>DD-WRT:~# nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlan3ports=<span class="hljs-string"><span class="hljs-string">"4 8"</span></span></code> </pre><br>  in order for the new vlan to be visible, you need to enter the command <br><pre> <code class="hljs perl">root@DD-WRT:~<span class="hljs-comment"><span class="hljs-comment"># nvram set vlan3hwname=et0</span></span></code> </pre><br>  save changes <br><pre> <code class="hljs perl">root@DD-WRT:~<span class="hljs-comment"><span class="hljs-comment"># nvram commit</span></span></code> </pre><br>  By analogy, you can do it for other routers with dd-wrt firmware. <br><br>  Now non-lyrical retreat.  In the ddwrt web interface, there are settings for velans.  But if you try to play with them, it‚Äôs not enough that nothing happens, but it can happen that only the reset of the router will help. <br><div class="spoiler">  <b class="spoiler_title">And now the lyrical digression</b> <div class="spoiler_text">  Probably everyone who read about the installation of dd-wrt on the router, faced with the magic ritual "30 30 30".  This is a complete reset of the router.  He is strongly recommended to do, otherwise then problems are possible.  Now I will explain to you why.  Resetting the settings in the web interface does not affect all of the nvram variables, in particular, the changes of the velans that we made can remain.  Therefore, the ritual is really needed.  But you can replace it with another command from the terminal (provided that you can still log in to the router): <br><pre> <code class="hljs ruby">root@DD-<span class="hljs-symbol"><span class="hljs-symbol">WRT:</span></span>~<span class="hljs-comment"><span class="hljs-comment"># erase nvram root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@DD</span></span></span><span class="hljs-comment">-WRT:~# reboot</span></span></code> </pre><br>  If you "played" with the vlans and everything stopped working, then the above full reset "30 30 30" can help. <br></div></div><br>  We will assign the address to our new interface, which is connected to the 4th port, from the script at the start.  Therefore, let's start writing this script.  But first, where it will be stored.  As the <s>Bokonon</s> <a href="http://www.dd-wrt.com/wiki/index.php/Script_Execution">dd-wrt wiki</a> teaches us, every script in the <code>/jffs/etc/config/</code> folder with the .startup extension runs at system startup before the firewall is configured.  Let's call our script vlan3.startup and write the following lines: <br><pre> <code class="hljs pgsql">#!/bin/sh WAN2_IFNAME=vlan3 WAN2_IPADDR=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.200</span></span> WAN2_GATEWAY=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> WAN2_NETMASK=<span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ "$(nvram get wan2_ipaddr)" != "$WAN2_IPADDR" ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_ifname=$WAN2_IFNAME nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_ipaddr=$WAN2_IPADDR nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_gateway=$WAN2_GATEWAY nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_netmask=$WAN2_NETMASK nvram <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span> fi ifconfig $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ifname) up $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ipaddr) netmask $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_netmask)</code> </pre><br>  In these lines, everything is simple.  We brought in nvram 4-D new variables and brought in them the interface name, address, mask and gateway for our backup port Internet.  Every time we start, we check that the address is exactly the one specified in the script variable, this is in case you need to change the settings of the backup Internet.  Next we configure the port with the specified values.  With current variables, it would look like this: <br> <code>ifconfig vlan3 up 192.168.100.200 netmask 255.255.255.0</code> <br> <br>  Add to our script an infinite loop, in which we will switch the Internet channel to the backup channel and back: <br><pre> <code class="hljs bash">INTERVAL=30 <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> sleep <span class="hljs-variable"><span class="hljs-variable">$INTERVAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> WAN1ALIVE=0 WAN2USING=0 WAN1GW=`nvram get wan_gateway` <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"check"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN1GW</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"1"</span></span> = `ping -c 1 <span class="hljs-variable"><span class="hljs-variable">$WAN1GW</span></span> 2&gt;/dev/null | awk <span class="hljs-string"><span class="hljs-string">'/packets received/ {print $4}'</span></span>` ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WAN1ALIVE=1 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"wan1alive"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> TARGET=`ip -4 route list 0/0 | awk -v gate=<span class="hljs-string"><span class="hljs-string">"via "</span></span><span class="hljs-variable"><span class="hljs-variable">$WAN2_GATEWAY</span></span> <span class="hljs-string"><span class="hljs-string">'$0 ~ gate {print $3}'</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ ! -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TARGET</span></span></span><span class="hljs-string">"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> WAN2USING=1 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"wan2using"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN1ALIVE</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ] &amp;&amp; [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN2USING</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> /jffs/etc/config/wan1.up <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Changed active WAN port to 1!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN1ALIVE</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"0"</span></span> ] &amp;&amp; [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN2USING</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"0"</span></span> ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"1"</span></span> = `ping -c 1 <span class="hljs-variable"><span class="hljs-variable">$WAN2_GATEWAY</span></span> 2&gt;/dev/null | awk <span class="hljs-string"><span class="hljs-string">'/packets received/ {print $4}'</span></span>` ]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> /jffs/etc/config/wan2.up <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Changed active WAN port to 2!"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>;</code> </pre><br>  This long piece of code can be described in words as follows.  Every n seconds we check: <br><ol><li>  The current gateway address of the main channel.  It is stored in the wan_gateway variable in the nvram and is automatically assigned when the main gateway receives the dhcp settings from the main provider.  If this address is not equal to ‚Äú0.0.0.0‚Äù, and ‚Äú0.0.0.0‚Äù it is equal when the address cannot be obtained, that is, the provider is lying, we ping it and in the case of a response set the WAN1ALIVE flag to one, that is, the main channel supposed to work. </li><li>  Whether the address of the backup gateway is in the routing table.  If present, then set the flag WAN2USING = 1, that is, at the moment the backup Internet channel is used. </li><li>  If the main channel works and the backup channel is used, then switch to the main channel Internet. </li><li>  If the main channel does not work and the backup channel is not used, then we test the availability of the backup channel gateway and switch to the working reserve. </li></ol><br><br>  The script include the main channel wan1.up: <br><pre> <code class="hljs kotlin">#!/bin/sh # WAN1 DEV=vlan2 GATEWAY=`nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan_gateway` DNS1=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.8.8 DNS2=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.4.4 nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan_dns=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ip route del <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> :; done ip route add <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> via $GATEWAY dev $DEV echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string">"</span></span> &gt;/tmp/resolv.dnsmasq echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> &gt;&gt;/tmp/resolv.dnsmasq pr=<span class="hljs-string"><span class="hljs-string">"$(ps|awk '/dnsmasq/ {print $1}')"</span></span> kill -<span class="hljs-number"><span class="hljs-number">9</span></span> $pr dnsmasq --conf-file=/tmp/dnsmasq.conf</code> </pre><br>  Everything is simple here.  Removed all default gateways.  Yes, there may be several of them: if after restarting the router the main channel was unavailable, then the backup Internet is turned on and we have one default gateway.  If the main channel then starts working, dd-wrt adds another default gateway.  There's nothing to be done.  I didn‚Äôt want to think long and a dirty hack appeared: <code>while ip route del default; do :; done</code> <code>while ip route del default; do :; done</code>  <code>while ip route del default; do :; done</code> , namely, to delete all the default gateways until an error occurs due to the fact that there are no more gateways.  Ugly, think how best. <br><br>  After all the default gateways have been deleted, we will add a new gateway, which is recorded in the variable wan_gateway nvram (the dd-wrt logic recorded it when receiving parameters from the main provider).  Replace dns with dns google, kill the <a href="https://ru.wikipedia.org/wiki/Dnsmasq">dnsmasq</a> process and run this process again. <br><br>  The script to enable the backup channel wan2.up is arranged in the same way, but the gateway address is taken from the variable wan2_gateway nvram and the interface associated with the 4th port of the router is used. <br><br><pre> <code class="hljs kotlin">#!/bin/sh # WAN2 DEV=vlan3 GATEWAY=`nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_gateway` DNS1=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.8.8 DNS2=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.4.4 nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan_dns=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ip route del <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> :; done ip route add <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> via $GATEWAY dev $DEV echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string">"</span></span> &gt;/tmp/resolv.dnsmasq echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> &gt;&gt;/tmp/resolv.dnsmasq pr=<span class="hljs-string"><span class="hljs-string">"$(ps|awk '/dnsmasq/ {print $1}')"</span></span> kill -<span class="hljs-number"><span class="hljs-number">9</span></span> $pr dnsmasq --conf-file=/tmp/dnsmasq.conf</code> </pre><br>  There is a small script vlan3.wanup, which runs after the WAN has been raised, immediately after the firewall turns on: <br><br><pre> <code class="hljs vbscript">#!/bin/sh iptables -t nat -A POSTROUTING -o $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ifname) -j SNAT --<span class="hljs-keyword"><span class="hljs-keyword">to</span></span> $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ipaddr)</code> </pre><br>  The purpose of the script is to add a rule for Nata through the backup interface. <br><br>  Now you can reboot the router and test.  All scripts were taken from my router that lives its own life and tests the resulting configuration for a long time. <br><br><div class="spoiler">  <b class="spoiler_title">Generalized script</b> <div class="spoiler_text">  We insert the following sheet into the telnet \ ssh window and press "Enter": <br><pre> <code class="hljs kotlin">nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlan0ports=<span class="hljs-string"><span class="hljs-string">"1 2 3 5*"</span></span> nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlan1ports=<span class="hljs-string"><span class="hljs-string">"3 2 1 8*"</span></span> nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlan3ports=<span class="hljs-string"><span class="hljs-string">"4 8"</span></span> nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vlan3hwname=et0 nvram commit mkdir -p /jffs/etc/config cat &lt;&lt; <span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt; /jffs/etc/config/vlan3.startup #!/bin/sh WAN2_IFNAME=vlan3 WAN2_IPADDR=<span class="hljs-number"><span class="hljs-number">192.168</span></span>.100.200 WAN2_GATEWAY=<span class="hljs-number"><span class="hljs-number">192.168</span></span>.100.1 WAN2_NETMASK=<span class="hljs-number"><span class="hljs-number">255.255</span></span>.255.0 <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"$(nvram get wan2_ipaddr)"</span></span> != <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN2_IPADDR</span></span></span><span class="hljs-string">"</span></span> ]; then nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_ifname=$WAN2_IFNAME nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_ipaddr=$WAN2_IPADDR nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_gateway=$WAN2_GATEWAY nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan2_netmask=$WAN2_NETMASK nvram commit fi ifconfig $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ifname) up $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ipaddr) netmask $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_netmask) INTERVAL=<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> sleep $INTERVAL <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> WAN1ALIVE=<span class="hljs-number"><span class="hljs-number">0</span></span> WAN2USING=<span class="hljs-number"><span class="hljs-number">0</span></span> WAN1GW=`nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan_gateway` echo <span class="hljs-string"><span class="hljs-string">"check"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN1GW</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span> ]; then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"1"</span></span> = `ping -c <span class="hljs-number"><span class="hljs-number">1</span></span> $WAN1GW <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;/dev/<span class="hljs-literal"><span class="hljs-literal">null</span></span> | awk <span class="hljs-string"><span class="hljs-string">'/packets received/ {print $4}'</span></span>` ]; then WAN1ALIVE=<span class="hljs-number"><span class="hljs-number">1</span></span> echo <span class="hljs-string"><span class="hljs-string">"wan1alive"</span></span> fi fi TARGET=`ip -<span class="hljs-number"><span class="hljs-number">4</span></span> route list <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> | awk -v gate=<span class="hljs-string"><span class="hljs-string">"via "</span></span>$WAN2_GATEWAY <span class="hljs-string"><span class="hljs-string">'$0 ~ gate {print $3}'</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ ! -z <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TARGET</span></span></span><span class="hljs-string">"</span></span> ]; then WAN2USING=<span class="hljs-number"><span class="hljs-number">1</span></span> echo <span class="hljs-string"><span class="hljs-string">"wan2using"</span></span> fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN1ALIVE</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ] &amp;&amp; [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN2USING</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span> ]; then /jffs/etc/config/wan1.up echo <span class="hljs-string"><span class="hljs-string">"Changed active WAN port to 1!"</span></span> fi <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN1ALIVE</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"0"</span></span> ] &amp;&amp; [ <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$WAN2USING</span></span></span><span class="hljs-string">"</span></span> = <span class="hljs-string"><span class="hljs-string">"0"</span></span> ]; then <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ <span class="hljs-string"><span class="hljs-string">"1"</span></span> = `ping -c <span class="hljs-number"><span class="hljs-number">1</span></span> $WAN2_GATEWAY <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;/dev/<span class="hljs-literal"><span class="hljs-literal">null</span></span> | awk <span class="hljs-string"><span class="hljs-string">'/packets received/ {print $4}'</span></span>` ]; then /jffs/etc/config/wan2.up echo <span class="hljs-string"><span class="hljs-string">"Changed active WAN port to 2!"</span></span> fi fi done; EOF chmod +x /jffs/etc/config/vlan3.startup cat &lt;&lt; <span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt; /jffs/etc/config/vlan3.wanup #!/bin/sh iptables -t nat -A POSTROUTING -o $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ifname) -j SNAT --to $(nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_ipaddr) EOF chmod +x /jffs/etc/config/vlan3.wanup cat &lt;&lt; <span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt; /jffs/etc/config/wan1.up #!/bin/sh # WAN1 DEV=vlan2 GATEWAY=`nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan_gateway` DNS1=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.8.8 DNS2=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.4.4 nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan_dns=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> #`ip -<span class="hljs-number"><span class="hljs-number">4</span></span> route list <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> | awk <span class="hljs-string"><span class="hljs-string">'/default via/ {print "ip route delete default"}'</span></span>` | sh # ip route delete <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ip route del <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> :; done ip route add <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> via $GATEWAY dev $DEV echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string">"</span></span> &gt;/tmp/resolv.dnsmasq echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> &gt;&gt;/tmp/resolv.dnsmasq pr=<span class="hljs-string"><span class="hljs-string">"$(ps|awk '/dnsmasq/ {print $1}')"</span></span> kill -<span class="hljs-number"><span class="hljs-number">9</span></span> $pr dnsmasq --conf-file=/tmp/dnsmasq.conf EOF chmod +x vi /jffs/etc/config/wan1.up cat &lt;&lt; <span class="hljs-string"><span class="hljs-string">'EOF'</span></span> &gt; /jffs/etc/config/wan2.up #!/bin/sh # WAN2 DEV=vlan3 GATEWAY=`nvram <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> wan2_gateway` DNS1=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.8.8 DNS2=<span class="hljs-number"><span class="hljs-number">8.8</span></span>.4.4 nvram <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wan_dns=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> #`ip -<span class="hljs-number"><span class="hljs-number">4</span></span> route list <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> | awk <span class="hljs-string"><span class="hljs-string">'/default via/ {print "ip route delete default"}'</span></span>`|sh # ip route delete <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ip route del <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> :; done ip route add <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> via $GATEWAY dev $DEV echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS1</span></span></span><span class="hljs-string">"</span></span> &gt;/tmp/resolv.dnsmasq echo <span class="hljs-string"><span class="hljs-string">"nameserver </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DNS2</span></span></span><span class="hljs-string">"</span></span> &gt;&gt;/tmp/resolv.dnsmasq pr=<span class="hljs-string"><span class="hljs-string">"$(ps|awk '/dnsmasq/ {print $1}')"</span></span> kill -<span class="hljs-number"><span class="hljs-number">9</span></span> $pr dnsmasq --conf-file=/tmp/dnsmasq.conf EOF chmod +x /jffs/etc/config/wan2.up</code> </pre><br></div></div><br><br>  Of course, one can and should be corrected \ add much, but my goal, namely to quickly fasten the backup channel at home, has been completed.  The main trouble is the firewall and port forwarding when working with the backup channel, I did not need them, so I did not configure.  For those who need to - supplement the vlan3.wanup script.  Good luck in your sequels! <br><br>  Article ideas were gleaned from the <a href="http://www.dd-wrt.com/wiki/index.php/Dual_WAN_with_failover">dd-wrt wiki</a> . </div><p>Source: <a href="https://habr.com/ru/post/263163/">https://habr.com/ru/post/263163/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263153/index.html">Together with Visual Studio 2015 release TypeScript 1.5</a></li>
<li><a href="../263155/index.html">Interactive audiobook concept</a></li>
<li><a href="../263157/index.html">How to conduct Testing Dojo</a></li>
<li><a href="../263159/index.html">A new look at MindMap in testing</a></li>
<li><a href="../263161/index.html">Universal Analytics Magic</a></li>
<li><a href="../263165/index.html">Budget Failover Solution for Remote Offices for Microsoft UC</a></li>
<li><a href="../263167/index.html">OData REST API - minor tricks (part 2)</a></li>
<li><a href="../263169/index.html">12 little-known facts about CSS</a></li>
<li><a href="../263171/index.html">Automatic textual key detection (Sentiment Analysis)</a></li>
<li><a href="../263175/index.html">Magic Ctrl-C Ctrl-V, or how to stop saving pictures and start living</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>