<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simulate the night vision of a person in a 3D game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will deal with postprocessing images in DirectX. 

 As you know, in the dark human vision is provided by retinal wand cells, high light sensi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simulate the night vision of a person in a 3D game</h1><div class="post__text post__text-html js-mediator-article">  Today we will deal with postprocessing images in DirectX. <br><br>  As you know, in the dark human vision is provided by retinal wand cells, high light sensitivity of which is achieved due to loss of color sensitivity and visual acuity (although the rods in the retina are larger, they are distributed over a much larger area, so the total ‚Äúresolution‚Äù is less). <br><br>  All these effects can be seen most, looking up from the computer and going out at night on the street. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, we get something like the following ( <em>look at the whole screen!</em> ): <br><br>  <em>Before: dull Polish shooter</em> <br> <a href=""><img src="http://ajenti.org/me/wp-content/uploads/2013/01/SS-before.png"></a> <br><br>  <em>After: IGF Finalist and E3 Laureate</em> <br> <a href=""><img src="http://ajenti.org/me/wp-content/uploads/2013/01/SS-After.png"></a> <br><a name="habracut"></a><br><br><h1>  Training </h1><br>  The first thing you need to decide what effect we want to achieve.  I broke all the processing into the following parts: <br><ul><li>  Loss of color in low-light areas </li><li>  Loss of clarity in the same place </li><li>  Slight noise (ibid) </li><li>  Loss of vision at long range in medium and low light </li></ul><br><h1>  Implementation </h1><br>  We will write under Unity3D Pro, in the form of a shader for post-processing. <br><br>  Before proceeding directly to the shader, we will write a small script that runs the screen buffer through this shader: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; [ExecuteInEditMode] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HumanEye</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Shader Shader; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> LuminanceThreshold; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Texture Noise; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> NoiseAmount = <span class="hljs-number"><span class="hljs-number">0.5f</span></span>, NoiseScale = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Camera mainCam; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Material material; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PASS_MAIN = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { mainCam = camera; mainCam.depthTextureMode |= DepthTextureMode.DepthNormals; material = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Material (Shader); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnRenderImage</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RenderTexture source, RenderTexture destination</span></span></span><span class="hljs-function">)</span></span> { material.SetFloat(<span class="hljs-string"><span class="hljs-string">"_LuminanceThreshold"</span></span>, LuminanceThreshold); material.SetFloat (<span class="hljs-string"><span class="hljs-string">"_BlurDistance"</span></span>, <span class="hljs-number"><span class="hljs-number">0.01f</span></span>); material.SetFloat (<span class="hljs-string"><span class="hljs-string">"_CamDepth"</span></span>, mainCam.far); material.SetTexture (<span class="hljs-string"><span class="hljs-string">"_NoiseTex"</span></span>, Noise); material.SetFloat (<span class="hljs-string"><span class="hljs-string">"_Noise"</span></span>, NoiseAmount); material.SetFloat (<span class="hljs-string"><span class="hljs-string">"_NoiseScale"</span></span>, NoiseScale); material.SetVector(<span class="hljs-string"><span class="hljs-string">"_Randomness"</span></span>, Random.insideUnitSphere); Graphics.Blit (source, destination, material, PASS_MAIN); } }</code> </pre> <br>  Here we just set the shader parameters to the user-defined ones and re-render the screen buffer through our shader. <br><br>  Now let's deal directly with the case. <br><br>  Variable and constant declarations: <br><pre> <code class="cpp hljs">sampler2D _CameraDepthNormalsTexture; float4 _CameraDepthNormalsTexture_ST; sampler2D _MainTex; float4 _MainTex_ST; sampler2D _NoiseTex; float4 _NoiseTex_ST; float4 _Randomness; uniform <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> _BlurDistance, _LuminanceThreshold, _CamDepth, _Noise, _NoiseScale; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEPTH_BLUR_START 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAR_BLUR_START 40 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAR_BLUR_LENGTH 20</span></span></code> </pre> <br><br>  The vertex shader is standard and does not perform any unusual transformations.  The most interesting begins in a pixel shader. <br><br>  First, select the value of the current pixel, and in addition to it - the ‚Äúblurred‚Äù value for the same pixel: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">v2f</span></span></span><span class="hljs-class"> {</span></span> float4 pos : POSITION; float2 uv : TEXCOORD0; float2 uv_depth : TEXCOORD1; }; <span class="hljs-function"><span class="hljs-function">half4 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main_frag</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(v2f i)</span></span></span><span class="hljs-function"> : COLOR </span></span>{ half4 cColor = tex2D(_MainTex, i.uv); half4 cBlurred = blur(_MainTex, i.uv, _BlurDistance);</code> </pre> <br><br>  Obtaining a ‚Äúblurred‚Äù value is performed by the function blur (), which samples a few pixels next to ours and averages their values: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> half4 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">blur</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sampler2D tex, float2 uv, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dist)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BLUR_SAMPLE_COUNT 16 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     float-! const float3 RAND_SAMPLES[16] = { float3(0.2196607,0.9032637,0.2254677), ....  14  .... float3(0.2448421,-0.1610962,0.1289366), }; half4 result = 0; for (int s = 0; s &lt; BLUR_SAMPLE_COUNT; ++s) result += tex2D(tex, uv + RAND_SAMPLES[s].xy * dist); result /= BLUR_SAMPLE_COUNT; return result; }</span></span></span></span></code> </pre> <br><br>  The pixel darkness coefficient will be determined by the average brightness value for three channels.  The coefficient is cut off by a given brightness limit value (LuminanceThreshold), i.e.  all pixels brighter than this are considered ‚Äúbright enough‚Äù to not process them. <br><br><pre> <code class="cpp hljs">half kLum = (cColor.r + cColor.g + cColor.b) / <span class="hljs-number"><span class="hljs-number">3</span></span>; kLum = <span class="hljs-number"><span class="hljs-number">1</span></span> - clamp(kLum / _LuminanceThreshold, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><br>  The dependence of kLum on brightness will look like this: <br><br><img src="https://habrastorage.org/storage2/0dd/889/d18/0dd889d186d36147e914e20357691b28.png"><br><br>  The kLum values ‚Äã‚Äãfor our scene look like this (white - 1, black - 0): <br><br><img src="https://habrastorage.org/storage2/54d/802/fbf/54d802fbf699deb7e389100a00e358c7.png"><br><br>  It is clearly seen here that bright areas (halo of lanterns and lighted grass) have a kLum equal to zero and our effect will not apply to them. <br><br>  The distance from the screen surface to the pixel in meters can be obtained from the <em>depth texture</em> (depth texture, Z-buffer), which is clearly available for deferred rendering. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> depth; float3 normal; DecodeDepthNormal(tex2D(_CameraDepthNormalsTexture, i.uv_depth), depth, normal); depth *= _CamDepth; <span class="hljs-comment"><span class="hljs-comment">// depth in meters</span></span></code> </pre> <br><br>  The kDepth coefficient will determine the degree of blurring of dark objects near, and kFarBlur - all others far away: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEPTH_BLUR_START 3 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAR_BLUR_START 40 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FAR_BLUR_LENGTH 20 half kDepth = clamp(depth - DEPTH_BLUR_START, 0, 1); half kFarBlur = clamp((depth - FAR_BLUR_START) / FAR_BLUR_LENGTH, 0, 1);</span></span></code> </pre> <br><br>  The plots of both coefficients from the distance look the same and differ only in scale: <br><br><img src="https://habrastorage.org/storage2/ffc/f73/874/ffcf7387426333ae221b6fac884f630f.png"><br>  KFarBlur values: <br><br><img src="https://habrastorage.org/storage2/a70/309/144/a703091444e170e488d5cc68d4e886f0.png"><br><br>  And now - magic!  We calculate the total pixel blur ratio, based on the previous three: <br><br><pre> <code class="cpp hljs">half kBlur = clamp(kLum * kDepth + kFarBlur, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><br>  Dark pixels will be blurred from a distance of several meters (DEPTH_BLUR_START), and distant objects will be irrespective of the light intensity. <br><br><img src="https://habrastorage.org/storage2/8d9/ea9/db8/8d9ea9db857e10528e49ab95c1a51318.png"><br><br>  The degree of color loss we will have is the degree of ‚Äúunlit‚Äù (half kDesaturate = kLum). <br><br>  It now remains to mix the normal, blurred and black and white pixel and calculate the final color: <br><pre> <code class="cpp hljs">half kDesaturate = kLum; half4 result = cColor; result = (<span class="hljs-number"><span class="hljs-number">1</span></span> - kBlur) * result + kBlur * cBlurred; half resultValue = result; result = (<span class="hljs-number"><span class="hljs-number">1</span></span> - kDesaturate) * result + kDesaturate * resultValue; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;</code> </pre> <br><br><img src="https://habrastorage.org/storage2/7b1/01b/4b2/7b101b4b2f7dc779bee04f090eb21852.png"><br><br>  However, if you look at the picture in dynamics, it is clear that something is missing.  What?  Noises! <br><br><pre> <code class="cpp hljs">half noiseValue = tex2D(_NoiseTex, i.uv * _NoiseScale + _Randomness.xy); half kNoise = kLum * _Noise;</code> </pre> <br><br>  Here we select a random variable from the _NoiseTex texture (filled with Gaussian noise from Photoshop), using the _Randomness vector provided by the script, which will change on each frame. <br><br>  We mix the random value into our pixel: <br><br><pre> <code class="cpp hljs">result *= (<span class="hljs-number"><span class="hljs-number">1</span></span> - kNoise + noiseValue * kNoise);</code> </pre> <br><br>  As a bonus - a small video and <a href="https://gist.github.com/4517834">the shader itself</a> : <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/4G2E8Ea3Rks%3Ffeature%3Doembed&amp;xid=25657,15700021,15700186,15700191,15700253,15700256&amp;usg=ALkJrhiwoJgcfgz2K8NmtcPC6eexEWYsPg" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>Update</b> : correct, human lens flares: <br> <a href=""><img src="http://ajenti.org/me/wp-content/uploads/2013/01/full.png" alt="full" width="1892" height="897"></a> </div><p>Source: <a href="https://habr.com/ru/post/165563/">https://habr.com/ru/post/165563/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165547/index.html">The principle of "anchor" in the game balance</a></li>
<li><a href="../165549/index.html">Take care of your sight, use f.lux</a></li>
<li><a href="../165551/index.html">For a scrap of colored tape</a></li>
<li><a href="../165553/index.html">Magic Panel - jQuery plugin for fast page scrolling</a></li>
<li><a href="../165559/index.html">We play in Haskell</a></li>
<li><a href="../165565/index.html">Knockoutjs Grow a tree</a></li>
<li><a href="../165567/index.html">OpenVPN 2.3 released</a></li>
<li><a href="../165569/index.html">Yota site was hacked</a></li>
<li><a href="../165571/index.html">Timothy Farris - How to work 4 hours a week</a></li>
<li><a href="../165575/index.html">Downloading GNU / Linux without a third-party bootloader</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>