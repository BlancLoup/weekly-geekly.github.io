<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BFQ I / O scheduler better</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In addition to the atomic KMS operations, another useful innovation was recently introduced to users of the Linux workstation - the BFQ (Budget Fair Q...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BFQ I / O scheduler better</h1><div class="post__text post__text-html js-mediator-article"><p>  In addition to the <a href="https://habrahabr.ru/post/336630/">atomic KMS operations,</a> another <strong>useful innovation was</strong> recently introduced to users of the Linux workstation - the <em>BFQ</em> (Budget Fair Queue) input and output subsystem scheduler.  It is an improvement of the default CFQ (Completely Fair Queue), <a href="http://kerneltrap.org/Linux/Budget_Fair_Queuing_IO_Scheduler">debuted</a> as much as 9 years ago, but only in version 4.12 it hit the mainline. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/76f/711/e6d/76f711e6de2c4acb8bd3ccf11b117e02.png"></div><br><p>  Before talking about how the scheduler works, check out the Paolo Valente developer <a href="https://www.youtube.com/watch%3Fv%3DZeNbS0rzpoY">demo</a> , this will give you the motivation to continue.  The screen shot shows the start of the player with 10 background tasks to read the file from the disk for two schedulers: CFQ and <em>BFQ</em> .  Guess which one of them did not start with such a load? </p><a name="habracut"></a><br><p>  Now briefly about the algorithm.  Just as in CFQ, synchronous requests are grouped in queues by task, and asynchronous - by device.  Then <em>BFQ</em> for new tasks is transformed by a simple Round Robin scheduler, based on timestamps, so that the algorithm takes as its basis the budgets, in which the disk sectors serve as a measure.  Depending on the nature and behavior of the task, the budget may vary, and the <em>BFQ</em> ensures that the flow of disk data will be adequately distributed between tasks. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/96e/0c4/5f5/96e0c45f5acd40eb8b1ab06df79d1472.png"></div><br><p> <em>BFQ</em> at any given time only works with one task.  When the device driver is ready to serve the next task, the algorithm requests from the queue the first <code>C-LOOK</code> in the order specified and sends it to the driver for execution. </p><br><h2 id="byudzhetnaya-politika-planirovschika">  Budget Policy Planner </h2><br><p>  Let's take a closer look at specific aspects of the algorithm in pseudocode.  The <code>add_request</code> function <code>add_request</code> new request R to the queue, and if no other requests are received, then that's it. </p><br><pre> <code class="hljs perl">active_appl = none ; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>     remaining_budget = <span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    //:  ,    add_request(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i, request R) { appl = applications[i] ; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   i //     R; enqueue(R, appl.queue) ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (appl.queue.size == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (appl != active_appl) b-wf2q+_insert(appl) ; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(waiting_for_next_re<span class="hljs-string"><span class="hljs-string">q()</span></span>) //  unset_timer() ; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   } }</code> </pre> <br><p>  <em>Logic Scheduler</em> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/web/08f/717/f92/08f717f92c6040b9b2bc061794f53c22.png"></div><br><p>  In the diagram, arrows indicate the path from the request to the disk device, and ellipses indicate the algorithms and operations. </p><br><p>  The <code>dispatch</code> function returns the value <code>no request</code> if all applications are idle, or the active application waits for the next request.  On the other hand, the application is deduced from the list if it does not have time to fulfill the request in the budget allocated to it.  Calling the function <code>b‚àíwf2q+update_vfintime</code> updates the application timestamps so that only the useful time during which requests are processed is taken into account.  The fact that the application failed to reset the request queue means that the batch of requests exceeded the allocated budget.  Therefore, the budget <strong>should be increased</strong> by a given amount, which does not exceed a certain threshold level B <sub>i, max</sub> . </p><br><div class="spoiler">  <b class="spoiler_title">Manager Function Code</b> <div class="spoiler_text"><pre> <code class="hljs perl">request dispatch() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (all_applic_are_idle() OR waiting_for_next_re<span class="hljs-string"><span class="hljs-string">q()</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> no_request ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(active_appl ! = none AND remaining budget &lt; C‚àíLOOK <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> re<span class="hljs-string"><span class="hljs-string">q (active_appl.queue)</span></span>.size ) { b‚àíwf2q+update_vfintime(active_appl, active_appl.budget ‚àí remaining_budget); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(active_appl.budget + BUDG_INC_STEP &lt;= active_appl. max_budget) active_appl.budget += BUDG INC STEP ; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> active_appl.budget = active_appl.max budget ; b‚àíwf2q+ insert(active_appl) ; active_appl = none ; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (active_appl == none ) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>       b-wf2q+ active_appl = b‚àíwf2q+ get_next_application() ; remaining budget = active_appl.budget ; } //          next_request = dequeue_next_re<span class="hljs-string"><span class="hljs-string">q(active_appl.queue)</span></span> ; remaining budget ‚àí= next_request.size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(is empty (active_appl.queue)) set_timer(T_wait) ; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    //   b-wf2q+ b-wf2q+_inc_tot_service(next_request.size) ; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next_request ;</code> </pre> </div></div><br><p>  Next, the application with the new budget falls into the B-WF <sup>2</sup> Q + scheduler.  If now there are no active applications left from the B-WF <sup>2</sup> Q + scheduler queue, the following is taken and everything is new - for the active application, the next request R is taken from a string of similar ones and a budget is assigned to it. </p><br><p>  Finally, the active application has been exhausted.  The new timer is set equal to the current time + T <sub>wait</sub> , in the case of the absence of new requests, the <code>timer_expiration</code> function <code>timer_expiration</code> .  The application is declared idle and the new one gets the same budget as the previous one. </p><br><pre> <code class="hljs swift">timer_expiration() active_appl.budget = active_appl.budget ‚àí remaining_budget ; b-wf2q+_update_vfintime(active_appl, active_appl.budget); active_appl = <span class="hljs-keyword"><span class="hljs-keyword">none</span></span> ; <span class="hljs-comment"><span class="hljs-comment">//   , //dispatch()   .</span></span></code> </pre> <br><p>  It is worth mentioning the internal algorithms: C-LOOK B-WF <sup>2</sup> Q +. </p><br><ul><li>  C-LOOK (Circular LOOK) is a disk scheduler in which the disk head moves from one end to the other, serving incoming requests.  Then, after the last request, reverses the direction, <em>not reaching the finish</em> , unlike the C-SCAN algorithm. </li><li>  B-WF <sup>2</sup> Q + adapted for block devices variant of the packet scheduler WF <sup>2</sup> Q +.  The <em>Weighted Fair Queue</em> algorithm allows you to assign each thread its own priority, or weight, in proportion to which a part of the channel is allocated. </li></ul><br><h3 id="tak-v-chem-zhe-delo">  So what's the deal? </h3><br><p>  Here you should place a picture of Boromir, who with irritation tries to say that you can‚Äôt just take and add the scheduler to the main branch of the Linux kernel.  In addition to code licked to mirror shine, patience and advanced social communication skills are needed here.  There are no tangible reasons because of which it was necessary to marinate <em>BFQ</em> for so long and it remains only to applaud the unrelenting perseverance of its author.  The official reason for the refusal to accept the new best scheduler was the lack of support for the new <em>multiqueue API</em> , since <em>BFQ</em> was able only to the previous block device API.  Fortunately, Jens Axboe, the main maintainer of the <em>multiqueue API</em> , came to the rescue, and together they managed to achieve the desired result. </p><br><p>  <em>Starting the gnome-terminal application on Hitachi HDD (less is better)</em> . </p><br><img src="https://habrastorage.org/web/4eb/0cf/dc0/4eb0cfdc0277440d961d0de0503d4aaa.png"><br><p><br></p><br><p>  At the moment, users of these distributions can safely watch movies while copying a file from a USB flash drive, unpacking a large archive and other I / O-demanding operations.  In them, the <em>BFQ</em> scheduler is used <strong>by default</strong> . </p><br><ul><li>  Manjaro </li><li>  Mageia </li><li>  OpenMandriva </li><li>  Sabayon </li><li>  Arch Linux ARM </li><li>  Rosa </li></ul><br><p>  <em>Performance on Hitachi HDD (more is better)</em> . </p><br><img src="https://habrastorage.org/web/fb6/04a/e10/fb604ae10e2d4837ac2809c6701e8a95.png"><br><p><br></p><br><p>  Optionally, the <em>BFQ</em> scheduler is available at: </p><br><ul><li>  Arch </li><li>  openSUSE </li><li>  PCLinuxOS </li><li>  Gentoo </li></ul><br><p>  It takes a <a href="https://unix.stackexchange.com/questions/375600/how-to-enable-and-use-the-bfq-scheduler">few simple steps</a> .  First, change the GRUB bootloader line so that it looks like this: </p><br><pre> <code class="hljs objectivec">GRUB_CMDLINE_LINUX=<span class="hljs-string"><span class="hljs-string">"scsi_mod.use_blk_mq=1"</span></span></code> </pre> <br><p>  Then after the reboot, check the availability of the required scheduler. </p><br><pre> <code class="hljs ruby">(<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">500</span></span>)$ sudo cat /sys/block/sda/queue/scheduler noop bfq deadline [cfq]</code> </pre> <br><p>  Change the default scheduler. </p><br><pre> <code class="hljs ruby">(<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">501</span></span>)$ sudo echo bfq &gt; <span class="hljs-regexp"><span class="hljs-regexp">/sys/block</span></span><span class="hljs-regexp"><span class="hljs-regexp">/sda/queue</span></span><span class="hljs-regexp"><span class="hljs-regexp">/scheduler</span></span></code> </pre> <br><p>  You can do this more thoroughly by applying the <code>udev</code> rule by writing the file <code>/path/to/rules.d/60-scheduler.rules</code> . </p><br><pre> <code class="hljs cpp">ACTION==<span class="hljs-string"><span class="hljs-string">"add|change"</span></span>, KERNEL==<span class="hljs-string"><span class="hljs-string">"sd[az]"</span></span>, ATTR{<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>/scheduler}=<span class="hljs-string"><span class="hljs-string">"bfq"</span></span></code> </pre> <br><h3 id="materialy-po-teme">  Materials on the topic </h3><br><ul><li>  <a href="https://lwn.net/Articles/653071/">A way forward for BFQ</a> </li><li>  <a href="http://algo.ing.unimo.it/people/paolo/disk_sched/">Budget Fair Queueing (BFQ) Storage-I / O Scheduler</a> </li><li>  <a href="https://goo.gl/cLPZdy">High Throughput Disk Scheduling with Fair Bandwidth Distribution</a> </li><li>  <a href="http://www.phoronix.com/scan.php%3Fpage%3Dnews_item%26px%3DLinux-4.12-Kernel-Exciting">Linux 4.12 Kernel</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/337102/">https://habr.com/ru/post/337102/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337092/index.html">Artificial intelligence will save from ransomware</a></li>
<li><a href="../337094/index.html">4 ICO IT startups in September: sale of excess communications, parallel Internet and awards to open-source developers</a></li>
<li><a href="../337096/index.html">Sending an e-mail message in the 3CX Call Flow Designer development environment</a></li>
<li><a href="../337098/index.html">Creator of Node.js: ‚ÄúFor servers, I can‚Äôt imagine another language other than Go‚Äù</a></li>
<li><a href="../337100/index.html">Be careful with what you measure - MJIT vs TruffleRuby: 2.1 times slower or 4.2 times faster</a></li>
<li><a href="../337106/index.html">Meeting in St. Petersburg "The role of the analyst in making important product decisions"</a></li>
<li><a href="../337108/index.html">Test asynchronous code with PyTest (translation)</a></li>
<li><a href="../337110/index.html">Getting rid of the RecyclerView.Adapter routine with DataBinding</a></li>
<li><a href="../337112/index.html">We broadcast WebRTC, RTSP and RTMP streams to Media Source Extensions via Websocket protocol</a></li>
<li><a href="../337114/index.html">We embed WebRTC player for live broadcasts from webcams and IP cameras</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>