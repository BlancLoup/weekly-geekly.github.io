<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FSE coding</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Finite State Entropy (FSE) is an entropy coding algorithm, somewhat similar to both the Huffman algorithm and arithmetic coding . At the same time, he...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FSE coding</h1><div class="post__text post__text-html js-mediator-article">  <b>Finite State Entropy</b> (FSE) is an <a href="https://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BD%25D1%2582%25D1%2580%25D0%25BE%25D0%25BF%25D0%25B8%25D0%25B9%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BA%25D0%25BE%25D0%25B4%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">entropy coding</a> algorithm, somewhat similar to both <a href="https://habrahabr.ru/post/144200/">the Huffman algorithm</a> and <a href="https://habrahabr.ru/post/130531/">arithmetic coding</a> .  At the same time, he took the best of both of them: it works as fast as a Huffman one, and with a compression ratio like that of arithmetic coding. <br><br>  FSE belongs to the ANS ( <a href="https://en.wikipedia.org/wiki/Asymmetric_Numeral_Systems">Asymmetric Numeral Systems</a> ) codec family, invented by <a href="">Yarek Duda</a> .  Based on his research, <a href="https://github.com/Cyan4973">Ian Collett</a> developed an optimized version of the algorithm, later called FSE. <br><br>  Ian Colett‚Äôs <a href="http://fastcompression.blogspot.ru/2014/01/fse-decoding-how-it-works.html">notes</a> are not easy to understand, so I‚Äôll present an explanation in a slightly different order, more easy to understand, in my opinion. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <a href="https://habrahabr.ru/company/playrix/blog/324116/"><img src="https://habrastorage.org/getpro/habr/post_images/cf4/ca6/008/cf4ca6008e7097320a48f37be6a64335.png"></a> <br><a name="habracut"></a><br><h2>  Comparison with existing algorithms </h2><br>  Recall how <a href="https://habrahabr.ru/post/144200/">the Huffman algorithm</a> works. <br><br>  Suppose we have a certain message consisting of characters in the following proportions: <br><blockquote>  <b>A</b> : 50%;  <b>B</b> : 25%;  <b>C</b> : 12.5%;  <b>D</b> : 12.5% </blockquote><br>  With such a good distribution, you can encode characters as follows: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/faa/0d0/901/faa0d09010378dd9031ed64d062b1b68.png"></div><br>  For A, 1 bit is needed; for B, 2 bits;  C and D - 3 bits. <br><br>  If the probability distribution is less appropriate, for example: <br>  A: 40%;  B: 30%;  C: 15%;  D: 15%, then according to the Huffman algorithm, we get exactly the same character codes, but the compression will not be as good. <br><br>  The degree of compression of the message is described by the following formula: <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>p</mi><mi>i</mi></msub><msub><mi>b</mi><mi>i</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.808ex" height="2.419ex" viewBox="0 -780.1 3792.1 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-73" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-75" x="719" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6D" x="1292" y="0"></use><g transform="translate(2170,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="712" y="-213"></use></g><g transform="translate(3018,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-62" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="607" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>p</mi><mi>i</mi></msub><msub><mi>b</mi><mi>i</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-1"> \ sum p_ib_i </script> where <code>p <sub>i</sub></code> is the frequency with which the character is encountered in the message, <code>b <sub>i</sub></code> is the number of bits for encoding this character. <br><br>  It is known that for entropy codecs the optimal compression quality is described by the Shannon formula: <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2212;</mo><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>p</mi><mi>i</mi></msub><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.581ex" height="2.66ex" viewBox="0 -832 7139 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-2212" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-73" x="1028" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-75" x="1498" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6D" x="2070" y="0"></use><g transform="translate(2949,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="712" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6C" x="3796" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6F" x="4095" y="0"></use><g transform="translate(4580,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-32" x="675" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-28" x="5512" y="0"></use><g transform="translate(5901,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="712" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-29" x="6749" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>‚àí</mo><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>p</mi><mi>i</mi></msub><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-2"> - \ sum p_i log_2 (p_i) </script>  .  If we compare this with the previous formula, it turns out that <code>b <sub>i</sub></code> should be equal to <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2212;</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.571ex" height="2.66ex" viewBox="0 -832 4120.7 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-2212" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6C" x="778" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6F" x="1077" y="0"></use><g transform="translate(1562,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-32" x="675" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-28" x="2493" y="0"></use><g transform="translate(2883,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="712" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-29" x="3731" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>‚àí</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3"> -log_2 (p_i) </script>  .  Most often, the magnitude of this logarithm is obtained as <i>non-integer</i> . <br><br><h3>  Incomplete number of bits - what to do about it? </h3><br>  In the Huffman algorithm, the number of bits is rounded to the whole, which negatively affects the degree of compression. <br><br>  The algorithm of <a href="https://habrahabr.ru/post/130531/">arithmetic coding</a> uses a different approach, which allows not to round off and thereby get closer to the ‚Äúideal‚Äù compression.  But it works relatively slowly. <br><br>  The FSE algorithm is a cross between the previous two approaches.  It uses a <i>variable number of bits</i> (sometimes more, sometimes less) to encode a character so that <i>on average it</i> turns out <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2212;</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.571ex" height="2.66ex" viewBox="0 -832 4120.7 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-2212" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6C" x="778" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6F" x="1077" y="0"></use><g transform="translate(1562,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-32" x="675" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-28" x="2493" y="0"></use><g transform="translate(2883,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-70" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="712" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-29" x="3731" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>‚àí</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-4"> -log_2 (p_i) </script>  bit per character. <br><br><h2>  How does FSE work </h2><br>  Consider an example.  Let the characters in the message to be encoded are in the following proportion: <br>  <b>A</b> : 5;  <b>B</b> : 5;  <b>C</b> : 3;  <b>D</b> : 3 <br>  We call these numbers the normalized frequencies and denote <code>q <sub>i</sub></code> . <br><br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>N</mi><mo>=</mo><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>q</mi><mi>i</mi></msub></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.04ex" height="2.419ex" viewBox="0 -780.1 5183.9 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-4E" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-3D" x="1166" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-73" x="2472" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-75" x="2942" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6D" x="3514" y="0"></use><g transform="translate(4393,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="631" y="-213"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>N</mi><mo>=</mo><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>q</mi><mi>i</mi></msub></math></span></span><script type="math/tex" id="MathJax-Element-5"> N = \ sum q_i </script>  - the sum of (normalized) symbol frequencies. <br><br>  In our example, N = 16. For fast operation of the algorithm, it is necessary that N be a power of two.  If the sum of the frequencies of the symbols is not equal to the power of two (almost always), then the frequencies need to be <i>normalized</i> - proportionally decrease (or increase) them so that the power of the power of two is combined.  More on this later. <br><br>  Take a table of N columns and enter message symbols there so that each character is encountered exactly as many times as its frequency.  The order is not important yet. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e85/623/55c/e8562355ce576fa166f5364a163ff7aa.png"><br><br>  Each symbol A has its own range of cells ( <i>Sub-ranges</i> in the figure): the size of each range should be a power of two (for speed), in total they should cover all N cells (for now, it doesn‚Äôt matter how these ranges are located). <br><br>  Similarly, for each of the other characters, we define our own set of ranges. <br>  For symbol D there will be 3 ranges: <br><br><img src="https://habrastorage.org/files/cc3/893/0af/cc38930afd3b445eb25dff61158e37c7.png"><br><br>  The code table is ready.  Encode with its help the word "BCDA". <br><br><ol><li>  The first character is " <b>B</b> ".  Choose any table cell with this symbol.  The cell number is our current <i>state</i> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fac/442/0c6/fac4420c61a41c767e30ffe7b4fc9b7e.png"><br>  Current state = <b>5</b> . <br><br></li><li>  Take the next character - " <b>C</b> ".  We look at the code table for C and check which of the intervals our current state has hit. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b5f/7cd/8ac/b5f7cd8ac78e9b1d2e103ba83bb4ff4a.png"><br>  In our case, state <b>5</b> fell into the second interval. <br><br>  We write the offset from the beginning of this interval.  In our case, it is <b>1</b> .  To record the offset, you will need <b>2 bits</b> - according to the size of the range in which our state fell. <br><br>  The current range corresponds to the character C in cell 11, then the new state = <b>11</b> . <br><br></li><li>  Repeat point 2 for each subsequent symbol: select the desired table, determine the range, write the offset, we get a new state. <br><br>  For each character, only an offset in the interval is recorded.  For this, a different number of bits is used, depending on whether we are in the ‚Äúlarge‚Äù or ‚Äúsmall‚Äù interval.  On average, the number of bits per character will tend to the value <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2212;</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>i</mi></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.664ex" height="2.66ex" viewBox="0 -832 5452.7 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-2212" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6C" x="778" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6F" x="1077" y="0"></use><g transform="translate(1562,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-32" x="675" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-28" x="2493" y="0"></use><g transform="translate(2883,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-2F" x="3674" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-4E" x="4174" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-29" x="5063" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>‚àí</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>q</mi><mi>i</mi></msub><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-6"> -log_2 (q_i / N) </script>  .  Proving this fact requires a <a href="">complex theory</a> , so just believe. <br><br></li><li>  When the last character is encoded, we will have the final state.  It needs to be saved, decoding will begin with it. <br></li></ol><br>  <b>Decoding</b> is performed in reverse order - from the last encoded character to the first. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d02/848/511/d028485112fe51b5edd0fff06e823c6d.png"><br><br><ol><li>  We have the final state (4), and it uniquely identifies the last encoded character (A). <br><br></li><li>  Each state corresponds to an interval in the code table.  We read the required number of bits according to the size of the interval (2 bits) and get a new state (15), which defines the next character. <br><br></li><li>  Repeat point 2 until we decode all characters. <br><br>  Decoding ends, either when the encoded data ends, or when a special stop character is encountered (requires an additional character in the alphabet). <br></li></ol><br><h2>  The distribution of characters in the table </h2><br>  The theory tells us that the coding will be more optimal if the same characters are distributed more evenly in the table. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/04d/b51/1cb/04db511cbfe90b7c8a9ec89cbf725d6a.png"><br><br>  This is necessary so that the state does not ‚Äústagnate‚Äù in large intervals, losing the extra bit. <br><br>  It may seem that it would be nice to fall into small intervals all the time (on the left side of the table).  But in this case, other characters will more often fall into large intervals - in the end it will only get worse. <br><br><h2>  Optimization </h2><br>  Finally, we move from theory to code.  To begin, let us figure out how to calculate during coding, in what interval the current state falls and how many bits need to be written. <br><br>  For coding, we need to split a table of size N (equal to some power of two) into <code>q <sub>i</sub></code> intervals.  The sizes of these intervals will also be powers of two: 2 ^ maxbit and 2 ^ (maxbit-1) - let's call them ‚Äúbig‚Äù and ‚Äúsmall‚Äù.  Let the small intervals be to the left, and the large intervals to the right, as in the figure below. <br><br>  For example, if N = 16 and we need 6 intervals, then the partition will be: 2 + 2 + 2 + 2 + 4 + 4 - four ‚Äúsmall‚Äù intervals of size 2 <sup>1</sup> and two ‚Äúlarge‚Äù sizes of 2 <sup>2</sup> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efb/ea5/18e/efbea518e02952739fa8a5dc9d96ac3d.png"></div><br>  Simply calculate the size of a large interval - this is the smallest power of two, such that <br>  <code>2^maxbit &gt;= N / q</code> . <br>  Accordingly, <code>maxbit = log <sub>2</sub> (N) - highbit(q)</code> , where <code>highbit</code> is the number of the highest nonzero bit. <br><br>  Let us return to obtaining <code>q</code> intervals.  First, we divide the table into ‚Äúlarge‚Äù intervals: (N / 2 ^ maxbit) pieces, then several of them will be divided in half.  Separation of the interval increases their total number by 1, therefore, ‚Äúdivide‚Äù requires q - (N / 2 ^ maxbit) large intervals.  Accordingly, the number of small intervals will be (q - (N / 2 ^ maxbit)) * 2. <br><br>  Now we will find under what condition the state state falls into a large interval. <br>  To determine the boundary between small and large intervals, multiply the number of small intervals by their size: <br> <code>(q - (N / 2^maxbit))*2 * 2^(maxbit-1) = (q * 2^maxbit) - N;</code> <br> <br>  It turns out that the state <code>state</code> falls into a <i>large</i> interval provided <br>  <code>N + state &gt;= q * 2^maxbit,</code> otherwise - in <i>small</i> . <br><br>  The size of the interval we hit determines how many lower bits from the current state need to be recorded during coding.  If the condition above is satisfied, then <code>nbBitsOut</code> = <code>maxbit</code> , otherwise ( <code>maxbit</code> - 1).  The remaining status bits will determine the slot number. <br><br>  Instead of the comparison operation, apply a hack with a difference shift by a sufficiently large number: <br>  <code>nbBitsOut = ((maxbit &lt;&lt; 16) +</code> <u><code>N + state - (count &lt;&lt; maxbit)</code></u> <code>) &gt;&gt; 16;</code> <br>  The absence of a condition in this expression allows the processor to more effectively use internal parallelism.  (The variable count corresponds to the q character in the preceding formulas.) <br><br>  As a result, the encoding function takes the following form: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      nbBitsOut = ((maxBitsOut &lt;&lt; 16) + N + state - (count &lt;&lt; maxBitsOut)) &gt;&gt; 16; //  nbBitsOut    state  bitStream: bitStream.WriteBits(state, nbBitsOut); interval_number = (N + state) &gt;&gt; nbBitsOut; //  : state = nextStateTable[deltaFindState[symbol] + interval_number];</span></span></code> </pre><br>  All that can be calculated in advance, put in the table: <br><br><pre> <code class="javascript hljs">symbolTT[symbol].deltaNbBits = (maxBitsOut &lt;&lt; <span class="hljs-number"><span class="hljs-number">16</span></span>) - (count &lt;&lt; maxBitsOut);</code> </pre> <br>  Note that <code>state</code> is always used as <code>N</code> + <code>state</code> .  If in the <code>nextStateTable</code> also store <code>N</code> + <code>next_state</code> , the function will take the following form: <br><br><pre> <code class="javascript hljs">nbBitsOut = (N_plus_state + symbolTT[symbol].deltaNbBits) &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>; bitStream.WriteBits(N_plus_state, nbBitsOut); <span class="hljs-comment"><span class="hljs-comment">//  : N_plus_state = nextStateTable[symbolTT[symbol].deltaFindState + (N_plus_state &gt;&gt; nbBitsOut)];</span></span></code> </pre><br>  As you can see, the calculations are very simple and fast. <br><br>  <b>Decoding</b> will look accordingly: <br><br><pre> <code class="javascript hljs"> <span class="hljs-comment"><span class="hljs-comment">//    outputSymbol(decodeTable[state].symbol); //   ,     nbBits = decodeTable[state].nbBits; //       offset = readBits(bitStream, nbBits); //   :   +  state = decodeTable[state].subrange_pos + offset;</span></span></code> </pre> <br>  Even easier! <br><br>  The real code can be found <a href="https://github.com/Cyan4973/FiniteStateEntropy">here</a> .  There you can also find how the <code>symbolTT  decodeTable.</code> tables are filled <code>symbolTT  decodeTable.</code> <br><br><h2>  About frequency symbol normalization </h2><br>  Above, we proceeded from the assumption that the sum of the frequencies of the symbols <code>q <sub>i</sub></code> is equal to the power of two.  In general, this is certainly not the case.  Then you need to proportionally reduce these numbers so that in total they give a power of two. <br><br>  In this case, it is necessary to take into account that the sum of the frequencies of the symbols is equal to the size of the code table.  The larger the table, the more accurate the symbol frequencies will be and the better the compression will be.  On the other hand, the table itself also takes up a lot of space.  To estimate the size of the compressed data, you can use the Shannon formula <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mo>&amp;#x2212;</mo><mtext>&amp;#xA0;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>q</mi><mi>i</mi></msub><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy=&quot;false&quot;>(</mo><msub><mi>q</mi><mi>i</mi></msub><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mo>/</mo></mrow><mi>N</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.542ex" height="2.66ex" viewBox="0 -832 8414 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-2212" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-73" x="1028" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-75" x="1498" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6D" x="2070" y="0"></use><g transform="translate(2949,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6C" x="3739" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-6F" x="4038" y="0"></use><g transform="translate(4523,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-67" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-32" x="675" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-28" x="5455" y="0"></use><g transform="translate(5844,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-71" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-69" x="631" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-2F" x="6635" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMATHI-4E" x="7136" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/company/playrix/blog/324116/&amp;xid=17259,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgntn7YTH6fR8ggqIaqjQeSAL6KcA#MJMAIN-29" x="8024" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mo>‚àí</mo><mtext>&nbsp;</mtext><mi>s</mi><mi>u</mi><mi>m</mi><msub><mi>q</mi><mi>i</mi></msub><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>2</mn></msub><mo stretchy="false">(</mo><msub><mi>q</mi><mi>i</mi></msub><mrow class="MJX-TeXAtom-ORD"><mo>/</mo></mrow><mi>N</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-7"> - \ sum q_i log_2 (q_i / N) </script>  , <s>too</s> boldly assuming that the compression tends to the ideal, and in this way to choose the optimal tables. <br><br>  In the process of frequency normalization, many small problems can arise.  For example, if some characters have a very, very small probability, then the smallest representable frequency 1 / N may be too inaccurate approximation, but there is no less.  One of the approaches in this case is to assign <code>q <sub>i</sub></code> = 1 to such characters immediately, place them at the end of the code table (so it is more optimal), and then deal with the other characters.  Rounding values ‚Äã‚Äãto the nearest integer may also not be the best option.  This and many other nuances are well written by Jan Collet ( <a href="http://fastcompression.blogspot.ru/2014/03/better-normalization-for-better.html">1</a> , <a href="http://fastcompression.blogspot.ru/2014/03/perfect-normalization.html">2</a> , <a href="http://fastcompression.blogspot.ru/2014/04/ultra-fast-normalization.html">3</a> , <a href="http://fastcompression.blogspot.ru/2014/04/taking-advantage-of-unequalities-to.html">4</a> ). <br><br>  There are both fast heuristic algorithms for frequency normalization and slow, but more accurate ones.  The choice is yours. <br><br><h2>  Choosing a data model </h2><br>  Let's consider the situation when we need to encode numeric values ‚Äã‚Äãfrom a potentially large range, for example, from -65536 to +65535.  At the same time, the probability distribution of these numbers is highly uneven: with a large peak in the center and very small probabilities at the edges, as in the picture.  If you encode each value as a separate character, the table will be of unimaginable size. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/2d4/bd8/d162d4bd80fac3295be583ecf8805428.png"></div><br>  In this situation, you can designate a single range of values ‚Äã‚Äãwith one symbol.  With FSE, we will encode only the symbol itself, and the offset in the range will be written ‚Äúas is‚Äù, according to the size of the range. <br><br>  This technique allows us to make the code tables more or less compact. <br><br>  This example demonstrates that the choice of the alphabet is highly dependent on your data.  It is necessary to apply a little imagination to make the coding the most optimal. <br><br><h2>  Mixed coding </h2><br>  If different parts of the data have a different frequency distribution, then it is better to use different tables for their coding. <br><br>  In this case, heterogeneous data can be encoded, alternately using different tables!  A state from one table is used to encode the next character by another table.  The main thing is that you can repeat the same order when decoding.  Tables must also be the same size. <br><br>  For example, let your data be a sequence of the form " <i>command - number - command - number ...</i> ".  You always know that there will be a number after the command, and this determines the order in which the tables are used. <br><br>  If you encode the data <i>from the end to the beginning</i> , then when decoding (from the beginning to the end) it will be clear what will be followed by and, accordingly, which table to use for decoding the next element. <br><br><h2>  About table entry </h2><br>  As mentioned above, the code table needs to be saved along with the data in order to decode it.  It is desirable that the table does not take up much space. <br><br>  Let's see what fields are in the dTable table: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> symbol; <span class="hljs-comment"><span class="hljs-comment">//     256  unsigned short subrange_pos; //    unsigned char nbBits; //   </span></span></code> </pre><br>  Total: 4 bytes for each character.  A lot. <br><br>  But if you think about it, instead of the dTable table you can only store normalized symbol frequencies.  For example, if the size of the code table is 2 <sup>8</sup> = 256, then 8 bits per character will be more than enough. <br>  Knowing the frequency, you can build exactly the same dTable, as when encoding. <br><br>  At the same time, I advise you to make sure that the algorithm does not use float (there are differences on different processors with it, it is better to use a fixed point), use only stable_sort and similar measures for reliable reproducibility of the result. <br><br>  By the way, these tables can also be compressed somehow.  ;) <br><br><h2>  Epilogue </h2><br>  We at <b>Playrix</b> use FSE to encode vector animations.  Delta between frames consist of a set of small values ‚Äã‚Äãwith a distribution peak near zero.  The transition from Huffman to FSE made it possible to reduce the size of animations by about one and a half times.  Compressed data is stored in memory, unpacking is done ‚Äúon the fly‚Äù with simultaneous playback.  FSE allows you to do this very effectively. <br><br><h2>  Links </h2><br>  Now that you have figured out how FSE works, for more understanding, I recommend reading the Jan Collet blog (in English) for details: <br><br><ol><li>  <a href="http://fastcompression.blogspot.ru/2013/12/finite-state-entropy-new-breed-of.html">Finite State Entropy - A new breed of entropy coder</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/01/fse-decoding-how-it-works.html">FSE decoding: how it works</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/01/huffman-comparison-with-fse.html">Huffman, a comparison with FSE</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/02/a-comparison-of-arithmetic-encoding.html">A comparison of Arithmetic Encoding with FSE</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/02/fse-defining-optimal-subranges.html">FSE: Defining optimal subranges</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/02/fse-distributing-symbol-values.html">FSE: distributing symbol values</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/02/fse-decoding-wrap-up.html">FSE decoding: wrap up</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/02/fse-encoding-how-it-works.html">FSE encoding: how it works</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/02/fse-tricks-memory-efficient-subrange.html">FSE tricks - Memory efficient subrange maps</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/03/better-normalization-for-better.html">Better normalization, for better compression</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/03/perfect-normalization.html">Perfect Normalization</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/04/ultra-fast-normalization.html">Ultra-fast normalization</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/04/taking-advantage-of-unequalities-to.html">Taking advantage of unequalities to provide better compression</a> <br></li><li>  <a href="http://fastcompression.blogspot.ru/2014/09/counting-bytes-fast-little-trick-from.html">Counting bytes fast - little trick from FSE</a> <br></li></ol><br>  The code on GitHub (by Jan Collet): <a href="https://github.com/Cyan4973/FiniteStateEntropy">https://github.com/Cyan4973/FiniteStateEntropy</a> . </div><p>Source: <a href="https://habr.com/ru/post/324116/">https://habr.com/ru/post/324116/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324106/index.html">How flexible are our knowledge of Rx operators?</a></li>
<li><a href="../324108/index.html">Windows Forth +</a></li>
<li><a href="../324110/index.html">Liquid cooling of servers as an upward trend in equipment for data centers</a></li>
<li><a href="../324112/index.html">HPE Aruba and Cisco Controller Interfaces</a></li>
<li><a href="../324114/index.html">PVS-Studio: search for security defects</a></li>
<li><a href="../324118/index.html">Difficulties in creating an isometric game in Unity</a></li>
<li><a href="../324120/index.html">Search for ski slopes from space</a></li>
<li><a href="../324122/index.html">Dark path</a></li>
<li><a href="../324124/index.html">Using the ArcGIS API for Python in Jupyter Notebook</a></li>
<li><a href="../324126/index.html">Logo is clothing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>