<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Key-value for storing metadata in storage. We test the selected databases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we continue to talk about how you can store metadata in storage using key-value databases. 

 This time, the focus of our attention o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Key-value for storing metadata in storage. We test the selected databases</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/w_/iy/86/w_iy86aeei2csgk9nnajkutpbmo.jpeg"><br><br>  In this article, we continue to talk about how you can store metadata in storage using key-value databases. <br><br>  This time, the focus of our attention on the selected database: Aerospike and RocksDB.  Description of the importance of metadata in the storage system, as well as the results of testing embedded databases can be found <a href="https://habrahabr.ru/company/raidix/blog/345076/">here</a> . <br><a name="habracut"></a><br><h2>  Test parameters of the key-value database </h2><br>  We briefly recall the main parameters for which we conducted testing (details <a href="https://habrahabr.ru/company/raidix/blog/345076/">in the previous article</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main workload is Mix50 / 50.  Additionally evaluated: RR, Mix70 / 30 and Mix30 / 70. <br><br>  Testing was carried out in 3 stages: <br><br><ol><li>  Database filling - we fill in 1 database flow to the required number of keys. <br>  1.1 Reset caches!  Otherwise, the tests will be dishonest: the database usually writes data on top of the file system, so the operating system cache works.  It is important to discard it before each test. </li><li>  Tests for 32 threads - we run workloads <br>  2.1 Random Read <br>  ‚Ä¢ We reset caches! <br>  2.2 Mix70 / 30 <br>  ‚Ä¢ We reset caches! <br>  2.3 Mix50 / 50 <br>  ‚Ä¢ We reset caches! <br>  2.4 Mix30 / 70 <br>  ‚Ä¢ We reset caches! </li><li>  Tests for 256 threads. <br>  3.1 Same as for 32 threads. </li></ol><br><h3>  Measurable indicators </h3><br><ul><li>  Throughput / throughput (IOPS / RPS - who loves which notation). </li><li>  Latency (msec) latency: <br>  ‚Ä¢ Min. <br>  ‚Ä¢ Max. <br>  ‚Ä¢ The mean square value is a more significant value than the arithmetic mean, because  takes into account the standard deviation. <br>  ‚Ä¢ Percentile 99.99. </li></ul><br><h3>  Test environment </h3><br>  Configuration: <br><table><tbody><tr><td>  CPU: </td><td>  2x Intel Xeon E5-2620 v4 2.10GHz </td></tr><tr><td>  RAM: </td><td>  16GB </td></tr><tr><td>  Disk: </td><td>  [2x] NVMe HGST SN100 1.5TB </td></tr><tr><td>  OS: </td><td>  CentOS Linux 7.2 kernel 3.11 </td></tr><tr><td>  FS: </td><td>  EXT4 </td></tr></tbody></table><br>  The amount of available RAM was not physically regulated, but programmatically - part of it was artificially filled with a Python script, and the remainder was free for the database and caches. <br><br><h2>  Dedicated DB.  Aerospike </h2><br>  How is Aerospike different from the engines we tested before? <br><br><ul><li>  RAM index </li><li>  Using RAW disks (= no FS) </li><li>  Not a tree, but a hash. </li></ul><br>  It so happened that in the Aerospike index for each key is stored 64B (and the key itself is only 8B).  In this case, the index must always be fully in RAM. <br><br>  This means that with our number of keys, the index will not fit in the memory we allocate.  It is necessary to reduce the number of keys.  And our data allows it! <br><br><img src="https://habrastorage.org/webt/xx/am/ny/xxamny5d3hid9dtbenwr5jog6cy.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">1. Package 1</font></i> <br><br><img src="https://habrastorage.org/webt/_r/dd/xk/_rddxkq7q0n45xbv2-dizbdfy2i.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">2. Packing 2</font></i> <br><br>  So, using this package, we reduced the number of keys by 4 times.  In the same way, we can reduce their number by k times.  Then the size of the value will be 16 * k B. <br><br><h2>  Testing.  17 billion keys </h2><br>  In order for the Aerospike index of 17 billion keys (17 billion lba-&gt; metadata mappings) to fit into RAM, you need to pack this 64 times. <br><br>  As a result, we get 265 625 000 keys (each of the keys will correspond to a value of 1024B in size, containing 64 instances of metadata). <br><br>  We will test using YCSB.  It does not produce the average square delay, so it will not be on the graphs. <br><br><h3>  Filling </h3><br>  Aerospike showed a good result to fill.  Behaves very stable. <br><br>  But the filling was carried out in 16 streams, and not in one, as it was with the engines.  In one thread, Aerospike issued about 20k IOPS.  Most likely, the matter is in the benchmark (that is, the benchmark simply does not ‚Äúsqueeze‚Äù the database into one thread).  Or Aerospike loves a lot of streams, and in one it is not ready to give out a large bandwidth. <br><br><img src="https://habrastorage.org/webt/fr/9a/eu/fr9aeuwcr1vji8gn5n16pumtndw.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">3. Base filling capacity</font></i> <br><br>  The maximum delay was also kept at about the same level throughout the filling. <br><br><img src="https://habrastorage.org/webt/h2/k4/o5/h2k4o5xqoowfr5sdmc1dnhdhhn0.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">4. Latency filling base</font></i> <br><br><h3>  Tests </h3><br>  It is important to note here that on these graphs you cannot directly compare Aerospike and RocksDB, as the tests were conducted under different conditions and different benchmarks - Aerospike was used ‚Äúwith packaging‚Äù, and RocksDB was used without. <br><br>  Also worth noting is that 1 IO from Aerospike = extract 64 values ‚Äã‚Äã(instances of metadata). <br>  RocksDB results here are provided as a reference. <br><br><img src="https://habrastorage.org/webt/go/wv/sa/gowvsa9dgdllgqyrxm135ymnane.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">5. Comparing Aerospike and RocksDB.100% Read</font></i> <br><br><img src="https://habrastorage.org/webt/fx/ex/t2/fxext2hg_p1nzhj7gf18aewoaos.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">6. Comparing Aerospike and RocksDB.</font></i>  <i><font color="#99999">Mix 70% / 30%</font></i> <br><br><img src="https://habrastorage.org/webt/gn/km/in/gnkminften1qb9gvukrhbnoskpa.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">7. Comparing Aerospike and RocksDB Mix 50% / 50%</font></i> <br><br><img src="https://habrastorage.org/webt/mb/cg/ki/mbcgkiyipk8znmver7u8f9uribo.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">8. Comparison of Aerospike and RocksDB Mix 30% / 70%</font></i> <br><br>  As a result, recording on a small number of streams was slower than that of RocksDB (it should be remembered that in the case of Aerospike, 64 values ‚Äã‚Äãare recorded at once). <br><br>  But on a large number of threads, Aerospike still produces higher values. <br><br><img src="https://habrastorage.org/webt/j4/ly/g5/j4lyg5vuaslhyfepf-cmeg9i4sg.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">9. Aerospike.</font></i>  <i><font color="#99999">Latency Read 100%</font></i> <br><br>  Here we finally managed to get an acceptable level of latency.  But only in the reading test. <br><br><img src="https://habrastorage.org/webt/gc/si/k7/gcsik7n7ustrrphuue4iz0whg9k.png"><br>  <i><font color="#99999">Fig.</font></i>  <i><font color="#99999">10. Aerospike.Latency Mix 50% / 50%</font></i> <br><br>  Now you can update the list of findings: <br><br><ul><li>  Record + few threads =&gt; WiredTiger </li><li>  Record + many threads =&gt; RocksDB </li><li>  Read + DATA&gt; RAM =&gt; RocksDB </li><li>  Read + DATA &lt;RAM =&gt; MDBX </li><li>  Multiple threads + DATA&gt; RAM + Pack =&gt; Aerospike </li></ul><br>  The final conclusion on the choice of database for metadata: in this form, none of the applicants do not reach the indicators we need.  Closer of all is the Aerospike. <br><br>  Below we will talk about what can be done with this and what data storage in direct addressing gives us. <br><br><h2>  Direct Addressing.  137 billion keys </h2><br>  Consider a storage system of 512 TV.  The metadata of such a storage system is placed on one NVME and corresponds to 137 billion keys for the key-value database. <br><br>  Consider the simplest implementation of direct addressing.  To do this, create a SPDK NVMf target on one node, take a local NVMe and this NVMf target on another node and combine them into logical RAID1. <br><br>  This approach will allow you to record metadata and protect them with a replica in case of failure. <br>  When testing performance in multiple threads, each thread will write to its area and these areas will not overlap. <br><br>  Testing was performed using the FIO benchmark in 8 threads with a queue depth of 32. The table below shows the test results. <br><br>  <i><font color="#99999">Table 1. Testing Direct Addressing</font></i> <br><table><tbody><tr><th></th><th>  rand read 4k (IOPS) </th><th>  rand write 4k (IOPS) </th><th>  rand r / w 50/50 4K (IOPS) </th><th>  rand r / w 70/30 4K (IOPS) </th><th>  rand r / w 30/70 4K (IOPS) </th></tr><tr><td>  spdk </td><td>  760 - 770 K </td><td>  350 - 360 K </td><td>  400 - 410 K </td><td>  520 - 540 K </td><td>  410 - 450 K </td></tr><tr><td>  lat (ms) avg / max </td><td>  0.3 / 5 </td><td>  0.4 / 23 </td><td>  0.3 / 19 </td><td>  0.5 / 21 </td><td>  1.2 / 28 </td></tr></tbody></table><br>  Now let's test Aerospike in a similar configuration, where 137 billion keys are also placed on one NVMe and replicated to another NVMe. <br><br>  We test with the help of the ‚Äúnative‚Äù benchmark Aerospike.  We take two benchmarks - each on its own node - and 256 threads to squeeze the maximum performance. <br><br>  We get the following results: <br><br>  <i><font color="#99999">Table 2. Aerospike testing with replication</font></i> <br><table><tbody><tr><th>  R / W </th><th>  Iops </th><th>  &gt; 1ms </th><th>  &gt; 2ms </th><th>  &gt; 4ms </th><th>  99.99 lat &lt;= </th></tr><tr><td>  100/0 </td><td>  635,000 </td><td>  7% </td><td>  one% </td><td>  0% </td><td>  50 </td></tr><tr><td>  70/30 </td><td>  425,000 </td><td>  eight% </td><td>  3% </td><td>  one% </td><td>  50 </td></tr><tr><td>  50/50 </td><td>  342,000 </td><td>  eight% </td><td>  four% </td><td>  one% </td><td>  50 </td></tr><tr><td>  30/70 </td><td>  271,000 </td><td>  eight% </td><td>  four% </td><td>  one% </td><td>  40 </td></tr><tr><td>  0/100 </td><td>  200,000 </td><td>  0% </td><td>  0% </td><td>  0% </td><td>  36 </td></tr></tbody></table><br>  Below are the results of testing without replication, one benchmark in 256 threads. <br><br>  <i><font color="#99999">Table 3. Aerospike testing without replication</font></i> <br><table><tbody><tr><th>  R / W </th><th>  Iops </th><th>  &lt;= 1ms </th><th>  &gt; 1ms </th><th>  &gt; 2ms </th><th>  99.99 lat &lt;= </th></tr><tr><td>  100/0 </td><td>  413,000 </td><td>  99% </td><td>  one% </td><td>  0% </td><td>  five </td></tr><tr><td>  70/30 </td><td>  376,000 </td><td>  95% </td><td>  five% </td><td>  2% </td><td>  7 </td></tr><tr><td>  50/50 </td><td>  360000 </td><td>  92% </td><td>  eight% </td><td>  3% </td><td>  eight </td></tr><tr><td>  30/70 </td><td>  326,000 </td><td>  93% </td><td>  7% </td><td>  3% </td><td>  eight </td></tr><tr><td>  0/100 </td><td>  260000 </td><td>  94% </td><td>  6% </td><td>  2% </td><td>  five </td></tr></tbody></table><br>  Note that Aerospike c replication works no worse, and even better.  This increases latency compared to non-replicating Aerospike testing. <br><br>  We also give the results of testing RocksDB without replication (RocksDB does not have native built-in replication) with its benchmark of 256 threads, 137 billion keys with packaging. <br><br>  <i><font color="#99999">Table 4. Testing RocksDB without replication</font></i> <br><table><tbody><tr><th>  R / W </th><th>  Iops </th><th>  &lt;= 1ms </th><th>  &gt; 1ms </th><th>  &gt; 2ms </th><th>  99.99 lat &lt;= </th></tr><tr><td>  100/0 </td><td>  444000 </td><td>  93% </td><td>  7% </td><td>  2% </td><td>  300 </td></tr><tr><td>  70/30 </td><td>  188,000 </td><td>  86% </td><td>  14% </td><td>  four% </td><td>  2000 </td></tr><tr><td>  50/50 </td><td>  107,000 </td><td>  75% </td><td>  25% </td><td>  3% </td><td>  1800 </td></tr><tr><td>  30/70 </td><td>  73,000 </td><td>  85% </td><td>  15% </td><td>  0% </td><td>  1200 </td></tr><tr><td>  0/100 </td><td>  97000 </td><td>  74% </td><td>  26% </td><td>  17% </td><td>  2500 </td></tr></tbody></table><br><h2>  findings </h2><br><ul><li>  RocksDB "c packaging" does not pass latency tests </li><li>  Aerospike c replication almost meets the criteria </li><li>  The simplest implementation of direct addressing meets all the criteria for performance and latency. </li></ul><br><h2>  P.S.  Restrictions </h2><br>  Note the important parameters that remained outside the scope of this study: <br><br><ul><li>  File system (FS) and its settings </li><li>  Virtual memory settings </li><li>  DB settings. </li></ul><br><h3>  1. FS and its settings </h3><br><ul><li>  There is an opinion that, for example, F2FS or XFS is suitable for RocksDB </li><li>  Also the choice of filesystem depends on which drives are used in the system. </li><li>  Size page (block) FS </li></ul><br><h3>  2. Virtual memory settings </h3><br><ul><li>  You can read <a href="http://www.hcst.net/~vogelke/server-tuning/fs/pdflush-tuning">here</a> . </li></ul><br><h3>  3. DB settings </h3><br><ul><li>  <b>Mdbx.</b>  A recommendation was received from the developer of this engine to try a different page size in the engine: 2 kilobytes or cluster size in NVME.  In general, this parameter is important in other databases (even in Aerospike). </li><li>  <b>WiredTiger.</b>  In addition to the cache_size parameter, which we changed, there are a lot of parameters.  Read <a href="http://source.wiredtiger.com/2.4.1/performance.html">here</a> . </li><li>  <b>RocksDB.</b> <br>  ‚Ä¢ You can try Direct IO: i.e.  communication with the disk, bypassing the page cache.  But then, most likely, it will be necessary to increase the block cache built into RocksDB.  About this <a href="https://github.com/facebook/rocksdb/wiki/Direct-IO">here</a> . <br>  ‚Ä¢ There is <a href="https://www.percona.com/live/data-performance-conference-2016/sites/default/files/slides/Percona_RocksDB_v1.3.pdf">information</a> on how to configure RocksDB for NVME.  Here, by the way, is used XFS. </li><li>  <b>Aerospike.</b>  It also has a lot of settings, but their tuning for several hours did not bring tangible results. </li></ul></div><p>Source: <a href="https://habr.com/ru/post/345482/">https://habr.com/ru/post/345482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345472/index.html">The future of Internet protocols</a></li>
<li><a href="../345474/index.html">Security in modern corporations</a></li>
<li><a href="../345476/index.html">Configuring VPN (PPTP) in Ubuntu 17.10 with authorization by JaCarta smart card</a></li>
<li><a href="../345478/index.html">All professions are important: why should a tester be valued as much as a programmer?</a></li>
<li><a href="../345480/index.html">How to save on spot EC2 instances with Scylla</a></li>
<li><a href="../345484/index.html">Linear Regression with Go</a></li>
<li><a href="../345486/index.html">20 hits of world cinema that translated from English otherwise</a></li>
<li><a href="../345488/index.html">What is the difference between React and Vue?</a></li>
<li><a href="../345490/index.html">We are launching a new online course ‚ÄúWeb Services Development on Go‚Äù</a></li>
<li><a href="../345492/index.html">Non convolutional networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>