<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rise of one small wayward neural network, or how to make a codewar-game in 3 days</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For the birthday of FirstVDS, we are launching the quest for the third time. Previously, it was only for admins, this year they decided to add a task ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rise of one small wayward neural network, or how to make a codewar-game in 3 days</h1><div class="post__text post__text-html js-mediator-article">  For the birthday of FirstVDS, we are launching the quest for the third time.  Previously, it was only for admins, this year they decided to add a task for programmers. <br><br>  In the story, the player failed to train Nexa‚Äôs neural network and hit the uprising machines.  In the final task administrators, programmers and simple people "with paws" fought with Nexa each in their own way.  If the tasks for admins were the groundwork, then we thought about the progersky. <br><br>  I wanted something non-trivial and with a visual interface - so that the player immediately saw the result is just as interesting.  We remembered the mail.ru competitions in the codewar style and decided to do something similar. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What is the point: the participant needs to write an effective code that will "compete" with the code of the conditional opponent. <br><a name="habracut"></a><br><h2>  Rules of the game </h2><br>  We introduce the terms: <br>  Nexa is an artificial intelligence character. <br>  "John" - a character fighter with AI. <br>  "Infection" is an area affected by the actions of Nexa.  The set of cells John needs to clear. <br><br>  A common metaphor is the struggle between John and Nexa.  Both characters are on the 10x10 field, where each cell of the field can have 2 states: clean and infected. <br><br>  A set of common actions is available for characters: stay in place, move left / right / up / down. <br><br>  Additional rules apply for Nexa: <br><br>  1) Stepping on a non-infected cell, infects it immediately <br>  2) Can move on uninfected cells once in 3 rounds, on infected ones as usual - 1 time per round <br><br>  For John, an additional action is available ‚Äî treating an infected cell, for which he must spend one turn. <br><br>  Character code is a function that describes the character's behavior in each round.  The round begins with Nexa‚Äôs move, followed by John‚Äôs move.  The input function receives the state of the playing field and the objects on it.  The output function gives one of the available actions.  Rounds continue until the field is cleared of the Infection, or the round counter reaches 100. <br><br>  From the participant‚Äôs side, the game looks like this: he writes code in a special field, presses the ‚ÄúCheck Code‚Äù button.  The server starts the sequence of moves of John and Nexa.  The player is returned full information about all the moves indicating the infected cells.  He sees if he could beat Nex, how many moves he spent and the length of his code.  After that, the player analyzes the information, corrects the code, sends it again.  When he decided that this was his best result, he stopped trying.  The last result is recorded in the database. <br><br><h2>  Stack technology </h2><br>  For the backend of the game, they launched a VDS server with a dual-core processor, 2 GB of RAM and CentOS 7 operating system. The program language of the game was chosen to be familiar to all web programmers JavaScript.  Since the code must be executed on the server, the backend platform served as NodeJS with the express framework.  Launched our application using the pm2 library. <br><br>  The engine of the whole quest was made on cmf Drupal 7. Information about the player passing the task was entered into the Mysql database.  The player control interface was implemented on jQuery.  Character visualization, game grid, motion animation were implemented using the ds js library, and the code editor ace editor. <br><br><h2>  Backend implementation </h2><br>  So, let's start creating the logic of the game. <br><br>  First, put NodeJs on the server, the npm package manager. <br>  Install the necessary components in npm.  Package.json file contents <br><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"quest_codewar"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"Sergey Pinigin"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"^4.16.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"http"</span></span>: <span class="hljs-string"><span class="hljs-string">"0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"https"</span></span>: <span class="hljs-string"><span class="hljs-string">"^1.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nodemon"</span></span>: <span class="hljs-string"><span class="hljs-string">"^1.12.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"performance-now"</span></span>: <span class="hljs-string"><span class="hljs-string">"^2.1.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pm2"</span></span>: <span class="hljs-string"><span class="hljs-string">"^2.10.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request"</span></span>: <span class="hljs-string"><span class="hljs-string">"^2.83.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vm2"</span></span>: <span class="hljs-string"><span class="hljs-string">"^3.5.2"</span></span> } }</code> </pre> <br><h3>  Application structure: </h3><br>  server.js - web server setup and routing. <br>  game.js is the main game mechanic. <br>  Character.js - file class, describes the basic features of the characters of the game. <br>  quest.js - interaction interface with the quest engine. <br><br><h3>  server.js </h3><br>  We describe the configuration of our server and make the routing. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = express(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> game = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./game'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    var quest = require('./quest'); //               var fs = require('fs'); var http = require('http'); var https = require('https'); //  ssl  var privateKey = fs.readFileSync('/var/www/codewar/ssl/codewar.firstvds.ru.key', 'utf8'); var certificate = fs.readFileSync('/var/www/codewar/ssl/codewar.firstvds.ru.crt', 'utf8'); app.use(function (req, res, next) { //    res.header("Access-Control-Allow-Origin", "*"); res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept"); next(); }); app.get('/enviroment', function (req, res) { //       var myGame = new game.Game(); res.send(myGame.enviroment()); }); app.get('/result', function (req, res) { //   ,     var url = require('url'); var url_parts = url.parse(req.url, true); var query = url_parts.query; // ,    var code = query.code; //   var quest_session = query.session; // codewar     json  var myGame = new game.Game(); var result = myGame.play(code); //      quest.send_codewar_result(quest_session, result.result, code); //    res.send(result); }); var credentials = {key: privateKey, cert: certificate}; var httpServer = http.createServer(app); var httpsServer = https.createServer(credentials, app); httpServer.listen(80); httpsServer.listen(443);</span></span></code> </pre><br><h3>  Character.js </h3><br>  We describe the basic features of our characters.  The methods and properties of the Character object will be inherited by John and Nexa objects. <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">members, options, timeline, sleep_steps</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.members = members; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.last_action = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.no_cooldown = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   .     ,    hold this.left = function () { if (this.members[this.who].position.x &gt; 1) { this.members[this.who].position.x--; } else { this.hold(); } } this.right = function () { if (this.members[this.who].position.x &lt;= options.scale.x - 1) { this.members[this.who].position.x++; } else { this.hold(); } } this.up = function () { if (this.members[this.who].position.y &gt; 1) { this.members[this.who].position.y--; } else { this.hold(); } } this.down = function () { if (this.members[this.who].position.y &lt;= options.scale.y - 1) { this.members[this.who].position.y++; } else { this.hold(); } } //     .    sleep_steps ‚Äî  ¬´¬ª  this.checkActionPossibility = function () { var cooldown = options[this.who].cooldown; if (!this.no_cooldown &amp;&amp; cooldown &gt; 0 &amp;&amp; sleep_steps[this.who] &lt; cooldown) { return false; } else { return true; } } //   this.hold = function () { this.action = 'hold'; } //        ,     this.action = function (action) { this.action = action; if (this.checkActionPossibility()) { switch (action) { case 'left': this.left(); break case 'right': this.right(); break case 'up': this.up(); break case 'down': this.down(); break default: //   ,      (John  Nexa)  if (typeof this.ind_action == "function") { this.ind_action(action); } else { this.hold(); } break } } else { this.hold(); } //     hold,  sleep_steps   1 if (this.action == 'hold') { sleep_steps[this.who]++; } else { sleep_steps[this.who] = 0; } members[this.who].last_action = this.action; } }</span></span></code> </pre><br><h3>  game.js </h3><br>  Let us proceed to the description of the main mechanics of the game.  The key point is the choice of sandbox for isolated execution of custom code.  Fortunately, Nodejs has a VM2 library.  There are 2 types of sandbox in it: VM and NodeVM. <br><br>  VM is a simple sandbox view that runs the script in isolation from the entire environment.  It is not possible to connect third-party libraries and functions to it.  Great for running unreliable code, you can specify the timeout of the script.  However, it is impossible to remove user use of the console from the VM, which makes it difficult to debug. <br>  NodeVM is a more functional sandbox, you can connect external functions to it and you can get console.log from it.  However, you cannot specify a timeout. <br><br>  Decided to work with VM, as the correct processing of unreliable code is more important than using the console by the user. <br><br><div class="spoiler">  <b class="spoiler_title">game.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Game = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   //    const {VM, VMScript} = require('vm2'); //       var now = require("performance-now"); //        var fs = require('fs'); //    var options = { scale: {//   x: 10, y: 10 }, maxSteps: 100, //     nexa: {//   beginPosition: {//   x: 8, y: 8 }, cooldown: 3 //   }, john: { //   beginPosition: { x: 3, y: 3 }, cooldown: 0 }, infection: [ //    {x: 1, y: 1}, {x: 5, y: 5}, {x: 8, y: 2}, {x: 2, y: 7}, {x: 4, y: 3}, {x: 10, y: 8} ] } //     var vm_john, vm_nexa; //     var timeline = []; //      var sleep_steps = {nexa: 0, john: 0}; //         var result = { //    win: false, code_length: 0, john_time: 0, steps: 0, moves: 0, cured: 0, infected: 0, version: 1, maxSteps: options.maxSteps }; var members = { //     ,     john: {}, nexa: {}, infection: options.infection }; var finish = false; // ,    var current_step = 0; //    //  ,     var Character = require('./Character'); //    var play = function (code) { var storage = {}; //     var vstorage = {}; //     finish = false; //        vm_john = new VM({ sandbox: {storage}, timeout: 50 }); //       vm_nexa = new VM({ sandbox: {vstorage}, timeout: 50 }); sleep_steps = {//     nexa: 0, john: 0 } result = {//    win: false, code_length: 0, john_time: 0, steps: 0, moves: 0, cured: 0, infected: 0, version: 1, maxSteps: options.maxSteps }; result.infected += options.infection.length; //      timeline = []; //    //    var john = { position: options.john.beginPosition, last_action: 'hold' } //    var nexa = { position: options.nexa.beginPosition, last_action: 'hold' } //        var members = { john: john, nexa: nexa, infection: options.infection } //  ,      members.infection.push({x: nexa.position.x, y: nexa.position.y}); result.infected++; timeline[0] = members; //      current_step = 1; //     . ,         . while (current_step &lt; 100 &amp;&amp; !result.win) { //      /,     step     : timeline[current_step] = step(JSON.parse(JSON.stringify(timeline[current_step - 1])), code); current_step++; } //         .     result calcResultVariables(code); //         return { timeline: timeline, result: result } } //  ,   John John = function (members) { this.who = "john"; //   call,    this    Character. Character.call(this, members, options, timeline, sleep_steps); //            this.vm_wrapper = function (code, members) { var re = ""; //         mind.           var codew = code + ' mind(' + JSON.stringify(members) + ', ' + JSON.stringify(options) + ');'; try { var script = new VMScript(codew).compile(); } catch (e) { re = "error"; members.john.error = ' ' + e.name + ": " + e.message; } if (re != "error") { try { re = vm_john.run(codew); } catch (e) { re = "error"; members.john.error = ' ' + e.name + ":" + e.message; } } return re; } //   step,    . this.step = function (code) { //    hold var re = 'hold'; var john_mind = code; var time = now(); re = this.vm_wrapper(john_mind, members); //       time = now() - time; result.john_time += time; return re; } //    ,  .       cure -    this.ind_action = function (action) { switch (action) { case 'cure': this.disinfect(); break; } } //      this.disinfect = function () { var cell = checkInfectedCell(members.infection, members.john.position.x, members.john.position.y); //delete cell; if (members.infection.indexOf(cell) != -1) { members.infection.splice(members.infection.indexOf(cell), 1); result.cured++; } } } //  ,   Nexa   John Nexa = function (members) { this.who = "nexa"; Character.call(this, members, options, timeline, sleep_steps); this.step = function () { var re = 'hold'; if (!sleep_steps.nexa &amp;&amp; timeline[current_step - 2] &amp;&amp; checkInfectedCell(timeline[current_step - 2].infection, members.nexa.position.x, members.nexa.position.y) ) { this.no_cooldown = true; } //       var nexa_mind = fs.readFileSync('./vm_scripts/nexa_v3.js', 'utf8'); re = vm_nexa.run(nexa_mind + ' mind(' + JSON.stringify(members) + ', ' + JSON.stringify(options) + ');'); return re; } //    ,  .       infect ‚Äî   this.ind_action = function (action) { switch (action) { case 'infect': this.infect(); break; } } //     this.infect = function () { result.infected++; if (!checkInfectedCell(members.infection, members.nexa.position.x, members.nexa.position.y)) { members.infection.push({x: members.nexa.position.x, y: members.nexa.position.y}); } } } //    step,         var step = function (members, user_code) { //  : var nexa = new Nexa(members); var action = nexa.step(); if (action == "error") { result.error = "        :-("; } nexa.action(action); //    :      ,       if (nexa.action != 'hold') { nexa.infect(); } //  : var john = new John(members); var action = john.step(user_code); if (action == "error") { result.error = "        :-("; } john.action(action); //     if (["left", "right", "up", "down"].indexOf(john.action) != -1) result.moves++; //     result.win = !members.infection.length; if (result.win) finish = true; return members; } // ,     var enviroment = function () { return JSON.parse(JSON.stringify(options)); } // ,   result      var calcResultVariables = function (code) { var min_code = String(code).replace(/[\s]^ /g, ''); min_code = min_code.replace(/\s+/g, ' '); result.code_length = min_code.length; result.steps = timeline.length; } //       var checkInfectedCell = function (infection, x, y) { if (infection) { for (var k in infection) { if (infection[k].x == x &amp;&amp; infection[k].y == y) { return infection[k]; } } } return false; } this.play = play; this.enviroment = enviroment; } module.exports.Game = Game;</span></span></code> </pre><br></div></div><br><h3>  quest.js </h3><br>  The interaction of the backend of the game with the quest engine was reduced to one action as a result - to transfer information about the game passing by the user.  We will transmit an object with the results of the attempt, the session id and the code written by the player.  Authorization from the engine of the quest by login and password.  As a measure of additional security, we can limit the range of ip addresses from the quest engine. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> quest_host = <span class="hljs-string"><span class="hljs-string">"https://quest.firstvds.ru/"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> send_codewar_result = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">quest_session, codewar_result, code</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (quest_session) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'request'</span></span>); request.post({ <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: {<span class="hljs-string"><span class="hljs-string">'content-type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>}, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: quest_host + <span class="hljs-string"><span class="hljs-string">'quest/codewar_api_user_result'</span></span>, <span class="hljs-attr"><span class="hljs-attr">form</span></span>: { <span class="hljs-attr"><span class="hljs-attr">auth</span></span>: { <span class="hljs-attr"><span class="hljs-attr">user</span></span>: <span class="hljs-string"><span class="hljs-string">"codewaruser"</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">"password"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">result</span></span>: codewar_result, <span class="hljs-attr"><span class="hljs-attr">session</span></span>: quest_session, <span class="hljs-attr"><span class="hljs-attr">code</span></span>: code } }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error, response, body</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(body); }); } } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.send_codewar_result = send_codewar_result;</code> </pre><br><h2>  Implementation frontend </h2><br>  The first component of the game interface is the code editor.  Ace editor is a simple and convenient tool for editing code on a page.  Add a nice button and the input interface is ready. <br><br><img src="https://habrastorage.org/webt/oj/yx/eh/ojyxehhveexazrkc0t81pyrfcuq.png"><br><br>  Let's create an interactive interface for displaying the move log in the ‚Äúplayer‚Äù style with the first move / previous move / run / pause / next move / last move buttons. <br>  When loading, the player shows the initial position of John, Nexa and infected cells.  The numerical results of the game will be displayed to the right of the "player". <br><br><img src="https://habrastorage.org/webt/ns/ir/gk/nsirgktiifjwxiqdva2vlwwbeci.png"><br><br>  Make a container for the playing field and controls: <br><br><pre> <code class="javascript hljs">&lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"codewar__scale"</span></span> id=<span class="hljs-string"><span class="hljs-string">"codewar__scale"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"codewar__control control js-codewar__control"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"control__icon control__start"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">data-control</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"start"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"control__icon control__prev"</span></span> data-control=<span class="hljs-string"><span class="hljs-string">"prev"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"control__icon control__play"</span></span> data-control=<span class="hljs-string"><span class="hljs-string">"play"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"control__icon control__pause"</span></span> data-control=<span class="hljs-string"><span class="hljs-string">"pause"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"control__icon control__next"</span></span> data-control=<span class="hljs-string"><span class="hljs-string">"next"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"control__icon control__end"</span></span> data-control=<span class="hljs-string"><span class="hljs-string">"end"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt;</span></span></code> </pre><br>  We begin to describe the interface logic in js.  First, create a game object, write the basic properties and the initialization function into it. <br><br><pre> <code class="javascript hljs">game = { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: <span class="hljs-string"><span class="hljs-string">"https://codewar.firstvds.ru/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">quest_session_url</span></span>: <span class="hljs-string"><span class="hljs-string">"/quest/quest_get_session_id/"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// url  id   area: d3, play_status: false, current_step: 1, spinner: $('&lt;span&gt;').addClass('glyphicon glyphicon-cog isp-quest-spin'), members: { nexa: {}, john: {} }, init: function () { var gm = this; try { this.editor = ace.edit("editor"); this.editor.setTheme("ace/theme/twilight"); this.editor.session.setMode("ace/mode/javascript"); //         localstorage this.editor.on("input", function () { localStorage.setItem('codewar_code', gm.editor.getValue()); }); if (localStorage.getItem('codewar_code')) { gm.editor.setValue(localStorage.getItem('codewar_code')); } } catch (e) { console.log("ace editor error"); } //   api      this.getGameEnviroment().then(function (enviroment) { //     gm.enviroment = enviroment; gm.printGameScale(enviroment); //   gm.printGameBegin(enviroment); //  ,     gm.bindControlElements(); //      //gm.startWar(gm.editor.getValue()); }); } }</span></span></code> </pre><br>  Then draw a grid with d3: <br><br><pre> <code class="javascript hljs">printGameScale: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">enviroment</span></span></span><span class="hljs-function">) </span></span>{ d3 .select(<span class="hljs-string"><span class="hljs-string">'#codewar__scale'</span></span>) .selectAll(<span class="hljs-string"><span class="hljs-string">"*"</span></span>).remove(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> area = d3 .select(<span class="hljs-string"><span class="hljs-string">'#codewar__scale'</span></span>) .append(<span class="hljs-string"><span class="hljs-string">'svg'</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'class'</span></span>, <span class="hljs-string"><span class="hljs-string">'chart_area'</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'width'</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'height'</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"viewBox"</span></span>, <span class="hljs-string"><span class="hljs-string">"0 0 "</span></span> + (enviroment.scale.x + <span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">" "</span></span> + (enviroment.scale.y + <span class="hljs-number"><span class="hljs-number">1</span></span>)) ; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.area = area; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.area .insert(<span class="hljs-string"><span class="hljs-string">"rect"</span></span>) .classed(<span class="hljs-string"><span class="hljs-string">"codewar__arena"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"y"</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"width"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"height"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; enviroment.scale.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.area .append(<span class="hljs-string"><span class="hljs-string">"line"</span></span>) .classed(<span class="hljs-string"><span class="hljs-string">"codewar__grid"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x1"</span></span>, i + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x2"</span></span>, i + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"y1"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"y2"</span></span>, enviroment.scale.y + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) ; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; enviroment.scale.y + <span class="hljs-number"><span class="hljs-number">1</span></span>; j++) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.area .append(<span class="hljs-string"><span class="hljs-string">"line"</span></span>) .classed(<span class="hljs-string"><span class="hljs-string">"codewar__grid"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"y1"</span></span>, j + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"y2"</span></span>, j + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x1"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"x2"</span></span>, enviroment.scale.x + <span class="hljs-number"><span class="hljs-number">0.5</span></span>) ; } }</code> </pre><br>  Draw Nexu, John and infected cells: <br><br><pre> <code class="javascript hljs">printGameBegin: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">enviroment</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.members.nexa.svg = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.area .append(<span class="hljs-string"><span class="hljs-string">"svg:image"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'x'</span></span>, enviroment.nexa.beginPosition.x - <span class="hljs-number"><span class="hljs-number">0.25</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'y'</span></span>, enviroment.nexa.beginPosition.y - <span class="hljs-number"><span class="hljs-number">0.25</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'width'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'height'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"xlink:href"</span></span>, <span class="hljs-string"><span class="hljs-string">"/sites/all/modules/custom/isp_quest/game/images/ai.png"</span></span>) .classed(<span class="hljs-string"><span class="hljs-string">"codewar__nexa"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.members.john.svg = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.area .append(<span class="hljs-string"><span class="hljs-string">"svg:image"</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'x'</span></span>, enviroment.john.beginPosition.x - <span class="hljs-number"><span class="hljs-number">0.25</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'y'</span></span>, enviroment.john.beginPosition.y - <span class="hljs-number"><span class="hljs-number">0.25</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'width'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">'height'</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) .attr(<span class="hljs-string"><span class="hljs-string">"xlink:href"</span></span>, <span class="hljs-string"><span class="hljs-string">"/sites/all/modules/custom/isp_quest/game/images/user.png"</span></span>) .classed(<span class="hljs-string"><span class="hljs-string">"codewar__john"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enviroment.infection) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.infectCell(enviroment.infection[i].x, enviroment.infection[i].y); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.infectCell(enviroment.nexa.beginPosition.x, enviroment.nexa.beginPosition.y); }</code> </pre><br>  Bind the event buttons with jQuery, add motion animation and parse the results.  The article will not disassemble these parts, you can see the entire frontend code <a href="https://bitbucket.org/firstvds/codewar.frontend.public/src">here</a> . <br><br><img src="https://habrastorage.org/webt/i7/sf/pk/i7sfpkjoqwlgcyauzefzctbsjqs.png"><br><br><h2>  Testing and experimenting with AI behavior </h2><br><h3>  Backend testing </h3><br>  Our server is able to receive HTTP requests, we use this for a test api backend.  We will create the player code in a separate file and read it in the same way as the Nexa code. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> john_mind = fs.readFileSync(<span class="hljs-string"><span class="hljs-string">'./vm_scripts/john_script_test.js'</span></span>, <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>);</code> </pre><br>  For testing, we set ourselves the following tasks: <br><br><ul><li>  create infinite loops and check the script stop by timeout, </li><li>  check the inability to access external libraries from the sandbox, </li><li>  check the data record in the quest quest via api, </li><li>  let's load the server 1000 simultaneous tasks and see the CPU load, </li><li>  debug the format of the data provided, if required. </li></ul><br>  Having caught all the found bugs, making sure that the nodejs has sufficient performance on the selected vds server, let's proceed to the experiments. <br><br><h3>  Experiments with AI script </h3><br>  First, let's take the simplest version of the Nexa script and try to defeat it on the open field.  In our case, the first version of Nexa moved from the center to the left wall, then went up and rested against a corner.  The victory over such an opponent took on the strength of 5 minutes.  Then we made Nexu, which chases the player: always moves in the direction that is the shortest before him.  This AI was also very simple.  In the next iteration, an initially infected area was added.  There have already been difficulties, but after a couple of hours, they wrote a script that won such a Nexu.  In the last experiment, the pirate soul was added to the Nexus: she caught up with John, and after meeting him, she began to run away.  Initially we planned to add attack and defense to the characters.  But at this stage of testing, they realized that the game is already quite interesting and not the easiest.  Therefore, we decided to stop at this version of Nexa. <br><br><h3>  Summarizing </h3><br>  27 people reached our codewar game in the quest.  Among them, we identified the winners who wrote the most effective code.  The performance criterion was 2: the smallest number of moves for which John cleared all the cells and the shortest code. <br><br>  Among the solutions there were a variety of solutions, including brute force and partial brute force.  The winner was the player who wrote a script of 339 characters who coped with Nexa in 64 moves.  He showed an elegant js code, and we congratulated him on his victory.  The second place was taken by the player with 64 moves and 835 code symbols.  The third and fourth place was taken by a married couple, who had the same number of moves and the size of the code.  The solution methods differed only in the sequence of pre-recorded moves. <br><br><h3>  Conclusion </h3><br>  Creating a game is a very addictive and addictive process.  We made and launched the game for customers in 3 days.  Despite the fact that not so many quest participants reached the task for programmers, they showed great interest in our game on social networks and shared their code with each other.  We ourselves enjoyed developing the game and entertained our users quite well. </div><p>Source: <a href="https://habr.com/ru/post/349690/">https://habr.com/ru/post/349690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349676/index.html">Function and Functional Object</a></li>
<li><a href="../349682/index.html">How to save the charge of a smartphone?</a></li>
<li><a href="../349684/index.html">CoLaboratory: Conference ProContent</a></li>
<li><a href="../349686/index.html">Optimization of the PID controller settings by the integral criterion for the quality of regulation</a></li>
<li><a href="../349688/index.html">‚ÄúMuch can be solved by helping a startup and explaining what mistakes we have already made‚Äù - Interview with Leonid Igolnik</a></li>
<li><a href="../349692/index.html">QA at CodeFest: the future, iOS farms and backdoors</a></li>
<li><a href="../349694/index.html">Fintech Digest: blockchain legalization, reduction of branches in favor of IT</a></li>
<li><a href="../349698/index.html">Comparative analysis of physical and functional objects</a></li>
<li><a href="../349700/index.html">OWASP Automated Threat: Automated Web Application Threats</a></li>
<li><a href="../349704/index.html">We expand the bundle of Nginx + Php-Fpm + MySQL with magento2 on board and decompose it in containers in the Docker</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>