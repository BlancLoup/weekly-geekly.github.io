<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Blocks. The internal structure of the Cach√© database file. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As in the two previous parts ( part 1 , part 2 ), I continue to acquaint you with the internal structure of the Cach√© databases. This time I will talk...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Blocks. The internal structure of the Cach√© database file. Part 3</h1><div class="post__text post__text-html js-mediator-article">  As in the two previous parts ( <a href="http://habrahabr.ru/company/intersystems/blog/267951/">part 1</a> , <a href="http://habrahabr.ru/company/intersystems/blog/268195/">part 2</a> ), I continue to acquaint you with the internal structure of the Cach√© databases.  This time I will talk about what else you can find out and what my project <a href="https://github.com/daimor/CacheBlocksExplorer">Cach√© Blocks Explorer</a> can help with. <br><br> <a href=""><img src="https://habrastorage.org/files/a77/291/a3d/a77291a3d5a647ffa812a682453f226a.png"></a> <br><a name="habracut"></a><br>  I think many people thought that which is shown in the picture (clickable).  When I wanted to portray the fragmentation of globals, for me the prototype was various numerous disk defragmentation utilities.  And, I hope, I managed to make an equally useful product. <br><br>  This utility displays a block map.  Each square represents a block, and its color corresponds to a specific global, which is specified in the legend.  The block itself also shows how much it is filled with data, which allows you to create a visual representation of the filling of the database file.  The display of the global level blocks and the block map have not yet been implemented - they, like all empty blocks, will be displayed in white. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can select a database and the block map download will start right away.  Information is not loaded sequentially, but bypassing the tree of blocks, which may make it look something like the image below. <br><br><div class="spoiler">  <b class="spoiler_title">Gif</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/53c/5de/696/53c5de696d3448398b62b19c600e7a47.gif"></div></div><br>  We continue to work with the database that we used in the previous <a href="http://habrahabr.ru/company/intersystems/blog/268195/">article</a> .  I deleted all globals, we do not need them.  And it generated new data based on the Sample classes package from the SAMPLES area.  For this, I configured a mapping package to my HABR area. <br><br><div class="spoiler">  <b class="spoiler_title">Configure mapping</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/243/1de/a51/2431dea51fcc42d8b854fc0ec84d0025.png"></div></div><br>  Executed data generation command. <br><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">d</span></span> #<span class="hljs-selector-id"><span class="hljs-selector-id">#class</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Sample</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Utils</span></span>)<span class="hljs-selector-class"><span class="hljs-selector-class">.Generate</span></span>(20000)</code> </pre> <br>  The result on our map is: <br><br> <a href=""><img src="https://habrastorage.org/files/003/26f/cdd/00326fcdd5094c85af50f58c8ceccc63.png"></a> <br><br>  You can note that the blocks do not start filling from the very beginning of the file.  From the 16th block, the blocks of upper level pointers begin, and from the 50th data blocks.  16 and 50 are default values ‚Äã‚Äãand can be changed if desired.  The <i>NewGlobalPointerBlock</i> property in the <a href="">SYS.Database</a> class is responsible for starting the block of pointers; this property sets the default value for new globals.  For already created globals, you can change it in to the <a href="">% Library.GlobalEdit</a> class via the <i>PointerBlock</i> property.  The block from which data blocks will begin is specified in the <i>NewGlobalGrowthBlock</i> property of the <i>SYS.Database</i> class, for a single global, this <i>GrowthBlock</i> property in the <a href="">% Library.GlobalEdit</a> class.  It makes sense to change these values ‚Äã‚Äãonly for those globals that do not yet have data, because changing this property does not affect the current location of the block of upper pointers or data blocks. <br><br>  Here we see that we have the most data in the global <b>^ Sample.PersonD</b> with 989 blocks of 83% filling.  In second place <b>^ Sample.PersonI</b> 573 blocks, and this global is already filled by 70%.  We can select any global we are interested in to see exactly which blocks are involved under this global.  And for the global ^ Sample.PersonI, we can see that some of the blocks are almost empty.  It is also clear that the blocks of these two globals are mixed.  This is understandable, because when creating new objects both globals are filled: one with data, the other with indices to the Sample.Person table. <br><br> <a href=""><img src="https://habrastorage.org/files/f46/414/e0b/f46414e0b42c4be8a39be1c23e1dda65.png"></a> <br><br>  Now that we have test data, we can look at the possibilities of manipulating the database that Cach√© provides us and see the result in a vivid way.  To begin with, we will do a small purge in the data in order to create some visibility of activity, when the data can not only be added but also deleted.  Therefore we will execute the code which will delete some random data. <br><br><pre> <code class="hljs sql"> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>(^Sample.PersonD(<span class="hljs-string"><span class="hljs-string">""</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>(^Sample.PersonD(<span class="hljs-string"><span class="hljs-string">""</span></span>),<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">first</span></span>:$random(<span class="hljs-number"><span class="hljs-number">5</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">last</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">##class(Sample.Person).%DeleteId(id) }</span></span></code> </pre> <br>  After running this code, we got the result, which can be seen below.  There were several empty blocks, the blocks are now filled to 64-67%. <br><br> <a href=""><img src="https://habrastorage.org/files/cbb/bbf/db3/cbbbbfdb32454d2b955a4573ac4d34d2.png"></a> <br><br>  To work with the database, we have the opportunity to use the <a href="">^ DATABASE</a> utility in the% SYS area.  We use some of its features. <br><br><img src="https://habrastorage.org/files/79f/4d4/9ba/79f4d49ba79a4a41a7c1d470d98f94fa.png"><br><br>  To begin with, since we have blocks with a small filling, we will compress all globals in the database and look at the result. <br><br><img src="https://habrastorage.org/files/987/afe/6d0/987afe6d0a494b5b9f338d0126e94999.png"><br><br> <a href=""><img src="https://habrastorage.org/files/e6e/35f/f22/e6e35ff2286142a39b1fb0e71b06c90c.png"></a> <br><br>  As you can see, as a result of the compression of globals, we received the requested 90% fill, or values ‚Äã‚Äãclose to this.  As a result of compression, it also turned out that previously empty blocks are now filled with data transferred from other blocks.  Compression of all globals in the database can be done using the <a href="">^ DATABASE</a> utility (item 7), or by executing the following command, passing the first parameter to the database path: <br><br><pre> <code class="hljs tex">d ##class(SYS.Database).CompactDatabase("c:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intersystems</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ensemble</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mgr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">habr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>)</code> </pre> <br>  It is also possible to move empty blocks to the end of the database.  Such a need may arise, for example, if we delete a large portion of data, and we want to subsequently reduce the size of the database file.  To demonstrate this, repeat the deletion of data from our database.  That's what I did after the removal. <br><br><div class="spoiler">  <b class="spoiler_title">Code example</b> <div class="spoiler_text">  Here I delete random chunks of data in order to form empty blocks. <br><br><pre> <code class="hljs sql"> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> gn=$<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>(^Sample.PersonD) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">first</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>(@gn@(<span class="hljs-string"><span class="hljs-string">""</span></span>),<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">last</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>(@gn@(<span class="hljs-string"><span class="hljs-string">""</span></span>),<span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=$random(<span class="hljs-keyword"><span class="hljs-keyword">last</span></span>)+<span class="hljs-keyword"><span class="hljs-keyword">first</span></span> write !,<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=$<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>(@gn@(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)) quit:<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">##class(Sample.Person).%DeleteId(id) quit:$increment(count)&gt;1000 } }</span></span></code> </pre> </div></div><br> <a href=""><img src="https://habrastorage.org/files/610/a8e/0b7/610a8e0b7f514b75b002a63c5f2703f0.png"></a> <br><br>  Here we see the appearance of empty blocks.  Cach√© provides the ability to move these empty blocks to the end of the database file, and further it is possible to reduce the size of the database.  In order to move empty blocks, we will run the FileCompact method from the <a href="">SYS.Database</a> class in the system area, or with the help of the <a href="">^ DATABASE</a> utility item 13. This method takes three parameters: the path to the database, the desired amount of free space at the end of the file (default is 0 ), and the return parameter is how much free space is obtained. <br><br><pre> <code class="hljs tex">do ##class(SYS.Database).FileCompact("c:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intersystems</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ensemble</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mgr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">habr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>,999)</code> </pre> <br>  And that's what happened with us, we now have no voids, the voids in the beginning are not counted, because they correspond to the settings (where to start blocks of top-level pointers and data blocks). <br><br> <a href=""><img src="https://habrastorage.org/files/a01/284/6f9/a012846f9cfa4c019df2524a768450cc.png"></a> <br><h2>  Defragmentation </h2><br>  Now we can go on to defrag our globals.  This process will rearrange the blocks of each global in order.  In the process of the utility may require free space at the end of the database file, and if necessary it will be added.  You can defragment using the <a href="">^ DATABASE</a> utility item 14, or with the following command: <br><br><pre> <code class="hljs tex">d ##class(SYS.Database).Defragment("c:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intersystems</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ensemble</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mgr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">habr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>)</code> </pre> <br> <a href=""><img src="https://habrastorage.org/files/a38/65d/87b/a3865d87b0cd47d6ab9d06ff5d150630.png"></a> <br><br><h2>  Free up space </h2><br>  Now we see all our globals lined up in turns.  But for defragmentation, all the same it took to increase free space in the database file.  And we can free this place using paragraph 12 in the <a href="">^ DATABASE</a> utility or with the command: <br><br><pre> <code class="hljs tex">d ##class(SYS.Database).ReturnUnusedSpace("c:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intersystems</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ensemble</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">mgr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">habr</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">"</span></span></span></span>)</code> </pre> <br> <a href=""><img src="https://habrastorage.org/files/4f7/4b4/efe/4f74b4efed0142759fb5f0b7820a777e.png"></a> <br><br>  Now our database takes up much less space, and only 1MB of free space remains in the database file.  The ability to defragment globals in the database and manage free space by moving and freeing free blocks appeared relatively recently.  Previously, if you need to defragment and reduce the size of the database file, you had to use the <a href="">^ GBLOCKCOPY</a> utility.  It performed block-by-copy from one database to another newly created one, with the ability to select specific globals.  This utility is still available. </div><p>Source: <a href="https://habr.com/ru/post/268587/">https://habr.com/ru/post/268587/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268577/index.html">Robonoch -2015</a></li>
<li><a href="../268579/index.html">Review TEKON SCADA</a></li>
<li><a href="../268581/index.html">Potentially, up to 1 million ‚Äúlive‚Äù VK.com accounts have been compromised by attackers.</a></li>
<li><a href="../268583/index.html">Supervisord and forever are no longer needed. Systemd</a></li>
<li><a href="../268585/index.html">Go Benchmarks</a></li>
<li><a href="../268593/index.html">Huawei and NTT DOCOMO successfully tested 5G technology in the field</a></li>
<li><a href="../268597/index.html">Mobile communications in Europe</a></li>
<li><a href="../268599/index.html">Enable HTTP / 2 in NGINX for the site</a></li>
<li><a href="../268605/index.html">Primary key - GUID or autoincrement? Part two</a></li>
<li><a href="../268607/index.html">Volker Simonis - Interiors of SAP JVM [Meeting JUG in St. Petersburg]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>