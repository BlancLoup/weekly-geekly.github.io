<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>AnyConnect and Address Space Intersection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi habr! In this article I would like to discuss the topic of intersection of address spaces when providing access to remote users. I will consider re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>AnyConnect and Address Space Intersection</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/341/d8f/cfd/341d8fcfdb044bb0a4839fbdd8cacf40.jpg"><br><br>  Hi habr!  In this article I would like to discuss the topic of intersection of address spaces when providing access to remote users.  I will consider remote access using Cisco AnyConnect VPN client.  As a VPN hub, consider the Cisco ASA.  The examples described in this article have been configured on the ASA5505 with software version 9.1 (6) 6.  The used version of the Anyconnect client is 4.1.  Personal computers with Windows 7 and 8.1 operating systems were used as VPN client devices. <a name="habracut"></a><br><br>  Many employees who want to work remotely, use SOHO routers to connect to the Internet at home, and very often the routers are installed with factory settings.  And, as is well known, in most cases the factory settings assume a LAN subnet of 192.168.0.0/24 or 192.168.1.0/24.  As practice shows, the probability of having a company‚Äôs 192.168.0.0/24 and 192.168.1.0/24 networks in the central office (the CO) is high.  It turns out the intersection of address spaces.  In this note I will consider three options for setting up connections to the CO through AnyConnect, highlight the pros and cons of each option and describe how access will work if the address spaces intersect. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <u><b>The first option</b></u> is the easiest.  It consists in the rejection of Split tunneling (as we remember, Split tunneling allows you to specify which traffic should be wrapped in a tunnel, and which should not).  In this case, absolutely all traffic is wrapped in a VPN tunnel.  This behavior is configured by the <i>split-tunnel-policy tunnelall directive</i> in the VPN connection group policy.  When Split tunneling is disabled, the route to the local network disappears from the routing table of the connected device and a new default route with the best metric appears.  Below are examples of output <i>print route of a</i> windows-based computer to the established VPN connection and after connecting: <br><br><img src="https://habrastorage.org/files/56f/b1a/fec/56fb1afec5a64b8caf1ad2db4feac635.png"><br><br><img src="https://habrastorage.org/files/f1e/003/990/f1e003990b6c441590307a1102db2cf4.png"><br><br>  At the same time, we can organize Internet access for the connected device only through the Internet channel of the office to which the user has connected.  Note that with the configured access to the Internet through the CO, the channel will be utilized twice as much by the remote user traffic. <br><br>  To configure Internet access for remote connections on the Cisco ASA, just enough to observe two nuances.  The first caveat is to correctly configure dynamic nat | pat for the pool of addresses issued by AnyConnect.  An example of setting nat: <br><br><pre><code class="python hljs">object network anyconnect-pool subnet <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.248</span></span> nat (outside,outside) dynamic interface</code> </pre> <br>  The second caveat is to remember to enable the same-security-traffic option to permit intra-interface. <br>  This option allows packets to leave the same interface to which traffic was received. <br><br>  Pluses of the first option: <br><ul><li>  Easy setup; </li><li>  Uniform behavior for all remote users regardless of the network settings of the connected device. </li></ul><br>  Disadvantages of the first option: <br><ul><li>  The need to configure Internet access for connected users via the Internet channel DH, and, as a consequence, double utilization of the channel DH Internet traffic of the remote user; </li><li>  The connected device loses access to its own local network.  For example, a network printer or network storage in the local network becomes unavailable to the user during the AnyConnect session. </li></ul><br>  The above disadvantages are relevant absolutely for all remote users.  Even if the user has a local network different from corporate networks and the intersection of address spaces does not occur.  Anyway, all user traffic will be tunneled during the AnyConnect session. <br><br>  <u><b>The second option</b></u> is to use Split tunneling policies.  Split tunneling policies come in two forms: Split Include and Split Exclude.  In the first case, you need to specify which networks need to be tunneled, in the second - on the contrary, it indicates which networks do not need to be wrapped in a tunnel. <br><br>  In our experience, Split Include is used most often.  In this case, you need to configure the access list, which will determine which networks you need to tunnel.  Setup Example: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   object network subnet1 subnet 192.168.0.0 255.255.255.0 object network subnet2 subnet 192.168.1.0 255.255.255.0 object-group network enterprise network-object object subnet1 network-object object subnet2 #    access-list acl-split-tunnel extended permit ip object-group enterprise any #   Split tunneling Split Include          group-policy GroupPolicy1 attributes split-tunnel-policy tunnelspecified split-tunnel-network-list value acl-split-tunnel tunnel-group TEST general-attributes default-group-policy GroupPolicy1</span></span></code> </pre><br>  In the case of intersection of address spaces, the remote user simply loses access to his local network.  That is, if the user has a local network of 192.168.0.0/24 or 192.168.1.0/24, the traffic to the hosts of these networks will be wrapped in a tunnel.  At the same time, the Internet access for the remote user will remain through the local Internet provider.  In our experience, this setting suits users in most cases. <br><br>  Split Tunneling of the Split Exclude type, on the contrary, allows remote users to maintain access to their own local network in any case.  Of course, in the case of intersection of address spaces, access to the conflict DH network will not work.  Below is an example of setting up Split Exclude.  In this case, we will include networks that do not need to tunnel into the access list.  In the example, we will not tunnel public address ranges (this will provide access to the Internet using a local Internet provider), nor will we tunnel a network of the type 0.0.0.0/255.255.255.255, which describes the client's local network in the ASA settings.  Network recording 0.0.0.0/255.255.255.255 helps to achieve universality: no matter what kind of network the user is local, access to it will always work. <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     object network range1 range 0.0.0.0 9.255.255.255 object network range2 range 11.0.0.0 172.15.255.255 object network range3 range 172.32.0.0 192.167.255.255 object network range4 range 192.169.0.0 255.255.255.255 object-group network net-exclude-RFC1918 network-object object range1 network-object object range2 network-object object range3 network-object object range4 #    access-list acl-exclude-tunnel extended permit ip object-group net-exclude-RFC1918 any access-list acl-exclude-tunnel extended permit ip host 0.0.0.0 any #  ‚Äúhost 0.0.0.0‚Äù   ‚Äú0.0.0.0 255.255.255.255‚Äù #   Split tunneling Split Exclude          group-policy GroupPolicy1 attributes split-tunnel-policy excludespecified split-tunnel-network-list value acl-exclude-tunnel tunnel-group TEST general-attributes default-group-policy GroupPolicy1</span></span></code> </pre><br>  However, in order for the user's access to his own local network to work, you need to remember one more nuance.  In the settings of the Anyconnect client, the Allow local (LAN) access option must be explicitly specified: <br><br><img src="https://habrastorage.org/files/ec7/0cf/2da/ec70cf2da9ad429c86ab151e22ae7679.png"><br><br>  This option can be set centrally in the Anyconnect client profile settings on the Cisco ASA: <br><br><img src="https://habrastorage.org/files/3e6/6bb/a9c/3e66bba9c1774d0baba758391f1ebd6f.png"><br><br>  The advantages of the second option: <br><ul><li>  Internet access can be configured through a local provider.  Here I would like to make a reservation: to ensure the maximum level of security, it is recommended to organize remote users accessing the Internet through corporate gateways, ITU and web proxy servers.  But in practice, many neglect this requirement; </li><li>  For users who have no intersection of address spaces with the CO, access to the local network works without problems. </li></ul><br>  The disadvantages of the second option: <br><ul><li>  For users who have the intersection of address spaces with the CO, access to the local network is lost.  Split Exclude helps to avoid loss of access to the local network, but in this case access to the conflicting DH network will be lost. </li></ul><br>  <b><u>The third option</u></b> is to use Split tunneling policies and NAT rules.  When the network engineer hears the phrase ‚Äúintersection of address spaces,‚Äù probably the first thing that comes to mind is to resolve the conflict with the help of network address translation.  Consider how this can be configured on the ASA in the case of connecting remote users. <br><br>  Suppose our task is to organize access in such a way that even users who have the intersection of the address space always have access to both the conflicting DH network and their own local area network.  To do this, we need to transmit the conflicting DH network to another network for remote users.  For example, a conflict network 192.168.1.0/24.  Configure the broadcast of the entire network 192.168.  <b>1</b> .0 / 24 to some other network 192.168.  <b>25</b> .0 / 24.  Then remote users wishing to connect to the host in the CO with the address, for example, 192.168.  1.10, they will have to use the translated address 192.168 for the connection.  <b>25</b> .10.  On the ASA, the construction described can be configured using the twice NAT rules as follows: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    object network net-1 subnet 192.168.1.0 255.255.255.0 # ,        object network net-25 subnet 192.168.25.0 255.255.255.0 #  ,     Anyconnect object network anyconnect-pool subnet 192.168.3.64 255.255.255.248 #  .       ,        nat (inside,outside) source static net-1 net-25 destination static anyconnect-pool anyconnect-pool no-proxy-arp</span></span></code> </pre><br>  Of course, working with IP addresses for end users is not convenient.  Especially in the case described, you will have to remember that in order to get to the host 192.168.1.10, you need to use the address 192.168.25.10 (that is, you already have to remember two IP addresses).  DNS and DNS doctoring on ASA comes to the rescue.  DNS doctoring allows you to change the IP address in DNS responses in accordance with the rules of NAT.  An example of DNS Doctoring is shown in the figure below: <br><br><img src="https://habrastorage.org/files/160/2a5/c31/1602a5c31ee046039328462001e1e0a4.png"><br><br>  In this example, the <i>Application Server</i> with the internal IP address 10.1.1.100 is published on the Internet at the public address 198.51.100.100.  On the corporate DNS server there is an A-record for the resource of this server www.  abc.ru A Rcrd = 10.1.1.100.  The DNS doctoring feature enabled on the ASA causes the A record to automatically change when the DNS response passes through the ASA.  In the DNS response, the internal IP address of the server is replaced with the public IP address accessible from the Internet. <br><br>  <u><i>Note 1</i></u> : to use the DNS doctoring feature on the ASA, DNS inspection must be enabled: <br><br><pre> <code class="python hljs">policy-map global_policy <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inspection_default</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">inspect</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dns</span></span></span></span></code> </pre> <br>  <u><i>Note 2</i></u> : To use the DNS doctoring feature, the VPN client must use an internal corporate DNS server (located behind the ASA). <br><br>  On the ASA, when setting up DNS doctoring there is a nuance.  DNS doctoring cannot always be configured in the Twice NAT rule.  The <i>dns</i> option in the NAT rule becomes unavailable once the <i>destination static</i> directive appears after <i>source</i> <i>static</i> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     destination static,  dns  nat (inside,outside) source static net-1 net-25 ? configure mode commands/options: description Specify NAT rule description destination Destination NAT parameters # DNS doctoring   dns Use the created xlate to rewrite DNS record inactive Disable a NAT rule no-proxy-arp Disable proxy ARP on egress interface route-lookup Perform route lookup for this rule service NAT service parameters unidirectional Enable per-session NAT &lt;cr&gt; #    destination static  dns  nat (inside,outside) source static net-1 net-25 destination static anyconnect-pool anyconnect-pool ? configure mode commands/options: description Specify NAT rule description inactive Disable a NAT rule net-to-net Net to net mapping of IPv4 to IPv6 no-proxy-arp Disable proxy ARP on egress interface route-lookup Perform route lookup for this rule service NAT service parameters unidirectional Enable per-session NAT &lt;cr&gt;</span></span></code> </pre><br>  This behavior is documented on <a href="http://www.cisco.com/c/en/us/support/docs/security/asa-5500-x-series-next-generation-firewalls/115753-dns-doctoring-asa-config.html">the Cisco website</a> . <br><br>  If we do not use <i>destination static</i> , the conflicting AC network 192.168.1.0/24 will be broadcast to the new network 192.168.25.0/24 always, and not just for remote employees.  This behavior is not acceptable.  To prevent this from happening, we need to put the rule of translation of the conflicting network at the end of the NAT rules.  In this case, the higher translation rules concerning the conflict network, we must upgrade in such a way that the rules always work, except in the case of data exchange with remote users.  In this case, the order of the rules of NAT is crucial, therefore, very briefly recall the order of NAT rules for ASA version IOS 8.3 and higher.  NAT rules are executed in the order of three sections: <br><br>  Section 1. Twice NAT in Configuration Order <br><br>  Section 2. Network Object NAT <br><ol><li>  Static </li><li>  Dynamic <br><ul><li>  First, where there are less IP addresses to broadcast </li><li>  Low IP numbers first </li><li>  By alphabet (by name Obj gr) </li></ul><br></li></ol>  Section 3. Twice NAT after auto in order of configuration <br><br>  I will give an example.  To organize access to the Internet from a conflicting DH network, as a rule, the corresponding rule is required dynamic nat | pat.  If dynamic nat | pat is configured using Network Object Nat, you will have to modify the setting for the Twice NAT type.  This is necessary in order to be able to add the <i>destination static</i> directive to the rule (we get the so-called Policy NAT).  The dynamic pat rule must be set above the nat rule for remote users.  This can be done in different ways: specify the position of the rules explicitly in section 1, transfer the nat rule for remote users to section 3 after auto, etc.  Setup Example: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#     object network range1 range 0.0.0.0 9.255.255.255 object network range2 range 11.0.0.0 172.15.255.255 object network range3 range 172.32.0.0 192.167.255.255 object network range4 range 192.169.0.0 255.255.255.255 object-group network net-exclude-RFC1918 network-object object range1 network-object object range2 network-object object range3 #   dynamic pat #  dynamic pat         nat (inside,outside) 1 source dynamic net-1 interface destination static net-exclude-RFC1918 net-exclude-RFC1918 #     192.168.1.0/24  192.168.25.0/24   dynamic pat #     dns nat (inside,outside) 2 source static net-1 net-25 dns no-proxy-arp</span></span></code> </pre><br>  If we use Split tunneling of the Split Include type, do not forget to specify the translated net-25 network in the corresponding access list: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#    access-list acl-split-tunnel extended permit ip object-group net-25 any #   Split tunneling Split Include          group-policy GroupPolicy1 attributes split-tunnel-policy tunnelspecified split-tunnel-network-list value acl-split-tunnel tunnel-group TEST general-attributes default-group-policy GroupPolicy1</span></span></code> </pre><br>  The advantages of the third option: <br><ul><li>  All the benefits of using Split Tunneling are inherent in the third option; </li><li>  For users who have the intersection of address spaces with the CO, it is possible to get access to the conflict network of the CO, while maintaining access to their own local network. </li></ul><br>  The disadvantages of the third option: <br><ul><li>  The complexity of the configuration.  When using DNS doctoring, it is necessary to modify the address translation rules for conflicting networks. </li></ul><br>  <b>Conclusion</b> <br><br>  In this article, I looked at three options for configuring remote user connections using the Cisco Anyconnect client to the Cisco ASA ITU: <br><ul><li>  no split tunneling; </li><li>  using Split Tunneling of two types: Split Include and Split Exclude; </li><li>  using Split Tunneling in conjunction with NAT rules and the DNS doctoring option. </li></ul><br>  For each option, I tried to consider the work of remote access in case of intersection of address spaces and highlight the features of each option. <br><br>  Waiting for your comments.  Maybe someone can share their experience or another way to solve the problem of intersection of address spaces. </div><p>Source: <a href="https://habr.com/ru/post/275517/">https://habr.com/ru/post/275517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275507/index.html">Search for a variety of regular expressions using the Hyperscan library</a></li>
<li><a href="../275509/index.html">Used servers as a reasonable alternative</a></li>
<li><a href="../275511/index.html">Using Kanban to Prepare Scrum Backlog</a></li>
<li><a href="../275513/index.html">Docker: Environment for testing</a></li>
<li><a href="../275515/index.html">Gradle: managing dependencies</a></li>
<li><a href="../275519/index.html">Icons in the bookmarks bar and the weight of everything in the assembly Vivaldi 1.0.375.3</a></li>
<li><a href="../275521/index.html">Mocks, fakes and stubs in C ++</a></li>
<li><a href="../275525/index.html">Corporate Laboratories 2016 - practical training in the field of information security</a></li>
<li><a href="../275527/index.html">What should we build the Zhegalkin polynomial ...</a></li>
<li><a href="../275529/index.html">NEMA Encryption Machine</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>