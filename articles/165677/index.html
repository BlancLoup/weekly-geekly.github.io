<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ViBe - background subtraction algorithm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 A couple of years ago, in the process of executing one project related to the selection and maintenance of moving objects, many backgroun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ViBe - background subtraction algorithm</h1><div class="post__text post__text-html js-mediator-article"><h5>  Prehistory </h5><br>  A couple of years ago, in the process of executing one project related to the selection and maintenance of moving objects, many background subtraction algorithms were scanned, and in the end one of the most interesting was the one that will be discussed further.  Its main drawback is a bunch of patents by which it is protected.  But one of the undoubted advantages - the presence of a library under Linux, which is allowed to use in non-commercial projects.  On the <a href="http://www2.ulg.ac.be/telecom/research/vibe/">page</a> with its description you can find this very library, as well as demo-programs for Windows and Android, links to patents (where you can find the basic descriptions of the algorithm), and other interesting information. <br><a name="habracut"></a><br><br><img src="https://habrastorage.org/storage2/241/f47/6ce/241f476ce4f5066e3dcbebe14162b22c.jpg" alt="image"><br><br><h5>  Use of the algorithm </h5><br>  An example of use is in the library header file.  For grayscale image: <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"vibe-background.h"</span></span></span><span class="hljs-meta"> int main(int argc, char **argv){ </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   ViBe vibeModel_t *model = libvibeModelNew(); // stride -  ,     uint8_t *image_data = acquire_image(stream); int32_t width = get_image_width(stream); int32_t height = get_image_height(stream); int32_t stride = get_image_stride(stream); //     uint8_t *segmentation_map = malloc(stride * height); //     libvibeModelAllocInit_8u_C1R(model, image_data, width, height, stride); //     //   -  segmentation_map while(!finished(stream)){ image_data = acquire_image(stream); libvibeModelUpdate_8u_C1R(model, image_data, segmentation_map); } //   libvibeModelFree(model); }</span></span></span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  His insides </h5><br>  Next will be the most interesting.  The developers did not show the source code of the library, but if there is a description from the patent, the h-file and the library, a couple of nights of time and several liters of coffee are enough to parse it. <br>  So, how it works. <br><br>  The vibeModel_t structure: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> u8b *samples; u32b numberOfSamples; u32b sizeOfSample; } pixel; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> pixel *pixels; u32b width; u32b height; u32b stride; u32b numberOfSamples; u32b matchingThreshold; u32b matchingNumber; u32b updateFactor; } vibeModel; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> vibeModel vibeModel_t;</code> </pre><br><br>  What is the reason here - it will be further clear from the algorithm. <br>  Create a model, set default values ‚Äã‚Äãand initialize random. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">vibeModel *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">libvibeModelNew</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ vibeModel *model = (vibeModel*)<span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(vibeModel)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (model) { model-&gt;numberOfSamples = <span class="hljs-number"><span class="hljs-number">20</span></span>; model-&gt;matchingThreshold = <span class="hljs-number"><span class="hljs-number">20</span></span>; model-&gt;matchingNumber = <span class="hljs-number"><span class="hljs-number">2</span></span>; model-&gt;updateFactor = <span class="hljs-number"><span class="hljs-number">16</span></span>; } u32b seed = time(<span class="hljs-number"><span class="hljs-number">0</span></span>); srand(seed); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model; }</code> </pre><br><br>  Further, in order not to write a lot of code here, suppose that we have some function <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">u32b </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRandPixel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u8b *image_data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b height, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b stride, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b y)</span></span></span></span>;</code> </pre><br>  which returns the value of a randomly selected pixel near the [xy] pixel.  Then the model initialization looks like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">s32b </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">libvibeModelAllocInit_8u_C1R</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vibeModel *model, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u8b *image_data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b height, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u32b stride)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!model || !image_data || !width || !height || !stride || (stride&lt;width)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    model-&gt;width = width; model-&gt;height = height; model-&gt;stride = stride; //      model-&gt;pixels = 0; model-&gt;pixels = (pixel*)calloc(model-&gt;width*model-&gt;height, sizeof(pixel)); if (!model-&gt;pixels) return 1; //          . for (u32b i=0; i &lt; model-&gt;width*model-&gt;height; i++) { model-&gt;pixels[i].numberOfSamples=model-&gt;numberOfSamples; model-&gt;pixels[i].sizeOfSample = 1; model-&gt;pixels[i].samples = 0; model-&gt;pixels[i].samples = (u8b*)calloc(model-&gt;numberOfSamples,sizeof(u8b)); if (!model-&gt;pixels[i].samples) return 1; } //  . //   .           , //       . u32b n=0; for (u32b j=0; j &lt; model-&gt;height; j++) { for (u32b i=0; i &lt; model-&gt;width; i++) { model-&gt;pixels[n].samples[0] = image_data[i+j*stride]; for (u32b k=1; k &lt; model-&gt;numberOfSamples; k++) model-&gt;pixels[n].samples[k] = getRandPixel(image_data, width, height, stride, i, j); n++; } } return 0; }</span></span></code> </pre><br><br>  The model is ready.  The libvibeModelAllocInit_8u_C3R function is arranged in a similar way, but each sample contains not one byte, but three. <br>  This is followed by the very subtraction of the background and the updating of its model.  To begin, consider the function of comparing one pixel with a background model, it is arranged as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// pix_data -   // pixel -     vibeModel s32b comparePixel(u8b pix_data, pixel *pixel, u32b matchingThreshold, u32b matchingNumber) { u32b matchingCounter=0; //     for (u32b i=0; i&lt;pixel-&gt;numberOfSamples; i++) { if (abs((s32b)pix_data-(s32b)pixel-&gt;samples[i]) &lt; matchingThreshold) { //         MatchingNumber, //  ,         matchingCounter++; if (matchingCounter &gt;= matchingNumber) return 1; } } return 0; }</span></span></code> </pre><br><br>  Still need a function <br><pre> <code class="cpp hljs">updateModel(vibeModel *model, u8b pix_data, u32b width, u32b height, u32b stride, u32b x, u32b y);</code> </pre><br>  which, like getRandPixel (...), is long and simple, so I don‚Äôt cite the code.  It does the following: when called, with a probability of 1 / model-&gt; updateFactor, writes the pix_data value to a randomly selected sample of the [x, y] pixel model, and also to one of the samples of the adjacent pixel (also random). <br><br>  And finally, the main function: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">s32b </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">libvibeModelUpdate_8u_C1R</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vibeModel *model, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> u8b *image_data, u8b *segmentation_map)</span></span></span><span class="hljs-function"> </span></span>{ s32b ad = model-&gt;stride - model-&gt;width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!model || !image_data || !segmentation_map) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (model-&gt;stride &lt; model-&gt;width) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; u32b n=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (u32b j=<span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; model-&gt;height; j++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (u32b i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; model-&gt;width; i++) { <span class="hljs-comment"><span class="hljs-comment">//      if (comparePixel(image_data[n], &amp;(model-&gt;pixels[n]), model-&gt;matchingThreshold, model-&gt;matchingNumber)) { //    -      segmentation_map[n] = 0; updateModel(model, image_data[n], model-&gt;width, model-&gt;height, model-&gt;stride,i,j); } else { //    segmentation_map[n] = 0xFFU; } n++; } if (model-&gt;stride &gt; model-&gt;width) n+=ad; } return 0; }</span></span></code> </pre><br>  For libvibeModelUpdate_8u_C3R, everything is again the same. <br><br><h5>  General impressions </h5><br>  The algorithm turned out to be quite simple and one of the fastest among those that we managed to try (among those who have at least some adaptability to the background and its gradual changes, of course).  Interested recommend <a href="http://www2.ulg.ac.be/telecom/research/vibe/download.html">downloading a</a> test program and independently evaluate it on any avi'shke. </div><p>Source: <a href="https://habr.com/ru/post/165677/">https://habr.com/ru/post/165677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165663/index.html">Optimization of LIKE expression when using Sqlite in iOS application</a></li>
<li><a href="../165667/index.html">Little Brave Arkanoid (Part 1 - IwGl)</a></li>
<li><a href="../165669/index.html">Simulate dark-eye adaptation in 3D, or HDR for dummies</a></li>
<li><a href="../165671/index.html">Mass publication of online journal articles in memory of Aaron Schwarz</a></li>
<li><a href="../165675/index.html">Results 24pullrequests</a></li>
<li><a href="../165681/index.html">Flyme 2.0 Review</a></li>
<li><a href="../165683/index.html">Where the hashCode legs grow</a></li>
<li><a href="../165695/index.html">Testing server 1C, DBMS MSSQL2008 on Windows 2008 OS on IBM x3650 M3 with 1 processor</a></li>
<li><a href="../165697/index.html">Adapting a website for users with disabilities is not difficult.</a></li>
<li><a href="../165699/index.html">Online IDE ShiftEdit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>