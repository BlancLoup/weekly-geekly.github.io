<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Errors found in Visual C ++ 2012 libraries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the methods for detecting errors in programs is static code analysis. We are pleased that this methodology is becoming increasingly popular. In...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Errors found in Visual C ++ 2012 libraries</h1><div class="post__text post__text-html js-mediator-article">  One of the methods for detecting errors in programs is static code analysis.  We are pleased that this methodology is becoming increasingly popular.  In many ways, this contributes to Visual Studio, in which static analysis is one of many features.  This functionality is easy to try and start using regularly.  When a person understands that he likes static code analysis, we are pleased to offer him a professional analyzer PVS-Studio for C / C ++ / C ++ 11 languages. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Visual Studio development environment allows static code analysis.  This analysis is extremely useful and easy to use.  However, it should be understood that Visual Studio performs a huge number of functions.  This means that a single function always loses to specialized tools.  The functions of refactoring and coloring code lose compared to Visual Assist.  The function for inline image editing is naturally worse than Adobe Photoshop or CorelDRAW.  The situation is similar with the static code analysis function. <br><br>  We will not theorize.  Let's go to practice.  Let's see what we managed to notice interesting by the PVS-Studio analyzer in the folders of Visual Studio 2012. <br><br>  In fact, we did not plan to check the source files included in Visual Studio.  Everything happened by chance.  In Visual Studio 2012, due to the support of the new C ++ standard, many header files have been modified.  The task was to make sure that the PVS-Studio analyzer is able to process the header files included in it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unexpectedly, we noticed several errors in the header * .h files.  We decided to study the files included in Visual Studio 2012 in more detail. Namely, such folders as: <br><ul><li>  Program Files (x86) \ Microsoft Visual Studio 11.0 \ VC \ include </li><li>  Program Files (x86) \ Microsoft Visual Studio 11.0 \ VC \ crt </li><li>  Program Files (x86) \ Microsoft Visual Studio 11.0 \ VC \ atlmfc </li></ul><br>  There was no complete validation, as we have no projects or make-files for building libraries.  So, it was possible to check only the modest part of the library code.  Despite the incompleteness of the test, the results are very interesting. <br><br>  Let's see what the PVS-Studio analyzer found inside the libraries for Visual C ++.  As you can see, all these errors leaked past the analyzer built into Visual C ++ itself. <br><br><h2>  Some of the suspicious sites found </h2><br>  We will not claim that all the code snippets below contain errors.  We simply chose from the list of places suggested by the PVS-Studio analyzer that seem to be the most suspicious. <br><br><h3>  Strange cycle </h3><br>  This suspicious code was found first.  He served as the impetus for the continuation of the study. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ATL_NO_VTABLE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CUtlProps</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CUtlPropsBase { .... <span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetIndexOfPropertyInSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(ULONG ul=<span class="hljs-number"><span class="hljs-number">0</span></span>; ul&lt;m_pUPropSet[*piCurSet].cUPropInfo; ul++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( dwPropertyId == pUPropInfo[ul].dwPropId ) *piCurPropId = ul; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_OK; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_FALSE; } .... };</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0228/">V612</a> An unconditional 'return' within a loop.  atldb.h 4829 <br><br>  The body of the loop is executed only once.  Error in the explanation does not need.  Most likely, the operator 'return' should be called when the desired value is found.  In this case, the code should look like this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(ULONG ul=<span class="hljs-number"><span class="hljs-number">0</span></span>; ul&lt;m_pUPropSet[*piCurSet].cUPropInfo; ul++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( dwPropertyId == pUPropInfo[ul].dwPropId ) { *piCurPropId = ul; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> S_OK; } }</code> </pre> <br><h3>  Suspicious projection </h3><br>  I apologize for the hard to read example.  Pay attention to the condition in the ternary operator. <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// TEMPLATE FUNCTION proj _TMPLT(_Ty) inline _CMPLX(_Ty) proj(const _CMPLX(_Ty)&amp; _Left) { // return complex projection return (_CMPLX(_Ty)( _CTR(_Ty)::_Isinf(real(_Left)) || _CTR(_Ty)::_Isinf(real(_Left)) ? _CTR(_Ty)::_Infv(real(_Left)) : real(_Left), imag(_Left) &lt; 0 ? -(_Ty)0 : (_Ty)0)); }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0090/">V501</a> There are identical sub-expressions '_Ctraits &lt;_Ty&gt; :: _ Isinf (real (_Left))' to the left |  operator.  xcomplex 780 <br><br>  The condition repeats the expression "_CTR (_Ty) :: _ Isinf (real (_Left))" twice.  It is difficult to say if there is a mistake and how to correct the code.  However, this feature clearly deserves attention. <br><br><h3>  Unnecessary check </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> BaseType, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> t_bMFCDLL = <span class="hljs-literal"><span class="hljs-literal">false</span></span>&gt; class CSimpleStringT { .... <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Append(_In_reads_(nLength) PCXSTR pszSrc, _In_ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nLength) { .... UINT nOldLength = GetLength(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nOldLength &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// protects from underflow nOldLength = 0; } .... };</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'nOldLength &lt;0' is always false.  Unsigned type value is never &lt;0. atlsimpstr.h 420 <br><br>  There is no error here.  Judging by the code, the length of the string cannot become negative.  In the class CSimpleStringT there are relevant checks.  The fact that the nOldLength variable has an unsigned type does not spoil anything.  Anyway, the length is always positive.  This is just an extra code. <br><br><h3>  Wrong string formation </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CHtmlEditCtrlBase</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-function"><span class="hljs-function">HRESULT </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDefaultComposeSettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( LPCSTR szFontName=</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">NULL</span></span></span></span><span class="hljs-function"><span class="hljs-params">, .....)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ CString strBuffer; .... strBuffer.Format(_T(<span class="hljs-string"><span class="hljs-string">"%d,%d,%d,%d,%s,%s,%s"</span></span>), bBold ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, bItalic ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, bUnderline ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, nFontSize, szFontColor, szBgColor, szFontName); .... } };</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0176/">V576</a> Incorrect format.  Consider checking the eighth actual argument of the Format.  Wchar_t type symbols is expected.  afxhtml.h 826 <br><br>  This code forms the wrong message in UNICODE programs.  The function 'Format ()' expects the eighth argument to be of type LPCTSTR.  But the variable 'szFontName' is always of type LPCSTR. <br><br><h3>  Port with a negative number </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> WORD ATL_URL_PORT; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CUrl</span></span></span><span class="hljs-class"> {</span></span> ATL_URL_PORT m_nPortNumber; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> BOOL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Parse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_In_z_ LPCTSTR lpszUrl)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">//get the port number m_nPortNumber = (ATL_URL_PORT) _ttoi(tmpBuf); if (m_nPortNumber &lt; 0) goto error; .... };</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression 'm_nPortNumber &lt;0' is always false.  Unsigned type value is never &lt;0. atlutil.h 2775 <br><br>  Checking that the port number is less than zero will not work.  The variable 'm_nPortNumber' has the unsigned type 'WORD'.  The type 'WORD' is 'unsigned short'. <br><br><h3>  Undefined behavior </h3><br>  The following macro is in the Visual C ++ header files. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DXVABitMask(__n) (~((~0) &lt;&lt; __n))</span></span></code> </pre> <br>  Wherever it is used, behavior arises indefinitely.  Of course, Visual C ++ developers know better if this construction is safe or not.  Perhaps there is confidence that Visual C ++ will always treat the shift of negative numbers in the same way.  Formally, a negative number shift leads to Undefined behavior.  More details on this topic are covered in the article " <a href="http://www.viva64.com/ru/b/0142/">Without knowing the ford, do not climb into the water. Part three</a> ". <br><br><h3>  Incorrect work in 64-bit mode </h3><br>  This pattern of 64-bit error is described in detail in the lessons we have drawn up on developing 64-bit C / C ++ applications.  To understand what the error is, we suggest that you familiarize yourself with the <a href="http://www.viva64.com/ru/l/0012/">lesson number 12</a> . <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CWnd</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CCmdTarget { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WinHelp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DWORD_PTR dwData, UINT nCmd = HELP_CONTEXT)</span></span></span></span>; .... }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CFrameWnd</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CWnd { .... }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CFrameWndEx</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CFrameWnd { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WinHelp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DWORD dwData, UINT nCmd = HELP_CONTEXT)</span></span></span></span>; .... };</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0080/">V301</a> Unexpected function overloading behavior.  WinHelpW 'in derived class' CFrameWndEx' and base class' CFrameWnd '.  afxframewndex.h 154 <br><br>  The 'WinHelp' function is declared incorrectly in the 'CFrameWndEx' class.  The type of the first argument must be 'DWORD_PTR'.  A similar error can be seen in some other classes: <br><ul><li>  V301 Unexpected function overloading behavior.  See "WinHelpW" in derived class "CMDIFrameWndEx" and base class "CFrameWnd".  afxmdiframewndex.h 237 </li><li>  V301 Unexpected function overloading behavior.  See WinDelpW 'in derived class' CMDIFrameWndEx' and base class' CMDIFrameWnd '.  afxmdiframewndex.h 237 </li><li>  V301 Unexpected function overloading behavior.  WinHelpW 'in derived class' COleIPFrameWndEx' and base class' CFrameWnd '.  afxoleipframewndex.h 130 </li><li>  V301 Unexpected function overloading behavior.  WinHelpW 'in derived class' COleIPFrameWndEx' and base class' COleIPFrameWnd '.  afxoleipframewndex.h 130 </li><li>  V301 Unexpected function overloading behavior.  WinHelpW 'in derived class' COleDocIPFrameWndEx' and base class' CFrameWnd '.  afxoledocipframewndex.h 129 </li><li>  V301 Unexpected function overloading behavior.  See the WinHelpW inline class COleDocIPFrameWndEx and base class COleIPFrameWnd.  afxoledocipframewndex.h 129 </li><li>  V301 Unexpected function overloading behavior.  WinHelpW inline class COleDocIPFrameWndEx and base class COleDocIPFrameWnd.  afxoledocipframewndex.h 129 </li></ul><br><h3>  The pointer at the beginning is used and then compared to NULL. </h3><br>  Such places have been found quite a lot.  To analyze whether each case is dangerous or not is very tiring.  The creators of libraries will do much better with this.  We will give only a couple of examples. <br><pre> <code class="cpp hljs">BOOL CDockablePane::PreTranslateMessage(MSG* pMsg) { .... CBaseTabbedPane* pParentBar = GetParentTabbedPane(); CPaneFrameWnd* pParentMiniFrame = pParentBar-&gt;GetParentMiniFrame(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pParentBar != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; (pParentBar-&gt;IsTracked() || pParentMiniFrame != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> &amp;&amp; pParentMiniFrame-&gt;IsCaptured() ) ) .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'pParentBar' pointer was used before it was verified against nullptr.  Check lines: 2840, 2841. afxdockablepane.cpp 2840 <br><br>  See, at the beginning, the 'pParentBar' pointer is used to call the GetParentMiniFrame () function.  The Zetas are suddenly suspected that this pointer may be NULL and the corresponding check is being performed. <br><pre> <code class="cpp hljs">AFX_CS_STATUS CDockingManager::DeterminePaneAndStatus(....) { .... CDockablePane* pDockingBar = DYNAMIC_DOWNCAST(CDockablePane, *ppTargetBar); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pDockingBar-&gt;IsFloating() &amp;&amp; (pDockingBar-&gt;GetCurrentAlignment() &amp; dwEnabledAlignment) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CS_NOTHING; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pDockingBar != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pDockingBar-&gt;GetDockingStatus( pt, nSensitivity); } .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'pDockingBar' pointer was used before it was verified against nullptr.  Check lines: 582, 587. afxdockingmanager.cpp 582 <br><br>  At the beginning, the 'pDockingBar' pointer is actively used, and then suddenly compared to NULL. <br><br>  And one more example at last: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CFrameImpl::AddDefaultButtonsToCustomizePane(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (POSITION posCurr = lstOrigButtons.GetHeadPosition(); posCurr != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; i++) { CMFCToolBarButton* pButtonCurr = (CMFCToolBarButton*)lstOrigButtons.GetNext(posCurr); UINT uiID = pButtonCurr-&gt;m_nID; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((pButtonCurr == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) || (pButtonCurr-&gt;m_nStyle &amp; TBBS_SEPARATOR) || (....) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0205/">V595</a> The 'pButtonCurr' pointer was used before it was verified against nullptr.  Check lines: 1412, 1414. afxframeimpl.cpp 1412 <br><br>  Feel free to contact the member of the class 'm_nID'.  And then from the condition it is clear that the 'pButtonCurr' pointer can be equal to 0. <br><br><h3>  Using a destroyed object </h3><br><pre> <code class="cpp hljs">CString m_strBrowseFolderTitle; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CMFCEditBrowseCtrl::OnBrowse() { .... LPCTSTR lpszTitle = m_strBrowseFolderTitle != _T(<span class="hljs-string"><span class="hljs-string">""</span></span>) ? m_strBrowseFolderTitle : (LPCTSTR)<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0240/">V623</a> Consider inspecting the '?:' Operator.  A temporary object is being created and subsequently destroyed.  afxeditbrowsectrl.cpp 308 <br><br>  The ternary operator cannot return values ‚Äã‚Äãof different types.  Therefore, an object of type CString is implicitly created from "(LPCTSTR) NULL".  Then from this empty string will be implicitly taken a pointer to its buffer.  The trouble is that a temporary object of type CString will be destroyed.  As a result, the value of the 'lpszTitle' pointer becomes not valid and it is impossible to work with it.  <a href="http://www.viva64.com/ru/d/0240/">Here</a> you can read a more detailed description of this error pattern. <br><br><h3>  Incorrect work with time </h3><br><pre> <code class="cpp hljs">UINT CMFCPopupMenuBar::m_uiPopupTimerDelay = (UINT) <span class="hljs-number"><span class="hljs-number">-1</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CMFCPopupMenuBar::OnChangeHot(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iHot) { .... SetTimer(AFX_TIMER_ID_MENUBAR_REMOVE, max(<span class="hljs-number"><span class="hljs-number">0</span></span>, m_uiPopupTimerDelay - <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0137/">V547</a> Expression '(0)&gt; (m_uiPopupTimerDelay - 1)' is always false.  Unsigned type value is never &lt;0. afxpopupmenubar.cpp 968 <br><br>  The value '-1' is used as a special flag.  Using the macro 'max', programmers wanted to protect themselves against negative values ‚Äã‚Äãin the m_uiPopupTimerDelay variable.  This will not work, since the variable is of unsigned type.  It is always greater than or equal to zero.  The correct code should look something like this: <br><pre> <code class="cpp hljs">SetTimer(AFX_TIMER_ID_MENUBAR_REMOVE, m_uiPopupTimerDelay == (UINT)<span class="hljs-number"><span class="hljs-number">-1</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : m_uiPopupTimerDelay - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>);</code> </pre> <br>  A similar error is found here: <br><ul><li>  V547 Expression '(0)&gt; (m_uiPopupTimerDelay - 1)' is always false.  Unsigned type value is never &lt;0. afxribbonpanelmenu.cpp 880 </li></ul><br><h3>  Pointless string </h3><br><pre> <code class="cpp hljs">BOOL CMFCTasksPaneTask::SetACCData(CWnd* pParent, CAccessibilityData&amp; data) { .... data.m_nAccHit = <span class="hljs-number"><span class="hljs-number">1</span></span>; data.m_strAccDefAction = _T(<span class="hljs-string"><span class="hljs-string">"Press"</span></span>); data.m_rectAccLocation = m_rect; pParent-&gt;ClientToScreen(&amp;data.m_rectAccLocation); data.m_ptAccHit; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TRUE; }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0222/">V607</a> Ownerless expression 'data.m_ptAccHit'.  afxtaskspane.cpp 96 <br><br>  What is "data.m_ptAccHit;"?  Perhaps you forgot to assign a value to this variable? <br><br><h3>  Maybe you need another one 0? </h3><br><pre> <code class="cpp hljs">BOOL CMFCTasksPane::GetMRUFileName(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MAX_NAME_LEN = <span class="hljs-number"><span class="hljs-number">512</span></span>; TCHAR lpcszBuffer [MAX_NAME_LEN + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(lpcszBuffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, MAX_NAME_LEN * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(TCHAR)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GetFileTitle((*pRecentFileList)[nIndex], lpcszBuffer, MAX_NAME_LEN) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { strName = lpcszBuffer; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TRUE; } .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0101/">V512</a> A call of the memset function will lead to underflow of the buffer lpcszBuffer.  afxtaskspane.cpp 2626 <br><br>  There is a suspicion that this code may return a string that will not terminate with a terminal zero.  Most likely, the last element of the array should also be reset: <br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(lpcszBuffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, (MAX_NAME_LEN + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(TCHAR));</code> </pre> <br><h3>  Strange 'if' </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CMFCVisualManagerOfficeXP::OnDrawBarGripper(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bHorz) { rectFill.DeflateRect(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rectFill.DeflateRect(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } .... }</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0112/">V523</a> The 'then' statement is equivalent to the 'else' statement.  afxvisualmanagerofficexp.cpp 264 <br><br><h3>  Dangerous class single_link_registry </h3><br>  If you use the 'single_link_registry' class, then your application may terminate unexpectedly, even if you correctly handle all exceptions.  Let's look at the destructor of the 'single_link_registry' class: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~single_link_registry() { <span class="hljs-comment"><span class="hljs-comment">// It is an error to delete link registry with links // still present if (count() != 0) { throw invalid_operation( "Deleting link registry before removing all the links"); } }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0098/">V509</a> The 'throw' operator inside the destructor should be placed within the try..catch block.  Raising exception inside the destructor is illegal.  agents.h 759 <br><br>  This destructor may throw an exception.  It is a bad idea.  If an exception occurs in the program, the destruction of objects begins by calling destructors.  If an error occurs in the 'single_link_registry' destructor, another exception will be raised.  It is not processed in the destructor.  As a result, the C ++ library immediately crashes the program by calling the terminate () function. <br><br>  Similar bad destructors: <br><ul><li>  V509 The 'throw' operator inside the destructor should be placed within the try..catch block.  Raising exception inside the destructor is illegal.  concrt.h 4747 </li><li>  V509 The 'throw' operator inside the destructor should be placed within the try..catch block.  Raising exception inside the destructor is illegal.  agents.h 934 </li><li>  V509 The 'throw' operator inside the destructor should be placed within the try..catch block.  Raising exception inside the destructor is illegal.  taskcollection.cpp 880 </li></ul><br><h3>  Another weird cycle </h3><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> CPreviewView::OnPreviewClose() { .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (m_pToolBar &amp;&amp; m_pToolBar-&gt;m_pInPlaceOwner) { COleIPFrameWnd *pInPlaceFrame = DYNAMIC_DOWNCAST(COleIPFrameWnd, pParent); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pInPlaceFrame) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; CDocument *pViewDoc = GetDocument(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pViewDoc) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">// in place items must have a server document. COleServerDoc *pDoc = DYNAMIC_DOWNCAST(COleServerDoc, pViewDoc); if (!pDoc) break; // destroy our toolbar m_pToolBar-&gt;DestroyWindow(); m_pToolBar = NULL; pInPlaceFrame-&gt;SetPreviewMode(FALSE); // restore toolbars pDoc-&gt;OnDocWindowActivate(TRUE); break; } .... }</span></span></code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0098/">V612</a> An unconditional 'break' within a loop.  viewprev.cpp 476 <br><br>  There is no 'continue' statement in the loop.  At the end of the cycle is a 'break'.  It is very strange.  The loop is always executed only once.  Here is either an error or better to replace 'while' with 'if' <br><br><h3>  Strange constant </h3><br>  There are other irrelevant notes on the code that are not interesting to list.  We give only one example, so that it is clear what is at stake. <br><br>  In the file afxdrawmanager.cpp, for some reason, a constant is entered for Pi: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> AFX_PI = <span class="hljs-number"><span class="hljs-number">3.1415926</span></span>;</code> </pre> <br>  <a href="http://www.viva64.com/ru/d/0241/">V624</a> The constant 3.1415926 is being utilized.  The resulting value could be inaccurate.  Consider using the M_PI constant from &lt;math.h&gt;.  afxdrawmanager.cpp 22 <br><br>  This is certainly not an error and the accuracy of the constant is sufficient.  But it is not clear why not to use the constant M_PI, which is much more accurate: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> M_PI 3.14159265358979323846</span></span></code> </pre> <br><h2>  Contacting Visual C ++ Developers </h2><br>  Unfortunately, we do not have a project and makefiles for building libraries included in Visual C ++.  Therefore, our analysis is very superficial.  We just found something and wrote about it.  Do not think that there are no other suspicious places :). <br><br>  We are sure that it will be much more convenient for you to use PVS-Studio to check the libraries.  If necessary, we are ready to prompt and help with integration into make-files.  It will also be easier to understand what is a mistake and what is not. <br><br><h2>  findings </h2><br>  See, in Visual Studio 2012 there is a static analysis of C / C ++ code.  However, this does not mean that it is enough.  This is only the first step.  This is only an opportunity to easily and cheaply try a new technology to improve the quality of the code.  And when you like it, come to us and purchase PVS-Studio.  This tool is much more intense struggling with defects.  He is under this sharpened.  We earn money on it, which means we are actively developing it. <br><br>  We found errors in the Visual C ++ libraries, although there is a static analysis.  We found errors in the Clang compiler, although it has static analysis.  Acquire us and we will regularly find errors in your project.  We are well interned in Visual Studio 2005, 2008, 2010, 2012 and are able to look for errors in the background. </div><p>Source: <a href="https://habr.com/ru/post/151786/">https://habr.com/ru/post/151786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151780/index.html">YaC 2012: more, more interesting</a></li>
<li><a href="../151781/index.html">Its cloud, 10-15 times cheaper than Amazon EC2</a></li>
<li><a href="../151783/index.html">Streaming and processing video through node.js + php and ffmpeg - part one</a></li>
<li><a href="../151784/index.html">Two interviews about hardware and virtualization</a></li>
<li><a href="../151785/index.html">Sony has introduced an updated PlayStation 3</a></li>
<li><a href="../151787/index.html">Service for creating layouts of rooms and interiors</a></li>
<li><a href="../151789/index.html">Working with AdMob in Russia will become easier from October 1, 2012</a></li>
<li><a href="../151790/index.html">Ten ways to make millions in your career</a></li>
<li><a href="../151791/index.html">Video sequence in drawable</a></li>
<li><a href="../151793/index.html">Why Russia is a country of the fourth world in social networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>