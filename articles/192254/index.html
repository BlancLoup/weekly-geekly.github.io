<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mini-study, improvement and bot for the game Shadow Worlds</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Yellow title: explore the MMORPG, add cheat features and write an elusive bot. 



 What is this game and what binds me to it 
 I came across Shadow W...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mini-study, improvement and bot for the game Shadow Worlds</h1><div class="post__text post__text-html js-mediator-article">  Yellow title: explore the MMORPG, add cheat features and write an elusive bot. <br><img src="https://habrastorage.org/getpro/habr/post_images/dfd/cb2/c2a/dfdcb2c2a653c3534404229ca01ce86e.jpg" alt="Picture to attract"><br><a name="habracut"></a><br><br><h4>  What is this game and what binds me to it </h4><br>  I came across Shadow Worlds about 10 years ago, and it completely captured me.  We played it with friends in a terrible modem connection, drenched rats and zombies, ran away from the orcs, opened the chests, rejoiced at the victories over the bosses and shouted ‚Äúawesome game!‚Äù When they died from the disconnect. <br><br>  What is so special about her is difficult to explain.  Even for those times, it had rather primitive graphics, almost no variety, but something attracted us to it.  Maybe it's a <a href="http://ru.wikipedia.org/wiki/%25D0%2597%25D0%25B0%25D0%25BF%25D0%25B5%25D1%2587%25D0%25B0%25D1%2582%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5">duckling syndrome</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Since then a lot of water has flowed under the bridge, but from time to time I downloaded the game client, created a new account and played until I got bored, and then deleted all traces of the game from the screw.  Every time I was convinced that nothing has changed in it over the years - the same locations, the same monsters, the same abuse in the global chat, nothing new, except that the balance is twisted back and forth. <br><br>  A month ago, raking tons of spam in an old mailbox, I found a letter from the SW Team.  It said that recently launched a new server with new maps, items and other amenities.  In my brain, the trigger worked, which is another time to plunge into nostalgia. <br>  Register, download client, and here I am in the game. <br><img src="https://habrastorage.org/storage3/7f5/4db/4fa/7f54db4fadd0946c2355533a58de8439.png"><br><h6>  The first thing that sees every new player. </h6><br><br>  You can again kill mice in the dungeons, zombies in the cemetery, collect money, buy a fishing net ... everything is as before, in general. <br><br>  Feeling young again, playing enough, towards Sunday evening, I was curious: how does the game communicate with the server?  Indeed, judging by the primitiveness of the interface (which I will mention later) and the lack of progress over many years, one can easily expect simplicity in the protocol used.  I started Wireshark, and I saw in the logs porridge from bytes, nothing meaningful.  Okay, then we will look from the inside. <br><br>  I open MUDClient.exe, the main exe-Schnick of the game in IDA, DeDe and OllyDBG.  In IDA, in order to feel cool, in Olly, because it is better not to find a debugger, in DeDe, because the game is written in Borland C ++ Builder. <br>  Everything goes with a bang, the exe is not packed and is not protected from above by any protector. <br><img src="https://habrastorage.org/storage3/a32/588/262/a32588262ae587d97b5cc33ce15d65ed.png"><br>  In DeDe, we see the curious names of the procedures, this gives us confidence that it will be possible to get a lot of useful information in a hurry (no protection). <br><br>  Olly has a small problem: the fact is that the game checks the update every time it starts, downloads it and restarts it. <br><img src="https://habrastorage.org/storage3/415/9e0/718/4159e071800423fa1b1cf2a9ca036490.png"><br><br>  Thus, by running MUDClient.exe in the debugger, it ends immediately, and run.exe starts instead, and even with the administrator privilege request, and I have to enter the admin password.  We understand. <br><br>  Open OllyDbg run.exe and set a breakpoint on CreateProcessW.  We get this: <br><img src="https://habrastorage.org/storage3/4da/000/39f/4da00039f59da8faec82f93df6233aa0.png"><br>  The magic parameter is E8DA81A3FFE9B1.  We won‚Äôt find out if it is some kind of checksum or just a secret, but take and create a bat file <br><pre><code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">start</span></span> MUDClient.exe E8DA81A3FFE9B1</code> </pre> <br>  The game starts, the admin password is not required, is not trying to update.  Victory <br><br>  Now we can specify the command line argument E8DA81A3FFE9B1 in Olly, the game will think that checking for updates is not required, and we can safely begin debugging.  And when you just want to play, it is more convenient to run this bat-file.  Worry about the fact that we will miss an important update is not worth it: still there are no fresh ehe-shnikov in them, the game is updated about once a week (the feature of this server), but the update contains only new files of game locations. <br><br>  What's the plan?  And let's hunt for those who hunt for players, that is, the administrators, who in the game are called Game Master'ami ( <b>GM</b> ).  Their task is to track the violators of the rules, especially AFK + Macros, that is, when a player launches a simple program that digs ore for him or fishes, while he goes on business.  This is prohibited by the rules. <br><br>  I myself have never violated this rule (honestly), and if I saw something like this, I tried to bring zombies to such a player, and then cleaned the corpse.  It's fun.  Why should I catch GMs?  And then, that the test is pretty easy to blink if you are at work, playing on the second monitor, and you accidentally blocked it with another window, while the players actively troll each other in the general chat.  And if now and then to be distracted by the game, then it does not work.  It means that we need to make an alarm: as soon as they try to check us, send some kind of signal, for example, blow up the game window and blink with it, play a melody, send SMS. <br><br>  How is the test?  The administrator teleports to you, while he looks like a regular player of zero level, only his guild is GAME MASTERS, and asks a simple question "here?" Or "check for afk".  If there is no answer within a couple of minutes, and the character continues to level the skill, then it is not there at the keyboard and he goes to the ban. <br><br>  To the debugger!  We enter the game as a character of Imthebot, then we are looking for a living soul for a long time - at this particular moment in the online game there are only 19 people (not thousands and not millions), which is not so little, sometimes less.  As a result, we stumble upon some kind of Bank. <br><img src="https://habrastorage.org/storage3/bb0/f1b/6d5/bb0f1b6d534ac3d086bcc64080e2c8d2.png"><br><h6>  Bank and does not suspect that it is special </h6><br><br>  Quickly grab the debugger, until Bank escaped, and search for the string ‚ÄúBank‚Äù by the process memory.  And we find. <br><br><img src="https://habrastorage.org/storage3/0bd/5bc/e5a/0bd5bce5a1728d9ce90c96231945aeab.png"><br>  Next to the name are still interesting tsiferki, and just above we see our nickname surrounded by the same tsiferok.  Morale increases, curiosity and desire to dig grows. <br><br>  But there is a chagrin: pretty soon garbage appears in the place of this data block, and the ‚ÄúBank‚Äù line is already detected at a number of other addresses.  That is, we did not find a static address, which would be convenient, but simply a phantom, a product of vital functions of some procedures.  So we will look for the source, where this data is formed. <br><br>  We set bryak on the recv function in the WSOCK32.dll module.  Many operations occur, for example: <br><img src="https://habrastorage.org/storage3/da4/95d/9c2/da495d9c29bfb533611dd7e1096795fb.png"><br>  In the buffer that recv fills, so far something meaningless, as in the results of Wireshark logging.  We go up the call stack above and see that as a result of processing by one of the calls, a human-readable string is formed in the memory <br><br><img src="https://habrastorage.org/storage3/32e/088/756/32e0887569a0ff1a3ce6c3a27ba1573d.png"><br><h6>  Pity the Bank went away on business </h6><br><br>  If we continue tracing, we will be in the kernel of the system.  The fact is that the call to recv is made in the stream, whose task is to form a string in memory, and then it will take it and process the main stream of the game.  You can put the hardware breakpoint on the generated string and end up in the main thread handler. <br><br>  For some time, while sitting at work, I was amused by logging incoming messages to the file using OllyDbg.  This is done by setting a conditional breakpoint (Shift + F4) <br><img src="https://habrastorage.org/storage3/11f/1a1/86e/11f1a186e441c0aae5832a8adbedc896.png"><br><br>  As a result, I have formed giant data wrappers. <br><div class="spoiler">  <b class="spoiler_title">An example of a footcloth when a Zloy player passed</b> <div class="spoiler_text">  0042A8CC New thread with ID 00000418 created <br>  0044A435 COND: 0: 448: P222: Imthebot: 1014: 46: 133: 1000: 1000: 0: 0: 0: 0: 0: 0:; G0000000 <br>  Thread 00000418 terminated, exit code 4BDFF7C (79560572.) <br>  0042A8CC New thread with ID 000007F0 created <br>  0044A435 COND: 0: 448: P212: Imthebot: 1014: 47: 133: 1000: 1000: 0: 0: 0: 0: 0: 0:; G0000000 <br>  Thread 000007F0 terminated, exit code 4BDFF7C (79560572.) <br>  0042A8CC New thread with ID 00000288 created <br>  0044A435 COND: 0: 493: P322: Imthebot: 1014: 48: 134: 1000: 1000: 0: 0: 0: 0: 0: 0:; P610: <b>Zloy</b> : 1009: 56: 138: 1000: 1000: 0: 0: 0: 0: 0: 0:; G0000000000 <br>  Thread 00000288 terminated, exit code 4BDFF7C (79560572.) <br>  0042A8CC New thread with ID 000009B0 created <br>  0044A435 COND: ??? <br>  Thread 000009B0 terminated, exit code 4FFFF7C (83885948.) <br>  0042A8CC New thread with ID 000008E0 created <br>  0044A435 COND: 0: 493: P222: Imthebot: 1014: 50: 134: 1000: 1000: 0: 0: 0: 0: 0: 0:; P620: <b>Zloy</b> : 1009: 55: 138: 1000: 1000: 0: 0: 0: 0: 0: 0:; G0000000000 <br>  Thread 000008E0 terminated, exit code 4FFFF7C (83885948.) <br>  0042A8CC New thread with ID 000007A0 created <br>  0044A435 COND: Ok <br><br>  0044A435 COND: 0: 493: P202: Imthebot: 1014: 50: 134: 1000: 1000: 0: 0: 0: 0: 0: 0:; P710: <b>Zloy</b> : 1009: 54: 137: 1000: 1000: 0: 0: 0: 0: 0: 0:; G0000000000 <br>  Thread 000007A0 terminated, exit code 4FFFF7C (83885948.) <br>  0042A8CC New thread with ID 00000C3C created <br>  0044A435 COND: ??? <br>  Thread 00000C3C terminated, exit code 51FFF7C (85983100.) <br>  0044A435 COND: Ok <br><br></div></div><br><br>  And suddenly, a message from a GM user with the text ‚ÄúGM-GM - check for AFK // GM - check for AFK‚Äù comes to my personal chat.  At the same time there was nobody near me.  I already jumped in surprise.  After welcoming the mysterious GM, I climbed onto the forum and discovered the latest topic, which referred to the reform of GM-checks.  In short: now GM doesn‚Äôt fly to you, but introduces a special spell, as a result of which he begins to see the character, but doesn‚Äôt know who is in front of him - not a nickname, level or even appearance can be determined.  Only the actions that you take and the opponents are visible (which are replaced by mice for greater anonymity).  This is how the problem of dishonest game masters was solved. <br><br>  It was an additional challenge: not only did you have to keep track of the players next to you, so also personal chat.  A question from GM, who flew in to me, got into the log, here it is: <br><blockquote> <code>0044A435 COND: 48:457:01GM-GM - check for AFK //  -   ;I41:46:35;P002:Imthebot:1001:53:35:1000:1000:0:0:0:0:0:0:;G00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</code> </blockquote> <br><br>  It's time to write a patch.  What is required of him?  It should transfer the string that arrives from the server to my external application, which can figure out what to do with it.  For this I will use the sending of the WM_COPYDATA message to my window. <br><br>  Quick googling gave this code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> aCopyData: TCopyDataStruct; hTargetWnd: HWND; begin with aCopyData <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> begin dwData := <span class="hljs-number"><span class="hljs-number">0</span></span>; cbData := StrLen(PChar(Edit1.Text)) + <span class="hljs-number"><span class="hljs-number">1</span></span>; lpData := PChar(Edit1.Text) end; <span class="hljs-comment"><span class="hljs-comment">// Search window by the window title // Fenster anhand des Titelzeilentext suchen hTargetWnd := FindWindowEx(0, 0, nil, PChar('WM_COPYDATA-Receiver')); if hTargetWnd &lt;&gt; 0 then SendMessage(hTargetWnd, WM_COPYDATA, Longint(Handle), Longint(@aCopyData)) else ShowMessage('No Recipient found!'); end;</span></span></code> </pre><br><br>  Importing MUDClient.exe does not have the FindWindowEx function, but there is FindWindowA, so I will use it. <br><br>  The jump to the patch will be in this place: <br><img src="https://habrastorage.org/storage3/653/328/294/65332829416dc099003e9bc7fb2c8b4b.png"><br><h6>  There is a string formed here, and three NOPs will benefit. </h6><br><br>  I will simply write over the top three final commands in the procedure my ‚ÄúJMP 00515080‚Äù <br>  It should be remembered that after eating two POP teams, we must restore them. <br><br>  The patch relay that I placed in a large memory block filled with zeros looks like this: <br><img src="https://habrastorage.org/storage3/3e2/499/bcc/3e2499bcc01641cf012dd2a5e328b332.png"><br><br>  The receiver code is even simpler: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">procedure </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WMCopyData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Msg: TWMCopyData</span></span></span><span class="hljs-function">)</span></span>; message WM_COPYDATA; ------ procedure TForm1.WMCopyData(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Msg: TWMCopyData); <span class="hljs-function"><span class="hljs-function">begin </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">try</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StrLCopy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">sText, Msg.CopyDataStruct.lpData, Msg.CopyDataStruct.cbData</span></span></span><span class="hljs-function">)</span></span>; DoProcessNewLine(sText); <span class="hljs-comment"><span class="hljs-comment">//      except end; end;</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Not a patch, but a loader</b> <div class="spoiler_text">  In fact, I do not change the exe file.  Instead, my application starts MUDClient.exe and uses the WriteProcessMemory command to modify the code in memory.  This allows you to distribute the "bot" in the form of one exe, not two, but also allows you to avoid violating the clause in the license agreement (Grammar Nazi, for battle) <br><blockquote>  13. Login to the game through the old client, as well as any modification of the game exe-file. </blockquote><br></div></div><br><br>  Here it is necessary to tell that for the line we get what is valuable in it.  For example, information about the characters on the screen, including yourself and mobs: <br><img src="https://habrastorage.org/storage3/807/0cf/780/8070cf7806cdedf3b74c165a59ee449d.png"><br><br>  Above cited part of the line in which there was a message in private from the character GM. <br><br>  This information is enough to keep track of both the characters we see and GM stealth who write to us in private.  In the screenshot, you can see one of the ‚Äúbot‚Äù windows, displaying units on the screen. <br><br><img src="https://habrastorage.org/storage3/ddb/e51/bc7/ddbe51bc7e15296aae78b32e9df69a03.png"><br><h6>  A typical example of breaking the rules.  Shakes the shield on the mice AFK, and did not even notice that I spoiled one of them health </h6><br><div class="spoiler">  <b class="spoiler_title">Continued in pictures</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage3/7d8/1cb/2fe/7d81cb2fe041790253e6119a3e463967.png"><br><br><img src="https://habrastorage.org/storage3/669/9e0/ba5/6699e0ba59293e82ce3b75641d7db96d.png"><br><br><img src="https://habrastorage.org/storage3/c68/1ec/ad3/c681ecad3cf8ebc977a34fca5f46bf2d.png"><br><br><img src="https://habrastorage.org/storage3/fff/f67/e9c/ffff67e9c17378747be12b5f15c65880.png"><br><br>  Really fun? <br></div></div><br><br>  Since I‚Äôve investigated the reception of data from the server, I‚Äôd have to look at least with one eye that the client is transmitting from his side.  I will not burden the reader with listings, I will tell you briefly that, just like with recv, I set a breakpoint to send, went up the call stack and found a place where the string is not yet encoded.  Examples of commands: <br><br><blockquote>  VR - is sent continuously, by this the client says that he is alive and wants to update the state <br>  QR - character's exit from the game <br>  UI4: 0 - use 4 inventory cells.  For example, drink a bottle, eat fish, read a scroll <br>  MB012: 4: 0 - move the inventory from 12 cells to 4 <br>  ACPrivet0000 - say ‚ÄúHello‚Äù to local chat <br>  PC * Vasya * Hello - write "Hello" in a private chat to the player Vasya <br>  SP3 - sit down (when a character is sitting, his health and magical energy are restored more quickly) <br>  ACesani gre olam1003 - recite fireball spell on character with ID1003 <br><br>  and so on. <br><br>  Each command must end with 0x13 and 0x10 characters. <br></blockquote><br><br>  How to use it?  Forging commands, of course.  You can write a more convenient chat, teach the character to automatically eat fish, automatically sit down.  Of course, much can be done by emulating keystrokes and mouse clicks.  Much, but not all. <br><br>  The second patch will be pretty simple too.  The basic idea: in the place where the game is just about ready to encrypt and transfer data to the server, we insert our patch code.  He looks for the window of our bot, and, if it finds it, reads the command, and then rewrites the line in the memory of the game process. <br><br><div class="spoiler">  <b class="spoiler_title">Here you can tell about the incident</b> <div class="spoiler_text">  While I was testing a new patch, a friend wrote to me, ‚ÄúListen, is it not you there indulging?‚Äù.  I did not understand his question, and then I paid attention to the global chat, in which the players were outraged en masse by the server restart.  At the same time they were thrown out of the game, there was a slight rollback of the game state, and all the mobs, including bosses, appeared again.  I did not believe it at first, but did several checks, and as a result of one server restarted.  In the chat, a complete hysterics began, but all of Elf was blamed (if the nickname was not mixed up) and asked him to stop the disgrace.  I don‚Äôt know why Elf became a scapegoat, or whether he deserved the fame of a local hacker, or because he parallels the adminit game and helps himself using his official position, and therefore has notoriety.  I do not know. <br><br>  In general, I made the button ‚Äúdrop the server‚Äù in my prog, which I then successfully checked a couple of times (because I didn‚Äôt believe that it was so easy to drop the server), that my friend and I had a lot of fun ‚Äúsomeone holds this server by the eggs‚Äù .  And after a few hours, it stopped working, apparently, they made an error on the server, which is good, since I wrote a letter to the main admin in which I admitted that it was me, as I did, and in general what affairs I do, but before clicking ‚Äúsend‚Äù, I decided to check the last time and ... found that the server was not broken. <br><br>  Yes, the point was that I did not complete the command with the trailing sequence 0x13 0x10. <br></div></div><br><br>  From cool.  The game has the ability to "look" at the character next, for this you need to click on it with the ALT clamped. <br><img src="https://habrastorage.org/storage3/ade/b02/41a/adeb0241a7068f6acf7118a3832f6da4.png"><br><br>  It is curious that the team is sent at the same time.  Click on itself, the log will display the following: <br><pre> <code class="dos hljs"><span class="hljs-number"><span class="hljs-number">00515160</span></span> COND: ID1006</code> </pre><br>  Let's try to change 1006 to 1001, we get <br><img src="https://habrastorage.org/storage3/32e/d1a/51e/32ed1a51e6f0687c881b7abe3156cdfc.png"><br><br>  But this player is not just not near us, or even in a different location, but generally in a different world (where all who pumped up to level 21 go, since in the first world there is no further experience). <br>  This makes it possible to know who is online now.  But stop, because the list of players online is available on the game site.  This is true, but administrators are not visible in it.  Also, to hide the admins, when you try to send them a private message, even if the admin is online, the message ‚Äúcould not be sent‚Äù appears as if it were not in the game.  And thanks to the found opportunity, we can always know that a particular GM is now working.  The task is facilitated by the fact that it is enough to do a search from ID1000 to ... ID1100, which is enough for the eyes.  When someone leaves the game and releases the ID, the next player takes the ID to himself.  Thus, we do not need to guess the ID of the game master.  And as a bonus, we can monitor the health of any player, even if he ran away from us. <br><br>  For example, send commands <br><pre> <code class="dos hljs">ID1020</code> </pre><br>  Result: <br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">Osiris:0:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invictus</span></span></span><span class="hljs-function">:53:0:705:705:1:124:190:189:0:139:187:131:184:186:0:0:0:</span></span></code> </pre><br><br><pre> <code class="dos hljs">ID1021</code> </pre><br>  Result: <br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">Admin:0::80:0:1880:1880:0:0:136:555:171:138:167:133:155:163:0:0:0:</span></span></code> </pre><br><br>  Pretty tasty. <br><br><h4>  Inventory </h4><br>  Then I wanted to do something really useful.  The game is very inconvenient work with inventory.  You cannot open the bag on the go and use it, only three fast cells are available to us, and if the object we need is far away, you will have to leaf through it for a very long time. <br><img src="https://habrastorage.org/storage3/a06/10b/37e/a0610b37efb6103012427f167796be21.png"><br>  In this case, it is worth mentioning a rather braking cursor, which is not tied to the hardware one, but is drawn by the game itself, that is, poking them into the small arrows scrolling through the quick inventory ‚Äî torture, clicking on objects too. <br><br>  I decided to make my inventory in the form of a separate window that can be used just like a game window.  Result: <br><img src="https://habrastorage.org/storage3/760/e4d/eda/760e4deda4add685a3d44e1a8baa6d89.png"><br><br>  First, I found out at what address the game stores the beginning of the inventory.  Here I resorted to using ArtMoney.  By sifting out unknown values ‚Äã‚Äãand throwing a zombie's hand between the first and zero cells, I quickly found a place in my memory: <br><img src="https://habrastorage.org/storage3/9fb/b93/8f8/9fbb938f8e1a246011e72553f2f5539b.png"><br>  Starting from 00550AC4, four-byte values ‚Äã‚Äãare stored that define the item.  True, it was not possible to simply take and match these values ‚Äã‚Äãto the images in the tga / items folder.  The zombie hand, as we see, has an index of 151, but in the folder with pictures the hand has a different meaning. <br><img src="https://habrastorage.org/storage3/6e9/1d3/ab7/6e91d3ab76f948dda7ab752ffe7a6286.png"><br><br>  A simple subtraction of 151-149 does not get rid of, since for other objects the difference may be completely different. <br><br>  Open the file ITEMS.DAT in WinHex, which is still in the same tga / items folder. <br><img src="https://habrastorage.org/storage3/83a/346/f8a/83a346f8a29ba66111996a5fe647e0fc.png"><br><br>  As we see, it does not look like an encrypted one, although at first glance only a description of subjects in Russian and alternative languages ‚Äã‚Äãis useful in it (German will be German in the German version).  We fiddle a bit in the file to find some kind of structure, and we find it quite quickly: if we calculate the distance between the beginning of each item description in bytes, then it is equal to 0x2E2 (738) bytes each time.  That is, each block of information about the N-subject begins with 738 * N. <br><br>  But what is the 151 that matches the hand of a zombie?  Very simple: multiply 151 * 738, backing away from the beginning of the file by this value (0x1B34E) and see: <br><img src="https://habrastorage.org/storage3/5b6/3df/bb7/5b63dfbb78875b82b23f0f6bfc7aa2e3.png"><br>  How to get the name of the image file in which the hand is drawn from this information?  Personally, I saw with my eyes, but you can also use the search by value, that the address 149 (149.bmp000.png) lies at 1B5A4.  Conclusion: after 0x256 bytes from the beginning of the data block, the number of 2 bytes is equal to the number of the PNG file with the image. <br><br>  Inventory is almost ready.  But the simple display is not enough, we must also use items from it.  As we found out earlier, if you send the command UI <b>X</b> : 0 to the server, where X is the cell number, the item will be used.  Now you can run your magician and drink bottles of mana on the go, a soldier to drink bottles of health replenishment, without opening the in-game inventory, and the more inconvenient "fast". <br><br><div class="spoiler">  <b class="spoiler_title">How to fish</b> <div class="spoiler_text">  One of the peaceful professions in the game is a fisherman (he is a blacksmith, but this is not important).  We need it not just for fishing, but the magic fish "magic".  Usually, fishing is automated by a macro, which right-clicks the fishing net, and then the left mouse button on the pond.  Magichka is rarely caught, mostly useless small fish that need to be eaten (this pumps the treatment skill).  You put on a full backpack of fish, and then tediously click on unnecessary fish, leaving magichek. <br><br>  But since we now have such a powerful tool, you can easily automate catching magic.  To do this, we cycle through the inventory and give the command to be eaten by all the bad fishes.  As a result, there is no need to follow the fisherman - he will catch precious fish. <br><br>  It‚Äôs a bit of a technical perversion: if you just send the UI <b>X</b> : 0 command to the server, it really eats it, and even went to the client ‚ÄúOK‚Äù, only the client has no idea what this OK belongs to, he didn‚Äôt send anything and ignore it.  Therefore, the client will continue to think that the fish / bottle is still intact.  I solved the problem very roughly: after sending the UI <b>X</b> command: 0 it is necessary to write zeros with the help of WriteProcessMemory to the corresponding cell.  And the fish will disappear immediately. <br></div></div><br><br>  For the greater functionality of the inventory, it remains to do the elementary: when you click on the subject of "our" inventory, the quick inventory of the game should scroll to this item, and double-click will be transferred to the game.  It was also made elementary: ArtMoney found the address where the quick inventory item is stored, and good old WriteProcessMemory I write the number I need there.  Double click sent by command <br><pre> <code class="cs hljs">PostMessageW(h, WM_LBUTTONDBLCLK,wParam,lParam);</code> </pre><br><br>  Working with Shadow Worlds inventory has never been so convenient, the speed of ejecting objects (very useful to miners) has increased many times, I felt myself to be the inventor of the lever and the wheel. <br><br><h4>  Auto fade and ban </h4><br><div class="spoiler">  <b class="spoiler_title">A bit boring snot and in-game twists and turns</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage3/aba/a5b/b08/abaa5bb085e4c5b984560ac61b40390c.png"><br>  Having made my prog very functional, I was distracted from it, and got carried away with the game.  With a friend, they began to rock blacksmiths - during working hours they do not need to be distracted especially: dig for yourself ore, then occasionally forge simple objects out of it, and the program simplified interaction with the interface. <br><br>  First trouble, foreigners.  There are quite a few foreign players on the server who behave aggressively towards the Russians.  Very soon, my friend and I realized that digging the ore just wouldn't work out - fighting characters now and then fly into the mines, often in groups, much higher than you in level and arranging a massacre.  As a result, the experience accumulated by sweat and blood flies into the pipe, and you also have to look for money to buy a new pick and hammer.  We didn‚Äôt take offense at foreigners, perceived more like hostile mobs, only they made fires among themselves and rejoiced when it came out to sneak away from them. <br><br>  Second trouble, ours.  At first, the Russian high-level players did not touch us, because they tried to fight with the Americans, as they are called on the server, although there are not only Americans.  But very soon, foreigners took a dominant position, and ‚Äúours‚Äù realized that they could not oppose a strong guild, and began to tear themselves away on the neutral characters of newcomers.        ‚Äî      () ,     ¬´?¬ª   .        ‚Äî ¬´ PvP-¬ª,   .   , PvP     .  ,     ‚Äî  . <br><br>  :   ,    .   ,   ,       <br><blockquote> 8.  [...]     /   ,  . </blockquote><br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we write automation of exit from the game in case of danger. To do this, there is everything you need: as soon as the character appears on the screen, we get a notice about it. You can exit the game in at least two ways: send a QR command to the server, or emulate a click on the "exit" button. It is necessary to press quickly, as if a character is hit once, for a minute he must remain in the game. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Made by Also added a white list to which you can add those you trust. And the fun began: we mined ore, evil foreigners or "ours" rushed into the mine in order to sprinkle our sword with our blood, but only managed to see instantly disappearing figures of noob-smiths. They set up ambushes, but we both appeared and disappeared, a sort of ninja.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A criminal thought also occurred to me (only for the sake of science): to make a fully automatic Imthebot that would fish or dig ore, while avoiding dangers and answering simple GM questions. How many days / months he would have lasted, what level of skills would he be able to pump? For several days I hatched the idea, but refused, because my passion for pumping the blacksmith was too strong, and I did not want to waste time on ‚Äústupidity‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And then a terrible thing happened: as always, I was digging ore, and Admin teleported to me. Auto exit triggered, I immediately quickly clicked "enter" and greeted. But it was late. </font></font><br><img src="https://habrastorage.org/storage3/587/26f/fbb/58726ffbbd399985aa3d57262a976296.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The character received a 999 days ban for using programs that automatically quit the game at the sight of a character.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oh, how did I reproach myself for not adding Admin to the white list on time, as I was constantly thinking about this topic, but my hands did not reach. </font><font style="vertical-align: inherit;">I tried to talk to the admin, but ran into a wall of silence. </font><font style="vertical-align: inherit;">It seems that he has become accustomed to the whining of those who are banned. </font><font style="vertical-align: inherit;">After long invitations to the dialogue, he only added that "a complaint was received against you, I checked, and the suspicion was confirmed." </font><font style="vertical-align: inherit;">Funny complaint: I can‚Äôt kill with my cool magician / warrior a naked low-level artisan, so I‚Äôll ask the admin to figure it out. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The loss of the blacksmith became for me another logical point of ‚Äúfucking game‚Äù, after which the game again moves into memories.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Little truth and reasoning about good and evil </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The obvious questions are: will the game suffer after the article, will the cheaters and bag-readers sweep? </font></font> Not.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First, there is almost no specific code in the article, only ideas. </font><font style="vertical-align: inherit;">Secondly, all these ideas are not entirely relevant, that is, they will work, but clumsily. </font><font style="vertical-align: inherit;">For example, the code with which I fake commands that go to the server is unstable. </font><font style="vertical-align: inherit;">Since it is fraying normal client requests, after some time the client becomes ill and disconnects occur. </font><font style="vertical-align: inherit;">How to do it right, I will not tell - the article from this will not be better. </font><font style="vertical-align: inherit;">Improving the auto-out algorithm also will not do anything for anyone: the admin can easily create another character to test, and the months of pumping will go to null, for admins are very tough - no democracy and no presumption of innocence.</font></font></div><p>Source: <a href="https://habr.com/ru/post/192254/">https://habr.com/ru/post/192254/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192242/index.html">Terminal access to the Cach√© DBMS - now in the browser</a></li>
<li><a href="../192244/index.html">Amazon opened the delivery of electronics in Russia</a></li>
<li><a href="../192248/index.html">Summer alarm: we are looking for cloud CRM</a></li>
<li><a href="../192250/index.html">We fasten SMS to cacti</a></li>
<li><a href="../192252/index.html">How to connect to Hyperboria</a></li>
<li><a href="../192256/index.html">Building a full MVC website on ExpressJS</a></li>
<li><a href="../192258/index.html">Connecting the accelerometer to the Raspberry Pi using the Pi4J library</a></li>
<li><a href="../192262/index.html">GWT-Platform basics of working with presenters</a></li>
<li><a href="../192266/index.html">Perfect migration using Catch-> Evernote</a></li>
<li><a href="../192268/index.html">Gradle and Automation Solution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>