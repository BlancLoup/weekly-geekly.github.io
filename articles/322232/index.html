<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Telegram bot polling a linux server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently fond of Python. I wanted to write something more significant than codes like helloworld. Since the telegram looked with interest towards the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Telegram bot polling a linux server</h1><div class="post__text post__text-html js-mediator-article">  Recently fond of Python.  I wanted to write something more significant than codes like helloworld.  Since the telegram looked with interest towards the bots, an idea was born to create a bot that would run commands or scripts on a remote server (linux) and return the result to telegrams.  What for?  Conveniently!  No need to log in to a server to get information about the load on the processor, free memory or disk space.  You can even run scripts. <a name="habracut"></a><br><br>  And so <s>we study python and api telegram bot</s> , register our bot in a telegram, download ready-made scripts, run them on our server and change config.py for ourselves. <br><br>  Let's go in order: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1) Registration of the telegram bot.  Find the father of all bots - @BotFather.  We write to him: <br><br><pre><code class="bash hljs">/newbot</code> </pre> <br>  In response to his message, enter the name of your new bot.  It must have the word bot at the end. <br><br><pre> <code class="bash hljs">moi_novii_bot</code> </pre> <br>  If the name is not taken and it is entered correctly, then you will receive a token - you will need to copy it into the config.py file of the script: <br><br><pre> <code class="bash hljs">token = <span class="hljs-string"><span class="hljs-string">' '</span></span></code> </pre> <br>  2) Download the script.  This is the first test version of the script - in order to evaluate the capabilities of the python itself first, and secondly the telegram bot.  Any wishes and suggestions are welcome - finish.  You can add something yourself - please share too.  What are the features of the program (you can see them typing / help in your bot): <br><br><ul><li>  view network settings (runs the ifconfig command on the server) </li><li>  get disk space information (runs the df -h command on the server) </li><li>  get memory information (runs the free -m command on the server) </li><li>  get information about the load on the processor (runs the mpstat command on the server) </li><li>  get information about the size of the folder specified in config.py (runs the command du -sh folder name on the server) </li><li>  checks the presence and size of the file in the folder (runs the ls -lh file on the server).  I make a backup of the base 1c in the mounted network folder with the file name by date - so there is such a need. </li></ul><br>  What else I plan to implement: launching any script (possibly without outputting the entire execution, but only the final result), improve the output of the result - more readable, collecting statistics in the database and outputting graphs for loads, etc. <br><br>  Python 3 and python-telegram-bot are required to run the script.  I have a centOS.  There already is version 2 of the python.  Put alongside 3 python and a library for bot operation: <br><br><pre> <code class="bash hljs">wget http://www.python.org/ftp/python/3.3.2/Python-3.6.0.tar.xz yum install xz tar -xpJf Python-3.6.0.tar.xz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> Python-3.6.0 yum groupinstall <span class="hljs-string"><span class="hljs-string">"Development tools"</span></span> ./configure make make install ln -s /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/python3 /usr/bin/python3 pip3 install python-telegram-bot --upgrade</code> </pre> <br>  Script composition: <br><br><blockquote>  bot - bash-script file that launches python3 bot.py <br>  bot.py - the bot script itself.  For those who are familiar with python - welcome inside. <br>  config.py - stores settings.  There you enter the token received in the telegram.  Then run the script. </blockquote><br>  In the application telegram enter: <br><br><pre> <code class="bash hljs">/id</code> </pre> <br>  So you get your personal id.  It must be entered in the string (instead of 123456789) admin = ['123456789'].  This is done for security purposes, so that other users can only enter users from certain telegram accounts.  You can enter several id through comma: admin = ['123456789', '987654321']. <br><br>  In the line dir1 we write the path to the folder the volume of which we would like to control (I have this path to the folder with the pgsql databases) <br><br>  In the line dir_backup - the path to the folder where the file is located, the volume (or the presence) of which must be monitored.  I have a file of the form 20170218.tar.gz.  By default, it is the version with the name of the year.mon.gd file that is checked.  If you want to change the mask of the file being checked, then you need to find and edit the line in the bot.py file <br><br><pre> <code class="python hljs">filebackup = config.dir_backup + cur_year + cur_month + cur_day + <span class="hljs-string"><span class="hljs-string">'.tar.gz'</span></span> <span class="hljs-comment"><span class="hljs-comment">#    </span></span></code> </pre> <br>  Keep in mind that later when you repair the config.py file, you will not need to restart the script.  All settings are re-read by the script each time anew. <br><br>  It would be nice to add this script to autoload.  For CentOS 7: <br><br><pre> <code class="bash hljs">touch /etc/systemd/system/telegram-bot.service chmod 664 /etc/systemd/system/telegram-bot.service</code> </pre> <br>  Content of this file: <br><br><pre> <code class="bash hljs">[Unit] Description=Telegram bot After=network.target [Service] Type=simple User=     ExecStart=   bot.sh (         bot.py) [Install] WantedBy=multi-user.target</code> </pre> <br>  We are starting a new service: <br><br><pre> <code class="bash hljs">systemctl start telegram-bot.service</code> </pre> <br>  Add it to autoload: <br><br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> telegram-bot.service</code> </pre> <br>  Checking status: <br><br><pre> <code class="bash hljs">systemctl status telegram-bot.service</code> </pre> <br>  We can enter commands.  We start with / help. <br><br>  ‚Üí <a href="http://xn--80aimpg7h.xn--p1ai/bot-telegrama-opros-servera-fajl-skripta/">Link to the archive with the script</a> <br><br>  Thank you, <a href="https://habrahabr.ru/users/riot26/" class="user_link">riot26</a> for the display on githab: <br>  <a href="https://gist.github.com/riot26/bb55e8a19fae0b58d687040c54cbc148">gist.github.com/riot26/bb55e8a19fae0b58d687040c54cbc148</a> </div><p>Source: <a href="https://habr.com/ru/post/322232/">https://habr.com/ru/post/322232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322222/index.html">Russian startups do not succeed because of laziness</a></li>
<li><a href="../322224/index.html">How IT professionals work. Andrey Smirnov, Development Team Leader at Rambler Digital Solutions</a></li>
<li><a href="../322226/index.html">Brave new Roslyn: Who needs their own code analyzers and C # scripting?</a></li>
<li><a href="../322228/index.html">We invite you to the March open lectures on the gaming industry and IT at VSBI</a></li>
<li><a href="../322230/index.html">Virtual and Augmented Reality Market: Prospects for Startups from an Investor's Point of View</a></li>
<li><a href="../322234/index.html">Traffic sources in arbitration</a></li>
<li><a href="../322236/index.html">"Clean up on your desk": my experience of remote interview in Amazon</a></li>
<li><a href="../322238/index.html">Virtual quest rake, part two: construction, billion bugs and nausea in VR</a></li>
<li><a href="../322240/index.html">YaBB - forum of the XX century</a></li>
<li><a href="../322242/index.html">Premature architecture optimization</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>