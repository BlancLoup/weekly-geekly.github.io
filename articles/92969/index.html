<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kernel message handling</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 A terrible tale: 
 EDAC MC0: 1 CE read ECC error on CPU # 0 Channel # 1_DIMM # ‚Äã‚Äã0 (channel: 1 slot: 0) 
 EXT4-fs error: ext4_wait_block_bi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kernel message handling</h1><div class="post__text post__text-html js-mediator-article"><h2>  Foreword </h2><br>  A terrible tale: <br><blockquote>  EDAC MC0: 1 CE read ECC error on CPU # 0 Channel # 1_DIMM # ‚Äã‚Äã0 (channel: 1 slot: 0) <br>  EXT4-fs error: ext4_wait_block_bitmap: 445: Cannot read block bitmap <br>  Out of memory: Kill process 95 (sshd) score 31 or sacrifice child <br>  CMCI storm detected: switching to poll mode <br>  page allocation failure: order: 1, mode: 0x4020 <br>  invalid opcode: 0000 [# 1] SMP <br></blockquote><br>  It looks bad, right?  The list <s>can be very long</s> very long.  In this article I will tell you how to live with it and what we did to it. <br><br>  Some of these messages in the examples above will make you plunge into the abysses of modern processor architecture (‚ÄúCMCI storm‚Äù, good luck in finding the way back, from the wilds of the Internet) ... Strange things in the kernel may violate expectations about how computers work, making subsequent debugging very obstructed  The lack of knowledge about what happened may even leave with a sad answer, "some kind of unknown garbage, rebutted, it seems, has passed." <a name="habracut"></a><br><br>  Strange things can be divided into four groups: <br><ul><li>  Failure of the central equipment (including the processor. How do you get the message "Generic CACHE Level-2 Generic Error"?) </li><li>  Peripheral equipment failure (CMCI storm from network card? Fallen SAS HBA?) </li><li>  Core bugs </li><li>  Lack of resources </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Sometimes errors occur in sad path (a triad of concepts: happy path, sad path, bad path) is sad but predictable.  There is a meaningful code branch that reacts to this problem.  The kernel was divided into zero, the hard disk began to pour Buffer I / O error on device ... etc.  Most often, such errors either mean rebooting the server (ideally, automatic), or are processed in the software area (a single broken hard drive is not even a problem, but rebuild the raid after a replacement), or in the hardware (recoverable ECC error in memory).  Sometimes errors even go unnoticed (for example, IO error for a CD drive, a lone segmentation fault for a program that ‚Äúhas restarted and continues to work‚Äù). <br><br><h2>  Sad example </h2><br>  But sometimes errors are not processed in the ‚Äúexpected‚Äù way, but they bring the system into a state where ‚Äúthere has never been such a thing, and here it is again‚Äù (bad path). <br><br>  A living example from recent practice: the RAID controller on the server went offline and immediately came back (PCI bus reset by watchdog in the driver).  All arrays were discovered as ‚Äúnew‚Äù disks and received new letters, the same uuid remained.  Everything that was in the databag of the chef was mounted at the first opportunity along the same paths. <br><br>  The result was a construction, to put it mildly, not provided for by the Administrative Code: <br>  / dev / sda -&gt; / mountpoint (broken) <br>  / dev / sdd -&gt; / mountpoint (working) <br>  At the same time, the files that were opened on the ‚Äúbat‚Äù version of / mountpoint gave IO error for any operations, and new files were created on the working / mountpoint.  Newfound readable files were also taken from there.  At the same time, the swap was on ‚Äúbat‚Äù / dev / sda and fantastic messages could be observed: <br><pre> Read-error on swap-device (8: 0: 330471000)
 Write-error on swap-device (8: 0: 362589920).
</pre><br>  (up to this point I did not know that Linux can make a read error on the swap and stay alive). <br><br>  The sda ‚Äã‚Äãitself was a hardware raid, but who can disk redundancy help if the controller falls off entirely?  The resulting design completely passed all checks.  Is there a disc?  There are also mounted.  Raid status?  OK!  Free place?  There is.  Queue size for IO?  All OK.  Error counter for mounted block device?  Zero (new device).  Do new write requests work?  Work out.  What more could you want? <br><br>  But at the same time, a lot of software caught a recording error and went into an unexpected state.  Someone ended, someone continued to write to the file in spite of errors (the same core with the swap file).  Even a special check that all the disks that the chef expects to see are mounted, also said ‚Äúok.‚Äù <br><br>  After debriefing, we changed the check to ‚Äúmount‚Äù from check to ‚Äúdrive mounted‚Äù to ‚Äúdrive mounted no more than once‚Äù.  Well, the analysis of the logs.  Actually, about them and the article. <br><br><h2>  Central equipment failures </h2><br>  It is difficult to collect broken teeth with broken arms.  The same applies to the system response to failure of the central components.  If the server has power problems with the processor, with the processor itself (yes, they also break down), RAM, a PCI controller, or other components that are critical for operation, it either hangs (and then the watchdog comes and reboots) or panics.  However, there is a whole class of noncritical errors (for example, a memory error, although very bad, but often does not lead to a reboot).  Sometimes a processor is wrong, a program crashes in an ACPI virtual machine, memory controllers or PCI buses are freaking out.  Sometimes these errors "only" change a few bytes (bits?) In some places.  The consequences of this are impossible to predict.  That is, not "difficult", but "impossible." <br><br><h2>  Core bugs </h2><br>  There are also.  BUG on bla-bla-bla.  Unpleasant, but not fatal "well, did not work."  In some cases, the error is fatal and leads to panic, in some, from the point of view of the kernel, no.  However, the consequences of a kernel error again, it is very difficult to describe from the standpoint of userspace.  Previously, everything was good, nothing has changed, and now everything is bad. <br><br><h3>  Story </h3><br>  Something went wrong in the core.  Either the mutex, or the memory was corrupted, but at the output we got a strange trace, and an unkillable process, eating 100% CPU.  I discovered it when I saw that nova-compute (written in python) is not responding to heartbeats.  I went to the host.  I see, in the top, 100% CPU.  Not restarted.  Does not kill (kill -9).  Strace shows nothing (no request). <br><br>  Wait, an experienced admin.  This process was not in 'D', it did not "go to IO and never returned."  He did not perform any syscall at all.  He just ate 100% CPU (in nuclear context?).  He was 'R' and he ignored signal 9 (and he was not init).  In that case, the story was not completely excavated, but the assumption was that either as a result of an error or an unnoticed memory damage, the kernel could not process a lock when the context was switched, so the CPU time was valid for the process, but the processor worked in the context kernels.  That is, ‚Äúa pear is hanging, eating 100%, cannot be beaten‚Äù.  Surprisingly, the process is self-terminated (or finished with kill -9) after 10 minutes, after which shutdown / migration went in a regular way (like, happy end). <br><br><h2>  Lack of resources </h2><br>  When your cozy application is told ‚ÄúFIG YOU, not a file socket,‚Äù this is: sad path.  Everything is under control and good.  But when the network driver cannot get a whole piece of 8kB memory for itself (for the jumbo frame) - ‚Äúpage selection failure: order: 2‚Äù, and the packet silently drops ‚Äî this is bad.  That is, from the outside you can see what is bad, but inside everything is fine, except for the lines in dmesg.  The main reason for this error is memory fragmentation (chunks of memory must be continuous), plus the feature of the kernel used (at that time).  By the way, as a temporary measure (before the server was decommissioned), we slightly reduced the size of the jumbo frame to the state when the module had 2 pages in a row rather than 4. It felt a little better. <br><br>  And it happens that the magic OOM killer comes and takes away New Year's gifts from some process.  This is especially sad when an auxiliary process dies (for example, epam for beam.smp in the context of erlang) and nobody knows about it.  Even more interesting, when a shortage of memory happens on a very busy system - not only does the OOM killer kill anyone, the search process for the "victim" can take tens of seconds, and during this time the server does nothing.  Nothing at all - neither the network nor the disk work.  Only the core rustles through the structures in memory.  And then (minus the ‚Äúnot waking loser‚Äù) it continues to work as if nothing had happened.  And guess after that why the failover worked with a timeout of 20s. <br><br><h2>  Leading up to the story topic </h2><br>  In all this sad there is one thing in common - the kernel writes about the causes of sadness in dmesg.  Even if the kernel decides to panic, it first writes to dmesg and then panics.  Analysis of the causes of post mortem - perhaps the most important work of the system administrator, it resembles the work of a specialist in evidence.  The smallest traces of what was left, allow you to put together pieces of the mosaic.  The mosaic is especially interesting when kurtosis occurs on the scale of several servers. <br><br>  The second important thing: to know about all these nasty things when they happen.  Because between the ‚Äúsad trace‚Äù in dmesg and the degradation of the service, which will be noticeable from the side, considerable time intervals can take place (up to several tens of hours).  And there is a time to ‚Äúfix it as if nothing had happened.‚Äù <br><br>  Thus, I want to "collect logs" and "respond to them." <br><br>  Those who have already sighed to themselves "well, another story about netconsole" - no.  I will say a few words about netconsole, and then I will tell you how to live with it later, when data is already received via UDP. <br><br><h1>  netconsole </h1><br>  Detailed howto has already been written: <a href="http://habrahabr.ru/post/131220/">habrahabr.ru/post/131220</a> , and here I will give a brief squeeze: netconsole is a kernel module for sending kernel logs in UDP packets.  Note that this is so low that even ARP does not work on it, that is, you must specify the recipient's MAC address. <br><br>  But netconsole works, even if you break through the entire network stack.  For example, make rmmod ip, or, or remove the IP address from the interface, or when bridging is enabled, rmmod openvswitch.  It is very funny to see how the kernel over the network writes that the entire network is broken. <br><br>  When the module is loaded, it is specified with a local interface, the IP address from which to send, the IP and recipient MAC addresses.  If the traffic is sent outside the network segment, then the MAC address of the gateway (.1) is specified as the MAC. <br><br><h1>  Reception </h1><br>  Everything interesting begins here.  You can collect netconsole using syslog (and its variations are syslog-ng, rsyslog).  In our case, logstash is used.  We have already written about this construction: <a href="http://habrahabr.ru/company/webzilla/blog/231623/">wrote</a> . <br><br>  Logs are firstly accepted, secondly marked on input as 'netconsole' (conditionally chosen label), and most importantly, the server name is recorded instead of the address.  This is a very important process and about him below. <br><br>  Config example: <br><pre><code class="ruby hljs">input { udp { type =&gt; <span class="hljs-string"><span class="hljs-string">"netconsole"</span></span> port =&gt; <span class="hljs-string"><span class="hljs-string">"6666"</span></span> buffer_size =&gt; <span class="hljs-string"><span class="hljs-string">"1048576"</span></span> } } filter { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [type] == <span class="hljs-string"><span class="hljs-string">"netconsole"</span></span> { dns { action =&gt; <span class="hljs-string"><span class="hljs-string">"replace"</span></span> reverse =&gt; [<span class="hljs-string"><span class="hljs-string">"host"</span></span>] } mutate { add_field =&gt; [<span class="hljs-string"><span class="hljs-string">"syslog_host"</span></span>, <span class="hljs-string"><span class="hljs-string">"%{host}"</span></span>] } } }</code> </pre> <br><br>  The only nontrivial here is setting the host field.  And it is very important, because otherwise there will be no dmesg.  It is so important that we are now having a discussion about whether we need to write out all the addresses in / etc / hosts on the monitoring hosts and use it so that the dns crash at the time of recording the trace would not spoil the error log. <br><br>  Further, we need to look at these logs.  In the context of kibana, for the sake of convenience, a 'TERMS' column was added with the choice: syslog or netconsole.  The resulting filter looks like this: <br>  <code>host must 'hostname' and source must 'netconsole'</code> . <br><br>  The resulting can already be read, but very inconvenient.  For convenience, I use another manual script, <br>  which rips out dmesg just by playtext from elasticsearch: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python from pyelasticsearch import * import json import sys es = ElasticSearch('http://elastic.local:9200/') q=json.load(sys.stdin) res=es.search(q)['hits']['hits'] for i in res: print(i['_source']['message']),</span></span></code> </pre><br><br>  On stdin, he is fed the interested request from kibana in the form of JSON (the 'i' button in the widget of interest), on stdout it gives out a neat pile of lines without unnecessary garbage.  However, I will write about life and struggle with Kibana separately. <br><br><h1>  Monitoring </h1><br>  Above, it was shown how to view post mortem data.  There is also the task to react to the ‚Äúbad‚Äù lines and notify shinken (nagios) about them.  And how to get on the nerves of admins, nagios himself knows very well. <br><br>  This is done using filters. <br><br><pre> <code class="ruby hljs">filter { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [type] == <span class="hljs-string"><span class="hljs-string">"netconsole"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( [message] =~ <span class="hljs-regexp"><span class="hljs-regexp">/ioc0: attempting task abort!/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> [message] =~ <span class="hljs-regexp"><span class="hljs-regexp">/mptbase: ioc0:.+Code=\{Abort\}/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> [message] =~ <span class="hljs-regexp"><span class="hljs-regexp">/Device offlined/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> ... [message] =~ <span class="hljs-regexp"><span class="hljs-regexp">/Read-error on swap-device/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">"1"</span></span> == <span class="hljs-string"><span class="hljs-string">"2"</span></span> ) { noop { add_tag =&gt; [<span class="hljs-string"><span class="hljs-string">"notify"</span></span>] } }</code> </pre><br>  We set the notify flag if we don‚Äôt like the line.  Pay attention to ‚Äú1‚Äù == ‚Äú2‚Äù - this line was added to boldly write or on each ‚Äúmeaningful‚Äù line and not be afraid to break the syntax. <br><br>  Flag processing is very simple: <br><pre> <code class="ruby hljs">output { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"notify"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [tags] { exec { command =&gt; <span class="hljs-string"><span class="hljs-string">"/usr/lib/nagios/plugins/log_event_sender.sh %{syslog_host} log_event '%{message}'"</span></span> } } }</code> </pre><br><br><h2>  Testing </h2><br>  I would say that this is ‚Äúeverything‚Äù, if not for one ‚Äúbut‚Äù.  Some types of scary lines appear extremely rarely - and it is very difficult to know whether monitoring will work on them or not.  Up to a certain point, we relied on ‚Äúwe will not break it,‚Äù but the fears of a ridiculous typo in the filters, which completely disable actuation for errors, were too great. <br><br>  And the microform was born for testing. <br><br>  The idea is simple: each regexp in filters should catch only one line.  And for each regexp there should be an original (preferably copied straight to the live, from a real event) that we want to catch. <br><br>  I showed an example of the file file above.  An example file with examples you can see in the introduction.  One muck on one line. <br><br>  Next comes the simplest test: we run logstash in stdin / stdout mode, and check that the number of input lines is equal to the number of output lines (labeled notify).  If it diverges - it means that someone broke something.  If it converges, it means that for every bad line it will catch something. <br><br>  Below run_test.sh, in which nothing interesting happens, we write microconfig with echo, insert its filter in the middle, which we test, check that everything coincides.  If not - the admin himself understands what's wrong. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash TMPC=logstash-test-$RANDOM.conf TMPO=logstash-test-output-$RANDOM.txt LOGSTASH=logstash/logstash-1.4.2/bin/logstash TIMEOUT=60 FILTERS=....../filters.conf.erb if test ! -d logstash; then echo "No local logstash found at $LOGSTASH (Please download/unpack)" exit -1 fi echo 'input { stdin { type =&gt; "netconsole" } }' &gt; $TMPC cat $FILTERS &gt;&gt;$TMPC echo 'output { if "notify" in [tags] { stdout { } } }' &gt;&gt;$TMPC #echo $LOGSTASH --quiet -f $TMPC cat netconsole_examples.txt | timeout -s SIGKILL $TIMEOUT $LOGSTASH --quiet -f $TMPC &gt; $TMPO if test `wc -l netconsole_examples.txt | awk '{print $1}'` -ne `wc -l $TMPO | awk '{print $1}'`; then echo Netconsole test FAILED echo Input: `wc -l netconsole_examples.txt` echo Output: `wc -l $TMPO` echo not removing files $TMPC and $TMPO exit 1 else echo netsonsole test PASSED rm $TMPC $TMPO exit 0 fi</span></span></code> </pre><br><br>  After each edit, you must / can run run_test.sh and check that it works.  At the same time, netconsole_examples.txt serves as an excellent method for storing all the most terrible things you can meet in this life.  (These lines themselves are commented on taste, with the addition of links to articles in the wiki, where post mortem analyzes are stored, etc.). <br><br>  At the monitoring output, we have the following messages: <br><pre> ** PROBLEM alert - database1984.utah42.nsa.gov/log_event is CRITICAL **
 Shinken notification<font></font>
<font></font>
 Notification Type: PROBLEM<font></font>
<font></font>
 Service: log_event
 Host: database1984.utah42.nsa.gov
 Address: 238.211.14.5
 State: CRITICAL<font></font>
<font></font>
 Date / Time: 01-23-2015 Additional Info: Jan 23 03:59:21 database1984 kernel: [15941700.780017] mce: [Hardware Error]: Machine check events logged
</pre></div><p>Source: <a href="https://habr.com/ru/post/92969/">https://habr.com/ru/post/92969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../92960/index.html">Incompetence of bank staff</a></li>
<li><a href="../92962/index.html">STIHL Autumn Calendar 2010</a></li>
<li><a href="../92963/index.html">DoS attack on MS Windows XP using a USB device</a></li>
<li><a href="../92965/index.html">Collection of signatures against the reform of the public sector</a></li>
<li><a href="../92967/index.html">How to win freelance contests or where diamonds come from in Bolivia</a></li>
<li><a href="../92971/index.html">Comparing the size of the game worlds</a></li>
<li><a href="../92974/index.html">Project Qubrit (business card) - need Habrapas users advice</a></li>
<li><a href="../92977/index.html">"National Information Policy: the base model" of UNESCO - now in Russian</a></li>
<li><a href="../92980/index.html">About multiplexing technology for wireless technology</a></li>
<li><a href="../92985/index.html">ViewSonic 3D projector, do you need it?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>