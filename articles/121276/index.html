<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>And once again about the tests. Real-life code testing approach</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think almost everyone has come across this opinion : writing tests is difficult, all examples of writing tests are given for the simplest cases, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>And once again about the tests. Real-life code testing approach</h1><div class="post__text post__text-html js-mediator-article">  I think almost everyone has come across <a href="http://habrahabr.ru/blogs/java/121234/">this opinion</a> : writing tests is difficult, all examples of writing tests are given for the simplest cases, but in real life they do not work.  I have the impression in recent years that writing tests is very simple, even trivial <sup>*</sup> .  The author of the comment mentioned above further says that it would be nice to make an example of a complex application and show how to test it.  I'll try to do just that. <br><br>  <sup>*)</sup> Writing the tests themselves is really elementary.  Creating an infrastructure that makes it easy to write tests is a bit more complicated. <br><br><a name="habracut"></a><br>  I am not a theorist, I am a practitioner (‚ÄúI am not Pushkin by nature, I am Belinsky‚Äù ¬©).  Therefore, I will use some ideas from Test Driven Development, Data Driven Development, Behavior Driven Development, but I cannot always justify my choice.  Basically, my argument will sound like this: ‚ÄúIt's easier,‚Äù or ‚Äúit's more convenient.‚Äù  Understanding perfectly well that my recipes are far from being suitable for everyone, I ask you, first, to still think about my arguments, and, second, not to treat this text as a textbook. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the drum roll: <br><br><h3>  Difficult application </h3><br><br>  This application exists in reality, but it is not public, so I can‚Äôt show the real code.  Scope - PaaS, platform-as-a-service.  Specifically - automate the launch of client applications on a certain virtual infrastructure.  Will work inside large enterprises.  The architecture is fairly standard: the relational database, on top of Hibernate, then the web interface, everything is managed by the Spring framework.  On the side, we have two pribluds: one talks to the API of the virtual infrastructure, and the second connects to each virtual machine created via SSH, and it starts something there, resulting in the virtual machine receiving all the necessary software and the necessary pieces of the client application, and these pieces starts up.  To be honest, this is the most complex application that I wrote in my life, I think, will go as an example.  Language - Java, interspersed with Scala. <br><br><h3>  Spring and tests.  We test business logic using mock tests </h3><br><br>  It is very easy to test applications on Spring.  One of the reasons for using Spring is that it‚Äôs easy to test with it.  ‚ÄúA rabbit is one who lives in a hole.  Nora is where the rabbit lives ‚Äù¬© <br><br>  Interface: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeploymentService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Deployment </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deploy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Application application, DeploymentDescription deploymentDescription)</span></span></span></span>; }</code> </pre> <br><br>  Implementation: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeploymentServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeploymentService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DeploymentRepository deploymentRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DeploymentMaker deploymentMaker; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> VirtualInfrastructureService virtualInfrastructureService; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeploymentServiceImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DeploymentRepository deploymentRepository, DeploymentMaker deploymentMaker, VirtualInfrastructureService virtualInfrastructureService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.deploymentRepository = deploymentRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.deploymentMaker = deploymentMaker; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.virtualInfrastructureService = virtualInfrastructureService; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Deployment </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deploy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Application application, DeploymentDescription deploymentDescription)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   Deployment Deployment deployment = deploymentMaker.makeDeployment(application, deploymentDescription); deploymentRepository.save(deployment); try { virtualInfrastructureService.launchVirtualMachines(deployment.getVirtualMachineDescriptors()); } catch (VirtualInfrastructureException e) { throw new DeploymentUnsuccsessfullException(e); } return deployment; } }</span></span></code> </pre><br><br>  In principle, it is clear what it does.  Of course, the real code is a bit more complicated, but not by much.  First, we test DeploymentService.deploy () on the forehead using the JMock mock library <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeploymentServiceMockTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockObjectTestCase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DeploymentRepository deploymentRepository = mock(DeploymentRepository.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DeploymentMaker deploymentMaker = mock(DeploymentMaker.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> VirtualInfrastructureService virtualInfrastructureService = mock(VirtualInfrastructureService.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DeploymentServiceImpl deploymentService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ deploymentService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeploymentServiceImpl(deploymentRepository, deploymentMaker, virtualInfrastructureService); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSuccessfulDeploymentSavedAndVMsLaunched</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Application app = makeValidApplication(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DeploymentDescription dd = makeValidDeploymentDescription(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Deployment deployment = helperMethodToCreateDeployment(); checking(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Expectations(){{ one(deploymentMaker).makeDeployment(app, dd);will(returnValue(deployment)); one(deploymentRepository).save(deployment); one(virtualInfrastructureService).launchVirtualMachines(deployment.getVirtualMachineDescriptors()); }}); deploymentService.deploy(application, deploymentDescription); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testExceptionIsTranslated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Application app = makeValidApplication(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DeploymentDescription dd = makeValidDeploymentDescription(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Deployment deployment = helperMethodToCreateDeployment(); checking(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Expectations(){{ one(deploymentMaker).makeDeployment(app, dd);will(returnValue(deployment)); one(deploymentRepository).save(deployment); one(virtualInfrastructureService).launchVirtualMachines(deployment.getVirtualMachineDescriptors());will(throwException(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> VirtualInfrastructureException(<span class="hljs-string"><span class="hljs-string">"error message"</span></span>))); }}); ` <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { deploymentService.deploy(application, deploymentDescription); fail(<span class="hljs-string"><span class="hljs-string">"Expected DeploymentUnsuccsessfullException!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (DeploymentUnsuccsessfullException e) { <span class="hljs-comment"><span class="hljs-comment">//expected } }</span></span></code> </pre><br><br>  What is important and interesting?  First, the mock tests allow us to test isolated methods without thinking about what these methods cause.  Secondly, the writing of tests greatly affects the structure of the code.  The first variant of the deploy () method, naturally, did not call DeploymentMaker.makeDeployment (), but the same method inside DeploymentServiceImpl.  When I started writing a test, I found that at this stage I was not interested in writing tests for all the options that makeDeployment performs.  They have nothing to do with the actions in the deploy () method, which simply has to write a new object to the database, and start the process of creating virtual machines.  Therefore, I rendered the logic of makeDeployment () into a separate helper class.  I will test it in completely different ways, because the state of the application and deploymentDescription objects is important for its operation.  In addition, I discovered that after DeploymentMaker has been tested, I can use it in other tests to create test data.  By the way, JMock has the ability to do mocks not only for interfaces, but also for instances of objects.  To do this, add setImpostorizer (ClassImpostorizer.INSTANCE) to setUp ().  I am sure that there is something similar in other mock libraries. <br><br>  To finish with this service, it remains: <br><br><h3>  Testing database interaction </h3><br><br>  As I wrote above, we use Hibernate to write our objects to the database and read them from it.  One of the rules for writing good tests is ‚ÄúDon't test libraries.‚Äù  In this case, this means that we can trust the authors of Hibernate that they have already tested all possible aspects of writing and reading various object graphs.  What we need to confirm with tests is the correctness of our mappings.  Plus it's nice to write a small number of integration tests, i.e.  Run DeploymentService.deploy () on a real base and make sure that there are no problems. <br><br>  As far as I know, the following method of testing interaction with databases is recommended: each test method works in a transaction, and at the end of the test a rollback is produced.  Honestly, I don't like it.  The method we use allows you to test more complex database operations that perform multiple transactions.  To do this, we use Hypersonic, an SQL-compatible database written in Java and able to work in memory.  All of our database tests create a Spring context, which instead of a real PostgreSQL or MySQL uses Hypersonic.  Specific details are beyond the scope of this post, want details - write, tell. <br><br>  An abstract class is created as the basis for all of our tests.  In fact, we used <a href="http://www.chrisrichardson.net/kb/testing/ormunit/ORMUnitCookbook.html">ORMUnit</a> , which stupidly re- <a href="http://www.chrisrichardson.net/kb/testing/ormunit/ORMUnitCookbook.html">creates the</a> entire database structure before each test.  If you use a real database, you can grow old until all the tests pass.  But when using Hypersonic, everything happens very quickly.  True true! <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeploymentRepositoryTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HibernatePersistenceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autorwired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DeploymentRepository deploymentRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSaveAndLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Deployment deployment = DeploymentMother.makeSimpleDeployment(); deploymentRepository.add(deployment); Deployment loadedDeployment = deploymentRepository.getById(deployment.getId()); assertDeploymentEquals(deployment, loadedDeployment); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">assertDeploymentEquals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Deployment expected, Deployment actual)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    .   -  Deployment.equals(...),     //  EqualsBuilder (,   Apache Commons-lang).    id. } }</span></span></code> </pre><br><br>  Pay attention to DeploymentMother.  We have adopted such designations for the helper classes that create entities.  Such entities are used for tests.  Our DeploymentMother has the following methods: makeSimpleDeployment (), makeMutliVmDeploymentWithMasterSlaveReplication (), makeFailedDeployment (), makeStartedDeploymentWithFailedVM (), and so on.  In principle, this is the implementation of one of the DDD options for the poor.  Personally, I prefer this approach to reading data from YAML or XML for the same reason that I prefer Scala, rather than Groovy - type checking at compile time.  If I change something in my classes (and if there are a sufficient number of tests, refactroing turns from a dangerous perversion into a pleasant occupation), then the compiler immediately shows me what problems will arise in the tests and what I will need to pay attention to. <br><br>  When working with Hibernate, the fun begins when writing complex queries.  We use a very useful library of <a href="http://code.google.com/p/aridpojos/">Arid pojos</a> (the same author as ORMUnit), which allows us not to write a huge pile of the same type of call request code.  For example, to select all deployments that are ready for launch, it is enough to: a) write a query named findDeploymentsReadyToLaunch in the Hibernate mapping, and define the List &lt;Deployment&gt; method FindDeploymentsReadyToLaunch () in the DeploymentRepository interface.  And that's all, when you start arid-pojos, it will generate code that will launch this particular query.  Again, we are not testing libraries, so we just need to create test data and make sure that what we expect is returned from the database.  Add to DeploymentRepositoryTest: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testRetrieveReadyToLaunch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">5</span></span>; i++) { deploymentRepository.add(DeploymentMother.makeReadyToLaunchDeployment()); } deploymentRepository.add(DeploymentMother.makeNewDeployment()); List&lt;Deployment&gt; result = deploymentRepository.findDeploymentsReadyToLaunch(); assertEquals(<span class="hljs-number"><span class="hljs-number">5</span></span>, result.size()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Deployment d : result) { assertTrue(deployment.isReadyToLaunch()); } <span class="hljs-comment"><span class="hljs-comment">//,    ,    ,    , ? }</span></span></code> </pre><br><br><h3>  Small digression: problems in previous examples </h3><br>  In principle, the above test samples work fine.  What is the problem?  The fact that they are not very easy to read.  We are trying to ensure that the tests could easily restore the requirements for the project and the code.  What can be done to make even such simple tests easier to read?  Use intention-revealing method names, i.e.  names of methods that reveal intentions (this is already a bit of BDD).  For example, to call the test not testSaveAndLoad, but testSavedDeploymentLoadedCorrectly.  Not testRetrieveReadyToLaunch, but testOnlyReadyToLaunchDeploymentsRetrieved. <br><br>  Next, assertEquals (5, result.size ()) - requires a little tense to understand what the programmer wanted to say with this.  Instead, it's better to create an assertSize (int expected, Collection collection) method in your TestUtils (do you have TestUtils, right ?!).  Or even better: <br><br>  In TestUtils: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">assertCollection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expectedSize, ElementAsserter&lt;T&gt; asserter, Collection&lt;T&gt; actual)</span></span></span><span class="hljs-function"> </span></span>{ assertSize(expectedSize, actual.size()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (T element : actual) { asserter.assertElement(element); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ElementAsserter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">assertElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T element)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkElement(element)) fail(getFailureDescription(element)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T element)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//  ,           protected String getFailureDescription(T element) { return "  "; } }</span></span></code> </pre><br><br>  And then in our test we can do this: <br><br><pre> <code class="java hljs"> ElementAsserter readyToLaunch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ElementAsserter&lt;Deployment&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Deployment d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d.isReadyToLaunch(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFailureDescription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Deployment d)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.format(<span class="hljs-string"><span class="hljs-string">"Deployment with id %d and name %s is NOT ready to be launched!"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">assertAllReadyToLaunch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expectedSize, List&lt;Deployment&gt; deployments)</span></span></span><span class="hljs-function"> </span></span>{ TestUtils.assertCollection(expectedSize, a, deployments); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testOnlyReadyToLaunchDeploymentsRetrieved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">5</span></span>; i++) { deploymentRepository.add(DeploymentMother.makeReadyToLaunchDeployment()); } deploymentRepository.add(DeploymentMother.makeNewDeployment()); assertAllReadyToLaunch(<span class="hljs-number"><span class="hljs-number">5</span></span>, deploymentRepository.findDeploymentsReadyToLaunch()); }</code> </pre><br><br>  You can also hide the creation of five necessary objects in a separate method, so that it becomes quite clear.  No limits to perfection.  Why all this?  And then, that the programmer does not have excuses from writing new tests.  If all that is required of him is two lines of code (it is very easy to write tests to call a method to create some objects and determine if some condition is checked).  And the process gives you an incomparable pleasure in the realization that your code can be directly run live ‚Äî everything will work. <br><br><h3>  So what is next? </h3><br><br>  That's all for today.  If there is interest in habra people, in a couple of days there will be a continuation in which I plan to tell about (our) approach to testing the application entirely, communicating with external services, and answer questions.  There will also be more about "complex infrastructure for simple tests." </div><p>Source: <a href="https://habr.com/ru/post/121276/">https://habr.com/ru/post/121276/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../121270/index.html">Hacker group Lulz Security reached the sites of Bethesda Softworks and the US Senate</a></li>
<li><a href="../121272/index.html">Game section on the 27th Point in Moscow in conjunction with Alawar Entertainment</a></li>
<li><a href="../121273/index.html">Let me go out!</a></li>
<li><a href="../121274/index.html">Solar Impulse aircraft will fly from Brussels to Paris</a></li>
<li><a href="../121275/index.html">Tips for reading</a></li>
<li><a href="../121277/index.html">nanoCAD 3.0: pleasant things</a></li>
<li><a href="../121278/index.html">Lecture "Video games as a new kind of media"</a></li>
<li><a href="../121279/index.html">Pilot issue</a></li>
<li><a href="../121281/index.html">Agile manifesto (human remix)</a></li>
<li><a href="../121282/index.html">Samsung Chromebook: to be or not to be? We need your voice</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>