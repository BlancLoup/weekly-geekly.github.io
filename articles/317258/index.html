<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Blocking duplicate symfony —Åommand</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I want to bring to your attention a special case for solving the "inconveniences" associated with the periodic launch of processes in the event ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Blocking duplicate symfony —Åommand</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/026/37b/8a5/02637b8a591446398a7c51ec53c42800.jpg" alt="image"><br><br>  Today I want to bring to your attention a special case for solving the "inconveniences" associated with the periodic launch of processes in the event that the previous one has not yet been completed.  In other words, blocking running processes in <i>symfony / console</i> .  But everything would be too banal if it were not for the need to block among the group of servers, and not on a single one. <br><br>  <i>Given: The</i> same process that runs on <b>N</b> servers. <br>  <i>Task:</i> Make it so that only one is launched at a time. <br><a name="habracut"></a><br>  The most popular solutions that can be found in the "open spaces": 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  lock through database; </li><li>  third-party applications; </li><li>  native use of lock file </li></ol><br>  The main disadvantages of each of them are: <br><br>  <b>Database</b> <br><br><ul><li>  requires a connection to the database in each running script; </li><li>  need a table; </li><li>  need a code that serves the record / delete; </li><li>  Difficulty in ‚Äúdropping‚Äù a script in order to remove a lock, watchDog is needed; </li><li>  Difficulties in the "fall" of the base </li></ul><br>  <b>Third-party applications (for example, <a href="https://launchpad.net/ubuntu/%2Bsource/run-one">run-one</a> for Ubuntu)</b> <br><br><ul><li>  not all platforms have the same applications with equally predictable behavior; </li><li>  it is not always possible to install something extra; </li><li>  not everyone can block "online" </li></ul><br>  <b>Native lock files</b> <br><br><ul><li>  each team must be accompanied by the creation of a file; </li><li>  how many teams - so many lines with the path and name of the lock-file </li></ul><br>  The most common, of course, is the 3rd option, but it creates a lot of inconvenience in the presence of a large number of servers and processes.  So I decided to share the idea of ‚Äã‚Äãwriting a <i>singleton-</i> command based on <i>symfony / console</i> .  But the idea can be used in any other framework. <br><br>  So, the first thing we had to give up was a <a href="http://php.net/manual/ru/function.flock.php">flock</a> , which is used, for example, in <a href="http://symfony.com/doc/3.1/components/filesystem/lock_handler.html">LockHandler</a> by <i>symfony</i> .  It does not allow locking among multiple servers. <br><br>  Instead, we will create a lock-file in a directory shared between servers, using a small <a href="https://github.com/jced-artem/lock-service">service</a> , this is practically an analogue of <i>LockHandler</i> , but with a ‚Äúsawed‚Äù <i>flock</i> . <br><br>  The next thing you need to get rid of is the need for each team to manually check the lock, and, most importantly, remove it, because the script does not always end where we expect. <br><br>  To do this, I propose to apply something similar to Mediator - to implement and finalize the standard <i>execute ()</i> method, which will be launched at the start of the command and impose the use of the new <i>lockExecute ()</i> method. <br><br>  What is it for: <br><br><ul><li>  the entire command code will be contained in the <i>lockExecute ()</i> method; </li><li>  The <i>execute ()</i> method called at startup will create a lock, register a lock <i>release</i> when the script is dropped / complete, and only then execute <i>lockExecute ()</i> </li></ul><br>  In summary, the standard <i>symfony</i> command: <br><br><pre><code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateUserCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } protected function execute(InputInterface $input, OutputInterface $output) { // ... } }</span></span></code> </pre> <br>  would look like this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateUserCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingletonCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingletonCommandInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } public function lockExecute(InputInterface $input, OutputInterface $output) { // ... } }</span></span></code> </pre> <br>  It is not necessary to write much more code and at the same time it will be guaranteed to be launched only 1 time, no matter how many servers try to do it.  The only condition is the general directory for lock-files. <br><br>  Already a ready-made solution and more details can be viewed on the githab: <a href="https://github.com/jced-artem/singleton-command">singleton-command</a> <br><br>  UPD: as was rightly observed - in the case of "hard" crashes of scripts, it is possible to save lock-files.  Therefore, it is advisable to organize a demon that will ‚Äúwatch‚Äù for ‚Äústale‚Äù lock-files. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/317258/">https://habr.com/ru/post/317258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317248/index.html">Unchangeable JavaScript: how it is done with ES6 and higher</a></li>
<li><a href="../317250/index.html">How to increase the Open Rate by 50%: tips and case from SendPulse</a></li>
<li><a href="../317252/index.html">Development for Sailfish OS: Work with LocalStorage</a></li>
<li><a href="../317254/index.html">Overview of the Instana application monitoring system</a></li>
<li><a href="../317256/index.html">Promise JavaScript Guide for Newbies</a></li>
<li><a href="../317262/index.html">DIY Genetic Algorithm</a></li>
<li><a href="../317264/index.html">HighLoad ++ 2016: how it was</a></li>
<li><a href="../317268/index.html">Russian AI Cup. Intermediate results of the championship</a></li>
<li><a href="../317270/index.html">Elusive bugs: errors that have escaped all tests and checks</a></li>
<li><a href="../317272/index.html">Security Week 49: Google fuzz open source, Android Trojan steals user accounts, Microsoft fixes old bug</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>