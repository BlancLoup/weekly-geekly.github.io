<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>.NET in an unmanaged environment: calling managed code from unmanaged</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you probably remember from my previous article , the interaction of unmanaged and managed code presents a certain problem, even for experienced dev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>.NET in an unmanaged environment: calling managed code from unmanaged</h1><div class="post__text post__text-html js-mediator-article">  As you probably remember from my <a href="http://habrahabr.ru/blogs/net/58031/">previous article</a> , the interaction of unmanaged and managed code presents a certain problem, even for experienced developers.  The reason for this is the need to understand what processes occur when the data crosses the CLR boundary. <br><br>  Unfortunately, often the problem of establishing interaction arises among those developers who are poorly familiar with the inside technology of COM and the capabilities of .NET for ensuring interaction.  This is normal - you can not know everything.  Therefore, I will not explain here the whole essence of the problem of marshalling data from unmanaged to managed and back, but I‚Äôll just give you some working recipes that will help you when you need urgently and tomorrow, and you look at the English edition of the book Inside OLE and you understand there is no way to figure this out for the day. <br><br>  However, for those who are good at it, there is a small bonus at the end of the article - a way to organize out-process COM on .NET.  Honestly, I honestly thought that it was impossible to do out-process COM using .NET, but just yesterday it turned out that it could not.  In this regard, I probably will not talk about the .NET Pipe RPC architecture - it is quite complex, however, out-process COM easily replaces all the opportunities provided to it. <br><a name="habracut"></a><br>  In general, there are two mechanisms offered by Microsoft - dll export and COM export.  Yes, that's right - despite the fact that very few people know about the possibility of exporting functions of a managed-code, it still exists.  However, I will not talk about it.  The fact is that the export of functions is not supported by .NET at a high level, that is, it is impossible to simply describe a function, hang some [DllExport] attribute on it and enjoy life - you will have to either <a href="http://blog.undsoft.com/programming/export-managed-to-unmanaged/">go into the IL jungle</a> or <a href="http://netobf.com/obf_optimization_dllexport">use third-party solutions.</a>  Both solutions cannot be called satisfactory, and therefore I will not dwell on this in detail - this mechanism has no practical use at all. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The mechanism of COM export is good because its work is transparent enough for a person who understands COM, but for a .NET developer this is a dark forest.  That is, for successful work with this mechanism, it is necessary to understand what COM technology is, how calls are made, how parameters should be transmitted, and so on.  However, not everyone has knowledge, and therefore common recipes.  Let's try to create an inproc-COM server in C # and access it, for example, from VBA.  To do this, we use Excel and its built-in scripting language. <br><br>  Why did I choose Excel?  As experience shows, VBA is quite capricious with respect to memory leaks by the client - in the case of the slightest leakage, Excel will fall either immediately upon completion of the procedure, or by unloading the dll (that is, somewhere in a minute after completion of the procedure).  Thus, the tilt of Excel helps us understand that we are doing something wrong. <br><br>  Let's start.  Let's create a new assembly, let's call it, as is customary, TestInprocCOM and make one CoClass there that will implement the interfaces through which we will pull it from VBA. <br><br>  But for a start, let's define what we need from the interaction.  As experience shows, most often required to transfer <br><ol><li>  lines </li><li>  arrays </li><li>  structures </li><li>  other objects </li></ol><br><br>  The crown of our today's work will be the transfer of an array of structures in which the lines lie.  This is enough for 99% of real applications.  For the remaining 1%, the information will be too specific for Habr's wide audience, and therefore I will not focus on this. <br><br>  I apologize for the too long introduction.  I also have to apologize for too detailed an explanation of many seemingly trivial things - I did not know what the level of those people who would read this article was, and wanted to make it understandable to absolutely everyone. <br><br>  So let's get started. <br><br><h1>  Implementation of inproc com. </h1><br><br>  To begin with, we define the interface that will be responsible for the calls.  Comments on what this or that line is for, I will do right in the code so as not to increase the already rather big size of the article. <br><br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">// ,     COM</font> <br> [ComVisible( <font color="#0000ff">true</font> )] <br> <font color="#008000">//    .  ,          </font> <br> <font color="#008000">//     VBA,      .  ,   </font> <br> <font color="#008000">//    C++</font> <br> [InterfaceType(ComInterfaceType.InterfaceIsDual)] <br> <font color="#008000">//  GUID .     -      ,  .</font> <br> [ <font color="#2B91AF">Guid</font> ( <font color="#A31515">"5AC0488E-9CAC-4032-B59A-37B8B277C4EF"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">interface</font> ITestInterface <br> { <br> <font color="#008000">//    COM-   ,     .</font> <br> <font color="#008000">//    ,       .NET</font> <br> <font color="#008000">//        BSTR.</font> <br> <font color="#0000ff">void</font> Hello([MarshalAs(UnmanagedType.BStr)] <font color="#0000ff">ref</font> <font color="#0000ff">string</font> name); <br> <br> <font color="#008000">//  ,      .</font> <br> [ <font color="#0000ff">return</font> : MarshalAs(UnmanagedType.BStr)] <br> <font color="#0000ff">string</font> Say(); <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As you can see, each parameter has a MarshalAs attribute.  It is he who says how to marshall the parameters when crossing the CLR boundary.  It is not necessary to set it if the marshalling defaults to what behavior you need.  However, the default marshall strings are as LPTStr, and therefore for marshalling strings in the form of BSTR you should always set. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//   CoClass</font> <br> [ComVisible( <font color="#0000ff">true</font> )] <br> [ <font color="#2B91AF">Guid</font> ( <font color="#A31515">"B06CC21C-BCBB-4dde-8ED3-BFBD9A31AD6E"</font> )] <br> <font color="#008000">// ProgId   ,       ,    GUID</font> <br> [ProgId( <font color="#A31515">"TestInprocCOM.TestCoClass"</font> )] <br> <font color="#008000">// ,   CoClass-        .</font> <br> <font color="#008000">//   ,     ,    COM</font> <br> <font color="#008000">//        - ,    </font> <br> <font color="#008000">//        ,     .</font> <br> [ClassInterface(ClassInterfaceType.None)] <br> <font color="#008000">//  default interface.      VBA,   ++   .</font> <br> [ComDefaultInterface( <font color="#0000ff">typeof</font> (ITestInterface))] <br> <font color="#0000ff">public</font> <font color="#0000ff">class</font> TestCoClass : ITestInterface <br> { <br> <font color="#0000ff">public</font> <font color="#0000ff">void</font> Hello( <font color="#0000ff">ref</font> <font color="#0000ff">string</font> name) <br> { <br> name = <font color="#A31515">"Hello, "</font> + name; <br> } <br> <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> Say() <br> { <br> <font color="#0000ff">return</font> <font color="#A31515">"OK"</font> ; <br> } <br> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  The object is created.  We compile it, and then register it in the system using the <code>regasm /tlb:testinproccom.tlb testinproccom.dll /codebase.</code> <br><br>  Everything, we have a registered object, there is a type library for it (tlb-file) and we can proceed to the client.  To do this, open Excel, go to the Visual Basic Editor, connect our type library via Tools-&gt; References, and write the following: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">Dim</font> a <font color="#0000ff">As</font> TestCoClass <br> <font color="#0000ff">Dim</font> s <font color="#0000ff">As</font> <font color="#0000ff">String</font> <br> <br> <font color="#0000ff">Sub</font> main() <br> <font color="#0000ff">Set</font> a = <font color="#0000ff">New</font> TestCoClass <br> s = <font color="#A31515">"mike"</font> <br> a.Hello s <br> MsgBox s <br> msgbox a.Say() <br> <font color="#0000ff">End</font> Sub</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  We should get two message boxes - the first ‚ÄúHello, mike‚Äù and the second ‚ÄúOK‚Äù.  Congratulations, we did everything right. <br><br>  However, one line will not be full.  Let's try to transfer the structure.  To do this, we define it. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[ComVisible( <font color="#0000ff">true</font> )] <br> <font color="#008000">// ,           ,  </font> <br> <font color="#008000">//     unmanaged.</font> <br> [StructLayout(LayoutKind.Sequential)] <br> [ <font color="#2B91AF">Guid</font> ( <font color="#A31515">"E1AB60D5-F8F5-41fe-BD0D-AE2AC94237DD"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">struct</font> MyStruct <br> { <br> <font color="#008000">// </font> <br> [MarshalAs(UnmanagedType.BStr)] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> wow; <br> <font color="#008000">// .      SafeArray,         </font> <br> <font color="#008000">// ,  VBA  JavaScript. ,   C++   SafeArray   </font> <br> <font color="#008000">// ,     .        -  </font> <br> <font color="#008000">//     .</font> <br> [MarshalAs(UnmanagedType.SafeArray, SafeArraySubType = VarEnum.VT_I4)] <br> <font color="#0000ff">public</font> <font color="#0000ff">int</font> [] gig; <br> <font color="#008000">//         IDispatch.    .NET </font> <br> <font color="#008000">//      object.</font> <br> [MarshalAs(UnmanagedType.IDispatch)] <br> <font color="#0000ff">public</font> <font color="#0000ff">object</font> self; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Now, let's expand the interface.  Let's add one more function there. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//        out  ref  -    </font> <br> <font color="#008000">//          .</font> <br> <font color="#0000ff">void</font> GetStruct([MarshalAs(UnmanagedType.Struct)] <font color="#0000ff">ref</font> MyStruct ms);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And we implement it in our CoClass. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> GetStruct( <font color="#0000ff">ref</font> MyStruct ms) <br> { <br> ms.gig = <font color="#0000ff">new</font> <font color="#0000ff">int</font> [] { 1, 2, 3, 4, 5 }; <br> ms.self = <font color="#0000ff">this</font> ; <br> ms.wow = <font color="#A31515">"wow"</font> ; <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  As you can see, we put the this parameter in self - that is, after calling this function in VBA, we will have in this field a link to our object with which we can work with late binding methods (that is, using IDispatch).  Let's check the functionality of the object - we recompile, reregister, open Excel again and write the following code: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">Dim</font> a <font color="#0000ff">As</font> TestCoClass <br> <font color="#0000ff">Dim</font> s <font color="#0000ff">As</font> <font color="#0000ff">String</font> <br> <font color="#0000ff">Dim</font> b <font color="#0000ff">As</font> MyStruct <br> <br> <font color="#0000ff">Sub</font> main() <br> <font color="#0000ff">Set</font> a = <font color="#0000ff">New</font> TestCoClass <br> s = <font color="#A31515">"mike"</font> <br> a.Hello s <br> MsgBox s <br> b.wow = <font color="#A31515">"baaa"</font> <br> a.GetStruct b <br> MsgBox b.gig(3) <br> MsgBox b.self.Say() <br> MsgBox b.wow <br> <font color="#0000ff">Set</font> a = <font color="#0000ff">Nothing</font> <br> <font color="#0000ff">End</font> Sub</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  If everything went well, then we have the following message boxes <br><ol><li>  Hello mike </li><li>  four </li><li>  Ok </li><li>  wow </li></ol><br><br>  Pay attention to <code>b.self.Say()</code> .  We call the Say function of our object using late binding.  This mechanism is ensured by the fact that we set the interface as dual (that is, capable of working through vtable and IDispatch simultaneously).  That is why it is better to always set interfaces as dual ‚Äî this does not require any work, but it provides many advantages. <br><br>  By the way, indirect evidence that everything is working correctly are the hints of the VBA environment. <br><br>  And finally, the crown number.  Array of structures with strings.  Define the structure. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[ComVisible( <font color="#0000ff">true</font> )] <br> [StructLayout(LayoutKind.Sequential)] <br> [ <font color="#2B91AF">Guid</font> ( <font color="#A31515">"1D40391F-C9CF-42ed-9C9E-4991B3F22907"</font> )] <br> <font color="#0000ff">public</font> <font color="#0000ff">struct</font> MyStruct2 <br> { <br> [MarshalAs(UnmanagedType.BStr)] <br> <font color="#0000ff">public</font> <font color="#0000ff">string</font> param; <br> <br> <font color="#0000ff">public</font> MyStruct2( <font color="#0000ff">string</font> par) <br> : <font color="#0000ff">this</font> () <br> { <br> param = par; <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  We define a function in the interface <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#008000">//     safearray  custom-  -  .</font> <br> <font color="#0000ff">void</font> SetMyStruct2([MarshalAs(UnmanagedType.SafeArray, SafeArrayUserDefinedSubType = <font color="#0000ff">typeof</font> (MyStruct2))] <font color="#0000ff">out</font> MyStruct2[] structs);</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Simply?  And no one said it would be difficult.  The only thing that is required when setting marshalling is to represent how the client will work with your parameters. <br><br>  Now, let's implement the function in CoClass. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">public</font> <font color="#0000ff">void</font> SetMyStruct2( <font color="#0000ff">out</font> MyStruct2[] structs) <br> { <br> structs = <font color="#0000ff">new</font> MyStruct2[] { <font color="#0000ff">new</font> MyStruct2( <font color="#A31515">"bla1"</font> ), <font color="#0000ff">new</font> MyStruct2( <font color="#A31515">"bla2"</font> ), <font color="#0000ff">new</font> MyStruct2( <font color="#A31515">"bla3"</font> ) }; <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Compiling, registering, and - a test case that tells us that everything went smoothly. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">Dim</font> a <font color="#0000ff">As</font> TestCoClass <br> <font color="#0000ff">Dim</font> sa() <font color="#0000ff">As</font> MyStruct2 <br> <br> <font color="#0000ff">Sub</font> main() <br> <font color="#0000ff">Set</font> a = <font color="#0000ff">New</font> TestCoClass <br> <br> a.SetMyStruct2 sa <br> <font color="#0000ff">For</font> i = 0 <font color="#0000ff">To</font> 2 <br> MsgBox sa(i).param <br> <font color="#0000ff">Next</font> i <br> <br> <font color="#0000ff">Set</font> a = <font color="#0000ff">Nothing</font> <br> <font color="#0000ff">End</font> Sub</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And if everything went well, then we should receive the following messages: <br><br><ol><li>  bla1 </li><li>  bla2 </li><li>  bla3 </li></ol><br><br>  Hooray us! <br><br><h2>  Outproc com. </h2><br><br>  However, the architecture of inproc COM does not always suit us - for example, if we want to create a singleton.  Since the dll is projected in the process memory field, different processes can raise the same class instance, which for each process will be unique and will not know anything about its other instances.  This is not always what we need. <br><br>  According to the COM specifications, the outproc implementation of the server is as follows.  When a client calls <code>CoGetClassObject</code> with the appropriate parameters, COM first looks at its internal table of class factories, looking for the CLSID specified by the client.  If there is no class factory in the table, then COM accesses the registry and starts the corresponding EXE module.  The task of the latter is to register its class factories as soon as possible so that COM can find them.  To register an EXE class factory, use the COM <code>CoRegisterClassObject. <br></code> function <code>CoRegisterClassObject. <br></code> <code>CoRegisterClassObject. <br></code> <br>  So our task is to do it.  To do this, create a new project (console EXE application), transfer the code of our interfaces, structures and classes to it.  Now, we define the required registration code in the Main function. <br><br>  According to COM specifications, outproc servers must support self-registration with the / register key.  This is done as follows: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">static</font> <font color="#0000ff">private</font> <font color="#0000ff">void</font> RegisterManagedType(Type type) <br> { <br> <font color="#2B91AF">String</font> strClsId = <font color="#A31515">"{"</font> + Marshal.GenerateGuidForType(type).ToString().ToUpper(CultureInfo.InvariantCulture) + <font color="#A31515">"}"</font> ; <br> <br> <font color="#008000">// Create the HKEY_CLASS_ROOT\CLSID key.</font> <br> <font color="#0000ff">using</font> (RegistryKey ClsIdRootKey = Registry.ClassesRoot.CreateSubKey( <font color="#A31515">"CLSID"</font> )) <br> { <br> <font color="#008000">// Create the HKEY_CLASS_ROOT\CLSID\&lt;CLSID&gt; key.</font> <br> <font color="#0000ff">using</font> (RegistryKey ClsIdKey = ClsIdRootKey.CreateSubKey(strClsId)) <br> { <br> ClsIdKey.SetValue( <font color="#A31515">""</font> , type.FullName); <br> <br> <font color="#008000">// Create the HKEY_CLASS_ROOT\CLSID\&lt;CLSID&gt;\LocalServer32 key.</font> <br> <font color="#0000ff">using</font> (RegistryKey LocalServerKey = ClsIdKey.CreateSubKey( <font color="#A31515">"LocalServer32"</font> )) <br> { <br> LocalServerKey.SetValue( <font color="#A31515">""</font> , ( <font color="#0000ff">new</font> <font color="#2B91AF">Uri</font> ( <font color="#2B91AF">Assembly</font> .GetExecutingAssembly().CodeBase)).LocalPath); <br> } <br> } <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  Finally, the Main function. <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">[MTAThread] <br> <font color="#0000ff">static</font> <font color="#0000ff">void</font> Main( <font color="#0000ff">string</font> [] args) <br> { <br> <br> <font color="#0000ff">if</font> ((args.Length == 1) &amp;&amp; (args[0] == <font color="#A31515">"register"</font> )) <br> { <br> RegisterManagedType( <font color="#0000ff">typeof</font> (TestCoClass)); <br> <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Server registered, press any key to exit"</font> ); <br> <br> <font color="#2B91AF">Console</font> .ReadKey(); <br> <br> <font color="#0000ff">return</font> ; <br> } <br> <br> <font color="#008000">//     ?</font> <br> <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  And now we have a problem - call <code>CoRegisterClassObject</code> to register class factories.  It would seem that a simple solution is to use the platform invoke for this function and enjoy life.  However, it will not work - Microfost explicitly prohibits p / invoke for the function of registering class factories. <br><br>  The solution came suddenly from the forums.  It turns out that in .NET there is a class with an analogue of this function, which serves specifically for this purpose, and it is called <a href="http://msdn.microsoft.com/en-us/library/system.runtime.interopservices.registrationservices.aspx"><code>RegistrationServices</code></a> .  It has a <code>RegisterTypeForComClients</code> method that does exactly the same thing that we require from the <code>CoRegisterClassObject.</code> method <code>CoRegisterClassObject.</code> <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">RegistrationServices rs = <font color="#0000ff">new</font> RegistrationServices(); <br> <br> rs.RegisterTypeForComClients( <br> <font color="#0000ff">typeof</font> (TestCoClass), <br> RegistrationClassContext.RemoteServer | RegistrationClassContext.LocalServer | RegistrationClassContext.InProcessServer, <br> RegistrationConnectionType.MultipleUse); <br> <br> <font color="#2B91AF">Console</font> .WriteLine( <font color="#A31515">"Server started, press any key to exit"</font> ); <br> <br> <font color="#2B91AF">Console</font> .ReadKey();</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br><br>  We compile, register, test, without forgetting to pre-delete registration inproc COM dll.  Hooray us! <br><br></div><p>Source: <a href="https://habr.com/ru/post/58240/">https://habr.com/ru/post/58240/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../58231/index.html">Automatic restart of the pSeries server after a power failure</a></li>
<li><a href="../58232/index.html">Music without monopoly (comparing digital music online stores in the US and Russia)</a></li>
<li><a href="../58234/index.html">Questions to the winners of the World Final ACM ICPC</a></li>
<li><a href="../58235/index.html">Kaspersky became the winner of the State Prize in the field of science and technology</a></li>
<li><a href="../58237/index.html">Flexible base_url</a></li>
<li><a href="../58241/index.html">Touchscreen Phone for $ 70</a></li>
<li><a href="../58245/index.html">Yahoo! Open Hack Day - London</a></li>
<li><a href="../58250/index.html">Google office in Ukraine</a></li>
<li><a href="../58251/index.html">And let's make a couple of free styles under WordPress.</a></li>
<li><a href="../58252/index.html">On the pricing policy of operating systems on "ultra-cheap laptops"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>