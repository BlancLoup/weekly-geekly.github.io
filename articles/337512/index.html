<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Typical use of Observable objects in Angular 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to your attention the typical options for using Observable objects in components and services of Angular 4. 



 Subscribe to a router param...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Typical use of Observable objects in Angular 4</h1><div class="post__text post__text-html js-mediator-article"><p>  I present to your attention the typical options for using Observable objects in components and services of Angular 4. </p><br><p><img src="https://habrastorage.org/web/957/c53/6ac/957c536acad345318908516464231f02.jpg"></p><br><h2 id="podpiska-na-parametr-routera-i-maping-na-drugoy-observable">  Subscribe to a router parameter and map to another Observable </h2><br><p> <em>Task:</em> When opening the <code>example.com/#/users/42</code> page, get user data by <code>userId</code> . </p><br><p>  <em>Solution:</em> When initializing the <code>UserDetailsComponent</code> component <code>UserDetailsComponent</code> we subscribe to the parameters of the router.  That is, if the <code>userId</code> changes, our subscription will trigger.  Using the obtained <code>userId</code> , we get <code>Observable</code> with user data from the <code>userService</code> service. </p><br><pre> <code class="hljs pgsql">// UserDetailsComponent ngOnInit() { this.route.params .pluck(<span class="hljs-string"><span class="hljs-string">'userId'</span></span>) //  userId   .switchMap(userId =&gt; this.userService.getData(userId)) .subscribe(<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> =&gt; this.<span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>); }</code> </pre> <br><img src="https://habrastorage.org/web/134/b43/856/134b438568384f58bcc1d7476bd501ed.jpg" title="say that articles with two pictures before kata get more views"><a name="habracut"></a><br><p><br></p><br><h2 id="podpiska-na-parametr-routera-i-stroku-zaprosa">  Subscribe to a router parameter and query string </h2><br><p>  <em>Task:</em> When you open the <code>example.com/#/users/42?regionId=13</code> page, you need to execute the <code>load(userId, regionId)</code> function <code>load(userId, regionId)</code> .  Where <code>userId</code> we get from the router, and <code>regionId</code> - from the request parameters. </p><br><p>  <em>Solution:</em> We have two sources of events, so let's use the <a href="http://rxmarbles.com/">Observable.combineLatest</a> function, which will work when each of the sources generates an event. </p><br><pre> <code class="hljs coffeescript">ngOnInit() { Observable.combineLatest(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.route.params, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.route.queryParams) .subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([params, queryParams])</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    const userId = params[<span class="hljs-string"><span class="hljs-string">'userId'</span></span>]; const regionId = queryParams[<span class="hljs-string"><span class="hljs-string">'regionId'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.load(userId, regionId); }); }</code> </pre><br><p>  Please note that the created subscriptions to the router will be deleted when the object is destroyed, an angular is following this, so you do not need to unsubscribe from the parameters of the router: </p><br><blockquote>  Router manages it observables it provides and localizes the subscriptions.  Do you need to keep track of the observable params?  <a href="https://stackoverflow.com/questions/38008334/angular2-rxjs-when-should-i-unsubscribe-from-subscription/41177163%3Fnoredirect%3D1">Mark rajcok</a> </blockquote><br><h2 id="ostanovka-animacii-zagruzki-posle-okonchaniya-vypolneniya-podpiski">  Stop loading animation after subscription completion </h2><br><p>  <em>Task:</em> Show download icon after starting saving data and hide it when data is saved or an error occurs. </p><br><p>  <em>Solution:</em> We have the <code>loading</code> variable responsible for displaying the bootloader; after clicking on the button, we set it to <code>true</code> .  And to set it to <code>false</code> use the <code>Observable.finally</code> functions, which is executed after the subscription is completed or if an error has occurred. </p><br><pre> <code class="hljs kotlin">save() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loading = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.userService.save(params) .<span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>(() =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) .subscribe(user =&gt; { <span class="hljs-comment"><span class="hljs-comment">//   }, error =&gt; { //   }); }</span></span></code> </pre> <br><h2 id="sozdanie-sobstvennogo-istochnika-sobytiy">  Creating your own event source </h2><br><p>  <em>Task:</em> Create a <code>lang$</code> variable in <code>configService</code> , to which other components will subscribe and respond when the language changes. </p><br><p>  <em>Solution:</em> Use the <code>BehaviorSubject</code> class to create the <code>lang$</code> variable; </p><br><p>  <a href="https://stackoverflow.com/questions/39494058/behaviorsubject-vs-observable">Differences between</a> <code>BehaviorSubject</code> and <code>Subject</code> : </p><br><ol><li>  <code>BehaviorSubject</code> must be initialized with an initial value; </li><li>  The subscription returns the last value of <code>Subject</code> a; </li><li>  You can get the last value directly through the <code>getValue()</code> function. </li></ol><br><p>  Create a variable <code>lang$</code> and immediately initialize it.  Also add the <code>setLang</code> function to set the language. </p><br><pre> <code class="hljs pgsql">// configService lang$: BehaviorSubject&lt;<span class="hljs-keyword"><span class="hljs-keyword">Language</span></span>&gt; = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BehaviorSubject&lt;<span class="hljs-keyword"><span class="hljs-keyword">Language</span></span>&gt;(DEFAULT_LANG); setLang(lang: <span class="hljs-keyword"><span class="hljs-keyword">Language</span></span>) { this.lang$.next(this.currentLang); //    }</code> </pre> <br><p>  Subscribing to change the language in the component.  The variable <code>lang$</code> is a "hot" Observable object, that is, a subscription requires unsubscribe when the object is destroyed. </p><br><pre> <code class="hljs coffeescript">private subscriptions: Subscription[] = []; ngOnInit() { const langSub = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.configService.lang$ .subscribe(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscriptions.push(langSub); } ngOnDestroy() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscriptions .forEach(s =&gt; s.unsubscribe()); }</code> </pre> <br><h3 id="ispolzovanie-takeuntil-dlya-otpiski">  Use takeUntil to unsubscribe </h3><br><p>  You can unsubscribe with a <a href="https://stackoverflow.com/questions/38008334/angular-rxjs-when-should-i-unsubscribe-from-subscription/41177163">more elegant option</a> , especially if there are more than two subscriptions in the component: </p><br><pre> <code class="hljs javascript">private ngUnsubscribe: Subject&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Subject&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt;<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ngOnInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">configService</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lang$</span></span></span><span class="hljs-function"> .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">takeUntil</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.ngUnsubscribe</span></span></span><span class="hljs-function">) //    .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... }); } ngOnDestroy() { this.ngUnsubscribe.next(); this.ngUnsubscribe.complete(); }</span></span></code> </pre> <br><p>  That is, in order not to lose memory on hot subscriptions, the component will work until the value of <code>ngUnsubscribe</code> changes.  And it will change when ngOnDestroy is <code>ngOnDestroy</code> .  The advantages of this option are that it is enough to add just one line to each of the subscriptions so that the answer works on time. </p><br><h2 id="ispolzovanie-observable-dlya-avtokomplita-ili-poiska">  Use Observable for autocomplete or search </h2><br><p>  <em>Task:</em> Show page suggestions when entering data on a form </p><br><p>  <em>Solution:</em> Sign up for changing the form data, take only the variable input data, set a small delay so that there are not too many events and send the request to Wikipedia.  The result is displayed in the console.  An interesting point is that <code>switchMap</code> will cancel the previous request if new data arrived.  This is very useful, to avoid non-spam effects from slow queries, if, for example, the penultimate query was executed for 2 seconds and the last 0.2 seconds, then the result of the last query will be displayed in the console. </p><br><pre> <code class="hljs coffeescript">ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.form.valueChanges .takeUntil(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ngUnsubscribe) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .map(form =&gt; form[<span class="hljs-string"><span class="hljs-string">'search-input'</span></span>]) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   .distinctUntilChanged() <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .debounceTime(<span class="hljs-number"><span class="hljs-number">300</span></span>) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    .switchMap(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wikipediaSearch) <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  Observable     .subscribe(data =&gt; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(data)); } wikipediaSearch = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(text: string)</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable .ajax(<span class="hljs-string"><span class="hljs-string">'https://api.github.com/search/repositories?q='</span></span> + text) .map(e =&gt; e.response); }</code> </pre> <br><h2 id="keshirovanie-zaprosa">  Query caching </h2><br><p>  <em>Task: You</em> need to cache Observable request </p><br><p>  <em>Solution:</em> Let's use a bunch of <code>publishReplay</code> and <code>refCount</code> .  The first function will cache one function value for 2 seconds, and the second will read the created subscriptions.  That is, the Observable will end when all subscriptions are completed.  <a href="http-responses">Here</a> you can read more. </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ tagService private tagsCache$ = this.getTags() .publishReplay(1, 2000) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     2  .refCount() /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   .take(1); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  1  getCachedTags() { return tagsCache$; }</span></span></code> </pre> <br><h2 id="posledovatelnyy-combinelatest">  Sequential combineLatest </h2><br><p>  <em>Task:</em> Critical situation on the server!  The backend team said that in order to correctly update the product, it is necessary to perform strictly consistently: </p><br><ol><li>  Update product data (title and description); </li><li>  Update the list of product tags; </li><li>  Update the list of product categories; </li></ol><br><p>  <em>Solution:</em> We have 3 Observables obtained from the <code>productService</code> .  Use <code>concatMap</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> updateProduct$ = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productService.update(product); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> updateTags$ = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productService.updateTags(productId, tagList); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> updateCategories$ = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.productService.updateCategories(productId, categoryList); Observable .from([updateProduct$, updateTags$, updateCategories$]) .concatMap(a =&gt; a) <span class="hljs-comment"><span class="hljs-comment">//    .toArray() //     .subscribe(res =&gt; console.log(res)); // res    </span></span></code> </pre> <br><h2 id="zagadka-na-pososhok">  Riding Riddle </h2><br><p>  If you have a desire to practice a little, solve the previous problem, but to create a product.  That is, first we create the product, then we update the tags, and only then - the categories. </p><br><h2 id="poleznye-ssylki">  useful links </h2><br><ul><li>  Enchanted look at the balls: <a href="https://rxviz.com/examples/basic-interval">rxviz.com</a> </li><li>  Drag the balls with the mouse: <a href="http://rxmarbles.com/">rxmarbles.com</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/337512/">https://habr.com/ru/post/337512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337498/index.html">How to meet consumer expectations regarding the Internet of Things? (survey results)</a></li>
<li><a href="../337500/index.html">As I wrote browser 3D football. Part 1</a></li>
<li><a href="../337502/index.html">PostgreSQL Indexes - 6</a></li>
<li><a href="../337504/index.html">Bank card instead of travel card</a></li>
<li><a href="../337508/index.html">Era IoT: how to enter?</a></li>
<li><a href="../337516/index.html">Artificial Intelligence for Retail: Skynet level salespeople, God level reviews</a></li>
<li><a href="../337518/index.html">How to set up mailing reports from Yandex. Metrics using R (from scratch)</a></li>
<li><a href="../337520/index.html">Security Week 36: a black hole in the Windows kernel, Adobe homograph attacks, the largest data leak in the US</a></li>
<li><a href="../337522/index.html">For a thousand rubles for the idea: we pay for proposals for the automation of QIWI wallets</a></li>
<li><a href="../337526/index.html">Microservice Architecture - Motive Shift to Target</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>