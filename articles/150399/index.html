<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collaborative filtering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In today's world, one often encounters the problem of recommending goods or services to users of an information system. In the old days, for the forma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Collaborative filtering</h1><div class="post__text post__text-html js-mediator-article">  In today's world, one often encounters the problem of recommending goods or services to users of an information system.  In the old days, for the formation of recommendations, a summary of the most popular products was treated: this can be observed even now by opening the same <a href="https://play.google.com/store/apps/collection/topselling_paid">Google Play</a> .  But over time, such recommendations began to be supplanted by targeted (targeted) offers: users are recommended not just popular products, but those products that will surely appeal to them.  Not so long ago, Netflix held a contest with a prize fund of $ 1 million, the task of which was to improve the algorithm for recommending films ( <a href="http://www.nytimes.com/2007/01/31/business/31leonhardt.html%3F_r%3D1">more</a> ).  How do these algorithms work? <br><br>  This article discusses the algorithm for collaborative filtering by user similarity, determined using a cosine measure, and its implementation in python. <br><img src="https://habrastorage.org/storage2/69a/197/0a1/69a1970a125a85ed9491f0e39fadfd46.jpg"><br><br><a name="habracut"></a><br><h5>  Input data </h5><br>  Suppose we have a matrix of user ratings for products, for simplicity, the products are assigned numbers 1-9: <br><img src="https://habrastorage.org/storage2/65a/17b/926/65a17b9260606bbceefab380d0221fae.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You can set it using a csv-file, in which the first column is the user name, the second is the product identifier, and the third is the user rating.  Thus, we need a csv file with the following contents: <br><pre><code class="python hljs">alex,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5.0</span></span> alex,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3.0</span></span> alex,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">4.0</span></span> ivan,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4.0</span></span> ivan,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1.0</span></span> ivan,<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">2.0</span></span> ivan,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">3.0</span></span> bob,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">5.0</span></span> bob,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">5.0</span></span> david,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4.0</span></span> david,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3.0</span></span> david,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">2.0</span></span> david,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre> <br>  To begin with, we will develop a function that will read the above csv file.  For the storage of recommendations, we will use the standard for python data structure dict: each user is assigned a reference book of his ratings of the type ‚Äúproduct‚Äù: ‚Äúrating‚Äù.  The result is the following code: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> csv <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadFile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(filename = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"&lt;csv_file_location&gt;"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> f = open (filename) r = csv.reader (f) mentions = dict() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> r: user = line[<span class="hljs-number"><span class="hljs-number">0</span></span>] product = line[<span class="hljs-number"><span class="hljs-number">1</span></span>] rate = float(line[<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> mentions: mentions[user] = dict() mentions[user][product] = rate f.close() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mentions</code> </pre><br><br><h5>  Measure of similarity </h5><br>  It is intuitively clear that in order to recommend the user # 1 of a product, you need to choose from products that some users like 2-3-4-etc., Who are most similar in their estimates to user # 1.  How to get the numerical expression of this "similarity" of users?  Suppose we have M products.  Estimates given by a single user represent a vector in the M-dimensional product space, and we can compare vectors.  Among the possible measures are the following: <br><ol><li>  Cosine measure </li><li>  Pearson Correlation Coefficient </li><li>  Euclidean distance </li><li>  Tanimoto coefficient </li><li>  Manhattan distance, etc. </li></ol><br>  I will discuss the various measures and aspects of their application in more detail in a separate article.  For now, suffice it to say that in recommender systems the cosine measure and the Tanimoto correlation coefficient are most often used.  Let us consider in more detail the cosine measure, which we are going to implement.  The cosine measure for two vectors is the cosine of the angle between them.  From the school mathematics course, we remember that the cosine of the angle between two vectors is their scalar product divided by the length of each of the two vectors: <br><img src="https://habrastorage.org/storage2/23a/dea/e1b/23adeae1b12f64f5786cd22ae1d23114.png"><br>  We implement the calculation of this measure, not forgetting that we have a lot of user ratings presented in the form of dict "product": "assessment" <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">distCosine</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vecA, vecB)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dotProduct</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vecA, vecB)</span></span></span><span class="hljs-function">:</span></span> d = <span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dim <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> vecA: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> dim <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> vecB: d += vecA[dim]*vecB[dim] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dotProduct (vecA,vecB) / math.sqrt(dotProduct(vecA,vecA)) / math.sqrt(dotProduct(vecB,vecB))</code> </pre><br>  The implementation used the fact that the scalar product of the vector itself gives itself the square of the length of the vector - this is not the best solution in terms of performance, but in our example, the speed of work is not critical. <br><br><h5>  Algorithm of collaborative filtering </h5><br>  So, we have a user preferences matrix and we can determine how two users resemble each other.  Now it remains to implement the algorithm of collaborative filtering, which consists of the following: <br><ol><li>  Select L users whose tastes are most similar to the tastes in question.  To do this, for each of the users, you need to calculate the selected measure (in our case, the cosine) with respect to the user in question, and select L the largest.  For Ivan, from the table above, we get the following values: <br><img src="https://habrastorage.org/storage2/1d7/af0/30a/1d7af030a5f1055130677f01cd366aa1.png"></li><li>  For each user, his scores will be multiplied by the calculated value of the measure, so the scores of more ‚Äúsimilar‚Äù users will have a stronger effect on the final position of the product, which can be seen in the table in the illustration below. </li><li>  For each of the products, calculate the sum of calibrated ratings of L closest users, divide the resulting amount into the sum of measures L of selected users.  The sum is shown in the illustration in the ‚Äúsum‚Äù line, the final value in the ‚Äúresult‚Äù line <br><img src="https://habrastorage.org/storage2/432/eb1/827/432eb1827eb9ed1fc4e143924d04c0bc.png"><br>  The columns of products that have already been evaluated by the user in question are marked in gray and it does not make sense to re-offer them to them. </li></ol><br>  As a formula, this algorithm can be represented as <br><img src="https://habrastorage.org/storage2/947/089/a15/947089a159aef40b0a9009b6f852f8b4.png"><br>  where sim is the chosen measure of similarity between two users, U is the set of users, r is the mark, k is the normalization factor: <br><img src="https://habrastorage.org/storage2/976/12f/185/97612f1857a05d90803ad05d8ed80306.png"><br><br>  Now you just have to write the corresponding code <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> math <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeRecommendation</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(userID, userRates, nBestUsers, nBestProducts)</span></span></span><span class="hljs-function">:</span></span> matches = [(u, distCosine(userRates[userID], userRates[u])) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> userRates <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> u &lt;&gt; userID] bestMatches = sorted(matches, key=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>(x,y):(y,x), reverse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)[:nBestUsers] <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Most correlated with '%s' users:"</span></span> % userID <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bestMatches: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">" UserID: %6s Coeff: %6.4f"</span></span> % (line[<span class="hljs-number"><span class="hljs-number">0</span></span>], line[<span class="hljs-number"><span class="hljs-number">1</span></span>]) sim = dict() sim_all = sum([x[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bestMatches]) bestMatches = dict([x <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bestMatches <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x[<span class="hljs-number"><span class="hljs-number">1</span></span>] &gt; <span class="hljs-number"><span class="hljs-number">0.0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> relatedUser <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bestMatches: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> product <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> userRates[relatedUser]: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> product <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> userRates[userID]: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> product <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sim: sim[product] = <span class="hljs-number"><span class="hljs-number">0.0</span></span> sim[product] += userRates[relatedUser][product] * bestMatches[relatedUser] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> product <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sim: sim[product] /= sim_all bestProducts = sorted(sim.iteritems(), key=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>(x,y):(y,x), reverse=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)[:nBestProducts] <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Most correlated products:"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> prodInfo <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bestProducts: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">" ProductID: %6s CorrelationCoeff: %6.4f"</span></span> % (prodInfo[<span class="hljs-number"><span class="hljs-number">0</span></span>], prodInfo[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [(x[<span class="hljs-number"><span class="hljs-number">0</span></span>], x[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bestProducts]</code> </pre><br><br>  To check its performance, you can run the following command: <br><pre> <code class="python hljs">rec = makeRecommendation (<span class="hljs-string"><span class="hljs-string">'ivan'</span></span>, ReadFile(), <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre><br>  That will lead to the following result: <br><img src="https://habrastorage.org/storage2/ba0/3e6/bab/ba03e6bab3fca62d342b0eb0e817da02.png"><br><br><h5>  Conclusion </h5><br>  We looked at an example and implemented one of the simplest options for collaborative filtering using a cosine measure of similarity.  It is important to understand that there are <a href="http://www10.org/cdrom/papers/519/node8.html">other approaches</a> to collaborative filtering, <a href="http://en.wikipedia.org/wiki/Collaborative_filtering">other formulas</a> for calculating product ratings, other measures of similarity ( <a href="http://www10.org/cdrom/papers/519/node8.html">article</a> , section "See also").  Further development of this idea can be carried out in the following directions: <br><ol><li>  <i>Optimization of the used data structures</i> .  When storing data in python in the form of dict, every time a call is made to a specific value, a hash calculation is performed and the situation gets worse the longer the line of names.  In practical tasks, <a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.csr_matrix.html">sparse matrices</a> can be used to store data, and instead of textual user names and product names, use numeric identifiers (number all users and all products) </li><li>  <i>Performance Optimization</i> .  Obviously, to calculate the recommendation for each user request is extremely expensive.  There are several ways to work around this problem: <br><ul><li>  Clustering users and calculating the similarity measure only between users belonging to the same cluster </li><li>  Calculation of product-product similarity coefficients.  To do this, you need to transpose the use-product matrix (you will get a product-user matrix), after which for each product you can calculate the set of the most similar products using the same cosine measure and remembering the <i>k</i> nearest ones.  This is quite a laborious process, so you can produce it once in <i>M</i> hours / days.  But now we have a list of products that are similar to this one, and multiplying the user's rating by the value of the measure of product similarity, we get the recommendation for <i>O (N * k)</i> , where <i>N</i> is the number of user ratings </li></ul></li><li>  <i>Selection of measures of similarity</i> .  The cosine measure is one of the frequently used, but the choice of measure should be made only according to the results of the analysis of the system data. </li><li>  <i>Modification of the filtering algorithm</i> .  Perhaps a different filtering algorithm will give more accurate recommendations in a particular system.  Again, the comparison of different algorithms can be made only when applied to a specific system. </li></ol><br><h5>  Literature </h5><br><ol><li>  <a href="http://www.ozon.ru/context/detail/id/4877842/">We program the collective mind</a> </li><li>  <a href="http://en.wikipedia.org/wiki/Collaborative_filtering">Collaborative wiki filtering</a> </li><li>  <a href="http://en.wikipedia.org/wiki/Cosine_similarity">Cosine measure</a> </li><li>  <a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.sparse.csr_matrix.html">Sparse matrices</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/150399/">https://habr.com/ru/post/150399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150393/index.html">Users and customers. What is the difference?</a></li>
<li><a href="../150394/index.html">Yandex joined the W3C</a></li>
<li><a href="../150395/index.html">Yandex closes Chat in Ya.Pochte and gives in return 10 gigs to the Disk</a></li>
<li><a href="../150396/index.html">SkyDrive for Android is available</a></li>
<li><a href="../150397/index.html">RAD Studio XE3 - changes to the EULA?</a></li>
<li><a href="../150401/index.html">Good place to work (translation by Ben Horowitz‚Äôs article)</a></li>
<li><a href="../150402/index.html">What will return the expression [[1,2], [3,4]] [[0,1] [1]] [0] is a javascript task</a></li>
<li><a href="../150403/index.html">30% of students chose an IT specialty in 2012</a></li>
<li><a href="../150405/index.html">Working moments</a></li>
<li><a href="../150406/index.html">One sentence that makes us stronger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>