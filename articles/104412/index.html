<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How To configure replication in MySQL using SSL encryption on Debian Lenny</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This guide describes how to set up database replication in MySQL using an SSL connection for encryption. 
 MySQL replication synchronizes the database...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How To configure replication in MySQL using SSL encryption on Debian Lenny</h1><div class="post__text post__text-html js-mediator-article">  This guide describes how to set up database replication in MySQL using an SSL connection for encryption. <br>  MySQL replication synchronizes the database, which allows you to have an exact copy of the database on another server.  All database updates on the main server are automatically replicated to another server, which allows you to protect the database from hardware failures.  This article will show how to implement exampledb DB replication from server1.example.com (ip address 192.168.0.100) to server2.example.com (ip address 192.168.0.101) using an SSL connection <br><a name="habracut"></a><br>  Both servers run on Debian Lenny, but the configuration can be used on almost all distributions without changes.  DB exampledb with tables and data already existing only on the main thing.  All commands are executed with root privileges. <br>  If the MySQL server is not installed on both servers, we proceed to the installation by running the following command on the main server and the secondary server: <br><pre><code class="bash hljs">aptitude install mysql-server mysql-client</code> </pre> <br>  You will be prompted to enter the root password for MySQL, both on the main and on the secondary server. <br>  Now let's check the SSL connection support with MySQL.  Let's go into MySQL and enter the command in the MySQL command line: <br><pre> <code class="bash hljs">mysql -u root -p mysql&gt; show variables like <span class="hljs-string"><span class="hljs-string">'%ssl%'</span></span>; +---------------+----------+ | Variable_name | Value | +---------------+----------+ | have_openssl | DISABLED | | have_ssl | DISABLED | | ssl_ca | | | ssl_capath | | | ssl_cert | | | ssl_cipher | | | ssl_key | | +---------------+----------+ 7 rows <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> (0.00 sec) mysql&gt;quit;</code> </pre><br>  If the output looks like this, it means that MySQL was compiled with SSL support, but as shown in the have_openssl DISABLED table and have_ssl DISABLED is not active. <br><br>  To enable SSL support, you need to edit the my.cnf file which is located in / etc / mysql / <br><pre> <code class="bash hljs">vi /etc/mysql/my.cnf</code> </pre><br>  Find the lines * Security Features and add the line ssl <br><pre> <code class="bash hljs">[...] <span class="hljs-comment"><span class="hljs-comment"># * Security Features # # Read the manual, too, if you want chroot! # chroot = /var/lib/mysql/ # # For generating SSL certificates I recommend the OpenSSL GUI "tinyca". ssl # ssl-ca=/etc/mysql/cacert.pem # ssl-cert=/etc/mysql/server-cert.pem # ssl-key=/etc/mysql/server-key.pem [...]</span></span></code> </pre><br>  Restart MySQL: <br><pre> <code class="bash hljs">/etc/init.d/mysql restart</code> </pre><br>  and check if ssl support is active <br><pre> <code class="bash hljs">mysql -u root -p show variables like <span class="hljs-string"><span class="hljs-string">'%ssl%'</span></span>; mysql&gt; show variables like <span class="hljs-string"><span class="hljs-string">'%ssl%'</span></span>; +---------------+-------+ | Variable_name | Value | +---------------+-------+ | have_openssl | YES | | have_ssl | YES | | ssl_ca | | | ssl_capath | | | ssl_cert | | | ssl_cipher | | | ssl_key | | +---------------+-------+ 7 rows <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> (0.00 sec) mysql&gt;quit;</code> </pre><br>  The output shows that ssl is enabled. <br>  Next, configure MySQL for listening on all interfaces by commenting the bind-address = 127.0.0.1 line in /etc/mysql/my.cnf: <br>  server1: <br><pre> <code class="bash hljs">vi /etc/mysql/my.cnf [...] <span class="hljs-comment"><span class="hljs-comment"># Instead of skip-networking the default is now to listen only on # localhost which is more compatible and is not less secure. #bind-address = 127.0.0.1 [...]</span></span></code> </pre><br>  MySQL restart: <br><pre> <code class="bash hljs">/etc/init.d/mysql restart</code> </pre><br>  Now let's see what hangs on our ports: <br><pre> <code class="bash hljs">netstat -tap | grep mysql server1:~<span class="hljs-comment"><span class="hljs-comment"># netstat -tap | grep mysql tcp 0 0 *:mysql *:* LISTEN 3771/mysqld server1:~#</span></span></code> </pre><br>  It seems that MySQL is broadcast on all interfaces. <br>  Now we need to create CA, servers and client certificates for SSL connections.  I usually create them in the / etc / mysql / newcerts directory <br>  Create a directory newcerts: <br><pre> <code class="bash hljs">mkdir /etc/mysql/newcerts &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/mysql/newcerts</code> </pre><br>  Make sure OpenSSL Unas is installed: <br><pre> <code class="bash hljs">aptitude install openssl</code> </pre><br>  Create CA certificate: <br><pre> <code class="bash hljs">openssl genrsa 2048 &gt; ca-key.pem openssl req -new -x509 -nodes -days 1000 -key ca-key.pem &gt; ca-cert.pem</code> </pre><br>  Next, create a certificate for the server ...: <br><pre> <code class="bash hljs">openssl req -newkey rsa:2048 -days 1000 -nodes -keyout server-key.pem &gt; server-req.pem openssl x509 -req -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> server-req.pem -days 1000 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 &gt; server-cert.pem</code> </pre><br>  and for the client: <br><pre> <code class="bash hljs">openssl req -newkey rsa:2048 -days 1000 -nodes -keyout client-key.pem &gt; client-req.pem openssl x509 -req -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> client-req.pem -days 1000 -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 &gt; client-cert.pem</code> </pre><br>  The output should look like this: <br><pre> <code class="bash hljs">ls -l server1:/etc/mysql/newcerts<span class="hljs-comment"><span class="hljs-comment"># ls -l total 32 -rw-r--r-- 1 root root 1346 2010-08-18 20:13 ca-cert.pem -rw-r--r-- 1 root root 1675 2010-08-18 20:13 ca-key.pem -rw-r--r-- 1 root root 1099 2010-08-18 20:14 client-cert.pem -rw-r--r-- 1 root root 1675 2010-08-18 20:14 client-key.pem -rw-r--r-- 1 root root 956 2010-08-18 20:14 client-req.pem -rw-r--r-- 1 root root 1099 2010-08-18 20:14 server-cert.pem -rw-r--r-- 1 root root 1679 2010-08-18 20:14 server-key.pem -rw-r--r-- 1 root root 956 2010-08-18 20:14 server-req.pem server1:/etc/mysql/newcerts#</span></span></code> </pre><br>  Now we have to transfer the ca-cert.pem, client-cert.pem and client-key.pem certificates to the second server.  Create a directory on the second server: <br>  server2: <br><pre> <code class="bash hljs">mkdir /etc/mysql/newcerts</code> </pre><br>  Let's go back to server1 and pass the certificates as follows: <br>  server1: <br><pre> <code class="bash hljs">scp /etc/mysql/newcerts/ca-cert.pem root@192.168.0.101:/etc/mysql/newcerts scp /etc/mysql/newcerts/client-cert.pem root@192.168.0.101:/etc/mysql/newcerts scp /etc/mysql/newcerts/client-key.pem root@192.168.0.101:/etc/mysql/newcerts</code> </pre><br>  Next, open /etc/mysql/my.cnf on server1 and make changes to the * Security Features area by uncommenting the ssl-ca, ssl-cert and ssl-key lines: <br><pre> <code class="bash hljs">vi /etc/mysql/my.cnf [...] <span class="hljs-comment"><span class="hljs-comment"># * Security Features # # Read the manual, too, if you want chroot! # chroot = /var/lib/mysql/ # # For generating SSL certificates I recommend the OpenSSL GUI "tinyca". ssl ssl-ca=/etc/mysql/newcerts/ca-cert.pem ssl-cert=/etc/mysql/newcerts/server-cert.pem ssl-key=/etc/mysql/newcerts/server-key.pem [...]</span></span></code> </pre><br>  Restart MySQL: <br><pre> <code class="bash hljs">/etc/init.d/mysql restart</code> </pre><br>  Now we will create the replication user slave_user, which will be used on server2, to access the database on server1 <br><pre> <code class="bash hljs">mysql -u root -p GRANT REPLICATION SLAVE ON *.* TO <span class="hljs-string"><span class="hljs-string">'slave_user'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> IDENTIFIED BY <span class="hljs-string"><span class="hljs-string">'slave_password'</span></span> REQUIRE SSL;</code> </pre><br>  Stream REQUIRE SSL is not mandatory, if you leave it, slave_user will be allowed to connect via an encrypted and unencrypted connection.  When using SSL, only an encrypted connection will be allowed. <br><br>  (If a replication user has already been created and you only need to specify an SSL connection, then you need to change the user as follows: <br><pre> <code class="bash hljs">GRANT USAGE ON *.* TO <span class="hljs-string"><span class="hljs-string">'slave_user'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> REQUIRE SSL;</code> </pre><br>  ) <br><pre> <code class="bash hljs">FLUSH PRIVILEGES; quit;</code> </pre><br>  In addition, we need MySQL to specify where to store our logs for replication, as well as to indicate which server is the main and which replication server: <br><pre> <code class="bash hljs">vi /etc/mysql/my.cnf [...] <span class="hljs-comment"><span class="hljs-comment"># The following can be used as easy to replay backup logs or for replication. # note: if you are setting up a replication slave, see README.Debian about # other settings you may need to change. server-id = 1 log_bin = /var/log/mysql/mysql-bin.log expire_logs_days = 10 max_binlog_size = 100M binlog_do_db = exampledb [...]</span></span></code> </pre><br>  Restart mysql <br><pre> <code class="bash hljs">/etc/init.d/mysql restart</code> </pre><br>  Next, we need to perform several operations: <br>  1. Block the exampledb database on server1 <br>  2. Learn master status server1 <br>  3. Create SQL dump exampledb (for import to server2) <br>  4. Unlock our database <br><pre> <code class="bash hljs">mysql -u root -p USE exampledb; FLUSH TABLES WITH READ LOCK; mysql&gt; SHOW MASTER STATUS; +------------------+----------+--------------+------------------+ | File | Position | Binlog_Do_DB | Binlog_Ignore_DB | +------------------+----------+--------------+------------------+ | mysql-bin.000001 | 98 | exampledb | | +------------------+----------+--------------+------------------+ 1 row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> (0.00 sec) mysql&gt;</code> </pre><br>  Now, without leaving the mysql console (because the DB lock will be deleted) we will make a backup and transfer it to server2 <br>  server1: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp mysqldump -u root -pyourrootsqlpassword --opt exampledb &gt; snapshot.sql scp snapshot.sql root@192.168.0.101:/tmp</code> </pre><br>  After the operation you can safely unlock our database. <br>  server1: <br><pre> <code class="bash hljs">UNLOCK TABLES; quit;</code> </pre><br>  This completes the server1 setup.  Proceed to setting up server2 by opening the configuration of muscle: <br>  server2: <br><pre> <code class="bash hljs">vi /etc/mysql/my.cnf</code> </pre><br>  make sure that we have the following line settings (if not, add them): <br><pre> <code class="bash hljs">[...] server-id=2 master-connect-retry=60 replicate-do-db=exampledb [...]</code> </pre><br>  The value server-id = 2 is unique and it should be different from the value that on server1 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Restart MySQL: <br><pre> <code class="bash hljs">/etc/init.d/mysql restart</code> </pre><br>  Before you start setting up replication, create an empty database: <br><pre> <code class="bash hljs">mysql -u root -p CREATE DATABASE exampledb; quit;</code> </pre><br>  Now you can import the snapshot.sql database dump to server2 <br><pre> <code class="bash hljs">/usr/bin/mysqladmin --user=root --password=yourrootsqlpassword stop-slave <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp mysql -u root -pyourrootsqlpassword exampledb &lt; snapshot.sql</code> </pre><br>  Go to MySQL and execute the command, so that server2 is a secondary server, and server1 is defined as the primary server: <br><pre> <code class="bash hljs">mysql -u root -p CHANGE MASTER TO MASTER_HOST=<span class="hljs-string"><span class="hljs-string">'192.168.0.100'</span></span>, MASTER_USER=<span class="hljs-string"><span class="hljs-string">'slave_user'</span></span>, MASTER_PASSWORD=<span class="hljs-string"><span class="hljs-string">'slave_password'</span></span>, MASTER_LOG_FILE=<span class="hljs-string"><span class="hljs-string">'mysql-bin.000001'</span></span>, MASTER_LOG_POS=98, MASTER_SSL=1, MASTER_SSL_CA = <span class="hljs-string"><span class="hljs-string">'/etc/mysql/newcerts/ca-cert.pem'</span></span>, MASTER_SSL_CERT = <span class="hljs-string"><span class="hljs-string">'/etc/mysql/newcerts/client-cert.pem'</span></span>, MASTER_SSL_KEY = <span class="hljs-string"><span class="hljs-string">'/etc/mysql/newcerts/client-key.pem'</span></span>;</code> </pre><br>  * MASTER_HOST - ip address or host name in our case is ip <br>  * MASTER_USER - user replication for the primary server <br>  * MASTER_PASSWORD - User Password <br>  * MASTER_LOG_FILE - Value of the Log file on server1 which we learned will execute the SHOW MASTER STATUS command; <br>  * MASTER_LOG_POS - The value obtained when executing the SHOW MASTER STATUS command; <br>  * MASTER_SSL - Creates a connection to the main and secondary server using SSL <br>  * MASTER_SSL_CA - Path to CA certificate (server2) <br>  * MASTER_SSL_CERT - Path to the client-cert.pem certificate (server2) <br>  * MASTER_SSL_KEY - Path to the client-key.pem certificate (server2) <br><br>  And finally <br><pre> <code class="bash hljs">START SLAVE;</code> </pre><br>  Now check the status of server2 <br><pre> <code class="bash hljs">SHOW SLAVE STATUS \G mysql&gt; SHOW SLAVE STATUS \G *************************** 1. row *************************** Slave_IO_State: Waiting <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> master to send event Master_Host: 192.168.0.100 Master_User: slave_user Master_Port: 3306 Connect_Retry: 60 Master_Log_File: mysql-bin.000001 Read_Master_Log_Pos: 98 Relay_Log_File: mysqld-relay-bin.000002 Relay_Log_Pos: 235 Relay_Master_Log_File: mysql-bin.000001 Slave_IO_Running: Yes Slave_SQL_Running: Yes Replicate_Do_DB: exampledb Replicate_Ignore_DB: Replicate_Do_Table: Replicate_Ignore_Table: Replicate_Wild_Do_Table: Replicate_Wild_Ignore_Table: Last_Errno: 0 Last_Error: Skip_Counter: 0 Exec_Master_Log_Pos: 98 Relay_Log_Space: 235 Until_Condition: None Until_Log_File: Until_Log_Pos: 0 Master_SSL_Allowed: Yes Master_SSL_CA_File: /etc/mysql/newcerts/ca-cert.pem Master_SSL_CA_Path: Master_SSL_Cert: /etc/mysql/newcerts/client-cert.pem Master_SSL_Cipher: Master_SSL_Key: /etc/mysql/newcerts/client-key.pem Seconds_Behind_Master: 0 1 row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> (0.00 sec) mysql&gt;</code> </pre><br>  After that, you can exit MySQL: <br><pre> <code class="bash hljs">quit;</code> </pre><br>  That's it, server setup is over.  If you have done everything correctly then replication is configured correctly and workable. <br><br>  Thank you very much for your attention! <br>  PS If you found ochepyatku or not properly formulated sentence please inform the PM. </div><p>Source: <a href="https://habr.com/ru/post/104412/">https://habr.com/ru/post/104412/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104401/index.html">From October 1, 2010, Nokia terminates the Ovi Files service.</a></li>
<li><a href="../104402/index.html">‚ô• UNIX ‚ô•</a></li>
<li><a href="../104404/index.html">Windows Phone 7 Release Day</a></li>
<li><a href="../104407/index.html">The pipes can not only blow</a></li>
<li><a href="../104409/index.html">EeePC 1215 - the scandalous flagship</a></li>
<li><a href="../104413/index.html">IDF: Russian netbooks and new atoms</a></li>
<li><a href="../104414/index.html">New HTC Sense for Windows Phone 7</a></li>
<li><a href="../104417/index.html">Do not forget about language and cultural features</a></li>
<li><a href="../104418/index.html">Dell Inspiron Duo - a hybrid of netbook and tablet</a></li>
<li><a href="../104420/index.html">We save video from Flash Player 10.2 or unlink</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>