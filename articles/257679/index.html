<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of CPL malware, part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CPL malware is a special type of malware that is distributed as dynamic DLL libraries that act as extensions of Windows Control Panel elements. This t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of CPL malware, part 1</h1><div class="post__text post__text-html js-mediator-article">  CPL malware is a special type of malware that is distributed as dynamic DLL libraries that act as extensions of Windows Control Panel elements.  This type of malware is especially popular with attackers in Brazil and is used to distribute the <b>Win32 / TrojanDownloader.Banload daunloader</b> and the <b>Win32 / Spy.Banker.T banker</b> . <br><br><img src="https://habrastorage.org/files/c4c/83c/af9/c4c83caf9fcc439d8a837a4b22adc5db.jpg"><br><br>  Each CPL file is a dynamically linked library.  The DLL itself, in its model, stores the executable code and data that can be used by other executable PE files through the DLL export mechanism.  However, the library cannot be executed directly by the user, since it can only be used through the executable file and the process created for it. <br><a name="habracut"></a><br>  Dynamic CPL libraries can be executed through a call to the executable file control.exe, which is the Windows Control Panel.  To do this, the DLL must meet special requirements, one of which is the presence of an export function named <i>CPlApplet</i> .  Below is its prototype on Delphi. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/c32/c39/af3/c32c39af30694b0f817029fa4cbcadd0.png"><br>  Fig.  The prototype of the <i>CPlApplet</i> function on Delphi. <br><br>  It can be seen that the function accepts four arguments as input: <i>hwndCPl</i> , which is the handle of the main application window;  <i>uMsg</i> is a message identifier that sends the DLL an executable file of the control panel;  <i>lParam1</i> and <i>lParam2</i> are arguments that are specific to a particular message.  Messages sent by the executable file of the control panel are the main mechanism for working with the CPL library. <br><br><img src="https://habrastorage.org/files/1f5/2e5/fd9/1f52e5fd98d74794bea7d57a33d229cb.png"><br>  Fig.  The basic structure of the function <i>CPlApplet</i> . <br><br>  Dynamic libraries of simple applets of the control panel are located in the% WINDIR% \ System32 directory.  Attackers use a different location to store their malicious CPL files, which will also be executed using the Windows Control Panel (control.exe).  Usually authors place malicious code in that section of the <i>CPlApplet</i> function, which is responsible for processing the <i>CPL_DBLCLK</i> message. <br><br>  To distribute this type of malware, attackers use phishing emails.  The user may be offered to read a fake document, opening which he is infected with malware.  The following e-mail topics are used by attackers to euthanize user vigilance: <br><br><ul><li>  a document with an invoice or receipt for payment of something; </li><li>  a document with information about the status of a bank account or other banking information; </li><li>  a document with information on electronic methods of paying bills that are popular in Brazil; </li><li>  A document with various images and photographs that are relevant to the user. </li></ul><br><br>  The figure below shows a typical attack pattern for users using CPL malware in Brazil.  The chain of compromise of a user begins with the attackers spreading malicious files through e-mail messages.  Such a message may include an attachment, or contain in the text a hyperlink to a file located on a remote server.  As a rule, the malicious DLL itself is packaged in a ZIP archive (email attachment). <br><br><img src="https://habrastorage.org/files/76d/2f4/e0c/76d2f4e0c3074f9395163e52848c3c6e.png"><br>  Fig.  Attack life cycle using CPL malware. <br><br>  Above, we mentioned the typical structure of the main function of <i>CPlApplet</i> , the screenshot below shows the similar function of the malware in the disassembler.  It is important to mention that the majority of samples of such malware analyzed by us are written in Delphi, with the exception of only a small number of samples with their own packers, which are written in Microsoft Visual C. <br><br><img src="https://habrastorage.org/files/28d/7ba/ae4/28d7baae4a79456f8e2a2bf96a388c9f.png"><br>  Fig.  The <i>CPlApplet</i> function of one of the malware samples. <br><br>  This function has a similar structure with the general form indicated above.  It can be seen that it contains a large number of conditions that indicate the processing of various types of messages.  The screenshot shows the various code fragments responsible for processing the four messages. <br><br>  We mentioned that <i>CPlApplet</i> is called in various situations and is the main function that implements the logic of the CPL library in memory.  The scheme of execution of these functions and their connection with the Windows system libraries is shown below. <br><br><img src="https://habrastorage.org/files/443/940/2f2/4439402f2585475a9c27387e7c5337a9.png"><br>  Fig.  Call flow of <i>CPlApplet</i> functions. <br><br>  The figure shows that the first function of the CPL library to be called is <i>DllMain</i> .  This is the entry point to the library, which performs the initial initialization of its data and structures.  The <i>DllMain</i> function <i>is</i> called by the <i>LoadLibrary</i> API in the shell32.dll library after the library is loaded into memory.  It would be logical to assume that all the logic of the malicious program can be immediately placed in this function, since it runs before the <i>CPlApplet is called</i> .  This question we will consider below. <br><br>  After the DLL is initialized, i.e., executing its <i>DllMain</i> function, the <i>CPlApplet</i> function is sequentially called with various messages.  The order of the function call with the corresponding messages is indicated by numbers from 1 to 7. The CPL_DBLCLK message is the main one, since the main code of the malicious program is located there.  In the case of this sample, there is a payload (payload), to which control is transferred when processing this type of message. <br><br>  The payload code of the CPL malware samples we observed has a specific structure and can be broken down into the following parts: <br><ul><li>  initialization; </li><li>  building URLs to download malicious content; </li><li>  execution of downloaded files. </li></ul><br><br><img src="https://habrastorage.org/files/27d/ed5/003/27ded5003d494e96a1bfa5d9c08bca2e.png"><br>  Fig.  A fragment of malicious code payload. <br><br>  As can be seen in the call graph of the functions of the payload, its execution is quite linear, the figure shows a fragment of the initialization function.  At the very beginning of this function, the stack is initialized with zero values ‚Äã‚Äãin the loop, then the function execution flow falls asleep for 30 seconds, after which it saves the path to the% APPDATA% directory in the memory buffer.  Note that the patterns we observed in the initialization function performed other actions, for example, did not call the <i>Sleep</i> function, received a path to other system directories.  However, the above scheme is quite common for many samples.  Below is a snippet of code in which URLs are constructed and files are loaded. <br><br><img src="https://habrastorage.org/files/924/1fb/267/9241fb26747046369c47747f0a5e3dbc.png"><br>  Fig.  Malware code snippet that is responsible for downloading files from a remote C &amp; C server. <br><br>  The screenshot above shows that for each encrypted string, the decipher_str decryption function is called.  Then, based on these lines, the final URL is generated, from which the executable file will be downloaded.  It can be seen that the download file is masked as an image file with the extension .png.  It will be saved to the location% APPDATA% \ Desk.exe.  The <i>download_URL</i> function directly downloads a file using standard Windows call APIs. <br><br>  Note that not all CPL malware samples detected by us use encrypted strings.  We often come across samples in which the lines are in clear text.  In such samples, the decipher_str decryption function, which we mentioned above, is missing. <br><br><img src="https://habrastorage.org/files/81e/233/f75/81e233f7544643a88d95985d43df44cf.png"><br>  Fig.  An example of a malicious CPL malware file with plaintext strings. <br><br>  The last piece of payload code is responsible for executing files downloaded from a remote server using the standard <i>ShellExecute</i> API function.  Our analysis showed that the actions performed by CPL malware are simple and effective enough to compromise the user's system.  The malicious program is not installed into the system, but only specializes in downloading and installing other malicious programs into the system, that is, it acts as a downloader or downloader.  Thus, the bootloader itself in the system is difficult to detect because it leaves no traces there, for example, registry keys or other indicators. <br><br><img src="https://habrastorage.org/files/ae2/50c/889/ae250c889e444446bee78a8464e7d94d.png"><br>  Fig.  The code snippet that is responsible for the execution of the downloaded file. <br><br>  Many of the malware files that we analyzed are variants of the <b>Win32 / TrojanDownloader.Banload</b> malware family and specialize in installing banking trojans into the system. <br><br>  Most samples of CPL malware use string decryption mechanisms based on SUB and XOR operations.  The decryption key is hardwired in the code of the function itself, which is responsible for decoding.  The malicious program uses the so-called.  ‚ÄúExtended Backus ‚Äì Naur Form (EBNF) for storing encrypted strings and a key. <br><br><img src="https://habrastorage.org/files/af0/1c1/9dd/af01c19ddf2e4de480e94b5ae26830ea.png"><br><br>  In the form of a regular expression, it looks like this: <br><br><img src="https://habrastorage.org/files/ef3/011/e0e/ef3011e0e5774fc49b3b66adeb47722f.png"><br><br>  It can be seen that the encrypted strings (cipher_string) consist of at least two pairs of hexadecimal characters (in upper case), and the number of characters will always be even.  The key consists of at least one alphanumeric character, also in upper case.  We also observed in the keys such characters as "@" and "!", Which we did not include in the regular expression above for simplicity. <br><br>  The following figure shows an example of the decryption algorithm.  At the first stage, the characters of the encrypted string will be encrypted twice, since each pair is considered as a hexadecimal byte value.  The same can be said about the key, the sequence of ASCII characters is treated as a hexadecimal byte stream. <br><br><img src="https://habrastorage.org/files/35b/9ec/08e/35b9ec08e42441a993dbee10de28373b.png"><br>  Fig.  The first stage of the decryption algorithm. <br><br><img src="https://habrastorage.org/files/957/375/da9/957375da986a40ecbdb2b712b3e3d0e0.png"><br>  Fig.  The second stage of the decryption algorithm. <br><br>  At the first stage of the algorithm, it is clear that in the decryption operation the first pair of characters of the encrypted string is skipped; it will be used in the second stage as a subtracted value from the result obtained at the first stage of the algorithm.  Already at this stage, the result of the subtraction is considered as an ASCII character.  In our example, the ASCII code represents the letter ‚Äúh‚Äù.  Note that in the case when the result of the subtraction operation gives a negative number, the value 0xFF is added to the most subtractive before the subtraction operation occurs.  The figure below shows how the decryption operation takes place for the first seven characters of the encrypted string. <br><br><img src="https://habrastorage.org/files/bed/766/8b0/bed7668b04364de39e362617907a1226.png"><br>  Fig.  Decrypt the first seven characters of the encrypted string of the CPL malware. <br><br>  The screenshot below shows the main part of the decryption function in IDA Pro.  The function reads the first two characters of the encrypted string from memory, stores them and starts the decryption process.  In the loop, the function takes the next two characters of the string and a pair of key characters, performing an XOR operation.  Then, the subtraction (SUB) operation is performed on the obtained value (the first stage), and the value of the first pair of characters that were stored in the memory at the very beginning of the function is subtracted from it.  The resulting value is copied to a memory buffer storing the decrypted text.  At the last step, the pair of symbols used in the XOR operation is copied, that is, they become a subtraction value for the SUB operation at the next iteration.  In the case when the decryption characters still remain, and all the key characters have already been used up, the key characters are taken from the very beginning. <br><br><img src="https://habrastorage.org/files/77e/bab/443/77ebab443d6c4c248a5334022a05a308.png"><br>  Fig.  Line decryption function. </div><p>Source: <a href="https://habr.com/ru/post/257679/">https://habr.com/ru/post/257679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257669/index.html">Redesign and promotion. Chicken and Egg Challenge</a></li>
<li><a href="../257671/index.html">Deploy web application with Fabric</a></li>
<li><a href="../257673/index.html">How 3CX solves security problems (part 2)</a></li>
<li><a href="../257675/index.html">Laboratory penetration testing "Test lab v.7" eyes hackers</a></li>
<li><a href="../257677/index.html">Low Blood Application Architecture</a></li>
<li><a href="../257681/index.html">Trojan-Downloader.Win32.Cabby.cemx - Part Two - Functional</a></li>
<li><a href="../257683/index.html">Likbez - how to become a programmer</a></li>
<li><a href="../257685/index.html">Product design digest, April 2015</a></li>
<li><a href="../257687/index.html">Write on Rust - run everywhere. Rust and C interaction</a></li>
<li><a href="../257689/index.html">Practical experience with little-known European cloud hosting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>