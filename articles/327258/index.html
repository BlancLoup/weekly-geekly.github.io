<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why do we need chat bots, or the story of Bitrix24</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We are often asked what the Microsoft Bot Framework can be used for, except to create bots and chat with them, and whether there are real cases of usi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why do we need chat bots, or the story of Bitrix24</h1><div class="post__text post__text-html js-mediator-article">  We are often asked what the Microsoft Bot Framework can be used for, except to create bots and chat with them, and whether there are real cases of using chat bots in projects in nature.  So, there are.  We asked one of our partners, Bitrix24, to share our experience and technical details on how to integrate bots into the project.  I give the floor to Sergey Pokoev, a system developer who tells about its architecture and the use of the Bot Framework to connect to Skype. <br><br><img src="https://habrastorage.org/files/c53/04a/33b/c5304a33b5d040e6b029f4ac9b7e89e0.jpg"><br><a name="habracut"></a><br><h2>  Prehistory </h2><br>  The company's communication with customers has long been transformed: to replace emails and phone calls, social networks came first, and then instant messengers.  Agree, it is now much more convenient, and, most importantly, to quickly ask a support question on Facebook, VKontakte, the What's App or Telegram. <br><br>  The abundance of channels not only gives ample opportunities, but also creates some problems: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Sales data is difficult to account for and analyze. </li><li>  Personnel errors lead to customer dissatisfaction. </li></ul><br>  Therefore, many companies are thinking about data aggregation in one place, which is easily controlled and controlled.  For them in the service "Bitriks24" * just there is a tool <a href="https://www.bitrix24.ru/features/olines.php">"Open lines"</a> , which we will discuss below. <br><br>  By the way, we‚Äôll immediately answer the question that worries many people: <b>‚ÄúWhy do we need chat bots?‚Äù</b> In our case, their use depends on the tasks that need to be solved: starting from simple - chat bots that can send a request to one of the company's departments, complex - to automate customer support. <br><br>  <b>* Reference:</b> <a href="https://www.bitrix24.ru/">Bitrix24 service</a> is a set of online tools for organizing a company's work.  It includes task and project management, omni-channel CRM, the company's internal messenger, a working social network, work time management, document management and other functionality. <br><br><h2>  How it works: user view </h2><br>  The client writes to the company's official account in social networks or in instant messengers.  This message is sent to the processing queue common to all channels.  From it, messages are distributed among employees who respond to them inside the Bitrix24 messenger.  As you could understand, this is an automated process and for the respondent there is no difference in which of the channels the client wrote. <br><br><img src="https://habrastorage.org/files/8cf/c24/fa7/8cfc24fa7c654a1b9a42f566e97029c0.png"><br><br><h2>  How it works: a developer‚Äôs view </h2><br><h4>  Integration with Microsoft Bot Framework </h4><br>  <a href="https://dev.botframework.com/">The Microsoft Bot Framework</a> is an environment that allows you to create an intelligent chat bot in the cloud, with which you can then communicate via various communication channels: from Skype and Telegram to Slack and SMS.  It can also be used as a proxy.  This is convenient, since it is not necessary to implement integration separately for each of these channels. <br><br>  For integration with the Microsoft Bot Framework, the existing Open Lines operating scheme was used with some modifications. <br><br>  We have created a special server connectors.  It is a link between external communication channels - social networks, instant messengers, online chats, forms on the website, and so on - and client Bitrix24.  The main advantages of the server: <br><br><ul><li>  provides guaranteed delivery of messages from social networks and instant messengers to Bitrix24; </li><li>  works with both cloud Bitrix24 and boxed; </li><li>  allows you to quickly connect the official account of the company in the social network or messenger to "Bitrix24". </li></ul><br><br><img src="https://habrastorage.org/files/5ff/f10/f82/5fff10f8296e43cea953749a490d8a30.png"><br><br>  Data exchange between the client Bitrix24 and the connector server is performed using its own protocol.  At the same time, the server acts as a router, with preprocessing of incoming and outgoing data. <br><br>  It has slightly different server environment requirements than Bitrix24: PHP starting from 5.4, MySql 5.5.3, InnoDB. <br><br>  To minimize the overhead of data exchange between client Bitrix24 and the server of connectors, it was decided: <br><br><ul><li>  Do not transfer files attached to messages from external channels and from the server.  The server sends only links to files from external sources to Bitrix24.  And the client‚Äôs Bitrix24 downloads them independently; </li><li>  when sending files from Bitrix24, transfer only download links to them.  The files themselves are stored on "Bitrix24.Disk"; </li><li>  for frequently used actions (receiving, sending a message, sending delivery statuses, reading a message and the like), after sending the message, do not expect a response and close the connection. </li></ul><br><h4>  Connector Server Message Queuing </h4><br>  The message queue on the server is based on MySQL.  At the moment there is no need for more complex, but flexible tools like Redis.  A database-based queue avoids additional overhead, is easier to maintain and easily withstands current workloads. <br><br>  The queue guarantees delivery of messages, even if the portal has been unavailable for some time.  The incoming message is processed and placed in the database.  A separate process continuously selects messages in the database for sending.  At the same time, he forms packets of several messages and sends them to the portals. <br><br>  If delivery confirmation does not arrive at the server, then the next sending to this portal in this ‚ÄúOpen Line‚Äù will occur only after the end of the blocking period.  After each attempt, the duration of the blocking increases.  If the last attempt fails, the sending of messages will be blocked for 12 hours.  In total, it turns out 24 hours since the first attempt to send messages to the portal.  After the last attempt, all messages for this portal of the ‚ÄúOpen line‚Äù are deleted, and the blocking is removed. <br><br>  If the server receives a confirmation, the delivered messages are removed from the queue, and the blocking of this ‚ÄúOpen Line‚Äù is removed.  That is, new messages will be immediately sent to the portal. <br><br><h4>  The mechanism of the connector server </h4><br>  We applied the ‚Äúfactory method‚Äù pattern to organize the code responsible for each communication channel.  Defined a standard set of methods that each connector should support.  In addition, each channel can have its own unique methods. <br><br>  For the channel to work, you must perform the initial setup on the portal.  It is done by users, and the portal manages the connection using special methods.  Settings for different types of connectors differ significantly in their method sets.  For the Microsoft Bot Framework, a simple configuration option is used.  From the portal, the remote <code>saveSettings</code> method is <code>saveSettings</code> , in which the necessary parameters are passed.  They are stored in the database and are used in the work of the channel in the future. <br><br>  The portal then calls the remote <code>testConnect</code> connector <code>testConnect</code> , which checks the connectivity with the specified data, and also checks the availability of the connected portal. <br><br>  Webhook is specified when creating a bot on the Bot Framework website.  We give the required address when setting up the user. <br><br>  The configuration interface on the portal side looks like this. <br><br><img src="https://habrastorage.org/files/f92/2bd/ddf/f922bdddf3314a8fbfb82129ab2e61bc.png"><br><br>  Beginners can use the step-by-step wizard, which will help you quickly register a new bot. <br><br>  After successful connection, we get records in three data structures. <br><br><img src="https://habrastorage.org/files/f05/4ee/450/f054ee450316413db59b7505914c6450.png"><br><br>  <b>Record with information about the site</b> .  An important parameter is the portal domain.  The server will access it in certain cases. <br><br>  <b>Record of the open line / connector</b> .  It uniquely identifies: <br><br><ul><li>  connector type; </li><li>  id of the open line on the client; </li><li>  link to the site; </li><li>  special hash to determine which ‚Äúopen line‚Äù the request refers to when accessing via WebHook; </li><li>  Information for a message queue: the number of attempts to send messages to the client and the blocking time for sending </li></ul><br>  <b>Records of connection parameters of a specific connector of a specific "Open line"</b> .  For different types of connectors, the set of parameters can vary greatly. <br><br><h4>  Work on the server directly with the Microsoft Bot Framework </h4><br>  Bot Framework contains a whole set of channels.  Therefore, we have introduced the concept of "real channel" and "virtual channel."  <code>Botframework</code> is a real channel, since it uses one point of contact.  <code>Botframework.skype</code> is a virtual channel that implements work with the Skype bot through the Microsoft Bot Framework. <br><br>  To work the connector you need: <br><br>  1. In the settings of the bot, specify the desired WebHook. <br>  2. In the channel settings in Bitrix24, specify the correct ones: <br><br><ul><li>  bot handle; </li><li>  Application ID; </li><li>  application secret. </li></ul><br>  Thanks to WebHook, the connector server determines which ‚Äúopen line‚Äù this bot is associated with.  If the binding could not be found, an error is returned. <br><br>  If there is no error, then we process the received data: <br><br><ul><li>  we form an array of data in the format of exchange between the client and the server; </li><li>  Parsim the text and transform all the entities into the format understandable to the Bitrix24 messenger.  For different channels, these transformations are different; </li><li>  convert all incoming emoticons in the universal format Emoji.  We tried to cover a maximum of smiles supported by all channels. </li></ul><br><br><img src="https://habrastorage.org/files/bad/da3/b60/badda3b605114b3e8b654eb54d16e215.jpg"><br><br>  After all conversions, the message is added to the message queue. <br><br>  When sending messages from ‚ÄúBitrix24‚Äù to an external messenger, a reverse conversion from one format to another is performed.  The message is sent using the POST method <code>/v3/conversations/{conversationId}/activities</code> .  All the data you need to send come along with the message. <br><br>  In this case, binary data is not transmitted.  All attached files are put into ‚ÄúBitrix24.Disk‚Äù and sent as links.  This saves traffic.  And if necessary, you can close access to the file at any time. <br><br><h4>  The principle of "Open lines" </h4><br>  Chat begins with a message from a social network user or messenger.  A single entry point is used.  This is a single URL, characterized by the GET parameter, which contains the Open Line Hash.  By hash, the system determines where to send the incoming message. <br><br><h4>  Connection uniqueness </h4><br>  There are situations when the same essence of an external system (group, bot) is attempted to be connected to several portals or to different ‚ÄúOpen Lines‚Äù within one portal.  If such cases are not handled, then abnormal situations and failures may occur.  Therefore, we implemented a uniqueness check mechanism. <br><br>  Attempts to reconnect for different channels are defined differently.  The Microsoft Bot Framework checks for the presence of a specific bot ID in the system.  If the current connection is not the only (repeated), then it continues to work in normal mode, and the data of the previous connection is completely removed from the server.  At the same time, a request is sent to the portal that marks this ‚Äúopen line‚Äù connector as ‚Äúemergency‚Äù, requiring the attention of the administrator. <br><br><h4>  The mechanism of the client part of "Bitrix24" </h4><br>  The client connector module is used for: <br><br><ul><li>  communication channel connection settings; </li><li>  receiving messages, processing and converting to the Bitrix24 messenger format.  With the subsequent generation of the event; </li><li>  processing users: registering or updating user data Bitrix24, which is associated with an external user; </li><li>  download files coming with messages. </li></ul><br>  The Open Lines module is responsible for routing messages, creating a message queue, referring to operators and other functions. <br><br><h4>  Implementation of data exchange on the client </h4><br>  In the "Open Lines" module, the <code>Output</code> class is responsible for sending messages to the server and additional processing.  The <code>query</code> method directly generates outgoing packets to a remote server and signs messages. <br><br>  In the <code>Output</code> class, ‚Äúmagic‚Äù methods are used, allowing you to call the methods of the remote server as if they were local.  This has advantages and disadvantages. <br><br>  <b>Disadvantages</b> : the speed of the "magic" methods is somewhat lower.  But they are used to work with external systems, so the delay is not so noticeable. <br><br>  <b>Advantages</b> : you can work with external methods as with internal ones.  That is, the developer locally calls remote methods.  All work is standardized.  You do not need to keep a list of methods on the client, you do not need to synchronize this list.  It is enough to add a method to the server, and you can use it on the client. <br><br>  Some external server methods have local wrappers.  They perform various tasks before sending a request to a remote server.  For example, they cache data (to reduce the load on a remote server), do preprocessing, and so on. <br><br>  All incoming requests are handled by the <code>Input</code> class.  It parses the incoming packet, verifies the signature (that the request actually came from the server), and redirects the data to the <code>Router</code> class, which routes incoming requests. <br><br>  Types of incoming requests: <br><br><ul><li>  <b>Connection testing</b>  This method is called by the remote server when it checks the availability of the client. </li><li>  <b>Incoming messages (all types)</b> .  More details below. </li><li>  <b>Delivery status</b>  Together with the delivery status comes the external message ID, which then allows you to manage the external data.  For example, we cannot delete a message on a remote server without knowing its external ID. </li><li>  <b>Read status</b> . </li><li>  <b>Deactivating the connector</b> .  Called when this connector is connected to another portal or Open Line. </li></ul><br><h4>  Receiving messages by the Bitrix24 client </h4><br>  The <code>input</code> class accepts an incoming message (message array) from the portal and begins processing.  A message delivery notification is sent to the server.  It removes them from the queue and removes the blocking of further sending messages. <br><br><img src="https://habrastorage.org/files/4a2/c53/5af/4a2c535affd84f0d887b60cfaaaf61b7.png"><br><br>  Received messages are additionally processed.  Shortname Emoji is converted to a special <code>icon</code> tag, supported by the Bitrix24 messenger.  This is how all available Emoji are supported. <br><br>  All attached files are processed.  They are downloaded and registered in the internal system.  And in the array describing the files, the links to them are replaced with internal IDs. <br><br>  The presence of the internal user created under the external user of the social network or messenger is checked on the portal.  If not, it is created.  If there is a user, then the md5 hash of the user data is checked.  It is compared with the received data, and if the hashes are different, the user data is updated.  Then they are replaced in the incoming array with the user ID inside the Bitrix24 portal. <br><br>  Such a converted data array is placed in the <code>OnReceivedMessage</code> event that is <code>OnReceivedMessage</code> .  His "catches" the module "Open lines". <br><br><h4>  Outgoing requests "Bitrix24" </h4><br>  Outgoing requests are practically not processed.  They are routed to a remote connector server.  For the Bot Framework, an additional handler is made on the client. <br><br>  This connector is different from all the others in that in outgoing messages you need to send information about the sender.  It is not transmitted to us when you connect.  But we can get it in the incoming data.  Therefore, a separate table has been created to store supporting information about each chat and each dialogue. <br><br>  For incoming messages, this method calls the <code>furtherMessageProcessing</code> method, which selects and saves the necessary information.  And when sending a message to the Botframework channel, the sendMessageProcessing method mixes the necessary data. <br><br><h2>  Instead of conclusions </h2><br>  Currently, the majority of Bitrix24 users connect the Bot Framework channel to work with their audience via Skype.  At the time of publication of the article the number of connected bots is 9 thousand. </div><p>Source: <a href="https://habr.com/ru/post/327258/">https://habr.com/ru/post/327258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327248/index.html">Bash scripts, part 6: functions and library development</a></li>
<li><a href="../327250/index.html">Open machine learning course. Theme 10. Gradient boosting</a></li>
<li><a href="../327252/index.html">Go meetup report April 14</a></li>
<li><a href="../327254/index.html">A prototype of a simple service for healthy eating.</a></li>
<li><a href="../327256/index.html">How DDos-attacks are ‚Äúordered‚Äù: life story</a></li>
<li><a href="../327260/index.html">How Google Cloud protects its data centers from cybercriminals and internal errors</a></li>
<li><a href="../327262/index.html">UIKit + Viper or MVC healthy person</a></li>
<li><a href="../327264/index.html">Everything is bad</a></li>
<li><a href="../327266/index.html">How to beat groundhog day ‚Üí Automate testing of the KOMPAS-3D v17 interface</a></li>
<li><a href="../327270/index.html">Hacksplaining - an online course on web vulnerabilities</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>