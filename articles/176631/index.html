<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Basics of security of the Android operating system. Native user space, part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Today, I will continue to look at security at a level slightly above the core. In the second part, we will look at where system.img, us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Basics of security of the Android operating system. Native user space, part 2</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  Today, I will continue to look at security at a level slightly above the core.  In the second part, we will look at where system.img, userdata.img and cache.img come from, as well as how security is provided in the Native user space. <br>  Anyone interested, welcome! <br><a name="habracut"></a><br><br><br><h4>  List of articles </h4>  Here are links to my articles from this topic: <br><ol><li>  <a href="http://habrahabr.ru/post/175517/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/175517/">Core level</a> </li><li>  <a href="http://habrahabr.ru/post/176131/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/176131/">Native user space, part 1</a> </li><li>  <a href="http://habrahabr.ru/post/176631/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/176631/">Native user space, part 2</a> </li><li>  <a href="http://habrahabr.ru/post/176093/">Basics of security of the Android operating system.</a>  <a href="http://habrahabr.ru/post/176093/">Security at the Application Framework level.</a>  <a href="http://habrahabr.ru/post/176093/">Binder ipc</a> </li></ol><br><br><br><h4>  What is meant by Native user space </h4>  Native user space refers to all user-space components that run outside the Dalvik Virtual Machine and that are not part of the Linux kernel.  Native user space are executable files compiled for a specific architecture.  These include executable files that are launched from the init script automatically or in the event of an event, toolbox utilities, as well as some executable files that the user can run from under the shell. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><br><h3>  Start </h3><br>  As I mentioned in the first part, the Android kernel is based on the Linux kernel.  As with all Linux systems, the access control is at the heart of Android security.  Those.  each resource (for example, a file) contains meta-information about who created this file - owner (owner) - and to which main group (owner group) belongs the owner (owner).  Each process runs on behalf of a user.  Each user has a main group.  In addition, he may be a member of other groups.  Thus, if you attach information to each resource (in rwxrwxrwx format) about who can read / write / execute a resource (for example, a file), then you can control access to this file.  For example, you can assign permissions to a file: what the owner (owner) of this file can do with this file;  what can users who are members of the owner group do;  what everyone else can do.  <a href="http://library.linode.com/using-linux/users-and-groups">Here</a> you can read more about this. <br><br>  But Android has some differences.  First, initially, Android is an operating system for phones that are known to belong to very personal things and which we don‚Äôt like to give into the wrong hands.  That is, it was conceived as an operating system with only one user.  Therefore, it was decided to use different Linux users for security (for each application - a separate user, as I already told in the first article).  Secondly, in Android, some user (users) and their UIDs (identifiers) were hard-coded into the system, which causes a lot of complaints from people related to security (although I honestly don‚Äôt really understand why this approach is criticized).  We have already seen these users in the <i><a href="">system / core / include / private / android_filesystem_config.h file.</a></i> For example, <b>root</b> has the identifier <b>0</b> , and <b>system</b> - <b>1000</b> . <br><br>  As I have already noted, the process is launched on behalf of the same user (UID) as the process that starts this new process, i.e.  UID (calling_process) == UID (called_process).  The first process that runs on Android, <b>init,</b> is run as root (UID == 0).  Thus, in theory, all processes should also be started on behalf of the same users.  So it probably would have been.  But, first, processes running on behalf of a privileged user (as well as those who possess certain capabilities) can change their UID to a less privileged one.  And secondly, in Android, when starting the daemons in the <a href=""><i>init.rc</i></a> script, you can also specify with which user privileges and which groups to start this process. <br><br><pre><code class="bash hljs">... service console /system/bin/sh class core console disabled user shell group <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ... service servicemanager /system/bin/servicemanager class core user system group system critical onrestart restart zygote onrestart restart media onrestart restart surfaceflinger onrestart restart drm ... service media /system/bin/mediaserver class main user media group audio camera inet net_bt net_bt_admin net_bw_acct drmrpc ioprio rt 4 ...</code> </pre> <br>  All processes that will be started through these daemons will no longer have root privileges. <br><br><br><br><h3>  System, data and cache </h3><br>  I announced this topic so many times that it was possible to think that it is very complicated and confusing.  In fact, it is not.  <b>System.img</b> , <b>userdata.img</b> and <b>cache.img</b> are what is obtained by compiling the Android operating system.  That is, as a result of the assembly of the system, these three files are obtained, which we write to our device. <br><br>  But the most important thing is not this.  Due to the fact that in the Android system, the user name and UID of system users are hard-coded, already at the compilation stage, we can determine the access rights of various system users to various directories in these images.  These permissions are specified in the <i><a href="">system / core / include / private / android_filesystem_config.h file</a></i> , which we already discussed in the first article.  Access rights are defined separately for directories (android_dirs []) and separately for files (android_files []) as follows: <br><br><pre> <code class="hljs cpp">... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fs_path_config</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> mode; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> uid; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> gid; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> capabilities; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *prefix; }; <span class="hljs-comment"><span class="hljs-comment">/* Rules for directories. ** These rules are applied based on "first match", so they ** should start with the most specific path and work their ** way up to the root. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fs_path_config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">android_dirs</span></span></span><span class="hljs-class">[] = {</span></span> { <span class="hljs-number"><span class="hljs-number">00770</span></span>, AID_SYSTEM, AID_CACHE, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"cache"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00771</span></span>, AID_SYSTEM, AID_SYSTEM, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/app"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00771</span></span>, AID_SYSTEM, AID_SYSTEM, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/app-private"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00771</span></span>, AID_SYSTEM, AID_SYSTEM, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/dalvik-cache"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00771</span></span>, AID_SYSTEM, AID_SYSTEM, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/data"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00771</span></span>, AID_SHELL, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/local/tmp"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00771</span></span>, AID_SHELL, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/local"</span></span> }, { <span class="hljs-number"><span class="hljs-number">01771</span></span>, AID_SYSTEM, AID_MISC, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/misc"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00770</span></span>, AID_DHCP, AID_DHCP, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/misc/dhcp"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00775</span></span>, AID_MEDIA_RW, AID_MEDIA_RW, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/media"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00775</span></span>, AID_MEDIA_RW, AID_MEDIA_RW, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/media/Music"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00771</span></span>, AID_SYSTEM, AID_SYSTEM, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00750</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"sbin"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/bin"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/vendor"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/xbin"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/ppp"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00777</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"sdcard"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }, }; <span class="hljs-comment"><span class="hljs-comment">/* Rules for files. ** These rules are applied based on "first match", so they ** should start with the most specific path and work their ** way up to the root. Prefixes ending in * denotes wildcard ** and will allow partial matches. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fs_path_config</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">android_files</span></span></span><span class="hljs-class">[] = {</span></span> { <span class="hljs-number"><span class="hljs-number">00440</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/init.goldfish.rc"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00550</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/init.goldfish.sh"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00440</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/init.trout.rc"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00550</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/init.ril"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00550</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/init.testmenu"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00550</span></span>, AID_DHCP, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/dhcpcd/dhcpcd-run-hooks"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00440</span></span>, AID_BLUETOOTH, AID_BLUETOOTH, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/dbus.conf"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00444</span></span>, AID_RADIO, AID_AUDIO, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/AudioPara4.csv"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00555</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/ppp/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00555</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/etc/rc.*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00644</span></span>, AID_SYSTEM, AID_SYSTEM, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/app/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00644</span></span>, AID_MEDIA_RW, AID_MEDIA_RW, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/media/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00644</span></span>, AID_SYSTEM, AID_SYSTEM, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/app-private/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00644</span></span>, AID_APP, AID_APP, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"data/data/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/bin/ping"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">/* the following file is INTENTIONALLY set-gid and not set-uid. * Do not change. */</span></span> { <span class="hljs-number"><span class="hljs-number">02750</span></span>, AID_ROOT, AID_INET, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/bin/netcfg"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">/* the following five files are INTENTIONALLY set-uid, but they * are NOT included on user builds. */</span></span> { <span class="hljs-number"><span class="hljs-number">06755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/xbin/su"</span></span> }, { <span class="hljs-number"><span class="hljs-number">06755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/xbin/librank"</span></span> }, { <span class="hljs-number"><span class="hljs-number">06755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/xbin/procrank"</span></span> }, { <span class="hljs-number"><span class="hljs-number">06755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/xbin/procmem"</span></span> }, { <span class="hljs-number"><span class="hljs-number">06755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/xbin/tcpdump"</span></span> }, { <span class="hljs-number"><span class="hljs-number">04770</span></span>, AID_ROOT, AID_RADIO, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/bin/pppd-ril"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">/* the following file has enhanced capabilities and IS included in user builds. */</span></span> { <span class="hljs-number"><span class="hljs-number">00750</span></span>, AID_ROOT, AID_SHELL, (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; CAP_SETUID) | (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; CAP_SETGID), <span class="hljs-string"><span class="hljs-string">"system/bin/run-as"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/bin/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/lib/valgrind/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/xbin/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"system/vendor/bin/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00750</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"sbin/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00755</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"bin/*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00750</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"init*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00750</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"charger*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00750</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"sbin/fs_mgr"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00640</span></span>, AID_ROOT, AID_SHELL, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"fstab.*"</span></span> }, { <span class="hljs-number"><span class="hljs-number">00644</span></span>, AID_ROOT, AID_ROOT, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }, }; ...</code> </pre><br>  And the <i>static inline</i> function <i>void fs_config (const char * path, int dir, unsigned * uid, unsigned * gid, unsigned * mode, uint64_t * capabilities)</i> , which is further defined in this file, is responsible for setting the owner, owner group, capabilities and access rights .  This function is called during <a href="http://hi.baidu.com/donghaozheng/item/5fb55bbc6687d7f163388ee4">image build</a> . <br><br>  In general, everything should be more or less clear, except for setting the <a href="http://ru.wikipedia.org/wiki/Suid">access rights flags</a> (setuid and setgid) for some files (for example, for ‚Äúsystem / xbin / su‚Äù, the access rights are defined as 06755, where the first 6 means that the setting user ID (4) and setting flag group ID (2)).  Setting these flags means that the user can elevate the rights of the process being started to the level of owner (owner) of the file or owner group.  In the case of Android, each application is a user with its own UID and GID.  Thus, by default, if you run any native executable from your application, it is executed with the same UID and GID as the application that caused it.  Installing these permission flags allows you to perform native executable with the rights of the owner.  In our case, the owner is AID_ROOT (root).  This happens as follows <a href=""><i>system / extras / su / su.c</i></a> : <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> argc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **argv</span></span></span><span class="hljs-function">)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> uid, gid, myuid; ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(setgid(gid) || setuid(uid)) { ... } ... }</code> </pre><br>  Those.  the <i>setuid</i> and <i>setgid</i> functions are called.  In this case, if these functions are completed successfully, the process starts on behalf of the owner and owner group of the file.  In our example, this process gets the superuser rights, i.e.  he can do whatever he wants :) Such anarchy is not always justified, so the concept of <a href="http://linux.die.net/man/7/capabilities">capabilities was</a> introduced in Linux.  So, the ‚Äúrun-as‚Äù application does not need all the superuser rights, it only needs to be able to change its identifier in order to launch applications on behalf of various users.  By the way, the capabilities seem to have appeared recently - in Android 2.3.x I have not met them. <br><br><br><br><h3>  Security </h3><br>  In the case of privileged programs (such as, su), it is necessary to limit the range of applications that these programs can call.  Otherwise, any application can get superuser rights.  Therefore, very often, UID checks are built into such programs: <br><br><pre> <code class="cpp hljs">... <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;private/android_filesystem_config.h&gt; ... int main(int argc, char **argv) { struct passwd *pw; int uid, gid, myuid; /* Until we have something better, only root and the shell can use su. */ myuid = getuid(); if (myuid != AID_ROOT &amp;&amp; myuid != AID_SHELL) { fprintf(stderr,"su: uid %d not allowed to su\n", myuid); return 1; } ... }</span></span></span></span></code> </pre><br>  Those.  the program first checks on whose behalf the calling process is running using the <b>getuid ()</b> function.  And then compares these values ‚Äã‚Äãwith the values ‚Äã‚Äãthat are hard-coded into the system.  In this case, only processes running on behalf of <i>the system</i> and <i>root</i> users are allowed to use <b>su</b> . <br><br><br><br><h3>  Conclusion </h3><br>  In this article we have finished to understand how security is provided at the level of the Native user space.  In the following articles, I plan to make out how permission (permissions) work, but due to the large current load I don‚Äôt know when to start writing them.  As always, I will be very happy with additions and corrections. <br><br>  PS Invited to prepare a report on <a href="http://habrahabr.ru/company/devconf/blog/177307/">DevConf @ mobi</a> What do you think, will the audience be interested in a report on the security of the Android operating system at a conference that is more focused on application developers? <br><br><br><h4>  Links </h4><br><ol><li>  <a href="http://shop.oreilly.com/product/0636920021094.do">"Embedded Android"</a> by Karim Yaghmour </li><li>  <a href="https://marakana.com/s/post/1393/slides.htm">Android Security Underpinnings</a> by Marko Gargenta </li><li>  <a href="http://library.linode.com/using-linux/users-and-groups">Linux Users and Groups</a> </li><li>  <a href="http://hi.baidu.com/donghaozheng/item/5fb55bbc6687d7f163388ee4">Image configuration</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/Suid">Suid</a> </li><li>  <a href="http://linux.die.net/man/7/capabilities">Overview of capabilities</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/176631/">https://habr.com/ru/post/176631/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176615/index.html">Copying business papers a hundred years ago</a></li>
<li><a href="../176617/index.html">Implement ToDoMVC on Jiant</a></li>
<li><a href="../176619/index.html">Is there life in the world of PostPC? Part One: Moving</a></li>
<li><a href="../176621/index.html">How to learn English</a></li>
<li><a href="../176629/index.html">Periodic table of visualization methods</a></li>
<li><a href="../176633/index.html">Mozilla JavaScript Web Chat</a></li>
<li><a href="../176635/index.html">PHP HTML DOM parser with jQuery like selectors</a></li>
<li><a href="../176637/index.html">A few words about the book "Professional TDD with C #"</a></li>
<li><a href="../176641/index.html">Education at the Computer Science Center: R & D and Practices</a></li>
<li><a href="../176643/index.html">Creating a custom component from scratch. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>