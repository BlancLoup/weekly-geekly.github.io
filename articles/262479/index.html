<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Instruction: we implement HIDS OSSEC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OSSEC (Open Source Host-based Intrusion Detection System) is a host intrusion detection system. If you have the task of checking the integrity of file...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Instruction: we implement HIDS OSSEC</h1><div class="post__text post__text-html js-mediator-article">  OSSEC (Open Source Host-based Intrusion Detection System) is a host intrusion detection system.  If you have the task of checking the integrity of files on your servers, logging various actions on servers, receiving security events from your servers (as well as any others) and notifications about these events, outputting various reports and much more, then HIDS OSSEC is an excellent solution for these tasks.  OSSEC can work locally, according to the scheme agent + server and in hybrid mode (agent-&gt; server-&gt; server).  We will consider the scheme agent + server and work in a hybrid mode. <br><br><h4>  Content </h4><br>  <a href="https://habr.com/ru/post/262479/">OSSEC installation</a> <br>  <a href="https://habr.com/ru/post/262479/">Configure the OSSEC configuration file</a> <br>  <a href="https://habr.com/ru/post/262479/">Adding agents</a> <br>  <a href="https://habr.com/ru/post/262479/">Configuring the configuration file for agents</a> <br>  <a href="https://habr.com/ru/post/262479/">Email Alerts</a> <br>  <a href="https://habr.com/ru/post/262479/">Working with agents and receiving reports</a> <br>  <a href="https://habr.com/ru/post/262479/">Data output to other systems</a> <br>  <a href="https://habr.com/ru/post/262479/">OSSEC operation in hybrid mode</a> <br><a name="install"></a><br><h4>  OSSEC installation </h4><br>  Install on Ubuntu OS 14.04. Install the necessary packages for the OSSEC installation: <br><a name="habracut"></a><br><pre><code class="xml hljs">apt-get install make gcc libssl-dev</code> </pre> <br>  Downloading OSSEC from offsite: <br><br><pre> <code class="xml hljs">http://www.ossec.net/files/ossec-hids-2.8.2.tar.gz tar -xvf ossec-hids-2.8.2.tar.gz cd ossec-hids-2.8.2</code> </pre><br>  Run the installation script ./install.sh.  Choose a language (en).  We answer questions: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="xml hljs">1) What kind of installation do you want (server, agent, local, hybrid or help)?  server. 2)   . 3) Do you want e-mail notification? (y/n) [y]:   smtp    email . 4) Do you want to run the integrity check daemon? (y/n) [y]:     . 5) Do you want to run the rootkit detection engine? (y/n) [y]:   . 6) Do you want to enable active response? (y/n) [n]:   IPS.         . 7) Do you want to enable remote syslog (port 514 udp)? (y/n) [y]: y</code> </pre><br>  We are waiting for the completion of the installation. <br><br>  By default, OSSEC will be installed in the / var / ossec / directory.  Directories with binary files - / var / ossec / bin /.  Directories with configuration files - / var / ossec / etc /.  Directories with logs - / var / ossec / logs /.  For agents to work with the server, you must open port 1514udp. <br><br><a name="config"></a><br><h4>  Configure the OSSEC configuration file </h4><br>  Open the config file. <br>  nano /var/ossec/etc/ossec.conf. <br><br>  Section global. <br>  In this section, we set up email alerts: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ossec_config</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">global</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_notification</span></span></span><span class="hljs-tag">&gt;</span></span>yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_notification</span></span></span><span class="hljs-tag">&gt;</span></span>     <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_to</span></span></span><span class="hljs-tag">&gt;</span></span>ivanov@ossec.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_to</span></span></span><span class="hljs-tag">&gt;</span></span>    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">smtp_server</span></span></span><span class="hljs-tag">&gt;</span></span>mail.ossec.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">smtp_server</span></span></span><span class="hljs-tag">&gt;</span></span>  SMTP  <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_from</span></span></span><span class="hljs-tag">&gt;</span></span>ossec@ossec.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_from</span></span></span><span class="hljs-tag">&gt;</span></span>    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_maxperhour</span></span></span><span class="hljs-tag">&gt;</span></span>100<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_maxperhour</span></span></span><span class="hljs-tag">&gt;</span></span>       <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">global</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Syscheck section  This section contains the file integrity check parameters: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">syscheck</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Frequency that syscheck is executed - default to every 22 hours --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frequency</span></span></span><span class="hljs-tag">&gt;</span></span>18000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frequency</span></span></span><span class="hljs-tag">&gt;</span></span>      <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Directories to check (perform all possible verifications) --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directories</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">check_all</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag">&gt;</span></span>/etc,/usr/bin,/usr/sbin,/boot,/opt,/lib,/lib64<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directories</span></span></span><span class="hljs-tag">&gt;</span></span>    <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Files/directories to ignore --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ignore</span></span></span><span class="hljs-tag">&gt;</span></span>/etc/mtab<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ignore</span></span></span><span class="hljs-tag">&gt;</span></span>      <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">syscheck</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Let us analyze additional parameters for checking the integrity of files.  If we need to run the scan at a specific time, then we can use the scan_time or scan_day parameter: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scan_time</span></span></span><span class="hljs-tag">&gt;</span></span>04:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scan_time</span></span></span><span class="hljs-tag">&gt;</span></span> #    4 </code> </pre><br>  If we need constant monitoring of integrity of any files, in this case there is a realtime parameter: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directories</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">realtime</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag">&gt;</span></span>/etc,/usr/bin,/usr/sbin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directories</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Constant monitoring of specific files cannot be included; you must specify the directory where this file is located.  You can also enable the launch of the scan when the OS starts: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scan_on_start</span></span></span><span class="hljs-tag">&gt;</span></span>yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scan_on_start</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  If we need to enable notifications about new files appearing in directories, we can use the alert_new_files parameter: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">alert_new_files</span></span></span><span class="hljs-tag">&gt;</span></span>yes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">alert_new_files</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The rootcheck section contains files with rootkit signatures. <br><br>  The localfile sections indicate the log files that ossec will monitor. <br><br>  Based on the decoders and rules that are in /var/ossec/etc/decoders.xml and / var / ossec / rules /, OSSEC will process the events from these log files.  By default, OSSEC has a fairly large number of rules, you can connect / disconnect them in the rules section.  If these rules are not enough for you or some of them are outdated, no one bothers you to change them or write your own. <br><br>  The command and active-response sections contain IPS mode configurations.  You can customize the response to any event.  In / var / ossec / active-response / bin / there are default scripts that can be used upon the occurrence of an event.  With a lack of these scripts, you can add your own. <br><br><a name="addagents"></a><br><h4>  Adding agents </h4><br><pre> <code class="xml hljs"> apt-get install make gcc libssl-dev</code> </pre><br>  Install OSSEC agent from the same distribution, only when installing, select agent mode. <br>  3.1- What's the IP Address or OSSEC HIDS server?  We specify the IP address of our OSSEC server.  Turn on the integrity and rootkit scanner module again.  We are waiting for the installation to complete. Now we need to connect the ossec agent with our server.  There are two ways to do this. <br><br><h5>  1st method </h5><br>  Go to the server and launch the agent management manager: <br><br><pre> <code class="xml hljs">/var/ossec/bin/manage_agents</code> </pre><br>  Choose A (A) dd an agent (A).  Next, write the name of our agent.  Specify the ip address of our agent.  Select the agent ID, you can leave the id that offers OSSEC. <br>  Confirm adding it? (Y / n): y <br>  Confirm the addition of the agent.  Next, select (E) xtract key for an agent.  We specify the id of our new agent.  Copy the base64 line and press Enter.  Select the Q output from the agent work manager.  Restart server for successful agent addition: <br><br><pre> <code class="xml hljs">/etc/init.d/ossec restart</code> </pre><br>  Next, go to our agent and go to the manager of work with agents: <br><br><pre> <code class="xml hljs">/var/ossec/bin/manage_agents</code> </pre><br>  Select (I) mport key from the server to add the key that we copied.  Insert the key and add the agent and exit.  Then you can run our agent. <br><br><pre> <code class="xml hljs">/etc/init.d/ossec start</code> </pre><br>  There should be a mail notification that the new agent is connected.  We go to the server to check whether the agent is connected. <br><br><pre> <code class="xml hljs"> /var/ossec/bin/agent_control ‚Äìl</code> </pre><br>  We should see your agent as Active in the list.  Also in /var/ossec/logs/alerts.alerts.log we should see the event. <br>  New ossec agent connected. <br>  Agent successfully added. <br><br><h5>  2nd method </h5><br>  We go to the server.  We generate a certificate for our server: <br><br><pre> <code class="xml hljs"># openssl genrsa -out /var/ossec/etc/sslmanager.key 2048 # openssl req -new -x509 -key /var/ossec/etc/sslmanager.key -out /var/ossec/etc/sslmanager.cert -days 365</code> </pre><br>  We start the daemon that will wait for the registration of agents on port 1515: <br><br><pre> <code class="xml hljs">/var/ossec/bin/ossec-authd -p 1515 &gt;/dev/null 2&gt;&amp;1 &amp;</code> </pre><br>  Go to the car with the agent: <br><br>  Add an agent <br><pre> <code class="xml hljs">/var/ossec/bin/agent-auth -m 192.168.1.113(ip  ) -p 1515</code> </pre><br>  We start the agent /etc/init.d/ossec start.  Go back to the server and see if our agent has appeared: <br><br><pre> <code class="xml hljs">/var/ossec/bin/agent_control ‚Äìl</code> </pre><br>  We need to see the new agent, the agent name will be the same as the hostname.  To successfully connect the agent, you must restart the OSSEC server.  This method of adding is very convenient, as it does not require many actions on working with keys from the OSSEC server administrator.  For this mode to work, both on the server and on the agent, it is necessary to install OSSEC with the libssl-dev package. <br><br><a name="agentconf"></a><br><h4>  Configuring the agent configuration file </h4><br>  Configuring the configuration file for agents is not much different from configuring this file for the server.  It also has syschek, rootkit, localfile and other sections.  But it is more convenient to keep one configuration file for agents on the server, and the agents themselves will pick up this config file and its changes. <br><br>  To do this, we need to create an agent.conf file on the server in / var / ossec / etc / shared / - this will be our common configuration file.  In this file, you can make different configurations for our agents, which can be divided into several types: <br>  - Agent name.  You can configure multiple agents and list their names. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agent_config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"agentname1|agenname2|agentname3"</span></span></span><span class="hljs-tag">&gt;</span></span>           <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agent_config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  - Server profile.  You can make configurations for server groups (for example, web servers, databases, etc.): <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agent_config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">profile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"web-servers"</span></span></span><span class="hljs-tag">&gt;</span></span>           <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agent_config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  - OS type.  You can make configurations depending on the type of OS: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agent_config</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">os</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Linux,Windows"</span></span></span><span class="hljs-tag">&gt;</span></span>           <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">agent_config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  To verify the syntax in the config file for agents, you can use: <br><br><pre> <code class="xml hljs">/var/ossec/bin/verify-agent-conf</code> </pre><br>  As a result, in /var/ossec/etc/ossec.conf you can leave several lines on the agent: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ossec_config</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">client</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server-hostname</span></span></span><span class="hljs-tag">&gt;</span></span>dns__ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server-hostname</span></span></span><span class="hljs-tag">&gt;</span></span> # <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server-ip</span></span></span><span class="hljs-tag">&gt;</span></span>ip_<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server-ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config-profile</span></span></span><span class="hljs-tag">&gt;</span></span>_, lowmemory<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config-profile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">client</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ossec_config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  The agent will pick up the rest of the configuration from the server. <br><br><a name="email"></a><br><h4>  Email Alerts </h4><br>  We have already specified the settings for email alerts in the global section of the OSSEC configuration file of the server.  In each event of the ossec rules there is a level of severity, if we want to receive email notifications not below a certain level, we can configure this in the alerts section: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">alerts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log_alert_level</span></span></span><span class="hljs-tag">&gt;</span></span>1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log_alert_level</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_alert_level</span></span></span><span class="hljs-tag">&gt;</span></span>7<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_alert_level</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">alerts</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  We can also set up email alerts for events from any specific groups of messages (groups are specified in the ossec rules). <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_alerts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_to</span></span></span><span class="hljs-tag">&gt;</span></span>web_admin@ossec.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_to</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span>apache<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_alerts</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  If we want to receive sms messages, then ossec has a special format for this. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_alerts</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_to</span></span></span><span class="hljs-tag">&gt;</span></span>admin@ossec.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_to</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span>7<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">format</span></span></span><span class="hljs-tag">&gt;</span></span>sms<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">format</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email_alerts</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><a name="report"></a><br><h4>  Working with agents and receiving reports </h4><br><pre> <code class="xml hljs">/var/ossec/bin/agent_control ‚Äìl</code> </pre><br>  Get a list of all agents: <br><br><pre> <code class="xml hljs">/var/ossec/bin/agent_control ‚Äìi id_</code> </pre><br>  Obtaining information about the agent is interesting here checksum configuration file.  It can be compared with the configuration on the server: <br><br><pre> <code class="xml hljs">md5sum /var/ossec/etc/shared/agent.conf</code> </pre><br>  If the checksums do not match, then the agent did not pick up the config from the server. <br><br><pre> <code class="xml hljs">/var/ossec/bin/agent_control ‚ÄìR id_</code> </pre><br>  Restarting the agent is usually necessary to apply changes in the config for agents. <br><br><pre> <code class="xml hljs">/var/ossec/bin/agent_control -r ‚Äìa</code> </pre><br>  Forced start of integrity check and rootkit scan on all agents: <br><br><pre> <code class="xml hljs">/var/ossec/bin/agent_control -r ‚Äìu id_</code> </pre><br>  The same, but only for a specific agent: <br><br><pre> <code class="xml hljs">/var/ossec/bin/syscheck_update -h</code> </pre><br>  Zeroing checksum files counters: <br><br><pre> <code class="xml hljs">/var/ossec/bin/syscheck_update -h -l List available agents. -a Update (clear) syscheck database for all agents. -u <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> Update (clear) syscheck database for a specific agent. -u local Update (clear) syscheck database locally.</code> </pre><br>  To receive reports in the console, you can use this: <br><br><pre> <code class="xml hljs">/var/ossec/bin/ossec-reportd</code> </pre><br>  Examples: <br><br><pre> <code class="xml hljs">      - cat /var/ossec/logs/alerts/alerts.log | /var/ossec/bin/ossec-reportd -s</code> </pre><br><pre> <code class="xml hljs">      - zcat /var/ossec/logs/alerts/2014/Dec/ossec-alerts-29.log.gz | /var/ossec/bin/ossec-reportd -s</code> </pre><br><pre> <code class="xml hljs">         - cat /var/ossec/logs/alerts/alerts.log | /var/ossec/bin/ossec-reportd -s -f group syscheck</code> </pre><br><pre> <code class="xml hljs">       - cat /var/ossec/logs/alerts/alerts.log | /var/ossec/bin/ossec-reportd -s -f rule 5503</code> </pre><br><pre> <code class="xml hljs">      ssh   - cat /var/ossec/logs/alerts/alerts.log | /var/ossec/bin/ossec-reportd -s -f rule 5716</code> </pre><br><pre> <code class="xml hljs">      - cat /var/ossec/logs/alerts/alerts.log | /var/ossec/bin/ossec-reportd -s -f rule 2902</code> </pre><br><pre> <code class="xml hljs">      - cat /var/ossec/logs/alerts/alerts.log | /var/ossec/bin/ossec-reportd -s -f rule 2903</code> </pre><br><pre> <code class="xml hljs">   ssh   - cat /var/ossec/logs/alerts/alerts.log | /var/ossec/bin/ossec-reportd -s -f rule 5712</code> </pre><br><pre> <code class="xml hljs">    - zcat /var/ossec/logs/alerts/2009/Jul/*.gz | /var/ossec/bin/ossec-reportd -s</code> </pre><br>  You can receive reports on the change of checksums of files of a specific agent or any file. <br><pre> <code class="xml hljs">/var/ossec/bin/syscheck_control</code> </pre><br><a name="output"></a><br><h4>  Data output to other systems </h4><br>  In addition to displaying events in the alerts files and in the form of email alerts, OSSEC can be configured to display events in other systems or in the database. <br><br><h5>  SIEM Prelude output </h5><br>  To output events in the SIEM Prelude, you must install the libprelude-dev package before installing the OSSEC server and add prelude support <br><br><pre> <code class="xml hljs">cd ossec-hids-2.8.2/src/ # make setprelude cd .. ./install.sh</code> </pre><br>  Make a conclusion from ossec in PreludeManager.  To do this, open /var/ossec/etc/ossec.conf.  In the global section, add the line &lt;prelude_output&gt; yes &lt;/ prelude_output&gt;. <br><br>  Now connect the OSSEC to the prelude.  Run in one terminal: <br><br><pre> <code class="xml hljs">prelude-admin registration-server prelude-manager</code> </pre><br>  <i>The "p9dfqy34" password will be requested by "pre-admin register"</i> <i><br></i>  <i>in order to connect.</i>  <i>Please remove the quotes before using it.</i> <i><br><br></i>  <i>Generating 1024 bits Diffie-Hellman key for anonymous authentication ...</i> <i><br></i>  <i>Waiting for peers install request on 0.0.0.0 Oc555 ...</i> <i><br></i>  <i>Waiting for peers install request on ::: 5553 ...</i> <br><br>  In another terminal, we add OSSEC with the command: <br><br><pre> <code class="xml hljs"># prelude-admin register OSSEC "idmef:w" 127.0.0.1 --uid ossec --gid ossec</code> </pre><br>  <i>Generating 2048 bits RSA private key ... This might take a very long time.</i> <i><br></i>  <i>[Increasing system activity will speed up the process].</i> <i><br></i>  <i>Generation in progress ... X</i> <br><br>  Now we will start both demons. <br><pre> <code class="xml hljs">/etc/init.d/prelude-manager start /etc/init.d/ossec restart</code> </pre><br>  Now we can observe events from OSSEC in Prelude. <br><br><h5>  Conclusion of events in a DB </h5><br>  To display event events in the database, you must add database support before installing OSSEC: <br><br><pre> <code class="xml hljs">cd ossec-hids-2.8.2/src/ # make setdb cd .. ./install.sh</code> </pre><br>  Later add the parameters to connect to the database in the configuration file.  Example: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ossec_config</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">database_output</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hostname</span></span></span><span class="hljs-tag">&gt;</span></span>192.168.2.32<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hostname</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">username</span></span></span><span class="hljs-tag">&gt;</span></span>db_test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">username</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span>db_pass1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">password</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">database</span></span></span><span class="hljs-tag">&gt;</span></span>ossecdb<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">database</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>mysql<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">database_output</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ossec_config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Supported databases: MySQL and PostgreSQL. <br>  Database schemas are in off-documentation. <br><br>  Next, you need to enable output to the database: <br><br><pre> <code class="xml hljs">/var/ossec/bin/ossec-control enable database /var/ossec/bin/ossec-control restart</code> </pre><br><h5>  Output to other systems via syslog </h5><br>  You need to add the following lines to the config file: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">syslog_output</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span><span class="hljs-tag">&gt;</span></span>ip_address<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>514<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">format</span></span></span><span class="hljs-tag">&gt;</span></span>default<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">format</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">syslog_output</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Enable output: <br><br><pre> <code class="xml hljs">/var/ossec/bin/ossec-control enable client-syslog</code> </pre><br>  Often, syslog from OSSEC displays events in SPLUNK, Logstash, various SIEM. <br><br><a name="hybrid"></a><br><h4>  OSSEC operation in hybrid mode </h4><br>  Hybrid mode in OSSEC is used to build the Agent -&gt; Server -&gt; Primary server schema, in other words, to forward events to the main OSSEC server.  In this mode, both the OSSEC agent and the OSSEC server are running on the server. <br><br>  To install OSSEC in a hybrid mode, you must run the installation script and select the hybrid installation mode, answer all questions and specify the ip address of the main server during the installation process. <br><br>  All files from the agent are located in the / var / ossec / ossec-agent / directory. <br>  Start, Stop, Restart Agent is performed using: <br><br><pre> <code class="xml hljs"> /var/ossec/ossec-agent/bin/ossec-control start|stop|restart</code> </pre><br>  To add this agent to the main server, you must also install a key created on the main server. <br><br><pre> <code class="xml hljs">/var/ossec/ossec-agent/bin/manage_agents</code> </pre><br>  Now this agent will read the file /var/ossec/logs/alerts/alerts.log and send these events to the main server. <br><br>  When I worked with this mode, the agent stopped reading this log after some time.  Installation of this patch helped with the problem: <a href="https://github.com/ddpbsd/ossec-hids/tree/ossecalert">github.com/ddpbsd/ossec-hids/tree/ossecalert</a> <br><br>  Now there are 135 agents on my OSSEC server, there are both servers on Windows and Linux (Ubuntu, Debian, CentOS). <br><br><h4>  Links </h4><br>  - <a href="http://www.ossec.net/">www.ossec.net</a> <br>  - Book OSSEC HIDS Host-Based Intrusion Detection Guide </div><p>Source: <a href="https://habr.com/ru/post/262479/">https://habr.com/ru/post/262479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262465/index.html">Integrating Jira and Slack for PHP</a></li>
<li><a href="../262467/index.html">Stop shot. Recorded and transmitted</a></li>
<li><a href="../262469/index.html">Do the opposite or portable channel for secure data transmission</a></li>
<li><a href="../262471/index.html">High Level C or a couple of words about Cello</a></li>
<li><a href="../262475/index.html">How to embed banners in the Android application without blocking other elements</a></li>
<li><a href="../262483/index.html">Build Tesseract OCR under MinGW</a></li>
<li><a href="../262487/index.html">The most boring build Vivaldi 1.0.219.34</a></li>
<li><a href="../262489/index.html">5 reasons for Angular developers to use Meteor</a></li>
<li><a href="../262493/index.html">Creating a map of a comfortable walk</a></li>
<li><a href="../262497/index.html">Magic of tensor algebra: Part 8 - On convolutions of the Levi-Civita tensor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>