<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New tools and methods to optimize performance and fault tolerance on the example of MS SQL 2012 (RC0): Denali</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Soon we will be preparing this article. Microsoft has already released MS SQL Server 2012: RTM and the final version of the product will be released v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New tools and methods to optimize performance and fault tolerance on the example of MS SQL 2012 (RC0): Denali</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/aae/a5b/8a3/aaea5b8a39d3cdd298eca65367dde5a0.png" align="left">  <s>Soon</s> we will be preparing this article. Microsoft has already released MS SQL Server 2012: RTM and the final version of the product will be released very soon, in which many interesting innovations are planned. <br><br>  Covering them all in one material is quite difficult, so I‚Äôll dwell only on two of them that seemed most interesting - they are associated with increased performance and fault tolerance.  They were considered on the example of a release candidate, but I do not think that in the final release something will change significantly. <br><br><a name="habracut"></a><br>  Practically all the MS SQL functionality described in this article related to server performance is aimed at optimizing read operations.  To effectively implement some of the new functionality, you will need to re-create the relational database and data presentation forms.  It will also require modification of the software that works with these databases. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Often, the data processing system is located within the same data center, which is not always logical from the point of view of common sense, because a data center failure is very likely.  In this part of the article, a geographically dispersed data processing environment will be considered, albeit emulated in poster conditions on a virtual farm of the following type: <br><br><img src="https://habrastorage.org/storage2/d1d/7fb/edf/d1d7fbedf9465ced654f7fc99549c41d.png"><br><br><h4>  One for all and all for one: AlwaysOn &amp; Availability group </h4><br><br>  As everyone knows, a high-performance cluster is a hand-made thing and, therefore, expensive.  Many would like to feel it without damage to the wallet.  A similar solution first appeared for the Exchange Server in the form of Database Availability Group, and then was adapted to the needs of database servers. <br>  So what is it?  The AlwaysOn function (available, by the way, only in the Enterprise Edition) is designed to ensure the resiliency of databases.  It is the database of baths, and not the instances in which these databases operate.  This technology works by replicating the database between servers, more precisely, the transaction log. <br><br>  Consider the process of modeling a fault-tolerant group of geographically distributed servers.  We take 4 identical servers entered into the domain, under control of the external domain controller.  To see how they will exchange data in an environment close to real, for two (SQLONE, SQLTWO) we set up the connection at a speed of 10 Gb, put SQLTHREE on the channel at 1 Gb, and SQLFOUR synchronizes over 3G (since this is a spherical horse in a vacuum , then we take a speed of 10 Mb).  All of them are included in the virtual cloud (ESX 5.0), created on the basis of the DEPO Storm 5302 server (FCoE) and the LSI 2600 (FC) storage, connected via Cisco Nexus 5548. <br><br>  Having a group of MSSQL servers united in a failover cluster (we can do without quorum, Node Majority will suffice), we enable the option 'AlwaysOn Avaibility Groups' on each of them. <br><br><img src="https://habrastorage.org/storage2/e93/f6a/f21/e93f6af21a22c82f7cf95fc96a5693d5.jpg"><br><br>  We select the future fault-tolerant database and switch to the Full recovery model, since replication is carried out by, as already mentioned, spreading the transaction log to the partner servers.  We create on the basis of this database the Availability Group, to which we assign spare placement sites with up to 3 Secondary servers. <br><br><img src="https://habrastorage.org/storage2/c9a/db5/b04/c9adb5b04431a3a197a135a9e988ec64.jpg"><br><br>  Specify the scheme of work with these servers, they will all replicate to themselves the data of the selected database.  Do not forget to create on all servers a group of logins for users of this database.  One or two servers can support synchronous replication with the original data set.  One of them must be Failover-ready, in order to have time to intercept customer service in case of problems with Primary.  By default, Secondary do nothing and just eat electricity.  If you tick 'Read Access Allow' normal Secondary, which is in synchronous replication mode, becomes Active Secondary or Readable Secondary. <br><br>  It looks like this: <br><br><img src="https://habrastorage.org/storage2/e7c/b47/13c/e7cb4713cd2f04b34e6ea55d701e91fd.jpg"><br><br>  ‚ÄúAnd what is the use of this parasite for us?‚Äù - you ask.  First, it can serve read requests.  Especially if an application connecting to an accessibility group does this solely for the purpose of reading data (Read Only), that is, the connection initialization string has the 'Application Intent = readonly' parameter. <br><br>  Secondly, for databases that are in the Availability Group, there is a great option 'Use secondary for backup'.  Thus, even if the databases have grown to such volumes that the backup takes 24 hours, you can safely do it from the data replica to the Secondary, without trying to cram the office day and server maintenance window in one day.  This is especially convenient for database servers with 24/7 operation. <br><br>  In general, with careful editing of applications working with the database, it is possible to ensure that all read operations will be performed from active Secondary, and write operations will be concentrated on Primary. <br>  There is also an option to assign a dedicated ‚Äúlistener‚Äù (listener) so that applications that work with the database can be accessed immediately at the right address: <br><br><img src="https://habrastorage.org/storage2/454/8c4/1ce/4548c41ce72b7f6143a34e11e7bf477d.jpg"><br><br>  Disadvantages of this scheme, of course, there is, first of all, this price.  On the other hand, we get the scheme of work when one server writes, two read, the fourth loafs and looks after its copy.  Given that the writer with the first reader may be in Moscow, the second reader in St. Petersburg or London, and the ‚Äúslacker‚Äù will sit in Vladivostok or Beijing.  This approach allows you to reduce the load on the main server for read operations, unloading it to more efficiently perform write operations, which is more efficient than a classic failover cluster. <br><br><h4>  7 vertically and 4 horizontally - Columnstore index </h4><br><br>  Another option to optimize the work with the database is the so-called Columnar DBMS, which many probably have heard about.  Their main difference from the classic Rowbased is the internal presentation of the data.  Suppose we have a table of the following form: <br><br><img src="https://habrastorage.org/storage2/d0a/f56/695/d0af56695b1f47459947ef4407521ea8.png"><br><br>  The classic Rowbased (string) database stores this data in the form of: <br><br><img src="https://habrastorage.org/storage2/af0/76a/9da/af076a9dae1fc48f245fc7ce200c8440.png"><br><br>  This is useful in cases where we often add rows to the database completely, but it becomes very difficult to make selective selections, for example, by first and last name, because for such a sample, you still need to read the entire table. <br><br>  In the case of the ‚Äúnewfangled‚Äù (that is, invented back in the early 70s of the last century, but according to experts from Microsoft, the database that suddenly turned out to be needed right now) Columnar database is stored in the form of: <br><br><img src="https://habrastorage.org/storage2/ec6/bd2/c43/ec6bd2c4344054fea6387326fec8c053.png"><br><br>  As it is easy to notice here, we see a completely reverse situation: in order to add a row, you need to modify each column, and therefore pull the database into RAM, sort through and stack it back.  But to add a new column or change an existing one in one operation - just spit.  Again, selective sampling becomes very convenient: we simply take the necessary columns of the original base and thus save space in the RAM. <br><br>  An additional plus of the Columnar DB manifests itself with compression - since within a column data has a more uniform appearance than within a row, LZW compression algorithms give a much greater degree of compression of data on columns than on rows. <br><br>  Columnstore index (CSI) gives us the opportunity to make a kind of hybrid Rowbased and Columnar from the table.  In other words, it is possible to select columns in the classic Rowbased table for storage in a Columnar view. <br><br>  This entails some limitations, the most unpleasant of which are: <br><br><ul><li>  if the table defines a Columnstore index, the table cannot be modified.  No UPDATE, INSERT, DELETE and MERGE.  You can certainly make DROP -&gt; INSERT -&gt; CREATE, but the sediment remains unpleasant; </li><li>  There are restrictions on the types of columns in which you can use the Columnstore index (http://msdn.microsoft.com/en-us/library/gg492088 (v=sql.110).aspx#Described); </li><li>  Columnstore Index cannot be a key (both primary - PRIMARY, and external FOREIGN), cannot be unique and cannot be sorted by ASC &amp; DESC (for the compression algorithm is responsible for sorting) and much more (http://msdn.microsoft.com/ en-us / library / gg492088 (v = sql.110) .aspx # Restrictions); </li><li>  also the Columnstore index is very demanding of RAM, in other words, if the column does not fit into the RAM as a whole, there will be no benefit. </li></ul><br><br>  But, of course, there are positive aspects of this solution: <br><br><ul><li>  sampling (SELECT) in the Columnstore index fields is about 10 times faster than sampling from Rowbased; </li><li>  the same can be said about * JOIN. </li></ul><br><br>  ‚ÄúIs that all?‚Äù You ask.  Yes that's all.  We ‚Äúonly‚Äù have a win approximately ten times on the two most popular queries to the database.  Then begins the work of the architect to bring the base to a decent view.  Some of them we leave in Rowbased as often changing, others partially transform in the Columnstore, as static. <br><br>  Or we approach more creatively.  For example, there are open orders that are stored in Rowbased, and every midnight the global archive of processed orders is made in the table for the last month: DROP COLUMNSTORE INDEX, INSERT DATA INTO MONTH, CREATE COLUMNSTORE INDEX.  And then, quickly checking both tables, cleans the common rows from the working base and everyone lives happily. <br><br>  Another variant.  There are incoming telemetry data that are homogeneous in nature.  There is a table in which data is collected for a certain period of time, for example, an hour or a day.  Then this table with the whole clear name 20120229 is converted into a column view according to the schedule, and the data begins to flow as early as 20120301. As a result, the information is neatly folded, compressed and available for real-time reading if necessary. <br><br><h4>  Conclusion </h4><br><br>  As stated at the beginning of the article, only the gain on reading operations is visible here.  Write operations benefit only in the high availability group, due to the fact that the write server can be unloaded by delegating read operations to secondary servers.  In general, the feature is very useful.  Saves nerves and resources, improves performance.  In general, this functionality can be safely put the top five with a minus.  Minus for recovery model requirements. <br><br>  In the case of column indices, we have a net loss by writing - you can‚Äôt enter data into such a table at all, but you can quickly read them from it.  This imposes certain restrictions on the use of this feature.  It turns out something like an American dragster: the speed is high, but only along a straight and level road, and since there are also limitations on the RAM, it is not very long. <br><br>  Overall, the Release Candidate left a pleasant impression.  A functional has appeared that allows us not to call MS SQL 2012 a product of the Enterprise level, and I congratulate all of us. <br><br>  <a href="http://habrahabr.ru/users/evans2094/" class="user_link">evans2094</a> , <br>  Systems Engineer <a href="http://www.depocomputers.ru/%3Futm_source%3Dtopic_220312%26utm_medium%3Dsign%26utm_campaign%3Dhabrahabr">DEPO Computers</a> </div><p>Source: <a href="https://habr.com/ru/post/140481/">https://habr.com/ru/post/140481/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140475/index.html">10 prohibited places on Google Maps</a></li>
<li><a href="../140476/index.html">Pocket Groupware Server: Performance Evaluation</a></li>
<li><a href="../140477/index.html">2GIS Online + Traffic jams: more convenient, more informative</a></li>
<li><a href="../140478/index.html">The Tale of Three Stories</a></li>
<li><a href="../140479/index.html">Video advertising in a new dimension</a></li>
<li><a href="../140483/index.html">Selenium documentation translation published</a></li>
<li><a href="../140484/index.html">Debriefing: Hackspace PHDays CTF Afterparty 2011</a></li>
<li><a href="../140486/index.html">Well, Herz'snim !!!</a></li>
<li><a href="../140487/index.html">Windows 8 Camp - how was it? Photos and recordings</a></li>
<li><a href="../140488/index.html">Xcode 4.3.2 released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>