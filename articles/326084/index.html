<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Audit of current vulnerabilities without registration and SMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 As is known to anyone who has ever signed up for newsletters on IS, the number of vulnerabilities found per day often exceeds a person‚Äô...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Audit of current vulnerabilities without registration and SMS</h1><div class="post__text post__text-html js-mediator-article"><h2>  Introduction </h2><br><img src="https://habrastorage.org/files/94e/2ba/f9f/94e2baf9f78449f3aea373e05165928c.png" align="left" height="180">  As is known to anyone who has ever signed up for newsletters on IS, the number of vulnerabilities found per day often exceeds a person‚Äôs ability to parse.  Especially if there are a lot of servers, especially if there is a zoo from OS and versions. <br><br>  In this topic I will talk about how we solved this problem.  And yes, Perl <b>* is</b> alive :) <br><a name="habracut"></a><br><h2>  Targets and goals </h2><br>  When designing the system, we <a href="https://habr.com/users/mkhlystun/" class="user_link">mkhlystun</a> <b>**</b> solved two parallel tasks: <br><br><ul><li>  Collecting package version information on systems </li><li>  Collecting information about current vulnerabilities on systems </li></ul><br>  Both of these activities pursued a common goal: to correctly prioritize the updates and execute these updates in guaranteed downtime, which we achieved. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Scheme of work </h2><br><img src="https://habrastorage.org/files/200/c43/403/200c43403a2541a4a82c4857e1b7218b.png"><br><ol><li>  Once an hour, each host collects information about current packets and sends its queue </li><li>  Messages are queued from the queue and placed in the database </li><li>  Once in 3 hours the robot comes to the base and drives the packages through the audit service </li><li>  The results for the day generated a report that is sent to all interested </li></ol><br><h3>  Base scheme </h3><br><div class="spoiler">  <b class="spoiler_title">pkgs.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hosts</span></span> ( hostname <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, os <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), pkg_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>[] ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> hosts_pkg_id_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">hosts</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> gin (pkg_id); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> pkg ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SERIAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> pkg_name_idx <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> pkg <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> btree (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> vulners ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, cvss_score <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">precision</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, cvss_vector <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>), description <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, cvelist <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> v2p ( pkg_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> pkg(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), vuln_id <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> vulners(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre> <br></div></div><br>  The <i>hosts</i> table (one host = one entry) is entered into the hosts table, the information in <i>pkg is</i> filled in parallel (one packet - one entry), in order to avoid duplication of information.  The array was chosen historically, it is quite possible to live with it <br><br>  At the same time, information about current vulnerabilities for packages is entered into the <i>vulners</i> table, the <i>v2p</i> connection <i>table</i> allows you to bind many-to-many. <br><br><h3>  Collection of package information </h3><br><div class="spoiler">  <b class="spoiler_title">grabber.pl</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl # (C) Ivan Agarkov 2016 use strict; use warnings; use JSON; # config our %grabs = ( 'centos|oraclelinux|redhat|fedora' =&gt; q(rpm -aq), 'debian|ubuntu' =&gt; q(dpkg-query -W -f='${Package} ${Version} ${Architecture}\n'), 'osx' =&gt; q(pkgutil --pkgs) ); our %unames = ( 'linux' =&gt; q(lsb_release -a), 'darwin' =&gt; q(echo "Distributor ID: OSX") ); # global vars our $hostname = `hostname -f`; our ($vercmd, $grabcmd, $operatingsystem, $version); # do uname my $uname = `uname`; chomp $uname; foreach (keys %unames) { $vercmd = $unames{$_} if $uname =~ /$_/i; } die "Version CMD not found" unless $vercmd; # do version check foreach (`$vercmd`) { chomp; /^Distributor ID:\s*(\S[\S\s]+)$/ and $operatingsystem = $1; /^Release:\s*(\S[\S\s]+)$/ and $version = $1; } die "Opetating System not found" unless $operatingsystem; foreach (keys %grabs) { $grabcmd = $grabs{$_} if $operatingsystem =~ /$_/i; } # grab pkgs die "Opetating System not found" unless $grabcmd; my @pkgs; foreach (`$grabcmd`) { chomp; push @pkgs, $_; } chomp $hostname; my $result = { hostname =&gt; $hostname, os =&gt; $version ? qq($operatingsystem $version) : $operatingsystem, pkgs =&gt; [ sort @pkgs ] }; # print JSON-&gt;new-&gt;encode($result); # done 1;</span></span></code> </pre><br></div></div><br>  For those who do not know Perl: the <i>hostname -f</i> , <i>lsb_release -a</i> and <i>rpm -aq | dpkg-query -W</i> commands are simply executed in succession, all this is packaged in JSON and displayed for sending to the message queue. <br><br><h3>  JSON Transformation to Base </h3><br><div class="spoiler">  <b class="spoiler_title">transform.pl</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl # (C) Ivan Agarkov 2016 use strict; use warnings; use JSON; use DBI; use constant DB =&gt; 'dbi:Pg:dbname=pkgs'; # 0. create connection my $dbh = DBI-&gt;connect( DB, "", "", { RaiseError =&gt; 1, AutoCommit =&gt; 0 } ); # 1. read from stdin and parse my $data = JSON-&gt;new-&gt;decode( join( "", &lt;STDIN&gt; ) ); # if data == array parse foeach if ( ref($data) eq "ARRAY" ) { foreach (@$data) { parse_host($_); } } else { parse_host($data); } # Done 1; ### SUBS ### sub parse_host { $_ = shift; # do parse packages my ( $hostname, $os, @pkgs ) = ( $_-&gt;{hostname}, $_-&gt;{os}, @{ $_-&gt;{pkgs} } ); my @pkgids; eval { foreach (@pkgs) { my $sth = $dbh-&gt;prepare("SELECT id FROM pkg WHERE name=?"); $sth-&gt;execute( ($_) ); if ( my ($id) = $sth-&gt;fetchrow_array ) { push @pkgids, int($id); } else { $dbh-&gt;do( "INSERT INTO pkg (name) VALUES(?)", undef, $_ ); push @pkgs, $_; } } }; $dbh-&gt;rollback and die "$@" if $@; $dbh-&gt;commit; # do parse host eval { my $sth = $dbh-&gt;prepare("SELECT os FROM hosts WHERE hostname=?"); $sth-&gt;execute( ($hostname) ); if ( my ($os2) = $sth-&gt;fetchrow_array ) { if ( lc($os2) ne lc($os) ) { $dbh-&gt;do( "UPDATE hosts SET os=? WHERE hostname=?", undef, $os, $hostname ); } } else { $dbh-&gt;do( "INSERT INTO hosts (hostname, os) VALUES(?, ?)", undef, $hostname, $os ); } }; $dbh-&gt;rollback and die "$@" if $@; $dbh-&gt;commit; # do set packages eval { $dbh-&gt;do( "UPDATE hosts SET pkg_id=? WHERE hostname=?", undef, [@pkgids], $hostname ); }; $dbh-&gt;rollback and die "$@" if $@; $dbh-&gt;commit; }</span></span></code> </pre><br></div></div><br>  This script receives json as input from the queue, and then decomposes it into the database in three stages: <br><br>  - First puts the packages, checking their uniqueness <br>  - Then puts the hosts, updating the version if necessary <br>  - then links the hosts and packets through an array <br><br><h3>  Audit </h3><br>  When we were looking for a way to audit our packages, we went over the options for a long time, until at some conference we had a <a href="http://vulners.com/">vulners</a> business card.  This is the vulnerability aggregator that <a href="https://habr.com/users/isox/" class="user_link">isox</a> and <a href="https://habr.com/users/videns/" class="user_link">videns do</a> .  I contacted them and asked for help.  The result was the <a href="https://vulners.com/audit">Audit API</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Audit API</b> <div class="spoiler_text">  To get information about vulnerabilities, it is enough to build a packet blob in json and send it to <i>/ api / v3 / audit / audit /</i> . <br><br><pre> <code class="hljs pgsql">POST /api/v3/audit/audit/ HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span> Host: vulners.com Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: application/<span class="hljs-type"><span class="hljs-type">json</span></span> Content-Length: <span class="hljs-number"><span class="hljs-number">377</span></span> { "os":"CentOS", "version":"7", "package":["kernel-3.10.0-229.el7.x86_64"]}</code> </pre><br>  In response, the server will give json with a list of current vulnerabilities in the following format: <br><br><pre> <code class="hljs ruby">{ <span class="hljs-string"><span class="hljs-string">"result"</span></span>: <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-string"><span class="hljs-string">"data"</span></span>: { <span class="hljs-string"><span class="hljs-string">"packages"</span></span>: { <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.el7.x86_64"</span></span>: { <span class="hljs-string"><span class="hljs-string">"CESA-2015:2152"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"package"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.el7.x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"providedVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"0:3.10.0-229.el7"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.10.0-327.el7"</span></span>, <span class="hljs-string"><span class="hljs-string">"providedPackage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.el7.x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinPackage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-327.el7.x86_64.rpm"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"lt"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinID"</span></span>: <span class="hljs-string"><span class="hljs-string">"CESA-2015:2152"</span></span> } ], <span class="hljs-string"><span class="hljs-string">"CESA-2015:1978"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"package"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.el7.x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"providedVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"0:3.10.0-229.el7"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.10.0-229.20.1.el7"</span></span>, <span class="hljs-string"><span class="hljs-string">"providedPackage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.el7.x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinPackage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.20.1.el7.src.rpm"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"lt"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinID"</span></span>: <span class="hljs-string"><span class="hljs-string">"CESA-2015:1978"</span></span> }, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> skipped ], <span class="hljs-string"><span class="hljs-string">"CESA-2016:0064"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"package"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.el7.x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"providedVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"0:3.10.0-229.el7"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinVersion"</span></span>: <span class="hljs-string"><span class="hljs-string">"3.10.0-327.4.5.el7"</span></span>, <span class="hljs-string"><span class="hljs-string">"providedPackage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-229.el7.x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinPackage"</span></span>: <span class="hljs-string"><span class="hljs-string">"kernel-3.10.0-327.4.5.el7.src.rpm"</span></span>, <span class="hljs-string"><span class="hljs-string">"operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"lt"</span></span>, <span class="hljs-string"><span class="hljs-string">"bulletinID"</span></span>: <span class="hljs-string"><span class="hljs-string">"CESA-2016:0064"</span></span> }, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> skipped ], <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> skipped ], <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> skipped <span class="hljs-string"><span class="hljs-string">"cvss"</span></span>: { <span class="hljs-string"><span class="hljs-string">"score"</span></span>: <span class="hljs-number"><span class="hljs-number">10.0</span></span>, <span class="hljs-string"><span class="hljs-string">"vector"</span></span>: <span class="hljs-string"><span class="hljs-string">"AV:NETWORK/AC:LOW/Au:NONE/C:COMPLETE/I:COMPLETE/A:COMPLETE/"</span></span> }, <span class="hljs-string"><span class="hljs-string">"cvelist"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"CVE-2014-9644"</span></span>, <span class="hljs-string"><span class="hljs-string">"CVE-2016-2384"</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> skipped ], <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"F777"</span></span> } }</code> </pre><br></div></div><br>  After running in the API, a code was written that pushes the list of packages on the OS and in response receives a list of vulnerabilities and puts them into the database. <br><br><div class="spoiler">  <b class="spoiler_title">audit.pl</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl # (C) Ivan Agarkov 2016 use strict; use warnings; use lib 'perl5'; use HTTP::Tiny; use DBI; use JSON; use constant VULNERS_AUDIT_API =&gt; 'http://vulners.com/api/v3/audit/audit/'; use constant VULNERS_ID_API =&gt; 'http://vulners.com/api/v3/search/id/'; use constant DB =&gt; 'dbi:Pg:dbname=pkgs'; our %VULNS; our $dbh; our %pkgs = (); # 0. connect to DB $dbh = DBI-&gt;connect( DB, "", "", { RaiseError =&gt; 1, AutoCommit =&gt; 0 } ); # get all OS variations my @os = get_os(); # for each OS get all packages and ask vulners for its vulnerabilities foreach my $os (@os) { eval { my ( $o, $ver ) = split( / /, $os ); my $res = HTTP::Tiny-&gt;new-&gt;request( 'POST', VULNERS_AUDIT_API, { headers =&gt; { 'Content-Type' =&gt; 'application/json' }, content =&gt; JSON-&gt;new-&gt;encode( { os =&gt; $o, version =&gt; $ver, package =&gt; [ get_packages($os) ] } ) } ); if ( !$res-&gt;{success} ) { die "HTTP Error: $res-&gt;{content}"; } my $data = JSON-&gt;new-&gt;decode( $res-&gt;{content} ); my $vulns = $data-&gt;{data}-&gt;{packages}; return undef unless defined $vulns; foreach ( keys %$vulns ) { my $o = $vulns-&gt;{$_}; if ( defined( $pkgs{$_} ) ) { $VULNS{ $pkgs{$_} } = [ keys %$o ]; } } }; print $@ if $@; } # Now get info on each vuln ID ( CESA, USN, etc ) ... my @result; my $res = HTTP::Tiny-&gt;new-&gt;request( 'POST', VULNERS_ID_API, { headers =&gt; { 'Content-Type' =&gt; 'application/json' }, content =&gt; JSON-&gt;new-&gt;encode( { id =&gt; [ map {@$_} values %VULNS ] } ) } ); if ( !$res-&gt;{success} ) { die "HTTP Error: $res-&gt;{content}"; } my $data = JSON-&gt;new-&gt;decode( $res-&gt;{content} ); foreach ( values %{ $data-&gt;{data}-&gt;{documents} } ) { push @result, { id =&gt; $_-&gt;{id}, cvss_score =&gt; $_-&gt;{cvss}-&gt;{score}, cvss_vector =&gt; $_-&gt;{cvss}-&gt;{vector}, description =&gt; $_-&gt;{description}, cvelist =&gt; join( ', ', @{ $_-&gt;{cvelist} } ), }; } # Insert the data to DB eval { $dbh-&gt;do( "DELETE FROM v2p", undef ); $dbh-&gt;do( "DELETE FROM vulners", undef ); # insert prepared data to vulners table foreach (@result) { $dbh-&gt;do( "INSERT INTO vulners (id, cvss_score, cvss_vector, description, cvelist) VALUES (?,?,?,?,?)", undef, $_-&gt;{id}, $_-&gt;{cvss_score}, $_-&gt;{cvss_vector}, $_-&gt;{description}, $_-&gt;{cvelist} ); } # and link pkg and vuls into v2p foreach my $pkg_id ( keys %VULNS ) { foreach my $vuln_id ( @{ $VULNS{$pkg_id} } ) { $dbh-&gt;do( "INSERT INTO v2p(pkg_id,vuln_id) VALUES(?,?)", undef, $pkg_id, $vuln_id ); } } }; $dbh-&gt;rollback and die "Error $@" if $@; $dbh-&gt;commit; # All done 1; ### SUBS #### sub get_os { my @os; my $sth = $dbh-&gt;prepare("SELECT DISTINCT os FROM hosts"); $sth-&gt;execute(); while ( my ($os) = $sth-&gt;fetchrow_array ) { push @os, $os; } return @os; } sub get_packages { my $os = shift; my $sth = $dbh-&gt;prepare( "select DISTINCT p.id,p.name FROM pkg p RIGHT JOIN hosts h ON (p.id=ANY(h.pkg_id)) WHERE h.os=?" ); $sth-&gt;execute( ($os) ); my @pkgs; while ( my ( $id, $name ) = $sth-&gt;fetchrow_array ) { $pkgs{$name} = $id; push @pkgs, $name; } return @pkgs; }</span></span></code> </pre><br></div></div><br>  Algorithm: <br><br>  - Take the OS list from the hosts table <br>  - For each OS we get a list of packages <br>  - We send packages to Audit API, we receive the list (id) of vulnerabilities <br>  - We send vulnerabilities to Api ID, we get metadata for each <br>  - We write vulnerability metadata to the vulners table <br>  - We write in the database of communication packages and vulnerabilities in the table v2p <br><br><h3>  Reports </h3><br>  Since our main goal was to get a list of hosts for the priority update, the first report I did was 'top10 hosts to update', selected based on the total CVSS Score <b>***</b> . <br><br><div class="spoiler">  <b class="spoiler_title">report.pl</b> <div class="spoiler_text"><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl # (C) Ivan Agarkov 2016 use strict; use warnings; use lib 'perl5'; use HTTP::Tiny; use DBI; use JSON; use constant DB =&gt; 'dbi:Pg:dbname=pkgs'; our $dbh; our @hosts; # 0. connect to DB $dbh = DBI-&gt;connect( DB, "", "", { RaiseError =&gt; 1, AutoCommit =&gt; 0 } ); # get top10 hosts my $sth = $dbh-&gt;prepare("SELECT h.hostname,SUM(v.cvss_score) as sum FROM hosts h INNER JOIN pkg p ON(p.id=ANY(h.pkg_id)) INNER JOIN v2p vp ON(vp.pkg_id=p.id) INNER JOIN vulners v ON (v.id=vp.vuln_id) GROUP BY h.hostname ORDER BY sum DESC LIMIT 10"); $sth-&gt;execute(); while (my ($host, $sum) = $sth-&gt;fetchrow_array) { push @hosts, { hostname =&gt; $host, score =&gt; $sum, pkgs =&gt; [] }; } foreach (@hosts) { $sth = $dbh-&gt;prepare("SELECT p.name,SUM(v.cvss_score) AS score FROM pkg p RIGHT JOIN hosts h ON (p.id=ANY(h.pkg_id)) INNER JOIN v2p ON (v2p.pkg_id=p.id) INNER JOIN vulners v ON (v.id=v2p.vuln_id) WHERE h.hostname=? GROUP BY p.name ORDER BY score DESC LIMIT 10"); $sth-&gt;execute(($_-&gt;{hostname})); while(my ($pkg,$sum) = $sth-&gt;fetchrow_array) { push @{$_-&gt;{pkgs}}, { package =&gt; $pkg, score =&gt; $sum }; } } print &lt;&lt;EOF TOP 10 SERVERS TO UPDATE EOF ; foreach (@hosts) { print &lt;&lt;EOF -------------------------------------------------- Hostname: $_-&gt;{hostname} Score : $_-&gt;{score} Packages: EOF ; foreach (@{$_-&gt;{pkgs}}) { print &lt;&lt;EOF Name : $_-&gt;{package} Score: $_-&gt;{score} EOF } }</span></span></code> </pre><br></div></div><br>  This code simply takes the top 10 hosts and for each of them takes the top 10 packets with a total soon.  Then you can create tasks and update. <br><br><h2>  Results of the year of use </h2><br>  For more than a year, we have been sending our data to the guys from Vulners.  To date, they are constantly auditing more than 30,000 unique packages.  What is nice, all the bugs found were promptly corrected, and the processing speed of every thousand increased from 30 seconds to 400 milliseconds.  It is thanks to them that this topic is called "... without registration and SMS") <br><br>  With regards to business goals, only with the introduction of this system, we began to appear a process of constant updates.  To update everything is too big a task for the engineer on duty, and to update the first 10 is quite feasible.  For the year, we dropped the total cvss score more than double what we want <b>****</b> ) <br><br><h4>  Footnotes and explanations </h4><br>  <b>*</b> - It happened historically, I started writing automation on Perl and no one had time to stop me. <br>  <b>**</b> - Misha is not an active user of the habr, but as an engineer he is indispensable :) <br>  <b>***</b> - Digital metric of vulnerability hazard, from 1.0 (can be scored) to 10.0 (critical vulnerability) <br>  <b>****</b> - All code can be found here: <a href="https://github.com/annmuor/freeaudit/">github.com/annmuor/freeaudit</a> <br><br>  <b>PS</b> And yet - Perl is alive! </div><p>Source: <a href="https://habr.com/ru/post/326084/">https://habr.com/ru/post/326084/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326074/index.html">Async / await: 6 reasons to forget about promises</a></li>
<li><a href="../326076/index.html">Mikrotik 6to4 automation with dynamic IPv4</a></li>
<li><a href="../326078/index.html">MASM, TASM, FASM, NASM for Windows and Linux</a></li>
<li><a href="../326080/index.html">Future API</a></li>
<li><a href="../326082/index.html">Huawei HyperMetro - tested and implemented</a></li>
<li><a href="../326086/index.html">Cisco CSR 1000v: Features Overview. Part 1</a></li>
<li><a href="../326088/index.html">Message based integration. Advantages and differences from other approaches</a></li>
<li><a href="../326090/index.html">Creating npm package of React components based on create-react-app</a></li>
<li><a href="../326094/index.html">Introduction to the Storage Performance Development Kit (SPDK)</a></li>
<li><a href="../326096/index.html">PostgreSQL indexes - 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>