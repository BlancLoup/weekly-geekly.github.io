<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The story of the classic game hacking on Dendy or Contra with the spreadgan in the beginning</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since my last article , to my great surprise, you are interested. I decided to supplement its result, the hacked version of the game "Contra (J) [T + ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The story of the classic game hacking on Dendy or Contra with the spreadgan in the beginning</h1><div class="post__text post__text-html js-mediator-article"><p>  Since my last <a href="https://habr.com/ru/post/447758/">article</a> , to my great surprise, you are interested.  I decided to supplement its result, the hacked version of the game "Contra (J) [T + Rus_Chronix]", with a bit of functionality, at the same time showing "code injection" on NES.  This time I will make the players start the game with the Spreadgun pumped in order to get it in the game, you need to select the "S" icon, and behind it the "R". </p><br><p><img src="https://habrastorage.org/webt/nd/lc/4a/ndlc4arnoooy49jv50nfqggzdey.png"></p><br><p>  All interested welcome under cat. <a name="habracut"></a></p><br><p>  Traditionally: </p><br><div class="spoiler">  <b class="spoiler_title">boring and tedious process video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/6QTlZS0Gl9A" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><p>  And traditionally plan out a sequence of actions. </p><br><ol><li>  Find the right addresses </li><li>  Find out the value of pumped Spreadgun </li><li>  Find out what he writes to these addresses at the beginning of the game. </li><li>  Rewrite ROM <br><ul><li>  Easyway - change the value of the base weapon on the pumped spread </li><li>  Hardway - use full-fledged code injection if the easy way doesn't work. </li></ul></li><li>  save the result to a new file </li></ol><br><p>  To search for addresses, we use the previously described method, but remembering that lives were in neighboring addresses, we will only look for the weapon of the first player in the hope that the second player will be near.  After opening the "Ram watch" window after the start of the first level, we are looking for an unknown value.  I assume that the base weapon is 0, but I don‚Äôt know for sure. <br>  We run around the level, not running ahead, shoot in all directions and weed out changing values.  Weapon has not changed. </p><br><p>  Let's use another window option, or rather, in the "Compare To / By" field, select the radio number "Number of Changes" checkbox in the field 0. Type of comparison is of course "Equals to".  The weapon still hasn't changed. </p><br><p>  So jumping from the option "equal to the previous value", the option "the number of changes is 0" can reach about 10,000 addresses.  When further screenings will reduce the list of addresses too little or not reduce at all, you can go far enough forward to knock out the first weapon. </p><br><p>  Picking it up, we immediately use the search method "not equal to the previous value", and additionally reduce the list by searching for "the number of changes is 1", the weapon has changed exactly once. </p><br><p>  In the place where we pick up our first weapon, the weapon amplifier also appears.  By knocking out and picking it up, you can reduce the number of addresses you need to 1, but if you don‚Äôt succeed, just kill your character and thus change the weapon again.  (Do not forget about the search after each change). </p><br><p>  With the weapon booster there is some risk that it will change not the value of the weapon itself, but the flag elsewhere in the memory, but let's hope that the authors of the game saved memory and instructions.  And, I was lucky the bonus "R" changed the very value of the weapon and the address was in the coordinate AA <sub>16</sub> .  (I may be mistaken, but I repeatedly monitored the hero‚Äôs weapons in different versions of the Contra game, it seems that this address was AA <sub>16</sub> everywhere). </p><br><p>  I also noticed that the bonus "R" increased the value in the address by 16 <sub>10</sub> or 10 <sub>16</sub> , that is, increased by 1 the first digit of the hexadecimal number. </p><br><p>  After the restart in the "Ram watch" window, you can see that the base value is indeed 00 <sub>16</sub> , the bonus "M" increased the second digit by 1, and the bonus "R" the first. </p><br><p>  You can go for the spreading machine, it will definitely meet in this level, or you can change the value of the address to see which numbers and which weapon they are creating.  Empirically, I found out that 01 <sub>16</sub> is ‚ÄúMachinegun‚Äù, 02 <sub>16</sub> is ‚ÄúFire‚Äù, 03 <sub>16</sub> is ‚ÄúSpreadgun‚Äù, and 04 <sub>16</sub> is ‚ÄúLaser‚Äù.  When you enter other values ‚Äã‚Äãin the second digit, various glitches appear. </p><br><p>  If you reset the game and enter the value 1x <sub>16</sub> in the address (where "x" is any of the valid options) before selecting the "Rapid" bonus, you can find out that re-selecting the bonus does not change anything. </p><br><p>  Now you can restart the game, start the game for two and try to change the addresses adjacent to AA <sub>16</sub> .  (There are two of them, the search will not be long) After shooting the second player, I very quickly found out that the weapon of the second player is really kept nearby in the address AB <sub>16</sub> .  And here we know the addresses we are interested in and the value that we should put there, it's time to find out what it writes to these addresses. </p><br><p>  Having thrown a breakpoint at the recording of this address, I found out that the recording goes there several times and one of them after the splash screen.  This entry makes the following code: </p><br><table><thead><tr><th>  Address </th><th>  Opcode </th><th>  Mnemonic </th><th>  Arguments </th><th>  A </th><th>  X </th></tr></thead><tbody><tr><td>  C307 </td><td>  A2 28 </td><td>  Ldx </td><td>  # $ 28 </td><td>  ?? </td><td>  ?? </td></tr><tr><td>  C309 </td><td>  A9 00 </td><td>  Lda </td><td>  # $ 00 </td><td>  ?? </td><td>  28 or 29 or ... or F0 </td></tr><tr><td>  C30B </td><td>  95 00 </td><td>  Sta </td><td>  $ 00, X </td><td>  00 </td><td>  28 or 29 or ... or F0 </td></tr><tr><td>  C30D </td><td>  E8 </td><td>  INX </td><td></td><td>  00 </td><td>  28 or 29 or ... or F0 </td></tr><tr><td>  C30E </td><td>  E0 F0 </td><td>  CPX </td><td>  # $ F0 </td><td>  00 </td><td>  29 or 30 or ... or F0 </td></tr><tr><td>  C310 </td><td>  D0 F9 </td><td>  Bne </td><td>  $ C30B </td><td>  00 </td><td>  29 or 30 or ... or F0 </td></tr></tbody></table><br><p>  If you carefully read the game here it zeros the range of addresses from 0028 <sub>16</sub> to 00F0 <sub>16</sub> , obviously both addresses of interest in the range.  So there will be no easy way.  We'll have to use "Code Injection" and the simplest solution that I see to find out where we get here, redirect the execution to some free space from code and data, write my own version of the cycle there, which zooms in the whole range except the addresses 00AA <sub>16</sub> and 00AB <sub>16</sub> and the return carriage execution back.  By the way, this is the most classic version of the injection.  It is also possible to assume that we get here from the JSR instruction (Jump to SubRoutine), this is easy to check with the stack. </p><br><div class="spoiler">  <b class="spoiler_title">How the stack works</b> <div class="spoiler_text"><p>  In 6502 processors, the stack is always located in the address range 0100 <sub>16</sub> - 01FF <sub>16</sub> for all computers based on this processor, and grows from a larger address to a smaller one.  There is a separate register pointing to the top of the stack, initially it is equal to FF <sub>16</sub> since the more significant byte never changes.  The register itself always indicates the highest unused bytes of useful data. </p></div></div><br><p>  The emulator debugger does not show the value of the "Stack Pointer" register, instead it shows the address to which the register refers and right now is the address 01F2 <sub>16</sub> , some simple calculations show that the last data to go to the stack is C3 <sub>16</sub> and C2 <sub>16</sub> , which could impose the idea of ‚Äã‚Äãthe address C3C2 <sub>16</sub> but 6502 processor type "Little Endian" and therefore when you execute instructions and save the address in memory or stack, the less significant byte is written first.  And if at the top of the stack is really the address is the address of C2C3 <sub>16</sub> .  And this is the address of the last argument of the JSR instruction, if again this is the general address.  It is very easy to check, just look at what is written two bytes above the C2C3 <sub>16</sub> address. </p><br><table><thead><tr><th>  Address </th><th>  Opcode </th><th>  Mnemonic </th><th>  Arguments </th></tr></thead><tbody><tr><td>  C2C1 </td><td>  20 07 C3 </td><td>  Jsr </td><td>  $ C307 </td></tr></tbody></table><br><p>  As you can see, this JSR instruction is addressed to C307 <sub>16</sub> , which means the assumption about the subroutine is true. </p><br><p>  Now you need to write the injection code correctly, find a suitable place for it, write it to this place and redirect the JSR instruction to this injection. </p><br><div class="spoiler">  <b class="spoiler_title">Reference Sites</b> <div class="spoiler_text"><p>  <a href="http://www.thealmightyguru.com/Games/Hacking/Wiki/index.php/6502_Opcodes">Opcodes</a> , <a href="http://www.6502.org/tutorials/6502opcodes.html">instructions</a> , a lot of information about the <a href="http://www.6502.org/tutorials/">6502 assembly</a> . </p></div></div><br><p> For this, it is very convenient to use a notebook, I have <a href="https://code.visualstudio.com/">Visual Studio Code</a> for it.  Everyone has his own style of writing, personally, I first write the JSR instruction with its address, to know where to change and the full opcode, to know what to change. </p><br><p>  After a couple of indents, I duplicate the cycle code, it can already be used without addresses, but it is extremely useful to see mnemonics with arguments besides opcodes, and it is useful to grab the instruction following the entire cycle, along with the address, to know where to return from the injection. </p><br><pre><code class="plaintext hljs">C2C1:20 07 C3 JSR $C307 A2 28 LDX #$28 A9 00 LDA #$00 95 00 STA $00,X E8 INX E0 F0 CPX #$F0 D0 F9 BNE $C30B C312:A2 07 LDX #$07</code> </pre> <br><p>  Another couple of indents below you can write the code of the injection itself, in fact it is a duplicate of the cycle itself, with some additions. </p><br><pre> <code class="plaintext hljs">C312:A2 07 LDX #$07 A2 28 LDX #$28 A9 00 LDA #$00 95 00 STA $00,X E8 INX E0 AA CPX #$AA D0 F9 BNE -7 A9 13 LDA #$13 95 00 STA $00,X E8 INX E0 AC CPX #$AC D0 F9 BNE -7 A9 00 LDA #$00 95 00 STA $00,X E8 INX E0 F0 CPX #$F0 D0 F9 BNE -7</code> </pre> <br><p>  For greater clarity, I instead of the address of the place of the jump indicated indentation. </p><br><div class="spoiler">  <b class="spoiler_title">If you could not read this code</b> <div class="spoiler_text"><p>  Here, the same cycle, but divided into three parts, in the first cycle we compare register X with the value AA <sub>16</sub> , since we need to zero all addresses to address 00AA <sub>16</sub> , then put register <sub>16</sub> A in register <sub>16 16</sub> , the value of the spredgan is pumped and the second cycle is written it to the address 00AC <sub>16</sub> starting from which the rest of the range should again be zeroed.  We return to the register A zero and zero the rest of the range. </p></div></div><br><p>  It is extremely important to add a return instruction from the injection at the end. </p><br><pre> <code class="plaintext hljs">E0 F0 CPX #$F0 D0 F9 BNE -7 4C 12 C3 JMP $C312</code> </pre> <br><p>  Now, for convenience, I prefer to write opcodes below in the file. </p><br><pre> <code class="plaintext hljs">4C 12 C3 JMP $C312 A2 28 A9 00 95 00 E8 E0 AA D0 F9 A9 13 95 00 E8 E0 AC D0 F9 A9 00 95 00 E8 E0 F0 D0 F9 4C 12 C3</code> </pre> <br><p>  And having calculated opcodes it is easy to find out that there are 32 <sub>10</sub> .  Therefore you need to find 20 <sub>16</sub> unused addresses on ROM.  As a rule, unallocated addresses are large spaces of the same values, most often zeros or FF <sub>16.</sub> Just such a big piece should be found, it must be at least 35 <sub>10</sub> addresses, so that there is some stock. </p><br><p>  In the "Hex Editor" I found such a range in B29E <sub>16</sub> -BFFF <sub>16</sub> .  Using the beginning of such free sites for injections can be dangerous, therefore I advise you to write the code for injections at its end.  The most convenient address to start the injection is BFE0 <sub>16</sub> , but this is the address in the console‚Äôs memory. To find out where it is in the ROM file, right-click on it and select "Go Here In ROM File". </p><br><p>  Now you can copy here the whole opcode (32 values).  The final touch is to change the instructions </p><br><pre> <code class="plaintext hljs">C2C1:20 07 C3 JSR $C307</code> </pre> <br><p>  to jump to the injection I have is BFE0 <sub>16</sub> . </p><br><pre> <code class="plaintext hljs">C2C1:20 E0 BF JSR $BFE0</code> </pre> <br><p>  Of course, having found the true place of the instruction on ROM. </p><br><div class="spoiler">  <b class="spoiler_title">The answer to the question of inattentive professionals.</b> <div class="spoiler_text"><p>  The address of the JSR instruction gets into the stack, so regardless of the jump location, there will be the same return address, and from the injection we return to the JMP instruction that does not affect the stack in any way.  Thus, the RTS instruction works in the same place as without the injection, and returns to the same place as without the injection.  As a result, this injection does not break the work of the stack. </p></div></div><br><p>  PS For good, you still need to do so that after death the characters are reborn with the pumped spreads, but I am sure that you will be able to cope with it yourself with the knowledge gained.  I will turn my gaze to something else.  Unity engine for example. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/447990/">https://habr.com/ru/post/447990/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447970/index.html">Javascript logging is super simple - two decorators and ready</a></li>
<li><a href="../447976/index.html">Development and assembly of a photo-lamp</a></li>
<li><a href="../447982/index.html">Digest: 10 materials about home theater screens and projectors</a></li>
<li><a href="../447984/index.html">Uber filed documents for IPO</a></li>
<li><a href="../447986/index.html">A very mathematical history of the perfect combination of colors.</a></li>
<li><a href="../447992/index.html">Find out the age of the user VK or what else can tell the social graph</a></li>
<li><a href="../447996/index.html">How scientists study the genes that control the complete regeneration of the body</a></li>
<li><a href="../447998/index.html">Time Travel Debugging in Visual Studio Enterprise 2019</a></li>
<li><a href="../448000/index.html">How to quickly try CQRS / ES in Laravel or write a bank in PHP</a></li>
<li><a href="../448002/index.html">What is heisenbag: the history of the term and examples</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>