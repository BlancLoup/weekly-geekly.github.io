<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenDKIM + Postfix = just</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the end of 2011, the developers of the dkim-milter project discontinued its support and development. Fortunately, OpenDKIM came to replace the dkim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenDKIM + Postfix = just</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/78c/c1e/d49/78cc1ed4936f0ef6075b9c9ddfce2165.png"><br><br>  At the end of 2011, the developers of the dkim-milter project <a href="http://sourceforge.net/projects/dkim-milter/">discontinued its support</a> and development.  Fortunately, OpenDKIM came to replace the dkim-milter <a href="http://opendkim.org/">project</a> , with which it‚Äôs just as easy to add a <a href="http://habrahabr.ru/search/%3Fq%3Ddkim">DKIM signature</a> to the letters. <br><br><div class="spoiler">  <b class="spoiler_title">tl; dr: nowadays without DKIM signatures</b> <div class="spoiler_text">  A DKIM signature is a digital signature that is added to the message headers by the sender server, by which the recipient server can verify that the sender of the letter matches the From field in the message headers.  If the recipient's server verifies this signature, then based on the results of the verification, the server can decide how to deal with the letter: accept, send to the Spam folder, send for additional verification, or refuse to accept it at all.  DKIM signatures are checked and used by all leading postal services themselves, including Yandex and Mail.ru.  <a href="http://habrahabr.ru/company/mailru/blog/216535/">The latter openly requires letters to be signed with DKIM.</a> </div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h2>  Instructions for configuring Postfix and OpenDKIM </h2><br>  To do this, we need Postfix itself and the <a href="http://www.opendkim.org/">OpenDKIM</a> packages.  Install all necessary components using your batch manager: <br><br><pre><code class="bash hljs">aptitude install opendkim opendkim-tools</code> </pre> <br>  Now we need to get the keys that we will use to sign letters. <br><br><h2>  Signature keys </h2><br>  We will get the key for the server domain and for the selector, equal to the name of the server without a domain, so as not to invent anything: <br><br><pre> <code class="bash hljs">mkdir /etc/opendkim/ opendkim-genkey -D /etc/opendkim/ -d $(hostname -d) -s $(hostname)</code> </pre> <br>  If it happens on the <code>mail.example.com</code> server, then the last command will create the <code>/etc/opendkim/mail.private</code> and <code>/etc/opendkim/mail.txt</code> , with private and public keys, respectively.  The public key must be added <a href="http://www.zytrax.com/books/dns/ch8/txt.html">to the appropriate TXT record of</a> your domain. <br><br>  The key files must be given read access to the group in which OpenDKIM is running, and <code>postfix</code> itself <code>postfix</code> added to the same group so that it can sign letters connecting to the OpenDKIM daemon through its socket: <br><br><pre> <code class="bash hljs">chgrp opendkim /etc/opendkim/* chmod g+r /etc/opendkim/* gpasswd -a postfix opendkim</code> </pre> <br><br><h2>  Where to find the keys? </h2><br>  <code>/etc/opendkim.conf</code> /etc/opendkim.conf and add our settings: <br><br><pre> <code class="bash hljs">tee -a /etc/opendkim.conf &lt;&lt;EOF Canonicalization relaxed/relaxed SyslogSuccess yes KeyTable file:/etc/opendkim/keytable SigningTable file:/etc/opendkim/signingtable X-Header yes <span class="hljs-comment"><span class="hljs-comment">#      : LogWhy yes #       : #ExternalIgnoreList file:/etc/opendkim/trusted #   ,    : #InternalHosts file:/etc/opendkim/internal EOF</span></span></code> </pre> <br>  A detailed <a href="http://www.opendkim.org/opendkim.conf.5.html">description of all directives is available</a> in the documentation. <br><br><h2>  What keys to sign? </h2><br>  The list of available keys will be <code>/etc/opendkim/keytable</code> in the <code>/etc/opendkim/keytable</code> in the format " <code> ::///</code> ".  If you created the keys with the command above, then you can register the key according to the FQDN of the server in this file as follows: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $(hostname -f | sed s/\\./._domainkey./) $(hostname -d):$(hostname):$(ls /etc/opendkim/*.private) | tee -a /etc/opendkim/keytable</code> </pre> <br>  For <code>mail.example.com</code> there will be the following line in the file: <br><br><pre> <code class="hljs swift">mail._domainkey.example.com example.com:mail:/etc/opendkim/mail.<span class="hljs-keyword"><span class="hljs-keyword">private</span></span></code> </pre> <br>  There can be any number of keys in this file for any number of domains.  Also, keys can be stored in the database - in more detail in the documentation. <br><br><h2>  Whose mail to sign? </h2><br>  Now let us explain OpenDKIM mail of which domains with which keys to sign in the <code>/etc/opendkim/signingtable</code> in the format " <code> -</code> ": <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $(hostname -d) $(hostname -f | sed s/\\./._domainkey./) | tee -a /etc/opendkim/signingtable</code> </pre> <br>  For the <code>mail.example.com</code> host, the file will be <code>example.com mail._domainkey.example.com</code> .  If you want to sign all outgoing mail at all, you can specify <code>*</code> instead of a domain. <br><br>  Other files specified in the <code>ExternalIgnoreList</code> and <code>InternalHosts</code> directives contain simply a list of hosts and / or IP addresses each on a new line, the signatures of letters for which will either be ignored or added.  If your mail is answered by a single server, then you don‚Äôt need to do anything with them. <br><br><h2>  Configure Postfix </h2><br>  Finally, we ask Postfix to send all the letters for signature: <br><br><pre> <code class="bash hljs">postconf -e milter_default_action=accept postconf -e milter_protocol=2 postconf -e smtpd_milters=unix:/var/run/opendkim/opendkim.sock postconf -e non_smtpd_milters=unix:/var/run/opendkim/opendkim.sock</code> </pre> <br><br><h3>  If Postfix is ‚Äã‚Äãin chroot ... </h3><br>  If you use Postfix without chroot, then nothing else needs to be done to configure it.  Otherwise, most likely, you need to explain to OpenDKIM where it should create a socket and give appropriate rights for everything: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'SOCKET="local:/var/spool/postfix/var/run/opendkim/opendkim.sock"'</span></span> | tee -a /etc/default/opendkim mkdir -p /var/spool/postfix/var/run/opendkim chown opendkim:opendkim /var/spool/postfix/var/run/opendkim</code> </pre> <br><br><h2>  Done! </h2><br>  We restart Postfix and OpenDKIM using standard tools, send a test <a href="http://habrahabr.ru/company/yandex/blog/189032/">letter somewhere to Yandex</a> , and enjoy the successful result of the signature verification: <br><br><img src="http://habrastorage.org/getpro/habr/post_images/78c/c1e/d49/78cc1ed4936f0ef6075b9c9ddfce2165.png"><br><br>  Do not forget to <a href="http://www.zytrax.com/books/dns/ch8/txt.html">add a TXT record</a> and check that it is in place: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">dig</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">txt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mail</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">._domainkey</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span></code> </pre> <br><br>  Another way to verify the signature is to send an email to <code>check-auth@verifier.port25.com</code> . <br><br><h2>  We will forbid letters without signature </h2><br>  If the check was successful, then it is necessary to formally prohibit other servers to receive letters with your domain, but without a signature, by adding the <a href="http://habrahabr.ru/post/106589/">ADSP entry</a> : <br><br><pre> <code class="hljs pgsql">_adsp._domainkey <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> TXT "dkim=all"</code> </pre> <br><br><h2>  the end </h2><br>  Read to the end, but want more?  Much <a href="http://www.alexeykopytko.com/2014/postfix-opendkim.html">shorter instructions on how to configure OpenDKIM</a> with one domain and correctly configured hostname. </div><p>Source: <a href="https://habr.com/ru/post/151904/">https://habr.com/ru/post/151904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151897/index.html">CUDA: block synchronization</a></li>
<li><a href="../151898/index.html">A look at the Modern (Metro) Windows interface (Phone / RT) 8</a></li>
<li><a href="../151899/index.html">Lumia can be taken from Nokia to try - for two weeks</a></li>
<li><a href="../151902/index.html">Red pill does not exist</a></li>
<li><a href="../151903/index.html">Worldwide IP Surveillance Industry Leader Supported Ivideon</a></li>
<li><a href="../151905/index.html">‚ÄúAuto Acceleration‚Äù: how to get into the Top 100 Google Play without money and what to do next?</a></li>
<li><a href="../151906/index.html">What is a vulnerability management system on the example of the cloud platform QualysGuard</a></li>
<li><a href="../151911/index.html">We change the design of the online store depending on the season, holiday and even mood</a></li>
<li><a href="../151912/index.html">Python-IronPython-Jython Interpreters Interaction</a></li>
<li><a href="../151913/index.html">Published application My WebMoney for Samsung Bada</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>