<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accelerating the restoration of backups in PostgreSQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My feelings from the process of work 


 Recently, I decided to speed up the recovery of our database in a dev-environment. As in many other projects,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accelerating the restoration of backups in PostgreSQL</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/a94/233/8c3/a942338c326a44a3ac9c4a1085a85873.jpeg"><br><p>  <em>My feelings from the process of work</em> </p><br><p>  Recently, I decided to speed up the recovery of our database in a dev-environment.  As in many other projects, the base was initially small, but it grew significantly over time.  When we started, its size was only a few megabytes.  Now the packed base occupies almost 2 GB (uncompressed - 30 GB).  We restore the dev-environment on average once a week.  The old way of carrying out the operation ceased to suit us, and the picture ‚Äú <a href="https://xkcd.com/303/">DB restore foos?</a>  ‚ÄùPrompted me to action. </p><br><p>  The following describes how I accelerated the database restore operation. </p><a name="habracut"></a><br><h2 id="prostoy-sposob">  Easy way </h2><br><p> The following describes our first version of the backup and restore procedure.  We started by running <code>pg_dump</code> and directing its output to <code>gzip</code> .  To restore the database in the dev environment, we copied the archive using <code>scp</code> , unpacked it, and then loaded it with the <code>psql</code> . </p><br><pre> <code class="bash hljs">$ pg_dump db | gzip &gt; dump.gz real 7m9.882s user 5m7.383s sys 2m56.495s $ gunzip dump.gz real 2m27.700s user 1m28.146s sys 0m41.451s $ psql db &lt; dump real 30m4.237s user 0m21.545s sys 0m44.331s</code> </pre> <br><p>  <em>The total time with a simple method: 39 minutes 41 seconds (32.5 minutes to recover in the dev-environment).</em> </p><br><p>  This approach was simple to understand, elementary in configuration and worked fine until the size of the database did not exceed several hundred megabytes.  However, 32.5 minutes to restore the database in a dev-environment is completely unacceptable. </p><br><h2 id="vosstanovlenie-i-raspakovka-odnoy-komandoy">  Recovery and unpacking in one command </h2><br><p>  The first thing that came to mind was simply to send the packed file directly to <code>psql</code> using <a href="http://linux.die.net/man/1/zcat">zcat</a> , which can be considered an analogue of <a href="http://linux.die.net/man/1/cat">cat</a> for compressed files.  This command unpacks the file and outputs it to <code>stdout</code> , which, in turn, can be sent to <code>psql</code> . </p><br><pre> <code class="bash hljs">$ pg_dump db | gzip &gt; dump.gz real 7m9.882s user 5m7.383s sys 2m56.495s $ zcat dump.gz | psql db real 26m22.356s user 1m28.850s sys 1m47.443s</code> </pre> <br><p>  <em>Total time: 33 minutes 31 seconds (26.3 minutes to recover in the dev-environment, which is 20% faster).</em> </p><br><p>  Great, we managed to speed up the process by 16%, winning 20% ‚Äã‚Äãin recovery.  Since I / O was the main limiting factor, by refusing to decompress the file to disk, we saved more than 6 minutes.  But it seemed to me that this was not enough.  Losing 26 minutes on base recovery is still bad.  I should have come up with something else. </p><br><h2 id="nastraivaemyy-format">  Customizable format </h2><br><p>  Going deeper into the <a href="http://www.postgresql.org/docs/9.5/static/app-pgdump.html">pg_dump documentation</a> , I discovered that pg_dump creates a plain-text SQL file.  Then we compress it with gzip to make it smaller.  Postgres has a custom format, which by default uses zlib for compression.  I thought that it would be possible to achieve a gain in the speed of creating a backup by immediately packing the data into Postgres instead of sending a simple text file to gzip. </p><br><p>  Since psql does not understand the custom format, I had to switch to <a href="http://www.postgresql.org/docs/current/static/app-pgrestore.html">pg_restore</a> . </p><br><pre> <code class="bash hljs">$ pg_dump -Fc db &gt; dumpfc.gz real 6m28.497s user 5m2.275s sys 1m16.637s $ pg_restore -d db dumpfc.gz real 26m26.511s user 0m56.824s sys 0m15.037s</code> </pre> <br><p>  <em>Total time 32 minutes 54 seconds (26.4 minutes to recover in the dev-environment).</em> </p><br><p>  I was right in believing that creating a backup would be faster if we did not have to send the output to gzip.  Unfortunately, recovering from a custom format on a local machine does not speed up the process.  I had to invent something else. </p><br><h2 id="rasparallelivanie">  Paralleling </h2><br><p>  When I start to deal with any problem, first of all I read the documentation and the source code.  Postgres has excellent documentation, including command line options with clear and detailed descriptions.  One of the options of the pg_restore command determines the number of parallel threads that run during the execution of the most time-consuming tasks, loading data, creating indexes or restrictions. </p><br><p>  The pg_restore documentation says that it‚Äôs better to start with the number of threads equal to the number of cores.  My virtual machine has 4 cores, but I wanted to experiment with different values ‚Äã‚Äãof this option. </p><br><pre> <code class="bash hljs">$ pg_dump -Fc db &gt; dumpfc.gz real 6m28.497s user 5m2.275s sys 1m16.637s $ pg_restore -d db -j 2 dumpfc real 25m39.796s user 1m30.366s sys 1m7.032s</code> </pre> <br><p>  <em>The total time is 32 minutes 7 seconds (25.6 minutes to restore in the dev-environment, which is 3% faster than the single-threaded launch of pg_restore).</em> </p><br><p>  Well, won a little.  Can we speed up yet? </p><br><pre> <code class="bash hljs">$ pg_dump -Fc db &gt; dumpfc.gz real 6m28.497s user 5m2.275s sys 1m16.637s $ pg_restore -d db -j 4 dumpfc.gz real 22m6.124s user 0m58.852s sys 0m34.682s</code> </pre> <br><p>  <em>The total time is 28 minutes 34 seconds (22.1 minutes to recover in the dev-environment, which is 14% faster than with two streams).</em> </p><br><p>  Fine!  Four streams are faster than two by 14%.  Yes, this moment in the dev-environment, we accelerated from 32.5 to 22.1 minutes: time has been improved by 32%! </p><br><p>  I decided to find out what will lead to a further increase in the number of cores. </p><br><pre> <code class="bash hljs">$ pg_dump -Fc db &gt; dumpfc.gz real 6m28.497s user 5m2.275s sys 1m16.637s $ pg_restore -d db -j 8 dumpfc.gz real 16m49.539s user 1m1.344s sys 0m39.522s</code> </pre> <br><p>  <em>The total time is 23 minutes 17 seconds (16.8 to restore in the dev-environment, which is 24% faster than four threads).</em> </p><br><p>  So, by increasing the number of threads to double the number of cores, we managed to reduce the time from 22.1 to 16.8 minutes.  Now we have accelerated by 49%, which is just wonderful. </p><br><p>  And you can still squeeze something? </p><br><pre> <code class="bash hljs">$ pg_dump -Fc db &gt; dumpfc.gz real 6m28.497s user 5m2.275s sys 1m16.637s $ pg_restore -d db -j 12 dumpfc.gz real 16m7.071s user 0m55.323s sys 0m36.502s</code> </pre> <br><p>  <em>The total time is 22 minutes 35 seconds (16.1 minutes to recover in the dev-environment, which is 4% more than 8 threads).</em> </p><br><p>  After specifying 12 threads, we accelerated a little more, but the CPU of the virtual machine was so loaded during recovery that no other actions in the system could be performed.  In this matter, I decided to stop at 8 threads (number of cores * 2). </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  As a result, we managed to reduce the time by almost half: from 30 to 16 minutes.  <strong>This saves us 72 hours of recovery time per year</strong> (6 developers for 52 runs of the recovery procedure for 14 minutes).  I am very pleased with these results.  In the future I plan to do only data recovery, but not the entire database.  Let's see how much faster it will be. </p><br><p>  References: </p><br><ol><li>  Original: <a href="https://medium.com/g-adventures-technology/speeding-up-postgres-restores-de575149d17a">Speeding up Postgres Restores</a> . </li><li>  The second part: <a href="https://habrahabr.ru/company/centosadmin/blog/328058/">Accelerate the restoration of backups in Postgres</a> . </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328056/">https://habr.com/ru/post/328056/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328046/index.html">Changes in the rules for advertising newsletters in France: the consent to the distribution by e-mail must be received annually</a></li>
<li><a href="../328048/index.html">All-In-One: Proxmox + OpenMediaVault or another idea for a home NAS</a></li>
<li><a href="../328050/index.html">There is no</a></li>
<li><a href="../328052/index.html">Boxing and unboxing - which is faster?</a></li>
<li><a href="../328054/index.html">2038: only 21 years left</a></li>
<li><a href="../328058/index.html">We speed up the restoration of backups in Postgres. Part Two (because shortening the time is not enough)</a></li>
<li><a href="../328060/index.html">New version of HPE Recovery Management Central 4.0 is available for download.</a></li>
<li><a href="../328062/index.html">Services on Go in Badoo: how we write and support them</a></li>
<li><a href="../328064/index.html">3D modeling and animation: a guide for beginners</a></li>
<li><a href="../328066/index.html">Internet of things - marketing or a real threat</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>