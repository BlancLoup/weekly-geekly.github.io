<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Batch operations as it is done in Drupal</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing projects, it is more complicated than a business card site, it is often necessary to process large amounts of data. Quite often, custo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Batch operations as it is done in Drupal</h1><div class="post__text post__text-html js-mediator-article">  When developing projects, it is more complicated than a business card site, it is often necessary to process large amounts of data.  Quite often, customers want integration with 1C, import of existing prices, upload to Yandex Market, migration from anywhere.  Obviously, creating a thousand nodes in one run will not work, and if so, then aka <a href="http://api.drupal.org/api/drupal/includes%2521form.inc/group/batch/7">Batch operations</a> come to the rescue. <a name="habracut"></a><br>  Start over. <br><br><h5>  Module creation </h5><br>  example / example.info <br><pre><code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">name</span></span> = example description = <span class="hljs-string"><span class="hljs-string">"example batch"</span></span> core = 7.x version = <span class="hljs-string"><span class="hljs-string">"7.x-0.1"</span></span></code> </pre> <br><br>  example / example.module <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example_menu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $items[<span class="hljs-string"><span class="hljs-string">"example"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">"title"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Example"</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span> =&gt; MENU_NORMAL_ITEM, <span class="hljs-string"><span class="hljs-string">"page callback"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"drupal_get_form"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// ,        "page arguments" =&gt; array('example_form'), //    'access arguments' =&gt; array('administer site configuration'), ); return $items; } //     ,    example_form function example_form($form, &amp;$form_state) { $form["submit"] = array( '#type' =&gt; 'submit', '#value' =&gt; t('Submit') ); $form["#action"] = url("example"); return $form; }</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here we have an elementary module that registers a menu item in the system, by clicking on which we will see a form with a button.  This item is available only to users with the right to configure the site, that is, Drupal will not even show anyone who has a link or a page. <br><br><h5>  Form processing and batch operation registration </h5><br>  example / example.module <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//          function example_form_submit() { $batch = array( 'title' =&gt; t('import'), 'operations' =&gt; array( array('example_batch_0', array($_SERVER['REQUEST_TIME'])), // array('example_batch_1', array($_SERVER['REQUEST_TIME'])), // ... ,   ), 'finished' =&gt; 'example_batch_finished', ); batch_set($batch);// batch_process();//     }</span></span></code> </pre><br><br><h5>  Perform batch operation </h5><br>  example / example.module <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     ,   ,  ,  &amp;$context function example_batch_0($time, &amp;$context) { if (empty($context['sandbox'])) { //  , example_batch_0    $context['sandbox']['progress'] = 0; $context['sandbox']['max'] = 100500; //  ,   } //  - // ,  -  $context["result"] $context['message'] = $context['sandbox']['progress']. "/" . $context['sandbox']['max'] ." - ". ($_SERVER['REQUEST_TIME'] - $time) . " sec"; $context['sandbox']['progress']++; if ($context['sandbox']['progress'] &lt; $context['sandbox']['max']) { $context['finished'] = $context['sandbox']['progress'] / $context['sandbox']['max']; } }</span></span></code> </pre><br><br>  $ context ['sandbox'] - our sandbox, the part of the data that belongs only to this function from the package, <br>  when (if) it comes to example_batch_1, the sandbox will be clean again, this allows us to find out at which step of the current operation we are <br><br>  $ context ['result'] - the part of the data that is available to all functions of the package as they are executed <br><br>  $ context ['message'] - the string that will be sent to the browser, in our case, you can see the time spent and the overall progress of the current operation <br><br>  $ context ['finished'] - this value allows the system to understand whether the current operation is completed, 1 or no result means that everything has already been done, a value from 0 to 1 is used to show the progress of the entire batch operation <br><br><h5>  Complete batch operation </h5><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example_batch_finished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($success, $results, $operations)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($success) { drupal_set_message(<span class="hljs-string"><span class="hljs-string">'yep'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { drupal_set_message(<span class="hljs-string"><span class="hljs-string">'nope'</span></span>, <span class="hljs-string"><span class="hljs-string">'error'</span></span>); } }</code> </pre><br><br>  $ success - means that the package is completed without errors. <br><br>  $ results - our results <br><br>  $ operations - our operations, because the same finish can be used for different packages <br><br><h5>  At last </h5><br>  Do not pass large data structures as arguments, do not store them in the sandbox, or output them to the result.  Drupal is able to glue operations together in a single launch, but between launches these structures will be stored in a database.  Large volume in the database simply will not be transferred. <br><br>  About where you can store intermediate data, next time. </div><p>Source: <a href="https://habr.com/ru/post/144424/">https://habr.com/ru/post/144424/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144419/index.html">Python binding for libsass. Exclusively for Habr</a></li>
<li><a href="../144420/index.html">Take Python with you</a></li>
<li><a href="../144421/index.html">Since when do you manage to enter the habr-captcha?</a></li>
<li><a href="../144422/index.html">Court decision: Google does not violate Oracle patents</a></li>
<li><a href="../144423/index.html">Network equipment upgrade</a></li>
<li><a href="../144425/index.html">Boot Windows 8 too fast</a></li>
<li><a href="../144427/index.html">DoS-attack on sites with their own caps</a></li>
<li><a href="../144428/index.html">Russia has created a platform for video conferencing with a record number of participants.</a></li>
<li><a href="../144429/index.html">Oracle vs Google: fronts</a></li>
<li><a href="../144430/index.html">Kinect for Windows SDK has learned to work with individuals</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>