<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WPF, WinForms: 15000 FPS. Hardcore tricks Part 1.5</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An unexpected continuation of this post (honestly did not expect a resonance), so part 2 of hardcore tricks, in which we will discuss a little about t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WPF, WinForms: 15000 FPS. Hardcore tricks Part 1.5</h1><div class="post__text post__text-html js-mediator-article">  An unexpected continuation of <a href="http://habrahabr.ru/post/164705/">this post</a> (honestly did not expect a resonance), so part 2 of hardcore tricks, in which we will discuss a little about the other, will wait. <br>  So, in a nutshell, what has changed: added a control and a test application for WindowsForms, the WPF variant has changed a bit, refactoring and brushing, threadsafe has been added and the control can now be resized normally (included in the samples, but I do not advise deploying to full screen - this is really scary).  Thanks comrades who pointed out the errors and shortcomings and now the project is proudly 0.5 beta.  You can immediately go for the update on <a href="http://razorgdipainter.codeplex.com/">razorgdipainter.codeplex.com/</a> , who are interested in the details please under the cat. <br><a name="habracut"></a><br>  It will be a question of WinForms use case.  Almost all control: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HandleRef hDCRef; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Graphics hDCGraphics; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> RazorPainter RP; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Bitmap RazorBMP { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Graphics RazorGFX { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RazorPainterWFCtl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.MinimumSize = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Size(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); SetStyle(ControlStyles.DoubleBuffer, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); SetStyle(ControlStyles.UserPaint, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); SetStyle(ControlStyles.AllPaintingInWmPaint, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); SetStyle(ControlStyles.Opaque, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); hDCGraphics = CreateGraphics(); hDCRef = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HandleRef(hDCGraphics, hDCGraphics.GetHdc()); RP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RazorPainter(); RazorBMP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bitmap(Width, Height, PixelFormat.Format32bppArgb); RazorGFX = Graphics.FromImage(RazorBMP); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Resize += (sender, args) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RazorGFX != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) RazorGFX.Dispose(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (RazorBMP != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) RazorBMP.Dispose(); RazorBMP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bitmap(Width, Height, PixelFormat.Format32bppArgb); RazorGFX = Graphics.FromImage(RazorBMP); } }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RazorPaint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { RP.Paint(hDCRef, RazorBMP); }</code> </pre> <br>  As promised, the code is as simple as a boot.  The transfer of GFX and BMP from the code of the test application to the code of the control immediately attracts attention.  Thanks, <a href="https://habrahabr.ru/users/alexanderzaytsev/" class="user_link">alexanderzaytsev</a> , it‚Äôs calmer on the soul - it will be more difficult for the front-end programmer to create something indecent with them, and it is easier to work with the resize control. <br><br>  Another noteworthy lock () in the resize code.  As I already mentioned, one of the main advantages of the library is thread independent.  We can ignore the UI Thread, and draw on the control from any stream, at least from three different at the same time.  We do not want anyone to try to draw on the bitmap, which is currently being recreated due to resize? <br>  Appropriately, the frontend code of the windowed application also changed a bit: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">lock</span></span>(razorPainterWFCtl1) { razorPainterWFCtl1.RazorGFX.Clear((drawred = !drawred) ? Color.Red : Color.Blue); razorPainterWFCtl1.RazorGFX.DrawString(<span class="hljs-string"><span class="hljs-string">"habr.ru"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Font, Brushes.Azure,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>); razorPainterWFCtl1.RazorPaint(); } }</code> </pre><br>  Another lock (), but we can be sure that no one can draw and resize at the same time. <br>  In the WPF-version of almost the same changes.  This implementation of threadsafe is of course clumsy, but it is good for demo test applications. <br>  In WF, when the window is closed, Exception has time to slip through - just change the render cycle, because: <br><pre> <code class="cs hljs">renderthread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) Render(); });</code> </pre>  This is really a stupid idea for production. <br><br>  It would be possible to use a control from the WF option as a child control in the WPF version, but something tells me that it is better to separate WPF and WF branches, because with the further development there may be usage patterns that are unique to each of the architectures.  But maybe I‚Äôm just scaring myself and in the future the branches will merge. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Use on health under the MIT-license, i.e.  in any way for any purpose.  Who has a desire - connect to the development of the library on <a href="http://razorgdipainter.codeplex.com/">CodePlex</a> . <br><br>  <b>UPD</b> : Habra comrades <a href="https://habrahabr.ru/users/sintez/" class="user_link">sintez</a> and <a href="https://habrahabr.ru/users/nile1/" class="user_link">nile1</a> convinced to do <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Lock it to avoid resize/repaint race </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> readonly object RazorLock = new object();</span></span></code> </pre>  with a reservation on the test form // better practice is Monitor.TryEnter () pattern, <br>  Indeed, and not very complicated, and it became more correct.  I updated the codex on the codep, released 0.6 beta, thanks to everyone who wrote it. </div><p>Source: <a href="https://habr.com/ru/post/164885/">https://habr.com/ru/post/164885/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164873/index.html">Creating a resilient gateway based on Mikrotik RouterOS</a></li>
<li><a href="../164875/index.html">The theory of creating artificial intelligence</a></li>
<li><a href="../164877/index.html">Re-optimization ... where is the limit?</a></li>
<li><a href="../164881/index.html">Seeder 1.1 entropy generator significantly reduces lags on Android devices</a></li>
<li><a href="../164883/index.html">Jelastic Cloud + Maven. Part 1</a></li>
<li><a href="../164887/index.html">Passage of the Labyrinth Captcha on Javascript</a></li>
<li><a href="../164889/index.html">Creating a TV channel on the Internet using a home computer</a></li>
<li><a href="../164895/index.html">Zero Day Vulnerability in IE v6-8</a></li>
<li><a href="../164899/index.html">Another ‚ÄúSolar System‚Äù on HTML5 Canvas</a></li>
<li><a href="../164901/index.html">We write a simple sniffer for Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>