<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Centrifugo - 3.5 million rpm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time I wrote about Centrifugo a little over a year ago. The time has come to remind of the existence of the project and tell what happened during...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Centrifugo - 3.5 million rpm</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/322/29c/285/32229c2853ef43a1bf7a3752ff5565aa.jpg"><br><br>  Last time I wrote about <a href="https://github.com/centrifugal/centrifugo">Centrifugo a</a> little over a year ago.  The time has come to remind of the existence of the project and tell what happened during this period of time.  To prevent the article from slipping into a boring enumeration of changes, I will try to focus on some Go libraries that have helped me in the development ‚Äî perhaps you will get something useful for yourself. <br><a name="habracut"></a><br>  The best part is that this year there was a decent amount of projects using Centrifugo in battle - and each such story is very inspiring.  Currently, the largest installation of the Centrifuge, which I know about, is: <br><br><ul><li>  300 thousand users online </li><li>  3.5 million fan-out messages per minute </li><li>  4 Centrifugo nodes on Amazon c4.xlarge </li><li>  nodes are connected by a PUB / SUB mechanism of a single Redis instance </li><li>  CPU consumption on average 40% </li></ul><br>  By tradition, I have to remind you what I'm writing to you about.  I will try to simplify my life and quote the <a href="https://habrahabr.ru/company/mailru/blog/280346/">last post</a> : <br><blockquote>  Centrifugo is a server that runs next to the backend of your application (the backend can be written in any language / framework).  Application users connect to Centrifuge using the Websocket protocol or the SockJS polyfill library.  Having connected and logged in using an HMAC token (received from the application backend), they subscribe to the channels of interest.  Having learned about a new event, the backend of the application sends it to the desired channel in Centrifuge using the HTTP API or the queue in Redis.  The centrifuge, in turn, instantly sends a message to all connected interested (subscribed to the channel) users. </blockquote><br>  A year ago, the latest version was 1.4.2, and now it is already 1.7.3 - a lot of work has been done. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Last year, Centrifuge received HTTP / 2 support.  It cost me a lot of work and many hours of work.  Just kidding :) With Go 1.6 release, Go projects got HTTP / 2 support automatically.  In fact, for Centrifugo, where the main transport is still Websocket, HTTP / 2 support may seem useless.  However, this is not entirely true - after all, Centrifugo including is a SockJS server.  SockJS provides fallback to transports that use the HTTP protocol (Eventsource, XHR-streaming, etc.), in case the browser for some reason cannot establish a Websocket connection.  Well, or just in case you for some reason do not want to use Websocket.  For many years, we struggled with the limit on persistent connections to a single host, which is set by the HTTP specification (in reality, 5-6 depending on the browser), and now the time has come when, thanks to HTTP / 2, connections from different browser tabs are multiplexed into one.  Tabs with permanent HTTP connections can now be opened a lot.  So understand - what kind of transport is currently better for a more unidirectional flow of real-time messages from the server to the client - Websocket or something like an Eventsource over HTTP / 2. <br><br>  A little later, another interesting innovation concerning the HTTP server appeared - support for automatically obtaining an HTTPS certificate from Let's Encrypt.  Again I would like to say that I had to sweat, but no - thanks to the <a href="https://godoc.org/golang.org/x/crypto/acme/autocert">golang.org/x/crypto/acme/autocert</a> package, I <a href="https://godoc.org/golang.org/x/crypto/acme/autocert">could</a> write a server that can work with <a href="https://letsencrypt.org/">Let's Encrypt</a> - this is a matter of several lines of code: <br><br><pre><code class="go hljs">manager := autocert.Manager{ Prompt: autocert.AcceptTOS, HostPolicy: autocert.HostWhitelist(<span class="hljs-string"><span class="hljs-string">"example.org"</span></span>), } server := &amp;http.Server{ Addr: <span class="hljs-string"><span class="hljs-string">":https"</span></span>, TLSConfig: &amp;tls.Config{GetCertificate: manager.GetCertificate}, } server.ListenAndServeTLS(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)</code> </pre> <br>  In version 1.5.0, an important change was that protobuf began to fly between Centrifuge and Radish instead of JSON.  To work with protobuf, I took the <a href="https://github.com/gogo/protobuf">github.com/gogo/protobuf</a> library - due to code generation and not using the package, the reflect speed of serialization and deserialization is simply crazy.  Especially in comparison with JSON: <br><br><pre> <code class="bash hljs">BenchmarkMsgMarshalJSON 2022 ns/op 432 B/op 5 allocs/op BenchmarkMsgMarshalGogoprotobuf 124 ns/op 48 B/op 1 allocs/op</code> </pre><br>  Initially, protobuf version 2 was used, but a little later it was possible to upgrade to the current version 3. <br><br><img src="https://habrastorage.org/files/5b7/16a/5ef/5b716a5ef2924d6da90cf8217f3a25c5.jpg"><br><br>  The graph shows much less time to process a request in version 1.5, using protobuf.  At the same time, the more complex the request and the more data (the more channels to which the messages should be posted) it contains - the more noticeable the difference. <br><br>  To add protobuf support to your Go project, just write a proto file like this: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> proto; <span class="hljs-attribute"><span class="hljs-attribute">import</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/gogo/protobuf/gogoproto/gogo.proto"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> (gogoproto.equal_all) = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> (gogoproto.populate_all) = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">option</span></span> (gogoproto.testgen_all) = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Message { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> UID = <span class="hljs-number"><span class="hljs-number">1</span></span> [(gogoproto.jsontag) = <span class="hljs-string"><span class="hljs-string">"uid"</span></span>]; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> Channel = <span class="hljs-number"><span class="hljs-number">2</span></span> [(gogoproto.jsontag) = <span class="hljs-string"><span class="hljs-string">"channel"</span></span>]; <span class="hljs-attribute"><span class="hljs-attribute">bytes</span></span> Data = <span class="hljs-number"><span class="hljs-number">3</span></span> [(gogoproto.customtype) = <span class="hljs-string"><span class="hljs-string">"github.com/centrifugal/centrifugo/libcentrifugo/raw.Raw"</span></span>, (gogoproto.jsontag) = <span class="hljs-string"><span class="hljs-string">"data"</span></span>, (gogoproto.nullable) = <span class="hljs-literal"><span class="hljs-literal">false</span></span>]; }</code> </pre><br>  As you can see, in the proto-file it is possible to use not only the basic types, but also your custom types. <br><br>  After the proto-file is written - it remains only to set a protoc on this file (you can <a href="https://github.com/google/protobuf/releases">download</a> it from the releases page) using one of the code generators provided by the <code>gogoprotobuf</code> library - as a result, a file will be created with all the necessary methods of serialization and deserialization of the described structures.  If you are interested in reading about it in more detail, <a href="https://medium.com/%40fzambia/21d39bdabd68">here is the article</a> , the truth is in English. <br><br>  I also experimented a lot with alternative JSON parsers to deserialize the messages included in the API - <a href="https://github.com/pquerna/ffjson">ffjson</a> , <a href="https://github.com/mailru/easyjson">easyjson</a> , <a href="https://github.com/tidwall/gjson">gjson</a> , <a href="https://github.com/buger/jsonparser">jsonparser</a> .  The best performance was shown by <code>jsonparser</code> - it really speeds up JSON parsing in the stated 10 times and practically does not allocate memory.  However, I did not dare to add it to Centrifugo - until it became a bottleneck I did not want to move away from using the standard library.  However, it is nice to know that there is an opportunity to so significantly improve the performance of parsing JSON data. <br><br>  Also JSON is used to communicate with the client - in some particularly hot areas (for example, for new messages in the channel) I create JSON not using the <code>Marshal</code> function, but manually, it looks like this: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(buf *bytebufferpool.ByteBuffer, msg *Message)</span></span></span></span> { buf.WriteString(<span class="hljs-string"><span class="hljs-string">`{"uid":"`</span></span>) buf.WriteString(msg.UID) buf.WriteString(<span class="hljs-string"><span class="hljs-string">`",`</span></span>) buf.WriteString(<span class="hljs-string"><span class="hljs-string">`"channel":`</span></span>) EncodeJSONString(buf, msg.Channel, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) buf.WriteString(<span class="hljs-string"><span class="hljs-string">`,"data":`</span></span>) buf.Write(msg.Data) buf.WriteString(<span class="hljs-string"><span class="hljs-string">`}`</span></span>) }</code> </pre> <br>  It uses the library <a href="https://github.com/valyala/bytebufferpool">github.com/valyala/bytebufferpool</a> - providing a pool of [] byte-buffers to further reduce the number of memory allocations. <br><br>  I also recommend the wonderful library <a href="https://github.com/nats-io/nuid">github.com/nats-io/nuid</a> - in the Centrifuge each message gets a unique id, this library from the developers of <a href="https://nats.io/">Nats.io</a> allows <a href="https://nats.io/">you</a> to generate unique identifiers very quickly.  However, it should be borne in mind that you can only use it where you are not afraid that the attacker will be able to calculate the next id from the existing one.  But in many places this library can be a good replacement for uuid. <br><br>  Version 1.6.0 was the result of a complete refactoring of the server code, on which I worked for three months - this is where I really had to sweat.  I still drink Centrifuge after hours, so these 3 months are not really that much in terms of time.  But still. <br><br>  The result of refactoring was the separation of code into small packages with a clear public API and interaction with each other - before that, all the code for the most part lay in one folder.  It also turned out to make certain parts of the server replaceable at the initialization stage.  Now, when almost half a year has passed since then, I will not say that this splitting into separate small packages had any significant impact or gave tangible benefits afterwards - no, nothing like that.  But, most likely, it simplifies reading the code for other programmers - who are not familiar with the project from the very first days. <br><br>  In the process of refactoring, it turned out to significantly improve some parts of the code ‚Äî for example, metrics that now somewhat resemble how the addition of metrics is arranged in the <a href="https://github.com/prometheus/client_golang">Prometheus client for Go</a> . <br><br>  The centrifuge uses the <a href="https://github.com/spf13/viper">github.com/spf13/viper</a> package for configuration ‚Äî this is one of the best libraries for configuring the application I've worked with ‚Äî since with minimal effort from the programmer, it is possible to customize the configuration of the application using environment variables and flags at startup and the settings file (using popular formats - YAML, JSON, TOML, etc.) + viper works in conjunction with <a href="https://github.com/spf13/cobra">github.com/spf13/cobra</a> - one of the most convenient packages for creating cli-utilities.  But there is one big BUT!  Viper pulls some unreasonable number of <a href="https://godoc.org/github.com/spf13/viper%3Fimports">external dependencies</a> , some of which pull their own - and most of these dependencies are not used at all in Centrifugo - remote configuration (Consul, Etcd), support for the afero file system, fsnotify (who generally needs a server did the applications restart automatically when the config was changed on the disk?), HCL and Java configuration file formats are also not needed.  So I had to fork the viper and make my ‚Äúlite‚Äù version, in which there are no dependencies that I do not need.  In fact, this is not the best option - I would like the viper to support plugins and library users themselves determine at the initialization stage which pieces of functionality they need. <br><br>  In version 1.6, the Redis sharding by channel name was added to distribute the load among several Redis instances.  I was always embarrassed by the restriction of one Redis instance ‚Äî although it was extremely fast on the operations that the Centrifuge uses, I still wanted to have a way to scale this point.  Now with the presence of sharding instead of the following scheme: <br><br><img src="https://habrastorage.org/files/4a1/bc4/765/4a1bc476547c474cb02a0b4103e5d46d.jpg"><br><br>  We get this: <br><br><img src="https://habrastorage.org/files/77d/92d/f1c/77d92df1c59740b68458a1dde868435b.jpg"><br><br>  Unfortunately, without resharing, but in the case of Centrifuge, resharding is not so important in fact - the message delivery model and so at most once, and thanks to the way the Centrifuge works, the state itself is restored after a while.  Inside, a fast and non-memory-consuming sharding algorithm called <a href="http://inf-server.inf.uth.gr/courses/CE623/Fast_min_memory_consistent_hash_algorithm.pdf">Jump</a> is used ‚Äî the code from the <a href="https://github.com/dgryski/go-jump">github.com/dgryski/go-jump</a> library is used.  More recently, a story has emerged of successfully using sharding in production ‚Äî in Mesos a three-shard environment.  However, I haven‚Äôt been able to use sharding in some of my projects. <br><br>  Perhaps you know that in Centrifuge there is a web-interface written in ReactJS, this interface lies in a separate repository and is uploaded to the server at the build stage.  Thus, the binary includes all the statics necessary for the operation of the web interface - the built-in Go FileServer allows you to easily give the statics to the desired address.  Initially, for these purposes I used <a href="https://github.com/jteeuwen/go-bindata">github.com/jteeuwen/go-bindata</a> in conjunction with <a href="https://github.com/elazarl/go-bindata-assetfs">github.com/elazarl/go-bindata-assetfs</a> .  However, I came across a more lightweight and simpler in my opinion <a href="https://github.com/rakyll/statik">github.com/rakyll/statik</a> library - from the familiar Go community Jaana B. Dogan. <br><br>  Finally, the last thing I would like to mention from the server changes is the integration with the <a href="https://godoc.org/github.com/gorilla/websocket">PreparedMessage</a> structure from the Gorilla Websocket library.  Appeared <code>PreparedMessage</code> in the Gorilla Websocket library recently.  The essence of this structure comes down to the fact that it caches the created websocket frame in order to reuse it whenever possible and not create it every time.  In the case of Centrifuges, when there are thousands of users in the channel and the same message is sent to the connection for all, it makes sense with a sufficiently large number of users (in my benchmarks, the gain appeared when there were&gt; 20k customers in one channel).  But it makes even more sense when Websocket traffic is turned on ‚Äî in the case of the Websocket protocol, this is <a href="https://tools.ietf.org/html/rfc7692">the permessage-deflate extension</a> , which allows you to compress traffic using <a href="https://golang.org/pkg/compress/flate/">flate</a> compression.  In Go, the <code>flate.Writer</code> structure weighs more than 600kb (!), So with a large fan-out of messages (regardless of the number of clients in the channel) - <code>PreparedMessage</code> helps a lot. <br><br>  A little sore point - these are clients for mobile devices.  Since I do not know either Objective-C / Swift, or Jav at a sufficient level, I can‚Äôt help with the development of mobile clients for Centrifugo, which allow you to connect to the server with iOS and Android devices.  These clients were written by members of the open-source community, for which I am immensely grateful to them.  However, having written clients, the authors, by and large, lost interest in their support - and some features are still missing there.  However, these are working clients who have proved the possibility of using the Centrifuge from mobile devices. <br><br>  This situation cannot but upset me - so for my part I took a step to try to write a client on Go and use <a href="https://github.com/golang/mobile">Gomobile</a> to generate binding to a client for iOS (Objective-C / Swift) and Android (Java).  Well, in general, I managed it - <a href="https://github.com/centrifugal/centrifuge-mobile">github.com/centrifugal/centrifuge-mobile</a> .  It was fascinating - the most difficult part was to try out the bindings obtained in the business - for this I had to master XCode and Android Studio, and also write small examples of using the Websocket client Centrifuge for all three languages ‚Äã‚Äã- Objective-C, Swift and Java.  I wrote <a href="https://medium.com/%40fzambia/e72dc2736f01">an article</a> about the features of Gomobile - maybe someone will be interested in the details. <br><br><img align="left" width="245" src="https://habrastorage.org/files/599/3cb/682/5993cb682a9a4603809a5f253a350882.jpg">  Among the shortcomings of gomobile, I would like to point out not even strict restrictions on the types supported (which are actually quite possible to live with), but the fact that Go does not generate LLVM bitcodes (Apple) that Apple recommends adding to each application.  In theory, this bitcode allows Apple to independently optimize applications in the App Store.  Currently, when creating an iOS application, you can disable the bitcode in the project settings in XCode, but what happens if Apple decides to make it mandatory?  Unclear.  And the lack of control over the situation is a little sad. <br><br>  The most amazing thing for me is that I learned about it only when the code of my library was ready, tested on an Android device, and I was absolutely sure that everything would go smoothly on iOS ‚Äî there is no mention of it anywhere in the gomobile documentation found (distracted and overlooked?). <br><br>  Here, in general, and all of the bright events.  Trying Centrifugo is not difficult - there are packages for popular Linux distributions, a Docker image, binary releases and a couple of lines to put on MacOS using brew - all useful links can be found in the <a href="https://github.com/centrifugal/centrifugo">README</a> on Github. </div><p>Source: <a href="https://habr.com/ru/post/326236/">https://habr.com/ru/post/326236/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326222/index.html">When GitHub shoots you in the head, a new framework is created. The idea, concept and implementation of "Rutetider"</a></li>
<li><a href="../326226/index.html">IP and IT: the eternal dispute about the main thing</a></li>
<li><a href="../326230/index.html">How I was a developer, and now Timlid</a></li>
<li><a href="../326232/index.html">APS technology: control panel frontend and JS SDK features</a></li>
<li><a href="../326234/index.html">New version of Windows 10: sysadmin view</a></li>
<li><a href="../326238/index.html">RStudio Connect - Shiny "facelift" for corporate use</a></li>
<li><a href="../326240/index.html">Office in 100 machines, or a story about how I transferred the server from Windows to Centos 7. Prologue</a></li>
<li><a href="../326242/index.html">Performance is a holiday</a></li>
<li><a href="../326246/index.html">Green light to developers - from startup to the stars. Valentin Gogichashvili</a></li>
<li><a href="../326248/index.html">W3Tech: the share of nginx in the world rose to third, Apache fell below half</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>