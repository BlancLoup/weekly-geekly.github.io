<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MikroTik. Correct dst nat when using 2 or more providers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Getting to the task, I was counting on an easy walk in the shade of an oak park, contemplating nature and indulging in thoughts ... However, later it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MikroTik. Correct dst nat when using 2 or more providers</h1><div class="post__text post__text-html js-mediator-article">  Getting to the task, I was counting on an easy walk in the shade of an oak park, contemplating nature and indulging in thoughts ... However, later it became clear that this would be a thorny and difficult trek through mountain rivers with underwater rocks, icy rocks and deep caves. <br>  Through meditation, the struggle with the elements and <s>my own dullness of</s> overcoming myself, I nevertheless achieved the desired nirvana. <br><br>  In this article I will not only provide a ready-made set of rules, but I will try to explain as much as possible why and how they work. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/076/f60/3f6/076f603f6bbf4675bba840eee8430a41.png"></div><br>  Specifically, in my case, it was necessary to configure the router so that the web server in the local network behind it was available over the IP of any of the 3 providers. <br><a name="habracut"></a><br><h3>  Part 1. </h3><br>  For a start, let's go over all the settings so that the most impatient can copy-paste without reading. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Version RouterOS:</b> <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># oct/11/2016 22:02:32 by RouterOS 6.37.1 # software id = X62B-STGZ</span></span></code> </pre> <br>  <b>Interfaces:</b> <br><pre> <code class="bash hljs">/interface list add name=WAN /interface list member add interface=ISP1 list=WAN add interface=ISP2 list=WAN add interface=ISP3 list=WAN</code> </pre><br>  I do not remember from which version of RouterOS this feature appeared.  It allows you to group interfaces, which is very convenient (for example, in the rules / ip firewall).  I have a group of 3 WAN interfaces. <br>  <a href="https://habrahabr.ru/users/acidvenom/" class="user_link">AcidVenom</a> suggested that in 6.36 <br><br>  <b>IP addresses (addresses, for obvious reasons, ‚Äúleft‚Äù):</b> <br><pre> <code class="bash hljs">/ip address add address=192.168.0.1/24 comment=defconf interface=bridge network=192.168.0.0 add address=95.11.29.240/24 interface=ISP1 network=95.11.29.0 add address=5.35.59.162/27 interface=ISP2 network=5.35.59.160 add address=5.98.112.30/30 interface=ISP3 network=5.98.112.28</code> </pre><br>  <b>Routing:</b> <br><pre> <code class="bash hljs">/ip route add distance=1 gateway=95.11.29.254 routing-mark=ISP1-route add distance=1 gateway=5.35.59.161 routing-mark=ISP2-route add distance=1 gateway=5.98.112.29 routing-mark=ISP3-route add check-gateway=ping distance=1 gateway=8.8.8.8 add check-gateway=ping distance=2 gateway=8.8.4.4 add check-gateway=ping distance=3 gateway=1.1.36.3 add distance=1 dst-address=8.8.4.4/32 gateway=5.35.59.161 scope=10 add distance=1 dst-address=8.8.8.8/32 gateway=95.11.29.254 scope=10 add distance=1 dst-address=1.1.36.3/32 gateway=5.98.112.29 scope=10</code> </pre><br>  For the organization of Failover, I configured recursive routing, I will tell you in more detail in the second part. <br><br>  <b>Firewall (for this publication, I deliberately provide rules that allow everything.</b> <b><br></b>  <b>Do not do this!):</b> <br><pre> <code class="bash hljs">/ip firewall filter add action=accept chain=forward add action=accept chain=input add action=accept chain=output</code> </pre><br>  <b>dst and src nat:</b> <br><pre> <code class="bash hljs">/ip firewall nat add action=masquerade chain=srcnat out-interface-list=WAN add action=dst-nat chain=dstnat comment=<span class="hljs-string"><span class="hljs-string">"HTTP"</span></span> dst-port=80 \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface-list=WAN protocol=tcp to-addresses=192.168.0.83 to-ports=80 add action=dst-nat chain=dstnat comment=<span class="hljs-string"><span class="hljs-string">"HTTPs"</span></span> dst-port=443 \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface-list=WAN protocol=tcp to-addresses=192.168.0.83 to-ports=443</code> </pre><br>  <b>mangle</b> <br><pre> <code class="bash hljs">/ip firewall mangle add action=mark-connection chain=input <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 \ new-connection-mark=ISP1-conn passthrough=yes add action=mark-routing chain=output connection-mark=ISP1-conn \ new-routing-mark=ISP1-route passthrough=no add action=mark-connection chain=input <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 new-connection-mark=\ ISP2-conn passthrough=yes add action=mark-routing chain=output connection-mark=ISP2-conn \ new-routing-mark=ISP2-route passthrough=no add action=mark-connection chain=input <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP3 \ new-connection-mark=ISP3-conn passthrough=yes add action=mark-routing chain=output connection-mark=ISP3-conn \ new-routing-mark=ISP3-route passthrough=no add action=mark-connection chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 \ new-connection-mark=ISP1-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP1-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=bridge new-routing-mark=ISP1-route add action=mark-connection chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 \ new-connection-mark=ISP2-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP2-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=bridge new-routing-mark=ISP2-route add action=mark-connection chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP3 \ new-connection-mark=ISP3-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP3-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=bridge new-routing-mark=ISP3-route</code> </pre><br><h3>  Part 2. </h3><br>  Consider all the details. <br><br>  <b>Routing:</b> <br><div class="spoiler">  <b class="spoiler_title">look under the spoiler so as not to thumb</b> <div class="spoiler_text"><pre> <code class="bash hljs">/ip route add distance=1 gateway=95.11.29.254 routing-mark=ISP1-route add distance=1 gateway=5.35.59.161 routing-mark=ISP2-route add distance=1 gateway=5.98.112.29 routing-mark=ISP3-route add check-gateway=ping distance=1 gateway=8.8.8.8 add check-gateway=ping distance=2 gateway=8.8.4.4 add check-gateway=ping distance=3 gateway=1.1.36.3 add distance=1 dst-address=8.8.4.4/32 gateway=5.35.59.161 scope=10 add distance=1 dst-address=8.8.8.8/32 gateway=95.11.29.254 scope=10 add distance=1 dst-address=1.1.36.3/32 gateway=5.98.112.29 scope=10</code> </pre><br></div></div><br>  <b>/ ip route</b> <br>  In the first three lines we specify the default gateway of each of our 3 providers. <br>  Routes have the same weight ( <b>distance</b> ), but work in different routing tables. <br><br>  In other words, these routes work for packets marked with the appropriate tag ( <b>routing-mark</b> ).  We will hang tags to packages in <b>/ ip firewall mangle</b> (which I will like to describe below). <br><br>  The next 3 lines indicate the default routes in the main routing table. <br><br>  Here you should pay attention to: <br><br><ol><li>  Parameter <b>distance</b> .  For each route is different and, accordingly, the "weight" of the routes is also different. <br><br>  ISP1 is the main one, ISP2 and ISP3 close it, i.e.  if the ISP1 provider fails, we will work through ISP2, and if ISP2 is in Bose, ISP3 will take over. <br><br></li><li>  Somewhat incomprehensible may be the value of the <b>gateway</b> parameter.  How did this google DNS and some kind of left IP address suddenly become the default route?  The magic lies in the <b>scope</b> parameter of the last three lines, as well as in the Nexthop lookup mechanism itself. <br><br>  In fact, the traffic will go to the active provider, and then he will send it to the Internet through his uplinks. <br><br></li><li>  About the <b>check-gateway = ping</b> parameter.  The bottom line is that in the simplest scheme of building failover, specifying <b>check-gateway = ping</b> in the default routes, we only check the connection to the provider‚Äôs router.  If the Internet is not available behind the ISP‚Äôs router, we will not understand this.  And with the help of feint with the <b>scope</b> parameter, we check the connection no longer with the provider, but look for it, on the Internet. </li></ol><br>  Under the spoiler my detailed translation / adaptation of the Wiki MikroTik on this topic. <br><br><div class="spoiler">  <b class="spoiler_title">MikroTik.</b>  <b class="spoiler_title">Nexthop_lookup</b> <div class="spoiler_text">  English articles <a href="http://wiki.mikrotik.com/wiki/Manual:IP/Route">http://wiki.mikrotik.com/wiki/Manual:IP/Route</a> , in my opinion, slightly upturned.  This is not Cisco CCNA Exploration, which is read in one breath, but I will try to translate its <a href="http://wiki.mikrotik.com/wiki/Manual:IP/Route">passage</a> as clear as possible.  If you see the same uproarty somewhere, correct me, please. <br><br>  First, let's define some terms. <br>  <b>Nexthop</b> - the next jump, if literally.  The next gateway / router / router on the way of the packet from point A (from my router, for example) to point B (say to google DNS 8.8.8.8), i.e.  the next hop where the packet will be processed.  The translation will use the phrase ‚Äúnext hop‚Äù (sorry for anglicism). <br><br>  <b>Immediate nexthop</b> is the next gateway / router / router on the route of the packet from point A to point B, accessible directly.  For my home MikroTik, with the default route: <br><br><pre> <code class="hljs lua">dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">89.189</span></span><span class="hljs-number"><span class="hljs-number">.163</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=<span class="hljs-number"><span class="hljs-number">89.189</span></span><span class="hljs-number"><span class="hljs-number">.163</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> reachable via ether1-gateway</code> </pre> <br>  89.189.163.1 - this is immediate nexthop, since  It is available through ether1-gateway.  The translation will use the phrase ‚Äúimmediately accessible next hop‚Äù. <br><br>  <b>Connected route</b> - a connected route.  A route whose gateway is directly accessible. <br><br>  <b>Gateway</b> - network gateway / router / router. <br>  I will use all three translation options. <br><br>  <b>scope</b> - Used in the search engine for the next hop, i.e.  what kind of hop decisions will be next.  The desired route can be selected only among routes whose scope values ‚Äã‚Äãare less than or equal to the target-scope value.  The default values ‚Äã‚Äãdepend on the protocol: <br><br><ul><li>  related routes: 10 (if the interface is running (running)) </li><li>  OSPF, RIP, MME routes: 20 </li><li>  static routes: 30 </li><li>  BGP Routes: 40 </li><li>  associated routes: 200 (if the interface is not running) </li></ul><br>  <b>target-scope</b> - Used in the search engine for the next hop, i.e.  what kind of hop decisions will be next.  This is the maximum value of the scope parameter for the route by which the next hop can be found.  For iBGP, the value is set to 30 by default. <br><br>  Label the values ‚Äã‚Äãof both parameters. <br><br><img src="https://habrastorage.org/files/725/a46/8de/725a468deba641df9c53ba33528f5430.png"><br><br>  Search for the next hop. <br>  Finding the next hop is part of the route selection process. <br><br>  Routes in the <a href="https://en.wikipedia.org/wiki/Forwarding_information_base">FIB</a> need an interface corresponding to each of the gateway addresses.  The address of the next hop gateway must be directly accessible through this interface.  The interface that should be used to send an outgoing packet to each of the gateways is found by searching for the next hop. <br><br>  Some routes (for example, iBGP), as the gateway address, may have an address belonging to the router, located through several hop-gateways from our MikroTik.  To install such routes in the FIB, you must find the gateway address that is accessible directly (an immediate nexthop), i.e.  directly from us, which will be used to reach the gateway address on this route.  The immediate address of the next hop can also be found using the next hop search mechanism. <br><br>  The next hop is searched for only in the main main routing table, even for routes that have an excellent value for the routing-mark parameter.  This is necessary to limit the installation of routes that can be used to search for immediately accessible nexthops.  In routes for RIP or OSPF protocols, it is assumed that the next router is directly accessible and should be found using only connected routes. <br><br>  Routes with the interface name as a gateway are not used in the search for the next hop.  If there is a route with the name of the interface, as well as a route with an active IP address, then the route with the interface is ignored. <br><br>  Routes that have a <b>scope</b> greater than the maximum allowed value are not used in the search for the next hop.  Each route specifies the maximum allowable value for the <b>scope</b> parameter, for its next hop, in the <b>target-scope</b> parameter.  The default value for this parameter allows you to search for the next hop only through connected routes, except for iBGP routes that have a larger default value and can also search for the next hop via IGP and static routes. <br><br><img src="https://habrastorage.org/files/48d/162/1ab/48d1621ab1f84ebda182ba5c665c4288.png"><br><br>  The interface and the address of the next directly accessible router are selected based on the search results for the next hop: <br><br><ul><li>  If the most accurate active route that was found during the search for the next hop address is a linked route, then the interface of this linked route is used as the next hop interface and the gateway is marked as reachable.  After the router becomes directly accessible through this interface (this is what should be understood as a ‚Äúconnected route‚Äù or ‚Äúconnected route‚Äù), its address is used as the address of the immediately next router (immediate next) address. <br><br></li><li>  If the most accurate active route that was found during the search for the next hop address has the gateway address that was already detected, the immediately available hop and interface are copied from this route, and the gateway is marked as recursive. <br><br></li><li>  If the most accurate active route that was found during the search for the next hop address is the ECMP route, then the first available router of that route is used. <br><br></li><li>  If the search engine for the address of the next hop did not find a single route, then the gateway is marked as unreachable. </li></ul><br>  And now, as they say in KVN, why did I show this number.  Please note that we set <b>scope = 10</b> for static routes in the last three lines, thereby ‚Äúforcing‚Äù MikroTik to take these routes into account when searching for the next hop. <br><br>  It accepts, and thus routes by default through: <br><br><ul><li>  8.8.8.8 </li><li>  8.8.4.4 </li><li>  1.1.36.3 </li></ul><br>  become recursive, i.e.  directly available hop will be the gateways of the providers and the traffic we will send through them, but check-gateway = ping will check the availability of the addresses for the provider networks. <br><br>  I hope my translation and explanation will be useful to you. <br></div></div><br>  While the most eager to learn to read under the spoiler, tell a little shorter and simpler. <br>  When we specify <b>scope = 10</b> in the last three lines, we let MikroTik understand that: <br><br><ul><li>  8.8.8.8 </li><li>  8.8.4.4 </li><li>  1.1.36.3 </li></ul><br>  it is not accessed directly, but <i>recursively</i> through these static routes.  One IP per brother provider. <br><br>  <b>/ ip firewall mangle</b> <br><div class="spoiler">  <b class="spoiler_title">rules here</b> <div class="spoiler_text"><pre> <code class="bash hljs">/ip firewall mangle add action=mark-connection chain=input <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 \ new-connection-mark=ISP1-conn passthrough=yes add action=mark-routing chain=output connection-mark=ISP1-conn \ new-routing-mark=ISP1-route passthrough=no add action=mark-connection chain=input <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 new-connection-mark=\ ISP2-conn passthrough=yes add action=mark-routing chain=output connection-mark=ISP2-conn \ new-routing-mark=ISP2-route passthrough=no add action=mark-connection chain=input <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP3 \ new-connection-mark=ISP3-conn passthrough=yes add action=mark-routing chain=output connection-mark=ISP3-conn \ new-routing-mark=ISP3-route passthrough=no add action=mark-connection chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP1 \ new-connection-mark=ISP1-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP1-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=bridge new-routing-mark=ISP1-route add action=mark-connection chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP2 \ new-connection-mark=ISP2-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP2-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=bridge new-routing-mark=ISP2-route add action=mark-connection chain=forward <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=ISP3 \ new-connection-mark=ISP3-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> passthrough=no add action=mark-routing chain=prerouting connection-mark=ISP3-conn<span class="hljs-_"><span class="hljs-_">-f</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-interface=bridge new-routing-mark=ISP3-route</code> </pre><br></div></div><br>  To clarify the rules of this section, we will invite several assistants. <br><br><ol><li>  <b>MANGLE</b> - this table is intended for operations on the classification and labeling of packets and connections, as well as modification of packet headers (TTL and TOS fields) (wikibooks). <br><br>  The mangle table contains the following chains: <br><ol><li>  <b>PREROUTING</b> - allows you to modify a packet <i>before</i> making a routing decision. </li><li>  <b>INPUT</b> - allows you to modify the package intended for the host itself. </li><li>  <b>FORWARD</b> is a chain that allows modifying transit packets. </li><li>  <b>OUTPUT</b> - allows you to modify packets originating from the host itself. </li><li>  <b>POSTROUTING</b> - allows you to modify all outgoing packets, both generated by the host itself, and transit. </li></ol></li><li>  <b>CONNECTION TRACKING</b> is a special subsystem that monitors the state of connections and allows you to use this information when making decisions about the fate of individual packets. </li><li>  MikroTik <b>Packet flow</b> </li><li><img src="https://habrastorage.org/files/5cc/692/8fa/5cc6928fa4054f8db82746af33bb919c.png"></li></ol><br>  I broke the rules into groups, to facilitate their understanding.  In the first group of 6 rules that are responsible for traffic to / from the router itself, and in the second group of 6, for transit traffic. <br><br>  Nachem from the first two. <br>  In the first, we tell the router that all incoming <b>chain = input</b> connections on the ISP1 interface need to be labeled <b>action = mark-connection new-connection-mark = ISP1-conn</b> , and also we specify <b>passthrough = yes</b> so that the packet, after passing this rule, does not left the table and continued following the rules. <br><br>  In the second we tell MikroTik to catch the outgoing connections <b>chain = output</b> marked as <b>ISP1-conn</b> and assign them a routing label (to be placed in the corresponding routing table, do you remember the first three routes?), And also tell <b>passthrough = no</b> how saying, there‚Äôs nothing to do here for the package after this rule, i.e.  the package will leave the table. <br><br>  All of the above is true for both ISP2 and ISP3.  Thus, we have ensured that the router answers exactly from the interface to which the request comes to it. <br><br>  Go to the final six rules. <br>  It is already clear, they are also divided into subgroups of 2, for each of our ISPs. <br>  The first one instructs the router to monitor the <b>FORWARD</b> chain, and if a connection occurs through the ISP1 interface, it is marked <b>action = mark-connection with a</b> new tag <b>new-connection-mark = ISP1-conn-f</b> (note! <b>Different</b> from the traffic tag of the router itself, In this case, we mark transit traffic).  <b>passthrough = n</b> o, since  we do not want the packet, after getting into this rule, to be processed in the table somehow else. <br><br>  The second hangs the desired routing label <b>new-routing-mark = ISP1-route</b> in the <b>PREROUTING chain</b> , i.e.  Before making a decision on routing, and monitors the traffic that came to us from the local network <b>in-interface = bridge</b> . <br>  Here we are rescued by the <b>CONNECTION TRACKING</b> mechanism, which allows us to catch connections from the local network (from the WEB server) marked by the rule above and hang up the necessary routing tag. <br><br>  This allows transit traffic (here to / from the web server) to go exactly the way it came, i.e.  came through ISP1 - go through it. <br><br><h3>  Conclusion </h3><br>  I am very happy if my explanations are clear, but this work will be useful. <br>  Gone to meditate, good luck to all! <br><br>  <b>Thank you for attention!</b> </div><p>Source: <a href="https://habr.com/ru/post/313342/">https://habr.com/ru/post/313342/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313330/index.html">Binary (file) storage, a terrible tale with a gloomy end</a></li>
<li><a href="../313332/index.html">Hello everyone, I am a webmaster and I was hacked</a></li>
<li><a href="../313334/index.html">Code examples in 39 esoteric programming languages</a></li>
<li><a href="../313338/index.html">Programming & Music: Delay, Distortion and Parameter Modulation. Part 4</a></li>
<li><a href="../313340/index.html">Thematic modeling on the way to exploratory information search. Lecture in Yandex</a></li>
<li><a href="../313344/index.html">How to order and promote a mobile application: digest of useful materials</a></li>
<li><a href="../313346/index.html">Diary of a bug: how I repaired pictures in e-mail</a></li>
<li><a href="../313350/index.html">Lambda and anonymous classes: who eats more</a></li>
<li><a href="../313356/index.html">Add disk space for a Linux ‚Äì server in the Azure Pack Infrastructure cloud, and at the same time, we are working with LVM</a></li>
<li><a href="../313364/index.html">Experience in building and operating large file storage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>