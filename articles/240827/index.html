<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Accident Alert Info Panel Project (Part 3)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all. 
 This is the third part of a rather long history ( one , two ). 
 The device is not yet complete, although almost all the main bloc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Accident Alert Info Panel Project (Part 3)</h1><div class="post__text post__text-html js-mediator-article">  Greetings to all. <br>  This is the third part of a rather long history ( <a href="http://habrahabr.ru/post/210418/">one</a> , <a href="http://habrahabr.ru/post/218859/">two</a> ). <br>  The device is not yet complete, although almost all the main blocks are currently assembled: <br>  - Indicators (2); <br>  - Processor module (in this part); <br>  - Power supply (pulse converter 48V -&gt; 5V to 6A) (in the process, pause due to the finally breaking probes to the oscilloscope (keTai)); <br><br>  Action plan: <br>  [+] SD-Card-Sector <br>  [+] FAT-FS <br>  [+&gt;] OneWire async <br>  [-] Slave firmware <br>  [part] Ethernet <br>  [-] Interprocessor exchange protocol <br>  [-] Bootloader <br><br>  Carefully photo. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Processor board has changed: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  V.1: <br><img src="https://habrastorage.org/files/03c/8b4/c59/03c8b4c5997242998d5b95234ab4a8cd.jpg"><br>  Disassembled, moved to the next. <br>  V.2: <br><img src="https://habrastorage.org/files/fa1/4b2/fc9/fa14b2fc9470454e825cfb4d306c2968.jpg"></div></div><br>  In the first variant, it was not possible to dilute the PORTA of the main controller, in variant 2 it was corrected - brought to the full comb.  It is possible to use both additional periphery and as a DAC (if you can get the audio playback from UDP packets to work without failures). <br>  Modular periphery.  Provided on the board: <br>  - DS18B20 temperature sensor (or any other OneWire devices); <br>  - Clock DS1307; <br>  - Hardware console (TTL levels, 115200, N, 1); <br>  - Piezo emitter (squeaker, connector); <br>  - Status module (plug); <br>  Type of module: It would be very good to make mini-windows for it so that the diodes do not light up the "neighbors". <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/84d/923/82e/84d92382eee04e0a8afc7981ccdd153b.jpg"></div></div><br>  The screen control processor has got an additional connector for connecting external indicators (a clock, just a clock) without additional power - they will take it directly from the power supply unit. <br><br>  The code is not yet compiled.  I am engaged in the hardware (at the moment - indicators: <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/bd0/5c7/e9c/bd05c7e9c3e644a68f5e4554ac517729.jpg"></div></div><br>  Dynamic indication, transistor row and column drivers, a duty cycle of 8 for each row.  Schemes and models of boards will be later. <br><br>  FAT: Partial database - use the library from ‚Äú <a href="http://www.roland-riegel.de/">www.roland-riegel.de</a> ‚Äù (the <a href="http://www.roland-riegel.de/sd-reader/index.html">library page</a> ).  I want to write myself, so the files, although distributed under the GPL license, are used as an example. <br>  Miraculously earned the function of reading / writing from / to the SD card / y.  Initialization proceeds normally, the map is determined, but zeroes are returned when reading.  There was a strange crutch when requesting a read / write sector - you need to add a constant to the absolute address.  For ordinary maps, the formula is: Calculated_Address = (Required_Sector + 249) * 512. For SDHC, you have to add 2048. <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre><code class="hljs ruby">uint8_t SPI_SD_READ_SECTOR(uint32_t Sector) { uint16_t i; uint32_t calc_Addr; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Sector == raw_block_buffered) /<span class="hljs-regexp"><span class="hljs-regexp">/        { return R_OK; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  .    ,    . }; SPI_Select_CARD(); if (!(sd_raw_card_type &amp; (1 &lt;&lt; SD_RAW_SPEC_SDHC))) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     SDHC -  9   . { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ !SDHC calc_Addr = ((Sector+249) &lt;&lt; 9); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ DaFaq?! But will not work in other case. } else { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ SDHC calc_Addr = (Sector+2048); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ And one more DAFAQ! }; i = SPI_SD_SendCMD(CMD_READ_SINGLE_BLOCK, calc_Addr); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     if(i) { SPI_UnSelect_CARD(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   return R_ERR; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  . =( }; while (SPI_SD_Rd_Byte() != 0xFE); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   .    30-40 . for (i=0; i&lt;512; i++) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        (512 ) { raw_block[i] = SPI_SD_Rd_Byte(); }; SPI_SD_Rd_Byte(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ CRC SPI_SD_Rd_Byte(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ CRC (2) /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ IGNORED T_T /</span></span>* deaddress card *<span class="hljs-regexp"><span class="hljs-regexp">/ SPI_UnSelect_CARD(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   () SPI_SD_Rd_Byte(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ . raw_block_buffered = Sector; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  ,  . return R_OK; };</span></span></code> </pre> </div></div><br>  Tested cards: <br>  Transcend MicroSD 1GB / Taiwan / (I C1210000 924) <br>  Transcend MicroSD 2GB / Taiwan / (8281AB 2G 01DS1) <br>  Samsung MicroSDHC 8GB Class 2 / Taiwan / (C FJCB85PZ T15) <br>  Kingston MicroSCHC 16GB Class 10 / Taiwan / (TM2I121100200) <br><br>  The observed strange behavior of the cards is reproduced. <br><br>  <b>Question to readers:</b> Has anyone encountered a similar experience with AVR * with SD cards? <br><br>  There is a difficulty with the Ethernet module - the module itself works, but you cannot connect it to the network with the presence of active PoE power.  A direct <a href="http://www.roland-riegel.de/sd-reader/index.html">link</a> to the datasheet of transformers used in Arduino-compatible Ethernet modules - all 4 pairs of them have a midpoint pulled up to a common point inside the circuit with 75 Ohm resistors (it‚Äôs logical that these are linear terminators).  With such a connection, only two options are possible - either the power supply goes into protection or the socket burns out.  Both are unpleasant. <br>  Now I am making an Ethernet board (in fact, I am reworking the Arduino-ENC28J60 module I purchased to a new board).  The module turned out to be 71 * 33mm (for comparison, the module from the Arduino is 55 * 35mm). <br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  Typical scheme from the <a href="http://elecfreaks.com/store/download/ENC28J60SS.pdf">description</a> to the module. <br><img src="https://habrastorage.org/files/36f/ca9/cb1/36fca9cb11a54a9a96a803e0284a65a2.png"><br>  The divorced board (the transformer from some device found in the office basket, the M-TEK G24102MKG, is very badly googled). <br><img src="https://habrastorage.org/files/d79/95b/a9d/d7995ba9dfe74364a988254db23e0875.png"><br>  Fee assembly.  The transformer was broken.  But, since  in the discarded donor device, only the first pairs were used, he earned in ... this form. <br><img src="https://habrastorage.org/files/367/472/0bb/3674720bbd104ecf8f8a64e057c8de6f.jpg"><br></div></div><br>  Boards do without metallization of the holes, jumpers on the next layer. <br><br>  Recently, the asynchronous library for OneWire has been more or less debugged.  It is not yet fully written, there are no interfaces and other things, it reads the previously designated number of bytes.  It is necessary to alter a few objects to simplify working with it. </div><p>Source: <a href="https://habr.com/ru/post/240827/">https://habr.com/ru/post/240827/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240815/index.html">"Purple" I2P - a window into the world of C ++ applications</a></li>
<li><a href="../240817/index.html">Using Accept Header for API Versioning</a></li>
<li><a href="../240819/index.html">Javascript equalizer</a></li>
<li><a href="../240823/index.html">Odroid W, or giblets raspberry pie</a></li>
<li><a href="../240825/index.html">Information for customers or for the protection of programmers</a></li>
<li><a href="../240829/index.html">Performance testing popular (and not so) CMS</a></li>
<li><a href="../240831/index.html">Amateur and back-engineering. Part 2: Frame</a></li>
<li><a href="../240833/index.html">The digest of interesting materials for the mobile developer # 75 (on October 13-19)</a></li>
<li><a href="../240835/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ18 (October 13 - 19, 2014)</a></li>
<li><a href="../240839/index.html">Passion around systemd and using it by default in Debian</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>