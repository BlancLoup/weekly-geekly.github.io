<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQUID for the lazy. Make life easier</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good afternoon, dear Habrapho users, in connection with the current tendency to study the well-known proxy server SQUID, I would like to suggest a var...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQUID for the lazy. Make life easier</h1><div class="post__text post__text-html js-mediator-article">  Good afternoon, dear Habrapho users, in connection with the current tendency to study the well-known proxy server SQUID, I would like to suggest a variant of some typical configuration of a small bundle that will be useful for novice system administrators of small offices, or just for those who are too lazy to understand.  This article in no way claims to be a global manual for all occasions - as I have already said, this is just a generalized special case. <br><a name="habracut"></a><br>  Well, let's discuss where we start, we have a server in my case, this is a freshly installed Ubuntu Server with the selected LAMP and SSH parameters (specifically for the purpose of writing this article): <br><br><pre>  root @ testgateway: ~ # uname -a
 Linux testgateway 2.6.32-33-generic-pae # 70-Ubuntu SMP Thu Jul 7 22:51:12 UTC 2011 i686 GNU / Linux

 root @ testgateway: ~ # lsb_release -a
 Distributor ID: Ubuntu
 Description: Ubuntu 10.04.3 LTS
 Release: 10.04
 Codename: lucid

 root @ testgateway: ~ # df -h
 Filesystem Size Used Avail Use% Mounted on
 / dev / sda6 5.5G 723M 4.6G 14% /
 none 190M 172K 189M 1% / dev
 none 194M 0 194M 0% / dev / shm
 none 194M 44K 194M 1% / var / run
 none 194M 0 194M 0% / var / lock
 none 194M 0 194M 0% / lib / init / rw
 / dev / sda7 7.3G 189M 6.7G 3% / var
 / dev / sda1 92M 21M 66M 25% / boot
</pre><br>  But with these parameters, I deliberately prepared 2 network interfaces, do not be surprised that both interfaces are from local ranges, just the machine is installed inside xen. <br><br><pre>  root @ testgateway: ~ # ifconfig
 eth0 Link encap: Ethernet HWaddr 00: 16: 36: 73: 84: 48  
           inet addr: 192.168.0.237 Bcast: 192.168.0.255 Mask: 255.255.255.0
           inet6 addr: fe80 :: 216: 36ff: fe73: 8448/64 Scope: Link
           UP BROADCAST RUNNING MULTICAST MTU: 1500 Metric: 1
           RX packets: 1361 errors: 0 dropped: 0 overruns: 0 frame: 0
           TX packets: 720 errors: 0 dropped: 0 overruns: 0 carrier: 0
           collisions: 0 txqueuelen: 1000 
           RX bytes: 111090 (111.0 KB) TX bytes: 107285 (107.2 KB)
           Interrupt: 32 Base address: 0xa000 

 eth1 Link encap: Ethernet HWaddr 00: 16: 36: 64: 1c: bd  
           inet addr: 192.168.122.51 Bcast: 192.168.122.255 Mask: 255.255.255.0
           inet6 addr: fe80 :: 216: 36ff: fe64: 1cbd / 64 Scope: Link
           UP BROADCAST RUNNING MULTICAST MTU: 1500 Metric: 1
           RX packets: 68 errors: 0 dropped: 0 overruns: 0 frame: 0
           TX packets: 82 errors: 0 dropped: 0 overruns: 0 carrier: 0
           collisions: 0 txqueuelen: 1000 
           RX bytes: 8170 (8.1 KB) TX bytes: 10923 (10.9 KB)
           Interrupt: 36 Base address: 0xe100 

 lo Link encap: Local Loopback  
           inet addr: 127.0.0.1 Mask: 255.0.0.0
           inet6 addr: :: 1/128 Scope: Host
           UP LOOPBACK RUNNING MTU: 16436 Metric: 1
           RX packets: 0 errors: 0 dropped: 0 overruns: 0 frame: 0
           TX packets: 0 errors: 0 dropped: 0 overruns: 0 carrier: 0
           collisions: 0 txqueuelen: 0 
           RX bytes: 0 (0.0 B) TX bytes: 0 (0.0 B)
</pre><br>  Here the Internet will go from eth1, local network, i.e.  I will be on the eth0 side. <br>  It is naturally recommended to hold: <br><pre> root @ testgateway: ~ # apt-get update
 root @ testgateway: ~ # apt-get upgrade
</pre><br>  The next step is to install additional packages for our proxy server, as you probably guessed, we will use the SQUID + SAMS bundle, but we will configure a typical case, IP authorization, and to facilitate our lives, turn all users to the proxy port.  This bundle can then be easily configured to authorize by login / password, and even associate with AD. <br>  We will install the necessary packages for our case as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre>  root @ testgateway: ~ # apt-get install libpcre3 libpcre3-dev libmysqlclient15-dev php5-ldap php-fpdf squid squidguard gcc make php5-gd
</pre><br>  If suddenly it is not enough yet.  The next step will be downloading and installing SAMS itself, downloading the stable version 1.0.5, there is still SAMS 2.0, but somehow I tried, there were still too many bugs. <br><pre> root @ testgateway: ~ # wget http://sams.perm.ru/download/sams-1.0.5.tar.bz2
</pre><br>  Next, unpack and install it: <br><pre> root @ testgateway: ~ # bunzip2 sams-1.0.5.tar.bz2 &amp;&amp; tar -xpf sams-1.0.5.tar &amp;&amp; rm sams-1.0.5.tar
 root @ testgateway: ~ # cd sams-1.0.5 /
 root @ testgateway: ~ # ./configure - -with-httpd-locations = / var / www
 root @ testgateway: ~ # make
 root @ testgateway: ~ # make install
</pre><br>  After that, in principle, there should be no errors, and you can safely continue, if there are any errors, then you should read it carefully, and install what is missing. <br>  Next, copy the sams startup script to our server <br><br><pre>  root @ testgateway: ~ / sams-1.0.5 # cp ./etc/sams.debian /etc/init.d/samsd
 root @ testgateway: ~ / sams-1.0.5 # update-rc.d samsd defaults
  Adding system startup for /etc/init.d/samsd ...
    /etc/rc0.d/K20samsd -&gt; ../init.d/samsd
    /etc/rc1.d/K20samsd -&gt; ../init.d/samsd
    /etc/rc6.d/K20samsd -&gt; ../init.d/samsd
    /etc/rc2.d/S20samsd -&gt; ../init.d/samsd
    /etc/rc3.d/S20samsd -&gt; ../init.d/samsd
    /etc/rc4.d/S20samsd -&gt; ../init.d/samsd
    /etc/rc5.d/S20samsd -&gt; ../init.d/samsd
</pre><br>  Next, let's tweak MySQL slightly.  You need to load the tables and organize access to them: <br><br><pre>  root @ testgateway: ~ / sams-1.0.5 # mysql -u root -p
 Enter password: 
 Welcome to the MySQL monitor.  Commands end with;  or \ g.
 Your MySQL connection id is 39
 Server version: 5.1.41-3ubuntu12.10 (Ubuntu)

 Type 'help;'  or '\ h' for help.  Type '\ c' to clear the current input statement.

 mysql&gt; GRANT ALL ON squidctrl. * TO sams @ localhost IDENTIFIED BY "maxim";
 Query OK, 0 rows affected (0.02 sec)

 mysql&gt; GRANT ALL ON squidlog. * TO sams @ localhost IDENTIFIED BY "maxim";
 Query OK, 0 rows affected (0.00 sec)

 mysql&gt; flush privileges;
 mysql&gt; exit

 root @ testgateway: ~ / sams-1.0.5 # cd ./mysql
 root @ testgateway: ~ / sams-1.0.5 / mysql # mysql -u root -p &lt;sams_db.sql 
 root @ testgateway: ~ / sams-1.0.5 / mysql # mysql -u root -p &lt;squid_db.sql 
</pre><br>  Next, edit the file a bit, /etc/sams.conf: <br>  MYSQLPASSWORD = maxim <br><br>  I hope everyone guessed that this is the password that we inserted into the Mysql commands. <br>  Finally, the turn has come and the settings of the SQUID itself, but do not think that it will be very difficult, get ready that in the future SAMS will do all the dirty work for you. <br>  Open the configuration file, and change there a few lines: <br><pre> # Squid normally listens to port 3128
 http_port 192.168.0.237Â§©128 transparent

 maximum_object_size_in_memory 50 MB

 cache_dir ufs / var / spool / squid 3000 32 512
 Cache parameters are selected individually for each case.

 maximum_object_size 50 MB

 url_rewrite_program / usr / local / bin / samsredir
</pre><br>  Now we set up access.log processing <br>  Open crontab, it‚Äôs better to do this with crontab -e, and add the following line there: <br>  * / 1 * * * * / usr / local / bin / sams <br><br>  Next, create directories for the Squid cache: <br>  root @ testgateway: ~ / sams-1.0.5 / mysql # squid -z <br>  2011/10/13 12: 40: 12 |  Creating Swap Directories <br><br>  and start squid. <br>  root @ testgateway: ~ / sams-1.0.5 / mysql # /etc/init.d/squid start <br><br>  Checking: <br><pre>  root @ testgateway: ~ / sams-1.0.5 / mysql # ps aux |  grep proxy
 proxy 19158 0.2 1.2 7696 4876?  Ss 12:40 0:00 / usr / sbin / squid -N -D
 proxy 19159 0.0 0.4 5080 1636?  Ss 12:40 0:00 (samsredir)
 proxy 19160 0.0 0.4 5080 1640?  Ss 12:40 0:00 (samsredir)
 proxy 19161 0.0 0.4 5080 1636?  Ss 12:40 0:00 (samsredir)
 proxy 19162 0.0 0.4 5080 1636?  Ss 12:40 0:00 (samsredir)
 proxy 19163 0.0 0.4 5080 1640?  Ss 12:40 0:00 (samsredir)
 proxy 19164 0.0 0.0 1616 316?  Ss 12:40 0:00 (unlinkd)
</pre><br>  If the picture is identical, then it all started well. <br>  Next we go to configure our SAMS, this is already done through the web interface, we type in the browser address of our proxy, we had it 192.168.0.237/sams, and we see an invitation page for entering both a user and a password. <br>  But before we do this, we need to fix a small bug of this system, namely due to the release of PHP5.3, the settings pages are displayed a little incorrectly, or rather, they are not displayed at all.  But this operation is not complicated, just edit two files: <br>  /usr/local/share/sams/src/configtray.php <br>  /usr/local/share/sams/src/webconfigtray.php <br>  We rename GetHostName into GetHostNameSams and it all worked. <br>  Next, I will use the example of small screenshots to show what and where you need to edit, so that everything works as we need.  Invitation, default login: Admin, password: qwerty <br><br><img src="http://img213.imageshack.us/img213/2157/40365055.png" alt="image"><br><br>  The next step, setting up the web interface, set the following parameters: <br><br><img src="http://img3.imageshack.us/img3/6722/47530631.png" alt="image"><br><br>  The SAMS administration window does not fit the width of the screen, so I will describe with text, authorization, set the IP, request redirection file <a href="">192.168.0.237/sams/icon/classic/blank.gif</a> , path to the directory where the request ban files are <a href="http://192.168.0.237/sams/messages">192.168.0.237/sams/messages</a> , the redirector built SAMS, and the last to save data on traffic in the database for the last 12 months. <br>  Next, we proceed to setting up the templates, delete everything so that nothing prevents us and create a new one. <br><br><img src="http://img705.imageshack.us/img705/1323/39464936.png" alt="image"><br><br>  Next we add the user and associate it with our template. <br><br><img src="http://img841.imageshack.us/img841/9872/35734411.png" alt="image"><br><br>  Next, run the samsd daemon: /etc/init.d/samsd start.  And reconfigure SQUID. <br>  After that, if the user enters a proxy in the browser, everything starts to work fine, but since it is not convenient for us to do this for all users, so apply the classic admin trick, turning HTTP traffic to the proxy port of the server. <br><br>  iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 3128 <br><br>  This is how we got a proxy, with a user-friendly web interface, maybe someone will accuse me of plagiarism, they say it was all 100 times, but I just want to note that, as I said at the very beginning of the article, this proxy setting option for the lazy, because  almost all SQUID goodies, such as traffic restrictions, creation of access lists, allowed domains, a ban on downloading, can be obtained from the web settings.  And also we easily get a system for viewing statistics, which can be used by any user of your organization by accessing the page under your login.  Of course, there remains the difficulty with regard to the traffic of torrents, mail and another non-80 port, and this too has its own solution, which will fit very well into the big picture. <br>  If questions will be formed, you are welcome, we will discuss all the other subtleties of customization </div><p>Source: <a href="https://habr.com/ru/post/130335/">https://habr.com/ru/post/130335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130329/index.html">GDD 2011: Developer Impressions</a></li>
<li><a href="../130330/index.html">Unix-way reminder</a></li>
<li><a href="../130332/index.html">Google+ is the best example that Google doesn't understand the Platform.</a></li>
<li><a href="../130333/index.html">You are out of the office \ home needed the Internet. Wi-Fi search found unfamiliar open network.</a></li>
<li><a href="../130334/index.html">Google Chrome Extension Habrahabr.ru-Tools-PATCHED</a></li>
<li><a href="../130338/index.html">Organization of technical support work on LeaderTask</a></li>
<li><a href="../130339/index.html">Numberama. Reviving your favorite game on iOS</a></li>
<li><a href="../130341/index.html">Yandex can not find a song about Putin</a></li>
<li><a href="../130342/index.html">The results of the action with Groupon. Practical experience</a></li>
<li><a href="../130343/index.html">Acer Aspire 7560G: an impressive desktop with a new-generation AMD quad-core processor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>