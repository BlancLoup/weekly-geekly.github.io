<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Comparative load testing of Lua-connectors for Tarantool from NGINX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, on Habr√©, there are quite a few articles about Tarantool - a database and application server, which is used in Mail.Ru Group, Avito, Yota in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Comparative load testing of Lua-connectors for Tarantool from NGINX</h1><div class="post__text post__text-html js-mediator-article">  Recently, on Habr√©, there are quite a few articles about <a href="https://tarantool.org/">Tarantool</a> - a database and application server, which is used in Mail.Ru Group, Avito, Yota in various interesting projects.  And so, I thought - and why are we worse?  Let's try too. <br><br>  By virtue of my professional deformation I will consider the following case: <br><br><ul><li>  There is a Web-resource, access to which we want to restrict; </li><li>  The resource itself cannot be changed or is highly undesirable. </li></ul><br>  How to approach this task? <br><a name="habracut"></a><br>  Let's put in front of the resource a gateway that will check the rights of users, and depending on the results of the test, allow or not allow the user to the resource.  User access rights will be stored in Tarantool.  It has master-master replication, and if we need to build a cluster of gateways, it will come in handy.  As a basis for the gateway, we will use NGINX (well, don‚Äôt write the Web server itself ...). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is necessary to add ‚Äúintelligence‚Äù to NGINX so that it understands where the user can go, and where it is impossible.  For this one could use <a href="http_auth_request_module.html">ngx_http_auth_request_module</a> , but it is not clear how to combine this with Tarantool.  Let's follow the example of OpenResty, and use it to intellectualize our Lua gateway, namely <a href="https://github.com/openresty/lua-nginx-module">lua-nginx-module</a> . <br><br>  To access Tarantool from within NGINX, we need the appropriate driver, or ‚Äúconnector‚Äù for the selected language.  The authors themselves Tarantool write that if you needed to have a connector to Tarantool from Lua - then you have something wrong with the architecture.  But in the case of the NGINX + Lua bundle, this can be justified. <br><br>  Googling shows that there are already three candidates in nature: <br><br><ul><li>  <a href="https://github.com/ziontab/lua-nginx-tarantool">github.com/ziontab/lua-nginx-tarantool</a> - Implemented on nginx cosockets.  The truth has not been updated for a long time. </li><li>  <a href="https://github.com/tarantool/tarantool-lua">github.com/tarantool/tarantool-lua</a> - the official driver from the Tarantool developers.  It is a modified fork of the first candidate.  In addition to nginx cosockets supports ordinary Lua sockets. </li><li>  <a href="https://github.com/perusio/lua-resty-tarantool">github.com/perusio/lua-resty-tarantool</a> - For two years now without commits, there is no support for the semantics of calls to Tarantool 1.7 procedures. </li></ul><br>  What to choose?  Need to test.  That and do. <br><br><h3>  Test bench: </h3><br><img src="https://habrastorage.org/web/459/351/610/4593516108d948a398c1817cd5b3ebf5.png"><br><br>  From the load generator, requests are transmitted to the gateway in a protected TLS form (do not forget about the prof. Deformation).  Next, NGINX removes TLS, and sends them to the protected resource in the form of regular HTTP. <br><br><h3>  Characteristics of test machines </h3><br><h4>  Load machine and protected resource </h4><br>  (two identical cars) <br><table><tbody><tr><td>  CPU </td><td>  2xIntel Xeon E5 2680 @ 2.70GHz Sandy Bridge-EP / EX 32nm Technology 8 Cores / 16 threads </td></tr><tr><td>  Ram </td><td>  32.0GB DDR3 @ 799MHz (11-11-11-28) </td></tr><tr><td>  MB </td><td>  Supermicro X9DR3-F </td></tr><tr><td>  Disk </td><td>  223GB OCZ-VERTEX3 (SSD) </td></tr><tr><td>  OS </td><td>  Debian 8.9 x64 (kernel 3.16.39-1) </td></tr><tr><td>  Nginx </td><td>  1.12.1 </td></tr><tr><td>  wrk </td><td>  4.0.2-dirty [epoll] + GOST TLS patches </td></tr></tbody></table><h4>  Gateway </h4><table><tbody><tr><td>  CPU </td><td>  1 vCPU </td></tr><tr><td>  Ram </td><td>  8 Gb </td></tr><tr><td>  Platform </td><td>  VMWare Workstation 12.5 </td></tr><tr><td>  Host CPU </td><td>  Intel Core i5 7600K 3.8 GHz </td></tr><tr><td>  Host ram </td><td>  16 Gb </td></tr><tr><td>  Host os </td><td>  Windows 10 x64 </td></tr><tr><td>  Nginx </td><td>  1.12.1 </td></tr><tr><td>  lua-nginx-module </td><td>  Latest master branch </td></tr></tbody></table><br><h4>  Config NGINX protected resource </h4><br>  Nothing out of the ordinary - just an empty gif. <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> nginx; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/ngate/nginx/error.log <span class="hljs-literal"><span class="hljs-literal">warn</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-attribute"><span class="hljs-attribute">worker_rlimit_nofile</span></span> <span class="hljs-number"><span class="hljs-number">65535</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">8192</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/ngate/nginx/access.log main; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> fast-ipsec2-db8; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html index.htm; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> = /ff/empty_gif.gif { empty_gif; } } <span class="hljs-comment"><span class="hljs-comment"># end server }</span></span></code> </pre> <br><h4>  NGINX gateway config: </h4><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx/error.log <span class="hljs-literal"><span class="hljs-literal">warn</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">worker_rlimit_nofile</span></span> <span class="hljs-number"><span class="hljs-number">65535</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">8192</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/opt/nginx/mime.types; <span class="hljs-attribute"><span class="hljs-attribute">default_type</span></span> text/html; <span class="hljs-attribute"><span class="hljs-attribute">sendfile</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">65</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">autoindex</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_tokens</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">lua_package_path</span></span> <span class="hljs-string"><span class="hljs-string">'?.lua;/opt/lua/?.lua;'</span></span>; <span class="hljs-comment"><span class="hljs-comment"># HTTPS server server { listen 443 ssl; server_name perf-test-1; ssl_certificate www.example.com.crt; ssl_certificate_key www.example.com.key; ssl_protocols TLSv1; ssl_ciphers HIGH:!aNULL:!MD5; if ($request_method !~ ^(GET|HEAD|POST)$ ) { return 444; } # Local Tarantool Node set $ng_local_tnt_addr '127.0.0.1'; set $ng_local_tnt_port 3320; # ff location /ff/ { proxy_pass http://fast-ipsec2-db8/ff/; access_by_lua_file /opt/lua/res_access.lua; } } # end server perf-test-1 } # end http</span></span></code> </pre> <br>  Pay attention to the line: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">access_by_lua_file</span></span> /opt/lua/res_access.lua;</code> </pre> <br>  this is where we check user rights. <br><br><h4>  Code /opt/lua/res_access.lua </h4><br>  It's simple: <br><br>  1. Extract the authorization cookie; <br>  2. Parsim request to understand which resource the user is accessing; <br>  3. We transfer the obtained values ‚Äã‚Äãof Tarantool so that it makes a decision whether to let the user or not. <br>  4. We process the answer Tarantool <br>  5. Depending on the answer, let the user go, or say ‚ÄúAccess Denied‚Äù. <br>  For simplicity, we will leave work with access rights outside the article, and we will always let the user access the resource. <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> auth_cookie_value = ngx.var.cookie_nginxauth <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> auth_cookie_value == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ngx.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(ngx.WARN, <span class="hljs-string"><span class="hljs-string">"Authentication cookie not provided."</span></span>) ngx.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(ngx.HTTP_NOT_FOUND) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> uri_root_regex = <span class="hljs-string"><span class="hljs-string">"(\\/[a-zA-Z0-9\\-\\._]+\\/)"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> m, err = ngx.re.<span class="hljs-built_in"><span class="hljs-built_in">match</span></span>(ngx.var.uri, uri_root_regex, <span class="hljs-string"><span class="hljs-string">"ai"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ngx.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(ngx.ERR, <span class="hljs-string"><span class="hljs-string">"Error in regexp: "</span></span>, err) ngx.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(ngx.HTTP_NOT_FOUND) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> m == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ngx.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(ngx.ERR, <span class="hljs-string"><span class="hljs-string">"Regexp returned nil value."</span></span>) ngx.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(ngx.HTTP_NOT_FOUND) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> uri_root = m[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> uri_root == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ngx.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(ngx.ERR, <span class="hljs-string"><span class="hljs-string">"error in regexp"</span></span>) ngx.<span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(ngx.HTTP_NOT_FOUND) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tnt = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">'resty.tarantool'</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tnt = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">'tarantool-lua.tarantool'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tar, err = tnt:new({ host = ngx.var.ng_local_tnt_addr, port = ngx.var.ng_local_tnt_port, <span class="hljs-comment"><span class="hljs-comment">--Default value 2000 socket_timeout = 500, # connect_now = false, }) if not tar:connect() then ngx.log(ngx.ERR, "TNT connection failed.") ngx.exit(ngx.HTTP_NOT_FOUND) end local res, err = tar:call('check_access', {auth_cookie_value, uri_root}) if not tar:set_keepalive() then ngx.log(ngx.WARN, "TNT connection not set as keep-alive.") end if not res then ngx.log(ngx.ERR, "TNT call failed: " .. err) ngx.exit(ngx.HTTP_NOT_FOUND) end if res[1] ~= nil and res[1][1] == true then -- Access granted ngx.log(ngx.INFO, "Resource access granted: " .. uri_root) return else ngx.log(ngx.ERR, "Resource access denied: " .. uri_root) ngx.exit(ngx.HTTP_FORBIDDEN) end</span></span></code> </pre><br><h4>  Tarantool stored procedure code </h4><br>  Since we still ignore the authorization cookie, for simplicity we will not consider the process of its receipt and formation. <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> strict = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'strict'</span></span>) strict.on() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check_access</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session_id, resource_name)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> session_id == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> resource_name == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.info(<span class="hljs-string"><span class="hljs-string">'Access to resource '</span></span> .. resource_name .. <span class="hljs-string"><span class="hljs-string">' granted.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h3>  Testing method </h3><br>  For testing, we will use the wrk utility.  It has worked well in load testing and, in addition to TLS, supports Lua scripts (although we will not use them now).  Of the features, wrk does not have a disconnected TLS Session Resumption, so the gateway's CPU will not be spent on permanent TLS handshakes.  In order to check the performance of access permissions per second, and not throughput, we will request a file of the minimum size from the protected resource - an empty GIF that occupies 43 bytes. <br><br>  Let's start testing. <br><br><h4>  Candidate 1 (lua-nginx-tarantool): </h4><br>  Does not work at all.  If you use it according to the documentation, then <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tnt = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span> <span class="hljs-string"><span class="hljs-string">'lua-nginx-tarantool.tarantool'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tar, err = tnt:new({...})</code> </pre><br>  An error: <br><br><pre> <code class="hljs pgsql">runtime error: /opt/lua/res_access.lua:<span class="hljs-number"><span class="hljs-number">33</span></span>: attempt <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-string"><span class="hljs-string">'tnt'</span></span> (a <span class="hljs-type"><span class="hljs-type">boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)</code> </pre><br>  We will not understand. <br><br><h4>  Candidate 2 (tarantool-lua): </h4><br><pre> <code class="hljs ruby">./wrk -t32 -c32 -d30s --latency --timeout <span class="hljs-number"><span class="hljs-number">10</span></span>s -H <span class="hljs-string"><span class="hljs-string">"Host: perf-test-1"</span></span> -H <span class="hljs-string"><span class="hljs-string">"Cookie: nginxauth=XXX "</span></span> <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/192.168.85.159/ff</span></span><span class="hljs-regexp"><span class="hljs-regexp">/empty_gif.gif Thread Stats Avg Stdev Max +/</span></span>- Stdev Latency <span class="hljs-number"><span class="hljs-number">252.12</span></span>ms <span class="hljs-number"><span class="hljs-number">248.32</span></span>ms <span class="hljs-number"><span class="hljs-number">514.22</span></span>ms <span class="hljs-number"><span class="hljs-number">31.13</span></span>% Req/Sec <span class="hljs-number"><span class="hljs-number">4.55</span></span> <span class="hljs-number"><span class="hljs-number">5.54</span></span> <span class="hljs-number"><span class="hljs-number">60.00</span></span> <span class="hljs-number"><span class="hljs-number">95.77</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">21.75</span></span>ms <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">502.22</span></span>ms <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">503.61</span></span>ms <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">507.63</span></span>ms <span class="hljs-number"><span class="hljs-number">3767</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">30.04</span></span>s, <span class="hljs-number"><span class="hljs-number">1.33</span></span>MB read Non-<span class="hljs-number"><span class="hljs-number">2</span></span>xx <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>xx <span class="hljs-symbol"><span class="hljs-symbol">responses:</span></span> <span class="hljs-number"><span class="hljs-number">1868</span></span> Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">125.40</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">45.49</span></span>KB</code> </pre> <br>  First - a little.  Only 125 requests per second. <br><br>  Secondly - more than half of the answers - not the expected 200, but something else.  What is this?  The answer is in error_log NGIXN: <br><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[error]</span></span> 11856<span class="hljs-selector-id"><span class="hljs-selector-id">#0</span></span>: *23410 <span class="hljs-selector-attr"><span class="hljs-selector-attr">[lua]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">res_access</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lua</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:42</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">TNT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">connection</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">failed</span></span>.</code> </pre> <br>  Something goes wrong - either Tarantool rejects the connections, or NGINX cannot digest them. <br>  But let's try further. <br><br><h4>  Candidate 3 (lua-resty-tarantool): </h4><br><pre> <code class="hljs ruby">./wrk -t32 -c32 -d30s --latency --timeout <span class="hljs-number"><span class="hljs-number">10</span></span>s -H <span class="hljs-string"><span class="hljs-string">"Host: perf-test-1"</span></span> -H <span class="hljs-string"><span class="hljs-string">"Cookie: nginxauth=XXX "</span></span> <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/192.168.85.159/ff</span></span><span class="hljs-regexp"><span class="hljs-regexp">/empty_gif.gif Thread Stats Avg Stdev Max +/</span></span>- Stdev Latency <span class="hljs-number"><span class="hljs-number">9.03</span></span>ms <span class="hljs-number"><span class="hljs-number">1.13</span></span>ms <span class="hljs-number"><span class="hljs-number">28.79</span></span>ms <span class="hljs-number"><span class="hljs-number">79.90</span></span>% Req/Sec <span class="hljs-number"><span class="hljs-number">110.13</span></span> <span class="hljs-number"><span class="hljs-number">10.43</span></span> <span class="hljs-number"><span class="hljs-number">131.00</span></span> <span class="hljs-number"><span class="hljs-number">75.49</span></span>% Latency Distribution <span class="hljs-number"><span class="hljs-number">50</span></span>% <span class="hljs-number"><span class="hljs-number">8.63</span></span>ms <span class="hljs-number"><span class="hljs-number">75</span></span>% <span class="hljs-number"><span class="hljs-number">9.46</span></span>ms <span class="hljs-number"><span class="hljs-number">90</span></span>% <span class="hljs-number"><span class="hljs-number">10.64</span></span>ms <span class="hljs-number"><span class="hljs-number">99</span></span>% <span class="hljs-number"><span class="hljs-number">11.81</span></span>ms <span class="hljs-number"><span class="hljs-number">105344</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">30.03</span></span>s, <span class="hljs-number"><span class="hljs-number">43.40</span></span>MB read Requests/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">3508.50</span></span> Transfer/<span class="hljs-symbol"><span class="hljs-symbol">sec:</span></span> <span class="hljs-number"><span class="hljs-number">1.45</span></span>MB</code> </pre> <br>  Wow!  3500 requests per second, and not a single error! <br>  And in error_log NGINX - silence. <br><br><h3>  findings </h3><br>  Despite the venerable age, and some shortcomings, Candidate 3 (lua-resty-tarantool) is clearly not just a leader, but the only use in production.  And once again we were convinced of the need to test various use cases before making decisions about using or not using one or another technology in real projects. </div><p>Source: <a href="https://habr.com/ru/post/336252/">https://habr.com/ru/post/336252/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336240/index.html">Welcome to South DevFest 2017</a></li>
<li><a href="../336242/index.html">Turn off Intel ME 11 using undocumented mode</a></li>
<li><a href="../336246/index.html">Championship #PGHACK. Platform</a></li>
<li><a href="../336248/index.html">Four types of programmers</a></li>
<li><a href="../336250/index.html">How to work with designers</a></li>
<li><a href="../336254/index.html">Features of the development of mobile MMO RTS. Part 6</a></li>
<li><a href="../336256/index.html">Russian girls in Data Science. Part 1</a></li>
<li><a href="../336258/index.html">Reporting in 1C: Data Composition System (ACS), idea and architecture</a></li>
<li><a href="../336260/index.html">Swift Mutexes and Capture</a></li>
<li><a href="../336262/index.html">Configuring IDE Clion and Cmake to work with STM32 and C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>