<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On detecting drive-by download attacks and new malware distribution vectors via Flash banners</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we want to tell you about a new kind of drive-by download attack using Flash banners, and how to fight it. Such an attack allows attackers to sp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On detecting drive-by download attacks and new malware distribution vectors via Flash banners</h1><div class="post__text post__text-html js-mediator-article"> Today we want to tell you about a new kind of drive-by download attack using Flash banners, and how to fight it.  Such an attack allows attackers to spread viruses through the site without hacking it.  Malicious software is distributed through Flash advertising banners, through which webmasters want to monetize their website.  At the same time, they themselves may not suspect that the banner placed on a web page made their portal part of a virus distribution network. <br><br>  <b>Malicious code</b> <br>  The execution of malicious JavaScript code, for example, in the context of a web browser, is possible thanks to the call to the ExternalInterface class, which appeared in ActionScript 3.0.  The process of executing JavaScript code in the context of web browsers that support the ability to work with ActiveX is implemented through the ActiveX component for Shockwave Flash.  And for web browsers without this feature, a plug-in for Shockwave Flash is used.  An ActiveX component or a plugin parses the bytecode of the Flash file transmitted to it and generates the JavaScript code that will be executed in the context of a web browser if such functionality is present in the Flash file.  After the JavaScript code is generated, it is further processed for processing through JavaScript functions that are pre-built in the ActiveX component or a plug-in for Shockwave Flash.  Figure 1 shows a list of such functions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/174/ddf/eca/174ddfeca94f66a6ea861b0c1245b34b.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Fig.1 - JavaScript functions that use the generation and further execution of the code passed to ExcternalInterface.call () <br><br>  Below is the harmless JavaScript code of the test Flash banner generated for execution in the context of a web browser by an ActiveX component or a plug-in for Shockwave Flash. <br><br><a name="habracut"></a><br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570840/"><img src="https://habrastorage.org/getpro/habr/post_images/06e/21e/cfe/06e21ecfe5af2494a7dc5681500e1198.png" width="500" height="212"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570840/">Look at Yandex. Photos</a> <br><br>  Fig.2 - JavaScript code transmitted to ExcternalInterface.call () of a test Flash banner, which is formed by an ActiveX component or a plug-in for Shockwave Flash <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570841/"><img src="https://habrastorage.org/getpro/habr/post_images/296/cd9/4db/296cd94db489f54c66822da3c1ea8958.png" width="500" height="219"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570841/">Look at Yandex. Photos</a> <br><br>  Fig.3 - The result of executing ExcternalInterface.call () from the test Flash banner <br><br>  Figure 3 shows the FireBug plugin window for the Firefox browser with the result of displaying a test Flash banner and invoking prepared JavaScript code that does not perform malicious actions.  Thus, using the call () method belonging to the ExternalInterface class, you can call any function in the JavaScript language.  This allows attackers to perform malicious actions. <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570842/"><img src="https://habrastorage.org/getpro/habr/post_images/bf9/683/b14/bf9683b14a0d09fafe76f0d05646415c.png" width="800" height="34"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570842/">Look at Yandex. Photos</a> <br><br>  Fig. 4 ‚Äî Calling the ExternalInterface.call () from a Flash banner to use an external JavaScript script on the HTML page <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570843/"><img src="https://habrastorage.org/getpro/habr/post_images/347/faf/b33/347fafb338b555a940b0bffb3db2712f.png" width="800" height="31"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570843/">Look at Yandex. Photos</a> <br><br>  Fig.5 - Calling ExcternalInterface.call () from a Flash banner to steal session data using JavaScript <br><br>  There are a number of limitations for successful execution of JavaScript code from a Flash banner, which are applicable to the Flash runtime environment and are described on the <a href="http://help.adobe.com/ru_RU/FlashPlatform/reference/actionscript/3/flash/system/package.html">official manual page</a> for the fscommand () function from the flash.system package and applicable to ExcternalInterface.call ().  Such restrictions apply depending on external parameters.  Namely, if the property allowScriptAccess is set to: <br><br>  ‚Ä¢ sameDomain (default) - scripts are allowed only for SWF files located in the same domain as the web page; <br>  ‚Ä¢ always - SWF can access the HTML page in which it is embedded, even if it is located on a different domain; <br>  ‚Ä¢ never ‚Äî The SWF file cannot access any HTML pages. <br><br>  <a href="">The system for detecting malicious content</a> on web pages, developed by Yandex, first discovered the use of this method of executing malicious JavaScript code in December 2010. <br><br>  On 04.24.2012, this file was detected by only one of 42 antiviruses presented on the <a href="https://www.virustotal.com/">VirusTotal</a> service.  Namely, <a href="http://www.sophos.com/en-us/">Sophos</a> Antivirus with the verdict <a href="http://www.sophos.com/en-us/threat-center/threat-analyses/viruses-and-spyware/Troj~SWFDlr-AB/detailed-analysis.aspx">Troj / SWFDlr-AB</a> . <br>  Malicious SWF file hash sums: <br><br>  ‚Ä¢ MD5: fd588c260cf38be7a7259c195da5b023 <br>  ‚Ä¢ SHA-1: 9db53d82392c85451e99cb7736ba7b30498e1624 <br>  ‚Ä¢ SHA-256: e15758a2f0ec5b6cb3203ee42d0454ffc7830a2026bcc3eebfdfa9bd0017c965 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d02/dbf/f71/d02dbff71e4bd63808b9f4defa2e52eb.png" alt="image"><br><br>  Figure 6 - Malicious Flash banner detected as Troj / SWFDlr-AB by Sophos classification <br><br>  This malicious SWF file contains in its body an ActionScript code, which is shown in the figure below. <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570845/"><img src="https://habrastorage.org/getpro/habr/post_images/3a2/25a/4eb/3a225a4eb9012dd789d4c6b6a0ed65d7.png" width="500" height="340"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570845/">Look at Yandex. Photos</a> <br><br>  Fig.7 - Malicious code passed to the ExcternalInterface.call () method in the Troj / SWFDlr-AB Flash banner <br><br>  As can be seen from this figure, the value of the User-Agent field transmitted in the HTTP header is checked.  If the browser does not belong to the Chromium family, and this Flash application is accessed from the desired address, specified as in the code snippet in the figure, an invisible element is created on the page that loads the malicious JavaScript code at hxxp: // 66.199.232.59/workarounds.js.  At the time of the spread of the malicious code, the script from the workarounds.js file contained the counts () function.  After execution, this function created a hidden element <b>DIV</b> on the page, and inside it - a hidden IFRAME.  The <b>SRC</b> attribute of the latter contained the address hxxp: //nnuled.co.cc/in.cgi? 3 - for switching to TDS Sutra. <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570846/"><img src="https://habrastorage.org/getpro/habr/post_images/7d5/ba3/b1f/7d5ba3b1fbed65f12b52c83733e481d1.png" width="500" height="393"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570846/">Look at Yandex. Photos</a> <br><br>  Fig.8 - Part of the malicious code of the counts () function from the workarounds.js file <br><br>  Then from the address hxxp: //nnuled.co.cc/in.cgi? 3 there was a transition to the BlackHole Exploit Pack, located at hxxp: //ds3c.co.cc/index.php? Tp = 50afe4b907e38c82.  Malware has already spread from there. <br><br>  Since the first detection of this family of malicious Flash banners, attackers have begun to complicate the ability to detect malicious calls and malicious code.  This is evidenced by a malicious Flash banner, the distribution of which was recorded by us in the middle of April 2012.  At that time, the detected file was not considered as malicious by any of the antiviruses presented on the <a href="http://virustotal.com/">VirusTotal</a> service. <br><br>  Malicious SWF file hash sums: <br>  ‚Ä¢ MD5: 6daa91ce91eee37be0d89e351a7e3a3e <br>  ‚Ä¢ SHA-1: bccc85031396e9c14911ed1c5e6829087eeb9893 <br>  ‚Ä¢ SHA-256: 92395014ac2a8a9e35eaf17f6e73b4fdd643538afbff0bf50afb80f0c6dfccfb <br><br><img src="https://habrastorage.org/getpro/habr/post_images/44d/995/e57/44d995e573686ce6f82cea7b9e79cef1.png" alt="image"><br><br>  Fig.9 - Malicious Flash banner, fixed in mid-April 2012 <br><br>  In appearance, this is a regular Flash advertising banner, but there is another SWF file in the contents of this SWF file. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5b0/5e8/5f2/5b05e85f26ac57b03b1b17d9ce09012a.png" alt="image"><br><br>  Fig.10 - Flash banner containing inside another SWF file <br><br>  This SWF file is loaded from a binary array using ActionScript code, as shown in Figure 11. <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570849/"><img src="https://habrastorage.org/getpro/habr/post_images/a04/bee/ca3/a04beeca39c5afd3447432d1117ea9df.png" width="500" height="178"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570849/">Look at Yandex. Photos</a> <br><br>  Fig.11 - Loading a SWF file from a binary array <br><br>  The hidden ActionScript is heavily obfuscated.  To make code analysis difficult, garbage instructions, spurious traces and reserved words (if, for, do, each, etc.) are used as names of methods and variables, as well as checking where the Flash banner was accessed from and whether currently application under debugging.  After de-obfuscation, large integer two-dimensional arrays inside ActionScript code are converted to strings: <br><br>  ‚Ä¢ superfoo <br>  ‚Ä¢ file: // <br>  ‚Ä¢ StandAlone <br>  ‚Ä¢ sendtoas <br>  ‚Ä¢ en <br>  ‚Ä¢ ru <br>  ‚Ä¢ Rambler <br>  ‚Ä¢ Mail.Ru <br>  ‚Ä¢ YB <br>  ‚Ä¢ Yx <br>  ‚Ä¢ Ya <br>  ‚Ä¢ Begun <br>  ‚Ä¢ Google <br>  ‚Ä¢ Bot <br>  ‚Ä¢ bot <br>  ‚Ä¢ GTB <br>  ‚Ä¢ vkontakte <br>  ‚Ä¢ mail.ru <br>  ‚Ä¢ bing <br>  ‚Ä¢ yahoo <br>  ‚Ä¢ google <br>  ‚Ä¢ yandex <br>  ‚Ä¢ rambler <br>  ‚Ä¢ Windows <br>  ‚Ä¢ MSIE <br>  ‚Ä¢ Explorer <br>  ‚Ä¢ Firefox <br>  ‚Ä¢ Opera <br><br>  Malicious code checks the value of the User-Agent field passed in the HTTP header.  If it does not coincide with one of the popular browsers listed above or contains substrings indicating that the site visitor is a search robot, the malicious code stops its work.  The value of the Referer field transmitted in the HTTP header is also checked for a transition from the search results page or major portals.  If all the conditions described above are met, then the JavaScript code is loaded, which is stored inside the malicious banner in an obfuscated form.  Below is a part of deobfuscated malicious JavaScript code that represents the main function of its execution.  To make the malicious code more difficult to detect, after the execution of the main JavaScript code, the code that removes traces of malicious activity is executed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/501/817/925/501817925d08f863301928ac7036ea86.png" alt="image"><br><br>  Fig.12 - JavaScript code that removes traces of malicious activity <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570851/"><img src="https://habrastorage.org/getpro/habr/post_images/885/dd2/059/885dd2059cdafcc6fca0c8eefad103b5.png" width="500" height="279"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570851/">Look at Yandex. Photos</a> <br><br>  Figure 13 - Deobfuscated malicious JavaScript code from a SWF file <br><br>  The malicious code creates an invisible container on the web page that loads the malicious script from the &lt;SUB&gt; yadro-yadro.com resource, where &lt;SUB&gt; is a random integer.  From there, it redirects to a malicious host in the .cx domain zone on which Nuclear Exploit Pack was located at the time of the propagation of the malicious code. <br><br>  The spread of malicious code in this way is recorded quite rarely by the <a href="http://help.yandex.ru/webmaster/%3Fid%3D1116612">Yandex behavioral analyzer</a> , 1-2 times per quarter.  But since, at the same time, malicious Flash banners are downloaded mainly from pages of well-known portals that are visited daily by a large number of users, the number of infected computers is quite significant. <br><br>  Probably those who invented this method kept it secret to complicate the struggle with it.  The active distribution of malicious code from an infected resource using this method lasts on average no more than 2 days, but this is more than enough to gather all the necessary information about it. <br><br>  In particular, CMS integrated with OpenX Ad Server is most often used to distribute malicious code.  OpenX Ad Server is a popular system for managing ads on your site, the number of times it shows with the price per click, etc.  The attackers choose exactly the sites that use it, because in it, for the Flash object created, the parameter allowScriptAccess is set to the value "always".  After a site that uses OpenX Ad Server advertising banners to rotate is found (which is not difficult - this system is very popular), the attackers need only agree on the placement of a malicious Flash object on it. <br><br> <a href="http://fotki.yandex.ru/users/safesearch/view/570852/"><img src="https://habrastorage.org/getpro/habr/post_images/f19/64d/b08/f1964db088732a6a02c991e1fcdb40d5.png" width="500" height="109"></a> <br>  <a href="http://fotki.yandex.ru/users/safesearch/view/570852/">Look at Yandex. Photos</a> <br><br>  Fig.14 - JavaScript code for creating a new Flash object in OpenX Ad Server <br><br>  <b>Conclusion</b> <br>  Probably, after some time, such malicious Flash applications will become reliably detected by ordinary antiviruses, and the vulnerabilities that they use will be closed.  But until then, to ensure the safety of users of your site and stable traffic to it (infection significantly reduces attendance), we recommend that you: <br><br>  ‚Ä¢ To prevent execution of JavaScript code from Flash applications, set the parameter allowScriptAccess to ‚Äúnever‚Äù.  You can also set the parameter allowNetworking to ‚Äúnone‚Äù or ‚Äúinternal‚Äù to restrict calls to navigateToURL (), fscommand (), ExternalInterface.call ().  Unfortunately, this is due to the need to reduce the functionality of Flash applications. <br>  ‚Ä¢ So that the navigateToURL () method required for advertising applications could work, and the dangerous ExternalInterface.call () could not, place Flash banners on a separate domain or subdomain, then set the allowScriptAccess parameter to ‚ÄúsameDomain‚Äù and the allowNetworking parameter to ‚Äúall‚Äù . <br>  ‚Ä¢ If the Flash application needs maximum permissions to work, get its source code, carefully check and compile it yourself.  If you check, you find the methods navigateToURL (), fscommand (), ExternalInterface.call (), and also ExternalInterface.addCallback (), obfuscated code and large data arrays - this is a reason to ask for clarification from those who suggested that you place this application on your site. <br>  ‚Ä¢ You can use HTML5 as an alternative technology for animated interactive ad units. <br><br>  For more information on the limitations that can be used, we recommend that you familiarize yourself on the Adobe <a href="http://www.adobe.com/devnet/flashplayer/security.html">security page</a> , as well as on the ‚Äú <a href="http://help.adobe.com/ru_RU/ActionScript/3.0_ProgrammingAS3/WS1EFE2EDA-026D-4d14-864E-79DFD56F87C6.html">Restricted Network Connection API</a> ‚Äù page. <br><br>  If you suspect that your site is infected or you don‚Äôt want to allow it to become infected, you can use the <a href="">site security recommendations</a> .  You can learn how to protect your site from spreading malware from it from the text of the <a href="">report of the Yandex Safe Search Team at RIT 2012</a> . <br><br>  In addition, we regularly publish research and analytics <a href="http://safesearch.ya.ru/">on the Yandex Safe Search blog</a> , stay tuned. <br><br>  <i><b>Yandex Safe Search Team</b></i> </div><p>Source: <a href="https://habr.com/ru/post/143345/">https://habr.com/ru/post/143345/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143339/index.html">VKontakte Android SDK</a></li>
<li><a href="../143340/index.html">How and why we changed the configuration of shards in the architecture of Evernote</a></li>
<li><a href="../143341/index.html">Console makovodov: Beyond the GUI</a></li>
<li><a href="../143342/index.html">Web must die</a></li>
<li><a href="../143344/index.html">Touching design: introduction</a></li>
<li><a href="../143346/index.html">Stateless and Statefull pages in Wicket 1.4</a></li>
<li><a href="../143347/index.html">All JavaScript libraries in one place</a></li>
<li><a href="../143348/index.html">Twice straight. Same phone number for St. Petersburg and Moscow</a></li>
<li><a href="../143349/index.html">‚ÄúRunet today‚Äù, May 5, 2012. Experts of the issue: Ilya Ponomarev, Victor Zakharchenko</a></li>
<li><a href="../143350/index.html">Digest of new materials in Russian MSDN for April</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>