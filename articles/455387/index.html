<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Understanding Machine Learning in the Elastic Stack (aka Elasticsearch, aka ELK)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recall that the Elastic Stack is based on the non-relational Elasticsearch database, the Kibana web interface and data collectors (the most well-known...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Understanding Machine Learning in the Elastic Stack (aka Elasticsearch, aka ELK)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/4b/oc/7b/4boc7b0gi2q5fu6pjwtfqqjejsu.png"><br><br>  Recall that the Elastic Stack is based on the non-relational Elasticsearch database, the Kibana web interface and data collectors (the most well-known Logstash, various Beats, APM, and others).  One of the nice additions to the entire listed product stack is data analysis using machine learning algorithms.  In the article we understand what these algorithms are.  We ask under the cat. <br><a name="habracut"></a><br>  Machine learning is a paid shareware Elastic Stack feature and is included in the X-Pack.  To start using it, it is enough to activate a 30-day trials after installation.  After the expiration of the trial period, you can request support for its renewal or buy a subscription.  The subscription price is calculated not on the amount of data, but on the number of nodes used.  No, the amount of data affects, of course, the number of nodes required, but still this approach to licensing is more humane in relation to the company's budget.  If there is no need for high performance - you can save. <br><br>  ML in the Elastic Stack is written in C ++ and works outside the JVM, in which Elasticsearch itself is spinning.  That is, the process (which, by the way, is called autodetect) consumes everything that it does not swallow the JVM.  On a demo stand, this is not so critical, but in a productive environment it is important to single out separate nodes for ML tasks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Machine learning algorithms are divided into two categories - <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2583%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D1%2581_%25D1%2583%25D1%2587%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D0%25B5%25D0%25BC">with a teacher</a> and <a href="https://ru.wikipedia.org/wiki/%25D0%259E%25D0%25B1%25D1%2583%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B1%25D0%25B5%25D0%25B7_%25D1%2583%25D1%2587%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258F">without a teacher</a> .  In the Elastic Stack algorithm from the "no teacher" category.  At <a href="http://www.ijmlc.org/papers/398-LC018.pdf">this link</a> you can see the mathematical apparatus of machine learning algorithms. <br><br>  For analysis, the machine learning algorithm uses data stored in Elasticsearch indexes.  You can create tasks for analysis both from the Kibana interface and through the API.  If you do this through Kibana, then some things are not necessary to know.  For example, additional indexes that the algorithm uses in the process. <br><br><div class="spoiler">  <b class="spoiler_title">Additional indexes used in the analysis process</b> <div class="spoiler_text">  .ml-state - information about statistical models (analysis settings); <br>  .ml-anomalies- * - the results of the ML algorithms; <br>  .ml-notifications - settings for alerts based on the analysis results. <br><br><img src="https://habrastorage.org/webt/5a/_a/qo/5a_aqopt2bguee9tkwz4vny85mo.png"><br></div></div><br>  The data structure in the Elasticsearch database consists of indexes and the documents stored in them.  If you compare with a relational database, then the index can be compared with the database schema, and the document with the record in the table.  This comparison is conditional and is given to simplify the understanding of further material for those who have only heard about Elasticsearch. <br><br>  Through the API, the same functionality is available as through the web interface, so for clarity and understanding of the concepts we will show how to configure through Kibana.  The menu on the left has a Machine Learning section, in which you can create a new job (Job).  In the Kibana interface, it looks like the image below.  Now we will analyze each type of task and show the types of analysis that can be constructed here. <br><br><img src="https://habrastorage.org/webt/3y/4g/f5/3y4gf5hczxc_dupysgikgsa9ata.png"><br><br>  Single Metric - analysis of one metric, Multi Metric - analysis of two or more metrics.  In both cases, each metric is analyzed in an isolated environment, i.e.  the algorithm does not take into account the behavior of concurrently analyzed metrics as it might seem in the case of Multi Metric.  To carry out the calculation taking into account the correlation of various metrics, you can apply Population-analysis.  And Advanced is a fine-tuning of algorithms with additional options for certain tasks. <br><br><h2>  Single metric </h2><br>  Analysis of changes to a single metric is the simplest thing you can do here.  After clicking on Create Job, the algorithm will look for anomalies. <br><br><img src="https://habrastorage.org/webt/qo/qt/5q/qoqt5q7adtanmtvkj7rzufdhpce.png"><br><br>  In the <i>Aggregation</i> field, you can choose the approach to search for anomalies.  For example, at <i>Min,</i> values ‚Äã‚Äãbelow typical will be considered abnormal.  There are <i>Max, Hign Mean, Low, Mean, Distinct</i> and others.  Description of all functions can be viewed <a href="https://www.elastic.co/guide/en/elastic-stack-overview/current/ml-functions.html">at the link</a> . <br><br>  In the <i>Field</i> field indicates the numeric field in the document on which we will conduct the analysis. <br><br>  In the <a href="https://www.elastic.co/blog/explaining-the-bucket-span-in-machine-learning-for-elasticsearch"><i>Bucket span</i></a> field - the granularity of the intervals on the timeline, which will be analyzed.  You can trust the automation or choose manually.  The image below shows an example of too low granularity - you can skip the anomaly.  With this setting, you can change the sensitivity of the algorithm to anomalies. <br><br><img src="https://habrastorage.org/webt/ab/td/4u/abtd4uyfg5bwhusjthw48vza34e.png"><br><br>  The duration of the data collected is the key thing that affects the efficiency of the analysis.  In the analysis, the algorithm determines the repeated intervals, calculates the confidence interval (baselines) and identifies anomalies - atypical deviations from the usual behavior of the metric.  Just for example: <br><br>  Baselines with a small segment of data: <br><br><img src="https://habrastorage.org/webt/gg/0q/lr/gg0qlreunogl4_e8kfqt692jkx4.png"><br><br>  When the algorithm is on what to learn - the baseline looks like this: <br><br><img src="https://habrastorage.org/webt/gh/sy/fm/ghsyfmlcchzvs8pgdlneq5lqje8.png"><br><br>  After starting the task, the algorithm determines the abnormal deviations from the norm and ranks them according to the probability of the anomaly (the color of the corresponding label is indicated in brackets): <br><br>  Warning (blue): less than 25 <br>  Minor (yellow): 25-50 <br>  Major (orange): 50-75 <br>  Critical (red): 75-100 <br><br>  On the graph below an example with the anomalies found. <br><br><img src="https://habrastorage.org/webt/jt/cj/sc/jtcjscwmq7c2efh2gjph8u_3uto.png"><br><br>  Here you can see the number 94, which indicates the probability of an anomaly.  It is clear that if the value is close to 100, then we have an anomaly.  The column below the graph indicates a disproportionately low probability of 0.000063634% of the appearance of the metric value there. <br><br>  In addition to searching for anomalies in Kibana, you can run a prediction.  This is done elementary and from the same presentation with anomalies - the <i>Forecast</i> button in the upper right corner. <br><br><img src="https://habrastorage.org/webt/qx/bj/4s/qxbj4sm4iuteghkt3olp575at-4.png"><br><br>  The forecast is built a maximum of 8 weeks ahead.  Even if you really want - you can no longer by design. <br><br><img src="https://habrastorage.org/webt/ee/ps/en/eepsen4-a-mhu9lbn_-y_unfajc.png"><br><br>  In some situations, the forecast will be very useful, for example, when the user load on the infrastructure is monitored. <br><br><h2>  Multi metric </h2><br>  Moving on to the next ML opportunity in Elastic Stack ‚Äî analyzing several metrics with one bundle.  But this does not mean that the dependence of one metric on another will be analyzed.  This is the same as Single Metric with only multiple metrics on one screen for easy comparison of the effects of one on the other.  About analyzing the dependence of one metric on another we will tell in the part of Population. <br><br>  After clicking on the square with Multi Metric, a window with settings will appear.  We dwell on them in more detail. <br><br><img src="https://habrastorage.org/webt/t_/tp/kl/t_tpklo5pluosupeh-2chlhdbtc.png"><br><br>  First you need to select the fields for analysis and data aggregation by them.  The aggregation options are the same as for Single Metric ( <i>Max, Hign Mean, Low, Mean, Distinct</i> and others).  Further, the data is optionally divided into one of the fields ( <i>Split Data</i> field).  In the example, we did this in the <i>OriginAirportID</i> field.  Note that the graph of the metrics on the right is now represented as a set of graphs. <br><br><img src="https://habrastorage.org/webt/ui/kk/lj/uikkljm3jja_dl_hatkli7uxw48.png"><br><br>  The <i>Key Fields (Influencers)</i> field directly affects the anomalies found.  By default, there will always be at least one value, and you can add additional ones.  The algorithm will take into account the influence of these fields in the analysis and show the most "influential" values. <br><br>  After launch, a similar picture will appear in the Kibana interface. <br><br><img src="https://habrastorage.org/webt/mp/bl/ma/mpblmaxtrq2zvntlquovckyf2yo.png"><br><br>  This is the so-called.  heat map of anomalies for each value of the <i>OriginAirportID</i> field, which we indicated in <i>Split Data</i> .  As in the case of Single Metric, the color indicates the level of abnormal deviation.  A similar analysis is conveniently done, for example, on workstations to track those where there are many suspicious authorizations, etc.  We have already written <a href="https://habr.com/ru/company/galssoftware/blog/447522/">about suspicious events in EventLog Windows</a> , which can also be collected and analyzed here. <br><br>  Under the heat map a list of anomalies, from each you can go to the Single Metric view for detailed analysis. <br><br><h2>  Population </h2><br>  To look for anomalies among the correlations between different metrics in the Elastic Stack there is a specialized Population analysis.  It is with the help of it that one can look for anomalous values ‚Äã‚Äãin the performance of any server in comparison with the others with, for example, an increase in the number of requests to the target system. <br><br><img src="https://habrastorage.org/webt/ir/su/j6/irsuj6dtlozgat-jf0hknc2tyzs.png"><br><br>  In this illustration, the Population field indicates the value to which the analyzed metrics will refer.  In this is the name of the process.  As a result, we will see how the processor load by each of the processes influenced each other. <br><br>  Please note that the graph of the analyzed data differs from the cases with Single Metric and Multi Metric.  This is done in Kibana by design for improved perception of the distribution of the values ‚Äã‚Äãof the analyzed data. <br><br><img src="https://habrastorage.org/webt/qo/zn/3v/qozn3vwfw6ytqwh5pzgutmvgk_o.png"><br><br>  From the graph it can be seen that the <i>stress</i> process (by the way, generated by a special utility) on the <i>poipu</i> server, which influenced (or turned out to be a fluencer) to the occurrence of this anomaly, behaved abnormally. <br><br><h2>  Advanced </h2><br>  Analytics with fine tuning.  With advanced analysis in Kibana additional settings appear.  After clicking on the Create menu on the Advanced tile, this tab window appears.  The <i>Job Details</i> tab was missed intentionally, there the basic settings are not directly related to the analysis settings. <br><br><img src="https://habrastorage.org/webt/kr/pf/w6/krpfw6x4bdgpezxfs44p6dyjvhm.png"><br><br>  In the <i>summary_count_field_name</i> optionally, you can specify the name of the field from documents containing aggregated values.  In this example, the number of events per minute.  The <a href="https://www.elastic.co/guide/en/elastic-stack-overview/current/ml-configuring-categories.html"><i>categorization_field_name</i></a> specifies the name of the field value from the document that contains some variable value.  According to the mask, this field can be used to break the analyzed data into subsets.  Pay attention to the <i>Add detector</i> button in the previous illustration.  Below is the result of clicking on this button. <br><br><img src="https://habrastorage.org/webt/ch/kg/sg/chkgsgutp0bsp0fxb7_q293caku.png"><br><br>  Here is an additional block of settings for setting up the anomaly detector for a specific task.  We will discuss the specific use cases (especially for security) in the following articles.  For an example, <a href="https://discuss.elastic.co/t/dec-4th-2018-en-ml-rarity-analysis-with-machine-learning/158979">look at</a> one of the disassembled cases.  It is associated with the search for rarely appearing values ‚Äã‚Äãand is implemented <a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.1/ml-rare-functions.html">by the rare function</a> . <br><br>  In the <i>function</i> field, you can select a specific function to search for anomalies.  In addition to <i>rare</i> , there are a couple of interesting features - <a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.1/ml-time-functions.html"><i>time_of_day</i> and <i>time_of_week</i></a> .  They bring out anomalies in the behavior of metrics throughout the day or week, respectively.  The remaining analysis functions <a href="https://www.elastic.co/guide/en/elastic-stack-overview/7.1/ml-functions.html">are in the documentation</a> . <br><br>  The <i>field_name</i> specifies the field of the document that will be analyzed.  <i>By_field_name</i> can be used to separate the analysis results for each individual value of the document field specified here.  If you fill in <i>over_field_name, you</i> get a population analysis, which we considered above.  If you specify a value in <i>partition_field_name</i> , then this field of the document will calculate individual baselines for each value (values ‚Äã‚Äãcan be, for example, the name of the server or the process on the server).  In <i>exclude_frequent,</i> you can select <i>all</i> or <i>none</i> , which will mean exclusion (or inclusion) of frequently encountered field values ‚Äã‚Äãof documents. <br><br>  In the article we tried to give an idea of ‚Äã‚Äãthe possibilities of machine learning in the Elastic Stack as concisely as possible, there are still a lot of details left overs.  Tell us in the comments which cases you managed to solve with the help of the Elastic Stack and for what tasks you use it.  To contact us you can use personal messages on Habr√© or <a href="https://gals.software/solutions/elasticstack">a feedback form on the site</a> . </div><p>Source: <a href="https://habr.com/ru/post/455387/">https://habr.com/ru/post/455387/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../455373/index.html">How to adjust the law of Spring to make it lifting for small providers? Cancel it</a></li>
<li><a href="../455377/index.html">IoT architecture</a></li>
<li><a href="../455379/index.html">(Static) Selection of optimal containers in C ++ programs</a></li>
<li><a href="../455381/index.html">Technical support 3CX responds: seizure of SIP-traffic on the PBX server</a></li>
<li><a href="../455383/index.html">How to start programming a newbie for free</a></li>
<li><a href="../455389/index.html">Haxe 4: What's new?</a></li>
<li><a href="../45539/index.html">The Japanese have released a browser with three engines</a></li>
<li><a href="../455391/index.html">RISC-V: RocketChip in unnatural habitat</a></li>
<li><a href="../455393/index.html">On the application of parametric spectral estimation methods in radar - the method MUSIC. Addition to the article</a></li>
<li><a href="../455397/index.html">How we designed and implemented a new network on Huawei in the Moscow office, part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>