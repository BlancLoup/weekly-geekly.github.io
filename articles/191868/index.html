<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>File Monitoring with GCD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think that most iOS developers know how to easily enable iTunes File Sharing in their application, adding just one line to Info.plist: 

UIFileShari...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>File Monitoring with GCD</h1><div class="post__text post__text-html js-mediator-article">  I think that most iOS developers know how to easily enable iTunes File Sharing in their application, adding just one line to Info.plist: <pre><code class="cpp hljs">UIFileSharingEnabled = YES</code> </pre>  But this is not even half the battle.  The point is that, in an amicable way, the application should now monitor all changes with files occurring in the Documents directory and update its data accordingly.  How to release it in your code and tell this article. <br><img src="https://habrastorage.org/getpro/habr/post_images/fa0/61a/bb1/fa061abb1253145d63482602dbae9dfd.png" alt="image"><br><a name="habracut"></a><br>  To begin with, quite a bit of theory from the Concurrency Programming Guide.  In GCD, there is such a thing as <b>dispatch source</b> , a fundamental data type that is responsible for coordinating the processing of specific low-level events.  To solve our problem, we are most interested in its kind as <b>descriptor sources</b> , which notifies of various operations with files or sockets. <br><br>  It turns out that we need to create an event <code>dispatch_source_create</code> using <code>dispatch_source_create</code> , the source of which will be the file descriptor (directory file descriptor), and the event itself (file recording) will work out the necessary block for updating the application data. <br><br>  Here it should be noted that the event is triggered by the first byte of the file recorded on the disk, and the files are now large.  Therefore, in the data update block, we launch a recursive check of the end of synchronization with a timeout of one second. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, closer to the body.  Let's create two main methods <code>startMonitor</code> and <code>stopMonitor</code> , respectively, launching and stopping the monitoring of the directory we need, as well as a couple of subsidiary methods for checking changes in this directory that will be launched through the handler block. <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)startMonitor { <span class="hljs-comment"><span class="hljs-comment">//     dispatch_source_t if (_src != NULL) return; //    Documents   NSString *docPath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject]; //  ,     (O_EVTONLY) _fileDescriptor = open([docPath fileSystemRepresentation], O_EVTONLY); //    thread,     UI dispatch_queue_t queue = dispatch_get_main_queue(); //    dispatch source    (write) _src = dispatch_source_create(DISPATCH_SOURCE_TYPE_VNODE, _fileDescriptor, DISPATCH_VNODE_WRITE, queue); // handler block      dispatch_source_set_event_handler(_src, ^{ [self directoryDidChange]; }); //     dispatch_source_set_cancel_handler(_src, ^{ close(_fileDescriptor); }); dispatch_resume(_src); } - (void)stopMonitor { if (_src) { //   ,    dispatch_source_cancel(_src); _src = NULL; } } - (void)directoryDidChange { if(!waitingForDocumentsDirectoryTimeout) { // ,    ,     waitingForDocumentsDirectoryTimeout = YES; //       _lastDocumentsDirectoryReferenceArray=[self documentsDirectoryReferenceArray]; //...         ,  [self performSelector:@selector(checkForDocumentsDirectoryChanges) withObject:nil afterDelay:1.0 inModes:[NSArray arrayWithObjects:NSRunLoopCommonModes,nil]]; } } -(void)checkForDocumentsDirectoryChanges { NSArray *newDocumentsDirectoryReferenceArray=[self documentsDirectoryReferenceArray]; //      if(![newDocumentsDirectoryReferenceArray isEqualToArray:_lastDocumentsDirectoryReferenceArray]) { //       _lastDocumentsDirectoryReferenceArray=newDocumentsDirectoryReferenceArray; [self performSelector:@selector(checkForDocumentsDirectoryChanges) withObject:nil afterDelay:1.0 inModes:[NSArray arrayWithObjects:NSRunLoopCommonModes,nil]]; } else { //    waitingForDocumentsDirectoryTimeout=NO; _lastDocumentsDirectoryReferenceArray=nil; // ...         ,  [self scanDocumentsDirectory]; } } -(NSArray *)documentsDirectoryReferenceArray { //         - NSString *documentsDirectoryPath = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject]; NSArray *documentsDirectoryContents = [[NSFileManager defaultManager] contentsOfDirectoryAtPath:documentsDirectoryPath error:NULL]; NSMutableArray *documentsDirectoryReferenceArray=[NSMutableArray arrayWithCapacity:10]; for(NSString *fileName in documentsDirectoryContents){ NSString *filePath=[documentsDirectoryPath stringByAppendingPathComponent:fileName]; NSError *error; NSDictionary *fileAttributes = [[NSFileManager defaultManager] attributesOfItemAtPath:filePath error:&amp;error]; NSInteger fileSize = [[fileAttributes objectForKey:NSFileSize] intValue]; NSString *fileWithLength=[NSString stringWithFormat:@"%@-%d",fileName,fileSize]; [documentsDirectoryReferenceArray addObject:fileWithLength]; } return documentsDirectoryReferenceArray; }</span></span></code> </pre><br><br>  Well, for those who run their eyes on text and who are too lazy to understand, a similar approach has already been implemented in <a href="https://github.com/Cocoanetics/DTFoundation">Cocoanetics / DTFoundation</a> class <code>DTFolderMonitor</code> . <br><br>  Also, from the experience of working with <a href="http://pdfboxapp.com/">my application</a> using iTunes File Sharing, I want to remind you of the need to launch a method like <code>scanDocumentsDirectory</code> , besides monitoring, as soon as the application becomes active.  Its purpose is not only to check, but also to update the data about the files in the application with their actual presence in the directory, since the synchronization of files with iTunes can occur even while the application is in the background or is not started at all. <br><br><pre> <code class="cpp hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)applicationWillEnterForeground:(UIApplication *)application { [self scanDocumentsDirectory]; }</code> </pre> <br><br><div class="spoiler">  <b class="spoiler_title">Links to primary sources</b> <div class="spoiler_text">  <a href="https://devforums.apple.com/thread/44497%3Fstart%3D0%26tstart%3D0">Historical thread of discussions on the topic on the Apple Developer Forum</a> (development account is required for access) <br>  <a href="http://www.mlsite.net/blog/%3Fp%3D2312">Directory Monitor</a> - the old school monitor from Michael Heyeck <br>  <a href="http://www.mlsite.net/blog/%3Fp%3D2655">Directory Monitoring and GCD</a> is the same, but updated <br>  <a href="https://www.cocoanetics.com/2013/08/monitoring-a-folder-with-gcd/">Monitoring a Folder with GCD</a> solution from Socoanetics <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/191868/">https://habr.com/ru/post/191868/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191858/index.html">Another JavaScript preprocessor</a></li>
<li><a href="../191860/index.html">The attacker got caught selling root accesses to supercomputers</a></li>
<li><a href="../191862/index.html">A little bit about how we wrote a photo mosaic generator for Android</a></li>
<li><a href="../191864/index.html">The use of IT in the search for new drugs: an overview of areas</a></li>
<li><a href="../191866/index.html">Electronic signature formats</a></li>
<li><a href="../191870/index.html">Execution of an external file from an Oracle database in order to obtain information about disk space</a></li>
<li><a href="../191872/index.html">Regional market of Internet advertising and sites. And how are you?</a></li>
<li><a href="../191874/index.html">PPTP vs L2TP vs OpenVPN vs SSTP</a></li>
<li><a href="../191876/index.html">Choosing a budget UPS</a></li>
<li><a href="../191878/index.html">Cloud Startup Market</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>