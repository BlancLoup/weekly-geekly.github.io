<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JIRA 4.1 integration with Active Directory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The challenge was to integrate JIRA 4.1 with Active Directory with the following conditions: 


1. Synchronization of users and groups (version 4.1 do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JIRA 4.1 integration with Active Directory</h1><div class="post__text post__text-html js-mediator-article">  The challenge was to integrate JIRA 4.1 with Active Directory with the following conditions: <br><ol><li>  Synchronization of users and groups (version 4.1 does not support synchronization) </li><li>  Transparent authentication (JIRA uses email addresses as logins) </li><li>  Filling user properties (phone number) </li><li>  Users who are not in AD should be flagged </li></ol><br>  And that's how I decided it: <br><a name="habracut"></a><br><br>  The topic was published at the request of habrovchanin <a href="http://habrahabr.ru/users/XoJIoD/">XoJIoD</a> - so there are advantages to it. <br><br><h4>  JIRA Setup </h4><br>  JIRA 4.1 has a ready-made LDAP integration mechanism, but the only thing that it can do is to check passwords, i.e.  About any synchronization of speech does not go.  This step can be skipped, because  in the future, we will entrust the verification of SPNEGO passwords. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, go to JIRA as an administrator and go to the section Administration ‚Üí System ‚Üí LDAP and fill out the form: <br><img src="https://habrastorage.org/getpro/habr/post_images/8ee/f1e/8cf/8eef1e8cf6af624d0c4d2d9da07e34f7.png" alt="image"><br>  where: <br><ul><li>  <b>LDAP Host</b> - the address and port of your LDAP server </li><li>  <b>BaseDN</b> - the root DN in which to search for users </li><li>  <b>Bind DN</b> - user DN used to connect to the LDAP server </li><li>  <b>Bind Password</b> - user password used to connect </li><li>  <b>Search Attribute</b> - an attribute that contains the user login (in my case, this is the email address) </li><li>  <b>Sample user to authenticate</b> - user login that will be used to verify the connection </li><li>  <b>Sample user's password</b> - user password to check the connection </li></ul><br><br>  If you receive a PartialResultException error, try using the Global Catalog port (3268).  If everything is filled out correctly, an <i>LDAP Authentication successful</i> message should appear and, just below, the contents of the XML file for integration.  Copy it, stop the JIRA server and replace with this content what was in the <i>$ JIRA_HOME / atlassian-jira / WEB-INF / classes / osuser.xml file</i> .  Taking this opportunity, we also enable the execution of Jelly scripts. To do this, in the <i>$ JIRA_HOME / bin / setenv.sh file</i> (for Linux), add the line <i>-Djira.jelly.on = true</i> to the <b>JAVA_OPTS</b> parameter. <br><br>  After that, rerun JIRA and make sure that users from AD use passwords from there. <br><br><h4>  Creating a jelly script </h4><br>  I wrote the program for generating the script that creates users and groups at the very beginning, and then it was a pity to throw it out.  Therefore, if you add groups to the authenticator or service (see below), you can also skip this step. <br><br>  In the documentation on the Atlassian website, <a href="http://confluence.atlassian.com/display/JIRA/Importing%2Buser%2Bfrom%2BLDAP">an</a> open source <a href="http://confluence.atlassian.com/display/JIRA/Importing%2Buser%2Bfrom%2BLDAP">utility</a> was found that generates a Jelly script that creates LDAP users in JIRA.  However, I also needed to create groups, therefore, having armed myself with <a href="http://confluence.atlassian.com/display/JIRA041/Jelly%2BTags">documentation on Jelly tags</a> , I added this utility to such a state: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.FileReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Properties; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.NamingEnumeration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.lang3.StringEscapeUtils; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LDAPImporter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Properties properties = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Properties(); File path = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(LDAPImporter.class.getProtectionDomain() .getCodeSource().getLocation().toURI()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!path.isDirectory()) { path = path.getParentFile(); } properties.load(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(path, <span class="hljs-string"><span class="hljs-string">"LDAP.properties"</span></span>))); properties.put(<span class="hljs-string"><span class="hljs-string">"java.naming.factory.initial"</span></span>, <span class="hljs-string"><span class="hljs-string">"com.sun.jndi.ldap.LdapCtxFactory"</span></span>); DirContext groupContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InitialDirContext(properties); SearchControls groupControls = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchControls(); groupControls.setReturningAttributes(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { (String) properties.get(<span class="hljs-string"><span class="hljs-string">"groupNameAttribute"</span></span>), (String) properties.get(<span class="hljs-string"><span class="hljs-string">"groupDNAttribute"</span></span>) }); groupControls.setSearchScope(SearchControls.SUBTREE_SCOPE); System.out.println(<span class="hljs-string"><span class="hljs-string">"&lt;JiraJelly xmlns:jira=\"jelly:com.atlassian.jira.jelly.JiraTagLib\"&gt;\n"</span></span>); NamingEnumeration results = groupContext.search( (String) properties.get(<span class="hljs-string"><span class="hljs-string">"baseDN"</span></span>), (String) properties.get(<span class="hljs-string"><span class="hljs-string">"groupFilter"</span></span>), groupControls); <span class="hljs-comment"><span class="hljs-comment">//    (Organisation Unit') while (results != null &amp;&amp; results.hasMoreElements()) { SearchResult result = (SearchResult) results.next(); Attribute attribute = result.getAttributes().get( (String) properties.get("groupNameAttribute")); if (attribute == null) { continue; } String groupName = (String) attribute.get(); String groupDN = (String) result.getAttributes() .get((String) properties.get("groupDNAttribute")).get(); //   System.out.println("&lt;jira:CreateGroup group-name=\"" + StringEscapeUtils.escapeXml("[AD] " + groupName) + "\"/&gt;\n"); DirContext userContext = new InitialDirContext(properties); SearchControls userControls = new SearchControls(); userControls.setReturningAttributes(new String[] { (String) properties.get("userLoginAttribute"), (String) properties.get("userNameAttribute"), (String) properties.get("userMailAttribute") }); userControls.setSearchScope(SearchControls.ONELEVEL_SCOPE); NamingEnumeration users = userContext.search(groupDN, (String) properties.get("userFilter"), userControls); //      while (users != null &amp;&amp; users.hasMoreElements()) { SearchResult user = (SearchResult) users.next(); attribute = user.getAttributes().get( (String) properties.get("userLoginAttribute")); if (attribute == null) { continue; } String userLogin = (String) attribute.get(); attribute = user.getAttributes().get( (String) properties.get("userNameAttribute")); String userName; if (attribute != null) { userName = (String) attribute.get(); } else { userName = userLogin; } attribute = user.getAttributes().get( (String) properties.get("userMailAttribute")); String userMail; if (attribute != null) { userMail = (String) attribute.get(); } else { userMail = userLogin.replace(' ', '.') + '@' + properties.get("userMailDomain"); } /* * ..     AD, *    */ String password = Integer.toHexString(new Random().nextInt()); //   System.out.println("&lt;jira:CreateUser username=\"" + StringEscapeUtils.escapeXml(userLogin.toLowerCase()) + "\" password=\"" + password + "\" confirm=\"" + password + "\" fullname=\"" + StringEscapeUtils.escapeXml(userName) + "\" email=\"" + StringEscapeUtils.escapeXml(userMail) + "\"/&gt;\n"); //     System.out.println("&lt;jira:AddUserToGroup username=\"" + StringEscapeUtils.escapeXml(userLogin.toLowerCase()) + "\" group-name=\"" + StringEscapeUtils.escapeXml("[AD] " + groupName) + "\"/&gt;\n"); } } System.out.println("&lt;/JiraJelly&gt;"); } }</span></span></code> </pre> <br>  Settings are taken from the file LDAP.properties, located in the same directory with the program, it looks like this: <br><pre> <code class="hljs pgsql">#   LDAP java.naming.provider.url=ldap://<span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">389</span></span> # DN    java.naming.<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>.principal=cn=test,ou=users,dc=<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>,dc=<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> #   java.naming.<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>.credentials=<span class="hljs-keyword"><span class="hljs-keyword">password</span></span> #  DN baseDN=ou=users,dc=<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>,dc=<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> #     groupNameAttribute=<span class="hljs-type"><span class="hljs-type">name</span></span> #   DN  groupDNAttribute=distinguishedName #   groupFilter=(objectclass=organizationalUnit) #     userLoginAttribute=mail #     (  ,  ) userNameAttribute=displayName #    e-mail  (  ,   + @ +  ) userMailAttribute=mail #   userMailDomain=<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> #   userFilter=(objectclass=<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>)</code> </pre><br>  The script obtained in this way we feed Jira in the section Administration ‚Üí Options &amp; Settings ‚Üí Jelly Runner and after some thought she creates users and groups. <br><br><h4>  Transparent Authentication </h4><br>  The idea of ‚Äã‚Äãtransparent authentication is as follows: authenticates SPNEGO users and passes the login of the already logged in user to the JARA variable REMOTE USER.  The downside is that with such a scheme, <b>users who are not in AD will not be able to log into JIRA</b> , but I didn‚Äôt think of anything better. <br><br><h5>  SPNEGO </h5><br>  First, we <a href="http://spnego.sourceforge.net/pre_flight.html">test the performance of</a> SPNEGO.  To do this, download the three files: <a href="">krb5.conf</a> , <a href="">login.conf</a> and <a href="">HelloKDC.java</a> . <br>  In the krb5.conf file in the [libdefaults] section, <b>one line is missing</b> , do not forget to enter it.  After changing the settings, the krb5.conf file should look like this: <br><pre> <code class="hljs pgsql">[libdefaults] default_realm = <span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span> default_tkt_enctypes = aes128-cts rc4-hmac des3-cbc-sha1 des-cbc-md5 des-cbc-crc default_tgs_enctypes = aes128-cts rc4-hmac des3-cbc-sha1 des-cbc-md5 des-cbc-crc permitted_enctypes = aes128-cts rc4-hmac des3-cbc-sha1 des-cbc-md5 des-cbc-crc [realms] <span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span> = { kdc = dc5.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> default_domain = <span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span> } [domain_realm] .<span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">LOCAL</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">DOMAIN</span></span></code> </pre><br>  HelloKDC.java: <br><pre> <code class="java hljs">... <span class="hljs-comment"><span class="hljs-comment">// Domain (pre-authentication) account final String username = "test"; // Password for the pre-auth acct. final String password = "password"; // Name of our krb5 config file final String krbfile = "krb5.conf"; // Name of our login config file final String loginfile = "login.conf"; // Name of our login module final String module = "spnego-client"; ...</span></span></code> </pre><br>  Compile and run the HelloKDC.java file, if everything went well, it will output a bunch of lines and at the end <i>Connection test successful.</i> <br><br>  Next, download the <a href="http://en.wikipedia.org/wiki/Windows_Support_Tools">Support Tools</a> utility set, install them on the administrator's domain computer and execute the commands: <br><pre> <code class="hljs bash">setspn.exe -A HTTP/domain1 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> setspn.exe -A HTTP/domain2 <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> ... setspn.exe -A HTTP/domainN <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre><br>  where <br><ul><li>  <b>test</b> - user login under which SPNEGO will log into AD </li><li>  <b>domain *</b> - all possible names by which JIRA will be available to users (for example, jira, jira.local.domain, etc.) </li></ul><br>  Download <a href="http://sourceforge.net/projects/spnego/files/">the SPNEGO distribution</a> and put it in the <i>$ JIRA_HOME / lib</i> directory.  Open the $ JIRA_HOME / conf / web.xml file and add to the end (but before closing the web-app tag) the following lines: <br><pre> <code class="hljs ruby">&lt;filter&gt; &lt;filter-name&gt;SpnegoHttpFilter&lt;<span class="hljs-regexp"><span class="hljs-regexp">/filter-name&gt; &lt;filter-class&gt;net.sourceforge.spnego.SpnegoHttpFilter&lt;/filter</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">allow</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">basic</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">allow</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">localhost</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">allow</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unsecure</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">basic</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">login</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">client</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">krb5</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">krb5</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">login</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">login</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">preauth</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">username</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">test</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">preauth</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">password</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">login</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">server</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prompt</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ntlm</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;init-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">spnego</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">logger</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">level</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;param-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;1&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filter</span></span></span><span class="hljs-class">&gt; &lt;filter-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mapping</span></span></span><span class="hljs-class">&gt; &lt;filter-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpnegoHttpFilter</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filter</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;url-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pattern</span></span></span><span class="hljs-class">&gt;*&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pattern</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filter</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mapping</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br>  Remember to replace your username and password with your own. <br><br><h5>  Authenticator </h5><br>  The time has come to write an authenticator whose task is to get the login of the logged-in user from SPNEGO, add the mail domain to this login (since the JIRA logs are postal addresses) and filling in the property containing the phone for users who do not yet have this property. .  In the delivery of the SDK for JIRA 4.x plug-ins, there was no place for the JiraOsUserAuthenticator class, on the basis of which our authenticator will be written, since  this class is already obsolete.  Therefore, it must be manually added to the libraries when compiling; you can take it in <i>$ JIRA_HOME / atlassian-jira / WEB-INF / classes / com / atlassian / jira / security / login /</i> . <br><br>  Actually, the authenticator code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.security.Principal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Properties; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.NamingEnumeration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.Attribute; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.DirContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.InitialDirContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.SearchControls; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.SearchResult; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletResponse; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.core.user.preferences.Preferences; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.ComponentManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.security.login.JiraOsUserAuthenticator; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.user.preferences.UserPreferencesManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.user.util.UserUtil; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.opensymphony.user.Group; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.opensymphony.user.User; <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"deprecation"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RemoteAuthenticator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JiraOsUserAuthenticator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serialVersionUID = <span class="hljs-number"><span class="hljs-number">1L</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UserPreferencesManager preferencesManager = ComponentManager .getInstance().getUserPreferencesManager(); <span class="hljs-comment"><span class="hljs-comment">//   LDAP private final String ADDRESS_NAME = "java.naming.provider.url"; private final String ADDRESS_VALUE = "ldap://127.0.0.1:389"; // DN    private final String LOGIN_NAME = "java.naming.security.principal"; private final String LOGIN_VALUE = "cn=test,ou=users,dc=local,dc=domain"; //   private final String PASSWORD_NAME = "java.naming.security.credentials"; private final String PASSWORD_VALUE = "password"; //  DN private final String BASEDN = "ou=users,dc=local,dc=domain"; //   private final String LOGIN_ATTRIBUTE = "mail"; //   (  ,  ) private final String NAME_ATTRIBUTE = "displayName"; //    (  , //   + @ +  ) private final String MAIL_ATTRIBUTE = "mail"; //   private final String PHONE_ATTRIBUTE = "telephoneNumber"; //   private final String DOMAIN = "local.domain"; @Override public Principal getUser(HttpServletRequest request, HttpServletResponse response) { Principal user = null; if (request.getSession() != null &amp;&amp; request.getSession(). getAttribute(JiraOsUserAuthenticator.LOGGED_IN_KEY) != null) { //    user = (Principal) request.getSession().getAttribute( JiraOsUserAuthenticator.LOGGED_IN_KEY); } else { String remote = request.getRemoteUser(); if (remote != null) { //    SPNEGO if (!remote.endsWith('@' + DOMAIN)) { /* *     , *    . *      , *      */ remote += '@' + DOMAIN; } user = getUser(remote.toLowerCase()); if (user == null) { /* *       JIRA, *  */ try { user = createUser(remote.toLowerCase()); } catch (Exception exception) { exception.printStackTrace(System.err); } } else { Preferences preferences = preferencesManager .getPreferences((User) user); String phone = preferences .getString(UserUtil.META_PROPERTY_PREFIX + "mobile"); if (phone == null || phone.isEmpty()) { /* *       , *  */ try { phone = getPhone(remote.toLowerCase()); if (phone != null) { preferences.setString( UserUtil.META_PROPERTY_PREFIX + "mobile", phone); } } catch (Exception exception) { exception.printStackTrace(System.err); } } } request.getSession().setAttribute( JiraOsUserAuthenticator.LOGGED_IN_KEY, user); request.getSession().setAttribute( JiraOsUserAuthenticator.LOGGED_OUT_KEY, null); } } return user; } private User createUser(String login) throws Exception { DirContext context = null; try { Properties properties = new Properties(); properties.put(ADDRESS_NAME, ADDRESS_VALUE); properties.put(LOGIN_NAME, LOGIN_VALUE); properties.put(PASSWORD_NAME, PASSWORD_VALUE); properties.put("java.naming.factory.initial", "com.sun.jndi.ldap.LdapCtxFactory"); ComponentManager componentManager = ComponentManager.getInstance(); UserUtil userUtil = componentManager.getUserUtil(); context = new InitialDirContext(properties); SearchControls controls = new SearchControls(); controls.setReturningAttributes(new String[] { "distinguishedName", NAME_ATTRIBUTE, MAIL_ATTRIBUTE, PHONE_ATTRIBUTE }); controls.setSearchScope(SearchControls.SUBTREE_SCOPE); NamingEnumeration users = context.search(BASEDN, '(' + LOGIN_ATTRIBUTE + '=' + login + ')', controls); if (users != null &amp;&amp; users.hasMoreElements()) { /* *     ( ) *   AD */ SearchResult result = (SearchResult) users.next(); Attribute attribute = result.getAttributes() .get(NAME_ATTRIBUTE); String userName; if (attribute != null) { userName = (String) attribute.get(); } else { userName = login; } attribute = result.getAttributes().get(MAIL_ATTRIBUTE); String userMail; if (attribute != null) { userMail = (String) attribute.get(); } else { userMail = login.replace(' ', '.') + '@' + DOMAIN; } attribute = result.getAttributes().get(PHONE_ATTRIBUTE); String userPhone = null; if (attribute != null) { userPhone = ((String) attribute.get()).replace("(", "") .replace(")", ""); } String userDN = (String) result.getAttributes() .get("distinguishedName").get(); //    String userPassword = Integer.toHexString(new Random().nextInt()); //   User user = userUtil.createUserNoEvent(login, userPassword, userMail, userName); //   AD  ,   if (userPhone != null) { preferencesManager.getPreferences(user).setString( UserUtil.META_PROPERTY_PREFIX + "mobile", userPhone); } /* *     JIRA,   AD, *    */ int index = userDN.indexOf("OU=") + 3; String groupName = "[AD] " + userDN.substring(index, userDN.indexOf(',', index)); Group group = userUtil.getGroup(groupName); if (group != null) { userUtil.addUserToGroup(group, user); } return user; } else { return null; } } finally { if (context != null) { context.close(); } } } private String getPhone(String username) throws Exception { DirContext context = null; try { Properties properties = new Properties(); properties.put(ADDRESS_NAME, ADDRESS_VALUE); properties.put(LOGIN_NAME, LOGIN_VALUE); properties.put(PASSWORD_NAME, PASSWORD_VALUE); properties.put("java.naming.factory.initial", "com.sun.jndi.ldap.LdapCtxFactory"); context = new InitialDirContext(properties); SearchControls controls = new SearchControls(); controls.setReturningAttributes(new String[] { PHONE_ATTRIBUTE }); controls.setSearchScope(SearchControls.SUBTREE_SCOPE); NamingEnumeration users = context.search(BASEDN, '(' + LOGIN_ATTRIBUTE + '=' + username + ')', controls); if (users != null &amp;&amp; users.hasMoreElements()) { SearchResult result = (SearchResult) users.next(); Attribute attribute = result.getAttributes().get( PHONE_ATTRIBUTE); String userPhone = null; if (attribute != null) { userPhone = ((String) attribute.get()).replace("(", "") .replace(")", ""); } return userPhone; } else { return null; } } finally { if (context != null) { context.close(); } } } }</span></span></code> </pre><br>  Compile, put in <i>$ JIRA_HOME / atlassian-jira / WEB-INF / classes</i> , open the file <i>$ JIRA_HOME / atlassian-jira / WEB-INF / classes / seraph-config.xml</i> and change the line in it <br><pre> <code class="hljs cs">&lt;authenticator <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"com.atlassian.jira.security.login.JiraOsUserAuthenticator"</span></span>/&gt;</code> </pre> <br>  on <br><pre> <code class="hljs cs">&lt;authenticator <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"RemoteAuthenticator"</span></span>/&gt;</code> </pre> <br><br>  After that, you can restart JIRA, configure Kerberos authentication in your favorite browser, and test its functionality.  For non-domain computers, a BASIC authorization window should appear, so that they can also log in (if they have AD accounts). <br><br><h4>  Service </h4><br>  In addition, a service was written that periodically synchronizes users in AD and JIRA and adds a text label to the names of those that are not in AD.  Here is its code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Properties; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Random; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.NamingEnumeration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.Attribute; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.DirContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.InitialDirContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.SearchControls; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.naming.directory.SearchResult; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.configurable.ObjectConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.configurable.ObjectConfigurationException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.core.user.preferences.Preferences; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.ComponentManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.event.user.UserEventType; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.service.AbstractService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.user.preferences.UserPreferencesManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.atlassian.jira.user.util.UserUtil; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.opensymphony.<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.propertyset.PropertySet; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.opensymphony.user.Group; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.opensymphony.user.User; <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"deprecation"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Importer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   LDAP private final String ADDRESS_NAME = "java.naming.provider.url"; private String ADDRESS_VALUE = "ldap://127.0.0.1:389"; // DN    private final String LOGIN_NAME = "java.naming.security.principal"; private String LOGIN_VALUE = "cn=test,ou=users,dc=local,dc=domain"; //   private final String PASSWORD_NAME = "java.naming.security.credentials"; private String PASSWORD_VALUE = "password"; //  DN private final String BASE_NAME = "baseDN"; private String BASE_VALUE = "ou=users,dc=local,dc=domain"; //   private final String LOGIN_ATTR_NAME = "userLoginAttribute"; private String LOGIN_ATTR_VALUE = "mail"; //   (  ,  ) private final String NAME_ATTR_NAME = "userNameAttribute"; private String NAME_ATTR_VALUE = "displayName"; //    (  ,   + @ +  // ) private final String MAIL_ATTR_NAME = "userMailAttribute"; private String MAIL_ATTR_VALUE = "mail"; //   private final String PHONE_ATTR_NAME = "userPhoneAttribute"; private String PHONE_ATTR_VALUE = "telephoneNumber"; //   private final String DOMAIN_NAME = "userMailDomain"; private String DOMAIN_VALUE = "local.domain"; //   private final String FILTER_NAME = "userFilter"; private String FILTER_VALUE = "(objectClass=user)"; // ,     private final String FIRED_STRING_NAME = "firedString"; private String FIRED_STRING_VALUE = "z_fired"; @Override public void init(PropertySet properties) throws ObjectConfigurationException { super.init(properties); for (Object keyObject : properties.getKeys()) { String key = (String) keyObject; if (key.equals(ADDRESS_NAME)) { ADDRESS_VALUE = properties.getString(key); } else if (key.equals(LOGIN_NAME)) { LOGIN_VALUE = properties.getString(key); } else if (key.equals(PASSWORD_NAME)) { PASSWORD_VALUE = properties.getString(key); } else if (key.equals(BASE_NAME)) { BASE_VALUE = properties.getString(key); } else if (key.equals(NAME_ATTR_NAME)) { NAME_ATTR_VALUE = properties.getString(key); } else if (key.equals(LOGIN_ATTR_NAME)) { LOGIN_ATTR_VALUE = properties.getString(key); } else if (key.equals(MAIL_ATTR_NAME)) { MAIL_ATTR_VALUE = properties.getString(key); } else if (key.equals(PHONE_ATTR_NAME)) { PHONE_ATTR_VALUE = properties.getString(key); } else if (key.equals(DOMAIN_NAME)) { DOMAIN_VALUE = properties.getString(key); } else if (key.equals(FILTER_NAME)) { FILTER_VALUE = properties.getString(key); } else { FIRED_STRING_VALUE = properties.getString(key); } } } @Override public ObjectConfiguration getObjectConfiguration() throws ObjectConfigurationException { return this; } @Override public void run() { try { importUsers(); checkUsers(); } catch (Exception exception) { exception.printStackTrace(); } } //    AD   JIRA private void importUsers() throws Exception { DirContext context = null; try { Properties properties = new Properties(); properties.put(ADDRESS_NAME, ADDRESS_VALUE); properties.put(LOGIN_NAME, LOGIN_VALUE); properties.put(PASSWORD_NAME, PASSWORD_VALUE); properties.put("java.naming.factory.initial", "com.sun.jndi.ldap.LdapCtxFactory"); ComponentManager componentManager = ComponentManager.getInstance(); UserPreferencesManager preferencesManager = componentManager .getUserPreferencesManager(); UserUtil userUtil = componentManager.getUserUtil(); context = new InitialDirContext(properties); SearchControls controls = new SearchControls(); controls.setReturningAttributes(new String[] { "distinguishedName", LOGIN_ATTR_VALUE, NAME_ATTR_VALUE, MAIL_ATTR_VALUE, PHONE_ATTR_VALUE }); controls.setSearchScope(SearchControls.SUBTREE_SCOPE); NamingEnumeration users = context.search(BASE_VALUE, FILTER_VALUE, controls); while (users != null &amp;&amp; users.hasMoreElements()) { SearchResult result = (SearchResult) users.next(); Attribute attribute = result.getAttributes().get( LOGIN_ATTR_VALUE); if (userUtil.getUser((String) attribute.get()) != null) { //     JIRA continue; } String login = ((String) attribute.get()).toLowerCase(); attribute = result.getAttributes().get(NAME_ATTR_VALUE); String userName; if (attribute != null) { userName = (String) attribute.get(); } else { userName = login; } attribute = result.getAttributes().get(MAIL_ATTR_VALUE); String userMail; if (attribute != null) { userMail = (String) attribute.get(); } else { userMail = login.replace(' ', '.') + '@' + DOMAIN_VALUE; } attribute = result.getAttributes().get(PHONE_ATTR_VALUE); String userPhone = null; if (attribute != null) { userPhone = ((String) attribute.get()).replace("(", "") .replace(")", ""); } String userDN = (String) result.getAttributes() .get("distinguishedName").get(); //    String userPassword = Integer.toHexString(new Random() .nextInt()); //   User user = userUtil.createUserWithEvent(login, userPassword, userMail, userName, UserEventType.USER_CREATED); if (userPhone != null) { preferencesManager.getPreferences(user).setString( UserUtil.META_PROPERTY_PREFIX + "mobile", userPhone); } /* *     JIRA, *   AD,    */ int index = userDN.indexOf("OU=") + 3; String groupName = "[AD] " + userDN.substring(index, userDN.indexOf(',', index)); Group group = userUtil.getGroup(groupName); if (group != null) { userUtil.addUserToGroup(group, user); } } } finally { if (context != null) { context.close(); } } } //     ,    AD private void checkUsers() throws Exception { DirContext context = null; try { Properties properties = new Properties(); properties.put(ADDRESS_NAME, ADDRESS_VALUE); properties.put(LOGIN_NAME, LOGIN_VALUE); properties.put(PASSWORD_NAME, PASSWORD_VALUE); properties.put("java.naming.factory.initial", "com.sun.jndi.ldap.LdapCtxFactory"); ComponentManager componentManager = ComponentManager.getInstance(); UserPreferencesManager preferencesManager = componentManager .getUserPreferencesManager(); UserUtil userUtil = componentManager.getUserUtil(); context = new InitialDirContext(properties); SearchControls controls = new SearchControls(); controls.setReturningAttributes(new String[] { PHONE_ATTR_VALUE }); controls.setSearchScope(SearchControls.SUBTREE_SCOPE); for (User user : userUtil.getAllUsers()) { NamingEnumeration users = context.search(BASE_VALUE, "(&amp;(" + LOGIN_ATTR_VALUE + '=' + user.getName() + ')' + FILTER_VALUE + ')', controls); if (users == null || !users.hasMore()) { //    AD if (!user.getFullName().startsWith(FIRED_STRING_VALUE)) { user.setFullName(FIRED_STRING_VALUE + ' ' + user.getFullName()); } } else { Preferences preferences = preferencesManager. getPreferences(user); String phone = preferences.getString( UserUtil.META_PROPERTY_PREFIX + "mobile"); if (phone == null || phone.isEmpty()) { //        try { Attribute attribute = ((SearchResult) users.next()) .getAttributes().get(PHONE_ATTR_VALUE); if (attribute != null) { phone = ((String) attribute.get()).replace("(", "").replace(")", ""); } if (phone != null) { preferences.setString( UserUtil.META_PROPERTY_PREFIX + "mobile", phone); } } catch (Exception exception) { exception.printStackTrace(System.err); } } } } } finally { if (context != null) { context.close(); } } } @Override public boolean allFieldsHidden() { return false; } @Override public String getName() { return "LDAP Importer"; } @Override public String getDescription() { return "      LDAP    ,    LDAP"; } @SuppressWarnings("rawtypes") @Override public String getDescription(Map params) { return "      LDAP    ,    LDAP"; } @Override public String[] getEnabledFieldKeys() { return new String[] { ADDRESS_NAME, LOGIN_NAME, PASSWORD_NAME, FILTER_NAME, BASE_NAME, LOGIN_ATTR_NAME, NAME_ATTR_NAME, MAIL_ATTR_NAME, PHONE_ATTR_NAME, DOMAIN_NAME, FIRED_STRING_NAME }; } @Override public String getFieldDefault(String key) throws ObjectConfigurationException { if (key.equals(ADDRESS_NAME)) { return ADDRESS_VALUE; } else if (key.equals(LOGIN_NAME)) { return LOGIN_VALUE; } else if (key.equals(PASSWORD_NAME)) { return PASSWORD_VALUE; } else if (key.equals(BASE_NAME)) { return BASE_VALUE; } else if (key.equals(NAME_ATTR_NAME)) { return NAME_ATTR_VALUE; } else if (key.equals(LOGIN_ATTR_NAME)) { return LOGIN_ATTR_VALUE; } else if (key.equals(MAIL_ATTR_NAME)) { return MAIL_ATTR_VALUE; } else if (key.equals(PHONE_ATTR_NAME)) { return PHONE_ATTR_VALUE; } else if (key.equals(DOMAIN_NAME)) { return DOMAIN_VALUE; } else if (key.equals(FILTER_NAME)) { return FILTER_VALUE; } else { return FIRED_STRING_VALUE; } } @Override public String getFieldDescription(String key) throws ObjectConfigurationException { if (key.equals(BASE_NAME)) { return "     DN"; } else if (key.equals(MAIL_ATTR_NAME)) { return "  ,   \" + @ +  \""; } else if (key.equals(FIRED_STRING_NAME)) { return "        LDAP"; } else if (key.equals(NAME_ATTR_NAME)) { return "  ,   "; } return ""; } @Override public String[] getFieldKeys() { return new String[] { ADDRESS_NAME, LOGIN_NAME, PASSWORD_NAME, FILTER_NAME, BASE_NAME, LOGIN_ATTR_NAME, NAME_ATTR_NAME, MAIL_ATTR_NAME, PHONE_ATTR_NAME, DOMAIN_NAME, FIRED_STRING_NAME }; } @Override public String getFieldName(String key) throws ObjectConfigurationException { if (key.equals(ADDRESS_NAME)) { return "  LDAP"; } else if (key.equals(LOGIN_NAME)) { return "  LDAP"; } else if (key.equals(PASSWORD_NAME)) { return "  LDAP"; } else if (key.equals(BASE_NAME)) { return " DN"; } else if (key.equals(NAME_ATTR_NAME)) { return "  "; } else if (key.equals(LOGIN_ATTR_NAME)) { return "  "; } else if (key.equals(MAIL_ATTR_NAME)) { return "  "; } else if (key.equals(PHONE_ATTR_NAME)) { return " "; } else if (key.equals(DOMAIN_NAME)) { return " "; } else if (key.equals(FILTER_NAME)) { return " "; } else { return ""; } } @Override public int getFieldType(String key) throws ObjectConfigurationException { return 0; } @SuppressWarnings("rawtypes") @Override public Map getFieldValues(String key) throws ObjectConfigurationException { return null; } @SuppressWarnings("rawtypes") @Override public void init(Map params) { } @Override public boolean isEnabled(String key) { return true; } @Override public boolean isI18NValues(String key) { return false; } }</span></span></code> </pre><br>  Compiled jar file (using the Jira Plugin SDK) with the service put in <i>$ JIRA_HOME / atlassian-jira / WEB-INF / lib /</i> .  You can add a service in Administration ‚Üí System ‚Üí Services <br><br>  On this all, I hope the information will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/141144/">https://habr.com/ru/post/141144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../141137/index.html">What I would like from future versions of Ruby, and how I cope now</a></li>
<li><a href="../141140/index.html">Overview of the navigation program Progorod for Android</a></li>
<li><a href="../141141/index.html">Three and a half programs for backup</a></li>
<li><a href="../141142/index.html">Asynchronous state machine: ideology and technology</a></li>
<li><a href="../141143/index.html">Let the morning be kind or Sleep as Android</a></li>
<li><a href="../141145/index.html">Radix Tree structure for data compression</a></li>
<li><a href="../141146/index.html">8-bit google maps</a></li>
<li><a href="../141148/index.html">OpenStreetMap News No. 16: a new license and data deletion, OSM is now on site No. 1 in Japan and in the PROGOROD, on-demand map to search for the missing child</a></li>
<li><a href="../141150/index.html">Wikidata: the first new project of the Wikimedia Foundation since 2006</a></li>
<li><a href="../141151/index.html">April 1st on the Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>