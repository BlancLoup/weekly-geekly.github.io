<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Luna. High-speed installation of operating systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. I present to the public a new utility for high-speed bare-metal provisioning in the north. 
 TL; DR 


 Competitor xCAT / Warewulf / Rocks. Use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Luna. High-speed installation of operating systems</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello.  I present to the public a new utility for high-speed bare-metal provisioning in the north. </p><br><h3 id="tldr">  TL; DR </h3><br><p>  Competitor xCAT / Warewulf / Rocks.  Uses BitTorrent to distribute OC images.  Supported OS - RHEL-family.  Debian / Ubuntu is in the works.  The most extensive test at the moment: a cold boot HPC cluster of 512 nodes is performed in 4 minutes.  Automatic detection of node name based on switch-port par. </p><br><p>  Link: <a href="https://github.com/dchirikov/luna">https://github.com/dchirikov/luna</a> </p><br><h3 id="chut-bolshe-detaley">  Slightly more details. </h3><a name="habracut"></a><br><p>  So.  Once, installing the next cluster with the help of xCAT and frustrating to endless post-scripts on the bash, there was a burning desire to write your own and better. </p><br><p>  At first it was a classic pet-project, but now it came out in people, and my company and I have already installed a little less than 10 clusters from 30 to 500 nodes.  The first release that is not a shame to show people we rolled out not so long ago, so there is a reason to show off on Habr√© :) </p><br><p>  Having experience with other systems and communicating with the engineers of customers, I chose 2 killer features: images instead of kickstart and bittorent for casting. </p><br><p>  The first uses, for example, Bright, as well as xCAT for the diskless method.  The idea of ‚Äã‚Äãa torrent I threw one of the customers from Sweden. </p><br><p>  She is brilliant in its simplicity.  An HPC cluster is when we have hundreds of compute nodes with exactly the same configuration.  That is, the image of the system is the same.  Therefore, instead of each node drawing its copy of the operating system from the master server and tearing down the interface to this poor server, let the nodes share what has already been downloaded.  The working images on each node differ slightly: literally the hostname and ip-addresses. </p><br><p> Therefore, we create this image on the master node.  This is done elementary - creating a chroot environment is quite a trivial task.  Then the whole tree is packed in a tarball and pushed into a torrent. <br>  The secret sauce is the dracut module that lies in the initrd.  He knows how to communicate with the server (and knows how to find it from / proc / cmdline), has a self-written lightweight torrent-client, and also knows how to execute simple commands.  Literally <code>curl | bash</code>  <code>curl | bash</code> .  Frequently asked question: ‚ÄúDoes a torrent client always work?‚Äù  Answer: "No, only when loading, before pivotroot, all services related to the luna module stop their work." </p><br><p>  Why do we need to load the nodes quickly?  First of all, this beauty ^ W reduces the time to put the cluster into operation.  For a rather limited installation time, we have the opportunity to conduct many tests with different parameters and configs.  HPC is a thing in itself.  If you run HPL (Linpack) on 4 nodes, it‚Äôs not at all a fact that it will start at 400. Secondly, the customer can only enable the nodes when there is work for them.  And for loading it is not necessary to wait for half an hour: the load time does not depend on the size of the task set in the scheduler (Slurm, for example).  There is no more difference to turn on 2 nodes or 100. </p><br><p>  Using OS images also reduces pain when experimenting with a cluster ‚Äî all those packages and configs that are installed in the chroot environment will be on the node.  There are no more surprises when xCAT sly refused to install a package or simply fell off for an unknown reason. <br>  Moreover, it is possible to configure the node and "grab" it into an image.  Therefore, installing drivers or some kind of exotic packages that will definitely serve up RDMA devices during installation is greatly facilitated. </p><br><h3 id="tehnicheskie-detali">  Technical details. </h3><br><p>  If it‚Äôs still interesting, I‚Äôll go further on technical details, utilities and architecture. </p><br><p>  <code>luna</code> is the main configuration utility.  She has a bunch of sub-objects.  I will describe the main and, approximately in that order in which it is necessary to start what to configure a cluster. </p><br><p>  <code>luna cluster</code> - I decided to abandon text configs, so everything that is expected to be seen in configs is configured here: port ranges, directory for storing files, network for dhcp, etc. </p><br><p>  <code>luna network</code> - <code>luna network</code> description.  Networks are assigned to interfaces in groups, which, in turn, are assigned to nodes. </p><br><p>  <code>luna osimage</code> is an operating system image.  Describes the path to the directory tree.  Includes the version and kernel parameters to load.  Also stores the exclude-list for "grabbing" the node. </p><br><p>  <code>luna group</code> - description of node groups.  As I said, the nodes have little individuality, so the basic configuration occurs here.  Interfaces are created (for example, em2), a network is assigned, additional parameters are written which go to the ifcfg-em2 file.  BMC / IPMI parameters are assigned.  There are also 3 types of scripts: pre-, part-, post-.  These are ordinary bash scripts that are executed at different stages of the installation. </p><br><p>  The first is rarely used.  In theory, here can be described something that should be executed before configuring the node.  This could be, for example, a BMC reboot or BIOS firmware (however, I strongly do not recommend this!). </p><br><p>  part-script - from partitioning.  Its purpose is to configure disks (if any) and mount them under / sysroot.  If there are no disks, then mount tmpfs.  After everything is mounted, the image of the OS will boot and unfold. </p><br><p>  post-script - write fstab, install grub and all that.  At this stage, we can chroot-nuty in / sysroot and do what we need is no longer in a dracut-environment, but, practically, in a full-featured OC. </p><br><p>  Yes, I forgot to mention that the dracut module brings up the network interfaces and the ssh daemon, so it can be used as a rescue environment.  Most binaries and utilities are available: awk, sed, parted, etc.  Moreover, there is a <code>service</code> mode when a node is not trying to load an image, but remains in dracut. </p><br><p>  The last object I would like to mention is the <code>luna node</code> .  Here individual parameters of the node are configured: name, ip-addresses, mac-address, switch and port in which the node is connected. </p><br><p>  About the mac-address is to say more in detail.  In fact, this is the central identifier of the node.  But manually typing 6 octets for a thousand nodes is very sad.  Therefore, there are 2 other destination modes.  One - when the admin can choose the name of the node from the list at startup.  Luna uses iPXE so it‚Äôs possible to write fairly advanced menus.  The second method is to assign the switch and port to the node.  That is, for example, any node connected to the first port of the first switch will be named as node001 and its mac address will be written into the database.  By the way, MongoDB is used as the base. </p><br><p>  In addition to <code>luna</code> , there are several executable files: </p><br><p>  Lweb is a web service that distributes tasks (bash scripts) and boot menus.  They are sent for execution on nodes.  lweb includes a torrent tracker.  All traffic is localized inside the cluster - nothing leaks out. <br>  ltorrent - torrent- "server" for distributing images. <br>  lpower - wrapper over ipmitool for quick reload / power on / off node.  Takes logins and passwords from the luna database. <br>  lchroot - wrapper over chroot.  Allowed to quickly "fail" in the chroot OS-image weapon.  In addition, can fake <code>uname -r</code> :) </p><br><pre> <code class="hljs ruby">[root@master ~]<span class="hljs-comment"><span class="hljs-comment"># uname -r 3.10.0-327.36.1.el7.x86_64 [root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@master</span></span></span><span class="hljs-comment"> ~]# lchroot compute IMAGE PATH: /opt/luna/os/compute chroot [root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@compute</span></span></span><span class="hljs-comment"> /]$ uname -r 4.8.10-1.el7.elrepo.x86_64</span></span></code> </pre> <br><p>  Uff ... Perhaps that's all.  I can say what is planned next. </p><br><ul><li>  Performance.  At this memo, working with the database is far from the most efficient way.  This does not affect the loading of the node, but it does affect the CLI.  Therefore, there is work to do. </li><li>  My colleague prepared a pull-request with Ubuntu support.  Most likely we will add. </li><li>  Change the logic of working with interfaces.  They are sometimes strange and unnerving me :) </li><li>  Add more tests.  The project has already come out of toddlers, so you should use the best practices. </li><li>  We think about restricting BitTorrent traffic between switches.  So far everything is working, but who knows when exascale will fall on us :) </li></ul><br><p>  Ps why luna?  <a href="https://www.youtube.com/watch%3Fv%3DDk2Vyh5PRcQ">Therefore</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/324750/">https://habr.com/ru/post/324750/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324738/index.html">Beautiful forms for receiving bank cards with CardInfo.js</a></li>
<li><a href="../324740/index.html">Making a free SSL certificate in 2017</a></li>
<li><a href="../324742/index.html">Designing animation or how I got involved in a design adventure</a></li>
<li><a href="../324746/index.html">Undocumented features of Windows: we hide changes in the registry from programs that work with an inactive registry</a></li>
<li><a href="../324748/index.html">More than React: Why not use ReactJS for complex interactive front-end projects</a></li>
<li><a href="../324756/index.html">Java and Docker: everyone should know</a></li>
<li><a href="../324758/index.html">Orienteer: overview of the platform and the latest release updates</a></li>
<li><a href="../324760/index.html">Visualization of attacks based on ELK (elasticsearch, kibana, logstash)</a></li>
<li><a href="../324762/index.html">Gamedev for dummies or how to make a game alone</a></li>
<li><a href="../324764/index.html">‚ÄúSmall yes remote‚Äù: scientists have developed a flow battery that cools the chips</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>