<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cisco Unequal Load Balancing with two providers, NAT and static gateways</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The topic may be beaten. But the solution to the problem with the specified source data is not found. Poke your nose, if not right. I had to do some t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cisco Unequal Load Balancing with two providers, NAT and static gateways</h1><div class="post__text post__text-html js-mediator-article">  The topic may be beaten.  But the solution to the problem with the specified source data is not found.  Poke your nose, if not right.  I had to do some tricks ;-). <br><br><h4>  Formulation of the problem </h4><br>  In one city, N-ke has a small network with two providers connected to a Cisco router.  IOS 12.2 (33).  After the next expansion of the channels, we take 8 Mbit from the " <i>First</i> " provider, and 4 Mbit from the " <i>Second</i> ". <br><br>  Dynamic routing with providers is not and is not expected. <br>  Users NAT to provider-dependent IP addresses. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is necessary to maximize both channels. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/672/544/621/672544621060971cbbcc68dcf95f18fc.png" alt="image"><br><br><a name="habracut"></a><br><br><h5>  Initial configuration </h5><br><br> <code>interface FastEthernet0/0 <br> ip address 192.168.1.2 255.255.255.252 <br> <br> interface FastEthernet1/0 <br> ip address 192.168.2.2 255.255.255.252 <br> <br> ip route 0.0.0.0 0.0.0.0 192.168.1.1 <br> ip route 0.0.0.0 0.0.0.0 192.168.2.1 <br> <br> route-map FirstNAT permit 10 <br> match interface FastEthernet0/0 <br> route-map SecondNAT permit 10 <br> match interface FastEthernet1/0 <br> <br> ip nat source route-map FirstNAT interface FastEthernet0/0 overload <br> ip nat source route-map SecondNAT interface FastEthernet1/0 overload <br></code> <br><br><h4>  Search solutions </h4><br><br>  Anyone who does not like this part, please immediately to the decision. <br><br>  Having two equal gateways, the traffic is split in half between the providers.  With heavy traffic (on the <i>Second</i> ‚Äúshelf‚Äù of 4 Mbit), the <i>First</i> download does not rise above 5 Mbit. <br><br>  After reading helpful documentation from cisco.com: <br><br>  - How does load balancing work? <br>  How does the Load Path Balancing (Variance) Work in IGRP and EIGRP? <br>  - Troubleshooting Cisco Express Forwarding Load Balancing Over Parallel Links <br><br>  We find an interesting <b>show ip cef {prefix} internal</b> command. <br> <code>Router# sh ip cef 0.0.0.0 0.0.0.0 internal <br> !----cut---- <br> Load distribution: 0 1 0 1 0 1 0 1 0 1 0 1 0 1 0 1 (refcount 1) <br> <br> Hash OK Interface Address Packets <br> 1 Y FastEthernet1/0 192.168.2.1 0 <br> 2 Y FastEthernet0/0 192.168.1.1 0 <br> 3 Y FastEthernet1/0 192.168.2.1 0 <br> 4 Y FastEthernet0/0 192.168.1.1 0 <br> 5 Y FastEthernet1/0 192.168.2.1 0 <br> 6 Y FastEthernet0/0 192.168.1.1 0 <br> 7 Y FastEthernet1/0 192.168.2.1 0 <br> 8 Y FastEthernet0/0 192.168.1.1 0 <br> 9 Y FastEthernet1/0 192.168.2.1 0 <br> 10 Y FastEthernet0/0 192.168.1.1 0 <br> 11 Y FastEthernet1/0 192.168.2.1 0 <br> 12 Y FastEthernet0/0 192.168.1.1 0 <br> 13 Y FastEthernet1/0 192.168.2.1 0 <br> 14 Y FastEthernet0/0 192.168.1.1 0 <br> 15 Y FastEthernet1/0 192.168.2.1 0 <br> 16 Y FastEthernet0/0 192.168.1.1 0 <br> !----cut---- <br></code> <br><br>  It can be seen that in the CEF there are 16 buckets (seats / slots / buckets) that are filled with routes to the specified network from the Routing Table (RIB). <br><br>  Here it is a tool with which you can control the proportion of <b>outgoing</b> traffic.  And when using NAT to the addresses of the provider, and the <b>incoming</b> ! <br><br>  In our problem, the traffic ratio should be 2: 1.  It is necessary that the <i>First</i> Provider was indicated by two routes, and the <i>Second</i> - by one.  It is necessary, just to register a fictitious route on the <i>First</i> Provider. <br><br>  Hint appeared here <br>  <a href="http://blog.ioshints.info/2007/02/unequal-load-split-with-static-routes.html">blog.ioshints.info/2007/02/unequal-load-split-with-static-routes.html</a> <br><br>  In the prompt, the providers are connected via the Serial interface and one route is registered via the IP address, the second through the interface.  In the version with FastEthernet, this focus does not work, the network is not point-to-point and needs next-hop IP. <br><br>  I tried to cheat.  I registered the default route to a non-existent address, plus added a route to this address through the <i>First</i> Provider: <br><br> <code>ip route 0.0.0.0 0.0.0.0 172.16.1.1 <br> ip route 172.16.1.1 255.255.255.255 192.168.1.1 <br></code> <br><br>  Focus did not pass, cef figured out by recursion that it would still be sent to 192.168.1.1.  The picture has not changed. <br><br><h4>  Decision </h4><br>  So, one route in the direction of each provider already exists.  It is necessary to add one more fictitious route in the direction of the <i>First</i> Provider. <br><br>  To do this, we configure a dummy subnet on the <i>First</i> Provider interface and a dummy gateway: <br><br> <code>interface FastEthernet 0/0 <br> ip address 172.16.1.2 255.255.255.252 secondary <br> ip route 0.0.0.0 0.0.0.0 172.16.1.1 <br></code> <br>  The route will appear, but the traffic will go nowhere, since the <i>First</i> Provider does not have the address 172.16.1.1. <br><br>  Now, <b>attention</b> , everyday cunning ;-).  We look at the real MAC address of the gateway of the first provider and write it into the static ARP entry. <br><br> <code>arp 172.16.1.1 XXXX.XXXX.XXXX arpa <br></code> <br><br>  That's it, the trick is over.  The route is fictitious, but the real traffic goes to the real <i>First</i> Provider. <br><br> <code>Router# sh ip cef 0.0.0.0 0.0.0.0 internal <br> !----cut---- <br> Load distribution: 0 1 2 0 1 2 0 1 2 0 1 2 0 1 2 (refcount 1) <br> <br> Hash OK Interface Address Packets <br> 1 Y FastEthernet1/0 192.168.2.1 0 <br> 2 Y FastEthernet0/0 192.168.1.1 0 <br> 3 Y FastEthernet0/0 172.16.1.1 0 <br> 4 Y FastEthernet1/0 192.168.2.1 0 <br> 5 Y FastEthernet0/0 192.168.1.1 0 <br> 6 Y FastEthernet0/0 172.16.1.1 0 <br> 7 Y FastEthernet1/0 192.168.2.1 0 <br> 8 Y FastEthernet0/0 192.168.1.1 0 <br> 9 Y FastEthernet0/0 172.16.1.1 0 <br> 10 Y FastEthernet1/0 192.168.2.1 0 <br> 11 Y FastEthernet0/0 192.168.1.1 0 <br> 12 Y FastEthernet0/0 172.16.1.1 0 <br> 13 Y FastEthernet1/0 192.168.2.1 0 <br> 14 Y FastEthernet0/0 192.168.1.1 0 <br> 15 Y FastEthernet0/0 172.16.1.1 0 <br> !----cut---- <br></code> <br><h5>  Same meaning but without tricks </h5><br>  Agree with the <i>First</i> provider about secondary addresses.  Then it remains to register two routes for two provider IP addresses. <br><br><h4>  findings </h4><br>  In this way, you can control the proportion of incoming / outgoing traffic in the very ordinary way of connecting to several providers.  And do not need BGP, AS, PI addresses. <br><br>  The cons are also obvious: <br>  - There are a few options for proportion. <br>  - It is impossible to manage the traffic of connections established from the Internet. <br>  - when changing the MAC on the provider's gateway, we get a blackhole. <br><br>  PS Later I found an article <a href="http://blog.ronix.net.ua/2008/10/ciso.html">blog.ronix.net.ua/2008/10/ciso.html</a> with the same meaning, but without the trick with the ARP record. <br><br>  <b>UPD</b> <br><br>  Habrouser <a href="https://geektimes.ru/users/fedia/" class="user_link">Fedia</a> correctly noted that I was wrong.  This way you can control the number of sessions (TCP in the main) in the direction of each provider, and not incoming traffic. <br><br>  <b>Fedia</b> : <br>  And due to the fact that cef with two routes will divide traffic in half - this is not quite true.  It will divide the initialization of the sessions (either by packets, or by destination, or by the source-destination pair, it may even divide by ports), but not the traffic count itself.  Those.  It may be (by default, he divides NOT into packages), that the sessions are equal, and there is 2-3 times more traffic on one provider. <br><br>  But I have a lot of users and each consumes a little.  So the proportion by the number of sessions, in my case, practically corresponds to the projection of incoming traffic. </div><p>Source: <a href="https://habr.com/ru/post/77383/">https://habr.com/ru/post/77383/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../77373/index.html">Sensor Examples for Windows 7</a></li>
<li><a href="../77375/index.html">KDE Software Compilation 4.4 Beta1 Released</a></li>
<li><a href="../77377/index.html">Perfect Bureaucrat</a></li>
<li><a href="../77380/index.html">Wappalyzer began to recognize popular CMS in Russia</a></li>
<li><a href="../77382/index.html">Apache Maven Basics</a></li>
<li><a href="../77384/index.html">The Japanese company Panasonic is preparing to stop the conveyor belt in 2010 with the iconic labor tool of DJs - Technics vinyl players.</a></li>
<li><a href="../77385/index.html">WimaxYota for 2.6.31-14-generic (netbook Remix ubuntu 9.10, intel 5150)</a></li>
<li><a href="../77386/index.html">Pleasant trifle for habracheloveka</a></li>
<li><a href="../77389/index.html">Easter egg in a notebook and calculator</a></li>
<li><a href="../77390/index.html">We buy Microsoft products with a 40% discount</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>