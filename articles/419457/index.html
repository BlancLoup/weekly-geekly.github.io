<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RabbitMQ - SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A week or two ago, I saw a message on the RabbitMQ Users forum about how to get messages sent from SQL Server to RabbitMQ. Since we are working closel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RabbitMQ - SQL Server</h1><div class="post__text post__text-html js-mediator-article">  A week or two ago, I saw a <a href="https://groups.google.com/forum/">message</a> on the <a href="https://groups.google.com/forum/">RabbitMQ Users</a> forum about how to get messages sent from SQL Server to RabbitMQ.  Since we are working closely with this at <a href="http://www.nielsberglund.com/Derivco">Derivco</a> , I left some suggestions there and also said that I was writing a blog post about how this can be done.  Part of my message was not entirely correct - at least until this point (sorry, Bro, was very busy). <br><br>  Awesome stuff, this is your <b>SQL Server</b> .  With it, it is very easy to put information into a database.  Retrieving data from a database using a query is just as easy.  But getting just the updated or inserted data is already a little more difficult.  Think about real-time events;  A purchase is made - someone needs to be notified at the same moment as soon as this has happened.  Perhaps someone will say that such data should not be pushed out of the database, but from somewhere else.  Of course, the way it is, but quite often we simply have no choice. <br><a name="habracut"></a><br>  We had a task: to send events from the database to the outside for further processing, and the question was how to do it? <br><br><h3>  SQL Server and external communications </h3><br>  During the existence of SQL Server, there have been several attempts to organize communications outside the database;  <b>SQL Server Notification Services</b> (NS), which appeared in SQL Server 2000, and then, in SQL Server 2005, <b>SQL Server Service Broker</b> (SSB) appeared.  I described them in my book <a href="https://www.amazon.com/First-Look-Server-2005-Developers/dp/0321180593/ref%3Dsr_1_1%3Fie%3DUTF8%26qid%3D1486701050%26sr%3D8-1%26keywords%3DA%2BFirst%2BLook%2Bat%2BSQL%2BServer%2B2005%2Bfor%2BDevelopers">A First Look at SQL Server 2005 for Developers</a> , along with Bob Boshman and Dan Sullivan.  NS appeared in SQL Server 2000, as I said, and was redesigned in beta version of SQL Server 2005. However, from the ready-for-sale (RTM) version of SQL Server 2005, NS was <s>cut</s> out completely. <br><blockquote>  <b>Note:</b> If you read the book, you will find a number of features there that were not in the RTM version. </blockquote>  SSB survived, and Microsoft introduced <a href="https://blogs.msdn.microsoft.com/sql_service_broker/2008/11/21/announcing-service-broker-external-activator/">Service Broker External Activator</a> (EA) in the SQL Server 2008 Feature Pack.  It allows SSB to interact outside the local database.  In theory, it sounds good, but in practice it is cumbersome and confused.  We conducted several tests and quickly realized that he was not fulfilling what we needed.  In addition, SSB did not give us the performance that was needed, so we had to invent something else. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  SQLCLR </h3><br>  What we came to as a result was based on the SQLCLR technology.  SQLCLR is a .NET platform embedded in the SQL Server kernel and with its help you can execute .NET code inside the kernel.  Since we are executing .NET code, we are able to do almost everything in a regular .NET application. <br><blockquote>  <b>Note:</b> I wrote ‚Äúalmost‚Äù above, because in fact there are some limitations.  In this context, these restrictions have little effect on what we are going to do. <br></blockquote>  The principle of operation of SQLCLR is as follows: the code is compiled into a dll library, and then this library is registered by means of SQL Server: <br><br>  Build build <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> [RabbitMQ.SqlServer] AUTHORIZATION rmq <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'F:\some_path\RabbitMQSqlClr4.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span>; GO</code> </pre> <br>  <b>Code Snippet 1:</b> Build an absolute path <br><br>  The code performs the following actions: <br><br><ul><li>  <code>CREATE ASSEMBLY</code> - creates an assembly with the given name (no matter what it should be). </li><li>  <code>AUTHORIZATION</code> - Indicates the owner of the assembly.  In this case, rmq is a predefined SQL Server role. </li><li>  <code>FROM</code> - determines where the original assembly is located.  In the <code>FROM</code> , you can also specify the path in binary or UNC formats.  The installation files for this project use a binary representation. </li><li>  <code>WITH PERMISSION_SET</code> - sets permissions.  <code>UNSAFE</code> is the least <code>UNSAFE</code> , and is needed in this case. </li></ul><br><blockquote>  <b>Note:</b> regardless of whether the role or the login name was used in the <code>AUTHORIZATION</code> clause, the appdomain class must be created with the same name as when loading the assembly into the domain.  It is recommended to separate assemblies with different names of appdomain classes so that when one assembly falls, the others do not collapse.  However, if assemblies have dependencies on each other, they cannot be divided into different classes. <br></blockquote>  When the assembly is created, we make the .NET method wrappers in it: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> rmq.pr_clr_PostRabbitMsg @EndpointID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @Message <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> [RabbitMQ.SqlServer].[RabbitMQSqlClr.RabbitMQSqlServer].[pr_clr_PostRabbitMsg]; GO</code> </pre><br>  <b>Code snippet 2:</b> .NET method wrapper <br><br>  The code performs the following actions: <br><br><ul><li>  Creates a T-SQL stored procedure named <code>rmq.pr_clr_PostRabbitMsg</code> that takes two parameters;  <code>@EndpointID</code> and <code>@Message</code> . </li><li>  Instead of the procedure body, an external source is used, which consists of: <br><ul><li>  The assembly is named <code>RabbitMQ.SqlServer</code> , that is, the aggregate we created above in the <b>code snippet 1</b> . </li><li>  Full type (namespace and class): <code>RabbitMQSqlClr.RabbitMQSqlServer</code> </li><li>  Method from the above namespace and class: <code>pr_clr_PostRabbitMsg</code> . </li></ul></li></ul><br>  When the <code>rmq.pr_clr_PostRabbitMsg</code> procedure is <code>rmq.pr_clr_PostRabbitMsg</code> , the <code>pr_clr_PostRabbitMsg</code> method will be called. <br><blockquote>  <b>Note:</b> when creating a procedure, the assembly name is not case-sensitive, unlike the full name of the type and method.  It is not necessary that the name of the procedure being created matches the name of the method.  However, the final data types for the parameters must match. </blockquote>  As I said earlier, we in Derivco need to send data outside of SQL Server, so we use SQLCLR and <a href="http://www.rabbitmq.com/">RabbitMQ</a> (RMQ). <br><br><h3>  RabbitMQ </h3><br>  RMQ is an open source message broker that implements the Advanced Message Queuing Protocol (AMQP) and is written in Erlang. <br><br>  Since RMQ is a message broker, AMQP client libraries are required to connect to it.  The application refers to the client libraries and with their help opens the connection and sends messages - such as, for example, a call is made through ADO.NET to SQL Server.  But unlike ADO.NET, where, most likely, the connection is opened each time the database is accessed, the connection remains open during the entire period of the application. <br><br>  Thus, in order to be able to interact from the database with RabbitMQ we need the application and the client .NET library for RabbitMQ. <br><blockquote>  <b>Note:</b> In the following part of this article, RabbitMQ code snippets will appear, but without detailed explanations of what they do.  If you are new to working with RabbitMQ, then I suggest looking at various <a href="http://www.rabbitmq.com/getstarted.html">RabbitMQ lessons</a> to understand the purpose of the code.  <a href="http://www.rabbitmq.com/tutorials/tutorial-one-dotnet.html">Hello World</a> C # tutorial is a good start.  One of the differences between textbooks and code examples is that the examples do not declare exchangers.  It is assumed that they are predetermined. </blockquote><h3>  RabbitMQ.SqlServer </h3><br>  <b>RabbitMQ.SqlServer</b> is an assembly that uses the client .NET library for RabbitMQ and provides the ability to send messages from the database to one or several RabbitMQ endpoints (VHosts and exchangers).  The code can be downloaded / posted from my <a href="https://github.com/nberglund/RabbitMQ-SqlServer">RabbitMQ-SqlServer repository</a> on GitHub.  It contains source codes of assembly and installation files (i.e. you do not have to compile them yourself). <br><blockquote>  <b>Note:</b> this is just an example to show how SQL Server can interact with RabbitMQ.  This is NOT a finished product and not even a part of it.  If this code breaks your brain you don‚Äôt have to blame me, for this is just an example. <br></blockquote><h3>  Functionality </h3><br>  When the assembly is loaded, or when its initialization is explicitly called, or indirectly, when the wrapper procedure is called, the assembly loads the connection string into the local database into which it was installed, as well as the RabbitMQ endpoints to which it is connected: <br><br>  Connection <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InternalConnect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { connFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionFactory(); connFactory.Uri = connString; connFactory.AutomaticRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; connFactory.TopologyRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; RabbitConn = connFactory.CreateConnection(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; channels; x++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = RabbitConn.CreateModel(); rabbitChannels.Push(ch); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  <b>Snippet code 3:</b> connect to the endpoint <br><br>  At the same time, part of the connection to the endpoint also creates IModels on the connection, and they are used when sending (adding to the queue) messages: <br><br>  Posting a message <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> exchange, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] msg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> topic</span></span></span><span class="hljs-function">)</span></span> { IModel <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> channelTryCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((!rabbitChannels.TryPop(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) &amp;&amp; channelTryCount &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>) { channelTryCount += <span class="hljs-number"><span class="hljs-number">1</span></span>; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (channelTryCount == <span class="hljs-number"><span class="hljs-number">100</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errMsg = <span class="hljs-string"><span class="hljs-string">$"Channel pool blocked when trying to post message to Exchange: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{exchange}</span></span></span><span class="hljs-string">."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(errMsg); } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.BasicPublish(exchange, topic, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, msg); rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  The <code>Post</code> method is called from the <code>pr_clr_PostRabbitMsg(int endPointId, string msgToPost)</code> method <code>pr_clr_PostRabbitMsg(int endPointId, string msgToPost)</code> , which was presented as a procedure using the <code>CREATE PROCEDURE</code> clause in code snippet 2: <br><br>  Post call method <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pr_clr_PostRabbitMsg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> endPointId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msgToPost</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(endPointId == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">"EndpointId cannot be 0"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isInitialised) { pr_clr_InitialiseRabbitMq(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = Encoding.UTF8.GetBytes(msgToPost); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (endPointId == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rep <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> remoteEndpoints) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exch = rep.Value.Exchange; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> topic = rep.Value.RoutingKey; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pub <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rabbitPublishers.Values) { pub.Post(exch, msg, topic); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { RabbitPublisher pub; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rabbitPublishers.TryGetValue(endPointId, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> pub)) { pub.Post(remoteEndpoints[endPointId].Exchange, msg, remoteEndpoints[endPointId].RoutingKey); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">$"EndpointId: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{endPointId}</span></span></span><span class="hljs-string">, does not exist"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  <b>Code Snippet 5:</b> Method Representation as a Procedure <br><br>  When executing the method, it is assumed that the caller sends the identifier of the end point to which the message is to be sent, and, in fact, the message itself.  If the value -1 is passed as the identifier of the end point, then we iterate over all the points and send a message to each of them.  The message comes in the form of a string from which we get the bytes using <code>Encoding.UTF8.GetBytes</code> .  In a production environment, the <code>Encoding.UTF8.GetBytes</code> call should be replaced with serialization. <br><br><h3>  Installation </h3><br>  To install and run the example, you need all the files in the <code>src\SQL</code> folder.  To install, follow these steps: <br><br><ul><li>  Run the script <code>01.create_database_and_role.sql</code> .  He will create: <br><ul><li>  <code>RabbitMQTest</code> test database, where the assembly will be created. </li><li>  <code>rmq</code> role to be assigned as the owner of the assembly </li><li>  scheme, which will also be called <code>rmq</code> .  In this scheme, various database objects are created. <br></li></ul><br></li><li>  Run the <code>02.create_database_objects.sql</code> file.  He will create: <br><br><ul><li>  table <code>rmq.tb_RabbitSetting</code> , which will store the connection string to the local database. </li><li>  the <code>rmq.tb_RabbitEndpoint</code> table, in which one or several <code>RabbitMQ</code> endpoints will be stored. </li></ul><br></li><li>  In file <code>03.create_localhost_connstring.sql</code> change the value of the <code>@connString</code> variable to the correct connection string to the <code>RabbitMQTest</code> database created in step 1 and run the script. <br></li></ul><br>  Before proceeding, you need to have a running instance of the RabbitMQ broker and VHost (by default, VHost is represented as /).  As a rule, we have several vhost, just for isolation.  This host also needs an exchanger, in the example we use <code>amq.topic</code> .  When your RabbitMQ broker is ready, edit the parameters of the <code>rmq.pr_UpsertRabbitEndpoint</code> procedure, which is in the <code>04.upsert_rabbit_endpoint.sql</code> file: <br><br>  RabbitMQ endpoint <br><br><pre> <code class="cs hljs">EXEC rmq.pr_UpsertRabbitEndpoint @Alias = <span class="hljs-string"><span class="hljs-string">'rabbitEp1'</span></span>, @ServerName = <span class="hljs-string"><span class="hljs-string">'RabbitServer'</span></span>, @Port = <span class="hljs-number"><span class="hljs-number">5672</span></span>, @VHost = <span class="hljs-string"><span class="hljs-string">'testHost'</span></span>, @LoginName = <span class="hljs-string"><span class="hljs-string">'rabbitAdmin'</span></span>, @LoginPassword = <span class="hljs-string"><span class="hljs-string">'some_secret_password'</span></span>, @Exchange = <span class="hljs-string"><span class="hljs-string">'amq.topic'</span></span>, @RoutingKey = <span class="hljs-string"><span class="hljs-string">'#'</span></span>, @ConnectionChannels = <span class="hljs-number"><span class="hljs-number">5</span></span>, @IsEnabled = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  <b>Code Snippet 6:</b> Creating an Endpoint in RabbitMQ <br><br>  At this stage, it is time to deploy the assembly.  There are differences in the deployments for SQL Server versions prior to SQL Server 2014 (2005, 2008, 2008R2, 2012), and for 2014 and higher.  The difference is in the supported version of the CLR.  Before SQL Server 2014, the .NET platform ran in the CLR version 2, and in SQL Server 2014 and higher, version 4 is used. <br><br><h3>  SQL Server 2005 - 2012 </h3><br>  Let's start with the versions of SQL Server that run on CLR 2, since there are some special features there.  We need to deploy the created assembly, and at the same time deploy the Rabbit client .NET library RabbitMQ ( <code>RabbitMQ.Client</code> ).  From our assembly we will refer to the RabbitMQ client library.  Since  we planned to use CLR 2, then our build and <code>RabbitMQ.Client</code> should be compiled based on .NET 3.5.  There are problems. <br><br>  All the latest versions of <code>RabbitMQ.Client</code> compiled for CLR 4, so they cannot be used in our build.  The latest version of client libraries for CLR 2 is compiled on .NET 3.4.3.  But even if we try to deploy this assembly, we get an error message: <br><br><img src="https://habrastorage.org/webt/db/yo/uj/dbyouj4az0fzhnwpkvtdkgj6i-q.png"><br>  <i><b>Figure 1:</b> System.ServiceModel assembly missing</i> <br><br>  This version of <code>RabbitMQ.Client</code> refers to an assembly that is not part of the CLR SQL Server.  This is a WCF assembly, and this is one of the limitations in SQLCLR that I mentioned above: this particular assembly is intended for those types of tasks that are not allowed to be performed in SQL Server.  The latest versions of <code>RabbitMQ.Client</code> do not have these dependencies, so they can be used without any problems, except for the annoying requirements of the CLR 4 environment. What should I do? <br><br>  As you know, RabbitMQ is open source, well, and we are developers, right?  ;) So let's recompile!  In the version to the latest releases (i.e. version &lt;3.5.0) of <code>RabbitMQ.Client</code> I deleted the references to <code>System.ServiceModel</code> and recompiled.  I had to change a couple of lines of code using the <code>System.ServiceModel</code> functionality, but these were minor changes. <br><br>  In this example, I did not use client version 3.4.3, but took the <a href="https://github.com/rabbitmq/rabbitmq-dotnet-client/tree/stable">stable release 3.6.6</a> and recompiled using .NET 3.5 (CLR 2).  It almost worked :), except that later <code>RabbitMQ.Client</code> releases use <code>Task</code> 'and which are not originally part of .NET 3.5. <br><br>  Fortunately, there is a version of <a href="https://www.nuget.org/packages/System.Threading.dll/"><code>System.Threading.dll</code></a> for .NET 3.5 that includes <code>Task</code> .  I downloaded it, set up links and everything went!  Here the main thing is that <code>System.Threading.dll</code> should be installed along with the assembly. <br><blockquote>  <b>Note: The</b> <code>RabbitMQ.Client</code> source, from which I compiled the version on .NET 3.5, is in my repository on the GitHub <a href="">RabbitMQ Client 3.6.6 .NET 3.5</a> .  The dll binary along with the <code>System.Threading.dll</code> for .NET 3.5 also lies in the <code>lib\NET3.5</code> repository <a href="https://github.com/nberglund/RabbitMQ-SqlServer">(RabbitMQ-SqlServer)</a> . <br></blockquote>  To install the necessary assemblies ( <code>System.Threading</code> , <code>RabbitMQ.Client</code> and <code>RabbitMQ.SqlServer</code> ), run the installation scripts from the <code>src\sql</code> directory in the following order: <br><br><ol><li>  <code>05.51.System.Threading.sql2k5-12.sql</code> - System.Threading </li><li>  <code>05.52.RabbitMQ.Client.sql2k5-12.sql</code> - RabbitMQ.Client </li><li>  <code>05.53.RabbitMQ.SqlServer.sql2k5-12.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  SQL Server 2014+ </h3><br>  In SQL Server 2014 and later, the build is compiled under .NET 4.XX (my example is 4.5.2), and you can refer to any of the latest versions of <code>RabbitMQ.Client</code> , which can be obtained using <a href="https://www.nuget.org/packages/RabbitMQ.Client">NuGet</a> .  In my example, I use 4.1.1.  <code>RabbitMQ.Client</code> , which is also in the <code>lib\NET4</code> <a href="https://github.com/nberglund/RabbitMQ-SqlServer">repository (RabbitMQ-SqlServer)</a> . <br><br>  To install, run the scripts from the <code>src\sql</code> directory in the following order: <br><br><ol><li>  <code>05.141.RabbitMQ.Client.sql2k14+.sql</code> - RabbitMQ.Client </li><li>  <code>05.142.RabbitMQ.SqlServer.sql2k14+.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  SQL method wrappers </h3><br>  To create the procedures that will be used from our assembly (3.5 or 4), run the script <code>06.create_sqlclr_procedures.sql</code> .  It will create T-SQL procedures for the three .NET methods: <br><br><ul><li>  <code>rmq.pr_clr_InitialiseRabbitMq</code> calls <code>pr_clr_InitialiseRabbitMq</code> .  Used to load and initialize the RabbitMQ.SqlServer assembly. </li><li>  <code>rmq.pr_clr_ReloadRabbitEndpoints</code> calls <code>pr_clr_ReloadRabbitEndpoints</code> .  Loads various RabbitMQ endpoints. </li><li>  <code>rmq.pr_clr_PostRabbitMsg</code> calls <code>pr_clr_PostRabbitMsg</code> .  Used to send a message to RabbitMQ. </li></ul><br>  The script also creates a simple T-SQL procedure, <code>rmq.pr_PostRabbitMsg</code> , which is applied to <code>rmq.pr_clr_PostRabbitMsg</code> .  This is a wrapper procedure that knows what to do with the data, handles exceptions, etc.  In a production environment, we have several similar procedures that handle different types of messages.  Read more about this below. <br><br><h3>  Using </h3><br>  From all of the above, we can call <code>rmq.pr_PostRabbitMsg</code> or <code>rmq.pr_clr_PostRabbitMsg</code> to send messages to RabbitMQ, passing the endpoint identifier and the message itself as a string.  All this, of course, cool, but I would like to see how it will work in reality. <br><br>  What we do in production environments ‚Äî in stored procedures that process data that needs to be sent to RabbitMQ, we collect data to send and in the connection block we call a procedure similar to <code>rmq.pr_PostRabbitMsg</code> .  Below is a very simplified example of such a procedure: <br><br>  Data processing procedure <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.pr_SomeProcessingStuff @<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-comment"><span class="hljs-comment">--     DECLARE @endPointId int; --    DECLARE @msg nvarchar(max) = '{' --        SET @msg = @msg + '"Id":' + CAST(@id AS varchar(10)) + ',' --  -  SET @msg = @msg + '"FName":"Hello",'; SET @msg = @msg + '"LName":"World"'; SET @msg = @msg + '}'; -- -  --     -,  -  SELECT @endPointId = 1; --    --     EXEC rmq.pr_PostRabbitMsg @Message = @msg, @EndpointID = @endPointId; END TRY BEGIN CATCH DECLARE @errMsg nvarchar(max); DECLARE @errLine int; SELECT @errMsg = ERROR_MESSAGE(), @errLine = ERROR_LINE(); RAISERROR('Error: %s at line: %d', 16, -1, @errMsg, @errLine); END CATCH END</span></span></code> </pre> <br>  In the <b>code snippet 7,</b> we see how the necessary data is captured and processed in the procedure and sent after processing.  To use this procedure, run script <code>07.create_processing_procedure.sql</code> from the <code>src\SQL</code> directory. <br><br><h3>  Let's run it all </h3><br>  At this point, you should be ready to send several messages.  Before testing, make sure you have queues in RabbitMQ that are attached to the endpoint exchanger at <code>rmq.tb_RabbitEndpoint</code> . <br><br>  So, to start you need to do the following: <br>  Open the file <code>99.test_send_message.sql</code> . <br>  Execute <br><br><pre> <code class="sql hljs">EXEC rmq.pr_clr_InitialiseRabbitMq;</code> </pre> <br>  to initialize the build and load RabbitMQ endpoints.  This is not a required step, but it is recommended to preload the assembly after it is created or modified. <br><br>  Execute <br><br><pre> <code class="sql hljs">EXEC dbo.pr_SomeProcessingStuff @id = 101</code> </pre> <br>  (you can use any other identifier you like). <br><br>  If everything worked out without errors, then a message should appear in the RabbitMQ queue!  So you used SQLCLR to send a message to RabbitMQ. <br><br>  Congrating! </div><p>Source: <a href="https://habr.com/ru/post/419457/">https://habr.com/ru/post/419457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419443/index.html">NASA will fly again to the moon, making all the elements of aircraft</a></li>
<li><a href="../419445/index.html">Unit Tests for Arduino Projects</a></li>
<li><a href="../419449/index.html">Redux vs React Context API</a></li>
<li><a href="../419451/index.html">Step-by-step creating a symfony 4 bundle</a></li>
<li><a href="../419453/index.html">Numerical methods for solving systems of nonlinear equations</a></li>
<li><a href="../419461/index.html">Ventilation of the bathroom with the mind</a></li>
<li><a href="../419467/index.html">From the light bulb to the vacuum cleaner and the drone - as we taught Alice to control hundreds of devices</a></li>
<li><a href="../419469/index.html">UE4 | Cycle day and night | SkySphere modification</a></li>
<li><a href="../419471/index.html">Migration option from jQuery to pure javascript</a></li>
<li><a href="../419473/index.html">How are things in the cloud, and what drives IaaS ahead: discuss technological trends</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>