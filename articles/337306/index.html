<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker Basics in X hours and Y days</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0. Introduction 
 The purpose of this article is to collect a small handful of basic information, minimally enough to start working with the docker on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker Basics in X hours and Y days</h1><div class="post__text post__text-html js-mediator-article"><h3>  0. Introduction </h3><br>  The purpose of this article is to collect a small handful of basic information, minimally enough to start working with the docker on a daily basis and remove locally installed apache, mysql, virtualenv, python3, mongodb, memchaced, redis, php5, php7 and the rest from the working machine. Zoo, which we use in the development, and which often also conflicts with each other from version to version. <br><a name="habracut"></a><br>  And I'm on the bus and the next 7 hours I still have nothing to do.  Well, in addition, I will finally gather in one place links and commands, for which I myself periodically have to go into the documentation, for example - how to add an alias IP to a local host on a poppy: <code>sudo ifconfig lo0 alias 10.200.10.1/24</code> (why would it be necessary said later) <br><br>  The article is called as it is called, because I could not more or less accurately calculate how much time is needed for the task.  It took me about 6 hours in 3 days.  In many ways, because at that moment I worked full time in the office and mastered the docker, so to speak, on the job. <br><br>  It can take you less days or more hours, depending on how hard you go. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But my personal opinion is that it is better not to try to ‚Äúrush in‚Äù in one day.  Just because if you have never dealt with it, then at the end of the first day you will have such a head somewhere. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f61/17b/cb8/f6117bcb89cdff57efc7b8ff367a015d.jpg" alt="image"></div><br>  And it is better to stop at this moment, digest information, maybe even sleep. <br><br><h3>  1. Theory </h3><br>  If you have previously dealt with virtual machines and tools such as virtualbox, vmware, vagrant and similar things, better forget about them. <br>  Personally, my mistake was trying to work with a docker like a virtual machine.  Docker is a means of virtualizing processes, not systems.  An important rule is for each process its own virtual container. <br><br>  The container should be perceived as a separate process and vice versa.  For example, you should not push into one container mysql and redis.  Or worse, the whole bunch of apache + php + mysql. <br><br><h4>  Basic terms </h4><br>  <b>Image (image)</b> - the assembled subsystem necessary for the operation of the process, stored in the image. <br>  <b>Container (container)</b> - the process, initialized on the basis of the image.  That is, the container only exists when running.  It is like an instance of a class, and an image is a type of class.  Well, I think the idea is clear. <br>  <b>Host (host)</b> - the environment in which the docker runs.  Simply put - your local machine. <br>  <b>Volume</b> is the disk space between the host and the container.  Easier - this is a folder on your local machine mounted inside the container.  Change here changes there, and vice versa, miracle. <br>  <b>Dockerfile</b> - a file with a set of instructions for creating an image of the future container <br>  <b>Service</b> is essentially a running image (one or more containers), additionally configured with options such as opening ports, folder mapping (volume), and so on.  This is usually done using the docker-compose.yml file. <br>  <b>Docker-compose</b> (docker-composite, more often a composer, but not to be confused with php composer) is a tool that facilitates the assembly and launch of a system consisting of several containers connected to each other. <br>  <b>Build (build, build)</b> - the process of creating an image from a set of instructions in a doc-file, or several doc files, if the build is done using a composer <br>  In this article later (tomorrow) I will describe the process of building a bunch of nginx + mysql + php7-fpm with examples and descriptions of dockerfile and docker-compose files. <br><br><h4>  Briefly about how image building works </h4><br>  First there is the docker hub, this is such a repository where everyone who wants to assert themselves publishes their own image builds.  For this many thanks a lot, but some don't, everything is just like in any other dump of packages. <br><br>  Usually the dockerfile begins with the <b>FROM</b> instruction, which indicates from which package / image from the hub to start. <br><br>  Next is usually the maintainer instruction, the task of which is to perpetuate the name of the creator of the next brilliant creation. <br><br>  Then the most common commands are: <br>  <b>RUN</b> - executes a command inside the image. <br>  <b>ADD</b> - takes files from the host and puts it inside the image. <br>  And also COPY, EXPOSE, ENTRYPOINT, CMD - you will learn about all this in the process. <br><br>  <b>Now attention.</b>  The docker executes instructions from the dockerfile sequentially over the previous result.  Thus, cache storage is organized. <br>  Not understood?  I'll show you now.  Here is the simplest file file: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ubuntu:latest MAINTAINER igor RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install nginx <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> ./nginx.conf /etc/nginx/ EXPOSE <span class="hljs-number"><span class="hljs-number">80</span></span> CMD [nginx]</code> </pre> <br>  How docker his build: <br><br>  1. download the ubuntu image with the latest tag, save it with ID = aaa <br>  2. take the image of aaa, set it to maintainer = igor, save it with ID = aab <br>  3. take the aab image, launch the container and execute the ‚Äúapt-get update‚Äù command inside, stop the container, the resulting image is saved with ID = aac <br>  4. take an aaC image, launch the container and execute the ‚Äúapt-get install nginx‚Äù command inside, stop the container, the resulting image is saved with ID = aad <br>  5. take the aad image, run the container and copy the ./nginx.conf file (the path is relative to the folder in which the dockerfile is located) inside the container along the path / etc / nginx /, stop the container, the resulting image is saved with ID = aae <br>  ... <br><br>  already understandable? <br><br>  The ID I wrote here is conditional, but it is important to remember that the identifiers of these ‚Äúintermediate‚Äù images are directly related to the instructions themselves, to the files that are added by the ADD instruction and to the ID of the parent image.  That is, in fact, before each step is executed, the ID (hash) of the image is first calculated, the search for such an ID in the local cache, and only if there is no such ID in the cache, then the step is executed and stored in the cache, otherwise the image from the cache is used. <br><br>  And it also means that if you decide to change a command such as <code>run apt-get install nginx</code> to another, then the hash (ID) of the instruction will change and all further cache will not be used after that.  Therefore, do not be surprised if, after changing one letter in the name of the maintainer, your entire assembly will be rebuilt from the very beginning. <br><br>  Also, based on the described command execution script, it becomes clear why there is no point in the instructions to execute commands that do not save anything after my execution - a frequent question on stackoverflow - ‚ÄúI ran something, but in the next instruction it is not running‚Äù.  For example, someone wants to activate source env / bin / activate and in the next instruction execute pip install <br><br><pre> <code class="hljs mel">RUN <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> /app/<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>/bin/activate RUN pip install something</code> </pre><br>  or another example - run mongodb and in the next instruction create a user / database or import the database from a file (there are reasons why it is better not to do this, but this is not about that now) <br><br> <code>RUN service mongodb start <br> RUN mongo db --eval 'db.createUser({user:"dbuser",pwd:"dbpass",roles:["readWrite","dbAdmin"]})' <br></code> <br>  As you can see from the build process, each next container does not know anything about what was started there in the previous step, so these instructions should be combined into one through &amp;&amp;: <br><br> <code>RUN source /app/env/bin/activate \ <br> &amp;&amp; pip install something <br> <br> RUN service mongodb start \ <br> &amp;&amp; RUN mongo db --eval 'db.createUser({user:"",...})' <br></code> <br>  but in general, due to the fact that the containers are isolated, I do not see much sense in using inside tools like nvm, virtualenv, rbenv and similar stuff.  Just put what you need and everything. <br><br>  I think to begin the work of this theory is enough. <br><br><h4>  2. Practice </h4><br>  Before starting, I think I should go take a little rest and make myself a seagull. <br>  And when you return, first install <a href="https://store.docker.com/search%3Foffering%3Dcommunity%26type%3Dedition">Docker</a> and <a href="https://docs.docker.com/compose/overview/">Docker Compose</a> . <br><br>  A small digression for those who read this under Windows. <br><br>  Are you seriously? <br><br>  No, it is of course possible and there are installation files and instructions on the site.  And personally, I have nothing against windows when it comes to home use as a media station.  But if you are developing under Windows, then I simultaneously admire you and condolences.  Frankly, I did not raise the docker under Windows, only under ubuntu and under poppy.  However, I heard the groans of a colleague from a nearby office who tried, and he even managed to run the assembly, but when it came to the symlinks inside the volume, everything was ruined.  Therefore, if you got here in the search for recipes, how to work with Docker under Windows, then I have bad news, here you will not find them. <br><br>  So, at this stage, you already have a docker installed, and in the taskbar, you happily gurgle in blocks of # bluekit (sorry, I could not resist).  Now go here <a href="https://docs.docker.com/get-started/">on this link</a> and go through the Get Started tutorial. <br><br>  Now let's imagine that we are developing a web site in php and will publish it with a bunch of nginx + php7-fpm + mysql. <br><br>  Here is a very primitive dockerfile for the php service: <br><br> <code>FROM php:7-fpm <br> # Install modules <br> RUN apt-get update &amp;&amp; apt-get install -y \ <br> libfreetype6-dev \ <br> libjpeg62-turbo-dev \ <br> libmcrypt-dev \ <br> libpng12-dev \ <br> libicu-dev \ <br> --no-install-recommends <br> RUN docker-php-ext-install mcrypt zip intl mbstring pdo_mysql exif \ <br> &amp;&amp; docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \ <br> &amp;&amp; docker-php-ext-install gd <br> <br> ADD ./php.ini /usr/local/etc/php/ <br> ADD ./www.conf /usr/local/etc/php/ <br> <br> RUN apt-get purge -y g++ \ <br> &amp;&amp; apt-get autoremove -y \ <br> &amp;&amp; rm -r /var/lib/apt/lists/* \ <br> &amp;&amp; rm -rf /tmp/* <br> <br> EXPOSE 9000 <br> CMD ["php-fpm"] <br></code> <br>  In short human language: <br><br><ul><li>  based on php: 7-fpm from hub </li><li>  update ubuntu, deliver php-extensions and tools we need, copy (add) php configs into the image, delete all unnecessary and open port 9000, which will listen to php-fpm </li><li>  the only unfamiliar detail is now the ADD construct, but it is obvious: take the file according to the first argument and put it inside the container along the path specified in the second argument.  The first argument can be an absolute path, a relative path, http or ftp url, and also this path can point to a folder or an archive.  In the case of an archive, it will be unpacked.  See the ADD and COPY documentation for details. </li></ul><br>  With php figured out, now we need to mark the images for the services of nginx and mysql, and also to collect all the services into a complete system. <br><br>  In the case of nginx and mysql, we don‚Äôt even need to write our dockerfile, since we don‚Äôt need to install any additional extensions.  Here‚Äôs what our project‚Äôs docker-compose.yml will look like <br><br> <code>app: <br> build: docker/php/Dockerfile <br> working_dir: /app <br> volumes: <br> - ./:/app <br> expose: <br> - 9000 <br> links: <br> - db <br> nginx: <br> image: nginx:latest <br> ports: <br> - "80:80" <br> volumes: <br> - ./:/app <br> - ./docker/nginx/vhost.conf:/etc/nginx/conf.d/vhost.conf <br> links: <br> - app <br> db: <br> image: mysql:5.7 <br> volumes: <br> - /var/lib/mysql <br> ports: <br> - "3306:3306" <br> environment: <br> MYSQL_ROOT_PASSWORD: root <br> MYSQL_DATABASE: dbname <br> MYSQL_USER: dbuser <br> MYSQL_PASSWORD: dbpassword <br></code> <br>  Here the services app, nginx, db are declared.  The app is assembled from our dockerfile, and the rest simply use images from the hub. <br><br>  The volumes directive mounts the folders from the host machine inside the container, thus configuring nginx and saving the database data on restart. <br>  The links directive binds the services to each other, the app is connected to the db, which means that after running inside the app container, the ‚Äúdb‚Äù host will be available and it will point to the corresponding container. <br><br>  It's simple (irony). <br><br>  There is a rather interesting template <a href="https://github.com/trntv/yii2-starter-kit/">yii2-starter-kit</a> , in the box of which you can find a good implementation of the described assembly php7-fpm nginx mysql as well as mailcatcher. <br><br>  Those who, like me, prefer python and django, you can not even bathe and do everything on the official tutorial from Docker - <a href="https://docs.docker.com/compose/django/">docs.docker.com/compose/django</a> <br>  plus, after you understand how it all works, it will not be difficult to rework any assembly you like to fit your needs. <br><br><h4>  Pitfalls </h4><br>  - MacOS.  Access to the service on the host (for example mongo or mysql) from the container. <br>  Due to the limitations of the ‚ÄúDocker for Mac networking stack‚Äù you cannot ‚Äújust pick up and connect‚Äù to a local host.  But there are two workarounds: <br><br>  a) official and simple (available in the Docker version starting from 17.06) - use a special DNS host to connect (available only on Docker for Mac) docker.for.mac.localhost.  <a href="https://docs.docker.com/docker-for-mac/networking/">Source of</a> <br><br>  b) add an alias IP to the network device lo0: <br>  `sudo ifconfig lo0 alias 10.200.10.1 / 24` <br>  and use this address to connect <br><br>  - MongoDB.  You cannot mount an external drive for data on a Mac.  The reasons are described <a href="https://hub.docker.com/_/mongo/">here.</a> <br>  <i>WARNING (Windows &amp; OS X): The default Docker setup on Windows and OS X.</i>  <i>Unfortunately, there is no need for folders.</i> <br><br>  - Under Windows <a href="https://forums.docker.com/t/symlinks-on-shared-volumes-not-supported/9288/9">, symlinks do not work</a> in mounted volumes.  It is expected, but it is very unpleasant to find out about this after everything else has worked. <br><br>  - Differences between entrypoint and command - <a href="https://stackoverflow.com/questions/21553353/what-is-the-difference-between-cmd-and-entrypoint-in-a-dockerfile">here the difference</a> between entrypoint and command <a href="https://stackoverflow.com/questions/21553353/what-is-the-difference-between-cmd-and-entrypoint-in-a-dockerfile">is described in detail and clearly</a> . <br><br>  - <b>UPD</b> <a href="https://habr.com/ru/post/337306/">addition</a> from <a href="https://habrahabr.ru/users/saskasa/" class="user_link">saskasa</a> : On the <a href="https://habrahabr.ru/users/saskasa/" class="user_link">Mac</a> , the recording speed from the container to the host disk (added as VOLUME) is very slow, for understanding the scale - about 50-100 times. </div><p>Source: <a href="https://habr.com/ru/post/337306/">https://habr.com/ru/post/337306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337294/index.html">About distinguishing objects by color</a></li>
<li><a href="../337298/index.html">In the wake of highloadcup: php vs node.js vs go, swoole vs workerman, splfixedarray vs array and more</a></li>
<li><a href="../337300/index.html">V8 internal mechanisms and fast work with object properties</a></li>
<li><a href="../337302/index.html">git rebase for beginners</a></li>
<li><a href="../337304/index.html">Ransomware hackers hacked more than 26,000 MongoDB servers</a></li>
<li><a href="../337308/index.html">Lannisters always pay their debts! (and technical too)</a></li>
<li><a href="../337310/index.html">Mathematical modeling of traffic flows</a></li>
<li><a href="../337312/index.html">11 free cyrillic fonts</a></li>
<li><a href="../337314/index.html">Object to iterate, iterator and generator</a></li>
<li><a href="../337316/index.html">Accidental deletion of root files</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>