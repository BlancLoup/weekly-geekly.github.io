<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Meteor. Developing a TODO List</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this lesson, I don‚Äôt want to discuss why the meteor is a web killer, especially since I don‚Äôt think so, but I have a certain sympathy for this fram...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Meteor. Developing a TODO List</h1><div class="post__text post__text-html js-mediator-article">  In this lesson, I don‚Äôt want to discuss why the meteor is a web killer, especially since I don‚Äôt think so, but I have a certain sympathy for this framework.  Therefore, I want to show where to start when developing an application on it, what packages are there and in general what this meteor is. <br><br>  Just want to say that I do not have much experience in developing web applications.  I have been doing this for only about two years, and have only been familiar with a meteor for a couple of months. <br><br>  I also want to warn you that the lesson turned out to be quite voluminous, but the code in it was written several times less than the text.  I just want to share my experience on how to use a meteor when creating a simple example, and to focus on various points that I thought were important.  Therefore, the lesson will use many third-party packages that facilitate the development process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And one more warning: in this lesson the following technologies will be used to write the example directly: <br><br><ul><li>  <a href="http://jade-lang.com/">jade</a> - html preprocessor; </li><li>  <a href="http://lesscss.org/">less</a> - css preprocessor; </li><li>  <a href="http://coffeescript.org/">coffeescript</a> is a programming language compiled into javascript. </li></ul><br>  Video demonstrating the application received during the lesson <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ATxB_CzCv8U%3Ffeature%3Doembed&amp;xid=25657,15700023,15700043,15700186,15700191,15700253&amp;usg=ALkJrhik9SsjtxlPKUjK1YJhpYIajtjjtQ" frameborder="0" allowfullscreen=""></iframe><br><br>  And who is still interested, welcome under cat. <br><a name="habracut"></a><br><br><h1>  Meteor installation </h1> The meteor itself is based on <code>nodejs</code> and <code>mongodb</code> , also the meteor does not have Windows support, and if you are going to touch a meteor you need to get a Linux or MacOS operating system. <br><br>  First install <a href="http://nodejs.org/download/">nodejs</a> and <a href="http://www.mongodb.org/downloads">mongodb</a> . <br><br>  The next step is to install a meteor.  It does not lie in the npm repository, so you don‚Äôt need to hurry and command <code>npm install -g meteor</code> , in this case just download the old version, you need to run it in the console to properly install: <br><br><pre> <code class="hljs ruby">$ curl <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/install.meteor.com/</span></span> <span class="hljs-params"><span class="hljs-params">| sh</span></span></code> </pre><br><br><h1>  Project creation </h1>  After installing the meteor, you can immediately command <br><br><pre> <code class="hljs php">$ meteor create <span class="hljs-string"><span class="hljs-string">'todo-list'</span></span> todo-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>: created. To run your <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> app: cd todo-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> meteor $ cd todo-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> $ meteor [[[[[ ~/dev/meteor-getting-started/todo-<span class="hljs-keyword"><span class="hljs-keyword">list</span></span> ]]]]] =&gt; Started proxy. =&gt; Started MongoDB. =&gt; Started your app. =&gt; App running at: http:<span class="hljs-comment"><span class="hljs-comment">//localhost:3000/</span></span></code> </pre><br><br>  This conclusion means that everything went well, and our hello world can be checked in the browser. <br><br><img alt="helloworld" src="https://habrastorage.org/getpro/habr/post_images/c45/793/7ce/c457937ce499ec0552f10c93dbf879a2.png"><br><br>  Now, after checking the performance of the new project, the files that are in the root of the project can be deleted - they are not particularly interesting to us.  You can also notice that the <code>.meteor</code> directory was created, various service information about the project is stored there, and even automatically generated <code>.gitignore</code> .  By the way, for manual package management, you can change the <code>packages</code> file, but console utilities are also quite convenient. <br><br>  If you have the same result as mine, then the minimal environment for developing a project meteor is ready, but if something went wrong, check the <code>nodejs</code> , <code>mongodb</code> and <code>meteor</code> installation, for example, I have the following configuration on my computer now: <br><br><pre> <code class="hljs ruby">$ node -v v<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">10.33</span></span> $ mongod --version db version v2.<span class="hljs-number"><span class="hljs-number">4.12</span></span> $ meteor --version Meteor <span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre><br><br>  Now you can finish with the formalities and proceed to the development of our sheet sheet.  For convenience, I recommend opening a new tab of the console, since restarting our meteor application will no longer be required, but we will use the framework framework for installing packages. <br><br><h1>  Packages </h1>  Here again, I don‚Äôt want to discuss why my pack manager is used in meteor and why they like to ride like that, this has nothing to do with the lesson. <br><br>  Packages are installed by the command <br><br><pre> <code class="hljs pgsql">$ meteor <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> &lt;package-<span class="hljs-type"><span class="hljs-type">name</span></span>&gt;</code> </pre><br><br>  As I wrote above, the application will be developed on <code>less</code> , <code>jade</code> and <code>coffeescript</code> , which means it's time to install them.  All the packages used in the lesson and a bunch of others can be found on the <a href="https://atmospherejs.com/">Atmosphere</a> website.  Actually package names: <br><br><ul><li>  <code>less</code> , <code>coffeescript</code> is official packages, so they do not contain the name of the author; </li><li>  <code>mquandalle:jade</code> - but this is not an official package, so the name consists of two components, but it is well made, and I have not had any problems with its use. </li></ul><br>  <code>sourcemap</code> support is built into the packages of <code>less</code> and <code>coffeescript</code> , so the <code>sourcemap</code> process in the browser will be simple, the <code>sourcemap</code> supported by the meteor itself: it provides the necessary api to connect this functionality, so we don‚Äôt have to customize something. <br><br>  In the course of development, we will add a few more popular packages, and I will try to describe the purpose of each.  By the way, <code>jquery</code> and <code>underscore</code> already included in the meteor, like many other packages, the full list can be found in the <code>./.meteor/versions</code> file in the created project. <br><br><h1>  Application structure </h1>  Now, in my opinion, it's time to figure out how a meteor connects files to a project, and what ways of regulating this exist.  Here we will not need to write configuration files for the <code>grant</code> or <code>gulp</code> to compile the templates, styles and scripts, the meteor has already taken care of this.  For scaffolding there is a <a href="https://github.com/Pent/generator-meteor">project</a> for Yeoman, but it is more pleasant for me to create everything manually.  In the previous project, I used about the following folder structure: <br><br><pre> <code class="hljs 1c">todo-list/ -   ‚îú‚îÄ‚îÄ client -      ‚îÇ ‚îú‚îÄ‚îÄ components -     <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  ‚îÇ ‚îÇ  ,    ‚îÇ ‚îú‚îÄ‚îÄ config -   ‚îÇ ‚îú‚îÄ‚îÄ layouts -  , <span class="hljs-keyword"><span class="hljs-keyword"></span></span>    ‚îÇ ‚îú‚îÄ‚îÄ lib -  ,     ‚îÇ ‚îÇ  ‚îÇ ‚îú‚îÄ‚îÄ routes -   ‚îÇ ‚îî‚îÄ‚îÄ styles -  ‚îú‚îÄ‚îÄ collections -     ‚îú‚îÄ‚îÄ lib - ,     ‚îú‚îÄ‚îÄ public - : , robots.txt    ‚îú‚îÄ‚îÄ server -  <span class="hljs-keyword"><span class="hljs-keyword"></span></span>    ‚îÇ ‚îú‚îÄ‚îÄ methods -    ,  , ‚îÇ ‚îÇ   ‚îÇ ‚îú‚îÄ‚îÄ publications -   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>  ‚îÇ ‚îú‚îÄ‚îÄ routes -  ,    ‚îÇ ‚îÇ  http  ‚îÇ ‚îî‚îÄ‚îÄ startup -  </code> </pre><br><br>  Maybe something will not be useful to us, but in any case, the meteor has no restrictions on the naming of folders and files, so you can think of any structure that is convenient for you.  The main thing to remember about some of the nuances: <br><br><ul><li>  all files from the <code>public</code> folder in the project root will be available to users via links from the browser and will not automatically connect to the project; </li><li>  all files from the <code>server</code> folder are in the root; only the server part of the application is available; </li><li>  all files from the <code>client</code> folder are in the root; only the client part of the application is available; </li><li>  everything else that is in the root is available in any environment; </li><li>  Files in the project are connected automatically, according to the following rules: </li><li>  the download starts from the subdirectories, and the first directory is always processed with the name <code>lib</code> , then all * folders and files are loaded in alphabetical order; </li><li>  files starting with <code>main.</code>  loaded last. </li></ul><br>  For example, consider how our project will be loaded in the browser: first of all, files from the <code>lib</code> directory in the project root will be loaded, the <code>client</code> folder will be further processed, files from <code>lib</code> will be loaded first, and then in alphabetical order: <code>components</code> -&gt; <code>config</code> - &gt; ... -&gt; <code>styles</code> .  And after the files from the <code>collections</code> folder.  Files from the <code>public</code> and <code>server</code> folders will not be loaded into the browser, but, for example, the scripts stored in the <code>public</code> folder can be connected via the <code>script</code> tag, as we used to do in other projects, but the developers of the framework do not recommend this approach. <br><br>  You can also use the following constructs to regulate the runtime in shared files: <br><br><pre> <code class="coffeescript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Meteor.isClient <span class="hljs-comment"><span class="hljs-comment"># ,     if Meteor.isServer # ,    </span></span></code> </pre><br><br>  And we can use the <code>Meteor.startup(&lt;func&gt;)</code> method to control the execution time of scripts, in the browser this is an analogue of the <code>$</code> function from the <code>jQuery</code> library, and on the server, the code in this function will be executed immediately after loading all the scripts in the order of loading these files.  <a href="https://docs.meteor.com/">Learn more about these variables and methods</a> . <br><br><h1>  Basic Application Template </h1>  For the layout, I will use Bootstrap, but I know that he has become boring to everyone, but the layout designer is none of me, and I am less familiar with the bootstrap. <br><br>  To do this, install the package <code>mizzao:bootstrap-3</code> - it is the most popular among others, and I think when using it we should have no problems. <br><br>  Next, create the file <code>head.jade</code> in the <code>client/layouts</code> <code>head.jade</code> .  This will be the only file in our application that does not have a template format, in short, just create a page header, and later we will analyze what templates are. <br><br><pre> <code class="hljs pgsql">//- client/layouts/head.jade head meta(charset=<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) meta(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'viewport'</span></span>, content=<span class="hljs-string"><span class="hljs-string">'width=device-width, initial-scale=1'</span></span>) meta(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'description'</span></span>, content=<span class="hljs-string"><span class="hljs-string">''</span></span>) meta(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'author'</span></span>, content=<span class="hljs-string"><span class="hljs-string">''</span></span>) title Meteor. TODO List.</code> </pre><br><br>  You can open the browser and make sure that after adding the file the page has the specified header. <br><br>  Before we begin to impose, I propose to carry out a basic setting of client routing, and a little later we will analyze this moment in more detail.  For routing, you can use a popular solution that has all the functionality we need.  Install the <code>iron:router</code> package ( <a href="https://github.com/EventedMind/iron-router">repository</a> ). <br><br>  After installation in the <code>client/config</code> directory, create a file <code>router.coffee</code> , with the following content: <br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/config/router.coffee Router.configure layoutTemplate: "application"</span></span></code> </pre><br><br>  Obviously, here we set the basic template for our application, it will be called <code>application</code> .  Therefore, in the <code>layouts</code> folder, create an <code>application.jade</code> file.  In this file we describe the template, some entity, which at the stage of assembling the application will turn into <code>javascript</code> code.  By the way, the meteor uses their own mustache <code>spacebars</code> template and <code>blaze</code> library. <br><br>  In short, the process of working templates looks like this (as far as I understood from the documentation).  <code>spacebars</code> templates <code>spacebars</code> compiled into a <code>blaze</code> library <code>blaze</code> , which will later work directly with the <code>DOM</code> .  In the project description there is a comparison with other popular libraries: <br><br><ul><li>  Compared to regular textual template engines, the Blaze works with the house, it will not re-render the entire template to change one attribute, and it has no problems with nested templates; </li><li>  compared to <code>Ember</code> templates, the Blade renders only changes, there is no need for explicit data-baiting and descriptions of dependencies between the templates; </li><li>  compared to the <code>angular</code> and <code>polymer</code> templates, the Blaze has a clear and simple syntax, a lower entry threshold and is not positioned at all as a technology of the future, but simply works; </li><li>  Compared to <code>React</code> has simple template description syntax and simple data management. </li></ul><br>  I practically translated this paragraph from the official <a href="https://atmospherejs.com/meteor/blaze">description of the</a> library, so please do not throw stones at me if you do not agree with something.  I myself have come across these technologies (except for <code>ember</code> ) and, in principle, agree with the authors of the library, from the minuses in the blaze I want to notice a tie on the meteor. <br><br>  But we in our project do not explicitly use either <code>blaze</code> or <code>spacebars</code> .  For <code>jade</code> templates, the compilation process has the following sequence: <code>jade</code> -&gt; <code>spacebars</code> -&gt; <code>blaze</code> . <br><br>  All patterns in a meteor are described in the <code>template</code> tag, where there should be an attribute with the name of the template.  Remember, we specified <code>layoutTemplate: "application"</code> in the settings of the router, here is the <code>application</code> , which is exactly the name of the template. <br><br>  It seems to have figured out what templates are in a meteor, it's time to impose a page frame, it will consist of a cap and a basement. <br><br><pre> <code class="hljs pgsql">//- client/layouts/application.jade <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'application'</span></span>) nav.navbar.navbar-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.navbar-fixed-top .container .navbar-<span class="hljs-keyword"><span class="hljs-keyword">header</span></span> button.navbar-toggle.collapsed( <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">'button'</span></span>, data-toggle=<span class="hljs-string"><span class="hljs-string">'collapse'</span></span>, data-target=<span class="hljs-string"><span class="hljs-string">'#navbar'</span></span>, aria-expanded=<span class="hljs-string"><span class="hljs-string">'false'</span></span>, aria-controls=<span class="hljs-string"><span class="hljs-string">'navbar'</span></span> ) span.sr-<span class="hljs-keyword"><span class="hljs-keyword">only</span></span> Toggle navigation span.icon-bar span.icon-bar span.icon-bar a.navbar-brand(href=<span class="hljs-string"><span class="hljs-string">'#'</span></span>) TODO List #navbar.collapse.navbar-collapse ul.nav.navbar-nav .container +yield .footer .container p.text-muted TODO List, <span class="hljs-number"><span class="hljs-number">2014.</span></span></code> </pre><br><br>  Here we need to understand that this <code>jade</code> is not quite familiar to us, with its mixins, javascript and includas.  <code>Jade</code> has to compile into a <code>spacebars</code> template, and this imposes some features.  From the <code>jade</code> , we can say we will take only the syntax, the rest we just do not need.  In this template, the <code>+yield</code> construction is used, this construction means that the <code>yield</code> template will be rendered instead, it is a <code>iron:router</code> feature, it will automatically substitute the desired template depending on the path, we will deal with routers a little later, and now we can make cosmetic changes to the layout and look at the result. <br><br><pre> <code class="hljs cmake">// client/styles/main.<span class="hljs-keyword"><span class="hljs-keyword">less</span></span> html { position: relative; min-height: <span class="hljs-number"><span class="hljs-number">100</span></span>%; } body { margin-bottom: <span class="hljs-number"><span class="hljs-number">60</span></span>px; &amp; &gt; .container{ padding: <span class="hljs-number"><span class="hljs-number">60</span></span>px <span class="hljs-number"><span class="hljs-number">15</span></span>px <span class="hljs-number"><span class="hljs-number">0</span></span>; } } .footer { position: absolute; bottom: <span class="hljs-number"><span class="hljs-number">0</span></span>; width: <span class="hljs-number"><span class="hljs-number">100</span></span>%; height: <span class="hljs-number"><span class="hljs-number">60</span></span>px; background-color: <span class="hljs-comment"><span class="hljs-comment">#f5f5f5; .container .text-muted { margin: 20px 0; } }</span></span></code> </pre><br><br>  When changing styles, by the way, you do not need to refresh the page in the browser, it is enough to save the file, and they will immediately be applied, this is a handy tool out of the box for designers of the meteor. <br><br><img alt="my_helloworld" src="https://habrastorage.org/getpro/habr/post_images/935/77b/aef/93577baeffb3ab7edbaa0354e20cfc94.png"><br><br><h1>  Routing </h1>  In the meteor itself, there is no standard routing mechanism, I suggest using the <code>iron:router</code> package, it is <a href="">well documented</a> , actively supported, has rich functionality and is also the most popular routing solution in the context of a meteor. <br><br>  You can also use this library for server routing.  For example, I, on a real project, needed it to authorize users, since the main project was made on <code>Ruby on Rails</code> , and users do not need to think that they are two different applications and authorize them twice.  In general, there are several popular <a href="http://www.meteorpedia.com/read/REST_API">approaches</a> for server routing and creating a REST api for a meteor. <br><br>  Let's create basic routers to see how this library works and what functionality it has, using an example, and later we will hang the main functionality on them. <br><br>  To begin with, let's set links to our pages. <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/- client/layouts</span></span><span class="hljs-regexp"><span class="hljs-regexp">/application.jade /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/- ... #navbar.collapse.navbar-collapse ul.nav.navbar-nav li a(href='/</span></span><span class="hljs-string"><span class="hljs-string">') Home li a(href='</span></span>/about<span class="hljs-string"><span class="hljs-string">') About</span></span></code> </pre><br><br>  We create controllers in the folder of client routers, as long as they are just stubs <br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/routes/home.coffee Router.route '/', name: 'home' class @HomeController extends RouteController action: -&gt; console.log 'Home Controller' super() # client/routes/about.coffee Router.route '/about', name: 'about' class @AboutController extends RouteController action: -&gt; console.log 'About Controller' super()</span></span></code> </pre><br><br>  Two parameters need to be passed to the <code>Router.route</code> function, the first is the path, and the path can be a pattern (for example: <code>/:user/orders/:id/info</code> ), all parameters from the pattern will be available in the controller's object via the <code>params</code> property.  The second parameter is an object with options.  To make all the logic separate from the simple description of the path and name, you can create controllers, in our case they are simple stubs, here we don‚Äôt explicitly specify controller names in the properties, because by default <code>iron:router</code> tries to find a controller named <code>&lt;RouteName&gt;Controller</code> , and of course, our controllers should be accessible globally, we do it in the censcript, binding the variable to the current context, in the usual js, it is enough just to declare the variable not through <code>var</code> . <br><br><blockquote>  By the way, the meteor is not used, for example, <code>amd</code> to download the code, the files are simply loaded in a certain sequence.  Therefore, all interaction between modules described in different files is carried out through global variables.  Which, as for me, is quite convenient, and when using coffee, randomly declaring a global variable is quite difficult, and it will be immediately noticeable. <br></blockquote><br>  <code>iron:router</code> will also try to automatically render the template with the name of the route (but the templates can be specified explicitly), create them <br><br><pre> <code class="hljs pgsql">//- client/components/home/home.jade <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'home'</span></span>) h1 Home //- client/components/about/about.jade <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'about'</span></span>) h1 About</code> </pre><br><br>  You can open the browser and make sure that our routing works by clicking on the links in the header.  And it works without refreshing the page. <br><br><img alt="base_routing" src="https://habrastorage.org/getpro/habr/post_images/8fc/645/9c8/8fc6459c8719c62822ab852440449e35.png"><br><br><blockquote>  In the course of the development of this lesson, I will try to make all changes in the code to the repository, in accordance with the sequence of presentation, so that you can follow the whole process, as in the post some things can be missed.  <a href="https://github.com/ovcharik/meteor-getting-started/commits/master">Repository</a> <br></blockquote><br>  <a href="http://hgsm-base-client-routing.meteor.com/">Here</a> you can see what happened in the end, and <a href="https://github.com/ovcharik/meteor-getting-started/tree/4035f092dc65cee6c93bfb308e890ad7fe17ba27/todo-list">here</a> you <a href="https://github.com/ovcharik/meteor-getting-started/tree/4035f092dc65cee6c93bfb308e890ad7fe17ba27/todo-list">can</a> see the project code in the current state. <br><br><h1>  Users and Authentication </h1>  Many technical assignments that come to our company, the first task describes the system of users.  Since this is a fairly common task, I consider it necessary in our lesson to consider ways to authenticate users, especially the meteor provides standard tools for this. <br><br>  We will not go deep into the mechanisms, but simply use ready-made solutions that will allow us to create users via login / password or <code>google</code> and <code>github</code> services.  I used to set up a bunch of <code>devise</code> and <code>omniauth</code> in rails <code>omniauth</code> pair of generators and a few lines in the config file.  So, the meteor is not enough that it provides out of the box, so also the setting up of services is as simple as possible. <br><br>  Install the following packages: <br><br><ul><li>  <code>accounts-base</code> - basic package for users of the application on a meteor; </li><li>  <code>accounts-password</code> , <code>accounts-github</code> , <code>accounts-google</code> - we will add support for login / password authentication and <code>github</code> and <code>google</code> services; </li><li>  <code>ian:accounts-ui-bootstrap-3</code> - a package to simplify the integration of accounts into the bootstrap application. </li></ul><br>  The <code>ian:accounts-ui-bootstrap-3</code> package will allow us to add an authentication / registration form to the application in one line, as well as provide an interface to configure third-party services.  <a href="https://github.com/ianmartorell/meteor-accounts-ui-bootstrap-3/">The project itself</a> , there is a small documentation and screenshots of how the form integration and customization of services look like. <br><br>  Modifying our cap <br><br><pre> <code class="hljs coffeescript"><span class="hljs-regexp"><span class="hljs-regexp">//</span></span>- client<span class="hljs-regexp"><span class="hljs-regexp">/layouts/application.jade /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/- ... #navbar.collapse.navbar-collapse ul.nav.navbar-nav li a(href='/</span></span><span class="hljs-string"><span class="hljs-string">') Home li a(href='</span></span><span class="hljs-regexp"><span class="hljs-regexp">/about') About ul.nav.navbar-nav.navbar-right /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/-     /</span></span>/-    ian:accounts-ui-bootstrap<span class="hljs-number"><span class="hljs-number">-3</span></span> +loginButtons</code> </pre><br><br>  And we get the following result <br><br><img alt="base_auth_form" src="https://habrastorage.org/getpro/habr/post_images/ac6/4cf/0a6/ac64cf0a689d86e73fbae5e922ca1cdb.png"><br><br><ul><li>  <a href="http://hgsm-base-user-auth.meteor.com/">Result</a> </li><li>  <a href="https://github.com/ovcharik/meteor-getting-started/tree/78c28cce3af54989ca8c89c453e37c578e8f1d52/todo-list">Repository</a> </li></ul><br>  After configuration, we can verify that the authorization tokens are stored in the database. <br><br><pre> <code class="hljs swift">$ meteor mongo <span class="hljs-type"><span class="hljs-type">MongoDB</span></span> shell version: <span class="hljs-number"><span class="hljs-number">2.4</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span> connecting to: <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>:<span class="hljs-number"><span class="hljs-number">3001</span></span>/meteor meteor:<span class="hljs-type"><span class="hljs-type">PRIMARY</span></span>&gt; show collections meteor_accounts_loginServiceConfiguration meteor_oauth_pendingCredentials system.indexes users meteor:<span class="hljs-type"><span class="hljs-type">PRIMARY</span></span>&gt; db.meteor_accounts_loginServiceConfiguration.<span class="hljs-built_in"><span class="hljs-built_in">find</span></span>() { <span class="hljs-string"><span class="hljs-string">"service"</span></span> : <span class="hljs-string"><span class="hljs-string">"github"</span></span>, <span class="hljs-string"><span class="hljs-string">"clientId"</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;id&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"secret"</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;secret&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"AjKrfCXAioLs7aBTN"</span></span> } { <span class="hljs-string"><span class="hljs-string">"service"</span></span> : <span class="hljs-string"><span class="hljs-string">"google"</span></span>, <span class="hljs-string"><span class="hljs-string">"clientId"</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;id&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"secret"</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;secret&gt;"</span></span>, <span class="hljs-string"><span class="hljs-string">"_id"</span></span> : <span class="hljs-string"><span class="hljs-string">"HaERjHLYmAAhehskY"</span></span> }</code> </pre><br><br>  We will configure our system of users, since I want to configure email address verification, I need to configure <code>smtp</code> , by the way, an <code>email</code> package is used to send <code>email</code> .  It is not included in the standard set of meteors, so you must install it manually if you need to work with mail. <br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/config/smtp/coffee smtp = username: "meteor-todo-list@yandex.ru" password: "meteor-todo-list1234" server: "smtp.yandex.ru" port: "587" #   _(smtp).each (value, key) -&gt; smtp[key] = encodeURIComponent(value) #  url   smtp url = "smtp://#{smtp.username}:#{smtp.password}@#{smtp.server}:#{smtp.port}" #   ,       process.env.MAIL_URL = url</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And we will configure the accounts, so that the meteor requests confirmation of the email address. </font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/config/accounts.coffee emailTemplates = from: 'TODO List &lt;meteor-todo-list@yandex.ru&gt;' siteName: 'Meteor. TODO List.' #      _.deepExtend Accounts.emailTemplates, emailTemplates #   Accounts.config sendVerificationEmail: true #       Accounts.onCreateUser (options = {}, user) -&gt; u = UsersCollection._transform(user) options.profile ||= {} #   ,        #        options.profile.emailHash = Gravatar.hash(u.getEmail() || "") #  ,     options.service = _(user.services).keys()[0] if user.services #      , #     _.extend user, options</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our application, it will not be possible to connect several services to one account, as this requires fine-tuning. </font><font style="vertical-align: inherit;">Perhaps soon the meteor will work this moment, but so far there is a ready, more or less normal solution </font></font><code>mondora:connect-with</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but it is still raw. </font><font style="vertical-align: inherit;">You can try to merge accounts yourself, there is nothing complicated in this, and there are many examples and other solutions in the network: </font></font><a href="https://atmospherejs.com/mondora/connect-with"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="http://www.meteorpedia.com/read/Merging_OAuth_accounts"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">two</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="http://stackoverflow.com/questions/18358007/using-meteor-accounts-package-to-link-multiple-services"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">three</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is also detailed </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on the accounts </font><font style="vertical-align: inherit;">, we just put the packages and see the magic, but under the hood it doesn‚Äôt happen much harder.</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You shouldn't kick me hard, for having considered the system of accounts so superficially, I just wanted to show that there is nothing difficult in it. </font><font style="vertical-align: inherit;">Detailed review will require a separate post. </font><font style="vertical-align: inherit;">And we in the lesson have created the necessary basic functionality and can continue to go to the final result.</font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The next step we will deal with the user page, but before crossing the need to consider how some things are implemented in a meteor. </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Collections, publications and subscriptions. </font></font></h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When creating the project, automatically two packages have been added </font></font><code>autopublish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>insecure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and so now is the time to get rid of them, as they provide the user unlimited access to all the collections in the database, and can be used for prototyping only. </font><font style="vertical-align: inherit;">Packages are removed by the command.</font></font><br><br><pre> <code class="hljs lua">$ meteor <span class="hljs-built_in"><span class="hljs-built_in">remove</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">package</span></span>-name&gt;</code> </pre><br><br><h2>  Collections </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Collection in the meteorite can be compared with collections of Mongu, in fact they are the same with them and work, and they also have the methods </font></font><code>find</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>insert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>update</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>upsert</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(the aggregation can be organized on the server using the package </font></font><code>zvictor:mongodb-server-aggregation</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). One of the collections we have already created and access to it can be obtained through </font></font><code>Meteor.users</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, for example, try running in the browser console </font></font><code>Meteor.users.findOne()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. It is important to note here that all collection data is cached in the browser, and if you execute a million times in a loop on the client </font></font><code>Meteor.users.find(options).fetch()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, you will not load anything except the browser. This is achieved by using a library </font></font><code>minimongo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that is smart enough to make a selection depending on the parameters passed to the client.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It‚Äôs not very pleasant to work with bare data, I would like to add business logic to collection objects, this can be done with the function of </font></font><code>_transform</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the collection, into which objects are transferred after receiving them from the server and there they can be processed, however, so as not to delve into these subtleties , you can use a package </font></font><code>dburles:collection-helpers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that adds a method to the collection </font></font><code>helpers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">where you can pass an object from which all data will be inherited. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Install the package, and write the methods for updating user data. Also, when creating a user, we added a calculated field with the user's avatar hash in the </font><a href="http://ru.gravatar.com/"><font style="vertical-align: inherit;">Gravatar</font></a><font style="vertical-align: inherit;"> service.</font></font><a href="http://ru.gravatar.com/"><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- add a method that can return a link to an image with some parameters. </font><font style="vertical-align: inherit;">We will also add methods for checking the user registration service and methods for returning various public information.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># collections/users.coffee Users = Meteor.users #     _.extend Users, #      allowFieldsForUpdate: ['profile', 'username'] #       Users.helpers #   ,      update: (data) -&gt; Users.update @_id, data #   ,      #      set: (data) -&gt; d = {} f = _(Users.allowFieldsForUpdate) for key, value of data when f.include(key) d[key] = value @update $set: d #      , #         #     merge: (data) -&gt; current = @get() @set _.deepExtend(current, data) #    ,    , #      get: -&gt; r = {} r[key] = @[key] for key in _(@).keys() r #     getEmails: -&gt; p = [@profile?.email] s = _(@services).map (value, key) -&gt; value?.email e = _(@emails).map (value, key) -&gt; value?.address _.compact p.concat(e, s) #   getEmail: -&gt; @getEmails()[0] #   getUsername : -&gt; @username || @_id getName : -&gt; @profile?.name || "Anonymous" getPublicEmail : -&gt; @profile?.email urlData: -&gt; id: @getUsername() #    ,     #       getAvatar: (size) -&gt; size = Number(size) || 200 options = s: size d: 'identicon' r: 'g' hash = "00000000000000000000000000000000" if email = @getPublicEmail() hash = Gravatar.hash(email) else hash = @profile?.emailHash || hash Gravatar.imageUrl hash, options #      isFromGithub: -&gt; @service == 'github' isFromGoogle: -&gt; @service == 'google' isFromPassword: -&gt; @service == 'password' #     #     isEditable: -&gt; @_id == Meteor.userId() #   @UsersCollection = Users</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It seems to have figured out what a collection is in a meteor, it should be mentioned that it is undesirable to store states in the model, since all data in the collection is reactive, if the record in the database changes, then saved somewhere in memory, the model object will lose its relevance, and subsequent work with it can lead us to the use of obsolete data, later on with examples we consider how to work with models. </font></font><br><br><h2>  Publications </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I created three user posts in db </font></font><br><br><pre> <code class="hljs pgsql">$ meteor mongo meteor:<span class="hljs-keyword"><span class="hljs-keyword">PRIMARY</span></span>&gt; db.users.count() <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And when I try to get data in the browser, I did not find any records without authentication and one (own) otherwise. </font></font><br><br><img alt="fail_publish" src="https://habrastorage.org/getpro/habr/post_images/07f/839/8b6/07f8398b6db6a971a43bbcb0e8c5e05e.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this application, we will not hide users from everyone, just hide private information, such as authentication tokens. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since we removed the package </font></font><code>autopublish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, now the process of publishing data needs to be done manually, this will allow us to control the data transmitted to the user. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We publish a collection of users.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/publications/users.coffee Meteor.publish 'users', (limit = 20) -&gt; UsersCollection.find {}, fields: service: 1 username: 1 profile: 1 limit: limit</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This code will provide access to users for everyone, you only need to subscribe, I immediately thought about giving users the ability to download data by page, if you do not specify the issue limit, all user records will be immediately downloaded, when subscribing to this publication, not very good for obvious reasons, the same thing happens when used </font></font><code>autopublish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, only automatically and with all collections. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We also limited the visibility of the paged data, nothing but information from the field </font></font><code>profile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and user name, subscribers can not see. But for example, we want to provide access to e-mail addresses for the current user; we will create another publication.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/publications/profile.coffee Meteor.publish 'profile', -&gt; #    , #   if @userId #       UsersCollection.find { _id: @userId }, fields: service: 1 username: 1 profile: 1 emails: 1 else #  ,    @ready() return</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second parameter passed to the method </font></font><code>Meteor.publish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is a function that should return the collection cursor. This function can take any number of arguments and it runs in the context of an object, in which some methods are available that allow you to notify the user about various changes in data and provide access to some properties of the connection. For example, in the profile publication we use the method </font></font><code>ready</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, in the case when the user is not authorized, it means that the data in the publication is ready, and a callback will be called upon the client when subscribing, but it will not receive any data. </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Read more</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> about publications.</font></font><br><br><h2>  Subscriptions </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I have repeatedly noted that to obtain data and to track changes in them, you first need to subscribe to publications, in general everything that happens with the data in the meteor application can be easily monitored and monitored, and if you simply create a prototype where this is not your key moments, you can always use the package </font></font><code>autopublish</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will use for subscriptions</font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, and it will control the entire necessary process, since for manual control this process will have to follow many things, and this library solves all the problems. </font><font style="vertical-align: inherit;">It is desirable to output some data page by page, so before creating a controller for users, we abstract a little and create a class that has the functionality to manage pages and which will inherit from the library controller </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/lib/0.pageable_route_controller.coffee varName = (inst, name = null) -&gt; name = name &amp;&amp; "_#{name}" || "" "#{inst.constructor.name}#{name}_limit" class @PagableRouteController extends RouteController pageable: true #  ,     perPage: 20 #      #    limit: (name = null) -&gt; Session.get(varName(@, name)) || @perPage #   incLimit: (name = null, inc = null) -&gt; inc ||= @perPage Session.set varName(@, name), (@limit(name) + inc) #   resetLimit: (name = null) -&gt; Session.set varName(@, name), null #     ? loaded: (name = null) -&gt; true</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's also create a template in the form of a button, with a click on which the method will be called </font></font><code>incLimit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, for the current controller, of course, if it supports this functionality. </font><font style="vertical-align: inherit;">It could be done and endless scrolling, but it's easier.</font></font><br><br><pre> <code class="hljs pgsql">//- client/components/next_page_button/next_page_button.jade <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'nextPageButton'</span></span>) unless loaded a.btn.btn-<span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>.btn-lg.NextPageButton(href = <span class="hljs-string"><span class="hljs-string">'#'</span></span>) | More</code> </pre><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/components/next_page_button/next_page_button.coffee Template.nextPageButton.helpers loaded: -&gt; ctrl = Router.current() if ctrl.pageable ctrl.loaded(@name) else true Template.nextPageButton.events 'click .NextPageButton': (event) -&gt; ctrl = Router.current() if ctrl.pageable ctrl.incLimit(@name, @perPage)</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we are already setting some logic for the component. As you can see, all templates are added to the global namespace </font></font><code>Template</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Refer to the template we can through </font></font><code>Template.&lt;template-name&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. To describe the methods used in the template, you need to use the method </font></font><code>helpers</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to which the object is passed with the methods. In this example, we describe only one method </font></font><code>loaded</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that checks what the current controller is and gives a result indicating whether all the data has been loaded. In the template itself, we pull this method in the construction </font></font><code>unless loaded</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; also in the template, you can take data from the current context. Template helpers can be compared with the prototype of an object when using them in a template, but there are limitations within the function itself, since each helper is called something like this</font></font><code>&lt;helper-func&gt;.apply(context, arguments)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, that is, we do not have the opportunity to apply to all template helpers, inside a function, which in general can sometimes interfere. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To handle template events, you need to describe them in the method </font></font><code>events</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to which the object is transferred, with keys of the following format </font></font><code>&lt;event&gt; &lt;selector&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The event is passed to the handler, </font></font><code>jQuery</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and the template in which the event was triggered, since we can handle child events in the parent template, this can sometimes be useful. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we are ready to create a page with a list of all users and look at an example of how to manage subscriptions in </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/routes/users.coffee Router.route '/users', name: 'users' class @UsersController extends PagableRouteController #      perPage: 20 #    ,   , #      # #     ,  iron:router #     ,     #  subscriptions: -&gt; @subscribe 'users', @limit() #       data: -&gt; users: UsersCollection.find() #    ? loaded: -&gt; @limit() &gt; UsersCollection.find().count() #    ,    onRun: -&gt; @resetLimit() @next()</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method </font></font><code>subscriptions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is subscribed to the publication </font></font><code>users</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. There is still a practically similar method </font></font><code>waitOn</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, only in it the router will wait until all data is unloaded, and after it renders the page, until this point it will display a template that can be set via a property </font></font><code>loadingTemplate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. The data returned by the method </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be bound to the template, and we will be able to use it through the current context. </font></font><code>UsersCollection.find()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">returns the cursor, not the data itself, but the Blaze will do all the transformations for us, as if we are already working with ready data. Since we subscribe to a limited amount of data, the call </font></font><code>UsersCollection.find().fetch()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will return us only the data uploaded to the client, that is, if we, for example, set a limit of 1, then</font></font><code>find</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will work only with the loaded selection (one record), and not all the data in the collection from the database. For example, here we redefine the method </font></font><code>loaded</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, I think its essence is clear, but it should be remembered that it </font></font><code>count</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will return us the number of local records, which means it will be equal </font></font><code>limit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">until all the data are unloaded, therefore the condition is strictly greater. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there are several hooks, for example, it would not be bad for us to reset the loaded limit every time you open a page with users. Otherwise, if we previously unloaded a large amount of data, the page can be rendered for a long time. Therefore, it is convenient to use the hook to reset the data limit.</font></font><code>onRun</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">It is executed once, when the page loads. </font><font style="vertical-align: inherit;">There is only the moment that when hot replacing the code that the meteor performs, after saving the files with the code, this hook will not be executed, so manually refresh the page when the controller using the hook is debugged (there is no such problem with others). </font><font style="vertical-align: inherit;">More about </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hooks</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">subscriptions</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Reactive variables and functions </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We have subscribed to the publication, but still it may not be clear why clicks on the button from the template </font></font><code>nextPageButton</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will lead us to load a new piece of data, but all due to manipulations with the object </font></font><code>Session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in </font></font><code>PagableRouteController</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The data in this object are reactive, and </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will automatically track changes in them. </font><font style="vertical-align: inherit;">You can try to type in the browser console</font></font><br><br><pre> <code class="javascript hljs">Tracker.autorun( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-string"><span class="hljs-string">'autorun test'</span></span>, Session.get(<span class="hljs-string"><span class="hljs-string">'var'</span></span>) ); } )</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And try to change the value using the call </font></font><code>Session.set('var', 'value')</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, the result will not take long. </font></font><br><br><img alt="reactive_var" src="https://habrastorage.org/getpro/habr/post_images/2de/3e5/694/2de3e569477b71bf8901873cf2f5cea1.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thanks to this mechanism, it </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">understands when a subscription needs to be updated, in the same way the data in the templates are updated automatically. More details about the reactive variables are well described in the official </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and in addition to the variables </font></font><code>Session</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there is an opportunity to create </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reactive objects</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , with methods </font></font><code>set</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>get</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for managing the values ‚Äã‚Äãthat will also be tracked by the tracker and templates. And the </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tracker</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is something like a listener, you can create a function that will not contain reactive variables, but will also be tracked by the tracker, for this you need to use</font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tracker.Dependency</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">In general, this library has other possibilities, but in practice I did not have to use them, perhaps in vain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another small example that can be performed in the browser console:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> depend = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Tracker.Dependency(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reactFunc = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ depend.depend(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; } Tracker.autorun(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( reactFunc() ); }); <span class="hljs-comment"><span class="hljs-comment">// 42 depend.changed() // 42 depend.changed() // 42</span></span></code> </pre><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> More about subscriptions </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I explained how subscriptions can be used with an example </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but this is </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">not the only mechanism</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . The main thing to remember is that you need to use subscriptions carefully, otherwise you risk unloading a large amount of data and automatically tracking changes to them where there is no need. </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">provides us with a very simple way to manage subscriptions, it will turn off all unnecessary ones, connect the necessary ones, update the current ones if necessary, like, for example, this happens when we load the next page with us. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's finish the list of users and make sure that all this works in practice.</font></font><br><br><pre> <code class="hljs pgsql">//- client/components/users.jade <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>( <span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'users'</span></span> ) h1 Users .<span class="hljs-keyword"><span class="hljs-keyword">row</span></span> //-  ,     +<span class="hljs-keyword"><span class="hljs-keyword">each</span></span> users .col-xs<span class="hljs-number"><span class="hljs-number">-6.</span></span>col-md<span class="hljs-number"><span class="hljs-number">-4.</span></span>col-lg<span class="hljs-number"><span class="hljs-number">-3</span></span> //-    //-   <span class="hljs-keyword"><span class="hljs-keyword">each</span></span>  ,   //-        +userCard //-     +nextPageButton //- client/components/user_avatar/user_avatar.jade //-   ,     <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'userAvatar'</span></span>) img(src="{{user.getAvatar size}}", alt=<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.getUsername, <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>="{{class}}") //- client/components/user_card.jade //-       //-        <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'userCard'</span></span>) .panel.panel-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> .panel-body .pull-left +userAvatar <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=this size=<span class="hljs-number"><span class="hljs-number">80</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-card-<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>-block ul.fa-ul //-     li <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isFromGithub i.fa.fa-li.fa-github <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isFromGoogle i.fa.fa-li.fa-google <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> i.fa.fa-li b= getName //-    li i.fa.fa-li @ //-    a(href="{{ pathFor route='users_show' data=urlData }}")= getUsername //-  ,   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> getPublicEmail li i.fa.fa-li.fa-envelope = getPublicEmail</code> </pre><br><br><img alt="users_page" src="https://habrastorage.org/getpro/habr/post_images/f15/ef6/89c/f15ef689c60ca976db3408265cce81ce.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, pagination works for us, and since all data is reactive, new users of the system will be added to the page automatically, without any reloads, because we have subscribed to the collection, which means that any changes to the data in the database on the server will immediately be displayed on user page. You can try to register a new user in a new tab, or change the values ‚Äã‚Äãdirectly in the database using the utility </font></font><code>mongo</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- the changes will be displayed on the page, and you will not have to do anything to do this.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And to make sure that this approach works optimally, you can see the browser logs. </font><font style="vertical-align: inherit;">I set the number of users per page equal to one. </font><font style="vertical-align: inherit;">DDP protocol is quite simple and easy to read, so I will not go into details. </font><font style="vertical-align: inherit;">In the logs, you can simply see that all unnecessary subscriptions were unsubscribed, and users downloaded only three times, one for each update of the subscription.</font></font><br><br><img alt="users_log" src="https://habrastorage.org/getpro/habr/post_images/976/de9/df9/976de9df90aac8f3a4a81233de03b8eb.png"><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> User page and some more about templates </font></font></h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's create a user page where there will be an opportunity to change some data and complete this work with users so that you can proceed to creating your own collections. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this, the first thing for an authorized user, instead of the home page, is to show the current user page, modify the controller a little.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/routers/home.coffee Router.route '/', name: 'home' class @HomeController extends PagableRouteController #   ? isUserPresent: -&gt; !!Meteor.userId() #       #   waitOn: -&gt; if @isUserPresent() @subscribe 'profile' #     ,    data: -&gt; if @isUserPresent() { user: UsersCollection.findOne Meteor.userId() } #       #       action: -&gt; if @isUserPresent() @render 'profile' else @render 'home'</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And also create a controller in which you can view the profile of any user. </font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/routers/user_show.coffee Router.route '/users/:id', name: 'users_show' class @UsersShowController extends PagableRouteController #     template: 'profile' #     waitOn: -&gt; @subscribe 'user', @params.id #    data: -&gt; user: UsersCollection.findOneUser(@params.id)</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> For the convenience of finding users either by ID or by login, I created additional methods in the collection: one returns a cursor, the second is data. </font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># collections/users.coffee # ... _.extend Users, # ... findUser: (id, options) -&gt; Users.find { $or: [ { _id: id }, { username: id } ] }, options findOneUser: (id, options) -&gt; Users.findOne { $or: [ { _id: id }, { username: id } ] }, options</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We try to get the data for the user page, but they are not published, we fix it. </font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/publications/user.coffee Meteor.publish 'user', (id) -&gt; UsersCollection.findUser id, fields: service: 1 username: 1 profile: 1 limit: 1</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Almost everything is ready, create a template and look at the result. </font><font style="vertical-align: inherit;">When creating the template, I decided to create a component that, depending on the access rights, will give the opportunity to edit the model field.</font></font><br><br><pre> <code class="hljs pgsql">//- client/components/editable_field/editable_field.jade //-       //-     ,     //-       //-     //-       this.&lt;key&gt; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'editableField'</span></span>) .form-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>.EditableFiled <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.isEditable div(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=inputGroupClass) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hasIcon .<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>-addon <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> icon i.fa.fa-fw(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">'fa-{{icon}}'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> i.fa.fa-fw=iconSymbol <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>.Field.form-control(placeholder=placeholder, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-type"><span class="hljs-type">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defaultValue span.form-control-static <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hasIcon <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> icon i.fa.fa-fw(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">'fa-{{icon}}'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> i.fa.fa-fw=iconSymbol = defaultValue</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To interpolate variables in rows in a template, you can use the baleen design: </font></font><code>class='fa-{{icon}}'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>icon</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- it is a variable.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/components/editable_field/editable_field.coffee Template.editableField.helpers value: -&gt; ObjAndPath.valueFromPath @data, @path name: -&gt; ObjAndPath.nameFromPath @scope, @path hasIcon: -&gt; @icon || @iconSymbol inputGroupClass: -&gt; (@icon || @iconSymbol) &amp;&amp; 'input-group' || '' Template.editableField.events #   ,      'change .Field': (event, template) -&gt; data = $(event.target).serializeJSON() $(template.firstNode).trigger 'changed', [data]</span></span></code> </pre><br><br><pre> <code class="hljs pgsql">//- client/components/profile/profile.jade <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'profile'</span></span>) //-  ,      , //-     +<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> .profile-left-side .panel.panel-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> .panel-body .container-fluid .<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>-bottom //-  ,    //-  &lt;&gt;=&lt;&gt;,      //-     userAvatar +userAvatar <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=this size=<span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">'profile-left-side-avatar'</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">row</span></span> //-      +editableField fieldUsername +editableField fieldName +editableField fieldEmail .profile-right-side h1 Boards</code> </pre><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/components/profile/profile.coffee Template.profile.helpers fieldUsername: -&gt; data: @ defaultValue: @getUsername() placeholder: 'Username' scope: 'user' path: 'username' iconSymbol: '@' fieldName: -&gt; data: @ defaultValue: @getName() placeholder: 'Name' scope: 'user' path: 'profile.name' icon: 'user' fieldEmail: -&gt; data: @ defaultValue: @getPublicEmail() placeholder: 'Public email' scope: 'user' path: 'profile.email' icon: 'envelope' Template.profile.events #      #    'changed .EditableFiled': (event, template, data) -&gt; user = template.data?.user return unless user data = data.user user.merge data</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It seems to me that the layout of meteor templates is </font></font><code>jade</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quite semantic, you don‚Äôt need to think about many things and read a lot of documentation - everything is quite obvious. </font><font style="vertical-align: inherit;">But if you have problems understanding the code above, I advise you to look through the documentation for the </font></font><a href="https://atmospherejs.com/mquandalle/jade"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mquandalle</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><a href="https://atmospherejs.com/mquandalle/jade"><font style="vertical-align: inherit;">: jade</font></a><font style="vertical-align: inherit;"> and </font></font><a href="https://atmospherejs.com/meteor/spacebars"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">spacebars</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">It‚Äôs just that when I got acquainted with the layout of templates in a meteor, there were no problems, I think that they, in fact, made them very comfortable. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, everything is ready, open the authentication form in the header, enter the system, and instead of the title ‚ÄúHome‚Äù your profile will immediately appear on the page, without any reloads.</font></font><br><br><img alt="profile" src="https://habrastorage.org/getpro/habr/post_images/2ee/3b7/0be/2ee3b70be1d92caded436a4dd30cf4bf.png"><br><br><ul><li> <a href="http://hgsm-base-users.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result</font></font></a> </li><li> <a href="https://github.com/ovcharik/meteor-getting-started/tree/2110ed5168155893fbaf27a29df0675070765d81/todo-list"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository</font></font></a> </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If something is not clear to you up to the present moment, then I advise you to get acquainted with the current state of the project in the </font></font><a href="https://github.com/ovcharik/meteor-getting-started/tree/b1067c219e591de6d6eb387d10a107cfff180e69/todo-list"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , I tried to comment everything on the files in the files, it is also possible to look through the above, maybe not completely consistently, but I tried to pay attention to all the key moments, and of course you can clone the project at this stage and touch it with your hands. </font><font style="vertical-align: inherit;">Then I'm going to touch on a few more topics related to server code: how to create your own collections, how to protect data in collections from unwanted editing, tell you a little about using RPC and using libraries </font></font><code>npm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on the server.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> More about collections and subscriptions </font></font></h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Before we start creating our collections, I suggest creating a mechanism that will automatically calculate some fields when inserting / modifying data in the database. </font><font style="vertical-align: inherit;">To do this, add the package </font></font><a href="https://github.com/aldeed/meteor-collection2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aldeed: collection2</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , which includes </font></font><a href="https://github.com/aldeed/meteor-simple-schema"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aldeed: simple-schema</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">These packages will allow us to easily validate data, add indexes to the collection, and more. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add </font></font><code>aldeed:simple-schema</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">some new features </font><font style="vertical-align: inherit;">to the package </font><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># lib/simple_schema.coffee _.extend SimpleSchema, #        #       build: (objects...) -&gt; result = {} for obj in objects _.extend result, obj return new SimpleSchema result #      , #          #  timestamp: createdAt: type: Date denyUpdate: true autoValue: -&gt; if @isInsert return new Date if @isUpsert return { $setOnInsert: new Date } @unset() updatedAt: type: Date autoValue: -&gt; new Date</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And create a new collection </font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># collections/boards.coffee #   boardsSchema = SimpleSchema.build SimpleSchema.timestamp, 'name': type: String index: true 'description': type: String optional: true #    #     'owner': type: String autoValue: (doc) -&gt; if @isInsert return @userId if @isUpsert return { $setOnInsert: @userId } @unset() #    'users': type: [String] defaultValue: [] 'users.$': type: String regEx: SimpleSchema.RegEx.Id #      Boards = new Mongo.Collection 'boards' Boards.attachSchema boardsSchema #   Boards.allow #       insert: (userId, doc) -&gt; userId &amp;&amp; true #       update: (userId, doc) -&gt; userId &amp;&amp; userId == doc.owner #   _.extend Boards, findByUser: (userId = Meteor.userId(), options) -&gt; Boards.find $or: [ { users: userId } { owner: userId } ] , options create: (data, cb) -&gt; Boards.insert data, cb #   Boards.helpers update: (data, cb) -&gt; Boards.update @_id, data, cb addUser: (user, cb) -&gt; user = user._id if _.isObject(user) @update $addToSet: users: user , cb removeUser: (user, cb) -&gt; user = user._id if _.isObject(user) @update $pop: users: user , cb updateName: (name, cb) -&gt; @update { $set: {name: name} }, cb updateDescription: (desc, cb) -&gt; @update { $set: {description: desc} }, cb # joins getOwner: -&gt; UsersCollection.findOne @owner getUsers: (options) -&gt; UsersCollection.find $or: [ { _id: @owner } { _id: { $in: @users } } ] , options urlData: -&gt; id: @_id #  @BoardsCollection = Boards</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, when creating the collection, we defined the schema; this will allow us to validate the data and automatically calculate some fields. You can read more about validation on the </font></font><a href="https://github.com/aldeed/meteor-simple-schema"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aldeed: simple-schema</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package page </font><font style="vertical-align: inherit;">, there is quite rich functionality, and when installing an additional package </font></font><code>aldeed:autoform</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">from the same author, you can generate forms that will immediately notify about errors when creating a record. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We create a new collection in the database by calling </font></font><code>Boards = new Mongo.Collection 'boards'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if it is not there, or we are connecting to the existing one. In principle, this is all the necessary functionality for creating new collections, there are </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a couple more</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> options that you can specify when creating. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Using the method</font></font><code>allow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">the collection, we can control access to change data in the collection. </font><font style="vertical-align: inherit;">In the current example, we prohibit the creation of new entries in the collection for all unauthorized users, and allow only the creator of the board to change data. </font><font style="vertical-align: inherit;">These checks will be carried out on the server and you can not worry that some cooler will change this logic on the client. </font><font style="vertical-align: inherit;">Also at your disposal there is almost a similar method </font></font><code>deny</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, I think its essence is clear. </font><font style="vertical-align: inherit;">Learn more about </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">allow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deny</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When displaying a board card, I want to immediately display the data about the board creator. </font><font style="vertical-align: inherit;">But if we subscribe only to the boards, then this data will not be transferred to the client. </font><font style="vertical-align: inherit;">However, publications in meteor make it possible to subscribe to any data, even automatically calculated, such as collection counters and others.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/publications/boards.coffee Meteor.publish 'boards', (userId, limit = 20) -&gt; findOptions = limit: limit sort: { createdAt: -1 } if userId #    cursor = BoardsCollection.findByUser userId, findOptions else #   cursor = BoardsCollection.find {}, findOptions inited = false userFindOptions = fields: service: 1 username: 1 profile: 1 #        addUser = (id, fields) =&gt; if inited userId = fields.owner @added 'users', userId, UsersCollection.findOne(userId, userFindOptions) #    , #       handle = cursor.observeChanges added: addUser changed: addUser inited = true #      , #       userIds = cursor.map (b) -&gt; b.owner UsersCollection.find({_id: { $in: userIds }}, userFindOptions).forEach (u) =&gt; @added 'users', u._id, u #    ,    @onStop -&gt; handle.stop() return cursor</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since Monga does not know how to make requests through several collections and produce already processed data, as it happens in relational databases, we will have to get information about the board makers with one more request, and it‚Äôs more convenient to work within the data models. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First of all, depending on the request, we get the required boards from the base, after that we need another request to get users. Methods </font></font><code>added</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>changed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and</font></font><code>removed</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the context of the publication can manage the data transmitted to the client. If we return a collection cursor to a publication, then these methods will be called automatically depending on the state of the collection, which is why we return the cursor, but additionally in the publication itself we subscribe to changes to the data in the board collections, and send user data to the client as necessary. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the help of connection logs via web sockets or with the help of </font></font><a href="https://github.com/arunoda/meteor-ddp-analyzer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility, you can make sure that this approach will work optimally. And here it is important to understand that in our case, changes in the user‚Äôs collection will not be synchronized with the client, but that was what was intended. By the way, for a simple join you can simply return an array of cursors as a result of a subscription.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To display user boards, I added new subscriptions to routers and wrapped up the necessary templates, but we already reviewed all these points above, if you are interested in all the changes, you can see them </font></font><a href="https://github.com/ovcharik/meteor-getting-started/commit/548ae3c4a6b8a752fa07c69e21ac3da929e1a70e"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">here</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">But in the end we have to get the following, though the boards will have to be created through the console to check the performance.</font></font><br><br><img alt="boards" src="https://habrastorage.org/getpro/habr/post_images/8ee/4f3/2f4/8ee4f32f4b0cfbf1e9dacbdab4cc5435.png"><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can also use the </font></font><a href="https://github.com/Diggsey/meteor-reactive-publish"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mrt: reactive-publish</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package to create reactive publications </font><font style="vertical-align: inherit;">.</font></font><br></blockquote><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We are finalizing the server </font></font></h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's add the ability for boards to set the background image, for this we need to configure the server so that it can receive files, process them, save and give them upon request. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> NPM </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For image processing, I used to use </font></font><a href="http://www.imagemagick.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageMagick</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and for the node there are corresponding packages that provide an interface to this library. </font><font style="vertical-align: inherit;">To allow the meteor to use the </font></font><code>npm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">packages, you need to add </font></font><code>meteorhacks:npm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, after that, all the necessary packages can be described in the file </font></font><code>packages.json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">For example, I only need the </font></font><a href="https://github.com/aheckmann/gm"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gm</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">and mine </font></font><code>packages.json</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will look like this:</font></font><br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"gm"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.17.0"</span></span> }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All packages </font></font><code>npm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">connected through </font></font><code>meteorhacks:npm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will turn around in one meteor package, so when you build an application through a command, </font></font><code>meteor build</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">there will be no problems and all dependencies will be resolved automatically. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You </font></font><code>npm</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">need to </font><font style="vertical-align: inherit;">connect </font><font style="vertical-align: inherit;">packages on the server through the command </font></font><code>Meteor.npmRequire(&lt;pkg-name&gt;)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, it works as well as the function </font></font><code>require</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">in the node.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> RPC and synchronous calls to asynchronous functions </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To load and process the image, create a server method that can be called from the client. </font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/lib/meteor.coffee Meteor.getUploadFilePath = (filename) -&gt; "#{process.env.PWD}/.uploads/#{filename}" # server/methods/upload_board_image.coffee #      gm = Meteor.npmRequire 'gm' #     resizeAndWriteAsync = (buffer, path, w, h, cb) -&gt; gm(buffer) .options({imageMagick: true}) .resize(w, "#{h}^", "&gt;") .gravity('Center') .crop(w, h, 0, 0) .noProfile() .write(path, cb) #     resizeAndWrite = Meteor.wrapAsync resizeAndWriteAsync #        Meteor.methods uploadBoardImage: (boardId, data) -&gt; board = BoardsCollection.findOne(boardId) if board.owner != @userId throw new Meteor.Error('notAuthorized', 'Not authorized') data = new Buffer data, 'binary' name = Meteor.uuid() #     path = Meteor.getUploadFilePath name resizeAndWrite data, "#{path}.jpg", 1920, 1080 resizeAndWrite data, "#{path}_thumb.jpg", 600, 400 #     BoardsCollection.update { _id: boardId }, $set: background: url: "/uploads/#{name}.jpg" thumb: "/uploads/#{name}_thumb.jpg" return</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the method </font></font><code>uploadBoardImage</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we accept the identifier of the board to which the image is added and the string with the binary data of this image. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If an exception is thrown in the method, it will be passed to the user on the client, by the first parameter of the callback. And the data returned by the method will come to the client with the second parameter of the callback. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So that you can use exceptions and return functions with asynchronous programming style, in the server part of the meteor there is a method that wraps asynchronous functions into synchronous, via the </font></font><a href="https://github.com/laverdet/node-fibers"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fibers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> library </font><font style="vertical-align: inherit;">. If in short, thanks to this library, the calls of wrapped functions will not occupy the execution queue, so that you can write synchronous code on the server and do not worry about the wrong sequence of code execution. By method</font></font><code>Meteor.wrapAsync(&lt;async-func&gt;)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">functions which last parameter accept kollbek turn around. </font><font style="vertical-align: inherit;">In this callback, the first parameter must be an error, and the second is the result, such is the format of the parameters of all standard libraries in the node. </font><font style="vertical-align: inherit;">If an error occurs, the wrapped function will throw an exception with this error, otherwise the second parameter returned from the function will be returned to the callback.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Routing </font></font></h2><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I understand that for issuing statics from the server it is better to use ready-made and run-in solutions for many reasons, but here I am going to give statics to the node. </font></font><br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In meteor for server routing there is a standard </font></font><a href="https://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webapp</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> package </font><font style="vertical-align: inherit;">, but we have already installed a much more convenient solution in the form </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Similarly, as on the client, create a server route.</font></font><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># server/routes/uploads.coffee fs = Meteor.npmRequire 'fs' Router.route '/uploads/:file', where: 'server' action: -&gt; try filepath = Meteor.getUploadFilePath(@params.file) file = fs.readFileSync(filepath) @response.writeHead 200, { 'Content-Type': 'image/jpg' } @response.end file, 'binary' catch e @response.writeHead 404, { 'Content-Type': 'text/plain' } @response.end '404. Not found.'</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here the main route to transfer the property </font></font><code>where: 'server'</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, otherwise it will not work. </font><font style="vertical-align: inherit;">In action, we are trying to read the specified file from disk, since in this directory there will be only images of the same format, I have simplified this method as much as possible. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Objects </font></font><code>request</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>response</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">available in the context of the route are class objects from the standard library of the </font></font><a href="&amp;xid=25657,15700023,15700043,15700186,15700191,15700253&amp;usg=ALkJrhi84LYf9Kfu2hSl_rQShNNEhrzg8Q#http_"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http.IncomingMessage</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><a href="&amp;xid=25657,15700023,15700043,15700186,15700191,15700253&amp;usg=ALkJrhi84LYf9Kfu2hSl_rQShNNEhrzg8Q#http_class_"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http.ServerResponse nodes,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> respectively.</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There </font></font><code>iron:router</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is also an </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interface</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> for creating a REST API.</font></font><br></blockquote><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Using RPC </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To use, let's create a form for adding a new board. </font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here I also created autocompet to add users to the board, it also uses RPC, more details on the implementation can be found in the </font></font><a href="https://github.com/ovcharik/meteor-getting-started/tree/master/todo-list/client/components/users_autocomplete"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br></blockquote><br><pre> <code class="hljs pgsql">//- client/components/new_board_form/new_board_form.jade <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'newBoardForm'</span></span>) //-     .panel.panel-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-board-panel(style=<span class="hljs-string"><span class="hljs-string">'{{panelStyle}}'</span></span>) .panel-body h1 <span class="hljs-built_in"><span class="hljs-built_in">New</span></span> board form(action=<span class="hljs-string"><span class="hljs-string">'#'</span></span>) .form-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>.form-control(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">'text'</span></span>,placeholder=<span class="hljs-string"><span class="hljs-string">'Board name'</span></span>,<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'board[name]'</span></span>) .form-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> textarea.form-control(placeholder=<span class="hljs-string"><span class="hljs-string">'Description'</span></span>,<span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-string"><span class="hljs-string">'board[description]'</span></span>) .form-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> //-    ,      ,   label.btn.btn-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>=<span class="hljs-string"><span class="hljs-string">'newBoardImage'</span></span>) Board image .hide <span class="hljs-keyword"><span class="hljs-keyword">input</span></span>#newBoardImage(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">'file'</span></span>, accept=<span class="hljs-string"><span class="hljs-string">'image/*'</span></span>) button.btn.btn-<span class="hljs-keyword"><span class="hljs-keyword">primary</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-string"><span class="hljs-string">'submit'</span></span>) Submit</code> </pre><br><br><pre> <code class="coffeescript hljs"><span class="hljs-comment"><span class="hljs-comment"># client/components/new_board_form/new_board_form.coffee #      currentImage = null currentImageUrl = null currentImageDepend = new Tracker.Dependency #    resetImage = -&gt; currentImage = null currentImageUrl = null currentImageDepend.changed() #     uploadImage = (boardId) -&gt; if currentImage reader = new FileReader reader.onload = (e) -&gt; #    Meteor.call 'uploadBoardImage', boardId, e.target.result, (error) -&gt; if error alertify.error error.message else alertify.success 'Image uploaded' reader.readAsBinaryString currentImage #    Template.newBoardForm.helpers #     , #    ,     panelStyle: -&gt; currentImageDepend.depend() currentImageUrl &amp;&amp; "background-image: url(#{currentImageUrl})" || '' #     ,      Template.newBoardForm.rendered = -&gt; resetImage() #   Template.newBoardForm.events #   ,     #    ,  , #    'submit form': (event, template) -&gt; event.preventDefault() form = event.target data = $(form).serializeJSON() BoardsCollection.create data.board, (error, id) -&gt; if error alertify.error error.message else form.reset() alertify.success 'Board created' resetUsers() uploadImage(id) resetImage() #       #     'change #newBoardImage': (event, template) -&gt; files = event.target.files image = files[0] unless image and image.type.match('image.*') resetImage() return currentImage = image reader = new FileReader reader.onload = (e) =&gt; currentImageUrl = e.target.result currentImageDepend.changed() reader.readAsDataURL(image)</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here for loading and image processing we perform the remote method through </font></font><code>Meteor.call</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As you can see, the remote procedure call on the client is not much different from the usual function call, and all the data passed by the arguments will be uploaded to the server via a web socket. </font><font style="vertical-align: inherit;">To read user files, I used the </font></font><a href="http://www.w3.org/TR/file-upload/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">File API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the HTML5 specification.</font></font><br><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The example of downloading images may not be the best, but it demonstrates well the capabilities of the server part of the meteor. </font><font style="vertical-align: inherit;">If you are writing for production, you can use the ready-made </font></font><a href="https://github.com/CollectionFS/Meteor-CollectionFS"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CollectionFS</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solution </font><font style="vertical-align: inherit;">.</font></font><br></blockquote><br><img alt="new_board" src="https://habrastorage.org/getpro/habr/post_images/236/7e7/f35/2367e7f359241bf21250ec5ebf585762.png"><br><br><ul><li> <a href="http://hgsm-boards.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The result</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the loading of images did not work there, the roofing felts deal with ImageMagick, the roofing felts of the inability to create their own directory for storage</font></font></li><li> <a href="https://github.com/ovcharik/meteor-getting-started/tree/8bc4dec60f3605e57f0a4330634980923a9925e5/todo-list"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository</font></font></a> </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In principle, this is all that I wanted to highlight in this lesson, but for completeness, I will complete the functionality of the cards in the boards, there will not be used something that is not in this lesson. </font><font style="vertical-align: inherit;">Changes are available as usual in the </font></font><a href="https://github.com/ovcharik/meteor-getting-started/commit/2c65c13e1c4c8b8402b74f9fc3c67146a966d227"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repository</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><img alt="tasks" src="https://habrastorage.org/getpro/habr/post_images/05e/52e/29e/05e52e29e1e56fad8ce2d60c75211fa8.png"><br><br><ul><li> <a href="http://hgsm-result.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result</font></font></a> </li><li> <a href="https://github.com/ovcharik/meteor-getting-started/tree/master/todo-list"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repository</font></font></a> </li></ul><br><br><h1>  Links </h1><ul><li> <a href="https://www.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meteor</font></font></a> <br><ul><li> <a href="http://docs.meteor.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Documentation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li> <a href="https://www.meteor.com/install"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tutorial</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> from the developers of the framework;</font></font></li></ul></li><li> <a href="https://atmospherejs.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Atmosphere</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - meteor packages</font></font><br><ul><li> <a href="https://atmospherejs.com/mquandalle/jade"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mquandalle: jade</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a package that adds the ability to use jade markup for meteor templates</font></font></li><li> <a href="https://atmospherejs.com/iron/router"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">iron: router</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - client and server routing;</font></font></li><li> <a href="https://atmospherejs.com/mizzao/bootstrap-3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mizzao: bootstrap-3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Twitter Bootstrap for a meteor;</font></font></li><li> <a href="https://atmospherejs.com/ian/accounts-ui-bootstrap-3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ian: accounts-ui-bootstrap-3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Twitter Bootstrap-based templates for login and registration forms;</font></font></li><li> <a href="https://atmospherejs.com/dburles/collection-helpers">dburles:collection-helpers</a> ‚Äî          ; </li><li> <a href="https://atmospherejs.com/jparker/gravatar">jparker:gravatar</a> ‚Äî       <a href="http://ru.gravatar.com/">Gravatar</a> ; </li><li> <a href="https://atmospherejs.com/aldeed/collection2">aldeed:collection2</a> ‚Äî     ; </li><li> <a href="https://atmospherejs.com/sergeyt/typeahead">sergeyt:typeahead</a> ‚Äî   ; </li><li> <a href="https://atmospherejs.com/meteorhacks/npm">meteorhacks:npm</a> ‚Äî   <code>npm</code>    ; </li><li> <a href="https://github.com/CollectionFS/Meteor-CollectionFS">CollectionFS</a> ‚Äî  ; </li></ul></li><li>  : <br><ul><li> <a href="https://meteorhacks.com/">MeteorHacks</a> ‚Äî  ; </li><li> <a href="https://www.eventedmind.com/">EventedMind</a> ‚Äî  ; </li><li> <a href="http://www.meteorpedia.com/read/Main_Page">Meteorpedia</a> ‚Äî  Wiki; </li><li> <a href="https://github.com/ericdouglas/Meteor-Learning">  </a> ; </li></ul></li><li> <a href="https://github.com/ovcharik/meteor-getting-started"></a> ,     </li></ul></div><p>Source: <a href="https://habr.com/ru/post/242943/">https://habr.com/ru/post/242943/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242929/index.html">Safe use of the RESET leg on the Arduino</a></li>
<li><a href="../242931/index.html">Alternative bug classification</a></li>
<li><a href="../242933/index.html">CERN plans to increase its computing capacity to 150,000 cores</a></li>
<li><a href="../242937/index.html">Windows Forms & Invoke from parallel threads</a></li>
<li><a href="../242939/index.html">Liskov Substitution Principle & Contracts</a></li>
<li><a href="../242945/index.html">Contract Interfaces & Inheritance</a></li>
<li><a href="../242947/index.html">Arachnidium self-made framework for testing web and mobile applications. Get started!</a></li>
<li><a href="../242949/index.html">We broadcast sound over the network using Java</a></li>
<li><a href="../242951/index.html">Who subscribed to Habrahabr?</a></li>
<li><a href="../242953/index.html">How and why "break" online shopping</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>