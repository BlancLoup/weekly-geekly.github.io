<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Record and modify sound in the browser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently decided for fun to make a site on which there will be a recording and modification of the sound. And I also wanted some appropriate animation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Record and modify sound in the browser</h1><div class="post__text post__text-html js-mediator-article">  Recently decided for fun to make a site on which there will be a recording and modification of the sound.  And I also wanted some appropriate animation.  I know how to work with sound in C ++ or C #, but I have never done it in a browser. <br>  A little googling, it turned out that there are not too many opportunities to record sound.  The most common is using Flash.  I have no experience in Flash, besides, I wanted to make the whole UI and functionality in JavaScript + HTML, so I had to somehow do without Flash or with minimal participation.  As a result, I found a <a href="http://www.sajithmr.me/jrecorder-jquery">jQuery jRecorder plugin</a> for recording sound, which eventually uses Flash, or rather ActionScript code, inside itself.  But since the work with sound was wrapped in JavaScript, this option suited me. <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/031/f42/5ee/031f425ee017106eb402383e890f3388.jpg"></a> <br><a name="habracut"></a><br>  My idea was to make the person speak something into the microphone, that sound was recorded, and then reproduced a little distorted.  For fun, I wanted to add there some more simple animation.  But, I'm a programmer, not a designer, so drawing a Flash or HTML5 movie is not at all mine.  I decided to unscrew more simple sposb - I drew the page of the site myself, but decided to use gif as animation.  Googled a funny Hamster who was chewing on something, and the thought came to mind - let him be silent (listening to a person say something into the microphone), and then ‚Äúsay‚Äù it.  That is, there was such a problem: <br>  - Sound recording <br>  - Sound distortion <br>  - Play the sound and turn on the animation <br><br>  Well, work has begun to boil.  First, I wrote a simple JS-code for the tests, which switches the gif image to the static picture of the Hamster: <br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPictureHamsterStop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"switch"</span></span>).src = <span class="hljs-string"><span class="hljs-string">"2.png"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPictureHamsterSpeech</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"switch"</span></span>).src = <span class="hljs-string"><span class="hljs-string">"3.gif"</span></span>; }</code> </pre> <br>  Next, it was necessary to embed the jRecorder code into my page, namely, that Gif was shown during audio playback and Png during recording.  jRecorder embeds the Flash window into the page and makes it invisible. <br>  In your page you need to insert a small block of CSS on top, and basically the body to place the initialization script with the settings: <br><pre> <code class="javascript hljs">$.jRecorder( { <span class="hljs-attr"><span class="hljs-attr">host</span></span> : <span class="hljs-string"><span class="hljs-string">'______wav'</span></span> , <span class="hljs-attr"><span class="hljs-attr">callback_started_recording</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{callback_started(); }, <span class="hljs-attr"><span class="hljs-attr">callback_stopped_recording</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{callback_stopped(); }, <span class="hljs-attr"><span class="hljs-attr">callback_activityLevel</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">level</span></span></span><span class="hljs-function">)</span></span>{callback_activityLevel(level); }, <span class="hljs-attr"><span class="hljs-attr">callback_activityTime</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">time</span></span></span><span class="hljs-function">)</span></span>{callback_activityTime(time); }, <span class="hljs-attr"><span class="hljs-attr">callback_finished_sending</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">time</span></span></span><span class="hljs-function">)</span></span>{ callback_finished_sending() }, <span class="hljs-attr"><span class="hljs-attr">swf_path</span></span> : <span class="hljs-string"><span class="hljs-string">'jRecorder.swf'</span></span>, } );</code> </pre><br>  I decided to put the site on a free hosting, for which I used my Google Drive account.  How to use it under a hosting on Habr√© already <a href="http://habrahabr.ru/post/160833/">wrote</a> .  There are a lot of restrictions, one of them does not allow <br>  I write a php-script file to Google Drive from the outside.  Therefore, the site can only be static.  But it did not bother me, since all the work is happening ‚Äúon the client‚Äù. <br>  Next, I copied all the JS code from the jReader and first of all removed from it callback handlers that I don‚Äôt need.  The main events for me were callback_started, callback_stopped, callback_finished_sending.  Callbacks speak for themselves.  The algorithm is simple: <br>  - After the recording starts, callback_started comes, and we set the picture as static (Hamster is silent and listens) <br>  - after stopping the recording, we get into callback_stopped and do SendFile <br>  - OnSendFinished shows the gif-animation, as the sound starts to play (this is according to the logic of jRecorder itself <br><br>  But here is the problem: when to start or stop recording?  I didn‚Äôt want to do this with a simple button, let the hamster say the words only when something was really said into the microphone, and there was no simple noise or silence. <br>  For this, I decided to analyze the sound level from the microphone, for good luck, jRecorder throws a callback_activityLevel, in which the sound level is transmitted - level.  I just had to come up with an algorithm.  And I decided to do this: <br>  - The method of selection set the optimal sound level, which can be considered noise (by the way, later, after digging into the ActionScript source code jRecorder, it turned out that it has a similar value and it is equal to mine). <br>  - Again, the method of selection set the threshold length of the recording noise.  That is, I started a simple counter, which each time increases by 1 if noise has come.  If this counter is greater than the threshold value, then we stop recording (there‚Äôs no need for us to record and reproduce noise). <br>  - Each time when entering the callback_activityLevel handler, we check if this level is noise: if yes, then increase the noise counter by 1, and if not, reset this counter (let's start counting again). <br>  - Additionally, set the Boolean flag, which is set to true if the noise threshold has been exceeded at least once during the entire record.  This is in order not to drive "empty" records over the network - we save traffic. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, if a person doesn‚Äôt say anything for a long time and doesn‚Äôt get any additional noise into the microphone, we don‚Äôt play anything.  In the case of a conspiracy (well, or noise, which also happens) we write 30 seconds of speech, <br>  or if a person stops talking earlier, our noise threshold meter will stop recording itself.  After stopping the sound is played: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> SILENCE_LEVEL = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> PEAK_LEVEL = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> MAX_SILENCE_TICKS = <span class="hljs-number"><span class="hljs-number">50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> MICROPHONE_AMPLIFY_LEVEL = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> silenceCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wasLevelPeak = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isRecording = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback_started</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     -    . setPictureHamsterStop(); silenceCounter = 0; totalTime = 0; wasLevelPeak = 0; isRecording = 1; } function callback_stopped(){ silenceCounter = 0; isRecording = 0; if (wasLevelPeak) { //   -  ,      . //           . wasLevelPeak = 0; $.jRecorder.sendData(); } else { $.jRecorder.record(30); } } function callback_finished_sending(){ //  GIF ,     . var timer = setTimeout('setPictureHamsterSpeech();', 2000); var timer = setTimeout('$.jRecorder.record(5);', totalTime * 1000); } function callback_activityLevel(level){ //   . if (level &gt; PEAK_LEVEL &amp;&amp; isRecording) { wasLevelPeak = 1; // ,  -... silenceCounter = 0; } //  ""    . if(level &lt; SILENCE_LEVEL &amp;&amp; isRecording) { silenceCounter = silenceCounter + 1; } //       -    // (   ,    ). if (silenceCounter == MAX_SILENCE_TICKS &amp;&amp; isRecording) { silenceCounter = 0; $.jRecorder.stop(); } }</span></span></code> </pre><br>  With the Java-Script part of the record-play sorted.  Now the next task is to modify the sound.  jRecorder comes with source codes on Action Script, but I don‚Äôt know it, and never really worked with Flash. <br>  But the ActionScript code was very natively comprehensible, and I quickly figured out the logic of sound recording and playback.  I needed to add a sound modification code, compile it into a * .swf file, and put in place of the existing jRecorder.swf.  I put the Trial version of Flash, opened the AudioRecorderCS4.fla project, google the sound modification code, and to my luck, on the <a href="http://help.adobe.com/en_US/ActionScript/3.0_ProgrammingAS3/WS1C0E1BE2-5322-4558-B7F9-73326C8F48EE.html">official website of Adobe I</a> found examples of working with sound. <br><br>  During recording from the microphone are packs of raw byte - samples.  In jRecorder, a sound processor is written, which, triggered by SampleDataEvent, added a new packet of bytes to the common heap so <br>  the result was a large array of bytes of recorded sound: <br><pre> <code class="javascript hljs">private <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSampleData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event:SampleDataEvent</span></span></span><span class="hljs-function">):</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ _recordingEvent.time = getTimer() - _difference; dispatchEvent( _recordingEvent ); <span class="hljs-comment"><span class="hljs-comment">//       while(event.data.bytesAvailable &gt; 0) _buffer.writeFloat(event.data.readFloat()); }</span></span></code> </pre><br><br>  To make the sound funnier, you just need to skip a few bytes, that is, during playback, the sound will play just faster: <br><pre> <code class="javascript hljs">private <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSampleData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event:SampleDataEvent</span></span></span><span class="hljs-function">):</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ _recordingEvent.time = getTimer() - _difference; dispatchEvent( _recordingEvent ); <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> event.data.position = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(event.data.bytesAvailable &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { _buffer.writeFloat(event.data.readFloat()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.data.bytesAvailable &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  , ,     -  { _buffer.writeFloat(event.data.readFloat()); } if (event.data.bytesAvailable &gt; 0) { event.data.position += 2; //  ,  - } } }</span></span></code> </pre><br><br>  Is done.  Ctrl + Enter, compile, replace jRecorder.swf, and get a working prototype.  A little Krivoruk of graphics: he drew a rocket in space, ‚Äúfitted‚Äù gif pictures in size so that the hamster ‚Äúsat‚Äù in a rocket <br>  (using the <a href="http://www.online-image-editor.com/">Online Image Editor</a> ) and laid out CIE at Google Drive hosting.  We open the site, Flash asks permission to access the microphone: <br><br>  If the user agrees, the write-play cycles begin.  As a result, it turned out to be a somewhat amusing hand-made article, plus an experience in working with sound.  Here is the result: <a href="https://googledrive.com/host/0B4Q3U97fHTqIVzhpb09XRTJ2enM/index.html">Space Hamster</a> . <br>  It may well happen that in some browser it will not work if there are any reviews, I will try to collect statistics on this issue. <br></div><p>Source: <a href="https://habr.com/ru/post/172299/">https://habr.com/ru/post/172299/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../172283/index.html">Ejabberd Crutches protection</a></li>
<li><a href="../172285/index.html">Implementing long-term arithmetic in C ++</a></li>
<li><a href="../172289/index.html">Large-scale update of the mobile version of 2GIS</a></li>
<li><a href="../172293/index.html">Technology to combat MiniDuke. Simple protection against complex threats?</a></li>
<li><a href="../172295/index.html">Mysterious FrontCache</a></li>
<li><a href="../172301/index.html">How graphics kill gameplay</a></li>
<li><a href="../172307/index.html">Registration of rights to the software without registering itself</a></li>
<li><a href="../172309/index.html">BAT: a wireless flying mouse that can prevent carpal tunnel syndrome</a></li>
<li><a href="../172311/index.html">Starcraft II Heart Of The Swarm online teleconference</a></li>
<li><a href="../172317/index.html">MakerBot company introduced a desktop 3D scanner</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>