<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating TMG traffic reports based on MS Reporting services. Continuation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 2: Reports 

 Hello, in the first part we created a table that is regularly, once an hour, filled with data. 
 Now, for example, we will build se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating TMG traffic reports based on MS Reporting services. Continuation</h1><div class="post__text post__text-html js-mediator-article"><h4>  Part 2: Reports </h4><br><br>  Hello, <a href="http://habrahabr.ru/post/188090/">in the first part</a> we created a table that is regularly, once an hour, filled with data. <br>  Now, for example, we will build several reports (for report generation, I used report builder 2.0). <br><a name="habracut"></a><br>  To warm up, let's build a report on the total traffic that has passed through TMG for a certain period of time: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> tmg <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(bytesrecvd)/<span class="hljs-number"><span class="hljs-number">1024</span></span>)/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(bytessent)/<span class="hljs-number"><span class="hljs-number">1024</span></span>)/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(bytesrecvd) + <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(bytessent))/<span class="hljs-number"><span class="hljs-number">1024</span></span>)/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.report <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logTime &gt;= @FromDate <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> logTime &lt;= @ToDate</code> </pre> <br>  In order to choose the length of time for which to build a report, I created the @FromDate and @ToDate variables (in builder 2.0, variables are created in the parameters section, the type of the date / time variable, default values ‚Äã‚Äãare not set). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So it looks like in the builder: <br><img src="http://habrastorage.org/storage2/631/571/5a9/6315715a900f049771b7e6b4177fa7f7.jpg" alt="image"><br><br>  It looks like a finished report: <br><img src="http://habrastorage.org/storage2/eb1/c88/6b9/eb1c886b96457435ab09fba973e5f1b4.jpg" alt="image"><br><br>  Now we will build a report on the consumption of Internet traffic by some department of the company.  To bind users to a department, we had to search for all sAMAccountName in the OU of the corresponding department (in order to make a request to AD, a Linked Server was created for one of the domain controllers). <br><br>  Make a request: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> tmg <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tbl <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">256</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> @tbl <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">'&lt; &gt;\' + sAMAccountName from openquery ( ADSII,'</span></span><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sAMAccountName <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>LDAP://&lt; &gt;<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> objectCategory = <span class="hljs-string"><span class="hljs-string">''</span></span>Person<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> objectClass = <span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-keyword"><span class="hljs-keyword">user</span></span><span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-string"><span class="hljs-string">') select clientusername, (SUM(bytessent)/1024)/1024 as '</span></span> M<span class="hljs-string"><span class="hljs-string">', (sum(bytesrecvd)/1024)/1024 as '</span></span> <span class="hljs-string"><span class="hljs-string">', ((SUM(bytesrecvd) + sum(bytessent))/1024)/1024 as '</span></span>   <span class="hljs-string"><span class="hljs-string">' from dbo.report where ClientUserName in ( SELECT name from @tbl) and (logTime &gt;= @FromDate AND logTime &lt;= @ToDate) group by clientusername</span></span></code> </pre><br>  It is worth noting here that using a temporary table to record the results of a query from AD, it allows you to significantly increase the performance of the report.  Report example: <br><img src="http://habrastorage.org/storage2/9d6/67a/cce/9d667acce67bf4323e4c0f934ed35fc1.jpg" alt="image"><br>  In this report, user names act as links to another report, in which these names, and fromdate, todate, are passed as parameters, this report will be discussed later. <br><br>  In the user report, we are interested in which sites he visited and how much traffic from them downloaded over a certain period of time, we make a request: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> tmg <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top (<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">percent</span></span> ClientUserName, destinationhost,(<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(bytesrecvd)/<span class="hljs-number"><span class="hljs-number">1024</span></span>)/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' '</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(bytessent)/<span class="hljs-number"><span class="hljs-number">1024</span></span>)/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">' M'</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(bytesrecvd) + <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(bytessent))/<span class="hljs-number"><span class="hljs-number">1024</span></span>)/<span class="hljs-number"><span class="hljs-number">1024</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'total'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> ISNUMERIC(<span class="hljs-keyword"><span class="hljs-keyword">replace</span></span>(destinationhost, <span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) )=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> destinationhost <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> dbo.ParseUrl(destinationhost) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> destinationhost, bytesrecvd, bytessent, clientusername, logtime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dbo.report )report2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (clientusername <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (logTime &gt;= @FromDate <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> logTime &lt;= @ToDate) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> clientusername, destinationhost <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> total <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span></code> </pre><br>  In this request, among other things, we check whether the destinationhost is FQDN, if it is, we parse it using the Parseurl function, and only after that we insert it into the report. <br><br>  Parseurl function: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [TMG] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> [dbo].[parseURL] ( @<span class="hljs-keyword"><span class="hljs-keyword">url</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @s <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>), @i <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (@<span class="hljs-keyword"><span class="hljs-keyword">url</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">url</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @s = <span class="hljs-keyword"><span class="hljs-keyword">REVERSE</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">url</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i = <span class="hljs-keyword"><span class="hljs-keyword">CHARINDEX</span></span>(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, @s) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> = @i) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">url</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @i = <span class="hljs-keyword"><span class="hljs-keyword">CHARINDEX</span></span>(<span class="hljs-string"><span class="hljs-string">'.'</span></span>, @s, @i + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> = @i) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">url</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REVERSE</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(@s, <span class="hljs-number"><span class="hljs-number">1</span></span>, @i - <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  In my case, the subdomains below the second level are uninteresting for the report, and the above function truncates them to the 2nd level: <br><img src="http://habrastorage.org/storage2/fcd/4d6/9f9/fcd4d69f96581a86846fa58d84f42160.jpg" alt="image"><br><br>  To improve performance, I recommend creating a nonclustered index, an example for my queries: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [TMG] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [dateindex2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [dbo].[REPORT] ( [logTime] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">INCLUDE</span></span> ( [ClientUserName], [bytesrecvd], [bytessent]) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, DROP_EXISTING = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br><br>  Findings: <br>  1 - Using a "clean" table allows you to reduce the amount of stored data and reduce the time to build a report. <br>  2 - SQL job, which puts the data in a clean table, runs an average of 30 seconds. <br>  3 - Reports are built no more than 5 minutes. <br>  4 - Reporting is not required to involve system administrators. <br><br>  PS: Thanks to my colleagues for answering questions about SQL, and for writing the parseurl procedure. </div><p>Source: <a href="https://habr.com/ru/post/188540/">https://habr.com/ru/post/188540/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188528/index.html">Autodesk creates a Russian application store and pays $ 100 for developers</a></li>
<li><a href="../188532/index.html">What is Echelon-GP?</a></li>
<li><a href="../188534/index.html">Industrial electronics design: how to design a device case</a></li>
<li><a href="../188536/index.html">How to make a working prototype of an electronic device</a></li>
<li><a href="../188538/index.html">Do you have an SSD on your work computer?</a></li>
<li><a href="../188544/index.html">Backup rule "3-2-1". Part 1</a></li>
<li><a href="../188550/index.html">Sim card as citizen ID</a></li>
<li><a href="../188554/index.html">Why did Windows 95 hang when formatting a floppy?</a></li>
<li><a href="../188556/index.html">August 1 - All-Russian Internet Strike (#Law Against Internet)</a></li>
<li><a href="../188558/index.html">Former corporation of good: what is actually "1GB for everyone home"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>