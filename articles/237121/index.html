<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Libgdx: Loading Screen and Loading Encrypted Resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Very often, mobile games require a loading screen, since resource loading can take a long time on various devices. In this article I will show my impl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Libgdx: Loading Screen and Loading Encrypted Resources</h1><div class="post__text post__text-html js-mediator-article">  Very often, mobile games require a loading screen, since resource loading can take a long time on various devices.  In this article I will show my implementation of the loader and file encryption using the <a href="http://libgdx.badlogicgames.com/">Libgdx</a> engine. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fdb/145/23b/fdb14523bd6feb2f61d07e71bd60c2ff.gif" alt="Simple gif animation loader to attract attention"><br><br>  In many applications, the boot screen is used only at startup (or not at all), while all images that may be needed are loaded at once.  This is convenient if your game is ‚ÄúFlappy Bird‚Äù and has several dozen pictures packed in an atlas 1024x1024 in size.  If the application is large, such as ‚ÄúCut The Rope‚Äù, then it will not be possible to download all the resources at once, and there is no need to download ‚Äúextra‚Äù resources, since the user may not even see them. <br><a name="habracut"></a><br><h4>  Part 1. Loader </h4><br>  The scheme of the loader is simple and transparent: <br><ol><li>  Add a screen that needs some resources. </li><li>  If resources are not loaded, add a bootloader screen on top of it. </li><li>  After downloading the resources, remove the loader </li></ol><br>  When implementing this algorithm, there are difficulties.  Consider the solution below. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Handling clicks when resources are not loaded yet.</i> <br>  This problem is solved by the screen manager, and each screen has an isActive () method inside it, which returns false if the screen is not ready. <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isTouched</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Rectangle rect, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pointer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isActive()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Gdx.input.isTouched(pointer) &amp;&amp; rect.contains(Gdx.input.getX(pointer), Gdx.input.getY(pointer)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPressed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isActive()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Gdx.input.isKeyPressed(key); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br>  <i>The loader has a beautiful animation with him, and you need to remove it after it has been completed.</i> <br>  All the logic of the animated bootloader will be built on methods that will return true if they are completed and you can go to the next.  stage. <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">assetsReady</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.assetsReady(); <span class="hljs-comment"><span class="hljs-comment">//   } @Override protected boolean isShowedScreen() { //  true,     } @Override protected void updateProgress() { //    } @Override protected void onAssetsLoaded() { //     } @Override protected boolean isHidedScreen() { //   ,  true }</span></span></code> </pre><br>  The improved loader logic looks like this (an example with the replacement of a loaded screen with a new one): <br><ol><li>  Add a second screen that needs some resources. </li><li>  If resources are not loaded, add a bootloader screen on top of it. </li><li>  Loader show animation is displayed, resources start to load simultaneously. </li><li>  After downloading the resources, we want to display the second screen already, so we delete the first screen. </li><li>  Loader hiding animation is displayed. </li><li>  Hide the loader and change the clicker to the second screen. </li></ol><br>  <i>When deleting downloaded resources from memory, resources that are used by other screens are deleted.</i> <br>  When deleting the screen, you need to unload resources from the memory that are no longer used.  For this purpose, this method serves (it will unload only those resources that are not in demand by other screens) <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> checkDependencies)</span></span></span><span class="hljs-function"> </span></span>{ loaded = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (checkDependencies) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (CoreScreen screen : coreManager.screens) { BaseAsset&lt;?&gt;[] screenAssets = screen.getAssets(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (BaseAsset&lt;?&gt; screenAsset : screenAssets) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (screenAsset != <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> &amp;&amp; name.equals(screenAsset.name)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">// neededByOtherAsset } } } } coreManager.resources.unload(name); }</span></span></code> </pre><br>  This loader allows the application to spend less resources, and reduces the user expectation, thereby making the application more convenient. <br><br><h4>  Part 2. Encryption </h4><br>  Sometimes it becomes necessary to encrypt resources.  Of course, if the application can decrypt them, then the user can, but it will not be so easy, especially if you did not forget to use ProGuard when you release the application (to protect the data stored in it).  In Libgdx, when working with the file system, an abstraction is necessary so that there is a similar behavior on different operating systems.  When working with internal resources, you can transfer your implementation of FileResolver to the AssetManager constructor, which in turn will return its implementation of FileHandle, which will return its implementation of InputStream. <br>  In my case, the logic is simple, and the wrapper for the InputStream replaces the main read () method. <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> one; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((one = inputStream.read()) != -<span class="hljs-number"><span class="hljs-number">1</span></span>) { one = CryptUtil.proceedByte(one, position); ++position; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> one; } <span class="hljs-comment"><span class="hljs-comment">// CryptUtil.java private static final int[] CRYPT_VALS = { 13, 177, 24, 36, 222, 89, 85, 56 }; static int proceedByte(int data, long position) { return (data ^ CRYPT_VALS[(int) (position % CRYPT_VALS.length)]); }</span></span></code> </pre><br>  When reading from a file, we only perform an XOR operation on the received byte with the value from the array.  Of course, this method can be complicated by hammering the beginning of the file with the numbers of the array, and initialize this array when it is first read. <br><br>  Unfortunately, these are not all the places where you need to wrap a FileHandle.  When loading atlases, the loadable dependencies are obtained in a different way, because for encrypted files we will add a new type, with the permission ".atlascrypt", and also inform AssetManager that this type has a new loader: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CryptTextureAtlasLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TextureAtlasLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CryptTextureAtlasLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FileHandleResolver resolver)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(resolver); } <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"rawtypes"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Array&lt;AssetDescriptor&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDependencies</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileName, FileHandle atlasFile, TextureAtlasParameter parameter)</span></span></span><span class="hljs-function"> </span></span>{ Array&lt;AssetDescriptor&gt; dependencies = <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.getDependencies(fileName, atlasFile, parameter); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (AssetDescriptor descriptor : dependencies) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(descriptor.file <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> CryptFileHandle)) { descriptor.file = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptFileHandle(descriptor.file); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dependencies; } }</code> </pre><br><br><h4>  Conclusion </h4><br>  To demonstrate the performance recorded video: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/7ix5eEuofw8%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253&amp;usg=ALkJrhg3_fgs8jHyjgALecKxCBx9ZceHHQ" frameborder="0" allowfullscreen=""></iframe><br><br>  Of course, all this text would be useless without source. <br>  Available on the <a href="https://github.com/withoutuniverse/libgdx">GitHub</a> link. </div><p>Source: <a href="https://habr.com/ru/post/237121/">https://habr.com/ru/post/237121/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237105/index.html">Windows 2012 R2 + IIS + MS SQL + PHP installation, configuration, pitfalls</a></li>
<li><a href="../237107/index.html">How an IT freelancer to become an entrepreneur. Part 1</a></li>
<li><a href="../237109/index.html">From analog to digital, or do it yourself IP camera</a></li>
<li><a href="../237111/index.html">Stephen Fry Pro New iPhone 6</a></li>
<li><a href="../237117/index.html">Bringing to mind the website hosting: 10 tips</a></li>
<li><a href="../237125/index.html">5 million security startup</a></li>
<li><a href="../237127/index.html">How I participated in the competition of small games js13kGames</a></li>
<li><a href="../237129/index.html">Traffic from social networks: the most modern methods of attraction, return and analysis</a></li>
<li><a href="../237131/index.html">Welcome to HadoopKitchen</a></li>
<li><a href="../237133/index.html">Why is the grass green and programmers cool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>