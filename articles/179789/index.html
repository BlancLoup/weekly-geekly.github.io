<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fighting duplicates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing the topic of using dynamic SQL, I want to talk about one useful tool that I implemented in one of the current projects. It will be about du...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fighting duplicates</h1><div class="post__text post__text-html js-mediator-article">  Continuing the <a href="http://habrahabr.ru/post/177957/">topic of</a> using dynamic SQL, I want to talk about one useful tool that I implemented in one of the current projects.  It will be about duplicates in reference books.  By duplicates, in this article, I understand the entries made to reference books again, for example, as a result of a spelling error when entering a name. <br><a name="habracut"></a><br>  The essence of the approach proposed by me is to make it possible to declare any record of the directory a duplicate of an existing one.  As a result, the duplicate entry will be deleted, and all references to it will be corrected so that they refer to the correct entry.  It is also very important to provide the opportunity to roll back such changes, in case they are made by mistake. <br><br>  Let's start with the tables for storing service data: <br><br><div class="spoiler">  <b class="spoiler_title">Utility tables</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_table ( table_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, pk_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(table_name) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> mg_action_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_action ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'mg_action_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, table_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> mg_table(table_name), old_id <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, new_id <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, action_time <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> mg_action_detail_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_action_detail ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'mg_action_detail_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, action_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> mg_action(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), table_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, pk_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, column_name <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, obj_id <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre> <br></div></div><br>  Here, the mg_table table contains data about tables for which duplicate merge is supported.  The only requirement for such tables is that the primary key must consist of a single numeric or string column.  We do not have to worry about this table, as it will be filled automatically.  The mg_action and mg_action_detail tables will contain the data needed to roll back the changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Define a pair of auxiliary functions: <br><br><div class="spoiler">  <b class="spoiler_title">Secondary functions</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mg_get_pk_column(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_table <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_pk <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; l_cn int; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(f.name), <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_pk, l_cn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ps_array_to_set(a.conkey) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_constraint a, pg_class b <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> b.oid = a.conrelid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> a.contype = <span class="hljs-string"><span class="hljs-string">'p'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> b.relname = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table) ) c, ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> d.attname <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, d.attnum <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> nn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_attribute d, pg_class e <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> e.oid = d.attrelid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> e.relname = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table) ) f <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> f.nn = c.nn; if l_cn &lt;&gt; 1 then raise EXCEPTION 'Can''t support composite PK'; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; return l_pk; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; $$ language plpgsql; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mg_add_dict(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_table <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_pk <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>; l_sql text; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> l_pk := mg_get_pk_column(p_table); perform 1 from mg_table where table_name = lower(p_table); if not FOUND then l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || lower(p_table) || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(p_table) || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">'; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || lower(p_table) || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">add</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-string"><span class="hljs-string">' || l_pk || '</span></span>)<span class="hljs-string"><span class="hljs-string">'; execute l_sql; insert into mg_table(table_name, pk_name) values (lower(p_table), l_pk); end if; end; $$ language plpgsql;</span></span></code> </pre><br></div></div><br>  The function mg_get_pk_column performs the query known to us from the previous <a href="http://habrahabr.ru/post/177957/">article</a> , which returns the name of the primary key column, and also checks that the primary key consists of one column. <br><br>  The function mg_add_dict, in addition to filling in mg_table, creates a table with the prefix 'mg_' in which deleted duplicates will be saved, in case the change needs to be rolled back.  By its structure, this table is completely similar to the original. <br><br>  We turn to the most interesting: <br><br><div class="spoiler">  <b class="spoiler_title">mg_merge</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mg_merge(<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_table <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_old <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> p_new <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_action <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; l_pk text; l_sql text; tabs record; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> perform mg_add_dict(p_table); <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pk_name <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_pk <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_table <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_name = <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(p_table); l_action := nextval('mg_action_seq'); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> mg_action(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, table_name, old_id, new_id) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (l_action, p_table, p_old, p_new); l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || lower(p_table) || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(p_table) || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || l_pk || '</span></span> = <span class="hljs-string"><span class="hljs-string">''' || p_old || ''''; execute l_sql; for tabs in select b.relname as table_name, d.attname as column_name from pg_constraint a, pg_class b, pg_class c, pg_attribute d where a.contype = '</span></span>f<span class="hljs-string"><span class="hljs-string">' and b.oid = a.conrelid and c.oid = a.confrelid and c.relname = lower(p_table) and d.attrelid = b.oid and a.conkey[1] = d.attnum loop l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> mg_action_detail(action_id, table_name, column_name, obj_id, pk_name) <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">' || l_action || '</span></span>, <span class="hljs-string"><span class="hljs-string">''' || tabs.table_name || '''</span></span>, <span class="hljs-string"><span class="hljs-string">''' || tabs.column_name || '''</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-string"><span class="hljs-string">' || '''' || mg_get_pk_column(tabs.table_name::varchar) || '''</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(tabs.table_name) || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(tabs.column_name) || '</span></span> = <span class="hljs-string"><span class="hljs-string">''' || p_old || ''''; execute l_sql; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(tabs.table_name) || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(tabs.column_name) || '</span></span> = <span class="hljs-string"><span class="hljs-string">''' || p_new || '''</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(tabs.column_name) || '</span></span> = <span class="hljs-string"><span class="hljs-string">''' || p_old || ''''; execute l_sql; end loop; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">' || lower(p_table) || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">' || l_pk || '</span></span> = <span class="hljs-string"><span class="hljs-string">''' || p_old || ''''; execute l_sql; end; $$ language plpgsql; create or replace function mg_merge(in p_table varchar, in p_old bigint, in p_new bigint) returns void as $$ declare begin perform mg_merge(p_table, p_old::varchar, p_new::varchar); end; $$ language plpgsql;</span></span></code> </pre><br></div></div><br>  This function performs a search for all tables that reference p_table with a foreign key and replaces p_old with p_new in them, saving the data necessary for rolling back the changes.  Since, most often, the primary key column will be numeric, for convenience, the mg_merge function (varchar, bigint, bigint) is overloaded. <br><br>  It remains to develop a function of rollback changes: <br><br><div class="spoiler">  <b class="spoiler_title">mg_undo</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replace</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> mg_undo() <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> l_action <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; l_old varchar(50); l_table text; l_sql text; tabs record; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_action <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_action; if l_action is null then raise EXCEPTION 'Can''t UNDO'; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_name, old_id <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> l_table, l_old <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_action <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = l_action; l_sql := '<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> <span class="hljs-string"><span class="hljs-string">' || l_table || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || l_table || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-string"><span class="hljs-string">''' || l_old || ''''; execute l_sql; for tabs in select table_name, pk_name, column_name from mg_action_detail where action_id = l_action group by table_name, pk_name, column_name loop l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-string"><span class="hljs-string">' || tabs.table_name || '</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-string"><span class="hljs-string">' || tabs.column_name || '</span></span> = <span class="hljs-string"><span class="hljs-string">''' || l_old || '''</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-string"><span class="hljs-string">''''</span></span> || <span class="hljs-string"><span class="hljs-string">' || tabs.pk_name || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-string"><span class="hljs-string">''''</span></span> || obj_id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_action_detail <span class="hljs-string"><span class="hljs-string">'|| '</span></span><span class="hljs-keyword"><span class="hljs-keyword">where</span></span> table_name = <span class="hljs-string"><span class="hljs-string">''' || tabs.table_name || '''</span></span> <span class="hljs-string"><span class="hljs-string">' || '</span></span><span class="hljs-keyword"><span class="hljs-keyword">and</span></span> action_id = <span class="hljs-string"><span class="hljs-string">' || l_action || '</span></span>) <span class="hljs-string"><span class="hljs-string">'; execute l_sql; end loop; l_sql := '</span></span><span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mg_<span class="hljs-string"><span class="hljs-string">' || l_table || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-string"><span class="hljs-string">''' || l_old || ''''; execute l_sql; delete from mg_action_detail where action_id = l_action; delete from mg_action where id = l_action; end; $$ language plpgsql;</span></span></code> </pre><br></div></div><br>  The changes will be rolled back in the order strictly created against them.  For this reason, no arguments are required for mg_undo. <br><br>  Let's see how it all works.  Create reference tables: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> city_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> city ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'city_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> street_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> street ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'street_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, city_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> city(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> address_seq; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> address ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'address_seq'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, street_id <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> street(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), house <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, apartment <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) );</code> </pre><br>  ... and fill them with test data: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> city(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> street(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, city_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> street(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, city_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> address(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, street_id, house, apartment) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'10'</span></span>, <span class="hljs-string"><span class="hljs-string">'1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> address(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, street_id, house, apartment) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'10'</span></span>, <span class="hljs-string"><span class="hljs-string">'2'</span></span>);</code> </pre><br><br>  Now, in order to "merge" the street "Victory Avenue" with the street "Victory", it is enough to run the following command: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> mg_merge(<span class="hljs-string"><span class="hljs-string">'street'</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre><br>  The function mg_undo (), as mentioned above, rolls back the changes. <br><br>  Hope this was helpful to someone.  Sources are posted on <a href="https://github.com/GlukKazan/mg">GitHub</a> . <br></div><p>Source: <a href="https://habr.com/ru/post/179789/">https://habr.com/ru/post/179789/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179777/index.html">Big changes on Yandex - ‚ÄúIslands‚Äù platform: interactive answers in search results</a></li>
<li><a href="../179781/index.html">Virtuilka - the current state of affairs</a></li>
<li><a href="../179783/index.html">PayPal received the Russian license of NPO</a></li>
<li><a href="../179785/index.html">Runetology (198): Sergey Vilyanov, Editor-in-Chief of the World PC Magazine</a></li>
<li><a href="../179787/index.html">23 statistical facts about users of social communities and media</a></li>
<li><a href="../179795/index.html">Googlers answer user questions about Google I / O 2013 on the social network Google+</a></li>
<li><a href="../179799/index.html">Eleventh commandment: ‚ÄúDo not postpone‚Äù</a></li>
<li><a href="../179801/index.html">BBC Click Program on Smart City and the Future of Modern Urban Transport</a></li>
<li><a href="../179803/index.html">Locking sessions in web projects - choosing an effective weapon</a></li>
<li><a href="../179805/index.html">On the threshold of the boom of electric vehicles: Tesla Motors made a profit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>