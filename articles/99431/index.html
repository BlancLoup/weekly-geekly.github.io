<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Correct PHP error handling</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What I mean by proper processing: 


- A universal solution that can be inserted into any existing code; 
- Easily expandable solution; 
- In PHP, the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Correct PHP error handling</h1><div class="post__text post__text-html js-mediator-article"><h1>  What I mean by proper processing: </h1><br><ul><li>  A universal solution that can be inserted into any existing code; </li><li>  Easily expandable solution; </li><li>  In PHP, there are already three "error mechanisms": the actual errors (error), exceptions (exception), and assertions.  Reduce the three mechanisms to one - exception.  In comments to the previous <a href="http://habrahabr.ru/blogs/php/30399/">article on this topic, the</a> view was expressed that exception is a bad and / or complex error handling method.  I do not think so and am ready to discuss this in the comments; </li><li>  Optional logging; </li><li>  General exception handler that will support different output formats and debug / production modes; </li><li>  In debug mode, trace should be output.  Requirements for trace: compact, clear and, if possible, links to open files in the IDE. </li></ul><br><a name="habracut"></a><br><h1>  Universal solution </h1><br>  To do this, we will make the class exceptionHandlerClass.  In exceptionHandlerClass settings and static methods will be stored - error, exception, and assertion handlers.  We also need the setupHandlers and restoreHandlers methods.  The first method will set up error trapping.  Error and assertion handlers will throw an ErrorException.  The Exception handler will handle the raw Exception and output the appropriate response depending on the settings.  restoreHandlers will return all handlers to their original state - this will help when embedding a class in code with an existing error handling mechanism.  Connection looks like this: <br><blockquote><ol><li>  <font color="#b1b100">require</font> <font color="#0000ff">'exceptionHandler / exceptionHandlerClass.php'</font> <font color="#339933">;</font> </li><li>  exceptionHandlerClass <font color="#339933">::</font> <font color="#004000">setupHandlers</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li></ol></blockquote><br>  enable debug mode (disabled by default): <br><blockquote><ol><li>  exceptionHandlerClass <font color="#339933">::</font> <font color="#000088">$ debug</font> <font color="#339933">=</font> <font color="#009900">true</font> <font color="#339933">;</font> </li></ol></blockquote><br><h1>  Output formats </h1><br>  It‚Äôs easier to explain with an example: to output trace on a web page, I wrap it in pre tags and use htmlspecialchars (), on the other hand, the same trace would not be convenient to read to the console, it would be easier if it were plainText.  If you want to display an error as a SoapServer response, then it must be a well-formed XML document (SoapFault).  If the script displays binary data, such as an image, then it is more convenient to display errors via WildFire.  In all these situations, you just need to apply different output formats. <br>  For different formats we will create different classes.  To begin with, I implement two output formats, exceptionHandlerOutputWeb (for the web) and exceptionHandlerOutputCli (for the command line).  We also need a factory class (exceptionHandlerOutputFactory), in which logic will be encapsulated, when and what output format to apply. <br><blockquote><ol><li>  <font color="#000000">public</font> <font color="#000000">function</font> getExceptionHandlerOutput <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#990000">php_sapi_name</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">==</font> <font color="#0000ff">'cli'</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">return</font> <font color="#000000">new</font> exceptionHandlerOutputCli <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#b1b100">return</font> <font color="#000000">new</font> exceptionHandlerOutputWeb <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote><br>  When you call setupHandlers, you can set the output format by passing an instance of the class exceptionHandlerOutput * or exceptionHandlerOutputFactory *. <br><blockquote><ol><li>  exceptionHandlerClass <font color="#339933">::</font> <font color="#004000">setupHandlers</font> <font color="#009900">(</font> <font color="#000000">new</font> exceptionHandlerOutputAjax <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li></ol></blockquote><br>  Thanks to this architecture, you can easily expand formats.  To create a new format, it is enough to create a class that will inherit from the abstract class exceptionHandlerOutput and implement one method (output). <br><blockquote><ol><li>  <font color="#000000">class</font> exceptionHandlerOutputAjax <font color="#000000">extends</font> exceptionHandlerOutput <font color="#009900">{</font> </li><li>  <font color="#000000">public</font> <font color="#000000">function</font> output <font color="#009900">(</font> <font color="#000088">$ exception</font> <font color="#339933">,</font> <font color="#000088">$ debug</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#990000">header</font> <font color="#009900">(</font> <font color="#0000ff">'HTTP / 1.0 500 Internal Server Error'</font> <font color="#339933">,</font> <font color="#009900">true</font> <font color="#339933">,</font> <font color="#cc66cc">500</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#990000">header</font> <font color="#009900">(</font> <font color="#0000ff">'Status: 500 Internal Server Error'</font> <font color="#339933">,</font> <font color="#009900">true</font> <font color="#339933">,</font> <font color="#cc66cc">500</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#000088">$ response</font> <font color="#339933">=</font> <font color="#990000">array</font> <font color="#009900">(</font> </li><li>  <font color="#0000ff">'error'</font> <font color="#339933">=&gt;</font> <font color="#009900">true</font> </li><li>  <font color="#0000ff">'message'</font> <font color="#339933">=&gt;</font> <font color="#0000ff">''</font> <font color="#339933">,</font> </li><li>  <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000088">$ debug</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#000088">$ response</font> <font color="#009900">[</font> <font color="#0000ff">'message'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000088">$ exception</font> <font color="#339933">-&gt;</font> <font color="#004000">getMessage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> <font color="#b1b100">else</font> <font color="#009900">{</font> </li><li>  <font color="#000088">$ response</font> <font color="#009900">[</font> <font color="#0000ff">'message'</font> <font color="#009900">]</font> <font color="#339933">=</font> <font color="#000000">self</font> <font color="#339933">::</font> <font color="#000088">$ productionMessage</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#990000">exit</font> <font color="#009900">(</font> <font color="#990000">json_encode</font> <font color="#009900">(</font> <font color="#000088">$ response</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote><br>  If you need more complex logic to automatically select the output format, you need to create a class that inherits from exceptionHandlerOutputFactory and implement the getExceptionHandlerOutput method. <br><blockquote><ol><li>  <font color="#000000">class</font> exceptionHandlerOutputAjaxFactory <font color="#000000">extends</font> exceptionHandlerOutputDefaultFactory <font color="#009900">{</font> </li><li>  <font color="#000000">public</font> <font color="#000000">function</font> getExceptionHandlerOutput <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#000000">self</font> <font color="#339933">::</font> <font color="#004000">detect</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">return</font> <font color="#000000">new</font> exceptionHandlerOutputAjax <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  parent <font color="#339933">::</font> <font color="#004000">getExceptionHandlerOutput</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#000000">public</font> static <font color="#000000">function</font> detect <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">return</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#990000">empty</font> <font color="#009900">(</font> <font color="#000088">$ _SERVER</font> <font color="#009900">[</font> <font color="#0000ff">'HTTP_X_REQUESTED_WITH'</font> <font color="#009900">]</font> <font color="#009900">)</font> </li><li>  <font color="#339933">&amp;&amp;</font> <font color="#990000">strtolower</font> <font color="#009900">(</font> <font color="#000088">$ _SERVER</font> <font color="#009900">[</font> <font color="#0000ff">'HTTP_X_REQUESTED_WITH'</font> <font color="#009900">]</font> <font color="#009900">)</font> <font color="#339933">==</font> <font color="#0000ff">'xmlhttprequest'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li><li>  exceptionHandlerClass <font color="#339933">::</font> <font color="#004000">setupHandlers</font> <font color="#009900">(</font> <font color="#000000">new</font> exceptionHandlerOutputAjaxFactory <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li></ol></blockquote><br><h1>  Logging </h1><br>  As I said above, logging can be enabled as desired.  To do this, the exceptionLand method is created in exceptionHandlerClass <br><blockquote><ol><li>  <font color="#000000">public</font> static <font color="#000000">function</font> exceptionLog <font color="#009900">(</font> <font color="#000088">$ exception</font> <font color="#339933">,</font> <font color="#000088">$ logPriority</font> <font color="#339933">=</font> <font color="#009900">null</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">if</font> <font color="#009900">(</font> <font color="#339933">!</font> <font color="#990000">is_null</font> <font color="#009900">(</font> <font color="#000000">self</font> <font color="#339933">::</font> <font color="#000088">$ exceptionHandlerLog</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#000000">self</font> <font color="#339933">::</font> <font color="#000088">$ exceptionHandlerLog</font> <font color="#339933">-&gt;</font> <font color="#004000">log</font> <font color="#009900">(</font> <font color="#000088">$ exception</font> <font color="#339933">,</font> <font color="#000088">$ logPriority</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote><br>  if you need to enable logging, it is enough to do the following: <br><blockquote><ol><li>  exceptionHandlerClass <font color="#339933">::</font> <font color="#000088">$ exceptionHandlerLog</font> <font color="#339933">=</font> <font color="#000000">new</font> exceptionHandlerSimpleLog <font color="#009900">(</font> <font color="#009900">)</font> <font color="#339933">;</font> </li></ol></blockquote><br>  The class for logging must be inherited from the abstract exceptionHandlerLog and implement the log method <br><blockquote><ol><li>  <font color="#000000">class</font> exceptionHandlerSimpleLog <font color="#000000">extends</font> exceptionHandlerLog <font color="#009900">{</font> </li><li>  <font color="#000000">public</font> <font color="#000000">function</font> <font color="#990000">log</font> <font color="#009900">(</font> <font color="#000088">$ exception</font> <font color="#339933">,</font> <font color="#000088">$ logType</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">switch</font> <font color="#009900">(</font> <font color="#000088">$ logType</font> <font color="#009900">)</font> <font color="#009900">{</font> </li><li>  <font color="#b1b100">case</font> <font color="#000000">self</font> <font color="#339933">::</font> <font color="#004000">uncaughtException</font> <font color="#339933">:</font> </li><li>  <font color="#990000">error_log</font> <font color="#009900">(</font> <font color="#000088">$ exception</font> <font color="#339933">-&gt;</font> <font color="#004000">getMessage</font> <font color="#009900">(</font> <font color="#009900">)</font> <font color="#009900">)</font> <font color="#339933">;</font> </li><li>  <font color="#b1b100">break</font> <font color="#339933">;</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li><li>  <font color="#009900">}</font> </li></ol></blockquote><br>  logType is one of the constants declared by exceptionHandlerLog <br><blockquote><ol><li>  <font color="#000000">const</font> uncaughtException <font color="#339933">=</font> <font color="#cc66cc">0</font> <font color="#339933">;</font>  <font color="#666666">// unhandled exceptions</font> </li><li>  <font color="#000000">const</font> caughtException <font color="#339933">=</font> <font color="#cc66cc">1</font> <font color="#339933">;</font>  <font color="#666666">// call the logging method outside of error handlers</font> </li><li>  <font color="#000000">const</font> ignoredError <font color="#339933">=</font> <font color="#cc66cc">2</font> <font color="#339933">;</font>  <font color="#666666">// masked @ errors are logged if the scream option is disabled</font> </li><li>  <font color="#000000">const</font> lowPriorityError <font color="#339933">=</font> <font color="#cc66cc">3</font> <font color="#339933">;</font>  <font color="#666666">// errors that do not become exception</font> </li><li>  <font color="#000000">const</font> assertion <font color="#339933">=</font> <font color="#cc66cc">4</font> <font color="#339933">;</font>  <font color="#666666">// assertion</font> </li></ol></blockquote><br>  With logType and exception, the developer can decide for himself what exceptions and how to log.  For example, uncaughtException can be sent by mail, ignoredError with severity E_ERROR log to a file and so forth. <br><br><h1>  Trace </h1><br>  When I output trace, I want to see the type of the exception, the message, and the trace itself.  In the trace for each call should be displayed, which function was called, a list of "short" parameters, the file and the line where the call occurred.  I will explain what the ‚Äúshort‚Äù parameters are with examples: if the function was called with a string of 1000 characters in length, the presence of this string in the trace will not do anything to solve the problem, but will only make it more difficult to read the trace, the same goes for arrays with great nesting.  Conclusion trace on the screen just has to tell where to look.  To figure out what exactly is happening you need to debug using xdebug or primitive var_dump () and die (), which one you like best. <br>  Example trace: <br><pre>	 [ErrorException]: E_WARNING - mysql_connect (): Can't connect to MySQL server on 'localhost' (10061)
	 # 0: mysql_connect ()
	     D: \ projects1 \ d \ index.php: 19
	 # 1: testClass :: test1 ("long string ... eeeeeery long string" (56))
	     D: \ projects1 \ d \ index.php: 22
	 # 2: testClass-&gt; test2 (testClass (), -‚àû, i: iTest, c: testClass, fa: testClass :: test2)
	     D: \ projects1 \ d \ index.php: 27
	 # 3: testAll (r: stream, fs: testClass :: test1)
	     D: \ projects1 \ d \ index.php: 30
</pre>  Legend <ul><li>  r: - resource </li><li>  fs: - function (callable string) </li><li>  fa: - function (callable array) </li><li>  i: - interface (string) </li><li>  c: - class (string) </li><li>  ‚àû / INF - infinity </li><li>  testClass () - object of type testClass </li><li>  "" (n) - string, length in brackets, ... is the place where part of the string is cut </li><li>  array (n) - array, length shown in brackets </li></ul><h1>  And the most useful ... links to open files in the IDE right from the trace. </h1>  Clicking on the link in the IDE will open the corresponding file on the appropriate line. <br>  For console mode (NetBeans console): <br><img src="http://img2.pict.com/4f/fe/b1/3807302/0/nbc.png" alt="NetBeans Console"><br><blockquote><ol><li>  exceptionHandlerOutputCli <font color="#339933">::</font> <font color="#004000">setFileLinkFormat</font> <font color="#009900">(</font> <font color="#0000ff">': in% f on line% l'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li></ol></blockquote>  For web mode (TextMate): <blockquote><ol><li>  exceptionHandlerOutputWeb <font color="#339933">::</font> <font color="#004000">setFileLinkFormat</font> <font color="#009900">(</font> <font color="#0000ff">'txmt: // open /? file: //% f &amp; line =% l'</font> <font color="#009900">)</font> <font color="#339933">;</font> </li></ol></blockquote><br>  It can be implemented for NetbBeans (or another IDE).  To do this: register the protocol;  make a handler for this protocol (the simplest is a bat file).  In the handler, call NetBeans with the appropriate file and string via the command line.  But this is the topic for the next article. <br>  The code was written in two days so that minor defects are possible.  <a href="http://narod.ru/disk/22879627000/ExceptionHandler.zip.html">Download</a> (did not have time to put in the repository). <br><br>  <strong>UPD:</strong> moved to PHP blog <br>  <strong>UPD2:</strong> in the continuation of the topic <a href="http://habrahabr.ru/blogs/php/100137/">work with exceptions in PHP</a> </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/99431/">https://habr.com/ru/post/99431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../99422/index.html">BranchCache in Windows 7</a></li>
<li><a href="../99423/index.html">Pissing off 2.0</a></li>
<li><a href="../99425/index.html">On a laptop in heat in the sun? Will it survive the iron?</a></li>
<li><a href="../99426/index.html">Brief history of computer iconography</a></li>
<li><a href="../99430/index.html">Overview of the GPS navigator NEC GPS 434B</a></li>
<li><a href="../99432/index.html">Improvements in the caching subsystem of Internet Explorer 9</a></li>
<li><a href="../99435/index.html">How much time does it usually take you to go to work (one way)?</a></li>
<li><a href="../99437/index.html">Laptop Lenovo W701 or Why do I need a steam locomotive at home</a></li>
<li><a href="../99439/index.html">Connecting Sberbank Internet Client to Ubuntu via rdesktop</a></li>
<li><a href="../99440/index.html">500 million Facebook users</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>