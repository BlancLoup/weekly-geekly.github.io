<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Effective way to protect against piracy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are a developer of ios applications, then most likely, the topic of piracy is familiar to you, painful and unpleasant. I hope you will be inter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Effective way to protect against piracy</h1><div class="post__text post__text-html js-mediator-article">  If you are a developer of ios applications, then most likely, the topic of piracy is familiar to you, painful and unpleasant.  I hope you will be interested in understanding how to hinder it and what you need to do in order not to see your application in the hackulo.us repository an hour after its release in the appstore. <br><a name="habracut"></a><br><h4>  In search of easy money </h4><br>  To begin with, consider what Apple has done for our protection.  This DRM is called FairPlay and its competence includes full encryption of the executable file, which, according to the apple, should prevent reverse engineering and unauthorized copying.  In general, the system copes with its tasks, but only until such time as our application gets on iDevice.  The fact is that the processor does not know how to execute encrypted instructions, so the operating system, after loading the file into memory and immediately before its execution, performs its full decryption.  Exactly this feature is exploited by the entire Cracker software.  Waiting for the application to be completely decrypted in memory and ready for execution, the cracker utility dumps its image into a file. <br><br>  For clarity, I will show how this can be done with gdb: <br><pre><code class="hljs lua"><span class="hljs-keyword"><span class="hljs-keyword">break</span></span> main #       command <span class="hljs-number"><span class="hljs-number">1</span></span> #     ,      <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.bin <span class="hljs-built_in"><span class="hljs-built_in">dump</span></span> memory <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>.bin <span class="hljs-number"><span class="hljs-number">0x2000</span></span> cryptsize # cryptsize   otool -l   LC_ENCRYPTION_INFO kill quit <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> start</code> </pre> <br>  Then, change the pair of service fields in the header of the executable file mach-o and Info.plist.  That's all.  Our application is ready to go free.  But, the most annoying thing is that with the release of fully automated utilities, such as Crackulous, any schoolchild can do this operation, even without having the slightest idea how things work out. <br><br>  Naturally, this situation could not leave the developer community indifferent.  You can easily google a dozen solutions that will help cope with schoolchildren, but are completely helpless against even a novice cracker.  Why?  Let's take a closer look.  The main idea of ‚Äã‚Äãchecks is to track changes in the application bundle.  For example, a different creation time of the executable file and Info.plist, or the size of Info.plist is different from the reference, or the _CodeSignature directory is missing.  As it should be for ios applications, all these checks are written in ObjC using frameworks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Try to open the executable file of your application in a text editor, and even better through the console utility strings.  See you  Everything that you use, lies in full view.  It is enough to load the binary into IDA and see who and where in the code uses all these NSBundle, NSDate and NSFileSize.  Where are the ‚Äúmenacing‚Äù warnings of Crack Detected, etc. used?  Having found the check, it is not difficult for the hacker to change 1-2 bytes so that the check always returns a convenient value. <br><br>  The disadvantage of all these methods is that they are very easily found by static analysis, because they use frameworks, methods and classes of ObjC.  So, we need a way that could not be found on the general templates, written in pure C, without using classes and frameworks.  Here is the best that Google showed me: <br><pre> <code class="hljs lua">#import &lt;mach-o/dyld.h&gt; #define LC_ENCRYPTION_INFO <span class="hljs-number"><span class="hljs-number">0x21</span></span> struct encryption_info_command { uint32_t cmd; uint32_t cmdsize; uint32_t cryptoff; uint32_t cryptsize; uint32_t cryptid; }; static BOOL is_encrypted () { //         dladdr(main, &amp;dlinfo),   iphone  , //  ,       dl- struct mach_header *header = <span class="hljs-number"><span class="hljs-number">0x1000</span></span>; struct load_command *cmd = (struct load_command *) (header+<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint32_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; cmd != NULL &amp;&amp; i &lt; header-&gt;ncmds; i++) { /* Encryption info segment */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmd-&gt;cmd == LC_ENCRYPTION_INFO) { struct encryption_info_command *crypt_cmd = (struct encryption_info_command *) cmd; /* Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> binary encryption is enabled */ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (crypt_cmd-&gt;cryptid &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { /* Disabled, probably pirated */ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NO; } /* Probably <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> pirated? */ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> YES; } cmd = (struct load_command *) ((uint8_t *) cmd + cmd-&gt;cmdsize); } /* Encryption info <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> found */ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NO; }</code> </pre><br>  The idea is that in the mach-o header of the executable file there is a cryptid flag in the LC_ENCRYPTION_INFO section, displaying whether the binary is encrypted or not.  Based on its value, a conclusion is drawn about the origin of this application. <br><br><h4>  At this place, all good ideas in public end, then only private </h4><br>  Despite the fact that the above code is quite difficult to detect with static analysis, an attacker can run our application on his jailbreaked phone under gdb.  And in the step-by-step mode, he will be able to unravel any of our protection in record time! <br>  Fortunately, Apple allows us to prohibit such a trace: <br><pre> <code class="hljs lisp">ptrace(<span class="hljs-name"><span class="hljs-name">PT_DENY_ATTACH</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br>  After its execution, any attempts to debug our application will be segfolded, ‚Äúencroached on the holy,‚Äù the process.  We can say that on this front we won a complete and unconditional victory! <br>  But do not be in a hurry to rejoice, because ptrace is a function, in fact, a wrapper, and not a real system call, it is easy to find and neutralize, for example: <br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">break</span></span> ptrace #    ptrace commands <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> #     ,      <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> end run</code> </pre><br>  How to be?  Refuse fancy api and do the system call yourself! <br>  Adepts C may recall: <br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/syscall.h&gt; syscall(SYS_ptrace, PT_DENY_ATTACH, 0, 0, 0);</span></span></span></span></code> </pre> <br>  But, firstly, syscall is a function with which you can do the same as with ptrace, and secondly, it is part of the private api and the censors may not miss the program for its use. <br>  So, we have to do a system call without intermediaries, straight into the assembler, the benefit is not at all scary: <br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">asm</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">mov</span></span> r0, <span class="hljs-comment"><span class="hljs-comment">#31 // PT_DENY_ATTACH mov r1, #0 mov r2, #0 mov r3, #0 mov ip, #26 // SYS_ptrace svc #0x80 //    }</span></span></code> </pre><br>  But to find and neutralize these instructions will be disproportionately more difficult, especially if there are 5-10 such calls and they are scattered throughout the program code. <br><br>  The crown of our protection should be the integrity check of the executable file, it is necessary to check the checksum of the section with the code (__text).  The point is that even changing one byte in this section will change the checksum, so we will track the attempt to modify the file!  Since in normal conditions our file is encrypted and there is no point in trying to read its contents, we will act as hackers and read the section after the operating system loads and decrypts it itself.  Necessary information about the displacement and length can be found using: <br><pre> <code class="hljs mel">otool -l myPrecious.app/binary ... Section sectname __text segname __TEXT addr <span class="hljs-number"><span class="hljs-number">0x00002000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-number"><span class="hljs-number">0x00096980</span></span> offset <span class="hljs-number"><span class="hljs-number">4096</span></span> <span class="hljs-keyword"><span class="hljs-keyword">align</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>^<span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>) reloff <span class="hljs-number"><span class="hljs-number">0</span></span> nreloc <span class="hljs-number"><span class="hljs-number">0</span></span> flags <span class="hljs-number"><span class="hljs-number">0x80000400</span></span> reserved1 <span class="hljs-number"><span class="hljs-number">0</span></span> reserved2 <span class="hljs-number"><span class="hljs-number">0</span></span> ...</code> </pre><br>  The code we are interested in is starting from the address 0x2000 already familiar to us, and the length is respectively 0x96980. <br>  The pattern of this check can be, for example, like this: <br><pre> <code class="hljs cs">__attribute__((always_inline)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_secret_checksum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { u_char *buf = <span class="hljs-number"><span class="hljs-number">0x2000</span></span>; u_int res; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">0x96980</span></span>; i++) { res += buf[i] ..... <span class="hljs-comment"><span class="hljs-comment">//    crc/adler   } if (res != ...) { // Achtung! Partizanen! } }</span></span></code> </pre><br>  Pay attention to the always_inline attribute, it allows in different places of the program to place not just a call to this function, but directly its code.  Thus, if we place this check in several places, the hacker will have to find and neutralize them all.  And until he does, any attempt to modify the executable file will be stopped.  Ideally, it is worth placing it in each of your methods or functions.  Reading from memory is a very fast process, so its frequent use will not affect its performance.  And the prospect of cutting it out of the entire code should repel even the most purposeful hacker. <br><br><h4>  Afterword </h4><br>  Defense is countering attack.  By opposing one attack, we are not protected from another.  Therefore, only a complex of checks can be effective protection.  I tried to highlight the required minimum.  And I hope this material will inspire the reader to their own searches and research.  Good luck to you!  And do not let the level of your sales darken romance with a big road! <br><br><h4>  Literature </h4><br>  A good instruction on the topic of Patching Iphone Application with life examples can be found <a href="http://www.accessroot.com/arteam/site/request.php%3F308">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/127875/">https://habr.com/ru/post/127875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../127868/index.html">Nonblocking message queue for two threads</a></li>
<li><a href="../127869/index.html">Nokia N950 Developer Kit for Developer</a></li>
<li><a href="../127870/index.html">Just about Qt. Container library</a></li>
<li><a href="../127871/index.html">About caching resource-intensive SQL queries on a web server</a></li>
<li><a href="../127874/index.html">How to write code?</a></li>
<li><a href="../127876/index.html">90 Node.js modules for public use</a></li>
<li><a href="../127878/index.html">NTRUEncrypt cryptosystem of the future?</a></li>
<li><a href="../127879/index.html">Home server WiFi router</a></li>
<li><a href="../127881/index.html">Damage to the optical highway in Germany</a></li>
<li><a href="../127886/index.html">Adobe Flash 11 and AIR 3 Release Candidate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>