<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arduino & Modbus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we connected the OpenHAB open-source home automation platform with the Arduino controller using a very simple text protocol. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arduino & Modbus</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/248569/">previous article,</a> we connected the OpenHAB open-source home automation platform with the Arduino controller using a very simple text protocol.  But this decision will stump us, if we want to connect our controller to another system, what should we do? <br><br>  Modbus is the most famous and widespread standard in industrial automation, it is supported by millions of devices around the world, these devices are easily integrated into a single network and interconnect with a huge amount of off-the-shelf software.  Let's try to use it in our project? <br><br>  What do we need to know about this standard? <br>  The Modbus protocol uses serial communication lines (for example, RS232, RS485), and the Modbus TCP protocol is designed for data transmission over TCP / IP networks. <br>  Modbus protocol has two modes of transmitting RTU and ASCII, in ASCII mode, each byte is transmitted as two ASCII characters of its hexadecimal representation. <br>  There is only one master in the Modbus network, which polls several slave devices at a given interval, each of which has its own unique address from 1 to 254, the address 0 is broadcast and all devices respond to it, since it has one address on the network master. . <br>  The Modbus specification defines two types of data, one bit and 16 bit word.  The data is organized into four tables with 16-bit addressing cells, addressing in the tables starts from 0. Separate commands are used to access data from different tables. <br><table border="1"><tbody><tr><td>  Discrete inputs </td><td>  1 bit </td><td>  only reading </td></tr><tr><td>  Coils </td><td>  1 bit </td><td>  read and write </td></tr><tr><td>  Input Registers </td><td>  16 bits </td><td>  only reading </td></tr><tr><td>  Holding registers </td><td>  16 bits </td><td>  read and write </td></tr></tbody></table><br>  How do we connect a Modbus device to OpenHAB? <a name="habracut"></a>  The <a href="https://github.com/openhab/openhab/wiki/Modbus-Tcp-Binding">Modbus Tcp Binding</a> module is responsible for this, this module operates in the master mode and provides the connection of several slave devices via a serial port or TCP / IP network. <br>  In order to connect Arduino with it, we need to implement a Modbus slave device in the controller, let's use the <a href="https://github.com/smarmengol/Modbus-Master-Slave-for-Arduino">Modbus-Master-Slave-for-Arduino</a> library for this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Download the library and create a sketch by copying the following code into the program editor.  If you wish, you can simply download the project with the necessary files from the <a href="https://github.com/borichl/modbus">repository</a> . <br><br>  Consider the example of our sketch, the basic steps necessary to work with this library. <br><br>  All library functions are implemented in a single ModbusRtu.h file. <br>  To interact with it, you need to create an object in the program by specifying the address, serial port number, output number controlling the transmission in the Modbus constructor (for RS485) <br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Modbus </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">slave</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ID, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;</code> </pre> <br>  Then define an array of Modbus registers. <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> au16data[<span class="hljs-number"><span class="hljs-number">11</span></span>];</code> </pre><br>  After that, when starting the program, configure the serial port of the slave <br><pre> <code class="cpp hljs">slave.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>);</code> </pre><br>  In the main program loop, call the Modbus message handling function. <br><pre> <code class="cpp hljs">state = slave.poll(au16data, <span class="hljs-number"><span class="hljs-number">11</span></span>);</code> </pre><br>  And after that, you can process the data and save the necessary variables in the Modbus registers. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ModbusRtu.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ID 1 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   #define btnPin 2 //  ,    #define stlPin 13 //     //    Arduino #define ledPin 12 //    //  ,  ,   TX Modbus slave(ID, 0, 0); boolean led; int8_t state = 0; unsigned long tempus; //   modbus uint16_t au16data[11]; void setup() { //     io_setup(); //     slave.begin( 9600 ); //    100  tempus = millis() + 100; digitalWrite(stlPin, HIGH ); } void io_setup() { digitalWrite(stlPin, HIGH ); digitalWrite(ledPin, LOW ); pinMode(stlPin, OUTPUT); pinMode(ledPin, OUTPUT); pinMode(btnPin, INPUT); } void loop() { //   state = slave.poll( au16data, 11); //      -    50  if (state &gt; 4) { tempus = millis() + 50; digitalWrite(stlPin, HIGH); } if (millis() &gt; tempus) digitalWrite(stlPin, LOW ); //    Modbus     io_poll(); } void io_poll() { // Coil[1]  Discrete[0] au16data[0] = au16data[1]; //   1.3   digitalWrite( ledPin, bitRead( au16data[1], 3 )); //     0.3 bitWrite( au16data[0], 3, digitalRead( btnPin )); // Holding[5,6,7]  Input[2,3,4] au16data[2] = au16data[5]; au16data[3] = au16data[6]; au16data[4] = au16data[7]; //     au16data[8] = slave.getInCnt(); au16data[9] = slave.getOutCnt(); au16data[10] = slave.getErrCnt(); }</span></span></span></span></code> </pre><br>  The standard provides a separate table for each data type, but the feature of the applied library is that all registers are stored in one array as overlapping tables, so the controller register structure will look like this: <br><br><img src="https://habrastorage.org/files/40f/0a8/789/40f0a878912f4bf4930ded14fe21e707.JPG"><br><br>  To demonstrate the work with different registers, in the course of program operation, data from a register with a coil type will be copied into a register with a discrete type, and from registers with a holding type into registers with an input type.  In addition, the button state will be saved to the third bit of the register au16data [0] (discrete), and the value of the third bit of the register au16data [1] (coil) is output to the LED. <br><br>  We will refine the layout of the controller, which was assembled for previous experiments, switch the LED from 13 to 12 output.  Usually the Arduino board itself already has an LED connected to pin 13, in our program it will become an indicator of the status of work.  Now we connect the USB cable to the computer, compile and download the program to the controller. <br><br><img src="https://habrastorage.org/files/6ff/226/483/6ff226483d9448a5b787af24c94286c2.JPG"><br><br>  It's time to start testing.  It greatly facilitates the work at this stage of the Modbus master device emulator, the network has some good, while free programs, here are some of them: <br>  <a href="http://www.focus-sw.com/fieldtalk/modpoll.html">www.focus-sw.com/fieldtalk/modpoll.html</a> <br>  <a href="http://qmodbus.sourceforge.net/">qmodbus.sourceforge.net</a> <br>  <a href="http://www.mikont.com/products/EAT-Console.html">www.mikont.com/products/EAT-Console.html</a> <br><br>  Among them, the EAT-Console utility allows not only to control and poll Modbus devices, but also displays data in graphical form, which is very convenient when debugging work with various sensors, such as humidity, pressure and temperature sensors.  Before you start working with the program and its configurator, I recommend that you familiarize yourself with the <a href="http://www.mikont.com/files/content/EATConsole_user_guide.pdf">documentation</a> . <br><br><img src="https://habrastorage.org/files/818/4e7/724/8184e77240054ca3a681087d35db8388.JPG"><br><br>  To install the emulator, you need to download the <a href="">archive</a> and unpack it to the C: \ arduino \ EATConsole folder, then open the <a href="http://www.eclipse.org/downloads/">Eclipse download page</a> , download the Eclipse IDE for Java Developers and unpack it to the C: \ arduino \ eclipse folder, then copy the files from the C folder: \ arduino \ EATConsole \ eclipse \ plugins in the C: \ arduino \ eclipse \ plugins folder. <br><br>  To create a configuration, you must run C: \ arduino \ eclipse \ eclipse.exe, create an empty project, copy an empty file C: \ arduino \ EATConsole \ menu.ptmenu into it and add items in the editor according to the following table.  If you downloaded the project from the <a href="https://github.com/borichl/modbus">repository</a> , then there is already a prepared menu.ptmenu file in the EATConsole folder. <br><table><tbody><tr><td>  Type </td><td>  Address </td><td>  Bit </td><td>  Name </td><td>  Point </td><td>  Slave </td></tr><tr><td>  Display boolean </td><td>  0 </td><td>  0 </td><td>  DT0 </td><td></td><td>  one </td></tr><tr><td>  Display boolean </td><td>  0 </td><td>  one </td><td>  DT1 </td><td></td><td>  one </td></tr><tr><td>  Display boolean </td><td>  0 </td><td>  2 </td><td>  DT2 </td><td></td><td>  one </td></tr><tr><td>  Display boolean </td><td>  0 </td><td>  3 </td><td>  Btn </td><td></td><td>  one </td></tr><tr><td>  Input boolean </td><td>  one </td><td>  0 </td><td>  CL16 </td><td></td><td>  one </td></tr><tr><td>  Input boolean </td><td>  one </td><td>  one </td><td>  CL17 </td><td></td><td>  one </td></tr><tr><td>  Input boolean </td><td>  one </td><td>  2 </td><td>  CL18 </td><td></td><td>  one </td></tr><tr><td>  Input boolean </td><td>  one </td><td>  3 </td><td>  LED </td><td></td><td>  one </td></tr><tr><td>  Display integer </td><td>  2 </td><td></td><td>  INPT3 </td><td>  0 </td><td>  one </td></tr><tr><td>  Display integer </td><td>  3 </td><td></td><td>  INPT4 </td><td>  0 </td><td>  one </td></tr><tr><td>  Display integer </td><td>  four </td><td></td><td>  INPT5 </td><td>  0 </td><td>  one </td></tr><tr><td>  Display integer </td><td>  five </td><td></td><td>  HOLD6 </td><td>  0 </td><td>  one </td></tr><tr><td>  Display integer </td><td>  6 </td><td></td><td>  HOLD7 </td><td>  0 </td><td>  one </td></tr><tr><td>  Display integer </td><td>  7 </td><td></td><td>  HOLD8 </td><td>  0 </td><td>  one </td></tr></tbody></table><br>  Type - the type of the EATConsole menu item. <br>  Address - the address of the data register. <br>  Bit - the number of bits in the register. <br>  Name - the name of the menu item. <br>  Point - the number of decimal places after a point. <br>  Slave - Modbus controller address. <br><br><img src="https://habrastorage.org/files/add/943/7d0/add9437d0a2f4e13a987d841bc8c993e.JPG"><br><br>  Now, save and copy the menu.ptmenu file to the C: \ arduino \ EATConsole directory. To do this, right-click on the file directly in Eclipse, select the ‚ÄúCopy‚Äù item in the context menu, and then paste into the C: \ arduino folder in the explorer \ EATConsole. <br><br>  After that, run C: \ arduino \ EATConsole \ EATConsole.exe, configure the serial connection by selecting the File \ Settings menu item, specify the port number, 9600 speed, 8 data bits, 1 stop bit in the dialog box. <br><br><img src="https://habrastorage.org/files/351/170/a62/351170a62856416da0b7a5f82885e5c7.JPG"><br><br>  * The program works with ports 1 through 8 and if the Arduino USB adapter is on the port with a larger number, you will have to open the Windows Device Manager and change the port number for it. <br><br>  When all the settings have been entered, click the ‚ÄúInstall‚Äù button, immediately after this the program will start polling the device and if something went wrong the message ‚ÄúNO COMMUNICATION‚Äù will appear.  If everything has been done correctly and there is a connection in what can be seen by the flashing status indicator (LED on pin 13), then it's time to start testing our controller. <br><br>  Let's try to change the value in the registers HLD0 ... HLD2 and L0 ... L2, the value in the corresponding register IN0..IN2 and DT0..DT2 should change, then click on the layout button, the value in the BTN field should change, click on the LED field , at the same time the LED should light up or go out. <br><br><img src="https://habrastorage.org/files/e45/8a8/cc6/e458a8cc65be4a059abd2734578c4336.JPG"><br><br>  What we received as a result of our work: <br><br>  1 got acquainted with the basics of the Modbus protocol; <br>  2 created a sketch that turns the Arduino into a Modbus slave device and allows you to read and write several Modbus registers with different data types; <br>  3 tested the exchange with the controller using the emulator of functions of the Modbus master device, for which they created a configuration corresponding to the register structure of the controller. <br><br>  findings <br>  The <a href="https://github.com/smarmengol/Modbus-Master-Slave-for-Arduino">Modbus-Master-Slave-for-Arduino</a> library is easy to use, it allows you to create a Modbus slave device that works correctly with a software emulator.  The compiled example takes a little more than 5kb of program memory, so there is enough space in the controller to add the necessary functionality. <br><br>  The Modbus standard is open and popular, but there are a number of flaws in it - the standard defines only two types of data, <br>  The protocol requires constant exchange between the master and the slave devices; it is necessary to configure the system manually. <br><br>  With some drawbacks, the protocol is quite suitable for use in the controller of home automation systems, especially if docking with various software is necessary. <br><br>  <a href="http://habrahabr.ru/post/252555/">Next time,</a> let's connect the controller to the OpenHAB platform. </div><p>Source: <a href="https://habr.com/ru/post/249043/">https://habr.com/ru/post/249043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249031/index.html">The synapse ensemble is a structural unit of the neural network</a></li>
<li><a href="../249037/index.html">Scan and index pages in multiple languages</a></li>
<li><a href="../249039/index.html">How I implemented multilingualism on the site and in the project</a></li>
<li><a href="../24904/index.html">Habr + Habra =?</a></li>
<li><a href="../249041/index.html">YouTube abandoned Flash in favor of HTML5 by default.</a></li>
<li><a href="../249045/index.html">C # for AS3 developers. Part 4: Abstract Classes and Functions</a></li>
<li><a href="../249047/index.html">Sass-architecture of your project</a></li>
<li><a href="../249051/index.html">Do not use MediaPlayer and MediaMetadataRetriever in Android</a></li>
<li><a href="../249053/index.html">How virtual reality came to the project on Unity</a></li>
<li><a href="../249055/index.html">Universal way to monitor Asterisk using Zabbix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>