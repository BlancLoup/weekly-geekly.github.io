<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Use EXPLAIN. Query enhancement</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When you execute a query, the MySQL query optimizer tries to come up with an optimal execution plan for this query. You can look at this very plan usi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Use EXPLAIN. Query enhancement</h1><div class="post__text post__text-html js-mediator-article">  When you execute a query, the MySQL query optimizer tries to come up with an optimal execution plan for this query.  You can look at this very plan using the query with the keyword EXPLAIN.  EXPLAIN is one of the most powerful tools at your disposal for understanding MySQL queries and optimizing them, but the sad fact is that many developers rarely use it.  In this article, you will learn about what data EXPLAIN offers at the output and see an example of how to use it to optimize queries. <br><a name="habracut"></a><br><br><h4>  What does EXPLAIN offer? </h4><br>  Using the operator EXPLAIN is simple.  It must be added to queries before the SELECT statement.  Let's analyze the output to see the information returned by the command. <br><br><pre><code class="php hljs">EXPLAIN SELECT * FROM categories</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="php hljs">********************** <span class="hljs-number"><span class="hljs-number">1.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: categories type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">4</span></span> Extra: <span class="hljs-number"><span class="hljs-number">1</span></span> row in set (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec)</code> </pre><br><br>  The conclusion may not look exactly the same, however, it will contain the same 10 columns.  What is this returned column? <br><br><ul><li>  <b>id</b> - the sequence number for each SELECT within the query (when there are several subqueries) </li><li>  <b>select_type</b> is a SELECT query type. <br><br><ul><li>  <b>SIMPLE</b> - A simple SELECT query without subqueries or UNIONS </li><li>  <b>PRIMARY</b> - this SELECT is the outermost query in JOIN </li><li>  <b>DERIVED</b> - this SELECT is part of a subquery inside a FROM </li><li>  <b>SUBQUERY</b> - the first SELECT in a subquery </li><li>  <b>DEPENDENT SUBQUERY</b> - a subquery that depends on an external query </li><li>  <b>UNCACHABLE SUBQUERY</b> - not cached subquery (there are certain conditions for the query to be cached) </li><li>  <b>UNION</b> - the second or subsequent SELECT in UNION </li><li>  <b>DEPENDENT UNION</b> - second or subsequent SELECT in UNION, dependent on external query </li><li>  <b>UNION RESULT</b> - the result of UNION </li></ul><br></li><li>  <b>Table</b> - the table to which the displayed row belongs </li><li>  <b>Type</b> - indicates how MySQL binds the tables used.  This is one of the most useful fields in the output because it can report missing indexes or why a written query should be revised and rewritten. <br>  Possible values: <br><br><ul><li>  <b>System</b> - the table has only one row. </li><li>  <b>Const</b> - the table has only one matching row that is indexed.  This is the fastest type of connection because the table is read only once and the value of the string can be perceived as a constant for further connections. </li><li>  <b>Eq_ref</b> - all parts of the index are used for binding.  Indices used: PRIMARY KEY or UNIQUE NOT NULL.  This is another best possible type of binding. </li><li>  <b>Ref</b> - all corresponding rows of the index column are read for each combination of rows from the previous table.  This type of join for indexed columns looks like using the operators = or &lt;=&gt; </li><li>  <b>Fulltext</b> - the join uses the full-text index of the table </li><li>  <b>Ref_or_null</b> is the same as ref, but also contains rows with null for a column. </li><li>  <b>Index_merge</b> - the join uses a list of indexes to get the result set.  The key column of the EXPLAIN command output will contain a list of used indexes. </li><li>  <b>Unique_subquery</b> - the IN subquery returns only one result from the table and uses the primary key. </li><li>  <b>Index_subquery</b> is the same as the previous one, but returns more than one result. </li><li>  <b>Range</b> - the index used to find the corresponding row in a certain range, usually when the key column is compared with a constant, using operators like: BETWEEN, IN,&gt;,&gt; =, etc. </li><li>  <b>Index</b> - scans the entire index tree to find the corresponding rows. </li><li>  <b>All</b> - Scan the entire table to find the corresponding rows.  This is the worst type of compound and usually indicates a lack of suitable indices in the table. </li></ul><br></li><li>  <b>Possible_keys</b> - shows the indexes that can be used to find rows in a table.  In practice, they may or may not be used.  In fact, this column can do a good job in query optimization, since the value NULL indicates that no suitable index has been found. </li><li>  <b>Key</b> - indicates the index used.  This column may contain an index that is not listed in the possible_keys column.  In the process of joining tables, the optimizer looks for the best options and can find keys that are not displayed in possible_keys, but are more optimal for use. </li><li>  <b>Key_len</b> is the length of the index that the MySQL optimizer chose to use.  For example, a key_len value of 4 means that memory is required to store 4 characters.  On this topic here is the <a href="http://dev.mysql.com/doc/refman/5.0/en/storage-requirements.html">link</a> </li><li>  <b>Ref</b> - indicates columns or constants that are compared with the index specified in the key field.  MySQL will choose either the constant value to compare, or the field itself, based on the query execution plan. </li><li>  <b>Rows</b> ‚Äî Displays the number of records processed to produce the output.  This is another very important field that gives reason to optimize queries, especially those that use JOINs and subqueries. </li><li>  <b>Extra</b> - contains additional information related to the query execution plan.  Values ‚Äã‚Äãsuch as ‚ÄúUsing temporary‚Äù, ‚ÄúUsing filesort‚Äù, etc. can be an indicator of a problem query.  You can find a full list of possible values <a href="http://dev.mysql.com/doc/refman/5.6/en/explain-output.html">here.</a> </li></ul><br><br>  After EXPLAIN in the query, you can use the EXTENDED keyword and MySQL will show you additional information about how the query is executed.  To see this information, you need to immediately after the request with EXTENDED execute the query SHOW WARNINGS.  It is most useful to look at this information about the query that was executed after any changes made by the query optimizer. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXPLAIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTENDED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> City.Name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> City <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Country <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (City.CountryCode = Country.Code) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> City.CountryCode = <span class="hljs-string"><span class="hljs-string">'IND'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> Country.Continent = <span class="hljs-string"><span class="hljs-string">'Asia'</span></span></code> </pre> <br><br><pre> <code class="php hljs">********************** <span class="hljs-number"><span class="hljs-number">1.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: Country type: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">3</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rows: <span class="hljs-number"><span class="hljs-number">1</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">2.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: City type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">4079</span></span> filtered: <span class="hljs-number"><span class="hljs-number">100.00</span></span> Extra: Using where <span class="hljs-number"><span class="hljs-number">2</span></span> rows in set, <span class="hljs-number"><span class="hljs-number">1</span></span> warning (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec)</code> </pre><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SHOW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WARNINGS</span></span></code> </pre> <br><br><pre> <code class="php hljs">********************** <span class="hljs-number"><span class="hljs-number">1.</span></span> row ********************** Level: Note Code: <span class="hljs-number"><span class="hljs-number">1003</span></span> Message: select `World`.`City`.`Name` <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> `Name` from `World`.`City` join `World`.`Country` where ((`World`.`City`.`CountryCode` = <span class="hljs-string"><span class="hljs-string">'IND'</span></span>)) <span class="hljs-number"><span class="hljs-number">1</span></span> row in set (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec)</code> </pre><br><br><h4>  Find and fix performance problems with EXPLAIN. </h4><br>  Now let's look at how we can optimize a not-so-smart query by analyzing the output of the EXPLAIN command.  There is no doubt that in existing working applications there are a number of tables with many links between them, but sometimes it is difficult to foresee the most optimal way to write a query. <br><br>  I created a test database for an e-commerce application that does not have any indexes or primary keys, and demonstrate the impact of this not-so-good way to create tables using scary queries.  You can download this dump table here - <a href="https://github.com/phpmasterdotcom/UsingExplainToWriteBetterMySQLQueries">github.com/phpmasterdotcom/UsingExplainToWriteBetterMySQLQueries</a> <br><br><pre> <code class="php hljs">EXPLAIN SELECT * FROM orderdetails d INNER JOIN orders o ON d.orderNumber = o.orderNumber INNER JOIN products p ON p.productCode = d.productCode INNER JOIN productlines l ON p.productLine = l.productLine INNER JOIN customers c on c.customerNumber = o.customerNumber WHERE o.orderNumber = <span class="hljs-number"><span class="hljs-number">10101</span></span></code> </pre><br><br>  If you look at the result (you only have to look at it in the example below, the link above contains a dump with the keys already added), you will see all the symptoms of a bad query. <br><br>  UPDATE.  <a href="">Here</a> lies the corrected dump without indexes.  For some reason, the indexes were originally added to the original author's dump. <br><br>  But even if I write a better query, the result will be the same until I add indexes.  The specified connection type is ALL (worst), which means that MySQL could not identify any keys that could be used during the connection.  It also implies that possible_keys and key are NULL.  Most importantly, the rows field shows that MySQL scans all the records for each table for a query.  This means that it will scan 7 √ó 110 √ó 122 √ó 326 √ó 2996 = 91,750,822,240 records to find the appropriate four (remove EXPLAIN from the query, check it yourself).  This is very bad and the number of these records will increase exponentially as the database grows. <br><br>  Now let's add the obvious indexes, such as the primary key for each table, and run the query again.  Taking this as a basic rule, you can use the columns used in JOINs as candidates for adding keys, since  MySQL always scans them to find the relevant entries. <br><br><pre> <code class="php hljs">ALTER TABLE customers ADD PRIMARY KEY (customerNumber); ALTER TABLE employees ADD PRIMARY KEY (employeeNumber); ALTER TABLE offices ADD PRIMARY KEY (officeCode); ALTER TABLE orderdetails ADD PRIMARY KEY (orderNumber, productCode); ALTER TABLE orders ADD PRIMARY KEY (orderNumber), ADD KEY (customerNumber); ALTER TABLE payments ADD PRIMARY KEY (customerNumber, checkNumber); ALTER TABLE productlines ADD PRIMARY KEY (productLine); ALTER TABLE products ADD PRIMARY KEY (productCode), ADD KEY (buyPrice), ADD KEY (productLine); ALTER TABLE productvariants ADD PRIMARY KEY (variantId), ADD KEY (buyPrice), ADD KEY (productCode);</code> </pre><br><br>  Let's execute our previous query after adding indexes.  You will see this: <br><br><pre> <code class="php hljs">********************** <span class="hljs-number"><span class="hljs-number">1.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: o type: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> possible_keys: PRIMARY,customerNumber key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">4</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">2.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: c type: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">4</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">3.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: d type: ref possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">4</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rows: <span class="hljs-number"><span class="hljs-number">4</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">4.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: p type: eq_ref possible_keys: PRIMARY,productLine key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">17</span></span> ref: classicmodels.d.productCode rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">5.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: SIMPLE table: l type: eq_ref possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">52</span></span> ref: classicmodels.p.productLine rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: <span class="hljs-number"><span class="hljs-number">5</span></span> rows in set (<span class="hljs-number"><span class="hljs-number">0.00</span></span> sec)</code> </pre><br><br>  After adding indexes, the number of read records dropped to 1 √ó 1 √ó 4 √ó 1 √ó 1 = 4 For each record, order_number = 10101 in the orderdetails table means that MySQL was able to find the corresponding entries in all other tables using indexes and did not resort to to full table scan. <br><br>  In the first output, you can use the connection type ‚Äúconst‚Äù, which is the fastest connection type for tables with more than one record.  MySQL was able to use PRIMARY KEY as an index.  The ‚Äúref‚Äù field displays ‚Äúconst‚Äù, which is nothing but the value 10101 specified in the query after the keyword WHERE. <br><br>  We look at another request.  In it, we choose the union of two tables, products and productvariants, each combined with productline.  productvariants, which consists of different variants of products with a field ProductCode - a link to their prices. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXPLAIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> p.productName, p.productCode, p.buyPrice, l.productLine, p.status, l.status <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> lineStatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> products p <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> productlines l <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.productLine = l.productLine <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> v.variantName <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> productName, v.productCode, p.buyPrice, l.productLine, p.status, l.status <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> lineStatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> productvariants v <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> products p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.productCode = v.productCode <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> productlines l <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> p.productLine = l.productLine ) products <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> = <span class="hljs-string"><span class="hljs-string">'Active'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> lineStatus = <span class="hljs-string"><span class="hljs-string">'Active'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> buyPrice <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span></code> </pre><br><br><pre> <code class="php hljs">********************** <span class="hljs-number"><span class="hljs-number">1.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: PRIMARY table: &lt;derived2&gt; type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">219</span></span> Extra: Using where ********************** <span class="hljs-number"><span class="hljs-number">2.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">2</span></span> select_type: DERIVED table: p type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">110</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">3.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">2</span></span> select_type: DERIVED table: l type: eq_ref possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">52</span></span> ref: classicmodels.p.productLine rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">4.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">3</span></span> select_type: UNION table: v type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">109</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">5.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">3</span></span> select_type: UNION table: p type: eq_ref possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">17</span></span> ref: classicmodels.v.productCode rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">6.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">3</span></span> select_type: UNION table: l type: eq_ref possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">52</span></span> ref: classicmodels.p.productLine rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">7.</span></span> row ********************** id: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> select_type: UNION RESULT table: &lt;union2,<span class="hljs-number"><span class="hljs-number">3</span></span>&gt; type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> Extra: <span class="hljs-number"><span class="hljs-number">7</span></span> rows in set (<span class="hljs-number"><span class="hljs-number">0.01</span></span> sec)</code> </pre><br><br>  You may notice a number of problems in this query.  It scans all entries in products and productvarians.  Since  In these tables there are no indices for the columns ProductLine and buyPrice, the possible_keys and key fields display NULL values.  The status of the products and productlines tables is checked after UNION, so moving them inside UNION will reduce the number of entries.  Add indexes. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_buyPrice <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> products(buyPrice); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_buyPrice <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> productvariants(buyPrice); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_productCode <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> productvariants(productCode); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> idx_productLine <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> products(productLine);</code> </pre><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXPLAIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> p.productName, p.productCode, p.buyPrice, l.productLine, p.status, l.status <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> lineStatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> products p <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> productlines <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> l <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (p.productLine = l.productLine <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.status = <span class="hljs-string"><span class="hljs-string">'Active'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> l.status = <span class="hljs-string"><span class="hljs-string">'Active'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> buyPrice <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> v.variantName <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> productName, v.productCode, p.buyPrice, l.productLine, p.status, l.status <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> productvariants v <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> products p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (p.productCode = v.productCode <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.status = <span class="hljs-string"><span class="hljs-string">'Active'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> productlines l <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (p.productLine = l.productLine <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> l.status = <span class="hljs-string"><span class="hljs-string">'Active'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> v.buyPrice <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span> ) product</code> </pre><br><br><pre> <code class="php hljs">********************** <span class="hljs-number"><span class="hljs-number">1.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">1</span></span> select_type: PRIMARY table: &lt;derived2&gt; type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">12</span></span> Extra: ********************** <span class="hljs-number"><span class="hljs-number">2.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">2</span></span> select_type: DERIVED table: p type: range possible_keys: idx_buyPrice,idx_productLine key: idx_buyPrice key_len: <span class="hljs-number"><span class="hljs-number">8</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">23</span></span> Extra: Using where ********************** <span class="hljs-number"><span class="hljs-number">3.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">2</span></span> select_type: DERIVED table: l type: eq_ref possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">52</span></span> ref: classicmodels.p.productLine rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: Using where ********************** <span class="hljs-number"><span class="hljs-number">4.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">3</span></span> select_type: UNION table: v type: range possible_keys: idx_buyPrice,idx_productCode key: idx_buyPrice key_len: <span class="hljs-number"><span class="hljs-number">9</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: Using where ********************** <span class="hljs-number"><span class="hljs-number">5.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">3</span></span> select_type: UNION table: p type: eq_ref possible_keys: PRIMARY,idx_productLine key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">17</span></span> ref: classicmodels.v.productCode rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: Using where ********************** <span class="hljs-number"><span class="hljs-number">6.</span></span> row ********************** id: <span class="hljs-number"><span class="hljs-number">3</span></span> select_type: UNION table: l type: eq_ref possible_keys: PRIMARY key: PRIMARY key_len: <span class="hljs-number"><span class="hljs-number">52</span></span> ref: classicmodels.p.productLine rows: <span class="hljs-number"><span class="hljs-number">1</span></span> Extra: Using where ********************** <span class="hljs-number"><span class="hljs-number">7.</span></span> row ********************** id: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> select_type: UNION RESULT table: &lt;union2,<span class="hljs-number"><span class="hljs-number">3</span></span>&gt; type: ALL possible_keys: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> key_len: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> ref: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> rows: <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> Extra: <span class="hljs-number"><span class="hljs-number">7</span></span> rows in set (<span class="hljs-number"><span class="hljs-number">0.01</span></span> sec)</code> </pre><br><br>  As you can see, as a result, the number of scanned lines decreased from 2,625,810 (219 √ó 110 √ó 109) to 276 (12 √ó 23), which is an excellent gain in performance.  If you execute the same query without previous permutations in the query immediately after adding the indices, you will not see such a decrease in the scanned rows.  MySQL is not able to use indices when using WHERE in a derived result.  After placing these conditions inside UNION it becomes possible to use indexes.  This means that adding indexes is not always enough.  MySQL will not be able to use them until you write suitable queries.  (http://www.php.su/mysql/manual/?page=MySQL_indexes - additional information). <br><br><h4>  Total </h4><br>  The article discusses the keyword EXPLAIN, information on the output, and examples of how you can use the output of the command to improve queries.  In the real world, this command may be more useful than in the scenarios discussed.  Almost always you will join a series of tables together using complex constructions with WHERE.  At the same time, simply adding indexes to tables does not always lead to the desired result.  In this case, you need to review your requests. </div><p>Source: <a href="https://habr.com/ru/post/211022/">https://habr.com/ru/post/211022/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211012/index.html">Transparent encryption of network folders in the corporate space</a></li>
<li><a href="../211014/index.html">HGST HelioSeal - a promising platform for the next decade</a></li>
<li><a href="../211016/index.html">Pocket PaaS with Dokku</a></li>
<li><a href="../211018/index.html">Probability in algorithms. Yandex lecture</a></li>
<li><a href="../211020/index.html">About security in Meteor and not only (part 2)</a></li>
<li><a href="../211024/index.html">Proxmox API. Introduction</a></li>
<li><a href="../211026/index.html">You like to read exciting books - love and wear a vest ...</a></li>
<li><a href="../211028/index.html">Browser game "Cyberset" - continued</a></li>
<li><a href="../211030/index.html">Google enters into a contract with the sea driver</a></li>
<li><a href="../211032/index.html">How to create a web page. Part 2 - Bootstrap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>