<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recursive queries in PostgreSQL (WITH RECURSIVE)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oddly enough, in order to understand recursion, PostgreSQL does not need to understand recursion. Because WITH RECURSIVE, which is present in the prog...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recursive queries in PostgreSQL (WITH RECURSIVE)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/f31/6ea/e26/f316eae261b24f7a8040219d94497e91.gif"><br>  Oddly enough, in order to understand recursion, PostgreSQL does not need to understand recursion.  Because WITH RECURSIVE, which is present in the program (and in other serious databases), is rather a calculation of something by iteration before some condition is fulfilled. <br>  Nevertheless, this is a very useful base functionality, which can be used, for example, to display all subcategories of a given category if the table is specified as (id, parent_id, ...) <br><a name="habracut"></a><br><br>  Let's try to calculate factorial for simplicity.  In javascript, we would do it like this: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">factorial</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i * factorial(i<span class="hljs-number"><span class="hljs-number">-1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(factorial(<span class="hljs-number"><span class="hljs-number">10</span></span>));</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is calculated completely differently.  In the recursive part of the CTE, there must necessarily be a starting part and a recursive part, separated by the word UNION. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-comment"><span class="hljs-comment">--    (.. "anchor") SELECT 1 AS i, 1 AS factorial UNION --   SELECT i+1 AS i, factorial * (i+1) as factorial FROM r WHERE i &lt; 10 ) SELECT * FROM r; i | factorial ----+----------- 1 | 1 2 | 2 3 | 6 4 | 24 5 | 120 6 | 720 7 | 5040 8 | 40320 9 | 362880 10 | 3628800 (10 rows)</span></span></code> </pre><br><br>  Please note that if you read this query, so to speak, intuitively, as it is, then it seems that the letter should go into an eternal cycle and do not understand what to count. <br>  The fact is that this <b>FROM r</b> does not execute the entire query again, but it works like this: for the first time it takes what is in the starting part of the recursion (anchor), and in the next iterations it takes the results of the previous iteration. <br><br>  Algorithm like this: <br><ol><li>  Take the starting data </li><li>  substitute in the "recursive" part of the query. </li><li>  look what happened: <br><ul><li>  if the exhaust of the recursive part is not empty, then we add it to the resulting sample, and also use this exhaust as data for the next call to the recursive part, i.e.  goto 2 </li><li>  if empty, we complete processing </li></ul></li></ol><br>  In general, the example with factorial is not very indicative, because postgresql already knows how to calculate factorials, even very large ones (and generally works well with large numbers): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span>! <span class="hljs-comment"><span class="hljs-comment">--    ,       </span></span></code> </pre><br><br>  Take the promised selection of wood. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> geo ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, parent_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> geo(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">1000</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> geo (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, parent_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>), (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'  '</span></span>), (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), (<span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), (<span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>), (<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">'-'</span></span>), (<span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>);</code> </pre><br><br>  Choose everything that relates to Europe: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, parent_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> geo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> parent_id = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, parent_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> geo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> parent_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> r ) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> r; ERROR: recursive reference to query "r" must not appear within a subquery</code> </pre><br><br>  Oops, the next constraint, recursion should not be used in subqueries. <br>  Ok, rewrite to join: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, parent_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> geo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> parent_id = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> geo.id, geo.parent_id, geo.name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> geo <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> geo.parent_id = r.id ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> r; id | parent_id | name <span class="hljs-comment"><span class="hljs-comment">----+-----------+----------------- 5 | 4 |  6 | 4 |  7 | 5 |  8 | 5 | - 9 | 6 |  (5 rows)</span></span></code> </pre><br><br>  Another example.  You can, for example, give everything that relates to Europe together with Europe itself, and also count the level of nesting <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RECURSIVE</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, parent_id, <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> geo <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> geo.id, geo.parent_id, geo.name, r.level + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> geo <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> geo.parent_id = r.id ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> r; id | parent_id | name | level <span class="hljs-comment"><span class="hljs-comment">----+-----------+-----------------+------- 4 | 2 |  | 1 5 | 4 |  | 2 6 | 4 |  | 2 7 | 5 |  | 3 8 | 5 | - | 3 9 | 6 |  | 3 (6 rows)</span></span></code> </pre><br><br>  If you know something interesting on this topic, please write in the comments.  Where in practice have you successfully used recursion in SQL?  What are the pitfalls? </div><p>Source: <a href="https://habr.com/ru/post/269497/">https://habr.com/ru/post/269497/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269487/index.html">The digest of interesting materials for the mobile developer # 126 (October 19-25)</a></li>
<li><a href="../269489/index.html">How to make friends AWS Lambda and PostgreSQL</a></li>
<li><a href="../269491/index.html">Android 6.0: Doze Mode, App Standby, Runtime Permissions. Everything every developer needs to know</a></li>
<li><a href="../269493/index.html">Taming of the Shrew. We connect a single number to several mobile</a></li>
<li><a href="../269495/index.html">Extreme economy fonts</a></li>
<li><a href="../269499/index.html">ASP.NET MVC integration with Sharepoint 2013. Part 2: Interact with SharePoint</a></li>
<li><a href="../269501/index.html">SparkleFormation - CloudFormation template generator with rainbows and unicorns.</a></li>
<li><a href="../269503/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ182 (October 19 - 25, 2015)</a></li>
<li><a href="../269505/index.html">Rapid Java Reporting Development: Downshifting from 1C: Enterprise</a></li>
<li><a href="../269507/index.html">Yandex and ZeroNights: a month of searching for vulnerabilities in Yandex Browser</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>