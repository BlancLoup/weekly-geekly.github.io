<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Building Android applications step by step, part two</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the article, we developed an application for working with github, consisting of two screens, divided into layers using the MVP pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Building Android applications step by step, part two</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/45a/eaf/d99/45aeafd99c8d4935add42ab36bba5012.jpg"><br><br>  In the <a href="https://habrahabr.ru/company/rambler-co/blog/275943/">first part of the article,</a> we developed an application for working with github, consisting of two screens, divided into layers using the MVP pattern.  We used RxJava to simplify interaction with the server and two data models for different layers.  In the second part, we will implement Dagger 2, write unit tests, take a look at MockWebServer, JaCoCo and Robolectric. <br><a name="habracut"></a><br>  Content: <br><ul><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Introduction</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Step 3. Dependency Injection</a> <br><ul><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Dagger 2</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Model</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Presenter</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">View</a> </li></ul></li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Step 4. Testing, Unit test</a> <br><ul><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Infrastructure</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">JaCoCo Code Coverage</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Model</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Presenter</a> </li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">View</a> </li></ul></li><li>  <a href="https://habr.com/ru/company/rambler-co/blog/277343/">Conclusion or to be continued</a> </li></ul><br><div class="spoiler">  <b class="spoiler_title">Full content</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/275943/">Introduction</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/275943/">Step 1. Simple architecture</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/275943/">Step 2. Complicated architecture</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/277343/">Step 3. Dependency Injection</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/277343/">Step 4. Unit Testing</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/279799/">Step 5. Integration Testing</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/279799/">Step 6. Functional testing</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/279799/">Step 7. TDD</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/279799/">Step 8. What's next?</a> </li><li>  <a href="https://habrahabr.ru/company/rambler-co/blog/279799/">Conclusion</a> </li></ul><br></div></div><br><a name="20"></a><h4>  Introduction </h4><br>  In the first part of the article, we in two stages created a simple application for working with github. <br><br><div class="spoiler">  <b class="spoiler_title">Conditional application scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e08/de8/101/e08de8101f3b486b9c7f556126dea55e.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Class diagram</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/files/4e0/9f7/802/4e09f78028274958819a59445c3065fd.png"></a> <br></div></div><br>  All sources can be found on <a href="https://github.com/andrey7mel/android-step-by-step">Github</a> .  The branches in the repository correspond to the steps in the article: <a href="https://github.com/andrey7mel/android-step-by-step/tree/Step_3_Dependency_injection">Step 3 Dependency injection</a> - the third step, <a href="https://github.com/andrey7mel/android-step-by-step/tree/Step_4_Unit_tests">Step 4 Unit tests</a> - the fourth step. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="21"></a><h4>  Step 3. Dependency Injection </h4><br>  Before you use Dagger 2, you need to understand the principle of <a href="https://ru.wikipedia.org/wiki/%25D0%2592%25D0%25BD%25D0%25B5%25D0%25B4%25D1%2580%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B7%25D0%25B0%25D0%25B2%25D0%25B8%25D1%2581%25D0%25B8%25D0%25BC%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8">Dependency injection (Dependency Injection)</a> . <br><br>  Imagine that we have an object A, which includes an object B. Without using DI, we have to create an object B in the code of class A. For example: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ B b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ b = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> B(); } }</code> </pre> <br>  This code immediately violates the <a href="https://en.wikipedia.org/wiki/Single_responsibility_principle">SRP</a> and <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">DRP</a> principles of <a href="https://ru.wikipedia.org/wiki/SOLID_(%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5)">SOLID</a> .  The simplest solution is to transfer object B to the class A constructor, thus we implement Dependency Injection ‚Äúmanually‚Äù: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ B b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(B b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.b = b; } }</code> </pre><br>  Typically, DI is implemented using third-party libraries, where, thanks to annotations, an object is automatically replaced. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> B b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ inject(); } }</code> </pre><br>  Read more about this mechanism and its application on Android can be found in this article: <a href="https://habrahabr.ru/post/202866/">Meet Dependency Injection using the example of Dagger</a> <br><br><a name="22"></a><h5>  Dagger 2 </h5><br>  Dagger 2 is a library created by Google for the implementation of DI.  Its main advantage in code generation, i.e.  all errors will be visible at compile time.  On Habr√© there is a <a href="https://habrahabr.ru/company/ncloudtech/blog/274025/">good article about Dagger 2</a> , you can also read the <a href="http://google.github.io/dagger/">official page</a> or a <a href="https://github.com/codepath/android_guides/wiki/Dependency-Injection-with-Dagger-2">good instruction on the codepath</a> <br><br>  To install Dagger 2, you need to edit build.gradle: <br><br><div class="spoiler">  <b class="spoiler_title">build.gradle</b> <div class="spoiler_text"><pre> <code class="ruby hljs">apply <span class="hljs-symbol"><span class="hljs-symbol">plugin:</span></span> <span class="hljs-string"><span class="hljs-string">'com.android.application'</span></span> apply <span class="hljs-symbol"><span class="hljs-symbol">plugin:</span></span> <span class="hljs-string"><span class="hljs-string">'com.neenbedankt.android-apt'</span></span> dependencies { compile fileTree(<span class="hljs-symbol"><span class="hljs-symbol">dir:</span></span> <span class="hljs-string"><span class="hljs-string">'libs'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">include:</span></span> [<span class="hljs-string"><span class="hljs-string">'*.jar'</span></span>]) compile <span class="hljs-string"><span class="hljs-string">'com.android.support:appcompat-v7:21.0.3'</span></span> compile <span class="hljs-string"><span class="hljs-string">'com.google.dagger:dagger:2.0-SNAPSHOT'</span></span> apt <span class="hljs-string"><span class="hljs-string">'com.google.dagger:dagger-compiler:2.0-SNAPSHOT'</span></span> provided <span class="hljs-string"><span class="hljs-string">'org.glassfish:javax.annotation:10.0-b28'</span></span> }</code> </pre><br></div></div><br>  It is also highly recommended to install the <a href="https://github.com/square/dagger-intellij-plugin">Dagger IntelliJ Plugin plugin</a> .  It will help you navigate where and where the injection takes place. <br><br><div class="spoiler">  <b class="spoiler_title">Dagger IntelliJ Plugin</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/580/171/c50/580171c50a1240f9bd2feca885a4d98e.gif"><br></div></div><br>  The objects themselves for Dagger 2 implementation are taken from the module methods (methods should be marked with <a href="https://habrahabr.ru/users/provides/" class="user_link">Provides</a> annotation, modules - <a href="https://habrahabr.ru/users/module/" class="user_link">Module</a> ) or created using the constructor of the annotated <a href="https://habrahabr.ru/users/inject/" class="user_link">Inject</a> class.  For example: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">ApiInterface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideApiInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApiModule.getApiInterface(); } }</code> </pre><br>  or <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepoBranchesMapper</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepoBranchesMapper</span></span></span><span class="hljs-class">() </span></span>{} }</code> </pre><br>  Fields for embedding are indicated by <a href="https://habrahabr.ru/users/inject/" class="user_link">Inject</a> annotation: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ApiInterface apiInterface;</code> </pre><br>  These two things are connected using components (@Component).  They indicate where to get objects from and where to embed them (inject methods).  Example: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(modules = {ModelModule.class}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelImpl dataRepository)</span></span></span></span>; }</code> </pre><br>  For Dagger 2, we will use one component (AppComponent) and 3 modules for different layers (Model, Presentation, View). <br><br><div class="spoiler">  <b class="spoiler_title">Appcomponent</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(modules = {ModelModule.class, PresenterModule.class, ViewModule.class}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelImpl dataRepository)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BasePresenter basePresenter)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RepoListPresenter repoListPresenter)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RepoInfoPresenter repoInfoPresenter)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RepoInfoFragment repoInfoFragment)</span></span></span></span>; }</code> </pre><br></div></div><br><a name="23"></a><h5>  Model </h5><br>  For the Model layer, you must provide ApiInterface and two Schedulers for flow control.  For Scheduler, you must use the <a href="https://habrahabr.ru/users/named/" class="user_link">Named</a> annotation for Dagger to figure out the dependency graph. <br><br><div class="spoiler">  <b class="spoiler_title">ModelModule</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">ApiInterface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideApiInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApiModule.getApiInterface(Const.BASE_URL); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Named</span></span>(Const.UI_THREAD) <span class="hljs-function"><span class="hljs-function">Scheduler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideSchedulerUI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> AndroidSchedulers.mainThread(); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Named</span></span>(Const.IO_THREAD) <span class="hljs-function"><span class="hljs-function">Scheduler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideSchedulerIO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Schedulers.io(); }</code> </pre><br></div></div><br><a name="24"></a><h5>  Presenter </h5><br>  For the presenter layer, we need to provide the Model and CompositeSubscription, as well as the mappers.  Model and CompositeSubscription will be provided through modules, mappers using an annotated constructor. <br><br><div class="spoiler">  <b class="spoiler_title">Presenter Module</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PresenterModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">Model </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideDataRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelImpl(); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-function">CompositeSubscription </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideCompositeSubscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompositeSubscription(); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">An example of a mapper with an annotated constructor</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepoBranchesMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Func1</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">List</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BranchDTO</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">List</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Branch</span></span></span><span class="hljs-class">&gt;&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RepoBranchesMapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Branch&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;BranchDTO&gt; branchDTOs)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Branch&gt; branches = Observable.from(branchDTOs) .map(branchDTO -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Branch(branchDTO.getName())) .toList() .toBlocking() .first(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> branches; } }</code> </pre><br></div></div><br><a name="25"></a><h5>  View </h5><br>  With the View layer and the introduction of presenters, the situation is more complicated.  When creating a presenter, we pass the View interface to the designer.  Accordingly, Dagger should have a link to the implementation of this interface, that is, to our fragment.  You can go another way by changing the presenter interface and passing the link to the view in onCreate.  Consider both cases. <br><br>  Passing the view link. <br><br>  We have a RepoListFragment fragment that implements the RepoListView interface, <br>  and RepoListPresenter, which takes this RepoListView as input to the constructor.  We need to embed the RepoListPresenter into the RepoListFragment.  To implement such a scheme, we will have to create a new component and a new module, which in the designer will receive a link to our RepoListView interface.  In this module, we will create a presenter (using the RepoListView interface reference) and embed it in the fragment. <br><br><div class="spoiler">  <b class="spoiler_title">Introduction in fragment</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); DaggerViewComponent.builder() .viewDynamicModule(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewDynamicModule(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)) .build() .inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Component</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(modules = {ViewDynamicModule.class}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RepoListFragment repoListFragment)</span></span></span></span>; }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Module</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewDynamicModule</span></span></span><span class="hljs-class"> </span></span>{ RepoListView view; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ViewDynamicModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RepoListView view)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.view = view; } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-function">RepoListPresenter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideRepoListPresenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepoListPresenter(view); } }</code> </pre><br></div></div><br>  In real-world applications, you will have many injections and modules, so creating different components for different entities is a great idea for preventing <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25BE%25D0%25B6%25D0%25B5%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BE%25D0%25B1%25D1%258A%25D0%25B5%25D0%25BA%25D1%2582">god object</a> creation. <br><br>  Change the code presenter. <br><br>  The above method requires the creation of several files and a variety of actions.  In our case, there is a much simpler way, change the constructor and pass the interface reference to onCreate. <br>  Code: <br><br><div class="spoiler">  <b class="spoiler_title">Introduction in fragment</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> RepoInfoPresenter presenter; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); App.getComponent().inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); presenter.onCreate(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, getRepositoryVO()); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Module</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-function">RepoInfoPresenter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideRepoInfoPresenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepoInfoPresenter(); } }</code> </pre><br></div></div><br>  Having completed the implementation of Dagger 2, we turn to testing the application. <br><br><a name="26"></a><h4>  Step 4. Unit Testing </h4><br>  Testing has long been an integral part of the software development process. <br>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D1%2581%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25BD%25D0%25BE%25D0%25B3%25D0%25BE_%25D0%25BE%25D0%25B1%25D0%25B5%25D1%2581%25D0%25BF%25D0%25B5%25D1%2587%25D0%25B5%25D0%25BD%25D0%25B8%25D1%258F">Wikipedia identifies many types of testing</a> , first of all, let's deal with the unit testing. <br><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25BE%25D0%25B4%25D1%2583%25D0%25BB%25D1%258C%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2582%25D0%25B5%25D1%2581%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Unit testing</a> process in programming, allowing to check for correctness of individual modules of the program source code. <br>  The idea is to write tests for each non-trivial method.  This allows you to quickly check whether the next code change did not lead to regression, that is, to the appearance of errors in the already tested program areas, and also facilitates the detection and elimination of such errors. <br><br>  We will not be able to write completely isolated tests, because all the components interact with each other.  By unit tests, we will mean checking the operation of a single module surrounded by mocks.  The interaction of several real modules will be checked in integration tests. <br><br>  Module interaction scheme: <br><br><img src="https://habrastorage.org/files/da6/d2c/ca8/da6d2cca88424fc2a7aa930a3de2cc8b.png"><br><br>  An example of testing a mapper (gray modules are not used, green ones are mocks, blue is a test module): <br><br><img src="https://habrastorage.org/files/44d/480/f5c/44d480f5c1954c489a64aa8dd6298a6c.png"><br><br><a name="27"></a>  Infrastructure <br><br>  Tools and frameworks improve the convenience of writing and supporting tests.  A CI server that prevents you from doing a merge with red tests drastically reduces the chances of unexpected failures of tests in the master branch.  Auto run tests and nightly builds help identify problems at an early stage.  This principle is called <a href="https://habrahabr.ru/post/218325/">fail fast</a> . <br>  You can read about the test environment in the article <a href="https://habrahabr.ru/company/rambler-co/blog/266837/">Testing on Android: Robolectric + Jenkins + Jao</a> .  In the future, we will use <a href="http://robolectric.org/">Robolecric</a> to write tests, <a href="http://mockito.org/">mockito</a> to create mocks, and <a href="http://eclemma.org/jacoco/">Jaoo</a> to check the code coverage of the tests. <br><br>  The MVP pattern allows you to quickly and efficiently write tests on our code.  With the help of Dagger 2, we can replace the real objects with test mocks, isolating the code from the outside world.  For this we use a test component with test modules.  The substitution of a component occurs in a test application, which we specify using the <a href="https://habrahabr.ru/users/config/" class="user_link">Config</a> (application = TestApplication.class) annotation in the base test class. <br><br><a name="28"></a>  JaCoCo Code Coverage <br><br>  Before you start, you need to determine which methods to test and how to calculate the percentage of coverage tests.  To do this, use the JaCoCo library, which generates reports on the results of test execution. <br>  Modern Android Studio <a href="https://codelabs.developers.google.com/codelabs/android-testing/index.html">supports code coverage out of the box,</a> or you can configure it by adding the following lines to build.gradle: <br><br><div class="spoiler">  <b class="spoiler_title">build.gradle</b> <div class="spoiler_text"><pre> <code class="ruby hljs">apply <span class="hljs-symbol"><span class="hljs-symbol">plugin:</span></span> <span class="hljs-string"><span class="hljs-string">'jacoco'</span></span> jacoco { toolVersion = <span class="hljs-string"><span class="hljs-string">"0.7.1.201405082137"</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">coverageSourceDirs</span></span></span><span class="hljs-function"> = [ '..</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">/</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">/</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">src</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">/</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">/</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">java</span></span></span><span class="hljs-function">' ] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">task</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jacocoTestReport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">type:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> JacocoReport, </span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">dependsOn:</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"testDebugUnitTest"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { group = <span class="hljs-string"><span class="hljs-string">"Reporting"</span></span> description = <span class="hljs-string"><span class="hljs-string">"Generate Jacoco coverage reports"</span></span> classDirectories = fileTree( <span class="hljs-symbol"><span class="hljs-symbol">dir:</span></span> <span class="hljs-string"><span class="hljs-string">'../app/build/intermediates/classes/debug'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">excludes:</span></span> [<span class="hljs-string"><span class="hljs-string">'**/R.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/R$*.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/*$ViewInjector*.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/*$ViewBinder*.*'</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>DI <span class="hljs-string"><span class="hljs-string">'**/*_MembersInjector*.*'</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>DI <span class="hljs-string"><span class="hljs-string">'**/*_Factory*.*'</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>DI <span class="hljs-string"><span class="hljs-string">'**/testrx/model/dto/*.*'</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//dto</span></span> model <span class="hljs-string"><span class="hljs-string">'**/testrx/presenter/vo/*.*'</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//vo</span></span> model <span class="hljs-string"><span class="hljs-string">'**/testrx/other/**'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/BuildConfig.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/Manifest*.*'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/Lambda$*.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/Lambda.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/*Lambda.class'</span></span>, <span class="hljs-string"><span class="hljs-string">'**/*Lambda*.class'</span></span>] ) additionalSourceDirs = files(coverageSourceDirs) sourceDirectories = files(coverageSourceDirs) executionData = files(<span class="hljs-string"><span class="hljs-string">'../app/build/jacoco/testDebugUnitTest.exec'</span></span>) reports { xml.enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> html.enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre><br></div></div><br>  Pay attention to the excluded classes: we have deleted everything related to Dagger 2 and our DTO and VO models. <br><br>  Run jacoco (gradlew jacocoTestReport) and look at the results: <br><br><img src="https://habrastorage.org/files/db7/7fb/7eb/db77fb7eb0ba403cb22e008e3dfb8f24.PNG"><br><br>  Now we have a percentage of coverage ideally coincides with our number of tests, ie, 0% =) Let's fix this situation! <br><br><a name="29"></a><h5>  Model </h5><br>  In the model layer we need to check the correctness of the retrofit setting (ApiInterface), the correctness of the client creation and the work of the ModelImpl. <br>  Components should be checked in isolation, so for checking we need to emulate a server, this will help us <a href="http/tree/master/mockwebserver">MockWebServer</a> .  We configure server responses and check retrofit requests. <br><br><div class="spoiler">  <b class="spoiler_title">Layer Model Layout, classes requiring testing are marked in red</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/770/238/309/7702383092c54bd88fff25b0113a2461.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Test module for Dagger 2</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelTestModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">ApiInterface </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideApiInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock(ApiInterface.class); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Named</span></span>(Const.UI_THREAD) <span class="hljs-function"><span class="hljs-function">Scheduler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideSchedulerUI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Schedulers.immediate(); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Named</span></span>(Const.IO_THREAD) <span class="hljs-function"><span class="hljs-function">Scheduler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideSchedulerIO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Schedulers.immediate(); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Test examples</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiInterfaceTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockWebServer server; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ApiInterface apiInterface; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.setUp(); server = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockWebServer(); server.start(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Dispatcher dispatcher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dispatcher() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MockResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RecordedRequest request)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.getPath().equals(<span class="hljs-string"><span class="hljs-string">"/users/"</span></span> + TestConst.TEST_OWNER + <span class="hljs-string"><span class="hljs-string">"/repos"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) .setBody(testUtils.readString(<span class="hljs-string"><span class="hljs-string">"json/repos"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.getPath().equals(<span class="hljs-string"><span class="hljs-string">"/repos/"</span></span> + TestConst.TEST_OWNER + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + TestConst.TEST_REPO + <span class="hljs-string"><span class="hljs-string">"/branches"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) .setBody(testUtils.readString(<span class="hljs-string"><span class="hljs-string">"json/branches"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.getPath().equals(<span class="hljs-string"><span class="hljs-string">"/repos/"</span></span> + TestConst.TEST_OWNER + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + TestConst.TEST_REPO + <span class="hljs-string"><span class="hljs-string">"/contributors"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) .setBody(testUtils.readString(<span class="hljs-string"><span class="hljs-string">"json/contributors"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">404</span></span>); } }; server.setDispatcher(dispatcher); HttpUrl baseUrl = server.url(<span class="hljs-string"><span class="hljs-string">"/"</span></span>); apiInterface = ApiModule.getApiInterface(baseUrl.toString()); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ TestSubscriber&lt;List&lt;RepositoryDTO&gt;&gt; testSubscriber = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestSubscriber&lt;&gt;(); apiInterface.getRepositories(TestConst.TEST_OWNER).subscribe(testSubscriber); testSubscriber.assertNoErrors(); testSubscriber.assertValueCount(<span class="hljs-number"><span class="hljs-number">1</span></span>); List&lt;RepositoryDTO&gt; actual = testSubscriber.getOnNextEvents().get(<span class="hljs-number"><span class="hljs-number">0</span></span>); assertEquals(<span class="hljs-number"><span class="hljs-number">7</span></span>, actual.size()); assertEquals(<span class="hljs-string"><span class="hljs-string">"Android-Rate"</span></span>, actual.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getName()); assertEquals(<span class="hljs-string"><span class="hljs-string">"andrey7mel/Android-Rate"</span></span>, actual.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getFullName()); assertEquals(<span class="hljs-number"><span class="hljs-number">26314692</span></span>, actual.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getId()); } <span class="hljs-meta"><span class="hljs-meta">@After</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tearDown</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ server.shutdown(); } }</code> </pre><br></div></div><br>  To check the model we mock ApiInterface and check the correctness of the work. <br><br><div class="spoiler">  <b class="spoiler_title">Sample tests for ModelImpl</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetRepoBranches</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ BranchDTO[] branchDTOs = testUtils.getGson().fromJson(testUtils.readString(<span class="hljs-string"><span class="hljs-string">"json/branches"</span></span>), BranchDTO[].class); when(apiInterface.getBranches(TestConst.TEST_OWNER, TestConst.TEST_REPO)).thenReturn(Observable.just(Arrays.asList(branchDTOs))); TestSubscriber&lt;List&lt;BranchDTO&gt;&gt; testSubscriber = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestSubscriber&lt;&gt;(); model.getRepoBranches(TestConst.TEST_OWNER, TestConst.TEST_REPO).subscribe(testSubscriber); testSubscriber.assertNoErrors(); testSubscriber.assertValueCount(<span class="hljs-number"><span class="hljs-number">1</span></span>); List&lt;BranchDTO&gt; actual = testSubscriber.getOnNextEvents().get(<span class="hljs-number"><span class="hljs-number">0</span></span>); assertEquals(<span class="hljs-number"><span class="hljs-number">3</span></span>, actual.size()); assertEquals(<span class="hljs-string"><span class="hljs-string">"QuickStart"</span></span>, actual.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getName()); assertEquals(<span class="hljs-string"><span class="hljs-string">"94870e23f1cfafe7201bf82985b61188f650b245"</span></span>, actual.get(<span class="hljs-number"><span class="hljs-number">0</span></span>).getCommit().getSha()); }</code> </pre><br></div></div><br>  Check the coverage in Jacoco: <br><br><img src="https://habrastorage.org/files/226/a79/59d/226a7959de2e4ff2a6eacad9210f3743.PNG"><br><br><a name="211"></a><h5>  Presenter </h5><br>  In the presenter layer, we need to test the work of mappers and the work of presenters. <br><br><div class="spoiler">  <b class="spoiler_title">Layer Presenter schema, classes requiring testing are marked in red</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/4f0/eeb/735/4f0eeb73517641629fdbd5e6fc1a1e3d.png"><br></div></div><br>  With mappers everything is quite simple.  We read json from files, we will transform and we check. <br>  With presenters, we mock the model and check the calls of the necessary methods in the view.  It is also necessary to check the correctness of onSubscribe and onStop, for this we intercept the subscription (Subscription) and check isUnsubscribed <br><br><div class="spoiler">  <b class="spoiler_title">Sample tests in the presenter layer</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.setUp(); component.inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); activityCallback = mock(ActivityCallback.class); mockView = mock(RepoListView.class); repoListPresenter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepoListPresenter(mockView, activityCallback); doAnswer(invocation -&gt; Observable.just(repositoryDTOs)) .when(model) .getRepoList(TestConst.TEST_OWNER); doAnswer(invocation -&gt; TestConst.TEST_OWNER) .when(mockView) .getUserName(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLoadData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ repoListPresenter.onCreateView(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); repoListPresenter.onSearchButtonClick(); repoListPresenter.onStop(); verify(mockView).showRepoList(repoList); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testSubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ repoListPresenter = spy(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepoListPresenter(mockView, activityCallback)); <span class="hljs-comment"><span class="hljs-comment">//for ArgumentCaptor repoListPresenter.onCreateView(null); repoListPresenter.onSearchButtonClick(); repoListPresenter.onStop(); ArgumentCaptor&lt;Subscription&gt; captor = ArgumentCaptor.forClass(Subscription.class); verify(repoListPresenter).addSubscription(captor.capture()); List&lt;Subscription&gt; subscriptions = captor.getAllValues(); assertEquals(1, subscriptions.size()); assertTrue(subscriptions.get(0).isUnsubscribed()); }</span></span></code> </pre><br></div></div><br>  See the change in JaCoCo: <br><br><img src="https://habrastorage.org/files/eaf/321/43c/eaf32143cf5849fab753279698c8b811.PNG"><br><br><a name="212"></a><h5>  View </h5><br>  When testing the View layer, we need to check only the calls of the methods of the life cycle of the presenter from the fragment.  All logic is contained in the presenters. <br><br><div class="spoiler">  <b class="spoiler_title">Layer View Layout, classes requiring testing are marked in red</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/493/308/eff/493308effac548b686cb5f2e2fe77667.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Example of fragment testing</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testOnCreateViewWithBundle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ repoInfoFragment.onCreateView(LayoutInflater.from(activity), (ViewGroup) activity.findViewById(R.id.container), bundle); verify(repoInfoPresenter).onCreateView(bundle); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testOnStop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ repoInfoFragment.onStop(); verify(repoInfoPresenter).onStop(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testOnSaveInstanceState</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ repoInfoFragment.onSaveInstanceState(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); verify(repoInfoPresenter).onSaveInstanceState(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); }</code> </pre><br></div></div><br>  Final test coverage: <br><br><img src="https://habrastorage.org/files/1c5/86b/69a/1c586b69aa204d818e39e5ba22920b33.PNG"><br><br><a name="213"></a><h4>  Conclusion or to be continued ... </h4><br>  In the second part of the article, we looked at the implementation of Dagger 2 and covered the unit code with tests.  Thanks to the use of MVP and the substitution of injections, we were able to quickly write tests for all parts of the application.  <a href="https://github.com/andrey7mel/android-step-by-step">All code is available on github</a> .  The article was written with the active participation of <a href="https://habrahabr.ru/users/nnesterov/" class="user_link">nnesterov</a> .  In the next part we will look at integration and functional testing, and also talk about TDD. <br><br>  <b>UPDATE</b> <br>  <a href="https://habrahabr.ru/company/rambler-co/blog/279799/">Building Android applications step by step, part three</a> </div><p>Source: <a href="https://habr.com/ru/post/277343/">https://habr.com/ru/post/277343/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277333/index.html">Copy elision, or how to shoot the leg to the neck ...</a></li>
<li><a href="../277335/index.html">Using functions in PostgreSQL as parameterized views</a></li>
<li><a href="../277337/index.html">Experiment: How irrational is exchange trading at short intervals (scalping)</a></li>
<li><a href="../277339/index.html">Theory of restrictions in interfaces (who killed the old graph?)</a></li>
<li><a href="../277341/index.html">NetSkills Online Networking School</a></li>
<li><a href="../277345/index.html">In-depth training in the garage - Two networks</a></li>
<li><a href="../277349/index.html">Ireland is a tasty morsel for building a data center</a></li>
<li><a href="../277351/index.html">Implementing a semantic news aggregator with extensive search capabilities</a></li>
<li><a href="../277353/index.html">Examination of SSL certificates, software licenses and backup space</a></li>
<li><a href="../277355/index.html">Data Center with warranty</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>