<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vraytap autumn crackme from Kaspersky Lab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. The name speaks for itself. The event was poorly lit and I somehow miraculously managed to participate in it. As a result, he managed to grab e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vraytap autumn crackme from Kaspersky Lab</h1><div class="post__text post__text-html js-mediator-article">  Hello.  The name speaks for itself.  The event was poorly lit and I somehow miraculously managed to participate in it.  As a result, he managed to grab eleventh place and get the right to the promised dividends.  Let's get down to business. <br><a name="habracut"></a><br>  <a href="https://filebin.ca/3dKBWvFonhA2">Quacks</a> .  Or <a href="https://events.kaspersky.com/crackme">here</a> (hello from 2k17 if the link got stuck) <br><br>  Tools: IDA, HxD, CFF Explorer, DbgView, <a href="http://www.softpedia.com/get/System/File-Management/PEChecksum.shtml">PEChecksum</a> , <a href="http://lsacccarp-ru.1gb.ru/ksec.html">KmdManager</a> <br>  The last three tools are quite specific, many crackers have already understood what the whole point of the crack is. <br><br>  After downloading the file, it turned out that it does not have an extension.  Dirty thoughts about the fact that this is another ctf rubbish a la find how to use me began to creep into my head.  Hex listing brought me back to ataraxia: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/06/59dd061b47615723607508.png" alt="image"><br></div></div><br>  Mark Zbikowski‚Äôs cherished signatures were in place, we continue the analysis: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/0b/59dd0b89d00c5475178970.png" alt="image"><br></div></div><br>  This is a turnaround driver.  Feel free to rename cracks in <code>crackme.sys</code> .  This time a well-grounded question came into my head: where is the loader?  Where is the graph (user interface, don't think anything bad)?  They are not.  Literally.  I think this is the second most important (hehe, we'll get to the first one), the illogical nature of the quacks: this does not happen.  We continue the analysis. <br><br>  This is what the ImageBase driver looks like: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/10/59dd1026aadce230842653.png" alt="image"><br></div></div><br>  And this is the real driverEntry: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/12/59dd12dd2bf8d306613069.png" alt="image"><br></div></div><br>  Here you should remember the name of the device and pay attention to the fact that our driver kindly handles the user <code>DeviceIoControl</code> . <br><br>  This is how the handler looks like before manual adjustment: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/15/59dd159a7e263809259086.png" alt="image"><br></div></div><br>  And so after comparing with asm listing: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/17/59dd176d52bef045115758.png" alt="image"><br></div></div><br>  What's going on here?  The function receives a buffer at the input (I‚Äôm not able to figure out how to transfer it to <code>DeviceIoControl</code> , write in the comments) and a control code.  The buffer, depending on the <code>ControlCode</code> , is copied to the mail or serial field (cool emulation, what to say).  After filling in these fields, we have to send a <code>ControlCode</code> for the third time and as a result, a certain <code>Validate</code> function will be launched, on the basis of which a message will be displayed. <br><br>  An experienced crack would patch this case and launch it into release, only we need to find the serial number to our email.  Prepare for the worst and go to the cherished function <code>Validate</code> : <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/20/59dd206252391365832696.png" alt="image"><br></div></div><br>  Asm listing of her most intimate moment: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/dd/26/59dd26f369a25547188800.png" alt="image"><br></div></div><br>  After validating the received parameters, it calculates a hash from a certain constant string, a hash from the input <code>buf1</code> (our mail, this is obvious) and a common hash from these two strings. <br><br>  What does the <code>func1</code> function look like?  Scary and terrible <s>(actually not very)</s> .  Inside it, there are also functions 4, which do something with the incoming line: fill, copy, modify, and so on. <br><br>  It is worth remembering that in <code>func1</code> we don‚Äôt transfer anything related to <code>buf2</code> (obviously, this is our serial).  And what does a cracker do when it sees a certain hash function from the mail, to which nothing connected with the serial is transferred, and right after this a charming combination: <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> eax, eax repe cmpsb setz al ret</code> </pre><br>  Of course!  It <s>flies like a Kama bullet</s> goes to breakpoint after calling this function, the return string is our serial (the biggest problem of any crackers is the banal strcmp).  But there is a couple but: <br><br><ol><li>  We need to correctly initialize the call to the function <code>Validate</code> through a series of calls to the driver (well, or use the handles to call + patch the memory) </li><li>  The usual debugger of the ‚ÄúOlya‚Äù archetype for ring0 is not suitable - you need to use more powerful tools </li></ol><br>  No matter how hard I tried, but my VirtualBox with the xp sp3 knurled on top refused to accept Syser / SoftICE / WinDbg.  An idea appeared: why not make the driver kindly tell us the serial?  How can I do that? <br><br>  To begin with, patch checks for validity of incoming data inside <code>Validate</code> : <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/de/50/59de508ddca8b166539644.png" alt="image"><br></div></div><br>  Just overwrite them with nop`ami. <br><br>  Then you need to manually fill the buffer with soap (it is dynamically allocated); we do this, let's say, at the very beginning of the <code>Validate</code> function.  It was like this: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/de/53/59de535a35d39719494233.png" alt="image"><br></div></div><br>  It became so: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/de/55/59de551feb29c814918402.png" alt="image"><br></div></div><br>  Those was a dynamic calculation of the length of the mail and everything related to <code>buf2</code> . <br><br>  Now we patch the very end of the function and instead of <code>repe cmpsb</code> execution of the <code>repe cmpsb</code> stuff the <code>DbgPrint</code> call: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/df/88/59df88af7b945511220895.png" alt="image"><br></div></div><br>  After patching, it is necessary to recalculate the CheckSum driver field - for this we use the PEChecksum utility.  Then we load the driver using KmdManager (to download the x32 driver, you must have a x32 system, preferably xp), open DebugView.  Then it remains to write a small program to call the driver: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> tmp[<span class="hljs-number"><span class="hljs-number">0x100</span></span>]; HANDLE handle = CreateFile(<span class="hljs-string"><span class="hljs-string">L"\\\\.\\crackme"</span></span>, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, <span class="hljs-number"><span class="hljs-number">0</span></span>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <span class="hljs-number"><span class="hljs-number">0</span></span>); DeviceIoControl(handle, <span class="hljs-number"><span class="hljs-number">0x222408</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;tmp, <span class="hljs-number"><span class="hljs-number">0x100</span></span>, &amp;tmp, <span class="hljs-number"><span class="hljs-number">0</span></span>); CloseHandle(handle);</code> </pre><br>  Compile, run: <br><br><div class="spoiler">  <b class="spoiler_title">Removed under spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/59/de/5e/59de5e486baed602792597.png" alt="image"><br></div></div><br>  The first line is the desired serial.  I say goodbye to this. <br><blockquote>  NOTE: The decision was published immediately after the assignment completed the first fifteen participants in the competition.  Fair competition must be respected. </blockquote></div><p>Source: <a href="https://habr.com/ru/post/339892/">https://habr.com/ru/post/339892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339870/index.html">Search for solutions to quickly create interfaces DBMS</a></li>
<li><a href="../339872/index.html">In search of reason: is it possible to make a ‚Äúuniversal‚Äù chat bot using neural networks?</a></li>
<li><a href="../339874/index.html">About the Strata AI conference: the future of artificial intelligence</a></li>
<li><a href="../339878/index.html">Uneducated youth. What's left overs</a></li>
<li><a href="../339882/index.html">How do we at Tutu.ru achieve the effectiveness of each of the 9000+ UI tests?</a></li>
<li><a href="../339894/index.html">What every developer should know about the search</a></li>
<li><a href="../339896/index.html">Instructions on how to compile the dynamic ngx_pagespeed module for Nginx to Debian</a></li>
<li><a href="../339900/index.html">Stream in NodeJS - rivers that you enter twice</a></li>
<li><a href="../339902/index.html">Maven, where are my artifacts? Another article about dependency management</a></li>
<li><a href="../339904/index.html">Overview of the Luigi Framework for building sequences of tasks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>