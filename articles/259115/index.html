<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hyper-v Server 2012R2: installation and configuration experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I want to share my experience installing and configuring the Hyper-V Server 2012R2 hypervisor from Microsoft. So let's get started. G...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hyper-v Server 2012R2: installation and configuration experience</h1><div class="post__text post__text-html js-mediator-article">  In this article, I want to share my experience installing and configuring the Hyper-V Server 2012R2 hypervisor from Microsoft.  So let's get started.  Given: 2 servers and iscsi storage. <br><br><h5>  1. Image preparation </h5><br>  <a href="http://www.microsoft.com/ru-ru/softmicrosoft/hyperv2012r2.aspx">Download the</a> image to install the server from Microsoft.  If you have a deployed Windows Deployment Services service or an installed Windows Deployment and Assessment Toolkit ( <a href="https://www.microsoft.com/ru-ru/download/details.aspx%3Fid%3D39982">Windows ADK</a> ) installed, you can unpack the 7-zip distributive from the link above into a folder, for example, <b>D: \ W2012 \ x64 \ dvd</b> .  Then received <div class="spoiler">  <b class="spoiler_title">windows update</b> <div class="spoiler_text">  Windows8.1-KB2919355-x64.msu <br>  Windows8.1-KB2919442-x64.msu <br>  Windows8.1-KB2932046-x64.msu <br>  Windows8.1-KB2934018-x64.msu <br>  Windows8.1-KB2937592-x64.msu <br>  Windows8.1-KB2938439-x64.msu <br>  Windows8.1-KB2959977-x64.msu <br></div></div>  copy to the folder <b>D: \ W2012 \ x64 \ upd</b> , create the folder <b>D: \ W2012 \ mnt</b> and use the following batch file to update the image. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Script update and image modifications</b> <div class="spoiler_text">  Dism / Mount-WIM /WimFile:D:\W2012\x64\DVD\sources\install.wim / index: 1 / MountDir: D: \ W2012 \ mnt <br>  dism / image: D: \ W2012 \ mnt / Enable-Feature / FeatureName: MultipathIo <br>  dism / image: D: \ W2012 \ mnt / Enable-Feature / All / FeatureName: NetFx3 / Source: d: \ W2012 \ x64 \ dvd \ sources \ sxs <br>  dism / image: D: \ W2012 \ mnt / Add-Package / PackagePath: d: \ W2012 \ x64 \ upd <br>  Dism / Unmount-Wim / MountDir: D: \ W2012 \ mnt / commit <br>  pause <br></div></div><br>  The unpacked distribution package can be rebuilt into a bootable iso, for example, using the Ultraiso program, opening the source image in it and adding the <b>install.wim</b> file from the <b>D: \ W2012 \ x64 \ dvd \ sources</b> folder to the <b>Sources</b> folder and saving the resulting image.  Again, all the above-described manipulations can be omitted, the updated image will speed up the deployment of the Hyper-V server. <br><br><h5>  2. Installation </h5><br>  If the source disk for the server installation exceeds 2TB in size, then in order to be able to use all the possible disk space you need to convert the disk to GPT and partition it before starting the installation.  It is not possible to do this during the installation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You need to boot into PE mode from the installation disk and run diskpart. <br>  Convert MBR to GPT using DISKPART <br><br><pre><code class="dos hljs"># Diskpart # select disk <span class="hljs-number"><span class="hljs-number">0</span></span> # <span class="hljs-built_in"><span class="hljs-built_in">convert</span></span> gpt # create partition primary align=<span class="hljs-number"><span class="hljs-number">64</span></span> offset= <span class="hljs-number"><span class="hljs-number">104857600</span></span></code> </pre> <br>  For further installation, you need to set the UEFI boot in the server's BIOS (but this is if your server‚Äôs local storage exceeds 2 TB, if not, you can skip this step) <br><br><h5>  3. Initial setup </h5><br>  We include Remote Desktop in sconfig (point 7-e-2): <br><br><img src="https://habrastorage.org/files/be5/4d7/28b/be54d728ba934024b4d1bb991490e037.png"><br><br>  Enable ping (clause 4-3): <br><br><img src="https://habrastorage.org/files/89d/a8c/202/89da8c20284047cc9c11ce8446ae0161.png"><br><br>  At the command line, launch powershell and disable the firewall (you can skip): <br><br><pre> <code class="vbscript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-NetFirewallProfile ‚ÄìProfile * -Enabled <span class="hljs-literal"><span class="hljs-literal">False</span></span></code> </pre><br><h5>  4. Configure the virtual switch </h5><br>  Setting the MAC address pool for the virtual switch (change the selected values, ie, take the last octet of the ip address (for example, 192.168. 251. <b>11</b> ) of the mgmt interface and translate it into hexadecimal): <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-ItemProperty -Path ‚ÄúHKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization‚Äù -Name MinimumMacAddress -PropertyType Binary -Value ([byte[]](<span class="hljs-number"><span class="hljs-number">0x00</span></span>,<span class="hljs-number"><span class="hljs-number">0x15</span></span>,<span class="hljs-number"><span class="hljs-number">0x5D</span></span>,<span class="hljs-number"><span class="hljs-number">0xFB</span></span>,<span class="hljs-number"><span class="hljs-number">0x0B</span></span>,<span class="hljs-number"><span class="hljs-number">0x00</span></span>)) ‚ÄìForce <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-ItemProperty -Path ‚ÄúHKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Virtualization‚Äù -Name MaximumMacAddress -PropertyType Binary -Value ([byte[]](<span class="hljs-number"><span class="hljs-number">0x00</span></span>,<span class="hljs-number"><span class="hljs-number">0x15</span></span>,<span class="hljs-number"><span class="hljs-number">0x5D</span></span>,<span class="hljs-number"><span class="hljs-number">0xFB</span></span>,<span class="hljs-number"><span class="hljs-number">0x0B</span></span>,<span class="hljs-number"><span class="hljs-number">0xFF</span></span>)) ‚ÄìForce</code> </pre><br>  This is to ensure that the MAC addresses of virtual servers located on different hyper-v host do not overlap.  By default, they are issued from the same range and may turn out to be the same, as I happened during the implementation on one object. <br><br>  Getting a list of network adapters: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-NetAdapter</code> </pre><br><pre> <code class="dos hljs">PS C:\Users\Administrator&gt; Get-NetAdapter Name InterfaceDescription ifIndex Status MacAddress LinkSpeed ---- ----------------- ------- ------ ---------- --------- NIC4 Broadcom NetXtreme Gigabit Ethernet #<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> Up C8-<span class="hljs-number"><span class="hljs-number">1</span></span>F-<span class="hljs-number"><span class="hljs-number">66</span></span>-D1-CB-FA <span class="hljs-number"><span class="hljs-number">1</span></span> Gbps NIC3 Broadcom NetXtreme Gigabit Ethernet #<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> Up C8-<span class="hljs-number"><span class="hljs-number">1</span></span>F-<span class="hljs-number"><span class="hljs-number">66</span></span>-D1-CB-F9 <span class="hljs-number"><span class="hljs-number">1</span></span> Gbps NIC2 Broadcom NetXtreme Gigabit Ethernet #<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> Up C8-<span class="hljs-number"><span class="hljs-number">1</span></span>F-<span class="hljs-number"><span class="hljs-number">66</span></span>-D1-CB-F8 <span class="hljs-number"><span class="hljs-number">1</span></span> Gbps NIC1 Broadcom NetXtreme Gigabit Ethernet <span class="hljs-number"><span class="hljs-number">13</span></span> Up C8-<span class="hljs-number"><span class="hljs-number">1</span></span>F-<span class="hljs-number"><span class="hljs-number">66</span></span>-D1-CB-F7 <span class="hljs-number"><span class="hljs-number">1</span></span> Gbps</code> </pre><br>  We need - NIC1 and NIC2. <br>  Combining adapters into a group (Team1): <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-NetLbfoTeam ‚ÄìName Team1 ‚ÄìTeamMembers ‚ÄúNIC1‚Äù,‚ÄúNIC2‚Äù ‚ÄìTeamingMode Lacp ‚ÄìLoadBalancingAlgorithm Dynamic</code> </pre><br>  Creating a virtual switch (vSwitch0): <br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-VMSwitch -Name vSwitch0 -NetAdapterName Team1 -AllowManagementOS $<span class="hljs-literal"><span class="hljs-literal">False</span></span> -MinimumBandwidthMode Weight</code> </pre><br>  Creating a virtual set.  adapter (Management) and connect it to a virtual switch: <br><br><pre> <code class="vbscript hljs">Add-VMNetworkAdapter -ManagementOS -Name <span class="hljs-string"><span class="hljs-string">"MGMT"</span></span> -SwitchName <span class="hljs-string"><span class="hljs-string">"vSwitch0"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-VMNetworkAdapterVlan -ManagementOS -VMNetworkAdapterName <span class="hljs-string"><span class="hljs-string">"MGMT"</span></span> -Access -VlanId <span class="hljs-number"><span class="hljs-number">251</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-VMNetworkAdapter -ManagementOS -Name <span class="hljs-string"><span class="hljs-string">"MGMT"</span></span> -MinimumBandwidthWeight <span class="hljs-number"><span class="hljs-number">20</span></span></code> </pre><br>  The ports on the physical switch are configured on the trunk and Vlan 251. In this example, this is the subnet for managing the Hyper-V server. <br><br>  Setting the IP address, mask, gateway and DNS server on the virtual adapter (MGMT): item 8 of the sconfig menu (for example: 192.168.251.11/24, gw 192.168.251.1): <br><br>  After that, the server should ping and you can use remote access. <br><br>  Connect via RDP, create a virtual network adapter (Cluster) and connect it to the virtual switch: <br><br><pre> <code class="vbscript hljs">Add-VMNetworkAdapter -ManagementOS -Name <span class="hljs-string"><span class="hljs-string">"Cluster"</span></span> -SwitchName <span class="hljs-string"><span class="hljs-string">"vSwitch0"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-VMNetworkAdapterVlan -ManagementOS -VMNetworkAdapterName <span class="hljs-string"><span class="hljs-string">"Cluster"</span></span> -Access -VlanId <span class="hljs-number"><span class="hljs-number">253</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-VMNetworkAdapter -ManagementOS -Name <span class="hljs-string"><span class="hljs-string">"Cluster"</span></span> -MinimumBandwidthWeight <span class="hljs-number"><span class="hljs-number">40</span></span></code> </pre><br><h5>  5. Connecting storage </h5><br>  We will proceed from the assumption that the storage system is already configured and connected to the corresponding ports of the switch.  Configure ip-addresses for interface iscsi adapters: <br><br>  Start powershell from the command line: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-NetIPAddress -InterfaceAlias <span class="hljs-string"><span class="hljs-string">"NIC3"</span></span> -IPAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.22</span></span> -PrefixLength <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-NetIPAddress -InterfaceAlias <span class="hljs-string"><span class="hljs-string">"NIC4"</span></span> -IPAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.22</span></span> -PrefixLength <span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-Service ‚ÄìName MSiSCSI ‚ÄìStartupType Automatic Start-Service MSiSCSI <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-IscsiTargetPortal ‚ÄìTargetPortalAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> $target = <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-IscsiTarget $target = <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-IscsiTarget $target| Connect-IscsiTarget -IsPersistent $<span class="hljs-literal"><span class="hljs-literal">true</span></span> -IsMultipathEnabled $<span class="hljs-literal"><span class="hljs-literal">true</span></span> -InitiatorPortalAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.22</span></span> -TargetPortalAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> $target| Connect-IscsiTarget -IsPersistent $<span class="hljs-literal"><span class="hljs-literal">true</span></span> -IsMultipathEnabled $<span class="hljs-literal"><span class="hljs-literal">true</span></span> -InitiatorPortalAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.22</span></span> -TargetPortalAddress <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-IscsiSession | Register-IscsiSession</code> </pre><br>  With Broadcom NetXtreme network adapters, an unpleasant bug emerged, which was expressed in the fact that the drivers in the image had a very low network transfer rate of 3 to 5 MB / s on a gigabit connection.  Low network performance - <blockquote>  This is a driver update to this issue.  If you have the following actions: <br>  Disable VMQ on the Virtual Network Adapter by using the following Windows PowerShell cmdlet: </blockquote><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Set</span></span>-VMNetworkAdapter ‚ÄìManagementOS -Name MGMT -VmqWeight <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  We fix or update drivers manually. <br><br><h5>  6. Install the necessary roles </h5><br>  Installing the necessary roles, the server must be connected to the Internet: <br><br><pre> <code class="vbscript hljs">Dism /online /enable-feature:MultipathIo DISM /online /Enable-Feature /all /FeatureName:NetFx3</code> </pre><br>  This is if you have not modified the image, as described in paragraph 1. <br><br>  We add support for SAS and iSCSI in the mpiocpl snap-in and after rebooting in the disk manager, the LUNs will not be duplicated if the server is connected in two or more ways. <br><br><pre> <b><code class="vbscript hljs">mpclaim -n -i -d <span class="hljs-string"><span class="hljs-string">"HP MSA 1040 SAN"</span></span></code></b> </pre>  (six spaces required) <br><br><img src="https://habrastorage.org/files/79b/d59/3e6/79bd593e66674e2fac86c515fe46ecb5.png"><br><br>  Check: <br><br><pre> <code class="dos hljs">diskpart # list disk</code> </pre><br><img src="https://habrastorage.org/files/602/9ab/c53/6029abc53cc44560badb7a4e29f08b8e.png"><br><br>  When adding a new volume to the storage system, execute in powershell: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">Get</span></span>-Disk Initialize-Disk -Number &lt;Number of disk&gt; -PartitionStyle GPT -PassThru | <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Partition -AssignDriveLetter -UseMaximumSize | Format-Volume</code> </pre><br>  Setting the time (after adding the server to the Windows domain, the time will be synchronized with the PDC): <br><br>  At the command prompt: <br><br><pre> <code class="dos hljs">sc config w32time <span class="hljs-built_in"><span class="hljs-built_in">start</span></span>= auto <span class="hljs-built_in"><span class="hljs-built_in">net</span></span> <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> w32time</code> </pre><br>  If necessary, manually: <br><pre> <code class="vbscript hljs">Control timedate.cpl</code> </pre><br>  ps <br>  Corrected some text and formatting <br>  Cluster configuration will be described later. </div><p>Source: <a href="https://habr.com/ru/post/259115/">https://habr.com/ru/post/259115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259103/index.html">Launch BIGIP Trial Edition for Oracle VirtualBox</a></li>
<li><a href="../259105/index.html">Cones on matryoshka</a></li>
<li><a href="../259107/index.html">Centos-admin.ru: learn Ansible</a></li>
<li><a href="../259111/index.html">We connect Microsoft Azure and a cloud of service provider in a uniform network</a></li>
<li><a href="../259113/index.html">STB - dive</a></li>
<li><a href="../259117/index.html">"Jetpack" is not so reactive, or how to do without it</a></li>
<li><a href="../259119/index.html">Automatic update of IP phones in 3CX. Part two. Practice</a></li>
<li><a href="../259121/index.html">Little tricks of passport collection</a></li>
<li><a href="../259123/index.html">Android M and Developer Tools</a></li>
<li><a href="../259125/index.html">Lectures Technopark. Semester 2 Java</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>