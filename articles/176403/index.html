<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Light music gift favorite with your own hands</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It will be a question of a device very simple to manufacture (even for a beginner electronics amateur), but at the same time extremely interesting and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Light music gift favorite with your own hands</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/420/ea5/1cb/420ea51cb6a427bab822b4bfb1b3579e.jpg"><br><br>  It will be a question of a device very simple to manufacture (even for a beginner electronics amateur), but at the same time extremely interesting and useful - an electronic ‚Äúmusic box‚Äù.  Also, as an example, I will show and tell you about one of the possible embodiments and applications of this device - about the last gift made to its base for its girlfriend. <br><a name="habracut"></a><br><h4>  History of creation </h4><br>  <i>There will be a lot of letters relevant indirectly enough, and if you want, <a href="https://habr.com/ru/post/176403/">you can go directly to the description of the device.</a></i> <br><br>  It all started a long time ago, several years ago, when I wanted to make a girl some interesting, original and memorable birthday gift.  And be sure to do it yourself.  There was very little time left before the holiday, two days, during which it was necessary to invent something and, in fact, realize it.  The day was spent in thought - hundreds of various options were spinning in my head, from all sorts of LED flashing lights, to various electromechanical handicrafts.  But all this was not that: either it was too simple and beaten up, or vice versa, it was rather difficult (and there is no time left at all!).  Suddenly a simple but wonderful, as it turned out, idea came to my mind: why not make a music card?  And not simple, but with a "chip", with an original melody.  Moreover, we had ‚Äúour own song‚Äù, under which we met and which caused us all sorts of pleasant romantic memories and experiences. <br>  So the very first version of the ‚Äúmusic box‚Äù was born, the progenitor, so to speak.  Very simple, quick-assembled mounted assembly from PIC12F675, piezodynamics, photodiode, a pair of resistors, a three-volt element 2016 and packed into a postcard drawn in photoshop.  This postcard, as a result, was able, when it opened (and when light hit the photodiode), to register that melody with a rectangle.  This is so simple and simple. <br>  But the idea turned out to be very successful, many times more than I expected.  Later, I made several more such simple postcards at the request of my friends, for their second half.  And in each case, such a gift caused a lot of emotions from both the donee themselves and their parents, friends and acquaintances :) <br>  It took a lot of time, everything started spinning, the project was forgotten.  But it so happened that I remembered the music box again.  This time it was supposed to be a gift on March 8th.  At that time, I was actively studying Atmel microcontrollers, in particular, I was playing with ATtiny45, and decided to improve the music module for this.  Moreover, this time there was a lot.  Then it all started. <br>  Searching for different information on the Internet, I came across the <a href="http://elm-chan.org/">website of Mr. Chan,</a> well-known in narrow circles.  And more specifically, to one of its designs, a <a href="http://elm-chan.org/works/mxb/report.html">miniature synthesizer</a> , just on the beloved MK :) Some time ago, I almost finished the four-channel synthesizer on the PIC18, but, alas, I have destroyed the groundwork in hearts (which I regretted more than once).  And Chan‚Äôs construction was completely self-sufficient and complete.  It remained to add to it only the "trigger" and go! <br>  I finished the code a bit and the trigger was ready.  But then everything turned out to be a little less rosy.  The main problem of the design was that it sounded too quiet.  No matter how hard I tried, with the direct drive, the dynamics of the MK pins turned out to be quiet and that's it!  As a result, a volition was made to add a power amplifier.  The choice fell on the LM4900 then present in Terraelectronics.  Again, we had to make some more changes to Mr. Chan‚Äôs code so that the synthesizer worked correctly with an external amplifier ‚Äî to make power-saving foot control, so that the amp wouldn't eat the battery when idle and reconfigure the PWM to output the signal from one pin correctly.  After these changes, the prototype earned just perfect.  Then I drew the first version of the board (in which, as it turned out, the jamb crept in :) and assembled the music box humanly.  Further, all along the beaten track is a homemade postcard, installation of the module and donation-presentation. <br>  Of course, this device was several heads taller than the previous ones - the very realistic sound of the ‚Äúreal‚Äù box and polyphony made themselves felt :) The gift, like last time, a long time ago, caused a stir.  And I also gathered about a dozen of such modules to my friends. <br><a name="about_device"></a><br><h4>  Now about the device itself </h4><br>  The current version of the module, the third in a row, contains several more changes and one interesting innovation - a <i>light</i> - <i>music channel</i> to which you can connect, for example, an LED.  But first things first. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Let's start with the scheme, it is very simple: </h5><br><img src="https://habrastorage.org/storage2/9a3/26f/af0/9a326faf02b829813c5835b34a35fd2e.jpg"><br>  Her heart is an <b>ATtiny45 / 85</b> microcontroller.  He is engaged, in fact, in the synthesis of music, manages the light-music channel and the power saving of the amplifier.  The second most important element is the <b>TPA301D</b> audio power amplifier.  A <b>speaker is</b> connected to the amplifier, which is located outside the module.  There is also a <b>BC847</b> transistor that controls the light-music channel and several passive elements - <b>resistors and capacitors</b> .  It all feeds from 2-3 alkaline cells (for example, AAA), located in an external <b>battery pack</b> (the most common, Chinese).  As you can see, the scheme is really elementary. <br><br><h5>  The principle of the scheme </h5><br>  Most of the time the device is in "sleep mode".  The MK falls asleep at the command of the firmware immediately after switching on, previously ‚Äúputting it to sleep‚Äù and the amplifier, setting a <i>‚ÄúSHUTDOWN‚Äù</i> high level on its leg (by connecting the weak <i>‚ÄúPB0‚Äù</i> leg tightening to the ‚Äú+‚Äù power inside the MK).  MK wakes up by interrupting c <i>PB2 / INT0</i> .  Initially, the leg is also tightened to the ‚Äú+‚Äù power inside the MK and it must be closed to the ground. <br>  From the ‚ÄúPB1 / OC1A‚Äù foot, the MK sound PWM signal, in order to filter it from the carrier, passes through the simplest RC filter of the second order ( <b>R2-C3</b> ), which must be calculated (and in our case it can be just ‚Äúestimated‚Äù) cut-off frequency, much smaller (ten times) of the carrier frequency.  And the filtered signal, through the blocking capacitor <b>C2</b> , is already fed to the input of the amplifier. <br>  The MC controls the additional light-music channel.  For this purpose, the npn transistor <b>Q1 is used</b> in the key mode, the base of which is connected to the foot of the MK <i>‚ÄúPB4 / OC1B‚Äù</i> via the current limiting resistor <b>R1</b> .  A limiting resistor ( <b>R3</b> ) can also stand in the collector circuit - it will not be superfluous.  The transistor is also controlled by a PWM signal.  Everything is done very simply - in the best traditions of ‚Äúflashing‚Äù LEDs from the ‚ÄúArduin‚Äù :) <br>  On nutrition there is an interchange tantalum ( <b>C1</b> ), the simplest body kit of the amplifier, performing both the role of decoupling ( <b>C4</b> ) and adjusting the gain (volume) coefficient, in general, is peeped at the datasheet on the amplifier.  If necessary, KU can be quite accurately calculated by the most common for the OS method of the ratio of the resistances of the input resistor <b>R4</b> and feedback resistor <b>R5</b> , since the volume can be useful to correct for a particular speaker or design. <br><br><h5>  Printed circuit board </h5><br>  Simple to ugliness, drawn in DipTrace: <br><img src="https://habrastorage.org/storage2/835/178/65a/83517865a94e9719393213bb1086acb7.jpg"><br>  This is the third version, which takes into account all previous shortcomings. <br>  The board is designed for surface mounting and one-sided, which greatly simplifies the process of home-made.  You can use any method: laser-ironing, photo-ability or even draw tracks with a marker (for an amateur, of course). <br>  All elements are 0805 (including ‚Äúzero‚Äù jumpers), tantalum - A or B, transistor in SOT23 and MK with amplifier in SO-8.  All "peripheral" components - the battery pack, the speaker, the LEDs and the button (photoresistor, reed switch) are fed to the corresponding "circles" on the board.  That's all. <br><br><h5>  Software part </h5><br><div class="spoiler">  <b class="spoiler_title">A little bit about sound synthesis</b> <div class="spoiler_text"> About the method of synthesis used in the device, you can lucidly read the original in Mr. Chan <a href="http://elm-chan.org/works/mxb/report.html">'s here</a> .  You can even google "wavetable synthesis".  If you do not speak the language, then briefly, a sound <i>sample</i> is stored in the memory of the MC (separately taken sound), the so-called.  <i>‚ÄúWavetable‚Äù</i> , which in our simplest case is conventionally divided into two logical parts, which generally form the <i>‚Äúenvelope‚Äù</i> - <i>‚Äúattack‚Äù</i> , the beginning of each new sound, and <i>‚Äúsustain‚Äù</i> , an excerpt, a fragment that constantly <i>loops</i> through the sound of the note.  There is also a <i>‚Äúdecay‚Äù</i> , ‚Äúvoice‚Äù part, which sounds after removing the note.  We have implemented it simply by gradually damping the sound of ‚Äúsustain‚Äù.  The MC has a timer that causes an interruption with a certain frequency, where, according to the current position of the ‚Äúenvelope‚Äù and the pitch of the note, the desired value is selected from the sample memory.  Moreover, in this way, you can simultaneously synthesize several channels (that is, notes) at the same time, everything depends only on the computing power of the MC and the sampling frequency (sound quality).  Then these values ‚Äã‚Äãare mixed and sent ‚Äúto the exit‚Äù (in our case - to the PWM control register).  All this disgrace, as I mentioned above, is called "Wavetable synthesis" or "tabular wave synthesis." </div></div><br>  The core of Mr. Chan‚Äôs synthesis has remained virtually unchanged.  Only the PWM output method has changed a bit, due to the rejection of the ‚Äúdirect drive‚Äù dynamics from the MK.  He added the ‚Äútrigger mechanism‚Äù, the power management of the MK and the amplifier, and also wrote the code for controlling the light and music channel, which works like this: by a special event from the score, the LED lights up in the right places, and then it turns off smoothly.  Well, "ported" (much, of course, said) code in the Studio, for convenience. <br>  The code is written in AVR assembly and consists of several files: <i>‚Äúmbox.asm‚Äù</i> is the program itself;  <i>‚ÄúNotes_pitch.inc‚Äù</i> - an indication of the correspondences of the mnemonic names of notes used in the score to the coefficients of the increment of the position of the pointer in the sample (that is, as a result, the pitch);  <i>‚ÄúWavetable.inc‚Äù</i> - sample data (‚Äútable‚Äù) and decay decay curve;  and <i>‚Äúscore.inc‚Äù</i> , as you may have guessed from the title, contains the score of the work being performed, the ‚Äúnotes‚Äù. <br>  Initially, in ‚Äúwavetable.inc‚Äù, Chan himself ‚Äúcrammed‚Äù the sound of the box.  But if necessary and desired, it can be changed to any other, using the auxiliary script <b>"wav2asm.pl"</b> , or simply by hand. <br>  The situation was more complicated with the score.  Initially it was supposed to write them by hand, which undoubtedly will bring a lot of pleasure to masochistic people, especially if the score is not at all simple. <br>  For a person who is going to use his score and, presumably, on this occasion, at least somewhat familiar with music and musical notation, it would be easier to draw the score in any available music editor and use it in some way.  For this, I wrote a special <b>converter program</b> that accepts a MIDI file of format 0 ‚Äúat the input‚Äù, and ‚Äúoutput‚Äù gives the finished file ‚Äúscore.inc‚Äù.  She can independently arrange the LED ignition events for all notes in the first channel, that is, if the melody is initially logically separated from the accompaniment and put into the first channel of the midi file, we will get a score that will light the LED in time with the melody if want and put daw.  <i>In fact, this is probably one of the most beautiful ways for an additional channel to work.</i> <br>  Another program can transpose the resulting score up to one or two octaves up / down, which in certain cases can greatly facilitate the work of writing a score. <br>  The program interface looks simple, clear and simple, and the source code for Delphi is included in the package: <br><br><img src="https://habrastorage.org/storage2/d83/f46/c28/d83f46c283e737ee0bf1e824257707c5.jpg"><br><br>  <i>By the way, as I was told at one time (for some reason I didn‚Äôt think about it at all), there are a lot of resources on the Internet, from where you can get ready-made midish with desired melodies.</i>  <i>They will need only a little refinement for use in my converter.</i>  <i>And some may not even have to refine.</i> <br><br><h5>  What else might be needed? </h5><br>  Suppose you bought / got all the necessary components, in one way or another made a board, or, alternatively, you just soldered all the hinged wiring.  What else is needed?  It will take a programmer.  If you already have or are dealing with AVR, then you most likely already have it.  And so, for example, <a href="http://www.fischl.de/usbasp/">‚ÄúUSBasp‚Äù</a> in hundreds of incarnations or <a href="http://www.ladyada.net/learn/avr/programmers.html">whatever</a> .  There is nothing supernatural.  In the archive with everything, there is an already compiled binary, which can be immediately poured into the controller and used if there is no intention to edit and reassemble something. <br><br><h4>  Application </h4><br>  And now, as promised, I will tell and show one of the hundreds of possible applications of the module, the musical rose of Kawasaki. <br>  <a href="http://www.forum.loveorigami.info/viewtopic.php%3Ff%3D46%26t%3D178">Rosa Kawasaki</a> , one of the masterpieces of origami, is generally a separate large topic, which you can fully familiarize yourself with on the Internet. <br>  Constructively, the thing itself is made of two parts: <br>  <i>The first, a rose</i> , is folded from a colored sheet of paper and glued onto a twisted stem with leaves (also folded from colored paper).  A thick copper wire passes through the stem (for strength) and a small neodymium magnet is hidden at the bottom. <br>  <i>The second part, a vase</i> , is cut and glued from thick white cardboard.  Inside it, the module itself is installed, a speaker (glued to a resonating volume filled with cotton), super-bright white wide-angle LEDs matted with a fine sandpaper and a battery pack mounted on the bottom of the vase for easy access to the batteries.  And, of course, the reed switch is a ‚Äútrigger mechanism‚Äù, which is paired with a magnet in the stem.  It is installed in such a way that the module is activated when removing the rose from the vase. <br>  Schematically, it looks like this: <br><br><img src="https://habrastorage.org/storage2/697/c54/a08/697c54a08e1c21457a1ac952da151a78.jpg"><br><br>  But a couple of photos of the prototype: <br><br><img src="https://habrastorage.org/storage2/bd4/b2c/977/bd4b2c9777aad2127c1a59d87275e023.jpg"><br><br><img src="https://habrastorage.org/storage2/7b8/7f4/a5f/7b87f4a5fc82db2ea6832df2eb87015c.jpg"><br><br>  And video work.  The composition ‚ÄúTenderness‚Äù plays on the video, which I transferred to the box, and which is included in the archive as a source (I typed in Sibelius) and a midish, as well as a ready-made score: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/T2qhZSITcDw%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253&amp;usg=ALkJrhiLOfsW4w61f3SWjOPRXFL65JNc5w" frameborder="0" allowfullscreen=""></iframe><br><br>  <i>As usual, my eternal problem with a normal sound in video makes itself felt.</i>  <i>A thousand apologies.</i>  <i>If it is interesting to listen in normal quality as the construction sounds, then you can download the <a href="">empathish from here</a> .</i> <br>  This is just one of the possible uses of the structure.  How you use your module will depend on your imagination;) <br>  I can only wish you success in this difficult creative work. <br>  Give joy to your loved ones and loved ones! <br><br>  <a href="">Download the archive with source codes and binary firmware, programs, drawing schemes and boards, score and other materials here.</a> <br><br><div class="spoiler">  <b class="spoiler_title">Disclaimer and thanks :)</b> <div class="spoiler_text">  PS This is my first post here, so please don‚Äôt kick much if in some way or somehow I was wrong. <br>  PPS I have already published this material partially and in a scattered form in my LiveJournal, more for myself, to notice some moments and leave a memo, but since the device turned out to be very interesting and successful, and already several modifications of this device in almost a couple of dozens of incarnations they fulfilled (and continue to fulfill) their destiny with interest - they please the ears and eyes of the girls - I decided to tell you about him and to you. <br>  PPPS Also, the story of the following device here, on Habr√©, was long ago comrade <a href="http://geektimes.ru/users/dlinyj/" class="user_link">dlinyj pushed me</a> , and then, finally, I gathered my strength, knocked off the material and decided to write the same post, for which Long thank you so much! </div></div></div><p>Source: <a href="https://habr.com/ru/post/176403/">https://habr.com/ru/post/176403/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176393/index.html">Google accounts can now be configured in case you cannot use them.</a></li>
<li><a href="../176395/index.html">Scientists managed to cure the paralyzed monkey hand by restoring neural connections</a></li>
<li><a href="../176397/index.html">Combimouse, a hybrid mouse and keyboard, launched a crowdsourcing campaign</a></li>
<li><a href="../176399/index.html">Search yesterday, today, tomorrow ...</a></li>
<li><a href="../176401/index.html">Samsung introduced a 6.3-inch smartphone Galaxy Mega</a></li>
<li><a href="../176407/index.html">HIV test ... from DVD drive</a></li>
<li><a href="../176409/index.html">Continuing the story with LitRes: a possible lawsuit against Alex Exler</a></li>
<li><a href="../176411/index.html">New domains of The Pirate Bay are blocked</a></li>
<li><a href="../176413/index.html">Facebook Game On: Moscow</a></li>
<li><a href="../176419/index.html">Effective online store. Instagram as a tool to increase sales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>