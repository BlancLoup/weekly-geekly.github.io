<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ossim. WMI plugins with a crisp. Recipe</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear readers. 

 I want to share with you my experiments to collect Windows event logs in OSSIM without the use of agents, i.e. using WMI pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ossim. WMI plugins with a crisp. Recipe</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear readers. <br><br>  I want to share with you my experiments to collect Windows event logs in OSSIM without the use of agents, i.e.  using WMI plugins. <br><a name="habracut"></a><br>  These plugins use the WMI interface and, accordingly, the wmi client to collect event logs.  The use of these plugins is not recommended, but rather is NOT recommended by the vendor (Alienvault) method of collecting event logs of target systems.  They argue that this method uses much more system resources than gathering event logs using the OSSEC agent.  This is true, and besides this, when using WMI, events may simply disappear, or the minutes may be delayed by 20-30, which, of course, is not acceptable. <br><br>  In addition, regular WMI plugins are made in such a way that they do not receive practically any useful information from Windows logs.  Only the Windows event ID (numeric and its translation into a human language, for example: 4624 - An account was successfully logged on), the name of the log (Security, System, Application ...), a timestamp and a huge message of the message field (which receives all useful information) information - IP addresses, user names, UAC settings, etc.).  Therefore, to get some useful information, the message field must be subjected to additional parsing, i.e.  regular WMI plugins need to be further configured.  Without this setting, a regular WMI plugin is almost useless. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If, nevertheless, the situation forces you to use not the OSSEC agent, but WMI plug-ins, I will tell you how to reduce the number and reduce the size of the rake that you will encounter along the way, namely: <br><br><ol><li>  How to set up receiving additional data from event logs collected via WMI; </li><li>  How to diagnose and troubleshoot the WMI plugin. </li></ol><br><h3>  <b>1. Retrieving additional data from event logs collected via WMI</b> </h3><br>  I will consider this task on the example of getting the user name.  The algorithm for setting up any other data will be similar. <br><br>  To obtain additional data, the ‚Äúcustom functions‚Äù functionality is used, which allows applying a samopisny function to any field received via WMI.  This function will parse the message field of the Windows log and place the resulting value (user name) in the username field of the event displayed in OSSIM. <br><br>  First, take a look at the regular wmi-security-logger plugin.  As can be seen from its configuration file, located in /etc/ossim/agent/plugins/wmi-security-logger.cfg, it executes two WQL (SQL for WMI) queries, the first of which (the cmd field in the start_cmd section) gets the number events starting from which the log is being read, and the second (the cmd field in the cmd section) already reads the log.  Here is an example of a second query reading the log: <br><br><pre><code class="bash hljs">Select ComputerName,EventCode,Logfile,Message,RecordNumber,SourceName,TimeWritten,User from Win32_NTLogEvent Where Logfile = <span class="hljs-string"><span class="hljs-string">'Security'</span></span> and RecordNumber &gt; OSS_COUNTER</code> </pre> <br>  These fields from the Windows log are read by the plugin: <br><br>  ComputerName, EventCode, Logfile, Message, RecordNumber, SourceName, TimeWritten, User <br>  You should not build hopes on the ‚ÄúUser‚Äù field, in Windows 2008R2 and more recent it gets the value ‚Äúnull‚Äù. <br><br>  Thus, the most informative field is ‚Äúmessage‚Äù.  From it using the function we will get the user name. <br><br>  If you look at the Windows log examples, you will see that there are two constructs containing the user name: <br><br>  <b>1) Logon Account: &lt;username&gt;</b> <br>  An example of a "raw" event, as OSSIM sees it: <br><br><pre> <code class="bash hljs">nsrv_WinSRV-DC.domain.test|4776|Security|The computer attempted to validate the credentials <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> an account.\r\n\r\nAuthentication Package:\tMICROSOFT_AUTHENTICATION_PACKAGE_V1_0\r\nLogon Account:\tAdministrator\r\nSource Workstation:\tALIENVAULT\r\nError Code:\t0x0|17507786|Microsoft-Windows-Security-Auditing|20170410111356.914996-000|(null)</code> </pre> <br>  <b>2) Account Name: &lt;username&gt;</b> <br>  An example of a "raw" event, as OSSIM sees it: <br><br><pre> <code class="bash hljs">nsrv_WinSRV-DC.domain.test|4672|Security|Special privileges assigned to new logon.\r\n\r\nSubject:\r\n\tSecurity ID:\t\tS-1-5-21-2827692199-2880599349-568663292-500\r\n\tAccount Name:\t\tAdministrator\r\n\tAccount Domain:\t\tDOMAIN\r\n\tLogon ID:\t\t0x2B9EB90D\r\n\r\nPrivileges:\t\tSeSecurityPrivilege\r\n\t\t\tSeBackupPrivilege\r\n\t\t\tSeRestorePrivilege\r\n\t\t\tSeTakeOwnershipPrivilege\r\n\t\t\tSeDebugPrivilege\r\n\t\t\tSeSystemEnvironmentPrivilege\r\n\t\t\tSeLoadDriverPrivilege\r\n\t\t\tSeImpersonatePrivilege\r\n\t\t\tSeEnableDelegationPrivilege|17507787|Microsoft-Windows-Security-Auditing|20170410111356.914996-000|(null)</code> </pre> <br>  Thus, we need a function that can get the user name from both of these structures.  Functions that are used in plugins should be written in python 2.7 and stored in a separate file, the path to which will be written in a special variable in the configuration of the plug-in. <br><br>  Please note that in the "raw" log \ r, \ t, \ n are all special characters, i.e.  carriage return, newline and tab. <br><br>  For files that store functions there is a special daddy - / etc / ossim / agent / plugins / custom_functions.  The function file for obtaining additional information from the WMI log is named ‚Äúwmi_funcs.cfg‚Äù. <br><br>  Here are its contents: <br><br><pre> <code class="bash hljs">Start Function win_account import re def win_account(self, input=<span class="hljs-string"><span class="hljs-string">''</span></span>): try: try: res = re.search( <span class="hljs-string"><span class="hljs-string">'Logon Account:[^\w]t(\S+)[^\w]r[^\w]'</span></span>, input ).group(1) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> res except: res = re.findall( <span class="hljs-string"><span class="hljs-string">'Account Name:[^\w]t[^\w]t(\S+)[^\w]r[^\w]'</span></span>, input ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(res) &gt; 1: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> res[1] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> res[0] except: <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> None End Function</code> </pre> <br>  The body of the function must necessarily be enclosed in the tags "Start Function" and "End Function".  Also, if you need to import additional python modules, as in my case, import must also be written before the function body itself. <br><br>  Here you should especially pay attention to the moment that to designate special characters from the ‚Äúraw‚Äù log ‚Äú\ r‚Äù, ‚Äù\ n‚Äù, ‚Äù\ t‚Äù you need to use the construct [^ \ w] r, [^ \ w] n and [ ^ \ w] t respectively.  Those.  the symbol "\" from the "raw" message in our regular expression (namely, using regular expressions, we obtain the data by this function) is represented as "[^ \ w]".  This solution was found by trial and error.  No other constructions, including ‚Äú. *‚Äù, ‚Äú\ S +‚Äù, shielding with slashes and others, could not cope with ‚Äú\‚Äù in the raw log. <br><br>  As can be seen from the function, if there are several ‚ÄúAccount Name‚Äù constructions in one message (and this happens, for example, in events of changing one UZ of a user of another UZ), it (function) takes the second value as a user name.  Because the first is the name of the user who changed the target UZ. <br><br>  Next, at the end of the [config] section of the plugin configuration file ‚Äú/etc/ossim/agent/plugins/wmi-security-logger.cfg‚Äù we add a parameter that refers to the function file: <br>  custom_functions_file = / etc / ossim / agent / plugins / custom_functions / wmi_funcs.cfg <br><br>  And in the [cmd] section we add a parameter that uses a custom function to get data about the user's UZ.  In general, it looks like this: <br><br><pre> <code class="bash hljs">&lt;   OSSIM&gt;={:&lt; &gt;($&lt; ,   WQL&gt;)}</code> </pre> <br>  And in my particular case it looks like this: <br><br><pre> <code class="bash hljs">username={:win_account(<span class="hljs-variable"><span class="hljs-variable">$3</span></span>)}</code> </pre> <br>  As a result, the plugin configuration file will look like this: <br><br><pre> <code class="bash hljs">[DEFAULT] plugin_id=1518 [config] <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=detector <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>=yes <span class="hljs-built_in"><span class="hljs-built_in">source</span></span>=wmi credentials_file=/etc/ossim/agent/wmi_credentials.csv sleep=10 process= start=no stop=no custom_functions_file=/etc/ossim/agent/plugins/custom_functions/wmi_funcs.cfg [start_cmd] cmd=wmic -U OSS_WMI_USER%OSS_WMI_PASS //OSS_WMI_HOST <span class="hljs-string"><span class="hljs-string">"Select LogFile,RecordNumber from Win32_NTLogEvent Where Logfile = 'Security'"</span></span> | head -n 3 | tail -n 1 | cut -f 2 -d \| regexp= [cmd] cmd = wmic -U OSS_WMI_USER%OSS_WMI_PASS //OSS_WMI_HOST <span class="hljs-string"><span class="hljs-string">"Select ComputerName,EventCode,Logfile,Message,RecordNumber,SourceName,TimeWritten,User from Win32_NTLogEvent Where Logfile = 'Security' and RecordNumber &gt; OSS_COUNTER"</span></span> | cat start_regexp=^([^\|]+)\|(\d+)\|([^\|]+)\| regexp=<span class="hljs-string"><span class="hljs-string">"^(?P&lt;system_name&gt;[^\|]+)\|(?P&lt;plugin_sid&gt;\d+)\|(?P&lt;logfile&gt;[^\|]+)\|(?P&lt;message&gt;[^\|]+)\|(?P&lt;recordnumber&gt;[^\|]+)\|(?P&lt;sourcename&gt;[^\|]+)\|(?P&lt;timewritten&gt;[^\|]+)\|(?P&lt;username&gt;.*)$"</span></span> src_ip={resolv(<span class="hljs-variable"><span class="hljs-variable">$0</span></span>)} plugin_sid={<span class="hljs-variable"><span class="hljs-variable">$1</span></span>} userdata2={<span class="hljs-variable"><span class="hljs-variable">$2</span></span>} userdata3={<span class="hljs-variable"><span class="hljs-variable">$3</span></span>} userdata4={<span class="hljs-variable"><span class="hljs-variable">$4</span></span>} userdata5={<span class="hljs-variable"><span class="hljs-variable">$5</span></span>} userdata6={<span class="hljs-variable"><span class="hljs-variable">$6</span></span>} username={:win_account(<span class="hljs-variable"><span class="hljs-variable">$3</span></span>)}</code> </pre> <br><h3>  <b>2. Diagnose and troubleshoot WMI plugin</b> </h3><br>  To diagnose the operation of the plugin, you must perform the following steps: <br><br>  <b>1) Test WMI by running the wmic client from the console of the OSSIM server.</b> <br>  The arguments with which wmic needs to be run can be taken from the same plugin configuration file. <br><br>  For example: <br><br><pre> <code class="bash hljs">wmic -U domain\Administrator%Passw0rd //server.example.com <span class="hljs-string"><span class="hljs-string">"Select LogFile,RecordNumber from Win32_NTLogEvent Where Logfile = 'Security'"</span></span></code> </pre> <br>  The result of the successful execution of this command should be a list of numeric event identifiers from the Windows log. <br><br>  If errors appear, then it is necessary to check that the UZ is configured correctly and has all the necessary rights to receive the event logs of the target system.  If there is a firewall between the OSSIM server and the target system, you also need to make sure that it passes OSSIM ‚Üí Windows traffic in the opposite direction. <br><br>  <b>2) Restart the OSSIM plugin.</b> <br>  First stop the plugin: <br><br><pre> <code class="bash hljs">/etc/init.d/ossim-agent stop</code> </pre> <br>  Then kill all the wmi client processes that are still hanging: <br><br><pre> <code class="bash hljs">ps ‚Äìef |grep wmi</code> </pre> <br>  And in turn: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -9 ‚Äú ‚Äù</code> </pre> <br>  After this, start the agent: <br><br><pre> <code class="bash hljs">/etc/init.d/ossim-agent start</code> </pre> <br>  <b>3) Clean the target system log.</b> <br>  On highly loaded servers, such as domain controllers with a large number of users, the event log can grow very large, taking up hundreds of megabytes.  In my practice I ran into the fact that on such volumes of event logs WMI plugin starts to receive events with significant delays in time.  The only recommendation here is to set a log size limit on the target system.  It is desirable if it will be no more than 30 MB. <br><br>  In the lab, often the WMI plugin started working only after the big security log was completely empty. </div><p>Source: <a href="https://habr.com/ru/post/326208/">https://habr.com/ru/post/326208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326194/index.html">django-tables2. Manual</a></li>
<li><a href="../326196/index.html">One task about cactus graph</a></li>
<li><a href="../326198/index.html">Sathurbot: Distributed Attack to WordPress Sites</a></li>
<li><a href="../326204/index.html">Millions of queries per second: a peaceful battle between PostgreSQL and MySQL with today's workload requirements</a></li>
<li><a href="../326206/index.html">10 ways to stand out from the crowd of faceless competitor outsourcers (with examples)</a></li>
<li><a href="../326210/index.html">Startup School 2017 from Y Combinator: ‚ÄúWhy?‚Äù (Part two)</a></li>
<li><a href="../326212/index.html">Cloud-AI - cloud artificial intelligence found 10 LinkedIn vulnerabilities</a></li>
<li><a href="../326214/index.html">Why mobile pre-order is more than just payment technology.</a></li>
<li><a href="../326216/index.html">Tarantool as the main data storage for server applications written in .NET</a></li>
<li><a href="../326218/index.html">SMS history: how to transfer text via voice channel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>