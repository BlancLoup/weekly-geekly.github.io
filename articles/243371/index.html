<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Let's talk about the differences Mono from MS.NET</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Every day, cross-platform development for .NET is becoming more real. And after the recent announcement of official support for Linux / MacOS, the hap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Let's talk about the differences Mono from MS.NET</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c51/2f0/34a/c512f034aa944f679e90a60b9427c1d9.png"><br><br>  Every day, cross-platform development for .NET is becoming more real.  And after the recent <a href="http://blogs.msdn.com/b/dotnet/archive/2014/11/12/net-core-is-open-source.aspx">announcement of</a> official support for Linux / MacOS, the happy future has become a little closer.  The above picture has lost its former relevance, because the source will now be under MIT.  However, it is possible to write cross-platform .NET-applications for a long time - Mono helps us in this.  But the attitude towards him in the community is rather ambiguous.  I often have to hear sayings like ‚ÄúMono tupit, everything works three times slower for him‚Äù or ‚ÄúUnder Mono, nothing runs normally.‚Äù  Moreover, it is very rare to hear specific facts from these people.  The questions ‚ÄúWhat specifically tupit?‚Äù Or ‚ÄúWhat specifically does not work?‚Äù Plunge them into a stupor.  Not all (some are capable of constructive discussion), but most.  Most often start angered answers in the spirit of ‚ÄúYes, nothing works at all!  And if it works, then very slowly! ‚Äù  At the end of the conversation, it seems that each final machine command under Mono runs several times slower, and in half of the sources there are <code>throw new Exception()</code> . <br><br>  In this post I would like to share my experience a little bit.  Not so long ago, we ported our product <a href="http://passportvision.ru/">PassportVision</a> ( <a href="http://habrahabr.ru/company/enterra/blog/219535/">announcement on Habr√©</a> ) under Linux.  I can say that it works quite normally.  Yes, a bit slower than under Windows on the classic .NET from Microsoft (hereinafter referred to as MS.NET).  But it works quite stably, but the drop in performance is not fundamental.  At the same time, our product is quite large and quite falls under the category of enterprise, and we use the capabilities of C # /. NET to the fullest.  So it‚Äôs really possible to start a large server application for .NET - there would be a desire.  I also had the opportunity to talk with different developers who write something for Mono - most of the stories are successful. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But why, then, is there so much negativity towards Mono?  I consider that a problem that people not especially want to understand a difference between rantayma.  We once launched a .NET application for Linux on Mono 2.4, but it did not start right away - everything, Mono is completely bad, we will not use it.  But in the end, the fault is a single method, whose implementation is slightly different from MS.NET.  New versions of Mono come out every couple of months, the implementation has long been fixed, but people still continue to walk and find fault with poor Mono, not wanting to understand the details. <br><br>  Today I will give a few examples of how different runtime may differ. <a name="habracut"></a>  Of course, it‚Äôs impossible to bring all the differences - you can write a whole book about it.  Yes, and supercool problems from the production-code, too, will not work, it is often too difficult to separate them from the context of the software architecture and bring in the form of a small clear piece of code.  My current task is to simply convey the idea of ‚Äã‚Äãwhat may differ in Mono and MS.NET.  I hope this helps beginner Mono programmers to take a broader look at the problems that arise and begin to deal with them, instead of turning around and leaving with the words "Mono is stupid." <br><br><h3>  Example 1. Different versions of the compiler </h3><br>  Let's start with a very simple example.  Suppose we have some C # program, and we want to compile it.  As we know, the standard compiler simply translates our C # code into the corresponding IL code and arranges it as an assembly.  Moreover, the translation process does not include any particularly clever optimization, because JIT is responsible for them.  The translation is quite simple, and an experienced .NET developer can often think about which IL teams will be in the end.  But for some reason, many developers are confident that this process is <i>unambiguous</i> .  I had some fairly heated discussions in which they tried to prove to me that ‚Äúthere is exactly one way to display the source program in IL‚Äù.  Usually, people motivate this with the remarkable argument <i>‚ÄúThere are specifications!‚Äù</i> .  I want to assure you that a lot of useful information has been written in the specifications, but nothing is said about the only option for broadcasting an arbitrary program.  Moreover, in different versions of the compiler, the translation logic may differ.  I picked up a very simple example that illustrates this.  Consider the following code: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> numbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> };</code> </pre><br>  In Mono 2.10+ and MS.NET, we will see something like the following: <br><br><pre> <code class="hljs kotlin">IL_0000: ldc.i4.3 IL_0001: newarr [mscorlib]System.Int32 IL_0006: dup IL_0007: ldtoken field valuetype <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{de495e46-bf42-4605-a020-39ddddfe413c}'</span></span>/<span class="hljs-string"><span class="hljs-string">'$ArrayType=12'</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;PrivateImplementationDetails&gt;{de495e46-bf42-4605-a020-39ddddfe413c}'</span></span>::<span class="hljs-string"><span class="hljs-string">'$field-0'</span></span> IL_000c: call void <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mscorlib</span></span></span><span class="hljs-class">]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">System</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runtime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilerServices</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RuntimeHelpers</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">:InitializeArray</span></span></span></span>(<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> [</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mscorlib</span></span></span><span class="hljs-class">]</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">System</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Array</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">valuetype [mscorlib]System.RuntimeFieldHandle) IL_0011: stloc.0 // ... .field assembly static valuetype '</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PrivateImplementationDetails</span></span></span><span class="hljs-class">&gt;</span></span>{de495e46-bf42-<span class="hljs-number"><span class="hljs-number">4605</span></span>-a020-<span class="hljs-number"><span class="hljs-number">39</span></span>ddddfe413c}<span class="hljs-string"><span class="hljs-string">'/'</span></span>$ArrayType=<span class="hljs-number"><span class="hljs-number">12</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span>$field-<span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-string"><span class="hljs-string">' at D_00004000 // ... .data D_00004000 = bytearray ( 01 00 00 00 02 00 00 00 03 00 00 00) // size: 12</span></span></code> </pre><br>  As you can see from the example, the values ‚Äã‚Äãof the source elements are stored in a special byte array.  But at the time of Mono 2.4.4 (you may not believe it, but to this day there are people who use it) the translator was not so smart: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0000</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0001</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">newarr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[mscorlib]</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Int32</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0006</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0007</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0008</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0009</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">stelem</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000a</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000b</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000c</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000d</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">stelem</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000e</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">dup</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_000f</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0010</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ldc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0011</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">stelem</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.i4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IL_0012</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">stloc</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span></code> </pre><br>  In fact, the following happens here: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> numbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[<span class="hljs-number"><span class="hljs-number">3</span></span>]; numbers[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">1</span></span>; numbers[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">2</span></span>; numbers[<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre><br>  Functionally, nothing has changed, but now we have the realization that different versions of the compiler can produce different code.  But this example is not so interesting, since the behavior of the code remains the same (except for a small performance drop for older versions of Mono).  Let's move on to more interesting examples. <br><br><h3>  Example 2. Differences in working with IL </h3><br>  Practice shows that a simple "trivial" code works about the same as under MS.NET, and under Mono.  And the problems most often start when not so trivial things appear in the code.  Not so long ago, John Skit wrote a wonderful post <a href="http://codeblog.jonskeet.uk/2014/11/07/when-is-a-string-not-a-string/">‚ÄúWhen is a string not a string?‚Äù</a> ( <a href="http://habrahabr.ru/post/243523/">Russian translation</a> from <a href="https://habrahabr.ru/users/impwx/" class="user_link">impwx</a> ).  In short, the content of the post is reduced to the consideration of the following example: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">Description(Value)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Test</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value = <span class="hljs-string"><span class="hljs-string">"X\ud800Y"</span></span>; }</code> </pre><br>  A string in C # is a sequence of words in UTF-16.  And the value of <code>"X\ud800Y"</code> not particularly good, because  includes the <code>0xD800</code> word of the surrogate pair <code>0xD800</code> , after which the lower word would have to go (interval <code>0xDC00..0xDFFF</code> ), but instead of it comes <code>Y</code> ( <code>0x0059</code> ).  The problems begin because IL code uses UTF-8 to store the arguments of the attribute constructor.  However, at John Skit everything is very well written, I advise everyone to read the original post. <br><br>  I was interested in how MS.NET and Mono will behave in this difficult situation ( <a href="http://aakinshin.blogspot.com/2014/11/mono-utf8-conversions.html">detailed note</a> ).  And they will behave in different ways.  The first difference can be seen at compile time.  MS.NET will put the value of the string in the metadata in the form of <code>58 ED A0 80 59</code> , and Mono in the form of <code>58 59 BF BD 00</code> (both values ‚Äã‚Äãare non-valid UTF-8 lines).  The second difference can be observed by running the received applications.  MS.NET will be able to run both versions and successfully retrieve the value of the attribute argument (in the form <code>0058 fffd fffd 0059</code> and <code>0058 0059 fffd fffd 0000</code> respectively), and Mono will choke with such an invalid line and return <code>null</code> in each of the cases.  Because of this, a small example of John Skit fell immediately when I tried to run it under Mono. <br><br>  The problems lie in different implementations of converting strings between encodings.  I like this example because, with its minimalist character, it shows that MS.NET and Mono can both form different IL code when compiled, and work differently with it when the application starts. <br><br><h3>  Example 3. Mono bugs </h3><br>  Yes, there are <a href="http://www.mono-project.com/community/bugs/">bugs</a> in Mono.  And yes, they are not very few, you have to live with it.  Fortunately, it is not often necessary to fall for them, and from open bugs there are not so many critical ones.  I'll tell you one story: when porting PassportVision to Mono, I came across one not very pleasant moment.  I had to deal with code generation and create a part of logic on the fly depending on a number of conditions.  I created new types through <a href="http://msdn.microsoft.com/library/system.reflection.emit.typebuilder.aspx">TypeBuilder</a> , and these types implemented certain interfaces.  I learned <i>a lot</i> about <i>new</i> code generation in Mono, but most of them are very difficult to briefly tell apart from the context.  But one bug was reproduced very easily: the <code>TypeBuilder.CreateType()</code> method did not check the scope of the declared interfaces.  I.e. code <br><br><pre> <code class="hljs coffeescript">private interface IFoo {} <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ... void Main() { var assemblyBuilder = Thread.GetDomain().DefineDynamicAssembly( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AssemblyName(<span class="hljs-string"><span class="hljs-string">"FooAssembly"</span></span>), AssemblyBuilderAccess.Run); var moduleBuilder = assemblyBuilder.DefineDynamicModule(<span class="hljs-string"><span class="hljs-string">"FooAssembly"</span></span>); TypeBuilder typeBuilder = moduleBuilder.DefineType(<span class="hljs-string"><span class="hljs-string">"Foo"</span></span>, TypeAttributes.Public, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(object), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IFoo) }); typeBuilder.CreateType(); }</code> </pre><br>  fell under MS.NET (as it should be), but it worked fine under Mono.  This situation did not suit me very much, so I went and started a <a href="https://bugzilla.xamarin.com/show_bug.cgi%3Fid%3D22059">bug</a> .  We must pay tribute to the guys from Xamarin - they <a href="https://github.com/mono/mono/commit/68e5cc395fd19366ed8e421f2f329fcf91d2b0b0">corrected</a> him after 5 days.  If you use Mono 3.8.0 (which was released in August), then you still have this bug, but Mono 3.10.0 <a href="http://www.mono-project.com/docs/about-mono/releases/3.10.0/">came out with a fix</a> . <br><br>  This problem is not particularly critical, but it still gave me a number of inconveniences.  But in the bug tracker still hangs <a href="https://bugzilla.xamarin.com/buglist.cgi%3Fquery_format%3Dspecific%26order%3Drelevance%2Bdesc%26bug_status%3D__open__%26product%3D%26content%3D">about 5,000</a> open problems.  Therefore, you need to keep in mind that certain errors in Mono can be and that from version to version the behavior of some minor moments may change (perhaps because of my bug report someone has stopped working after the update).  If possible, it is better to sit under the latest stable version of Mono. <br><br><h3>  Example 4. .NET bugs </h3><br>  After such conversations, they usually begin to fly stones in the direction of Mono: they say that it is bad, there are bugs in it.  And somehow they forget that Microsoft bugs do too.  The following story cost a certain number of nerve cells to one friend of mine.  After the next commit, the build server reported that the tests had dropped.  And on the working machine, they passed on excellent, but on the build server they fell.  I‚Äôll leave out a fascinating description of how the search for bugs occurred, and I‚Äôll get to the point: there were different versions of the .NET Framework on the build server and the host machine: 4.0 and 4.5.  And the bug itself was that the line <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"http://localhost/%2F1"</span></span>).AbsoluteUri</code> </pre><br>  produces a different result depending on TargetFramework ( <a href="http://aakinshin.blogspot.ru/2014/11/dotnet-uri-slash-escape.html">detailed note</a> ).  In 4.0, there was a <a href="https://connect.microsoft.com/VisualStudio/feedback/details/511010/erroneous-uri-parsing-for-encoded-reserved-characters-according-to-rfc-3986">bug</a> with slash escaping (aka <code>%2F</code> ): this line returned <code>http://localhost//1</code> .  In 4.5, the bug was corrected in accordance with <a href="http://tools.ietf.org/html/rfc3986">RFC 3986</a> , the new result is <code>http://localhost/%2F1</code> . <br><br>  And what about Mono?  And there was a similar <a href="https://bugzilla.xamarin.com/show_bug.cgi%3Fid%3D16960">bug</a> that was <a href="https://github.com/mono/mono/commit/1f1dc988ad7b165603a1175bf0a92156c4372c43">corrected</a> in August (the fix is ‚Äã‚Äãincluded in Mono 3.10.0).  This example teaches us that the same problems may arise in different implementations of .NET and be corrected with new versions.  A truly cross-platform application must either not use the platform-specific functionality that changes from version to version, or use it very wisely in order to remain efficient under various runtimes. <br><br><h3>  Example 5. Implementation of standard classes </h3><br>  I will give one more instructive story.  The guys from one good company once decided to use structures as keys for hash tables.  Nothing foreshadowed trouble, the application worked fine.  Slightly slowed down, but not so that straight is too critical.  And then one day the guys decided to launch their application under Mono.  And lo and behold: it began to work many times faster.  ‚ÄúOh, what a good Mono, how quickly everything works under it,‚Äù the guys were delighted.  The only thing that did not give rest was the thought that it should not be so, that somewhere there was something wrong. <br><br>  To understand this example, you need to read a little about the implementation of GetHashCode structures in MS.NET ( <a href="http://habrahabr.ru/post/188038/">good habrapost</a> ).  In short, there are two versions for the hash function: one for structures without reference fields and free space between the fields, and the other for all others.  As the thoughtful reader could guess, our guys were not doing well with the key structure (namely, there were ‚Äúholes‚Äù between the fields; no one bothered to prescribe an explicit GetHashCode ()).  And in this case, the second version of the hash function is used, which is based on the first field of the structure.  Consider an example: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>); Console.WriteLine(a1.GetHashCode() == a2.GetHashCode()); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>); Console.WriteLine(b1.GetHashCode() == b2.GetHashCode());</code> </pre><br>  This code will print <code>False True</code> under MS.NET.  The hashes <code>a1</code> and <code>a2</code> will be different (they will be calculated on the basis of all the fields), and the hashes for <code>b1</code> and <code>b2</code> will coincide (they will be considered only on the basis of the first field).  Mono developers decided not to bother with a bunch of different versions of the hash function: they wrote one that works on the basis of all the fields (see <a href="">GetHashCode</a> and <a href="">InternalGetHashCode</a> ).  Accordingly, the above code will print <code>False False</code> under Mono, because all the hashes will be different. <br><br>  Let's go back to our funny guys with a hash table.  If you look at the situation from the right angle, their application did not fly under Mono, but slowed down under MS.NET.  And it slowed down because so many keys had the same hash due to the coinciding first field.  It would seem a trifle, but it had a rather strong effect on performance. <br><br>  You know, when I start telling someone about the .NET internals, I am often reproached with the phrases ‚ÄúWhy should I know all this?  Such details of internal implementations <i>will never</i> be useful in real life. ‚Äù  And I answer: "Well, well, of course, no one will ever come in handy." <br><br><h3>  .NEXT </h3><br>  I can persecute such stories for a very long time, but in this post I just wanted to identify common issues and get people to think again.  Think about the fact that we live in a complex world in which your C # program may work differently depending on the environment.  The difference in behavior rests on very specific things that can be sorted out and ensure that the .NET application works quickly and stably for different platforms. <br><br>  If you want to listen to more funny stories, then come to my report at the <a href="http://dotnext.ru/%3Futm_source%3Dhabr%26utm_medium%3Dblog%26utm_term%3Dhabrapost20141118_akinshin%26utm_campaign%3Ddotnext2014moscow">.NEXT</a> conference (December 8, 2014, Moscow, Radisson Slavyanskaya).  I will continue to discuss the topic of different platforms, talk about the features of Mono for working with memory and the differences in the implementations of JIT compilers.  And I will wander around the site all day, so I can be caught and talked about .NET. <br><br>  I also hope that Habrazhiteley has enough funny stories.  I will be glad to hear them =) </div><p>Source: <a href="https://habr.com/ru/post/243371/">https://habr.com/ru/post/243371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243361/index.html">Yii2 test on HHVM</a></li>
<li><a href="../243363/index.html">Animations using the Transitions API</a></li>
<li><a href="../243365/index.html">Digest of grocery design, August-October 2014</a></li>
<li><a href="../243367/index.html">The digest of interesting news and materials from the world of PHP No. 51 (October 26 - November 16, 2014)</a></li>
<li><a href="../243369/index.html">Interlight Moscow 2014 - what's new in coverage?</a></li>
<li><a href="../243373/index.html">Auto-positioning and autotracing of printed circuit boards</a></li>
<li><a href="../243377/index.html">We invite you to participate in Security Meet Up December 4</a></li>
<li><a href="../243379/index.html">Zabbix + Communigate Pro: low-level discovery and account monitoring</a></li>
<li><a href="../243381/index.html">Work in the office VS Work in coworking for a small team</a></li>
<li><a href="../243383/index.html">How to send push notifications to the Windows Universal app</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>