<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring the automatic assembly of the project Unity3d in Gitlab CI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Update 02/17/2019 - This article is out of date. To use it in 2019 is not worth it. 

 Why do you need to automatically build the project does not nee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring the automatic assembly of the project Unity3d in Gitlab CI</h1><div class="post__text post__text-html js-mediator-article">  Update 02/17/2019 - This article is out of date.  To use it in 2019 is not worth it. <br><br>  Why do you need to automatically build the project does not need to explain to anyone. <br>  In the case of assembling projects for Unity, this is especially true, since an average project, for example, for WebGL, is assembled on a working machine for 5-7 minutes, completely closing it. <br><br>  Not so long ago, the Unity version for Linux was released, which made it possible in principle to configure automatic build using Gitlab CI (which is based on docker images). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I want to share my experience with this setup. <br><a name="habracut"></a><br><h3>  Part one - we collect a docker image with Unity </h3><br>  We will need a docker image that contains Unity. <br><br>  Below I will attach the finished docker file. <br>  But first, a few comments, from which it should be clear why there is such an exotic thing in a dockerfile as gnome or tightvncserver. <br><br>  So, the main problem when using the docker image with the ‚Äúhead-on‚Äù unit: after installation, manual activation is required.  Moreover, activation works only in graphical mode.  Fortunately, you only need to do this once. <br><br>  Therefore, the plan is: <br><br><ul><li>  We collect the image with Unity containing the graphic environment and the VNC server </li><li>  We start from it the container </li><li>  Connect to the VNC server </li><li>  Launch Unity manually and activate it. </li><li>  Save the container to the new image, which will contain an activated copy of the unity </li></ul><br>  Below is my docker file.  He collects the image for unity5.6 <br>  I do not change the version of Unity to a newer one, because I myself checked everything with this version. <br>  But you can try to replace <br>  <a href="">beta.unity3d.com/download/6a86e542cf5c/unity-editor_amd64-5.6.1xf1Linux.deb</a> <br>  to another version. <br><br>  The current list can be found <a href="https://forum.unity3d.com/threads/unity-on-linux-release-notes-and-known-issues.350256/">here</a> : <br><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre><code class="plaintext hljs">FROM ubuntu:16.04 RUN apt-get update -qq RUN env DEBIAN_FRONTEND=noninteractive apt-get -qq install -y ffmpeg ubuntu-desktop gnome-panel gnome-settings-daemon metacity nautilus gnome-terminal --no-install-recommends curl gconf-service lib32gcc1 lib32stdc++6 libasound2 libc6 libc6-i386 libcairo2 libcap2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libfreetype6 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libgl1-mesa-glx libglib2.0-0 libglu1-mesa libgtk2.0-0 libnspr4 libnss3 libpango1.0-0 libstdc++6 libx11-6 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxtst6 zlib1g debconf npm xdg-utils lsb-release libpq5 xvfb git vim xrdp tightvncserver \ &amp;&amp; rm -rf /var/lib/apt/lists/* &amp;&amp; apt-get purge RUN echo "Downloading Unity3D installer...." \ &amp;&amp; mkdir /app \ &amp;&amp; curl -o /app/unity_editor.deb "http://beta.unity3d.com/download/6a86e542cf5c/unity-editor_amd64-5.6.1xf1Linux.deb" \ &amp;&amp; echo "Unity3D installer downloaded." \ # To make a "min" version of this image build, omit this dpkg line. It saves a lot of space, but you'll need to dpkg it yourself when you use the image. &amp;&amp; dpkg -i /app/unity_editor.deb &amp;&amp; ln -s /opt/Unity/Editor/Unity /usr/local/bin/unity &amp;&amp; rm -rf /app RUN mkdir -p .vnc .cache/unity3d .local/share/unity3d ENV USER root ADD xstartup /root/.vnc/xstartup COPY runUnity.sh /root RUN chmod 755 /root/.vnc/xstartup &amp;&amp; chmod 755 /root/runUnity.sh &amp;&amp; sed -i -e 's/\r//g' /root/.vnc/xstartup &amp;&amp; sed -i -e 's/\r//g' /root/runUnity.sh # VNC EXPOSE 5901 ENTRYPOINT ["bash"]</code> </pre> </div></div><br>  And here are two scripts that are used by this dokerfile: <br><br><div class="spoiler">  <b class="spoiler_title">xstartup</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh export XKL_XMODMAP_DISABLE=1 unset SESSION_MANAGER unset DBUS_SESSION_BUS_ADDRESS [ -x /etc/vnc/xstartup ] &amp;&amp; exec /etc/vnc/xstartup [ -r $HOME/.Xresources ] &amp;&amp; xrdb $HOME/.Xresources xsetroot -solid grey vncconfig -iconic &amp; gnome-panel &amp; gnome-settings-daemon &amp; metacity &amp; nautilus &amp; gnome-terminal &amp;</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">runUnity.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh xvfb-run --server-args="-screen 0 1024x768x24" /opt/Unity/Editor/Unity -batchmode -logfile -force-opengl -quit -projectPath /project -executeMethod WebGLBuilder.build</span></span></code> </pre></div></div><br><h4>  Step 1 </h4><br>  We put these three files in one directory. <br><br><h4>  Step 2 </h4><br>  We collect a docker image (it will contain a non-activated copy of Unity) <br>  I did this: <br><br><pre> <code class="bash hljs">docker build -t softaria/unity3d .</code> </pre> <br><h4>  Step 3 </h4><br>  We start the container from this image: <br><br><pre> <code class="bash hljs">docker run --privileged --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>-add=SYS_ADMIN -ti -p <span class="hljs-string"><span class="hljs-string">"5901:5901"</span></span> --entrypoint=bash softaria/unity3d</code> </pre> <br>  We need the port to reach the VNC server. <br><br>  Why do I need privileges, I do not remember, but without them it does not work.  We specify bash as the entrypoint to go directly to the running container. <br><br><h4>  Step 4 </h4><br>  Now inside the container you need to start the vnc server: <br><br><pre> <code class="bash hljs">vncserver :1</code> </pre> <br>  It will ask for a password.  Ok - we come up with. <br><br><img width="800" src="https://habrastorage.org/web/ecc/c40/81e/eccc4081ebaf4fcd92e66ec36c116528.JPG"><br><br>  As can be seen in the screenshot, the server writes the path to its log file. <br>  You can look at this log to make sure that gnome has started (however, you can not look). <br><br><h4>  Step 5 </h4><br>  Now we need a VNC client.  Any. <br>  For example, this <a href="https://www.realvnc.com/download/viewer/">one</a> <br><br>  Go to your server (you must specify IP + port) for example: <br><br>  123.123.133.123:5901 <br><br>  The port will be exactly 5901. But the IP is yours. <br><br><h4>  Step 6 </h4><br>  Run through the gnome Unity menu <br>  Login and activate the license. <br><br><img width="600" src="https://habrastorage.org/web/cf6/336/93c/cf633693c7694a2fa34eae1a361a0e18.JPG"><br><br>  We leave <br><br><h4>  Step 7 </h4><br>  We stop vncserver (of course, inside the container docker - in the same place where it was launched) <br><br><pre> <code class="bash hljs">vncserver -<span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> :1</code> </pre> <br>  It should be made not to litter our future image with the activated Unity every unnecessary junk. <br><br><h4>  Step 8 </h4><br>  Now we open another terminal on the machine where the docker is running.  We need to save the new docker image from the running container. <br><br>  To do this, without leaving the container, in another terminal we find this container, simply by running docker ps and copying the id of this container. <br><br>  Next, save the container to a new image: <br><br><pre> <code class="bash hljs">docker commit {-} softaria/unity3d:licensed</code> </pre> <br>  Now we have a docker image with activated Unity. <br>  You can fill it in the registry. <br><br><h4>  Check the image </h4><br>  After this step, you should check the performance of the image outside of gitlab. <br><br>  You can do it like this: <br><br>  Let in / root / myProject are the sources of our project, which need to be collected. <br>  We know (or will find out now) that to build from the command line, you need to put a special class configuring the assembly in the project sources. <br><br>  Put it in the Assets / Editor <br><br>  Both the class and its method should be named exactly as in my example below (since these names were mentioned in our runUnity.sh script. Remember: ‚Äú- executeMethod WebGLBuilder.build‚Äù?) <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WebGLBuilder</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//        string[] scenes = { "Assets/main.unity" }; //  ‚Äî       ,  ‚Äî   (   WebGL,   None) BuildPipeline.BuildPlayer(scenes, "WebGL-Dist", BuildTarget.WebGL, BuildOptions.None); } }</span></span></code> </pre> <br>  Next, launch the container from our image like this: <br><br><pre> <code class="bash hljs">docker run --privileged --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>-add=SYS_ADMIN -v <span class="hljs-string"><span class="hljs-string">"/root/myProject:/project"</span></span> softaria/unity3d:licensed /root/runUnity.sh</code> </pre> <br>  And make sure the build works. <br><br>  If the build is working, go to the next item: <br><br><h3>  Part two.  Build the project in Gitlab.CI </h3><br>  Below I will give my .gitlab-ci.yml <br><br>  But first, a few comments again - why is it so <s>ugly</s> non-trivial. <br><br>  Attempting to build on the basis of the newly assembled image (softaria / unity3d: licenced) <br>  failed - an error occurred "/ usr / bin / sh: / usr / bin / sh: cannot execute binary file gitlab" <br>  I don‚Äôt remember the exact reasons for it, but it turned out to be a simple and working solution to use the standard image - docker, and to launch my image inside it. <br><br>  The second problem was the inability to transfer its source code into the container with Unity using volume.  Inside the gitlab, the volumes just didn't work.  Perhaps there is some kind of workaround here, but I was <s>too lazy to sort</s> it <s>out</s> easier to copy the sources into the container from the unit, and then take the result back. <br><br>  I do not pretend to the elegance of these decisions, but here you are <div class="spoiler">  <b class="spoiler_title">working build option:</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">stages: - build build: image: docker stage: build before_script: #     - docker login -u $CI_REGISTRY_USER -p $CI_BUILD_TOKEN $CI_REGISTRY script: #     - docker pull docker.softaria.com/games/unity:licensed #   ,      - docker create --name ${CI_BUILD_REF}_lines --privileged --cap-add=SYS_ADMIN --entrypoint=bash docker.softaria.com/games/unity:licensed /root/runUnity.sh #     - docker cp $(pwd) ${CI_BUILD_REF}_lines:/project #  - docker start -a -i ${CI_BUILD_REF}_lines #      - rm -rf nginx/client #       - docker cp ${CI_BUILD_REF}_lines:/project/WebGL-Dist/ nginx/client/ #       ‚Äî         nginx,             .      (     )    - . - docker build -t $CI_REGISTRY_IMAGE --build-arg build_name=$CI_PIPELINE_ID nginx - docker push $CI_REGISTRY_IMAGE after_script: - docker rm ${CI_BUILD_REF}_lines - docker logout $CI_REGISTRY tags: - docker artifacts: name: "${CI_BUILD_REF_NAME}_${CI_BUILD_REF}" expire_in: 2 weeks paths: - nginx/client only: - master</code> </pre></div></div><br>  That's all.  If you have any questions, I will try to answer in the comments. <br><br>  update from 09/25/2017 - Added ffmpeg to the unit image build.  Without it, there is no sound in games. <br></div><p>Source: <a href="https://habr.com/ru/post/335980/">https://habr.com/ru/post/335980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335968/index.html">Cloning the Lode Runner game from the first PC in the USSR "BK-0010" plus a few words about the programming of games in the late 80s</a></li>
<li><a href="../335970/index.html">We break haks completely. We read machine codes as an open book.</a></li>
<li><a href="../335972/index.html">Game model of behavior in the market of two competing firms in Python</a></li>
<li><a href="../335974/index.html">Labyrinth generation by Eller algorithm in Unity</a></li>
<li><a href="../335976/index.html">About website rejuvenation - decision criteria</a></li>
<li><a href="../335982/index.html">How to create a map with the voices of fans for the Olympics. Lecture in Yandex</a></li>
<li><a href="../335986/index.html">One secure password for all occasions</a></li>
<li><a href="../335988/index.html">Replace and Conquer - the SOLID approach to developing reusable components on the web</a></li>
<li><a href="../335990/index.html">The digest of interesting materials for the mobile developer # 217 (August 14 - August 20)</a></li>
<li><a href="../335992/index.html">Edge hates your attributes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>