<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Javascript Video Refactoring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My book on refactoring in 1999 began with a simple example of calculating and formatting a receipt for a video store. Modern JavaScript has several op...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Javascript Video Refactoring</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/612/696/646/612696646d2a45ee881f90b4acac0e8b.png" align="left">  <i>My <a href="https://martinfowler.com/books/refactoring.html">book on refactoring</a> in 1999 began with a simple example of calculating and formatting a receipt for a video store.</i>  <i>Modern JavaScript has several options for refactoring that code.</i>  <i>Here I will outline four of them: refactoring of top-level functions;</i>  <i>transition to a nested function with a dispatcher;</i>  <i>using classes;</i>  <i>transformation using an intermediate data structure.</i> <br><br>  Many years ago, when I was writing a <a href="https://martinfowler.com/books/refactoring.html">book on refactoring</a> , I started with a (very) simple example of refactoring code that calculated a bill for a client for renting video films (in those days we had to go to the salon for this).  I recently thought about this example, in particular, how it would look like in modern JavaScript. <br><br>  Any refactoring implies improving the code in a certain direction, in that which corresponds to the programming style of the development team.  The example in the book was in Java, and Java (at that time) meant a certain programming style, an object-oriented style.  However, with JavaScript, there are many more options to choose which style.  Although you can adhere to a Java-like object-oriented style, especially with ES6 (Ecmascript 2015), not all JavaScript supporters approve of this style.  Many people really think that using classes is Very Bad. <br><a name="habracut"></a><br><h1>  The initial code of the salon video rental </h1><br>  To continue the explanation, you need to show some code.  In this case, the JavaScript version of the original example, which I wrote at the end of the last century. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="java hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(customer, movies)</span></span></span><span class="hljs-function"> </span></span>{ let totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; let frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; let result = `Rental Record <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ${customer.name}\n`; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (let r of customer.rentals) { let movie = movies[r.movieID]; let thisAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// determine amount for each movie switch (movie.code) { case "regular": thisAmount = 2; if (r.days &gt; 2) { thisAmount += (r.days - 2) * 1.5; } break; case "new": thisAmount = r.days * 3; break; case "childrens": thisAmount = 1.5; if (r.days &gt; 3) { thisAmount += (r.days - 3) * 1.5; } break; } //add frequent renter points frequentRenterPoints++; // add bonus for a two day new release rental if(movie.code === "new" &amp;&amp; r.days &gt; 2) frequentRenterPoints++; //print figures for this rental result += `\t${movie.title}\t${thisAmount}\n` ; totalAmount += thisAmount; } // add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result; }</span></span></code> </pre> <br>  Here I am using ES6.  The code works on two data structures, both of which are simply lists of json entries.  The client record looks like this: <br><br><pre> <code class="java hljs">{ <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"martin"</span></span>, <span class="hljs-string"><span class="hljs-string">"rentals"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"movieID"</span></span>: <span class="hljs-string"><span class="hljs-string">"F001"</span></span>, <span class="hljs-string"><span class="hljs-string">"days"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>}, {<span class="hljs-string"><span class="hljs-string">"movieID"</span></span>: <span class="hljs-string"><span class="hljs-string">"F002"</span></span>, <span class="hljs-string"><span class="hljs-string">"days"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}, ] }</code> </pre> <br>  The structure of the movie list is as follows: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"F001"</span></span>: {<span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Ran"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"regular"</span></span>}, <span class="hljs-string"><span class="hljs-string">"F002"</span></span>: {<span class="hljs-string"><span class="hljs-string">"title"</span></span>: <span class="hljs-string"><span class="hljs-string">"Trois Couleurs: Bleu"</span></span>, <span class="hljs-string"><span class="hljs-string">"code"</span></span>: <span class="hljs-string"><span class="hljs-string">"regular"</span></span>}, <span class="hljs-comment"><span class="hljs-comment">// etc }</span></span></code> </pre>  <i><font color="gray">In the original book, films were simply represented as objects in the structure of Java objects.</font></i>  <i><font color="gray">For this article, I preferred to go to the json structure.</font></i>  <i><font color="gray">It is assumed that some kind of global search such as <a href="https://martinfowler.com/eaaCatalog/repository.html">Repository is</a> not suitable for this application.</font></i> <br><br>  The method produces a simple text message about the video rental. <br><br> <code>Rental Record for martin <br> Ran 3.5 <br> Trois Couleurs: Bleu 2 <br> Amount owed is 5.5 <br> You earned 2 frequent renter points</code> <br>  <i><font color="gray">This issue is pretty rough, even for an example.</font></i>  <i><font color="gray">How could I not even bother to properly format the numbers?</font></i>  <i><font color="gray">But remember that the book was written in the days of Java 1.1, before being added to the String format language.</font></i>  <i><font color="gray">This partially justifies my laziness.</font></i> <br><br>  The <code>statement</code> function smells like <a href="http://my.safaribooksonline.com/0-201-485672/ch03lev1sec2">Long Method</a> .  Only its size is already suspicious.  But one bad smell is not a reason for refactoring.  Badly factorized code is a problem because it is difficult to understand.  If the code is difficult to understand, then it is difficult to change to add new features or correct errors.  So if you don‚Äôt need to read or understand some code, then its bad structure doesn‚Äôt hurt you and you will be happy to leave it alone for a while.  Therefore, to arouse our interest in this code, there must be some reason for changing it.  Our reason, which I pointed out in the book, is to create an HTML version of the statement <code>statement</code> with something like this: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Rental Record for <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span>martin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>Ran<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>3.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>Trois Couleurs: Bleu<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Amount owed is <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span>5.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>You earned <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span>2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">em</span></span></span><span class="hljs-tag">&gt;</span></span> frequent renter points<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  As I noted earlier, in this article I study some ways to refactor code in order to simplify the addition of additional rendering options for output.  They all start in the same way: break one method into a set of functions, covering different parts of logic.  When I finish this partition, I‚Äôll explore four ways how these functions can be organized to support alternative rendering. <br><img src="https://habrastorage.org/getpro/habr/post_images/9a7/7c5/1f9/9a77c51f9f7b02e63bc3a2778a0c14e6.png"><br><br><h1>  Splitting into several functions </h1><br>  Every time I work with too long a function like this, my first thought is to try to break it up into logical pieces of code and make separate functions of them using the <a href="http://refactoring.com/catalog/extractMethod.html">Extract Method</a> . <a name="1_1"></a>  <a href="https://habr.com/ru/post/320280/">[1]</a> .  The first piece that caught my attention was the <code>switch</code> . <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> movie = movies[r.movieID]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> thisAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// determine amount for each movie switch (movie.code) { case "regular": thisAmount = 2; if (r.days &gt; 2) { thisAmount += (r.days - 2) * 1.5; } break; case "new": thisAmount = r.days * 3; break; case "childrens": thisAmount = 1.5; if (r.days &gt; 3) { thisAmount += (r.days - 3) * 1.5; } break; } //add frequent renter points frequentRenterPoints++; // add bonus for a two day new release rental if(movie.code === "new" &amp;&amp; r.days &gt; 2) frequentRenterPoints++; //print figures for this rental result += `\t${movie.title}\t${thisAmount}\n` ; totalAmount += thisAmount; } // add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result; }</span></span></code> </pre> <br>  My development environment (IntelliJ) offers itself to do refactoring automatically, but incorrectly conducts it - its abilities in JavaScript are not as advanced as in Java refactoring.  So I will do it manually.  You need to see what data this extract candidate uses.  There are three pieces of data: <br><br><ul><li>  The value of <code>thisAmount</code> calculated by the extracted code.  I can initiate it inside a function and return it at the end. </li><li>  The value of <code>r</code> for the number of days of rental is checked in a cycle, I can pass it as a parameter. </li><li>  The variable <code>movie</code> is a rented <code>movie</code> .  Temporary variables like this usually get in the way of refactoring procedural code, so I would prefer to run <a href="http://refactoring.com/catalog/replaceTempWithQuery.html">Replace Temp with Query first</a> to convert it into a function that I can call from any extracted code. </li></ul><br>  When I finish with <a href="http://refactoring.com/catalog/replaceTempWithQuery.html">Replace Temp with Query</a> , the code looks like this: <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> thisAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// determine amount for each movie switch (movieFor(r).code) { case "regular": thisAmount = 2; if (r.days &gt; 2) { thisAmount += (r.days - 2) * 1.5; } break; case "new": thisAmount = r.days * 3; break; case "childrens": thisAmount = 1.5; if (r.days &gt; 3) { thisAmount += (r.days - 3) * 1.5; } break; } //add frequent renter points frequentRenterPoints++; // add bonus for a two day new release rental if(movieFor(r).code === "new" &amp;&amp; r.days &gt; 2) frequentRenterPoints++; //print figures for this rental result += `\t${movieFor(r).title}\t${thisAmount}\n` ; totalAmount += thisAmount; } // add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result; function movieFor(rental) {return movies[rental.movieID];} }</span></span></code> </pre> <br>  Now extract the <code>switch</code> . <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> thisAmount = amountFor(r); <span class="hljs-comment"><span class="hljs-comment">//add frequent renter points frequentRenterPoints++; // add bonus for a two day new release rental if(movieFor(r).code === "new" &amp;&amp; r.days &gt; 2) frequentRenterPoints++; //print figures for this rental result += `\t${movieFor(r).title}\t${thisAmount}\n` ; totalAmount += thisAmount; } // add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result; function movieFor(rental) {return movies[rental.movieID];} function amountFor(r) { let thisAmount = 0; // determine amount for each movie switch (movieFor(r).code) { case "regular": thisAmount = 2; if (r.days &gt; 2) { thisAmount += (r.days - 2) * 1.5; } break; case "new": thisAmount = r.days * 3; break; case "childrens": thisAmount = 1.5; if (r.days &gt; 3) { thisAmount += (r.days - 3) * 1.5; } break; } return thisAmount; } }</span></span></code> </pre> <br>  Now look at the calculation of regular customer points.  Here you can perform the same extraction procedure. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> thisAmount = amountFor(r); frequentRenterPointsFor(r); <span class="hljs-comment"><span class="hljs-comment">//print figures for this rental result += `\t${movieFor(r).title}\t${thisAmount}\n` ; totalAmount += thisAmount; } // add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result; ‚Ä¶ function frequentRenterPointsFor(r) { //add frequent renter points frequentRenterPoints++; // add bonus for a two day new release rental if (movieFor(r).code === "new" &amp;&amp; r.days &gt; 2) frequentRenterPoints++; }</span></span></code> </pre> <br>  Although I learned the function, I don‚Äôt like how it works by updating the variable of the parent area.  Such side effects make the code difficult, so I will change it to take away these side effects. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> thisAmount = amountFor(r); frequentRenterPoints += frequentRenterPointsFor(r); <span class="hljs-comment"><span class="hljs-comment">//print figures for this rental result += `\t${movieFor(r).title}\t${thisAmount}\n` ; totalAmount += thisAmount; } // add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result; ‚Ä¶ function frequentRenterPointsFor(r) { let result = 1; if (movieFor(r).code === "new" &amp;&amp; r.days &gt; 2) result++; return result; }</span></span></code> </pre> <br>  I will use the chance to slightly clean the two extracted functions while I understand them. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (movieFor(rental).code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"regular"</span></span>: result = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"new"</span></span>: result = rental.days * <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"childrens"</span></span>: result = <span class="hljs-number"><span class="hljs-number">1.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (movieFor(rental).code === <span class="hljs-string"><span class="hljs-string">"new"</span></span> &amp;&amp; rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre>  <font color="gray"><i>With these functions, I could do something else, especially with the <code>amountFor</code> , and I really did something in the book.</i></font>  <font color="gray"><i>But for this article, I will no longer delve into the study of the body of these functions</i></font> <br><br>  Done, now back to the body of the function. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> thisAmount = amountFor(r); frequentRenterPoints += frequentRenterPointsFor(r); <span class="hljs-comment"><span class="hljs-comment">//print figures for this rental result += `\t${movieFor(r).title}\t${thisAmount}\n` ; totalAmount += thisAmount; } // add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result;</span></span></code> </pre> <br>  The general approach I like to use is to eliminate mutable variables.  Here there are three, one collects the final line, two more calculate the values ‚Äã‚Äãthat are used in this line.  I have nothing against the first, but I would like to destroy the other two.  First you need to break the cycle.  First, simplify the cycle and embed a constant value. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { frequentRenterPoints += frequentRenterPointsFor(r); result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span> ; totalAmount += amountFor(r); } <span class="hljs-comment"><span class="hljs-comment">// add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result;</span></span></code> </pre> <br>  Then we divide the cycle into three parts. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> totalAmount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> frequentRenterPoints = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { frequentRenterPoints += frequentRenterPointsFor(r); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { totalAmount += amountFor(r); } <span class="hljs-comment"><span class="hljs-comment">// add footer lines result += `Amount owed is ${totalAmount}\n`; result += `You earned ${frequentRenterPoints} frequent renter points\n`; return result;</span></span></code> </pre>  <font color="gray"><i>Some programmers are worried about performance issues after such refactoring, in which case look at the <a href="https://martinfowler.com/ieeeSoftware/yetOptimization.pdf">old, but relevant, article</a> about software performance.</i></font> <br><br>  Such a partition allows you to later extract the functions for these calculations. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += amountFor(r); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += frequentRenterPointsFor(r); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  As a fan of the <a href="https://martinfowler.com/articles/collection-pipeline/">collection pipeline,</a> I also adjust cycles to such a chain. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) =&gt;</span></span> frequentRenterPointsFor(r)) .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> a + b) ; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">total, r</span></span></span><span class="hljs-function">) =&gt;</span></span> total + amountFor(r), <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre>  <font color="gray"><i>Not sure which of these two types of chains I like best</i></font> <br><br><h1>  Investigation of the assembled function </h1><br>  Now let's see what we did.  Here is the whole code. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) =&gt;</span></span> frequentRenterPointsFor(r)) .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> a + b) ; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">total, r</span></span></span><span class="hljs-function">) =&gt;</span></span> total + amountFor(r), <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> movies[rental.movieID]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (movieFor(rental).code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"regular"</span></span>: result = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"new"</span></span>: result = rental.days * <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"childrens"</span></span>: result = <span class="hljs-number"><span class="hljs-number">1.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (movieFor(rental).code === <span class="hljs-string"><span class="hljs-string">"new"</span></span> &amp;&amp; rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; } }</code> </pre> <br>  Now I have a well-composed function.  Its main code takes seven lines, and they all relate to formatting the final line.  The code for all calculations is transferred to its own set of nested functions, each of which is small and with a distinct name that indicates its purpose. <br><br>  But I'm still not ready to write a function for issuing html.  All functions after splitting are nested inside the general function <code>statement</code> .  So it is easier to extract functions, since they can refer to the names inside the scope of the function, including each other (as <code>amountFor</code> call <code>movieFor</code> ) and the corresponding <code>customer</code> and <code>movie</code> parameters.  But I can't write a simple <code>htmlStatement</code> function that references these functions.  In order to support some other output formats using the same calculations, refactoring should be continued.  Now I‚Äôll open the dots when different refactoring options appear depending on how I want to convert the code.  Then I will test each of these options, explain how each of them works, and when all four are ready, we will compare them. <br><br><h1>  Using the parameter to determine the issue </h1><br>  One option is to define the output format as an argument to the <code>statement</code> function.  I would like to start this refactoring by using <a href="http://refactoring.com/catalog/addParameter.html">Add Parameter</a> , extract the existing code to format the text, and append the code at the beginning to refer to the extracted function when the parameter indicates this. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies, format = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'text'</span></span></span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (format) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textStatement(); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">`unknown statement format </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${format}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">textStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  Then I can write the html generation function and add a condition to the dispatcher. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies, format = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'text'</span></span></span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (format) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> textStatement(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"html"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> htmlStatement(); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">`unknown statement format </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${format}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`&lt;h1&gt;Rental Record for &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/h1&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;table&gt;\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">` &lt;tr&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;/tr&gt;\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">"&lt;/table&gt;\n"</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;Amount owed is &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/p&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;You earned &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string">&lt;/em&gt; frequent renter points&lt;/p&gt;\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  I can use the data structure for the controller logic. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies, format = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'text'</span></span></span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dispatchTable = { <span class="hljs-string"><span class="hljs-string">"text"</span></span>: textStatement, <span class="hljs-string"><span class="hljs-string">"html"</span></span>: htmlStatement }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> === dispatchTable[format]) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">`unknown statement format </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${format}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dispatchTable[format].call();</code> </pre> <br><h1>  Using top level features </h1><br>  The problem with writing the top-level <code>statement</code> function is that the evaluation functions are nested inside the <code>statement</code> function.  The obvious way out is to move them to the upper context. <br><br>  To do this, I began by searching for a function that does not refer to any others, in our case, <code>movieFor</code> . <br><br>  Whenever I move functions, I like to first copy a function into a new context, embed it in that context, and then replace the body of the original function with a call to the moved function. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">topMovieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> movies[rental.movieID]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// [snip] function movieFor(rental) { return topMovieFor(rental, movies); } function frequentRenterPointsFor(rental) { return (movieFor(rental).code === "new" &amp;&amp; rental.days &gt; 2) ? 2 : 1; }</span></span></code> </pre> <br>  At this stage, you can compile and test the code to check if there are any problems due to the change of context.  When this is done, you can embed the forwarding feature. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> movies[rental.movieID]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// [snip] function frequentRenterPointsFor(rental) { return (movieFor(rental, movies).code === "new" &amp;&amp; rental.days &gt; 2) ? 2 : 1; }</span></span></code> </pre>  <font color="gray"><i>Similar changes are made inside <code>amountFor</code></i></font> <br><br>  Simultaneously with embedding, I also renamed the top-level function to match the old name, so the only difference now is <code>movies</code> . <br><br>  Then do this with all the nested functions. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r, movies).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r, movies)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount(customer, movies)}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints(customer, movies)}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) =&gt;</span></span> frequentRenterPointsFor(r, movies)) .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> a + b) ; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">total, r</span></span></span><span class="hljs-function">) =&gt;</span></span> total + amountFor(r, movies), <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> movies[rental.movieID]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (movieFor(rental, movies).code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"regular"</span></span>: result = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"new"</span></span>: result = rental.days * <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"childrens"</span></span>: result = <span class="hljs-number"><span class="hljs-number">1.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (movieFor(rental, movies).code === <span class="hljs-string"><span class="hljs-string">"new"</span></span> &amp;&amp; rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  Now I can easily write the <code>htmlStatement</code> function. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`&lt;h1&gt;Rental Record for &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/h1&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;table&gt;\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">` &lt;tr&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r, movies).title}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r, movies)}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;/tr&gt;\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">"&lt;/table&gt;\n"</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;Amount owed is &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount(customer, movies)}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/p&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;You earned &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints(customer, movies)}</span></span></span><span class="hljs-string">&lt;/em&gt; frequent renter points&lt;/p&gt;\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><h3>  Declaring some local functions with partial use </h3><br>  When the global function is used in this way, the parameter lists can stretch out pretty heavily.  So it can sometimes be useful to declare a local function that calls a global function with some or all of the parameters inside.  This local function, which is a partial application of a global function, can be useful for later use.  There are various ways to do this in JavaScript.  One of them is to assign local functions to variables. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> amount = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> totalAmount(customer, movies); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> frequentRenterPoints = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> totalFrequentRenterPoints(customer, movies); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> movie = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aRental</span></span></span><span class="hljs-function">) =&gt;</span></span> movieFor(aRental, movies); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rentalAmount = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aRental</span></span></span><span class="hljs-function">) =&gt;</span></span> amountFor(aRental, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`&lt;h1&gt;Rental Record for &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/h1&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;table&gt;\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">` &lt;tr&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movie(r).title}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rentalAmount(r)}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;/tr&gt;\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">"&lt;/table&gt;\n"</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;Amount owed is &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amount()}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/p&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;You earned &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${frequentRenterPoints()}</span></span></span><span class="hljs-string">&lt;/em&gt; frequent renter points&lt;/p&gt;\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  Another way is to declare them as nested functions. <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`&lt;h1&gt;Rental Record for &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/h1&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;table&gt;\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">` &lt;tr&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movie(r).title}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rentalAmount(r)}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;/tr&gt;\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">"&lt;/table&gt;\n"</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;Amount owed is &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amount()}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/p&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;You earned &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${frequentRenterPoints()}</span></span></span><span class="hljs-string">&lt;/em&gt; frequent renter points&lt;/p&gt;\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> totalAmount(customer, movies);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> totalFrequentRenterPoints(customer, movies);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rentalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aRental</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> amountFor(aRental, movies);} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">aRental</span></span></span><span class="hljs-function">) </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> movieFor(aRental, movies);} }</code> </pre> <br>  Another option is to use <code>bind</code> .  I leave it to you for your own research - this is not what I would use here, since the previous options seem to me more suitable. <br><br><h1>  Using classes </h1><br>  I am familiar with the object approach, so it is not surprising that I am going to consider classes and objects.  ES6 has a nice syntax for the classic object approach.  Let's see how to apply it in this example. <br><br>  First of all we wrap the data in the objects, starting with the <code>customer</code> . <br><br>  <i>customer.es6 ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Customer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(data) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data = data; } get name() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data.name;} get rentals() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data.rentals;} }</code> </pre> <br>  <i>statement.es6 ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Customer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./customer.es6'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customerArg, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Customer(customerArg); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;</code> </pre> <br>  Until now, the class is a simple wrapper around the original JavaScript object.  Next we will do the same for <code>rental</code> . <br><br>  <i>rental.es6 ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rental</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(data) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data = data; } get days() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data.days} get movieID() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data.movieID} }</code> </pre> <br>  <i>customer.es6 ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Rental <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./rental.es6'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Customer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(data) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data = data; } get name() {<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data.name;} get rentals() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data.rentals.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rental(r));} }</code> </pre> <br>  Now that classes are created around my simple json objects, a job for the <a href="http://refactoring.com/catalog/moveMethod.html">Move Method has appeared</a> .  As during the transfer of functions to the upper level, first of all we take the function that does not apply to any other - <code>movieFor</code> .  But this function needs a list of movies as a context that needs to be made available for the <code>rental</code> objects being created. <br><br>  <i>statement.es6 ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customerArg, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Customer(customerArg, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;</code> </pre> <br>  <i>class Customer ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(data, movies) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data = data; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._movies = movies } get rentals() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data.rentals.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rental(r, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._movies));}</code> </pre> <br>  <i>class Rental ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(data, movies) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._data = data; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._movies = movies; }</code> </pre> <br>  When I have all the supporting data in place, I can transfer the function. <br><br>  <i>statement.es6 ...</i> <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rental.movie; }</code> </pre> <br>  <i>class Rental ...</i> <br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Rental</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">movie</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._movies[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.movieID]; }</code> </pre> <br>  As with the previous move, first of all, we move the key behavior of the function into a new context, embed it in the context, and configure the original function to call a new function.  When this works, it is relatively easy to embed calls to the original function. <br><br>  <i>statement.es6 ...</i> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customerArg, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Customer(customerArg, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.movie.title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (rental.movie.code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"regular"</span></span>: result = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"new"</span></span>: result = rental.days * <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"childrens"</span></span>: result = <span class="hljs-number"><span class="hljs-number">1.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rental.days &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { result += (rental.days - <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (rental.movie.code === <span class="hljs-string"><span class="hljs-string">"new"</span></span> &amp;&amp; rental.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>          <code>rental</code>   . <br><br> <i>statement.es6‚Ä¶</i> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customerArg, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Customer(customerArg, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.movie.title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.amount}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) =&gt;</span></span> r.frequentRenterPoints) .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> a + b) ; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> customer.rentals .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">total, r</span></span></span><span class="hljs-function">) =&gt;</span></span> total + r.amount, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br> <i>class Rental...</i> <br><pre> <code class="javascript hljs"> get frequentRenterPoints() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.movie.code === <span class="hljs-string"><span class="hljs-string">"new"</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; } get amount() { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.movie.code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"regular"</span></span>: result = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { result += (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.days - <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"new"</span></span>: result = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.days * <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"childrens"</span></span>: result = <span class="hljs-number"><span class="hljs-number">1.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.days &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { result += (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.days - <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>      <code>customer</code>    . <br><br> <i>statement.es6‚Ä¶</i> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customerArg, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Customer(customerArg, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.movie.title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.amount}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.amount}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.frequentRenterPoints}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br> <i>class Customer...</i> <br><pre> <code class="javascript hljs"> get frequentRenterPoints() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rentals .map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) =&gt;</span></span> r.frequentRenterPoints) .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> a + b) ; } get amount() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.rentals .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">total, r</span></span></span><span class="hljs-function">) =&gt;</span></span> total + r.amount, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br>       <code>rental</code> <code>customer</code> ,  html- <code>statement</code> . <br><br> <i>statement.es6‚Ä¶</i> <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customerArg, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> customer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Customer(customerArg, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`&lt;h1&gt;Rental Record for &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/h1&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;table&gt;\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals) { result += <span class="hljs-string"><span class="hljs-string">` &lt;tr&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.movie.title}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.amount}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;/tr&gt;\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">"&lt;/table&gt;\n"</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;Amount owed is &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.amount}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/p&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;You earned &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.frequentRenterPoints}</span></span></span><span class="hljs-string">&lt;/em&gt; frequent renter points&lt;/p&gt;\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><h3>    </h3><br>    ES2015 ,   ,      (   Java-).            : <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customerArg, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> customer = createCustomer(customerArg, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.name()}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> customer.rentals()) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.movie().title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.amount()}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.amount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${customer.frequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createCustomer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> data.name, <span class="hljs-attr"><span class="hljs-attr">rentals</span></span>: rentals, <span class="hljs-attr"><span class="hljs-attr">amount</span></span>: amount, <span class="hljs-attr"><span class="hljs-attr">frequentRenterPoints</span></span>: frequentRenterPoints }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rentals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data.rentals.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> createRental(r, movies)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rentals() .map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function">) =&gt;</span></span> r.frequentRenterPoints()) .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, b</span></span></span><span class="hljs-function">) =&gt;</span></span> a + b) ; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rentals() .reduce(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">total, r</span></span></span><span class="hljs-function">) =&gt;</span></span> total + r.amount(), <span class="hljs-number"><span class="hljs-number">0</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRental</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">days</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> data.days, <span class="hljs-attr"><span class="hljs-attr">movieID</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> data.movieID, <span class="hljs-attr"><span class="hljs-attr">movie</span></span>: movie, <span class="hljs-attr"><span class="hljs-attr">amount</span></span>: amount, <span class="hljs-attr"><span class="hljs-attr">frequentRenterPoints</span></span>: frequentRenterPoints }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> movies[data.movieID]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (movie().code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"regular"</span></span>: result = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { result += (data.days - <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"new"</span></span>: result = data.days * <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"childrens"</span></span>: result = <span class="hljs-number"><span class="hljs-number">1.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.days &gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) { result += (data.days - <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">1.5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (movie().code === <span class="hljs-string"><span class="hljs-string">"new"</span></span> &amp;&amp; data.days &gt; <span class="hljs-number"><span class="hljs-number">2</span></span>) ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>      <a href="http://www.cs.uni.edu/~wallingf/patterns/envoy.pdf">Function As Object</a> . - ( <code>createCustomer</code>  <code>createRental</code> )   JavaScript ()  .  -     .          ,      .        ,     ,   .     ,      ‚Äî     . <br><br><h1>   </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All of these approaches require that print functions </font></font><code>statement</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">call other functions to calculate the data they need. This can be done differently: pass this data to the report printing function in the data structure itself. With this approach, the calculation functions are used to transform the data structure in </font></font><code>customer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">such a way that it will contain all the data needed by the print function. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In terms of refactoring, this is an example of the not yet written Split Phase refactoring, which Kent Beck described to me last summer. With this refactoring, I divide the calculations into two phases, which communicate with each other through an intermediate data structure. We start this refactoring with the introduction of an intermediate data structure.</font></font><br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = createStatementData(customer, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${movieFor(r).title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStatementData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, customer); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>         <code>customer</code> ,    ,     <code>Object.assign</code> .         .      ,       . <br><br>         <code>rental</code> . <br><br> <i>function statement‚Ä¶</i> <br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStatementData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, customer); result.rentals = customer.rentals.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> createRentalData(r)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRentalData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, rental); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br>  ,    <code>createRentalData</code>  <code>createStatementData</code> ,     <code>createStatementData</code>   ,    . <br><br>       ,    ,  . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = createStatementData(customer, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${amountFor(r)}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalAmount()}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${totalFrequentRenterPoints()}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ function createStatementData(customer, movies) { // ‚Ä¶ function createRentalData(rental) { let result = Object.assign({}, rental); result.title = movieFor(rental).title; return result; } }</span></span></code> </pre> <br>       . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = createStatementData(customer, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`Rental Record for </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.name}</span></span></span><span class="hljs-string">\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data.rentals) { result += <span class="hljs-string"><span class="hljs-string">`\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.title}</span></span></span><span class="hljs-string">\t</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.amount}</span></span></span><span class="hljs-string">\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">`Amount owed is </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.totalAmount}</span></span></span><span class="hljs-string">\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`You earned </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.totalFrequentRenterPoints}</span></span></span><span class="hljs-string"> frequent renter points\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStatementData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, customer); result.rentals = customer.rentals.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">r</span></span></span><span class="hljs-function"> =&gt;</span></span> createRentalData(r)); result.totalAmount = totalAmount(); result.totalFrequentRenterPoints = totalFrequentRenterPoints(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRentalData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.assign({}, rental); result.title = movieFor(rental).title; result.amount = amountFor(rental); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br> ,           ,   ,      <code>statement</code> .        <code>createStatementData</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// body ‚Ä¶ function createStatementData (customer, movies) { // body ‚Ä¶ function createRentalData(rental) { ‚Ä¶ } function totalFrequentRenterPoints() { ‚Ä¶ } function totalAmount() { ‚Ä¶ } function movieFor(rental) { ‚Ä¶ } function amountFor(rental) { ‚Ä¶ } function frequentRenterPointsFor(rental) { ‚Ä¶ } } }</span></span></code> </pre> <br>   <code>createStatementData</code>   <code>statement</code> . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStatementData</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRentalData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ ‚Ä¶ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span></span>{ ‚Ä¶ } }</code> </pre> <br>      ,   HTML- <code>statement</code> ,       . <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> data = createStatementData(customer, movies); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">`&lt;h1&gt;Rental Record for &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.name}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/h1&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;table&gt;\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> r <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> data.rentals) { result += <span class="hljs-string"><span class="hljs-string">` &lt;tr&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.title}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;td&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${r.amount}</span></span></span><span class="hljs-string">&lt;/td&gt;&lt;/tr&gt;\n`</span></span>; } result += <span class="hljs-string"><span class="hljs-string">"&lt;/table&gt;\n"</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;Amount owed is &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.totalAmount}</span></span></span><span class="hljs-string">&lt;/em&gt;&lt;/p&gt;\n`</span></span>; result += <span class="hljs-string"><span class="hljs-string">`&lt;p&gt;You earned &lt;em&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${data.totalFrequentRenterPoints}</span></span></span><span class="hljs-string">&lt;/em&gt; frequent renter points&lt;/p&gt;\n`</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>    <code>createStatementData</code>   ,           () . <br><br><h1>   </h1><br> ,        .   ,     .      ,   HTML-     .         ,    .       . <br><img src="https://habrastorage.org/getpro/habr/post_images/9a7/7c5/1f9/9a77c51f9f7b02e63bc3a2778a0c14e6.png"><br><hr><br><h4> top-level-functions </h4><br>        <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">textStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental, movies</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Üí <a href="https://martinfowler.com/articles/refactoring-video-store-js/top-level-functions.html"> </a> <br><br><hr><br><h4> parameter-dispatch </h4><br>          <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies, format</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">textStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Üí <a href="https://martinfowler.com/articles/refactoring-video-store-js/parameter-dispatch.html"> </a> <br><br><hr><br><h4> classes </h4><br>     ,     <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">textStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">class</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Customer</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rentals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">class</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rental</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span></code> </pre> ‚Üí <a href="https://martinfowler.com/articles/refactoring-video-store-js/classes.html"> </a> <br><br><hr><br><h4> transform </h4><br>       ,         <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">statement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">htmlStatement</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStatementData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">customer, movies</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRentalData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalAmount</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalFrequentRenterPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">amountFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frequentRenterPointsFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">movieFor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rental</span></span></span><span class="hljs-function">)</span></span></code> </pre> ‚Üí <a href="https://martinfowler.com/articles/refactoring-video-store-js/transform.html"> </a> <br><br><hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will begin with an example of top-level functions in order to select the conceptually simplest alternative as a basis for comparison. </font></font><a name="2_2"></a> <a href="https://habr.com/ru/post/320280/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[2]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> It is simple because it divides the work into a number of pure functions, and everyone can access them from anywhere in the code. </font><font style="vertical-align: inherit;">This is easy to use and easy to test - I can easily test any single function either using test cases or using REPL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The negative side </font></font><code>top-level-functions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- a large number of repetitive transmission parameters. </font><font style="vertical-align: inherit;">Each function should be given a data structure with movies, and level functions</font></font><code>customer</code> ‚Äî     .            ,      .        ,   ,     .             ‚Äî           .    ,           ,   ,     ,  . <br><br>          .       ,      .     ,     ,       ,      ,    .      ,      ,           ‚Äî        . <br><br>      ,        ,     .  <code>parameter-dispatch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">does this by capturing the context in the top-level parameter list, which is then available as a general context for all nested functions. This works especially well with the original code, making refactoring from a single function to nested functions easier than in a language that does not have nested functions. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But the approach </font></font><code>parameter-dispatch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">begins to wobble when other general behaviors are required from my context, like an HTML response. I had to write something like a dispatcher to determine which function I want to call. Defining a format for a renderer is not very bad, but such a controller logic clearly smells bad. However, I wrote it, it still essentially copies the basic ability of a language to call a named function. And I'm heading for the path that quickly leads me to this nonsense:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeFunction</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, args</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dispatchTable = { <span class="hljs-comment"><span class="hljs-comment">//...</span></span></code> </pre> <br>     ,         .           .       <code>statement</code>  ‚Ä¶ <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> someValue = statement(customer, movieList, <span class="hljs-string"><span class="hljs-string">'text'</span></span>);</code> </pre> <br> ‚Ä¶          . <br><br>   ‚Äî  .        ‚Äî  .   API    ,    ,    , <code>textStatement</code>  <code>htmlStatement</code> .               . <br><br> ,     ,   ?   -     - ,         .      ,        ‚Äî           . <a name="3_3"></a> <a href="https://habr.com/ru/post/320280/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[3]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This leads me to an example with classes in which you can capture the general context of users and movies in objects </font></font><code>customer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and </font></font><code>rental</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. I set the context once, when I assert the objects, and then all further logic can use the general context. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Object methods are similar to local functions with partial application in the first example, except for the general context provided here by the constructor. Therefore, I am writing only local functions, not top-level functions. The caller specifies the context with a constructor, and then calls the local function directly. I can imagine local methods as a variant of partial application of abstract functions of the upper level on the general context of an object instance.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The use of classes introduces an additional concept - the separation of rendering logic from the calculation logic. One of the drawbacks of the original single function is that it mixes them together. The division into functions to some extent divides them, but they still exist in a single conceptual space. This is slightly wrong, I could put the computational functions in one file, and the rendering functions in another, link them with the corresponding import statements. But it seems to me that the general context in itself gives a hint how to group the logic into modules.</font></font><br><br>         ,      .      ,           .      ,   ,         ,    ‚Äî  <a href="https://martinfowler.com/bliki/UniformAccessPrinciple.html">Uniform Access Principle</a> .                .    <code>transform</code>   ,      ,       .        <code>customer</code>  <code>rental</code> ,     <code>transform</code>     <code>createStatementData</code>  <code>createRentalData</code> .       <a href="https://martinfowler.com/bliki/ListAndHash.html">List And Hash</a>      .    <code>create‚Ä¶Data</code>    ,        . <br><br><blockquote> <font color="gray">           <code>transform</code> ,    .   <code>transform</code>    ,           .         ,      .             .    <code>transform</code>      ,      .        .  -      ,       /      .</font> </blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, four approaches - which one to prefer? </font><font style="vertical-align: inherit;">I do not want to write controller logic, so I would not use the approach </font></font><code>parameter-dispatch</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">One could choose </font></font><code>top-level-functions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, but they quickly spoil the impression of themselves when the overall context increases in size. </font><font style="vertical-align: inherit;">Even with just two arguments, I'd rather have built in functions to achieve other alternatives. </font><font style="vertical-align: inherit;">It is harder to choose between classes and transformation; both approaches make it possible to make the overall context and the separation explicit. </font><font style="vertical-align: inherit;">I‚Äôm not interested in cockfights, so I‚Äôll just throw a coin and have the winner choose the lot.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Further refactoring </font></font></h1><br>             .   ‚Äî   ,      ,         . <br><br>   ,    .         <code>amount</code>  <code>frequentRenterPoint</code>      .         , ,     ,   .   ,          . <br><br>   ,      ,   ,          .       ‚Äî        Java,      . JavaScript    .  ,     ,       ‚Äî     . (     JavaScript    ,    ).    ,    ,    .            ,       ,    .      ,         ,        . <br><br><h1>  Notes </h1><br> <sup><a name="1"></a> [1]         - ,      ¬´¬ª   //   .  JavaScript      ¬´¬ª,        . <a href="https://habr.com/ru/post/320280/" title="  ">  </a> <br><br><a name="2"></a> [2]  <code>parameter-dispatch</code>     ,         .    ,     <code>top-level-functions</code> . <a href="https://habr.com/ru/post/320280/" title="  ">  </a> <br><br><a name="3"></a> [3]    <a href="http://wcook.blogspot.com/2012/07/proposal-for-simplified-modern.html">     ¬´¬ª</a> . <a href="https://habr.com/ru/post/320280/" title="  ">  </a></sup> </div><p>Source: <a href="https://habr.com/ru/post/320280/">https://habr.com/ru/post/320280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320264/index.html">We write a wrapper over the API, make a PIP packet out of it, connect Travis CI testing and look at open source licenses</a></li>
<li><a href="../320266/index.html">JunOS update on EX4500 switches in VirtualChassis - what could go wrong? Part 1</a></li>
<li><a href="../320268/index.html">Generating documents in doc, excel, pdf and other formats on the server</a></li>
<li><a href="../320270/index.html">Internet intelligence in action: who is Mr./Ms. Habraman?</a></li>
<li><a href="../320278/index.html">Hard parting with Net-Tools</a></li>
<li><a href="../320282/index.html">Hijacking Whatsapp accounts using the web version</a></li>
<li><a href="../320284/index.html">Qt 5.8 framework release</a></li>
<li><a href="../320286/index.html">The right way to become a safe person: from lamer to practical exploit</a></li>
<li><a href="../320288/index.html">Python: collections, part 4/4: All about expression-generators, list generators, sets and dictionaries</a></li>
<li><a href="../320290/index.html">This is not ransomware, but in any case can ‚Äúseize‚Äù your server.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>