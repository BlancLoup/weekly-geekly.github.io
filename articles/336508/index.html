<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Change payment service using A / B test through HAProxy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At Avito, we are closely following the development of other classifications around the world. And of course, we are interested in the best practices o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Change payment service using A / B test through HAProxy</h1><div class="post__text post__text-html js-mediator-article"><p>  At Avito, we are closely following the development of other classifications around the world.  And of course, we are interested in the best practices of working with such a complex system as billing.  Today I am publishing a translation of the post of my colleague in the <a href="https://www.naspers.com/">Naspers</a> group (Avito is a member of it), M. Rafai Alem, a software engineer from <a href="https://dubizzle.com/">Dubizzle</a> .  This is the leading ad site in the UAE, part of the OLX Group - a network of the largest online markets in 45 countries with more than 1.9 billion visits, 37 billion page views and 54 million ads monthly.  The topic will interest all those involved in the creation and development of their own payment service. </p><br><img src="https://habrastorage.org/web/86b/bb7/c2a/86bbb7c2a68f4ec8a68be1a852b13e5f.jpeg"><a name="habracut"></a><br><p><br>  Imagine that you need to rewrite an existing web service to upgrade to a new payment service provider for various practical reasons.  Your first thought will probably be to completely replace the old gateway with a new one and start it.  But this is a bit naive, especially if you work with payment gateways that have service level agreements, agreements with servicing banks, scripts for risk detection and fraudulent activities, etc.  These factors make the transition process more risky in terms of operations, revenues, customer retention and, ultimately, business success.  In this post, we will look at the approach we used to reduce the risks of changing the payment gateway, and why it is so important. </p><br><img src="https://habrastorage.org/web/00f/999/0c8/00f9990c81ff459d970e9f09acdc8520.png"><br><p>  <em>Dubizzle checkout page</em> </p><br><h3 id="vse-nachinaetsya-so-starogo-platezhnogo-servisa">  It all starts with the old payment service ... </h3><br><p>  Our old payment system is written in Python 2 and is closely connected with the old payment gateway.  When we first tackled the problem, we thought that integrating the new payment gateway into existing flows, URLs and the <a href="https://bottlepy.org/docs/dev/">Python Bottle</a> would be easy.  When we started working on the first prototype, we realized that we were creating spaghetti code, since the API flows of these two payment gateways were completely different.  The API of the old payment gateway was different: <a href="https://redis.io/">Redis</a> and <a href="http://www.gevent.org/">Gevent were</a> largely used to optimize the processing of users and payments, there was absolutely no need to repeat this in the API of the new gateway. </p><br><p><img src="https://habrastorage.org/web/c95/8a4/7a7/c958a47a79a645c4aaa035cff039cfc8.gif"><br>  <em>Payment service in the old payment gateway</em> </p><br><h3 id="ab-testy-horoshi-poka-oni-prosty">  A / B tests are good as long as they are simple. </h3><br><p>  A / B tests are very important for decision making in product development.  In Dubizzle, such tests are usually more focused on what the user faces: the transitions between pages, the components on the pages and their location, the features.  However, they complicate the situation if you want to test basic systems that are highly dependent on each other. </p><br><p>  Working on the prototype, we realized that the A / B test we wanted to perform should not be performed using tools like Optimizely, even if we could somehow integrate the new gateway into the same custom mappings and streams.  And that's why. </p><br><ul><li>  Using external JavaScript code in a payment service that can capture credit card information is a huge security threat. </li><li>  Applying the Optimizely approach would require us to implement the A / B testing logic for each web service mapping, to ensure that requests from all transaction mappings are sent to the correct payment gateway using cookies.  This would require the following code for each display and would not look very neat: </li></ul><br><pre><code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cookie == <span class="hljs-string"><span class="hljs-string">'OLD'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> old payment gateway API <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> payment gateway API</code> </pre> <br><ul><li>  When debugging two different payment gateways using the same namespaces (for example, in Redis), the generation and registration of the UUID would inevitably cause problems, and we would have to solve them instantly. </li></ul><br><p>  If the user is in control group A (a web service that interacts with the old payment gateway), this web service must ensure that the payment process of this user continues in the same payment gateway in which he started.  So, the web service should not initiate transactions in the old payment gateway and try to complete them in the new one.  This problem can be solved using <a href="http://wiki.metawerx.net/wiki/StickySessions">sticky sessions</a> , which are supported by Optimizely and HAProxy. </p><br><h3 id="istoriya-o-dvuh-platezhnyh-servisah">  The story of two payment services </h3><br><p>  When we began to understand the problem we encountered, we decided to develop a new payment service integrated with the new gateway and compare their performance using the A / B test (50/50).  The A / B test had to meet at least the following requirements: </p><br><ul><li>  The appearance of the payment card data entry form in the new service must exactly match the old form so that no operation will be disrupted.  In this case, the operation refers to the click on the ‚ÄúPay‚Äù button. </li><li>  No internal server tasks or API calls should increase the number of transaction failures in the new service compared to the old one.  This means that most user processes should essentially flow in the same way as with the old gateway. </li></ul><br><p><img src="https://habrastorage.org/web/e40/7df/861/e407df861fdf4c92bbd43ce5590c959a.gif"><br>  <em>Payment service integrated with new payment gateway</em> </p><br><h3 id="ab-test--s-pomoschyu-haproxy">  A / B test with HAProxy </h3><br><p>  Excluding Optimizely, we decided to use the HAProxy test.  It is a powerful load balancer of the fourth and seventh levels of the OSI network model with a wide range of functions.  One of these functions is the ability to bind a request to a backend using cookies at the seventh level. <br>  We set up HAProxy for three backends: </p><br><ul><li>  Main backend (main) </li><li>  Old service backend </li><li>  New service backend </li></ul><br><p>  Below is an example of the HAProxy backend: </p><br><pre> <code class="hljs sql">backend main balance roundrobin cookie SERVERID <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> indirect nocache maxlife <span class="hljs-number"><span class="hljs-number">2</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> forwardfor <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>-pretend-keepalive <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> queue <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">50000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">old</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">old</span></span>-pg <span class="hljs-keyword"><span class="hljs-keyword">old</span></span>-service.eu-west<span class="hljs-number"><span class="hljs-number">-1.</span></span>elasticbeanstalk.com:<span class="hljs-number"><span class="hljs-number">80</span></span> weight <span class="hljs-number"><span class="hljs-number">128</span></span> cookie old_v1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-pg <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service.eu-west<span class="hljs-number"><span class="hljs-number">-1.</span></span>elasticbeanstalk.com:<span class="hljs-number"><span class="hljs-number">80</span></span> weight <span class="hljs-number"><span class="hljs-number">128</span></span> cookie new_v1 <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> backend old_service <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> forwardfor <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>-pretend-keepalive <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> queue <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">50000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">old</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">old</span></span>-pg-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">old</span></span>-service.eu-west<span class="hljs-number"><span class="hljs-number">-1.</span></span>elasticbeanstalk.com:<span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> backend new_service <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> forwardfor <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> <span class="hljs-keyword"><span class="hljs-keyword">http</span></span>-pretend-keepalive <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> queue <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timeout</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">50000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-pg-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service.eu-west<span class="hljs-number"><span class="hljs-number">-1.</span></span>elasticbeanstalk.com:<span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span></code> </pre> <br><p>  Perhaps you thought: why do we need static backends?  This will become clear when we get to the frontend HAProxy, so let's first consider the main backend. </p><br><p>  We chose Weighted Round Robin (WRR) to balance the load on old-service-old-pg and new-service-new-pg.  This makes sense in the A / B test, where you just need to divide the traffic between groups A and B, given that a request falling into group A should not fall into group B throughout the session.  We achieved this with the <a href="http://cbonte.github.io/haproxy-dconv/1.6/configuration.html">cookie</a> directive HAProxy.  Assuming that any user who initiates a transaction completes it within 2 hours, we set up HAProxy so that the cookie is deleted after 2 hours and a new one is created based on the WRR results. </p><br><p>  This gave us two very important results: </p><br><ul><li>  We were able to adjust the weights in the A / B test to reach all users for 2 hours without disrupting sessions or user threads. </li><li>  Increased the likelihood that the user will try transactions in both services during the entire A / B test.  This helped us to identify problems related to the fact that one gateway refused to accept a credit card that had previously been accepted by another gateway.  We were amazed to see how things can begin to crumble on a larger scale, when several cascade systems are involved on different continents. </li></ul><br><p>  There is a small vulnerability in our scheme that you probably haven‚Äôt noticed yet.  Consider the following scheme: </p><br><p><img src="https://habrastorage.org/web/147/315/4eb/1473154eb0ad4efc9bc104e4af2a6b4f.jpeg"><br>  <em>Payment process through HAProxy</em> </p><br><p>  The user starts the transaction in the old payment service at 45 minutes after receiving the cookie.  Then it goes to the 3-D Secure Bank page at 1:00 and 59 minutes and is redirected back to our URL of the successful payment page after 2 hours.  Since HAProxy is set to maxlife cookie for 2 hours, HAProxy cancels the session cookie and tries to insert a new one after redirection to the URL of the successful payment page.  If we are unlucky, WRR can link a new session to a new payment service that does not know how to handle redirection to the successful payment page initiated by the old service. </p><br><p>  In our case, we decided to ignore this problem, because we knew from experience that the users who initiated the transaction usually complete it within two hours.  But imagine what problem we would face by setting the <code>maxlife</code> parameter to, for example, 1 minute? </p><br><p>  Let's go back to the conversation about why we used the <code>old_service</code> and <code>new_service</code> , as well as <code>main</code> .  HAProxy typically configure a proxy <code>frontend</code> that handles all access control lists (ACLs).  In our case, it looked like this: </p><br><pre> <code class="hljs pgsql">frontend <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> bind *:<span class="hljs-number"><span class="hljs-number">80</span></span> timeout client <span class="hljs-number"><span class="hljs-number">50000</span></span> default_backend main acl is_old_webhook path_reg ^\/webhook-<span class="hljs-built_in"><span class="hljs-built_in">old</span></span>.* acl is_refund path_reg ^\/refund-endpoint.* acl is_new_webhook path_reg ^\/webhook-<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>.* use_backend old_service <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_old_webhook use_backend new_service <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_refund use_backend new_service <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_new_webhook</code> </pre><br><p>  These web pages and endpoints, which can be seen in the configuration, are the specific rules needed to process requests originating from external gateways.  Since the old and new services are not able to interact with each other's payment gateways, using WRR for load balancing will result in almost all requests giving an error 404 or 400.  In addition, since these requests come from payment gateways, there is no need for persistence because they do not contain scripts that cover different rules (all requests are processed instantly upon receipt of code 200). </p><br><p>  The best place to solve this problem is the balancer itself, so we configured ACLs to direct the flow of requests to the appropriate application servers through the <code>old_service</code> and <code>new_service</code> static <code>new_service</code> .  In other words, there is a sort of conversation between the payment gateway and HAProxy, which should redirect the request to the appropriate application server. </p><br><blockquote>  Payment Gateway: Hi, I‚Äôm an internal request from an old payment gateway, and I‚Äôm reporting that I‚Äôve received a successful payment. <br>  HAProxy: Hi, I know you.  Go through the old_service door to access the target application. <br>  Target app: Hi, I know how to be with you.  Let's activate this user's order.  For this, I will give you code 200. </blockquote><br><h3 id="monitoring-potokov-zaprosov">  Query flow monitoring </h3><br><p>  Now that all the problems have been solved, it is worth wondering how to test the implementation of such a complex A / B test. </p><br><p>  HAProxy keeps very detailed logs for debugging complex systems.  Consider a few examples from the A / B test. </p><br><pre> <code class="hljs cs">Feb <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span> ip<span class="hljs-number"><span class="hljs-number">-1</span></span>-xxx haproxy[<span class="hljs-number"><span class="hljs-number">9046</span></span>]: <span class="hljs-number"><span class="hljs-number">1.</span></span>xac:<span class="hljs-number"><span class="hljs-number">2459</span></span> [<span class="hljs-number"><span class="hljs-number">22</span></span>/Feb/<span class="hljs-number"><span class="hljs-number">2017</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">25.623</span></span>] all main/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-pg <span class="hljs-number"><span class="hljs-number">13783</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">101</span></span>/<span class="hljs-number"><span class="hljs-number">13884</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">8241</span></span> - - --NI <span class="hljs-number"><span class="hljs-number">22</span></span>/<span class="hljs-number"><span class="hljs-number">22</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">"GET /step1/1725770 HTTP/1.1"</span></span> Feb <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span> ip<span class="hljs-number"><span class="hljs-number">-1</span></span>-xxx haproxy[<span class="hljs-number"><span class="hljs-number">9046</span></span>]: <span class="hljs-number"><span class="hljs-number">1.</span></span>xac:<span class="hljs-number"><span class="hljs-number">2629</span></span> [<span class="hljs-number"><span class="hljs-number">22</span></span>/Feb/<span class="hljs-number"><span class="hljs-number">2017</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">12.291</span></span>] all main/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-pg <span class="hljs-number"><span class="hljs-number">7223</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">3881</span></span>/<span class="hljs-number"><span class="hljs-number">11105</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">327</span></span> - - --VU <span class="hljs-number"><span class="hljs-number">19</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">"POST /step2/1725770 HTTP/1.1"</span></span> Feb <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> ip<span class="hljs-number"><span class="hljs-number">-1</span></span>-xxy haproxy[<span class="hljs-number"><span class="hljs-number">9402</span></span>]: <span class="hljs-number"><span class="hljs-number">1.</span></span>xbz:<span class="hljs-number"><span class="hljs-number">59238</span></span> [<span class="hljs-number"><span class="hljs-number">22</span></span>/Feb/<span class="hljs-number"><span class="hljs-number">2017</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">26.761</span></span>] all main/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-pg <span class="hljs-number"><span class="hljs-number">3714</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">45</span></span>/<span class="hljs-number"><span class="hljs-number">3760</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">4711</span></span> - - --VN <span class="hljs-number"><span class="hljs-number">34</span></span>/<span class="hljs-number"><span class="hljs-number">34</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">"GET /success-redirect/1725770 HTTP/1.1"</span></span> Feb <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span> ip<span class="hljs-number"><span class="hljs-number">-1</span></span>-xxx haproxy[<span class="hljs-number"><span class="hljs-number">9046</span></span>]: <span class="hljs-number"><span class="hljs-number">1.</span></span>xac:<span class="hljs-number"><span class="hljs-number">2459</span></span> [<span class="hljs-number"><span class="hljs-number">22</span></span>/Feb/<span class="hljs-number"><span class="hljs-number">2017</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">49.146</span></span>] all new_service/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-service-<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-pg-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-number"><span class="hljs-number">2047</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span>/<span class="hljs-number"><span class="hljs-number">2052</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">226</span></span> - - ---- <span class="hljs-number"><span class="hljs-number">29</span></span>/<span class="hljs-number"><span class="hljs-number">29</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-string"><span class="hljs-string">"POST /webhook-new HTTP/1.1"</span></span></code> </pre> <br><p>  Note the NI, VU, and VN flags in each request for a single order identifier.  These checkboxes allow you to understand how the client, server and HAProxy processed cookies.  This is the most important information that you should pay attention to when testing and debugging. <br>  We quote the HAProxy <a href="http://cbonte.github.io/haproxy-dconv/1.6/configuration.html">documentation</a> : </p><br><blockquote>  <strong>-:</strong> Cookie binding is disabled.  This is the case when we do not do an A / B test. <br>  <strong>NI: The</strong> cookie was not set by the client and was generated in response.  This usually occurs when the first request from each user and allows you to count the number of real users.  <strong>WRR will define the user group.</strong> <br>  <strong>VU:</strong> Cookie provided by the client;  The last date of the visit is outdated, so an updated cookie was given in response.  This is also possible if there is no date at all or it is specified, but the maxidle parameter is not set and the cookie can be set indefinitely. <br>  <strong>VN:</strong> Cookie provided by the client.  Occurs in most responses if the client already has a cookie.  <strong>So HAProxy finds the current group for the user and sends it to the corresponding backend.</strong> </blockquote><p>  Please note that when HAProxy selects the <code>new-service-new-pg</code> server and sets a cookie, all subsequent requests from this user are sent to the <code>new-service-new-pg</code> via the <code>main</code> backend. </p><br><p>  If the request matches one of the ACLs, HAProxy sends the request without setting a cookie.  It also ensures that the A / B test results are not distorted by HTTP calls originating from bots. </p><br><h3 id="arhitektura-ab-testa">  A / B Test Architecture </h3><br><p><img src="https://habrastorage.org/web/f43/cf4/b35/f43cf4b35ec24b96874bdad82b30dae0.jpeg"><br>  <em>A / B Test Architecture</em> </p><br><p>  DNS and boundary node - common to all our microservices.  All the magic of the A / B test begins after the traffic passes through the upstream load balancer (also HAProxy). </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Although for us such a solution was the best possible solution, there are many other ways of more complex balancing, not only using Cookie bindings.  Shopify described the solution with Nginx and OpenResty very well in his <a href="https://engineering.shopify.com/232808527-surviving-flashes-of-high-write-traffic-using-scriptable-load-balancers-part-i">blog</a> . </p><br><h3 id="ot-perevodchika">  From translator </h3><br><p>  Thanks to the author, who kindly agreed to the translation and publication here.  You can contact him directly on Twitter: <a href="https://twitter.com/mrafayaleem">mrafayaleem</a> .  And if you want to develop similar services, check out our vacancies on My Circle: we in Avito need developers of highly loaded systems, including billing developers. </p><br><p>  Have you encountered such problems?  Let's discuss in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336508/">https://habr.com/ru/post/336508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336498/index.html">Know your tool: Event Loop in libuv</a></li>
<li><a href="../336500/index.html">PHP Digest number 115 - the latest news, materials and tools (August 14 - 27, 2017)</a></li>
<li><a href="../336502/index.html">Revit API Vector Geometry for Developers</a></li>
<li><a href="../336504/index.html">Check dependency injection on Swift</a></li>
<li><a href="../336506/index.html">XBRL: just about the complex - Chapter 6. Immersion in XBRL - Part 5. New dimensions</a></li>
<li><a href="../336512/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ277 (August 21 - 27, 2017)</a></li>
<li><a href="../336514/index.html">Kim Dotcom was returned part of the confiscated property</a></li>
<li><a href="../336516/index.html">Text independent voice identification</a></li>
<li><a href="../336518/index.html">What to expect from Apple: the main thing about iOS, macOS, Watch 3, iPhone 8</a></li>
<li><a href="../336520/index.html">DevOps Evolution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>