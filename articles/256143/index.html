<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interactive gender on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably many of you have seen interactive games for children in shopping centers. Where the dynamic scene is projected on the floor, and next to it, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interactive gender on Android</h1><div class="post__text post__text-html js-mediator-article">  Probably many of you have seen interactive games for children in shopping centers.  Where the dynamic scene is projected on the floor, and next to it, the installed sensor determines the touch points with the surface and converts them into events for the application on the control computer.  After searching the Internet for information about this device, it turned out that it was a rather expensive toy.  For example, Chinese clones start at a price tag of $ 1,200, but something more original costs already $ 10,000. After analyzing the technical component of the product, it was decided to make a similar device myself. <br><br>  Iron project consists of three parts: <br><ul><li>  Depth sensor (original is ASUS Xtion); </li><li>  Control computer (Cubieboard A80, ODROID-U3); </li><li>  Projector. </li></ul><br><a name="habracut"></a><br><img src="https://habrastorage.org/files/e12/cc4/ec5/e12cc4ec57d14d998410c7845092f32c.gif"><br><br>  Ideally, all the glands together should not cost more than 700 dollars.  It was assumed that connecting all three parts should be relatively easy, as there are such libraries on the Internet as OpenNI and libfreenect, which work on both Android and Linux.  Due to the lack of experience at an early stage, it seemed that there was a choice in hardware and OS;  There are examples of open source and combine everything together is not difficult.  Some time after the start of the project, it turned out that this was not the case.  Integrating all the parts and even running the libraries on the target device is the most difficult task.  I had to choose between the availability of information on setting up Linux and the abundance of applications in the market for the Android platform. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, first things first. <br><br>  In order to immediately start experimenting with hardware, a used Microsoft Kinect sensor and a projector were purchased.  Then, a mounting for a projector and a sensor was made from a square shaped tube: <br><br><img src="https://habrastorage.org/files/cab/440/72a/cab44072aa464b1d9bb48178a26f4e84.JPG"><br><br>  In the upper part of the mount a small piece of the welded corner is mounted to the ceiling.  Plates in the form of kerchiefs are welded in places at the bends of the pipe to strengthen the structure.  The projector is connected to the mount through a triangular plate of plywood.  To connect the sensor with the mount, a special Kinect accessory is used, which can be easily found on ebay.  To reduce the cost, the <a href="">Cubieboard A10</a> board was chosen as the controlling computer, which can also be easily found on ebay.  At the time of this writing, the Cubieboard A20 and A80, two and eight-core counterparts, have already been released.  If the budget allows, it is advisable to buy A80, so that the system has a power reserve for the simultaneous operation of user applications and services for capturing and processing data from the depth sensor.  The power supply of the board and the sensor is <a href="">controlled by a USB power supply</a> with an output current of 4A.  The projector and the sensor are connected to the mount so that the depth camera is in the same plane as the projector lens: <br><br><img src="https://habrastorage.org/files/278/e7b/3f5/278e7b3f583149ebbe58fa571e852a7a.png"><br><br>  The model of the projector is better to choose such that the picture is as large as possible from a small distance.  On this description of the iron parts can be completed.  Now about the software. <br><br>  The operating system was chosen to build Android under Cubieboard with a funny <a href="">screensaver</a> on the desktop.  I had to tweak the configuration files a bit and compile the assembly myself due to the fact that in Android it is impossible to change the sequence of loading modules, or rather, you can, but until the next system reboot. <br><br>  To implement the events, the sun4i-ts touch screen driver module was required.  In fact, the test application implements the TUIO client, but as it turned out, even with the touchpad driver, the existing TUIO server for Android does not support multitouch events.  Perhaps this is due to the touchpad driver sun4i-ts under Allwinner.  Based on these facts, the option of direct implementation of the events was chosen. <br><br>  To capture depth data, the lightweight and fast libfreenect library is used, which in turn uses libusb to transfer data via USB.  Depth data is processed using OpenCV for Android.  The essence of processing is quite simple: it is necessary to convert the depth map into closed contours with a length not less than the threshold one, in order to eliminate false alarms - and find their geometric centers. <br><br>  At the very beginning of work, when there are no objects on the scene, the application builds a background depth map, then in the process, the map is used to separate the target objects from the background.  The application is a control part and service with C / C ++ code.  All logic for processing and capturing depth data is implemented in C / C ++.  Part of the code for working with TUIO and OpenCV was taken from this <a href="https://github.com/robbeofficial/KinectTouch">project</a> on github. <br><br>  Consider the code in more detail.  In the code, as I said, OpenCV is used.  At the very beginning of the work, the application builds a depth map: <br><br><pre><code class="hljs haskell"><span class="hljs-number"><span class="hljs-number">1</span></span> void <span class="hljs-type"><span class="hljs-type">STouchDetector</span></span>::process(const uint16_t&amp; depthData) { <span class="hljs-number"><span class="hljs-number">2</span></span> frmCount++; <span class="hljs-number"><span class="hljs-number">3</span></span> // create background model (average depth) <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (frmCount &lt; <span class="hljs-type"><span class="hljs-type">BackgroundTrain</span></span>) { <span class="hljs-number"><span class="hljs-number">5</span></span> depth.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uchar</span></span></span><span class="hljs-class">*)(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">depthData</span></span></span><span class="hljs-class">); 6 buffer[frmCount] = depth; 7 } 8 else { 9 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frmCount</span></span></span><span class="hljs-class"> == </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BackgroundTrain</span></span></span><span class="hljs-class">) { 10 // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Calculate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">average</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">depth</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">based</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frames</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class"> 11 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">average</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buffer</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">background</span></span></span><span class="hljs-class">); 12 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Scalar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmeanVal</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">background</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">roi</span></span></span><span class="hljs-class">)); 13 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">double</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bminVal</span></span></span><span class="hljs-class"> = 0.0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmaxVal</span></span></span><span class="hljs-class"> = 0.0; 14 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">minMaxLoc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">background</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">roi</span></span></span><span class="hljs-class">), &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bminVal</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmaxVal</span></span></span><span class="hljs-class">); 15 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LOGD</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Background</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extraction</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">completed</span></span></span><span class="hljs-class">. </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Average</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">depth</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> %</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> %</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">max</span></span></span><span class="hljs-class"> %</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmeanVal</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class">[0], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bminVal</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bmaxVal</span></span></span><span class="hljs-class">); 16 }</span></span></code> </pre> <br>  In line 6, the depth data is stored in a buffer.  It should be noted that the buffer is of type std :: vector &lt;cv :: Mat1s&gt;.  This is an array of matrices and the assignment in line 6 is actually copying all the pixels of the frame into the buffer.  After the frame counter reaches the threshold, the BackgroundTrain function calls the function to calculate the average depth value for all frames in line 11: <br><br><pre> <code class="hljs matlab"><span class="hljs-number"><span class="hljs-number">1</span></span> void STouchDetector::average(vector&lt;Mat1s&gt;&amp; frames, Mat1s&amp; <span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>) { <span class="hljs-number"><span class="hljs-number">2</span></span> Mat1d acc(<span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>()); <span class="hljs-number"><span class="hljs-number">3</span></span> Mat1d frame(<span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>()); <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (unsigned int <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>&lt;frames.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">i</span></span>++) { <span class="hljs-number"><span class="hljs-number">5</span></span> frames[<span class="hljs-built_in"><span class="hljs-built_in">i</span></span>].convertTo(frame, CV_64FC1); <span class="hljs-number"><span class="hljs-number">6</span></span> acc = acc + frame; <span class="hljs-number"><span class="hljs-number">7</span></span> } <span class="hljs-number"><span class="hljs-number">8</span></span> acc = acc / frames.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>(); <span class="hljs-number"><span class="hljs-number">9</span></span> acc.convertTo(<span class="hljs-built_in"><span class="hljs-built_in">mean</span></span>, CV_16SC1); <span class="hljs-number"><span class="hljs-number">10</span></span> }</code> </pre><br>  In the function above, the matrix of double-byte integers is transformed into a matrix of floating-point numbers, then the accumulator is added to the matrix and, at the end, the average is calculated.  In line 8, the division operation is performed for each element of the matrix. <br><br>  In the next part of the code, objects are selected using the previously created depth background in line 4. Then, using the OpenCV function, findContours () contours are selected.  For contours with a length greater than the threshold, their geometric center is calculated.  The coordinates of the obtained centers are added to the array of touchPoints, which stores the coordinates of the click events on the surface: <br><br><pre> <code class="hljs haskell"><span class="hljs-number"><span class="hljs-number">1</span></span> // <span class="hljs-type"><span class="hljs-type">Update</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> bit depth matrix <span class="hljs-number"><span class="hljs-number">2</span></span> depth.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uchar</span></span></span><span class="hljs-class">*)(&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">depthData</span></span></span><span class="hljs-class">); 3 // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Extract</span></span></span><span class="hljs-class"> foreground by simple subtraction of very basic background model 4 foreground = background - depth; 5 6 // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Find</span></span></span><span class="hljs-class"> touch mask by thresholding (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">points</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">that</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">are</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">close</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">background</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">touch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">points</span></span></span><span class="hljs-class">) 7 touch = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreground</span></span></span><span class="hljs-class"> &gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TouchDepthMin</span></span></span><span class="hljs-class">) &amp; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foreground</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TouchDepthMax</span></span></span><span class="hljs-class">); 8 9 // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Extract</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ROI</span></span></span><span class="hljs-class"> 10 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Mat</span></span></span><span class="hljs-class"> touchRoi = touch(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">roi</span></span></span><span class="hljs-class">); 11 12 // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Find</span></span></span><span class="hljs-class"> contours by depth </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> 13 vector&lt; vector&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Point2i</span></span></span><span class="hljs-class">&gt; &gt; contours; 14 vector&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Point2f</span></span></span><span class="hljs-class">&gt; touchPoints; 15 findContours(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">touchRoi</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contours</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CV_RETR_LIST</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CV_CHAIN_APPROX_SIMPLE</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Point2i</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">xMin</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">yMin</span></span></span><span class="hljs-class">)); 16 17 for (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unsigned</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">=0; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contours</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class">(); i++) { 18 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Mat</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contourMat</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contours</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">]); 19 // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Find</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">touch</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">points</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">by</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">area</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thresholding</span></span></span><span class="hljs-class"> 20 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> ( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contourArea</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contourMat</span></span></span><span class="hljs-class">) &gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ContourAreaThreshold</span></span></span><span class="hljs-class"> ) { 21 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Scalar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mean</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">contourMat</span></span></span><span class="hljs-class">); 22 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Point2i</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">touchPoint</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class">[0], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">center</span></span></span><span class="hljs-class">[1]); 23 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">touchPoints</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">push_back</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">touchPoint</span></span></span><span class="hljs-class">); 24 } 25 }</span></span></code> </pre><br>  In the last part, events are sent to the system.  The coordinates for the surface pressure events are taken from the previously created touchPoints array. <br><br><pre> <code class="hljs haskell"><span class="hljs-number"><span class="hljs-number">1</span></span> // <span class="hljs-type"><span class="hljs-type">Send</span></span> <span class="hljs-type"><span class="hljs-type">TUIO</span></span> cursors <span class="hljs-number"><span class="hljs-number">2</span></span> tuioTime = <span class="hljs-type"><span class="hljs-type">TuioTime</span></span>::getSessionTime(); <span class="hljs-number"><span class="hljs-number">3</span></span> tuio-&gt;initFrame(tuioTime); <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> for (unsigned int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; touchPoints.size(); i++) { // touch points <span class="hljs-number"><span class="hljs-number">6</span></span> float cursorX = (touchPoints[i].x - xMin) / (xMax - xMin); <span class="hljs-number"><span class="hljs-number">7</span></span> float cursorY = <span class="hljs-number"><span class="hljs-number">1</span></span> - (touchPoints[i].y - yMin) / (yMax - yMin); <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-type"><span class="hljs-type">TuioCursor</span></span>* cursor = tuio-&gt;getClosestTuioCursor(cursorX,cursorY); <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-type"><span class="hljs-type">LOGD</span></span>(<span class="hljs-string"><span class="hljs-string">"Touch detected %d %d"</span></span>, (int)touchPoints[i].x, (int)touchPoints[i].y); <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> // <span class="hljs-type"><span class="hljs-type">TODO</span></span> improve tracking (don't move cursors away, that might be closer to another touch point) <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cursor == nullptr || cursor-&gt;getTuioTime() == tuioTime) { <span class="hljs-number"><span class="hljs-number">14</span></span> tuio-&gt;addTuioCursor(cursorX,cursorY); <span class="hljs-number"><span class="hljs-number">15</span></span> eventInjector-&gt;sendEventToTouchDevice((int)(touchPoints[i].x - xMin), <span class="hljs-number"><span class="hljs-number">16</span></span> (int)(touchPoints[i].y - yMin)); <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-type"><span class="hljs-type">LOGD</span></span>(<span class="hljs-string"><span class="hljs-string">"TUIO cursor was added at %d %d"</span></span>, (int)touchPoints[i].x, (int)touchPoints[i].y); <span class="hljs-number"><span class="hljs-number">18</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-number"><span class="hljs-number">19</span></span> tuio-&gt;updateTuioCursor(cursor, cursorX, cursorY); <span class="hljs-number"><span class="hljs-number">20</span></span> } <span class="hljs-number"><span class="hljs-number">21</span></span> }</code> </pre><br>  The function sendEventToTouchDriver () is called to send events to the system, and the functions addTuioCursor () and updateTuioCursor () are called to send a message to TUIO server. <br><br>  At the end of the discussion of the code I would like to talk about the event sending module of the system.  The module is called stouchEventInjector.cpp.  At the very beginning of work in the constructor, using the open () function, the input device event file / dev / input / eventX is opened, where X is a number.  The module itself tries to find the descriptor associated with the required driver (sun4i_ts).  To do this, the getevent function is called sequentially with the -pl switch for each existing / dev / input / eventX file.  Sending an event is actually writing to the / dev / input / eventX file of the uinput_event structure using the write () function.  The touchscreen has its own coordinate system with a maximum and minimum value along the axes; in the case of sun4i-ts, the maximum number on both axes oh and oy is 4095. The sequence of commands that you need to send to simulate pressing the touchscreen can be found in the source code in the sendTouchDownAbs function ( ). <br><br>  To automatically start the touchscreen driver after the device starts, as I said at the beginning, you need to change the Android build configuration.  To build Android, the latest version of Ubuntu in my case was version 14.10.  The source code is taken from here <a href="http://docs.cubieboard.org/tutorials/cb1/installation/building_android_ics_a10_image">Cubieboard A10 Android</a> and unpack.  We need to change two files: <br><br><pre> <code class="hljs kotlin">android/device/softwinner/apollo-cubieboard/<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>.sun4i.rc android/frameworks/base/<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>/etc/platform.xml</code> </pre><br>  In the file init.sun4i.rc you need to uncomment the line insmod /system/vendor/modules/sun4i-ts.ko.  In the platform.xml file, you need to add usb, input and shell groups to the INTERNET section: <br><br><pre> <code class="hljs cs"> &lt;<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> gid=<span class="hljs-string"><span class="hljs-string">"usb"</span></span>/&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> gid=<span class="hljs-string"><span class="hljs-string">"input"</span></span>/&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> gid=<span class="hljs-string"><span class="hljs-string">"shell"</span></span>/&gt;</code> </pre><br>  After making changes, run the assembly with the command: <br><br><pre> <code class="hljs">./build.sh -p sun4i_crane -k 3.0</code> </pre><br>  To build the Android ICS version, you need the GCC compiler version 4.6 and make version 3.81.  If the version of the compiler and make differs from the required one, then it can be changed with the commands: <br><br><pre> <code class="hljs go">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc<span class="hljs-number"><span class="hljs-number">-4.6</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span> --slave /usr/bin/g++ g++ /usr/bin/g++<span class="hljs-number"><span class="hljs-number">-4.6</span></span> sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc<span class="hljs-number"><span class="hljs-number">-4.9</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> --slave /usr/bin/g++ g++ /usr/bin/g++<span class="hljs-number"><span class="hljs-number">-4.9</span></span> sudo update-alternatives --config gcc sudo mv /usr/bin/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> /usr/bin/make40 sudo update-alternatives --install /usr/bin/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> /usr/local/bin/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span> sudo update-alternatives --install /usr/bin/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span> <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> /usr/bin/make40 <span class="hljs-number"><span class="hljs-number">40</span></span> sudo update-alternatives --config <span class="hljs-built_in"><span class="hljs-built_in">make</span></span></code> </pre><br>  Then follow the instructions on the page <a href="http://docs.cubieboard.org/tutorials/cb1/installation/building_android_ics_a10_image">Cubieboard A10 Android</a> .  Compilation errors may occur during the build process.  Error correction hints can be found in the Fix building issues section in the fix_android_firmware.readme file in the source code repository.  To connect the board to the PC, you need to add rules for connecting the device via USB. To do this, create a file: <br><br><pre> <code class="hljs"> /etc/udev/rules.d/51-android.rules</code> </pre><br>  And add the following line: <br><br><pre> <code class="hljs objectivec">SUBSYSTEM==<span class="hljs-string"><span class="hljs-string">"usb"</span></span>, ATTRS{idVendor}==<span class="hljs-string"><span class="hljs-string">"18d1"</span></span>, ATTRS{idProduct}==<span class="hljs-string"><span class="hljs-string">"0003"</span></span>,MODE=<span class="hljs-string"><span class="hljs-string">"0666"</span></span></code> </pre><br>  For the changes to take effect, restart the udev service: <br><br><pre> <code class="hljs perl">$sudo <span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> a+rx /etc/udev/rules.d/<span class="hljs-number"><span class="hljs-number">51</span></span>-android.rules $sudo service udev restart</code> </pre><br>  We connect the board to the PC and upload the sun4i_crane_cubieboard.img firmware image using the <a href="">LiveSuit</a> utility.  Before installing, carefully read the instructions for LiveSuit, if installed incorrectly, the application will not be able to download the image to the device.  After downloading the image and restarting the board, you can install and run the SimpleTouch application.  The application will automatically start a service that captures / processes data from Kinect and sends events to the system.  The application can simply be minimized and run any game from PlayMarket. <br><br>  Source code can be downloaded from <a href="https://rdv0011%40bitbucket.org/rdv0011/stouch_public">bitbucket</a> . <br><br>  Work demo video: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/HVdO2DluagE%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhj7MjUub_LeGZQKNJBU65lR1QpPLg" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/256143/">https://habr.com/ru/post/256143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256131/index.html">The digest of events from the world D</a></li>
<li><a href="../256133/index.html">Apple Watch's first successes, App Annie and Tapjoy reports, Europe vs. Google - and other news of the week for a mobile developer</a></li>
<li><a href="../256137/index.html">API and SOA Management</a></li>
<li><a href="../256139/index.html">ASA5525-X + MS CA Windows Server 2012R2 - two-factor authentication</a></li>
<li><a href="../256141/index.html">VIII Annual Conference "Embedded Technologies 2015"</a></li>
<li><a href="../256145/index.html">How to assemble a robot with your own hands in 6 hours and become the soul of the company</a></li>
<li><a href="../256147/index.html">How to catch what is not. Part Five: The Myth of the Need for Certified Software</a></li>
<li><a href="../256151/index.html">DLang plugin for IntelliJ IDEA (Alpha, EAP, POC)</a></li>
<li><a href="../256155/index.html">Friday to Monday Night: How We Launched Skyforge</a></li>
<li><a href="../256157/index.html">Weekly assembly Vivaldi 1.0.156.2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>