<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We configure authorization in IIS according to certificates using OneToOne</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all. It just so happened that at work it was necessary to set up a server with IIS, and not just to set up, but hang up authorization for ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We configure authorization in IIS according to certificates using OneToOne</h1><div class="post__text post__text-html js-mediator-article">  Good day to all.  It just so happened that at work it was necessary to set up a server with IIS, and not just to set up, but hang up authorization for different services using only a specific certificate service.  This problem can be solved using several generation centers, but we will not complicate everything and proceed to setting up the ‚ÄúOne-way‚Äù of our IIS. <br><a name="habracut"></a><br>  The generation of the necessary keys is described in great detail on the Internet (the <a href="http://habrahabr.ru/post/96827/">article</a> on Habr√©) and should not cause any special problems, therefore I will omit this part. <br><br>  Getting down to business: <br>  1) Install IIS and necessary components.  Be sure to check "Authentication with IIS client certificate mapping". <br><br><img src="https://habrastorage.org/files/ab9/8ae/2ad/ab98ae2ad6154c9085eae7bdafb99304.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      2) To bind, we need a client certificate encoded in base64, it is very easy to export from the certificate (certmgr.msc) "Certificates" or from "Internet Options". <br><br><img src="https://habrastorage.org/files/14a/d01/077/14ad01077f5e420da15f63fa6f5b4afd.png"><br><br>  3) The received certificate is opened in a text editor and we stand in one line, after deleting the lines "BEGIN CERTIFICATE" and "END CERTIFICATE". <br><br><img src="https://habrastorage.org/files/eca/d7c/7a2/ecad7c7a231f446a80d4f7b44fafaee9.png"><br><br>  With the preparation finished go to the server. <br><br>  4) Run the toolbar (inetmgr) "IIS Manager", and install the server certificate.  In my case, the CN certificate is Localhost. <br><br><img src="https://habrastorage.org/files/8ed/720/9f5/8ed7209f566942118a0e3bf460e52b5d.png"><br><br>  5) After that we can bind this certificate to services.  Go to the bindings and select Https and specify the desired port and certificate. <br><br>  6) In the SSL settings, check ‚ÄúRequire SSL‚Äù and client certificate ‚Äúrequire‚Äù. <br><br><img src="https://habrastorage.org/files/85a/f1b/881/85af1b88161b41208c6b8983e6d42ce6.png"><br><br>  7) Now any certificate issued by our CA is suitable for authorization, but the purpose of this article is to show the next step when clients with certificates need to be divided.  Go to the "Configuration Editor" at: "system.webServer / security / authentication / iisClientCertificateMappingAuthentication". <br><br><img src="https://habrastorage.org/files/8b0/e3c/652/8b0e3c6521fa4883b32bf04f0f437c3f.png"><br><br>  8) Here you have to make a choice, or we let on specific certificates or a specific field in the certificate (for example, a unique OID). <br><br>  9) Consider the "oneToOneCertificateMappingsEnabled" parameter.  By setting its value to ‚ÄúTrue‚Äù we will be able to bind a specific certificate to a user. <br><br><img src="https://habrastorage.org/files/808/66f/902/80866f902ef748cc973c513f1b14cd94.png"><br><br>  10) The certificate received on the second paragraph is inserted into the ‚Äúcertificate‚Äù field.  The ‚ÄúuserName‚Äù and ‚Äúpassword‚Äù fields are filled with the account that you previously created. <br><br>  11) Now, upon presentation of the registered client certificate, we will get access with the rights of the specified account.  However, all other certificates will continue to work quietly and get anonymous access, to avoid this it is necessary in iis to disable anonymous authentication. <br><br><img src="https://habrastorage.org/files/68e/c29/b00/68ec29b004ae4e7daa9aa6ec86dcc271.png"><br><br>  At this stage, authorization should take place only on the specified certificate. <br><br>  Code for appcmd: <br><br><pre><code class="go hljs">appcmd.exe set config <span class="hljs-string"><span class="hljs-string">"Default Web Site"</span></span> -section:system.webServer/security/authentication/iisClientCertificateMappingAuthentication /enabled:<span class="hljs-string"><span class="hljs-string">"True"</span></span> /oneToOneCertificateMappingsEnabled:<span class="hljs-string"><span class="hljs-string">"True"</span></span> /commit:apphost appcmd.exe set config <span class="hljs-string"><span class="hljs-string">"Default Web Site"</span></span> -section:system.webServer/security/authentication/iisClientCertificateMappingAuthentication /+<span class="hljs-string"><span class="hljs-string">"oneToOneMappings.[userName='22',password='22',certificate='    base64']"</span></span> /commit:apphost appcmd.exe set config <span class="hljs-string"><span class="hljs-string">"Default Web Site"</span></span> -section:system.webServer/security/access /sslFlags:<span class="hljs-string"><span class="hljs-string">"Ssl, SslNegotiateCert, SslRequireCert"</span></span> /commit:apphost</code> </pre> </div><p>Source: <a href="https://habr.com/ru/post/249503/">https://habr.com/ru/post/249503/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249491/index.html">Easy way to migrate virtual machines from VirtualBox to VMware ESXi 5.5</a></li>
<li><a href="../249495/index.html">Vivaldi. We remove the thumbnails from the sidebar and a few more settings</a></li>
<li><a href="../249497/index.html">DevExtreme: filter the data on the chart</a></li>
<li><a href="../249499/index.html">Checking MatrixSSL with PVS-Studio and Cppcheck</a></li>
<li><a href="../249501/index.html">The most effective in terms of speed of work - server scheme for client-server 1C 8.x</a></li>
<li><a href="../249507/index.html">How I was looking for an idea for the first project on Arduino or Wake-on-LAN on Arduino.</a></li>
<li><a href="../249509/index.html">GPS control for personal use (Conclusion)</a></li>
<li><a href="../249511/index.html">Acronis True Image (for Windows) usage example for Mac computers</a></li>
<li><a href="../249513/index.html">Vulnerability on the site Dom.ru, allowing to obtain personal customer data</a></li>
<li><a href="../249515/index.html">ssh: We pull out a foreign port for ourselves because of NAT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>