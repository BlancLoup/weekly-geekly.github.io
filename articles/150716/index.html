<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple way to organize an e-mail queue with Zend_Mail</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 I want to share a very simple and easy way to organize an e-mail queue using Zend_Mail. The examples in the article are intentionally made a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple way to organize an e-mail queue with Zend_Mail</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  I want to share a very simple and easy way to organize an e-mail queue using Zend_Mail.  The examples in the article are intentionally made as simple as possible and are not tied to the framework, since  the purpose of the article is to show the way, not the concrete implementation.  In addition, this solution does not necessarily have to be used only within the Zend Framework, it will easily fit into any project. <br><a name="habracut"></a><br>  Immediately to the point.  We will need: <br>  - table in the database; <br>  - class of transport; <br>  - a file that implements sending messages (runs on the crown). <br><br>  First we define the database table: <br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> email_queue ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, recipients <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, subject <span class="hljs-built_in"><span class="hljs-built_in">CHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, message <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, header <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">parameters</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TEXT</span></span>, max_attempts TINYINT <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>, attempts TINYINT <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, is_false TINYINT(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, in_process <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, time_last_attempt <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, create_time <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> );</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Next, create a class of our transport: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailQueueTransport</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Zend_Mail_Transport_Sendmail</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Send mail using EmailQueue * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@access</span></span></span><span class="hljs-comment"> public * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> Zend_Mail_Transport_Exception If parameters is set but not a string * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> Zend_Mail_Transport_Exception If failed to add a message in queue */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_sendMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;parameters !== <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !is_string(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;parameters)) { <span class="hljs-comment"><span class="hljs-comment">/** * Exception is thrown here because $parameters is a public property */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Zend_Mail_Transport_Exception(<span class="hljs-string"><span class="hljs-string">'Parameters were set but are not a string'</span></span>); } $db = Zend_Db_Table_Abstract::getDefaultAdapter(); $statement = $db-&gt;prepare(<span class="hljs-string"><span class="hljs-string">' INSERT email_queue SET recipients = :recipients, subject = :subject, message = :message, header = :header, parameters = :parameters, create_time = :create_time '</span></span>); $result = $statement-&gt;execute(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'recipients'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;recipients, <span class="hljs-string"><span class="hljs-string">'subject'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_mail-&gt;getSubject(), <span class="hljs-string"><span class="hljs-string">'message'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;body, <span class="hljs-string"><span class="hljs-string">'header'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;header, <span class="hljs-string"><span class="hljs-string">'parameters'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;parameters, <span class="hljs-string"><span class="hljs-string">'create_time'</span></span> =&gt; time() )); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$result) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Zend_Mail_Transport_Exception( <span class="hljs-string"><span class="hljs-string">'Failed to add a message in queue.'</span></span>); } } }</code> </pre><br>  All that this class does is get the already prepared data from Zend_Mail and save it to the database.  If creating an entry in the table failed, throws a Zend_Mail_Transport_Exception exception. <br><br>  Well, the file that implements sending messages, suppose that the file is in a separate folder, in the application root: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * Add the messages in the log * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> type $message * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> void */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_log</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($message)</span></span></span><span class="hljs-function"> </span></span>{ $message = date(<span class="hljs-string"><span class="hljs-string">'H:i dmY '</span></span>, time()) . $message . <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>; $logFile = dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . DIRECTORY_SEPARATOR . <span class="hljs-string"><span class="hljs-string">'logs'</span></span> . DIRECTORY_SEPARATOR . basename(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>, <span class="hljs-string"><span class="hljs-string">'.php'</span></span>) . <span class="hljs-string"><span class="hljs-string">'.log'</span></span>; error_log($message, <span class="hljs-number"><span class="hljs-number">3</span></span>, $logFile); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $config = <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> realpath(dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/../'</span></span>) . <span class="hljs-string"><span class="hljs-string">'/application/config/config.php'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Path to config file $configDb = $config['db']['params']; $db = new PDO( 'mysql:host=' . $configDb['host'] . ';dbname=' . $configDb['dbname'], $configDb['username'], $configDb['password'], array( PDO::MYSQL_ATTR_INIT_COMMAND =&gt; "SET NAMES 'utf8'", 'profiler' =&gt; false, ) ); } catch (PDOException $e) { set_log('Connection error: ' . $e-&gt;getMessage()); } $limit = 100; // limit rows $processLimitTime = 600; // 10 minutes $statement = $db-&gt;query(' SELECT * FROM email_queue WHERE attempts &lt; max_attempts AND in_process &lt; ' . (time() - $processLimitTime) . ' ORDER BY id ASC LIMIT ' . $limit ); $rows = $statement-&gt;fetchAll(PDO::FETCH_ASSOC); foreach ($rows as $row) { $db-&gt;beginTransaction(); $result = $db-&gt;exec(' UPDATE email_queue SET in_process = ' . time() . ' WHERE id = ' . $row['id'] ); if (!$result) { set_log('Error when updating record from the table "email_queue". Id queue is ' . $row['id'] . '.'); continue; } $isSent = mail( $row['recipients'], $row['subject'], $row['message'], $row['header'], $row['parameters'] ); $db-&gt;commit(); if ($isSent) { $result = $db-&gt;exec('DELETE from email_queue WHERE id = ' . $row['id']); if (!$result) { set_log('Error when deleting record from the table "email_queue". Id queue is ' . $row['id'] . '.'); } } else { $result = $db-&gt;exec(' UPDATE email_queue SET is_false = 1, in_process = 0, attempts = ' . ($row['attempts'] + 1) . ' WHERE id = ' . $row['id'] ); if (!$result) { set_log('Error when updating record from the table "email_queue". Id queue is ' . $row['id'] . '.'); } set_log('Error when sending messages to e-mail. Id queue is ' . $row['id'] . ', e-mails is ' . $row['recipients'] . '.'); } }</span></span></code> </pre><br>  Use Queue: <br><pre> <code class="php hljs">$mail = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Zend_Mail(); $mail-&gt;setFrom($from); $mail-&gt;addTo($to); $mail-&gt;setBodyHtml($body); $mail-&gt;setSubject($subject); $transport = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \EmailQueueTransport(); $mail-&gt;send($transport);</code> </pre><br>  Accordingly, if you need to send a message out of turn, via mail () - do not pass the transport or pass null. <br><br>  PS Perhaps someone will find it more correct to use Zend_Queue, and it may be right.  I am by no means arguing that the method described in the article is the only correct solution.  There are always many solutions, I have described only one of them. <br><br>  PPS Special thanks for the useful comments from <a href="http://habrahabr.ru/users/markpnk/" class="user_link">markPnk</a> and <a href="http://habrahabr.ru/users/gen/" class="user_link">gen</a> users. </div><p>Source: <a href="https://habr.com/ru/post/150716/">https://habr.com/ru/post/150716/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150708/index.html">MIMB - Multi-installation and multi-boot flash drive</a></li>
<li><a href="../150709/index.html">Announced hybrid smartphone reader with e-ink</a></li>
<li><a href="../150712/index.html">How to open a coworking center: a detailed guide</a></li>
<li><a href="../150713/index.html">How I Fought Contexts</a></li>
<li><a href="../150715/index.html">Md5-hash calculation for mp3-file</a></li>
<li><a href="../150719/index.html">Dell Technology Park at IFA 2012</a></li>
<li><a href="../150720/index.html">The selector of generalized related elements</a></li>
<li><a href="../150722/index.html">What killed Linux Desktop (version of Miguel de Icaza)</a></li>
<li><a href="../150724/index.html">Convenient classes for getting IM statuses in PHP</a></li>
<li><a href="../150725/index.html">Building Distributed Data Center (DC Interconnect, DCI)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>