<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a script for publishing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From time to time the task appears: to make a script for the publication, which needs to be updated but cannot be changed. For example, it can be an i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a script for publishing</h1><div class="post__text post__text-html js-mediator-article">  From time to time the task appears: to make a script for the publication, which needs to be updated but cannot be changed.  For example, it can be an initialization script, wired inside a virtual machine image or a script to install the site engine (published by the engine developer). <br><br>  In the article I will talk about the techniques that I use to create such scripts, they will help to avoid some rakes, to preserve the simplicity and flexibility of scripts.  The approach is suitable for those scripts whose behavior should change depending on the needs of the author, updates, etc.  The approach is NOT suitable for scripts that should work autonomously (without communication with the author's system). <br><br>  I use this approach in bash scripts, but the general principle can be applied regardless of the language. <br><a name="habracut"></a><br><h5>  Short prehistory (you can skip): </h5><br>  A few years ago I began to make templates of VDS-servers for mass use by clients.  After creating a template, changing it is no longer possible;  the only way to correct the error is to publish a new template, which costs time and a lot of gigabytes of space (template + copies on all servers).  In these few years, it has turned out to make some uncomfortable mistakes, and as a result, now many more years will have to maintain patterns with uncomfortable behavior at the start. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A similar situation can happen with the installation / configuration scripts of control panels, site engines, just programs that need to be downloaded, configured and configured one at a time.  Despite the fact that the program itself can be updated, and everyone who downloaded it already has no access to the installation script fix. <br><br>  Some of what I use was seen in similar scripts, for example, installers ispsystem, brew.  The part was prompted by colleagues and the part is acquired by their own bitter experience. <br><br><h5>  General essence </h5><br>  Every time, download and execute all the code from your server. <br><br><h5>  General code structure </h5><br>  Published script - only loads the first file of the executable code, nothing else is done. <br>  The first file of the executable code - immediately does what it needs (in simple cases) or determines something in common and loads new files. <br>  The rest of the files are organized in any convenient manner, it can be changed already in the process of work. <br><br><h5>  What should and should not be done by the published script </h5><br>  The published script in no case should perform the task for which it is published and should not even have a hint of its solution.  The only task of this script is to find a way to connect to the developer‚Äôs server and download the code to execute from there.  This code should be as simple as possible with a minimum of external dependencies, since  they will have to be maintained throughout the life of the script. <br><br><div class="spoiler">  <b class="spoiler_title">Here is the code I came to in the end.</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">try</span></span></span></span>() { <span class="hljs-comment"><span class="hljs-comment">#  ,    -    ,      ...   ,    } # Execute init.sh from panel function execute_init() { local EVAL_CODE=`curl http://panel.1gb.ru/minimal/init.sh` if [ "${EVAL_CODE#\#\!/bin/bash}" != "$EVAL_CODE" ] &amp;&amp; [ "${EVAL_CODE%\#BashScriptEnd}" != "$EVAL_CODE" ]; then eval "$EVAL_CODE" return 0 else return 1 fi } try 100000 execute_init</span></span></code> </pre> <br></div></div><br><br>  I put this code in a template with a previously known environment, in particular, I know for sure that curl is there, but many attempts are necessary since  when the server starts, the network may not work or the http server may temporarily generate an error.  Other scripts may work in different environments and there may not be curl there.  This is a good place to try to connect to the server in many ways, if necessary many times. <br><br>  It is necessary to check that the code for execution has been loaded entirely - a long line with if does exactly the check: it checks that the script starts with #! / Bin / bash and ends with #BashScriptEnd.  So you can be sure that the HTML error code or half-script will not be executed by cutting rm -rf / tmp / my-downloads to rm -rf / <br><br>  I didn‚Äôt intentionally do more complex checks in this place - TCP in this case provides reasonable protection against data damage, and then any complication of the external interface will have to be maintained forever. <br><br>  This script has only one external dependency - the URL.  In the future, even then he had to change - with the improvement of the organization of the code, but the dependence is so simple that it is simple to maintain it.  Moreover, in the new scripts, this is also the path used that has developed historically, and not the new ‚Äúcorrect‚Äù one.  Because in case of changes in the future, we would have to support two URLs, etc. <br><br>  The script should not have any attempts to define the environment and load, for example, init_linux.sh or init_freebsd.sh instead of init.sh - there was also such an attempt, it turned out that it was inconvenient and now it is necessary to support stubs for the old version of scripts. <br><br><h5>  What to put in the downloadable script </h5><br>  Here the freedom can be changed more without touching the already published part.  So if everything is simple - here you can immediately put the code that will be executed.  If something becomes complicated - it is easy to change in the future. <br><br>  If the complexity of the executed code is more than 1 file, I recommend placing it here: <br>  1. The function to download new files.  It will redefine how to connect to the server and in all the scripts you need to use it.  It is not suitable for the general library, since  it is not loaded yet. <br>  2. Call this function one / several times to connect and execute all the necessary files: general code library, specific code for the environment found, etc.  It may be possible to see which command is passed in the arguments and load the code for executing this command. <br><br><h5>  What to look for </h5><br><ul><li>  Always check loaded code before executing.  Otherwise, you can perform a half-script or some kind of error. </li><li>  In the published script, the minimum (ideally one) external dependency is the address from which the main code is loaded.  Always the same </li><li>  Always make several attempts to download each file.  Even if the work goes on the local network - there may be temporary server errors when it returns something wrong, such as an error.  Or even the connection will not accept.  If you have one downloadable file and the commands are executed manually, it may not be a problem.  But if the commands are built into the automation and there are a lot of connected files, the probability that the error will happen is very real.  The loading of a file is not entirely real either. </li><li>  Before publishing the script, be sure to check it - it is a shame when it was sealed in one character and because of this you need to redo a lot of work on preparing / checking the template or interact with those who recently gave the script </li></ul><br><br><h5>  Disadvantages and point of view on them </h5><br><ul><li>  The need to connect to the network (or the Internet).  In the context of applying this approach, you still have to download something from the developer‚Äôs server (including from your own if the system is used internally) and you still need the network.  The script will not be able to configure the local network if it does not work or set an access password if it cannot get it from the network.  Also, the script will not be able to deploy software / website from the developer‚Äôs server if it is not available. </li><li>  Execution of undefined code.  If this is your code, then everything is clear.  If this is someone else's code, it will still be launched / executed at that level of trust that is supposed to be.  If this is a client application installation - in the client environment and anyway, the developer inside his software can do anything and no one will check the entire code (if someone does - they will hardly use auto-deployment from third-party resources at all - only their own codes from their servers ) </li></ul></div><p>Source: <a href="https://habr.com/ru/post/230285/">https://habr.com/ru/post/230285/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230269/index.html">Building Reliable Web Applications with React: Part 4, Server Generation</a></li>
<li><a href="../230273/index.html">British special services Swiss knife: a set of tools for doing cyber war</a></li>
<li><a href="../230279/index.html">Facebook is testing the Buy button</a></li>
<li><a href="../230281/index.html">Bing has become the next search engine where you can request the removal of search results.</a></li>
<li><a href="../230283/index.html">Time versus memory using Java hash tables</a></li>
<li><a href="../230287/index.html">The interplanetary station Rosetta sent the clearest picture of the nucleus of comet Churyumov-Gerasimenko: the nucleus of the comet was doubled</a></li>
<li><a href="../230291/index.html">Testing the layout of the news site with responsive design</a></li>
<li><a href="../230293/index.html">The dark side of Google Play</a></li>
<li><a href="../230295/index.html">The next generation Raspberry Pi will be released no earlier than 2017</a></li>
<li><a href="../230299/index.html">Self-made autonomous flying machine from Android smartphone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>