<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>36 million requests per hour, 10,000+ constantly working clients, on one server, nginx + mysql</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A situation has arisen that I am participating in a project that works with a fairly large load. As already written - 36 million requests per hour. I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>36 million requests per hour, 10,000+ constantly working clients, on one server, nginx + mysql</h1><div class="post__text post__text-html js-mediator-article">  A situation has arisen that I am participating in a project that works with a fairly large load.  As already written - 36 million requests per hour.  I have read and tried many things over the last month, setting up a server;  I would just like to concisely and compactly issue the thesis that works well in this configuration. <br><br>  The first thing I noticed was a lot of tips on how to set everything up under a heavy load.  Read them carefully, usually in the text you will find that we are talking about a "high load" of 15-20 thousand clients per day.  We have about a million customers, active, daily. <br><br>  We have no money and we do everything at our own expense, so we save.  The result - all one million clients served on one server, here on this - <a href="http://ru.hetzner.com/hosting/produkte_rootserver/ex60">EX-60 on hetzner</a> . <br><a name="habracut"></a><br>  We accidentally made ourselves an analogue of DDoS through our clients and as a result of the settings, when there were 4000 php processes, the OS was also loaded under 4000, I managed to try many configurations and find the most working ones.  They coped with the error in the software, now these 10-12 thousand requests per second are processed with the load load average: 3.92, 3.22, 2.85.  Not one, of course, but for one server I consider it a good result. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Operating system - CentOS 7.1, 64 bits.  Minimal installation, plus iptables, nginx, php-fpm, mysql.  Kernel 4th version, from kernel-ml. <br><br>  Tuning kernel settings under high pressure tcp connections: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/sysctl.conf</b> <div class="spoiler_text">  fs.file-max = 1000000 <br>  net.ipv4.ip_local_port_range = 1024 65535 <br>  net.ipv4.conf.all.accept_redirects = 0 <br>  net.ipv4.conf.all.secure_redirects = 0 <br>  net.ipv4.conf.all.send_redirects = 0 <br>  net.ipv4.tcp_max_orphans = 65536 <br>  net.ipv4.tcp_fin_timeout = 30 <br>  net.ipv4.tcp_keepalive_time = 1800 <br>  net.ipv4.tcp_keepalive_intvl = 15 <br>  net.ipv4.tcp_keepalive_probes = 5 <br>  net.ipv4.tcp_max_syn_backlog = 65536 <br>  net.ipv4.tcp_synack_retries = 1 <br>  net.ipv4.tcp_mem = 50576 64768 98152 <br>  net.ipv4.tcp_rmem = 4096 87380 16777216 <br>  net.ipv4.tcp_wmem = 4096 65536 16777216 <br>  net.ipv4.tcp_orphan_retries = 0 <br>  net.ipv4.tcp_syncookies = 0 <br>  net.ipv4.netfilter.ip_conntrack_max = 1048576 <br>  net.ipv4.tcp_timestamps = 1 <br>  net.ipv4.tcp_sack = 1 <br>  net.ipv4.tcp_congestion_control = htcp <br>  net.ipv4.tcp_no_metrics_save = 1 <br>  net.ipv4.route.flush = 1 <br>  net.ipv4.conf.all.rp_filter = 1 <br>  net.ipv4.conf.lo.rp_filter = 1 <br>  net.ipv4.conf.eth0.rp_filter = 1 <br>  net.ipv4.conf.default.rp_filter = 1 <br>  net.ipv4.conf.all.accept_source_route = 0 <br>  net.ipv4.conf.lo.accept_source_route = 0 <br>  net.ipv4.conf.eth0.accept_source_route = 0 <br>  net.ipv4.conf.default.accept_source_route = 0 <br>  net.ipv4.tcp_tw_reuse = 1 <br>  net.ipv4.tcp_window_scaling = 1 <br>  net.ipv4.tcp_rfc1337 = 1 <br>  net.ipv4.ip_forward = 0 <br>  net.ipv4.icmp_echo_ignore_broadcasts = 1 <br>  net.ipv4.icmp_ignore_bogus_error_responses = 1 <br>  net.core.somaxconn = 262144 <br>  net.core.netdev_max_backlog = 1000 <br>  net.core.rmem_default = 65536 <br>  net.core.wmem_default = 65536 <br>  net.core.rmem_max = 16777216 <br>  net.core.wmem_max = 16777216 <br></div></div><br>  Tuning file limits, since there are no users on the server, we don‚Äôt bother too much: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/security/limits.conf</b> <div class="spoiler_text">  * soft nproc 65535 <br>  * hard nproc 65535 <br>  * soft nofile 100000 <br>  * hard nofile 100000 <br>  root soft nofile unlimited <br>  root hard nofile unlimited <br></div></div><br>  Monsters know, but I have not been administering for a long time and was not aware that * does not work as root, and it must be separately tuned. <br><br>  This is the core of everything. <br><br>  Muscle settings  Installed percona-56. <br><br>  The choice was finally made on InnoDB, we tried TokuDb, but on large volumes of permanent inserts, and we have them 95% of the 36 million per hour.  InnoDB behaves better, the tests of the perkons say the same thing. <br><br>  Mysql settings: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/my.cnf</b> <div class="spoiler_text">  [mysql] <br>  port = 3306 <br>  socket = /var/lib/mysql/mysql.sock <br>  [mysqld] <br>  user = mysql <br>  default-storage-engine = InnoDB <br>  socket = /var/lib/mysql/mysql.sock <br>  pid-file = /var/lib/mysql/mysql.pid <br>  key-buffer-size = 32M <br>  myisam-recover = FORCE, BACKUP <br>  max-allowed-packet = 16M <br>  max-connect-errors = 1000000 <br>  skip-name-resolve <br>  datadir = / var / lib / mysql / <br>  tmp-table-size = 32M <br>  max-heap-table-size = 32M <br>  query-cache-type = 0 <br>  query-cache-size = 0 <br>  max-connections = 15000 <br>  thread-cache-size = 5000 <br>  open-files-limit = 150000 <br>  table-definition-cache = 1024 <br>  table-open-cache = 50000 <br>  innodb-flush-method = O_DIRECT <br>  innodb-log-files-in-group = 2 <br>  innodb-log-file-size = 2G <br>  innodb-file-per-table = 1 <br>  innodb-buffer-pool-size = 10G <br>  innodb_flush_log_at_trx_commit = 0 <br>  log-error = /var/log/mysql/mysql-error.log <br>  log-queries-not-using-indexes = 0 <br>  slow-query-log = 1 <br>  slow-query-log-file = /var/log/mysql/mysql-slow.log <br></div></div><br>  Be sure to disable with such a load query-cache.  It will really slow down the whole system.  However, play around, maybe not in your case, but in many tests and texts I met this moment, checked it myself - it is, with the disabled it works faster. <br><br>  skip-name-resolve also gives a good increase. <br><br>  Additional settings in relation to the standard for nginx: <br><br><div class="spoiler">  <b class="spoiler_title">fastcgi_params</b> <div class="spoiler_text">  fastcgi_param REDIRECT_STATUS 200; <br>  fastcgi_buffer_size 4K; <br>  fastcgi_buffers 64 4k; <br></div></div><br>  nginx tyunim under our needs: <br><br><div class="spoiler">  <b class="spoiler_title">nginx.conf</b> <div class="spoiler_text">  user nginx; <br>  worker_processes 8; <br><br>  error_log /var/log/nginx/error.log warn; <br>  pid /var/run/nginx.pid; <br><br>  worker_rlimit_nofile 150000; <br><br>  events { <br>  worker_connections 8000; <br>  multi_accept on; <br>  use epoll; <br>  } <br><br>  http { <br>  include /etc/nginx/mime.types; <br>  default_type application / octet-stream; <br><br>  log_format main '$ remote_addr - $ remote_user [$ time_local] "$ request"' <br>  '$ status $ body_bytes_sent "$ http_referer"' <br>  '"$ http_user_agent" "$ http_x_forwarded_for"'; <br><br>  access_log /var/log/nginx/access.log main; <br><br>  gzip off; <br>  sendfile on; <br>  tcp_nopush on; <br>  tcp_nodelay on; <br>  reset_timedout_connection on; <br>  server_tokens off; <br>  client_body_buffer_size 128k; <br><br>  include /etc/nginx/conf.d/*.conf; <br><br>  } <br></div></div><br>  The cores are 8, that's why worker-processes are 8, 8000 per brother, anyway, more than 64k cannot be serviced at a time.  There will be a small queue if there are more simultaneous connections. <br><br>  In a site with php-fpm we communicate through sockets: <br><div class="spoiler">  <b class="spoiler_title">/etc/nginx/conf.d/site.conf</b> <div class="spoiler_text">  fastcgi_pass unix: /var/run/php-fpm/php-fpm.sock; <br>  fastcgi_send_timeout 180s; <br>  fastcgi_read_timeout 180s; <br></div></div><br>  Main configuration php-fpm: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/php-fpm.d/www.conf</b> <div class="spoiler_text">  listen = /var/run/php-fpm/php-fpm.sock <br>  pm = ondemand <br>  pm.max_children = 4000 <br>  pm.start_servers = 5 <br>  pm.min_spare_servers = 5 <br>  pm.max_requests = 0 <br></div></div><br>  ondemand is described in few places, but it is better than dynamic under heavy load.  And static is, of course, a kill for the server, I did not like it much. <br><br>  ondemand starts from 5, grows if necessary, but unlike dynamic with a decrease in load, it does not kill processes, then to increase again, but simply at the peak captures the value and puts the unnecessary into standby mode.  And if the load suddenly grows again - the processes are ready, no one needs to start from scratch. <br><br>  pm.max_requests = 0 helps fight memory leaks, in third-party software. <br><br>  Actually, this is how we serve 36 million per hour, of which 95 percent is transferring data to us and writing them to the database.  For 2.8 billion queries, we now have from 10 to 16 slow_query, each not more than 10 seconds, and all of them are selects with many fields and tables.  The remaining requests work out instantly. <br><br>  Instead of php-fpm I compiled and used hhvm at one time, it really works great, much faster than php-fpm, but there is a problem - it drops every 30-40 minutes, and tightly. <br><br>  I wrote to git developers, until we could not help them, they don‚Äôt know the reasons.  As a result, we sit on php-fpm, version 5.6. <br><br>  All software is put through yum, no builds from sorts with megatuning are used. <br><br>  I think someone will be useful this information about the settings all in one place. </div><p>Source: <a href="https://habr.com/ru/post/262623/">https://habr.com/ru/post/262623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262607/index.html">We give the right to choose access to the page using the Rules</a></li>
<li><a href="../262611/index.html">Mail.Ru Rating Launches Website Scan For Viruses</a></li>
<li><a href="../262613/index.html">Mail collector (making simple things difficult)</a></li>
<li><a href="../262615/index.html">iOS Developer Tools</a></li>
<li><a href="../262617/index.html">48 hours of your publication on Habr√©</a></li>
<li><a href="../262625/index.html">Ten commandments of a successful data center</a></li>
<li><a href="../262627/index.html">6 phrases that can change your approach to customer service</a></li>
<li><a href="../262631/index.html">Beeline interferes with user traffic</a></li>
<li><a href="../262633/index.html">Shine always, shine everywhere. Start</a></li>
<li><a href="../262635/index.html">Internet Explorer 11 discovered zero day vulnerability</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>