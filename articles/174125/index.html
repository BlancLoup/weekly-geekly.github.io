<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk. We transfer the caller's number when forwarding to mobile via SMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello dear habrovchane and lovers of solutions based on Asterisk. In this article I want to share the experience of solving an interesting problem. It...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk. We transfer the caller's number when forwarding to mobile via SMS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/7d5/2a8/f98/7d52a8f98ce670260dcc6445382944a0.png"><br><br>  Hello dear habrovchane and lovers of solutions based on Asterisk.  In this article I want to share the experience of solving an <a href="http://direktologia.ru/">interesting</a> problem.  It was necessary to ensure that when forwarding calls from one mobile / city number to another mobile, we would see the caller‚Äôs number, not our city number.  But the fact is that telecom operators will not let us so easily substitute their numbers when they call through their networks (Indeed, this would be a real mess).  But you can solve the problem by sending it via SMS message via a GSM modem. <br><a name="habracut"></a><br><br>  What we have: <br>  Server with FreePBX Distro FreePBX 2.11.0.0beta2.5 (Asterisk 1.8), Huawei E171 modem, several connected city lines, dialplan with redirection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To begin with we will install the modem, we will transfer it to the necessary mode.  It is important to transfer the modem to the modem only mode: <br>  HUAWEII <a href="http://huawei.mobzon.ru/instruktsii/25-instruktsiya-po-nastrojke-modem">http://huawei.mobzon.ru/instruktsii/25-instruktsiya-po-nastrojke-modem</a> <br>  ZTE <a href="http://www.yccy.ru/category/raznoe/346.html">http://www.yccy.ru/category/raznoe/346.html</a> <br><br>  Configure the program to send SMS - Gnokii.  Here and further I describe actions for CentOS. <br><br>  1. Be sure to set dependencies: <br><br><pre><code class="bash hljs">yum install usbutils libusb1-devel tcl</code> </pre> <br><br>  2. Insert the modem and see how it is defined: <br><br><pre> <code class="bash hljs">lsusb Bus 002 Device 007: ID 12d1:14fe Huawei Technologies Co., Ltd.</code> </pre>  So at the beginning looks like a string. <br><br>  3. In my distribution there was no package for building programs from sources.  We put Development Tools. <br><br><pre> <code class="bash hljs">yum groupinstall <span class="hljs-string"><span class="hljs-string">"Development Tools"</span></span></code> </pre><br><br>  4. Download the program to switch the modem mode.  Packages usb-modeswitch usb-modeswitch-data take <a href="http://www.draisberghof.de/usb_modeswitch/">from here</a> . <br><br>  5. Unpack both archives and install in turn: <br><br><pre> <code class="bash hljs">tar xvjf ... make install</code> </pre><br><br>  6. We distort the modem and check: <br><br><pre> <code class="bash hljs">lsusb Bus 002 Device 008: ID 12d1:1506 Huawei Technologies Co., Ltd. E398 LTE/UMTS/GSM Modem/Networkcard</code> </pre><br><br>  So everything is OK and the modem will be determined every time as necessary.  If the line is the same as at the beginning, then go <a href="http://awsswa.livejournal.com/12015.html">here</a> . <br><br>  The dmesg command will show us: <br><br><pre> <code class="bash hljs">option 2-1.4:1.0: GSM modem (1-port) converter detected usb 2-1.4: GSM modem (1-port) converter now attached to ttyUSB0 option 2-1.4:1.1: GSM modem (1-port) converter detected usb 2-1.4: GSM modem (1-port) converter now attached to ttyUSB1 option 2-1.4:1.2: GSM modem (1-port) converter detected usb 2-1.4: GSM modem (1-port) converter now attached to ttyUSB2</code> </pre><br><br>  7. Install the repository for EPEL CentOS <a href="http://www.server-world.info/en/note%3Fos%3DCentOS_6%26p%3Dinitial_conf%26f%3D6">like this</a> . <br><br>  8. Install gnokii <br><br><pre> <code class="bash hljs">yum --enablerepo=epel install gnokii gnokii-smsd</code> </pre><br><br>  You can download the package: <a href="http://rpm.pbone.net/index.php3/stat/4/idpl/27788385/dir/redhat_el_6/com/gnokii-0.6.30-2.el6.i686.rpm.html">http://rpm.pbone.net/index.php3/stat/4/idpl/27788385/dir/redhat_el_6/com/gnokii-0.6.30-2.el6.i686.rpm.html</a> <br>  and the dependency <a href="http://rpm.pbone.net/index.php3/stat/4/idpl/16859934/dir/redhat_el_6/com/libpcsclite1-1.4.0-9.el6.i686.rpm.html">http://rpm.pbone.net/index.php3/stat/4/idpl/16859934/dir/redhat_el_6/com/libpcsclite1-1.4.0-9.el6.i686.rpm.html</a> <br><br>  9. Edit config / etc / gnokiirc <br><br><pre> <code class="bash hljs">[global] port = /dev/ttyUSB0 model = AT initlength = default connection = serial use_locking = no serial_baudrate = 115200</code> </pre><br><br>  there may be a different port for different modems; <br><br>  10. Check SMS sending: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Bingo!'</span></span> | gnokii --sendsms +79060000000</code> </pre><br><br>  Now you need to allow the asterisk user to run gnokii from the dialplan.  Since gnokii was installed under the root account, the asterisk user will not be able to start it.  Edit the / etc / sudoers file using the visudo command (it is strongly recommended that you only use visudo to edit the sudoers file): <br><br>  Add a line for the asterisk user: <br><br><pre> <code class="bash hljs">asterisk ALL=NOPASSWD:/usr/bin/gnokii</code> </pre><br><br>  Save the file and exit. <br><br>  Next, we need to implement the System () command in our dialplan to send a CID to SMS.  FreePBX, of course, will not allow us to edit extensions.conf and extensions_additional.conf, since it overwrites them all the time.  But you can insert your edits into the plan using the extensions_override_freepbx.conf file, which we will do.  You can simply find the necessary context in the extensions_additional.conf file, copy its fragment into extensions_override_freepbx.conf and make your changes.  I have an internal number 203 which is redirected to a mobile phone number via SIP / trunk / telephone_number.  We will edit this part of the dialplan: <br><br><pre> <code class="bash hljs">[ext-local] exten =&gt; 203,1,Set(__RINGTIMER=<span class="hljs-variable"><span class="hljs-variable">${IF($[${DB(AMPUSER/203/ringtimer)}</span></span> &gt; 0]?<span class="hljs-variable"><span class="hljs-variable">${DB(AMPUSER/203/ringtimer)}</span></span>:<span class="hljs-variable"><span class="hljs-variable">${RINGTIMER_DEFAULT}</span></span>)}) exten =&gt; 203,n,System(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'8${CALLERID(num)}'</span></span> | sudo gnokii --sendsms +79061234567) ;   exten =&gt; 203,n,Macro(exten-vm,novm,203,0,0,0) exten =&gt; 203,n(dest),Set(__PICKUPMARK=) exten =&gt; 203,n,Goto(<span class="hljs-variable"><span class="hljs-variable">${IVR_CONTEXT}</span></span>,<span class="hljs-built_in"><span class="hljs-built_in">return</span></span>,1) exten =&gt; 203,hint,SIP/10000/778899 exten =&gt; Narva778899,1,Goto(from-internal,203,1)</code> </pre><br><br>  Now, when calling or forwarding to 203, an SMS with the caller's number, taken from the CALLERID variable (num), will be sent directly to the mobile phone. <br><br>  In the next article I want to talk about setting up a bunch of Asterisk and SugarCRM to display the number of the caller on the monitor screen of the CRM operator, for later entry into the customer base.  ( <a href="http://habrahabr.ru/post/174637/">done</a> ) <br><br>  Pls, throw karma if someone useful article. </div><p>Source: <a href="https://habr.com/ru/post/174125/">https://habr.com/ru/post/174125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../174111/index.html">Setting up IPTV Beeline via WiFi using Mikrotik routers</a></li>
<li><a href="../174115/index.html">Splitting a continuous data stream into structural units</a></li>
<li><a href="../174119/index.html">Accountology vs Accounting. The rules of computer accounting and the consequences of non-compliance</a></li>
<li><a href="../174121/index.html">Does NASA terminate all educational programs?</a></li>
<li><a href="../174123/index.html">RE: Is time travel possible?</a></li>
<li><a href="../174127/index.html">Screenshots of Windows Blue and IE 11 published</a></li>
<li><a href="../17413/index.html">Blog engine Movable Type from today Open Source</a></li>
<li><a href="../174131/index.html">Run OpenGL on python3 (ubuntu)</a></li>
<li><a href="../174133/index.html">LinkMeUp. Release 1</a></li>
<li><a href="../174135/index.html">Effective online store. What to automate first?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>