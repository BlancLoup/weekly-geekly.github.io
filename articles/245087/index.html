<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to organize sending push-notifications on iPhone</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At Surfingbird, we use push notifications to inform our users of urgent news and simply inform them of interesting materials about the day. Already in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to organize sending push-notifications on iPhone</h1><div class="post__text post__text-html js-mediator-article">  At Surfingbird, we use push notifications to inform our users of urgent news and simply inform them of interesting materials about the day.  Already in the first weeks of testing, the fluffs showed their tremendous effectiveness in terms of retension hobby.  There is a logical explanation for this - the user‚Äôs phone is always with him, in the subway, in the toilet, at meetings, etc. When the user comes to push, his entire attention is focused on this notification. <br><br>  We implemented sending push notifications from the backend in the Perl programming language.  However, when we first started introducing pushes, we encountered some difficulties.  We also want to tell about difficulties and their overcoming in this post. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e87/76c/b2e/e8776cb2e5c7c53172818cfb784a54b1.png" alt="image" width="776" height="300"><br><a name="habracut"></a><br>  To begin with, we initially did not want to use third-party services, such as <a href="http://aws.amazon.com/sns/">Amazon SNS</a> , <a href="http://www.parse.com/">Parse</a> , <a href="http://push.io/">Push IO</a> , etc. No matter how comfortable all these solutions are, they deprive you of the flexibility and ability to somehow influence the process. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A little about why we need push notifications at all.  If an important event occurs in the world, we want to notify our users about this as quickly as possible.  It doesn't matter what this event is: Parmesan has disappeared from the supermarket shelves, the dollar rate is breaking all records, an accident in the subway, or the <a href="http://surfingbird.ru/surf/vladeltsy-kotov-po-vsej-yaponii-prevrashchayut--jfrf39028">Japanese have started putting cats in dolls from Ikea on Instagram</a> .  Any such infopovod needs to work as quickly as possible and deliver to the user's phone. <br><br>  <a href="http://metacpan.org/">Of</a> course, we immediately went to <a href="http://metacpan.org/">metacpan</a> in search of a ready-made module. <br>  The first we came across was <a href="https://metacpan.org/pod/Net::APNS">Net :: APNS</a> .  We really liked the <s>code of the</s> sweetest avatar with chanterelle.  But the code was completely unsuitable for use in production.  He opened the connection before each sending a message to each device and, after sending, closed it.  This, firstly, takes a lot of time, and secondly, Apple can (and will) be perceived as a DoS attack. <br><br>  Well, in general, the module code is clear and supported, it only remains to enrich it.  At the very beginning, we used a simple notification format: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cce/e2e/3df/ccee2e3dfdd4f52a5b7b6f4569ef29cf.png" alt="image" width="558" height="115"><br><br>  The code is: <br><br><pre><code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> Birdy::PushNotification::APNS; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-number"><span class="hljs-number">5.018</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Mojo::Base -base; <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $] &gt;= <span class="hljs-number"><span class="hljs-number">5.018</span></span>, <span class="hljs-string"><span class="hljs-string">warnings =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"experimental"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Socket; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Net::SSLeay <span class="hljs-keyword"><span class="hljs-keyword">qw</span></span>/die_now die_if_ssl_error/; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> JSON::XS; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Encode <span class="hljs-string"><span class="hljs-string">qw(encode)</span></span>; BEGIN { $Net::SSLeay::trace = <span class="hljs-number"><span class="hljs-number">4</span></span>; $Net::SSLeay::ssl_version = <span class="hljs-number"><span class="hljs-number">10</span></span>; Net::SSLeay::load_error_strings(); Net::SSLeay::SSLeay_add_ssl_algorithms(); Net::SSLeay::randomize(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($class, $sandbox) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $port = <span class="hljs-number"><span class="hljs-number">2195</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $address = $sandbox ? <span class="hljs-string"><span class="hljs-string">'gateway.sandbox.push.apple.com'</span></span> : <span class="hljs-string"><span class="hljs-string">'gateway.push.apple.com'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $apns_key = <span class="hljs-string"><span class="hljs-string">"$ENV{MOJO_HOME}/apns_key.pem"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $apns_cert = <span class="hljs-string"><span class="hljs-string">"$ENV{MOJO_HOME}/apns_cert.pem"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $socket; <span class="hljs-keyword"><span class="hljs-keyword">socket</span></span>( $socket, PF_INET, SOCK_STREAM, <span class="hljs-keyword"><span class="hljs-keyword">getprotobyname</span></span>(<span class="hljs-string"><span class="hljs-string">'tcp'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"socket: $!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>( $socket, sockaddr_in( $port, inet_aton($address) ) ) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"Connect: $!"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $ctx = Net::SSLeay::CTX_new() <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> die_now(<span class="hljs-string"><span class="hljs-string">"Failed to create SSL_CTX $!."</span></span>); Net::SSLeay::CTX_set_options($ctx, &amp;Net::SSLeay::OP_ALL); die_if_ssl_error(<span class="hljs-string"><span class="hljs-string">"ssl ctx set options"</span></span>); Net::SSLeay::CTX_use_RSAPrivateKey_file($ctx, $apns_key, &amp;Net::SSLeay::FILETYPE_PEM); die_if_ssl_error(<span class="hljs-string"><span class="hljs-string">"private key"</span></span>); Net::SSLeay::CTX_use_certificate_file($ctx, $apns_cert, &amp;Net::SSLeay::FILETYPE_PEM); die_if_ssl_error(<span class="hljs-string"><span class="hljs-string">"certificate"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $ssl = Net::SSLeay::new($ctx); Net::SSLeay::set_fd($ssl, fileno($socket)); Net::SSLeay::<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>($ssl) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> die_now(<span class="hljs-string"><span class="hljs-string">"Failed SSL connect ($!)"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $self = <span class="hljs-keyword"><span class="hljs-keyword">bless</span></span> { <span class="hljs-string"><span class="hljs-string">'ssl'</span></span> =&gt; $ssl, <span class="hljs-string"><span class="hljs-string">'ctx'</span></span> =&gt; $ctx, <span class="hljs-string"><span class="hljs-string">'socket'</span></span> =&gt; $socket, }, $class; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $self; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($self) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($ssl, $ctx, $socket) = @{$self}{<span class="hljs-keyword"><span class="hljs-keyword">qw</span></span>/ssl ctx <span class="hljs-keyword"><span class="hljs-keyword">socket</span></span>/} CORE::<span class="hljs-keyword"><span class="hljs-keyword">shutdown</span></span>($socket, <span class="hljs-number"><span class="hljs-number">1</span></span>); Net::SSLeay::free($ssl); Net::SSLeay::CTX_free($ctx); <span class="hljs-keyword"><span class="hljs-keyword">close</span></span>($socket); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($self, $token, $alert, $data_id, $sound) = @_; Net::SSLeay::<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>( $self-&gt;{<span class="hljs-string"><span class="hljs-string">'ssl'</span></span>}, $self-&gt;_pack_payload($token, $alert, $data_id, $sound) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> _</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pack_payload</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($self, $token, $alert, $data_id, $sound) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $data = { <span class="hljs-string"><span class="hljs-string">'aps'</span></span> =&gt; { <span class="hljs-string"><span class="hljs-string">'alert'</span></span> =&gt; encode(<span class="hljs-string"><span class="hljs-string">'unicode'</span></span>, $alert), }, <span class="hljs-string"><span class="hljs-string">'data_id'</span></span> =&gt; $data_id, }; <span class="hljs-comment"><span class="hljs-comment">#   $data-&gt;{'aps'}-&gt;{'sound'} = 'default' if $sound; my $xs = JSON::XS-&gt;new-&gt;utf8(1); my $payload = chr(0) . pack('n', 32) . pack('H*', $token); #    if (!$self-&gt;{'_alert'}) { #   ,      256  my $json = $xs-&gt;encode($data); my $overload = length($payload) + length(pack 'n', length $json) + length($json) - 256; if ($overload &gt; 0) { substr( $data-&gt;{'aps'}-&gt;{'alert'}, -$overload ) = ''; } #      $self-&gt;{'_alert'} = $data-&gt;{'aps'}-&gt;{'alert'}; } my $json = $xs-&gt;encode($data); $payload .= pack('n', length $json) . $json; return $payload; }</span></span></code> </pre> <br>  However, after the very first tests, it became clear that in production it would be better not to use the simple notification format.  The thing is, if you send an incorrect or illegible notification, Apple returns an error and closes the connection. <br><br>  In the future, all notifications sent over the same connection will be discarded and must be sent again.  The error is returned in this format: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d85/05a/fb8/d8505afb8bb7bff4c6f5c5364b1fd3bc.png" alt="image" width="236" height="76"><br><br>  As you can see, the description of the error indicates the identifier of the notification that caused this error.  In order for notifications to have identifiers, it is necessary to use the extended notification format: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/065/377/624/065377624fd7be26d72eafe5b75b9ae1.png" alt="image" width="670" height="94"><br><br>  To do this, we rewrite the two methods.  As $ push_id, you can use the token sequence number: <br><br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($self, $token, $alert, $data_id, $sound, $push_id) = @_; Net::SSLeay::<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>( $self-&gt;{<span class="hljs-string"><span class="hljs-string">'ssl'</span></span>}, $self-&gt;_pack_payload($token, $alert, $data_id, $sound, $push_id) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> _</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pack_payload</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($self, $token, $alert, $data_id, $sound, $push_id) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $data = { <span class="hljs-string"><span class="hljs-string">'aps'</span></span> =&gt; { <span class="hljs-string"><span class="hljs-string">'alert'</span></span> =&gt; encode(<span class="hljs-string"><span class="hljs-string">'unicode'</span></span>, $alert), }, <span class="hljs-string"><span class="hljs-string">'data_id'</span></span> =&gt; $data_id, }; <span class="hljs-comment"><span class="hljs-comment">#   $data-&gt;{'aps'}-&gt;{'sound'} = 'default' if $sound; my $xs = JSON::XS-&gt;new-&gt;utf8(1); my $payload = chr(1) . pack('N', $push_id) . pack('N', time + (3600 * 24) ) . pack('n', 32) . pack('H*', $token); #    if (!$self-&gt;{'_alert'}) { #   ,      256  my $json = $xs-&gt;encode($data); my $overload = length($payload) + length(pack 'n', length $json) + length($json) - 256; if ($overload &gt; 0) { substr( $data-&gt;{'aps'}-&gt;{'alert'}, -$overload ) = ''; } #      $self-&gt;{'_alert'} = $data-&gt;{'aps'}-&gt;{'alert'}; } my $json = $xs-&gt;encode($data); $payload .= pack('n', length $json) . $json; return $payload; }</span></span></code> </pre><br>  So much better!  Now you can safely send puschi, until you receive a response with an error.  After that, we take out the identifier of the problem notification from the error description, close the old one and open a new connection, continue to send notifications from the place where the error occurred. <br><br>  With the problematic notification you need to understand privately, there can be several reasons and they are all described <a href="http://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/CommunicatingWIthAPS.html">here</a> . <br><br>  But that's not all.  The user can delete your application or simply deny accepting push.  In order not to send notifications on dead tokens, you need to use feedback service.  It returns a list of all tokens to which you no longer need to send notifications.  Feedback format: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bbd/ec4/bca/bbdec4bca0acfd3c25fe9d3afae6698f.png" alt="image" width="376" height="96"><br><br>  As Apple recommends, it‚Äôs enough just once a day, according to crown, to connect to feedback.push.apple.com:2196 and read from the socket.  The resulting tokens just need to be removed from the database. <br><br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_feedback</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($self) = @_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $result = []; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $bytes = Net::SSLeay::<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>( $self-&gt;{<span class="hljs-string"><span class="hljs-string">'ssl'</span></span>} ); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($bytes) { <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> ($ts, $token); ($ts, $token, $bytes) = <span class="hljs-keyword"><span class="hljs-keyword">unpack</span></span> <span class="hljs-string"><span class="hljs-string">'N n/aa*'</span></span>, $bytes; $token = <span class="hljs-keyword"><span class="hljs-keyword">unpack</span></span> <span class="hljs-string"><span class="hljs-string">'H*'</span></span>, $token; <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> @$result, { <span class="hljs-string"><span class="hljs-string">'ts'</span></span> =&gt; $ts, <span class="hljs-string"><span class="hljs-string">'token'</span></span> =&gt; $token, }; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; }</code> </pre><br>  By the way, to send notifications to the android, it is enough to make an ordinary http request, in which you can transfer 1000 tokens at once.  Of course, in parallel, you can make several requests.  And if this seems too slow, you can use the <a href="http://developer.android.com/google/gcm/ccs.html">Cloud Connection Server (XMPP)</a> . <br><br>  In the comments, we would be interested to know how you solve the problem of push notifications in your applications. <br><br>  one; </div><p>Source: <a href="https://habr.com/ru/post/245087/">https://habr.com/ru/post/245087/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245075/index.html">DFS Replication and "temporary" files</a></li>
<li><a href="../245079/index.html">Digital actors</a></li>
<li><a href="../245081/index.html">Self-study for CCNP exams (personal experience)</a></li>
<li><a href="../245083/index.html">Does your mobile ad work?</a></li>
<li><a href="../245085/index.html">Disks, Controllers, OS and Advanced Format</a></li>
<li><a href="../245089/index.html">Azure RemoteApp comes out of beta testing</a></li>
<li><a href="../245093/index.html">DOMPDF - export data from PHP to PDF</a></li>
<li><a href="../245095/index.html">We work with the Control button in Visual Studio + Resharper</a></li>
<li><a href="../245097/index.html">Tests that test tests</a></li>
<li><a href="../245099/index.html">93% of users are happy with the design: how we designed Septim</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>