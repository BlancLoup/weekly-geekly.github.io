<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby on your server may be 2 times slower due to RVM</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Looking at Ruby Inside today, I stumbled upon the article Justin Kulesza. Is Your Application Running with Ruby - Slow? . Article from November 6, but...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby on your server may be 2 times slower due to RVM</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/91f/a2e/ed1/91fa2eed1b870afa520836bdf0bf9a9e.jpg"><br>  Looking at Ruby Inside today, I stumbled upon the article Justin Kulesza. <a href="http://spin.atomicobject.com/2012/11/06/is-your-application-running-with-ruby-slow/">Is Your Application Running with Ruby - Slow?</a>  .  Article from November 6, but on Habr√© about this situation not a word.  And the essence of the article is this: the guys transferred their application from the server to Solaris to the server from Ubuntu and used RVM to compile Ruby.  However, after the transfer, they noticed that the application became as if slower.  At first they made mistakes on iron, but quickly found out that the matter was in RVM, namely, that RVM does not use optimization at all when compiling. <br><a name="habracut"></a><br>  Diagnosing a problem is very simple: <br><pre><code class="bash hljs">$ time ruby -e <span class="hljs-string"><span class="hljs-string">"count = 0; while(count &lt; 100000000); count = count + 1; end; puts count"</span></span> 100000000 real 0m9.019s user 0m8.933s sys 0m0.016s</code> </pre> <br>  The ‚Äúnormal‚Äù execution time should be no higher than ~ 4 seconds. <br><br>  Plus the lack of optimization flags in <b>~ / .rvm / log / your.ruby.version / make.log</b> : <br><pre> <code class="bash hljs">CC = gcc LD = ld LDSHARED = gcc -shared CFLAGS = -I/home/user/.rvm/usr/include -fPIC XCFLAGS = -include ruby/config.h -include ruby/missing.h -fvisibility=hidden -DRUBY_EXPORT CPPFLAGS = -I. -I.ext/include/x86_64-linux -I./include -I. DLDFLAGS = -Wl,-soname,libruby.so.1.9 SOLIBS = -lpthread -lrt -ldl -lcrypt -lm</code> </pre><br>  CFLAGS must contain -O3. <br><br>  I checked on my server - and the truth is, the problem is taking place. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The article provides the following solution: <br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"rvm_configure_env=(CFLAGS=-O3)"</span></span> &gt; ~/.rvmrc</code> </pre><br>  An alternative from <a href="http://alisnic.net/blog/making-your-ruby-fly/">this article</a> : <br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'rvm_configure_env=(CFLAGS="-march=native -O2")'</span></span> &gt; ~/.rvmrc</code> </pre><br>  And then: <br><pre> <code class="bash hljs">$ rvm reinstall your.ruby.version</code> </pre><br>  However, currently it is still easier: <br><pre> <code class="bash hljs">$ rvm get head &amp;&amp; rvm reinstall your.ruby.version</code> </pre><br>  And besides, in the 'head'-version of RVM, there is a bad <a href="https://gist.github.com/4136373">patch</a> from <a href="https://github.com/funny-falcon">funny-falcon available</a> for the latest version of Ruby - 1.9.3-p327, which makes Ruby even faster (especially when downloading an application).  Installation is also simple: <br><pre> <code class="bash hljs">$ rvm install 1.9.3 -n perf --patch falcon $ rvm use 1.9.3-perf --default</code> </pre><br>  After reinstallation, the server showed a speed increase of more than 2 times: <br><pre> <code class="bash hljs">$ time ruby -e <span class="hljs-string"><span class="hljs-string">"count = 0; while(count &lt; 100000000); count = count + 1; end; puts count"</span></span> 100000000 real 0m4.117s user 0m4.032s sys 0m0.012s</code> </pre><br>  So check your servers, speed up your applications. </div><p>Source: <a href="https://habr.com/ru/post/160371/">https://habr.com/ru/post/160371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160361/index.html">TechEd Russia 2012 - Microsoft's largest online conference!</a></li>
<li><a href="../160363/index.html">And which task tracker do you use in a small team?</a></li>
<li><a href="../160365/index.html">EventMachine ‚áí collection of information from various sources with subsequent processing</a></li>
<li><a href="../160367/index.html">IBM launched an initiative to develop future power systems</a></li>
<li><a href="../160369/index.html">nanoCAD Heating 1.0 Beta - a new solution in the product line based on nanoCAD</a></li>
<li><a href="../160373/index.html">Introduction to R-project</a></li>
<li><a href="../160375/index.html">Mobile home transformers</a></li>
<li><a href="../160377/index.html">Firefox 18 beta</a></li>
<li><a href="../160379/index.html">Personal electric helicopter</a></li>
<li><a href="../160383/index.html">DJ controller</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>