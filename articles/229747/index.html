<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple way to connect an arbitrary video source in Qml</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preamble 
 All of the following is given in the context of Qt version 5.3.1 (as the most relevant at the moment), but it makes sense in the context of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple way to connect an arbitrary video source in Qml</h1><div class="post__text post__text-html js-mediator-article"><h4>  Preamble </h4><br>  All of the following is given in the context of Qt version 5.3.1 (as the most relevant at the moment), but it makes sense in the context of any version of the 5.x branch, and perhaps even 4.8.x (did not check as unnecessary). <br><br>  Operating system - Windows, development environment - QtCreator 3.1.2 in conjunction with MinGW and gcc 4.8.2 The essence does not change from using other platforms / IDE / compilers. <br><br>  The simplest of the available options was chosen as the video source, namely, the desktop.  Those.  The application will display a copy of everything that happens on the desktop.  In multi-monitor configurations, we will use the main screen as the source. <br><a name="habracut"></a><br><h4>  So let's get started </h4><br>  As a starting point, you can read the documentation: <a href="http://qt-project.org/doc/qt-5/videooverview.html">"Video Overview: Working with Low Level Video Frames"</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A few theses that need to be gleaned from this article: <br><br><ul><li>  The video source must be a descendant of QObject; </li><li>  It should declare a property videoSurface of type QAbstractVideoSurface *; </li><li>  It should call QAbstractVideoSurface :: start, with the transfer of QVideoSurfaceFormat, before starting playback; </li><li>  It must call QAbstractVideoSurface :: present, with a QVideoFrame transfer, to display each frame; </li><li>  It should call QAbstractVideoSurface :: stop when the movie has finished playing. </li></ul><br><br><h4>  Write the code </h4><br>  Create a new project ‚ÄúQt Quick Application‚Äù.  It is important to select this type of application type, since in the future we will create a Qml component using C ++. <br><br>  Next, create a class, a descendant of QObject, and start expanding it. <br><br>  As a result, it‚Äôs quite simple and laconic, I won‚Äôt pour a lot of water, but I‚Äôll just give the code, with some comments: <br><br>  DesktopVideoProducer.h: <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> once #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QAbstractVideoSurface&gt; #include &lt;QVideoSurfaceFormat&gt; class DesktopVideoProducer : public QObject { Q_OBJECT public: //         Qml    static void registerQmlType(); explicit DesktopVideoProducer( QObject *parent = 0 ); ~DesktopVideoProducer(); //  property,   Q_PROPERTY( QAbstractVideoSurface* videoSurface READ videoSurface WRITE setVideoSurface ) QAbstractVideoSurface* videoSurface() const; void setVideoSurface( QAbstractVideoSurface* s ); protected: void timerEvent( QTimerEvent* ); private: void closeSurface(); private: QAbstractVideoSurface* _surface; QVideoSurfaceFormat _format; };</span></span></span></span></code> </pre> <br>  DesktopVideoProducer.cpp: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DesktopVideoProducer.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QtQml/qqml.h&gt; #include &lt;QApplication&gt; #include &lt;QScreen&gt; #include &lt;QDesktopWidget&gt; void DesktopVideoProducer::registerQmlType() { //      DesktopVideoProducer, //  0.1,   DesktopVideoProducer. //       QtCreator, //   . // @uri DesktopVideoProducer qmlRegisterType&lt;DesktopVideoProducer&gt;( "DesktopVideoProducer", 0, 1, "DesktopVideoProducer" ); } DesktopVideoProducer::DesktopVideoProducer( QObject *parent ) : QObject( parent ), _surface( 0 ) { startTimer( 1000 / 15 ); //15 fps } DesktopVideoProducer::~DesktopVideoProducer() { closeSurface(); } QAbstractVideoSurface* DesktopVideoProducer::videoSurface() const { return _surface; } void DesktopVideoProducer::setVideoSurface( QAbstractVideoSurface* s ) { closeSurface(); _surface = s; } void DesktopVideoProducer::closeSurface() { if( _surface &amp;&amp; _surface-&gt;isActive() ) _surface-&gt;stop(); } void DesktopVideoProducer::timerEvent( QTimerEvent* ) { if( !_surface ) return; QScreen* screen = QGuiApplication::primaryScreen(); QDesktopWidget* desktop = QApplication::desktop(); if( !screen || !desktop ) return; // screenshot        QVideoFrame QPixmap screenPixmap = screen-&gt;grabWindow( desktop-&gt;screen()-&gt;winId() ); QImage screenImage = screenPixmap.toImage(); QVideoFrame::PixelFormat pixelFormat = QVideoFrame::pixelFormatFromImageFormat( screenImage.format() ); //    -   (   )- //  ()  surface if( screenPixmap.size() != _format.frameSize() || pixelFormat != _format.pixelFormat() ) { closeSurface(); _format = QVideoSurfaceFormat( screenPixmap.size(), pixelFormat ); _surface-&gt;start( _format ); } //     _surface-&gt;present( QVideoFrame( screenImage ) ); }</span></span></span></span></code> </pre><br>  main.qml: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">QtQuick</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">QtQuick</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Window</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">QtMultimedia</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DesktopVideoProducer</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Window</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">visible</span></span>: true width: <span class="hljs-number"><span class="hljs-number">360</span></span> height: <span class="hljs-number"><span class="hljs-number">360</span></span> DesktopVideoProducer { id: videoProducer; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">VideoOutput</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">anchors.fill</span></span>: parent; <span class="hljs-attribute"><span class="hljs-attribute">source</span></span>: videoProducer; } }</code> </pre><br><br>  main.cpp: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;QApplication&gt; #include &lt;QQmlApplicationEngine&gt; #include"DesktopVideoProducer.h" int main(int argc, char *argv[]) { // DesktopVideoProducer    Qml DesktopVideoProducer::registerQmlType(); //   QApplication::desktop() QGuiApplication  //QGuiApplication app(argc, argv); QApplication app(argc, argv); QQmlApplicationEngine engine; engine.load(QUrl(QStringLiteral("qrc:///main.qml"))); return app.exec(); }</span></span></span></span></code> </pre><br><br>  PS: The complete project is available for download from <a href="https://github.com/RSATom/QmlVideoProducer">GitHub</a> . </div><p>Source: <a href="https://habr.com/ru/post/229747/">https://habr.com/ru/post/229747/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../229731/index.html">Using Percona XtraBackup in daily life</a></li>
<li><a href="../229733/index.html">14 mpps SYN floods or 14 V load fork</a></li>
<li><a href="../229735/index.html">Private space truck "Cygnus" successfully launched to the ISS</a></li>
<li><a href="../229741/index.html">Improving performance: boxing in .NET that can be avoided</a></li>
<li><a href="../229743/index.html">Node.js + jQuery Ajax. Upload files to server</a></li>
<li><a href="../229749/index.html">Raspberry Developers Release Raspberry Pi Model B +</a></li>
<li><a href="../229755/index.html">Meet Avaya ERS 4000</a></li>
<li><a href="../229757/index.html">Search and analysis of the optimal color space for the construction of eye-catching objects on a given class of images</a></li>
<li><a href="../229761/index.html">Fail story of SaaS Helpdesk for small business</a></li>
<li><a href="../229763/index.html">YaLinqo (LINQ to Objects for PHP) - version 2.0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>