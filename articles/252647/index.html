<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Assembler with C ++ in Visual Studio 2013</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The idea of ‚Äã‚Äãthis article is not new, but since I had to spend two days analyzing all the compilation and linking errors, as well as searching for an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Assembler with C ++ in Visual Studio 2013</h1><div class="post__text post__text-html js-mediator-article">  The idea of ‚Äã‚Äãthis article is not new, but since I had to spend two days analyzing all the compilation and linking errors, as well as searching for answers to my questions, I decided that Habr readers deserve to save time.  Those who want to quickly learn how to use simultaneously * .asm and * .cpp files in a project, how to call C ++ methods from an assembler and vice versa, please welcome under cat. <br><a name="habracut"></a><br><h4>  <b>Foreword</b> </h4><br>  It all started with my reading of the publication <a href="http://habrahabr.ru/post/111275/">‚ÄúAssembler for Windows using Visual Studio‚Äù</a> (hence the almost identical code).  They consider using Visual Studio 2005, and for the 2013 studio, the process is similar, but there are several differences that will cause an unprepared user to search for solutions to all problems with the assembly for a long time. <br><br><h4>  <b>Content</b> </h4><br><ol><li>  TL; DR </li><li>  Project creation </li><li>  Setting syntax highlighting </li><li>  The subtleties of calling methods between C ++ and Asm </li><li>  application </li></ol><br><h4>  <b>TL; DR</b> </h4><br>  For those who have absolutely no time to read: at the end of the article (in the appendix) there is a link to the finished project template and to the addon for syntax highlighting. <br><br><h4>  <b>Project creation</b> </h4><br><div class="spoiler">  <b class="spoiler_title">Illustrated version</b> <div class="spoiler_text">  Turn on Visual Studio, choose <b>File -&gt; New -&gt; Project ...</b> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/8d2/c85/346/8d2c8534671449e79621fb9e2fcfb389.png" alt="image"><br><br>  Select the <b>Win32 Console Application</b> template, click <b>OK</b> : <br><br><img src="https://habrastorage.org/files/c36/0ec/cd2/c360eccd2e9a4d08872d5011cd55bc4d.png" alt="image"><br><br>  Click <b>Next</b> : <br><br><img src="https://habrastorage.org/files/ec9/76c/968/ec976c96817e439b825b82d3b7cba72a.png" alt="image"><br><br>  Put a tick in front of the <b>Empty project</b> and click <b>Finish</b> : <br><br><img src="https://habrastorage.org/files/564/aea/db2/564aeadb209342459df8a625e5948d4f.png" alt="image"><br><br>  We create source codes.  To do this, right click on <b>Source Files</b> , select <b>Add -&gt; New Item ...</b> : <br><br><img src="https://habrastorage.org/files/613/fc6/417/613fc64174924fbe9fd402fc4abe7575.png" alt="image"><br><br>  Choose <b>C ++ File</b> and click <b>Add</b> : <br><br><img src="https://habrastorage.org/files/1bf/89c/339/1bf89c33992840378f5031df3a4dff91.png" alt="image"><br><br>  Similarly, create a * .asm file (just change the extension in the <b>Name</b> field): <br><br><img src="https://habrastorage.org/files/848/40f/173/84840f17347649ab85575914eb733a02.png" alt="image"><br><br>  <b>Important: the file names must be different (disregarding the extension), otherwise when creating * .obj files, there will be a problem of overwriting one object file with another</b> . <br><br>  Now settings.  Make a right click on the project, select <b>Build Dependencies -&gt; Build Customizations ...</b> <br><br><img src="https://habrastorage.org/files/1de/a34/25a/1dea3425a605412cab718678f8f52476.png" alt="image"><br><br>  Put a tick in front of the <b>masm</b> and click <b>OK</b> : <br><br><img src="https://habrastorage.org/files/0c3/f1d/206/0c3f1d206a6549608ea1d29ac84ee630.png" alt="image"><br><br>  Right-click on the * .asm file, select <b>Properties ...</b> : <br><br><img src="https://habrastorage.org/files/589/728/295/58972829532b4d4a837c766c4d29950f.png" alt="image"><br><br>  In the <b>Item Type</b> field, select <b>Microsoft Macro Assembler</b> and click <b>OK</b> : <br><br><img src="https://habrastorage.org/files/3a6/f1d/4df/3a6f1d4dfa7f4bf0b14b246920cbb772.png" alt="image"><br><br>  Choose <b>Project -&gt; Properties ...</b> : <br><br><img src="https://habrastorage.org/files/8cf/122/ca4/8cf122ca471246829aa40c9c2e5791eb.png" alt="image"><br><br>  Choose <b>Configuration Properties -&gt; Microsoft Macro Assembler -&gt; Listing File</b> .  In the <b>Assembled Code Listing File</b> field, enter <b>$ (ProjectName) .lst</b> : <br><br><img src="https://habrastorage.org/files/b69/a1b/890/b69a1b8902824eb39eba1f5dafcf108f.png" alt="image"><br><br>  Choose <b>Configuration Properties -&gt; Linker -&gt; Advanced</b> .  In the <b>Image Has Safe Exception Handlers</b> field, select the value <b>No.</b>  Click <b>OK</b> : <br><br><img src="https://habrastorage.org/files/074/22f/538/07422f538fa940d885331fe56cedc9bb.png" alt="image"><br><br>  At this stage, the project can be considered created.  Code writing is discussed in the <b>Subtleties</b> section of <b>calling methods between C ++ and Asm</b> . <br><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Text only</b> <div class="spoiler_text">  Turn on Visual Studio, choose <b>File -&gt; New -&gt; Project ....</b> <br><br>  Select the <b>Win32 Console Application</b> template, click <b>OK</b> . <br><br>  Click <b>Next</b> . <br><br>  Put a tick in front of the <b>Empty project</b> and click <b>Finish</b> . <br><br>  We create source codes.  To do this, right click on <b>Source Files</b> , select <b>Add -&gt; New Item ....</b> <br><br>  Select <b>C ++ File</b> and click <b>Add</b> . <br><br>  Similarly, create a * .asm file (just change the extension in the <b>Name</b> field). <br><br>  <b>Important: file names must be different (not including the extension), otherwise when creating * .obj files, there will be a problem of overwriting one object file with another</b> . <br><br>  Now settings.  Make a right click on the project, select <b>Build Dependencies -&gt; Build Customizations ...</b> <br><br>  Put a tick in front of the <b>masm</b> and click <b>OK</b> . <br><br>  Right-click on the * .asm file, select <b>Properties ...</b> <br><br>  In the <b>Item Type</b> field, select <b>Microsoft Macro Assembler</b> and click <b>OK</b> . <br><br>  Choose <b>Project -&gt; Properties ...</b> <br><br>  Choose <b>Configuration Properties -&gt; Microsoft Macro Assembler -&gt; Listing File</b> .  In the <b>Assembled Code Listing File</b> field, enter <b>$ (ProjectName) .lst</b> . <br><br>  Choose <b>Configuration Properties -&gt; Linker -&gt; Advanced</b> .  In the <b>Image Has Safe Exception Handlers</b> field, select the value <b>No.</b>  Click <b>OK</b> . <br><br>  At this stage, the project can be considered created.  Code writing is discussed in the <b>Subtleties</b> section of <b>calling methods between C ++ and Asm</b> . <br></div></div><br><h4>  <b>Setting syntax highlighting</b> </h4><br>  There is an addon for Visual Studio - <a href="http://asmhighlighter.codeplex.com/">asmHighlighter</a> , but at the time of this writing, there was no version for VS2013.  However, after reviewing the Discussions section, I found a message from <i>Trass3r</i> , who, fortunately, shared the <a href="https://github.com/Trass3r/AsmHighlighter">repository</a> with the add-on version for VS2013.  After installing the <a href="https://www.visualstudio.com/integrate/explore/explore-vside-vsi">Visual Studio SDK,</a> I managed to build a project and now the * .vsix package is <a href="">freely available</a> . <br><br><h4>  <b>The subtleties of calling methods between C ++ and Asm</b> </h4><br>  In order to avoid compilation and / or binding errors, remember the following: <br><ol><li>  If it is necessary to call library methods from the assembler, it is sufficient to specify at the beginning of the code section which methods we are going to use. <br><br><pre><code class="hljs rust">EXTRN printf : <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span> ;we<span class="hljs-symbol"><span class="hljs-symbol">'ll</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> printf</code> </pre> <br>  Then you can simply use <i>call</i> : <br><br><pre> <code class="hljs perl">;<span class="hljs-keyword"><span class="hljs-keyword">printf</span></span>(ebx,eax) <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> eax; <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx call <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> add esp, <span class="hljs-number"><span class="hljs-number">8</span></span> ;<span class="hljs-keyword"><span class="hljs-keyword">pop</span></span> x2</code> </pre></li><li>  If you need to call custom methods, then in addition to item 1, you must also write <i>extern "C"</i> before defining the method. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* name = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*)<span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">scanf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s"</span></span>, name); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (getchar() != <span class="hljs-string"><span class="hljs-string">'\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name; }</code> </pre><br>  Accordingly, in the * .asm file: <br><pre> <code class="hljs pgsql">EXTRN readName : proc ;<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span>* readName()</code> </pre>  and <br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">call</span></span> readName ;eax = readName()</code> </pre><br></li><li>  In the case of using Asm-methods in C ++, it is enough just to specify the prototype: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  This prototype corresponds to the following Asm method declaration: <br><br><pre> <code class="hljs sql">sayHello PROC <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> readName ;eax = readName() lea ebx, helloFormat ;ebx = &amp;helloFormat ;printf(ebx,eax) push eax push ebx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> printf <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> esp, <span class="hljs-number"><span class="hljs-number">8</span></span> ;pop x2 retn sayHello ENDP</code> </pre></li></ol><br>  Actually, the full source code of the example: <br><br><div class="spoiler">  <b class="spoiler_title">Source.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _CRT_SECURE_NO_WARNINGS #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; extern "C" { void sayHello(); } void main() { printf("Hello, what is your name?\n"); sayHello(); while (getchar() != '\n'); } extern "C" void* readName() { char* name = (char*)calloc(1, 255); scanf("%s", name); while (getchar() != '\n'); return name; }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">AsmSource.asm</b> <div class="spoiler_text"><pre> <code class="hljs perl">.<span class="hljs-number"><span class="hljs-number">686</span></span> .MODEL FLAT, C .STACK .DATA ;-----------Local data------------------------------ helloFormat BYTE <span class="hljs-string"><span class="hljs-string">"Hello, %s!"</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> .CODE ;-----------External usage-------------------------- EXTRN <span class="hljs-keyword"><span class="hljs-keyword">printf</span></span> : proc;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span> we<span class="hljs-string"><span class="hljs-string">'ll use printf EXTRN readName : proc;//and void* readName() ;-----------Function definitions-------------------- sayHello PROC call readName; eax = readName() lea ebx, helloFormat; ebx = &amp;helloFormat ;printf(ebx,eax) push eax push ebx call printf add esp, 8;pop x2 retn sayHello ENDP END</span></span></code> </pre><br></div></div><br><br><h4>  <b>application</b> </h4><br>  A complete project template can be found <a href="">here</a> . <br>  The package for syntax highlighting asm can be found <a href="">here</a> . <br><br>  PS Thank you <a href="http://habrahabr.ru/users/ilynxy/">ilynxy</a> for fixing ‚Äúdeserve on‚Äù) </div><p>Source: <a href="https://habr.com/ru/post/252647/">https://habr.com/ru/post/252647/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../252637/index.html">Animations against lags, or the best battle that was not</a></li>
<li><a href="../252639/index.html">130 thousand surveillance cameras - how to make them work?</a></li>
<li><a href="../252641/index.html">Trends and statistics: How Internet companies create an effective newsletter</a></li>
<li><a href="../252643/index.html">What are you guided in the first place, choosing a cloud provider - IaaS service provider?</a></li>
<li><a href="../252645/index.html">We stamp windows: automated deployment of Windows virtual machines to Hyper-V using Vagrant (part 3)</a></li>
<li><a href="../252649/index.html">CDN in a backpack. How we made a portable CDN</a></li>
<li><a href="../252653/index.html">CKFinder - image sizes</a></li>
<li><a href="../252657/index.html">OData + Angular.js + Bootstrap + JavaScript Grid = application in 5 minutes</a></li>
<li><a href="../252663/index.html">3D printing - to schools (techno-marathon for assembling 3D printers in Yekaterinburg)</a></li>
<li><a href="../252665/index.html">Free Cloud IP-PBX - implementation from ppbbxx.com</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>