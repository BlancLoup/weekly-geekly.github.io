<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>JavaScript tooling by modifying code: areas of application and general operating principles</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A little paraphrasing Wikipedia, the instrumentation is tracking the parameters of the level of performance code, the ability to diagnose errors and r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>JavaScript tooling by modifying code: areas of application and general operating principles</h1><div class="post__text post__text-html js-mediator-article">  A little paraphrasing Wikipedia, the instrumentation is tracking the parameters of the level of performance code, the ability to diagnose errors and record information to track the causes of their occurrence. <br><br>  JavaScript tooling may be necessary for a variety of reasons.  The most common: debugging, profiling, tracing, logging.  As a rule, the engines in which JavaScript is executed provide ways to instrument the code without changing it.  <a href="http://habrahabr.ru/post/188708/">In my last article</a> I described some of the means by which this is done, and also the existing limitations that eventually led me to the beginning of the project described in that article and to study the issue of JavaScript instrumentation by automatically changing the code.  This topic, in my opinion, is deprived of attention, but deserves disclosure, especially in the comments there was an interest in the conceptual approach of code modification. <br><a name="habracut"></a><br>  So why and how can you automatically change the code? <br><br>  For the simplest debugging, for example, you may need to change each script function by wrapping its body in a try-catch block. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Simple tracing or logging can be done by inserting console.log, profiling by inserting console.time / console.profile at the beginning and end of each function, or, if metering accuracy is not that important or the running environment does not support console.time / console.profile, good old Date.now (). <br><br>  Deeper and more complete tracing may be needed for the subsequent analysis of test or scenario code coverage.  The information on the execution of the code collected by instrumental instructions is stored where the tool can later take it for a report.  A qualitative analysis of test coverage implies tracking the execution (and, accordingly, instrumentation) of not only the lines of code, but also the branches of logical and ternary operators. <br><table><tbody><tr><td><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arg1, arg2</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arg1 || arg2 &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) Bar1(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arg2 ? Bar2() : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br></td><td>  =&gt; </td><td><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,   function Foo(arg1, arg2) { try { ping('Foo invoked'); if ((ping('arg1 check'), arg1) || (ping('arg2 check'), arg2 &gt; 0)) { ping('if branch'); Bar1(); } return arg2 ? (ping('Bar2 branch'), Bar2()) : (ping('false branch'), false); } finally { ping('Foo finished'); } }</span></span></code> </pre><br></td></tr></tbody></table><br>  Code instrumentation for subsequent tracing of this kind is performed by code coverage tools.  Of those with whom I had to work and enjoyed, I can not fail to mark <a href="http://gotwarlost.github.io/istanbul/">istanbul</a> .  The tool is written in JavaScript, which also helps its popularity in using it in <a href="http://gruntjs.com/plugins">grunt extensions</a> .  I use istanbul with <a href="http://pivotal.github.io/jasmine/">Jasmine</a> both for analyzing client test coverage ( <a href="http://phantomjs.org/">PhantomJs</a> plus <a href="https://npmjs.org/package/grunt-template-jasmine-istanbul">grunt-template-jasmine-istanbul</a> ) and for server code (with <a href="https://npmjs.org/package/grunt-jasmine-node-coverage">grunt-jasmine-node-coverage</a> ).  You <a href="http://gotwarlost.github.io/istanbul/public/coverage/lcov-report/istanbul/lib/command/check-coverage.js.html">can see</a> an example of the report on the coverage of the istanbul code for yourself <a href="http://gotwarlost.github.io/istanbul/public/coverage/lcov-report/istanbul/lib/command/check-coverage.js.html">here</a> . <br><br><img src="https://habrastorage.org/storage2/6a7/176/14e/6a717614e6884579b5f74ed8b072ecc2.png"><br><br>  Even more complex code modification may be needed in the visualization and analysis tools for the execution of the code mentioned in the previous article. <br><br>  How can you automatically change the JavaScript code, find the right places and insert instrumentation instructions there?  You can certainly try to do this with regular expressions and call the devil, as in this <a href="http://stackoverflow.com/a/1732454/2644022">stackoverflow answer</a> , but the correct answer to this question is the following: JavaScript code needs to be parsed, bypass the resulting abstract syntax tree, change the nodes of interest to us, convert the modified tree back into code. <br><br>  There are many easily found JavaScript parsers, some of which we use all the time, without even thinking about the fact that it is also a parser (for example, <a href="https://github.com/mishoo/UglifyJS">uglify.js</a> or various JavaScript beautifiers).  In my project, I used esprima to get the original syntax tree.  The tree is a hierarchical JSON describing the code being analyzed.  You can play with syntactic trees, as well as see other examples of using esprima, <a href="http://esprima.org/demo/parse.html">on the site of the tool</a> . <br><br><img src="https://habrastorage.org/storage2/d71/358/1fb/d713581fb69ea56b0e401d5f28965fea.png"><br><br>  Traversing the tree with the modification I implemented without additional tools.  However, such tools exist, for example <a href="https://github.com/substack/node-falafel">falafel</a> and <a href="https://github.com/substack/node-burrito">burrito</a> , and eliminate the need to write the infrastructure for traversing the tree, allowing you to concentrate on the task of finding and modifying the necessary nodes. <br><br>  It is important to note that for many code modification tasks (for tasks of my project and for problems of code coverage analysis tools), the position of the nodes of the initial tree is important.  When inserting new nodes into the tree (instrumental instructions) and the subsequent generation of the modified code, the instructions of the old code will be shifted.  Instrumentation instructions describing the execution of the code should communicate the initial positions (rows / columns) of this code.  Parsers can on demand include information about the position of the code in the generated tree. <br><br>  I <a href="https://github.com/Constellation/escodegen">generate the</a> code for the modified tree using <a href="https://github.com/Constellation/escodegen">escodegen</a> , which understands the syntax tree format issued by esprima. <br><br>  Unfortunately, different parsers / generators are free to use and use different syntax tree formats.  Fortunately, several popular parsers use the <a href="https://developer.mozilla.org/en-US/docs/SpiderMonkey/Parser_API">SpiderMonkey parser API</a> syntax tree format, and esprima / escodegen are among these parsers / generators. <br><br>  In order to hide instrumentation instructions during debugging and make the client code in the debugger look like it is not instrumented, <a href="http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/">source maps</a> can be used when generating the modified tree code.  Using escodegen, all you need to do is set one flag (options.sourceMap). <br><br>  In conclusion, I would like to note that non-destructive automatic modification of the code requires a good knowledge of the specification of the language (or constant verification with it).  As a postscript, I can give an example of a pitfall that I came across. <br><br>  In the prototype of the project, I politely wrapped everything that was possible in blocks, that is, <br><table><tbody><tr><td><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> y) { <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre><br></td><td>  turned into </td><td><pre> <code class="javascript hljs">{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> y) { <span class="hljs-comment"><span class="hljs-comment">//   } }</span></span></code> </pre><br></td></tr></tbody></table><br>  what i thought was non-destructive change.  And everything was fine until I came across a library that broke after modification. <br><br><div class="spoiler">  <b class="spoiler_title">The reader can, if he wishes, test his knowledge / memory before reading the answer.</b> <div class="spoiler_text">  I knew of course that there are labels in the language, but I rarely used it in my practice and did not expect a certain behavior for the case with continue label.  The breaking scenario was: <br><pre> <code class="javascript hljs">l1: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> y) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> l1; }</code> </pre> <br>  (see comments on the article for a more detailed explanation) <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/188990/">https://habr.com/ru/post/188990/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188974/index.html">Firefox 17 0day via Freedom Hosting</a></li>
<li><a href="../188978/index.html">The history of the creation of a startup for the development of mobile games</a></li>
<li><a href="../188980/index.html">Curiosity - year</a></li>
<li><a href="../188986/index.html">Compiling iOS faster with AIR 4</a></li>
<li><a href="../188988/index.html">Two days in the life of the Intel 0x7DD summer school</a></li>
<li><a href="../188992/index.html">Making microcircuits at home - part 3</a></li>
<li><a href="../188994/index.html">Review Anchor CMS - throw anchor into the bay of bloggers</a></li>
<li><a href="../188996/index.html">A software package for conducting an automated audit of the virtual environment for errors in the security configuration</a></li>
<li><a href="../188998/index.html">Rocket summer: where to go to study</a></li>
<li><a href="../189000/index.html">Multipurpose devices: some history</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>