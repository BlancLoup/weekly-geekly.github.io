<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Logging into Aeronet: running a standalone quadrocopter in a virtual environment</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To fly on a quadcopter now, if desired, perhaps, perhaps, everyone. But in order to solve the problem of autonomous control, so that you do not need t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Logging into Aeronet: running a standalone quadrocopter in a virtual environment</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/_u/wx/n4/_uwxn4mt5vwbrjvzxwrcxjg7mnu.png"></p><br><p>  To fly on a quadcopter now, if desired, perhaps, perhaps, everyone.  But in order to solve the problem of autonomous control, so that you do not need to move the remote control stick and constantly monitor the drone - in this formulation, the solution may require a lot of resources: buy, assemble, solder, adjust, take off, drop, and after a fall - return to the beginning of the cycle. </p><br><p>  Teaching the Aeronet judges / teachers on our project, we faced the need for a simplified ‚Äúentry into the topic‚Äù of programming unmanned vehicles for teachers of robotics / computer science, who already have a set of basic knowledge. </p><br><p>  There is an easy way to learn the basics of drone flight programming - a virtual simulation environment, a step-by-step example of the use of which we will discuss in our article. </p><a name="habracut"></a><br><p>  To upgrade the basic programming skills of the drone, you do not need to buy anything - just use the jMAVSim drone simulator of the PX4 project.  The PX4 is a powerful set of open source software designed for use on various unmanned vehicles, both flying and driving on the ground.  The source code of the project lies <a href="https://github.com/PX4/Firmware">on Github</a> . </p><br><p>  Initially, Linux Ubuntu LTS is recommended as a development environment by the PX4 authors.  There is also Mac support.  This year, a simulation and development environment for Windows appeared in Cygwin, which can simplify life for Russian educational institutions that use Windows in computer science classes. </p><br><p>  Next we look at the process of installing, building and running the simulator under Linux and under Windows. </p><br><h2 id="ustanovka-i-zapusk-jmavsim-na-linux-ubuntu">  Installing and running jMAVSim on Linux Ubuntu </h2><br><p>  PX4 developers recommend Linux Ubuntu 16.04 LTS as a standard system.  Linux allows you to build the PX4 package for all supported systems (NuttX-based hardware platforms, Qualcomm Snapdragon Flight, Linux, simulation environments, ROS). </p><br><p>  First of all, add the user to the dialout group: </p><br><pre><code class="bash hljs">sudo usermod -a -G dialout <span class="hljs-variable"><span class="hljs-variable">$USER</span></span></code> </pre> <br><p>  Let's log in to the changes to take effect. </p><br><p>  The development toolchain development for Pixhawk / NuttX, including jmavsim, is done automatically using the <a href="">ubuntu_sim_nuttx.sh</a> script.  You need to download the script to the user's directory and run it with the command </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">source</span></span> ubuntu_sim_nuttx.sh</code> </pre> <br><p>  All questions asked by the script to answer positively. </p><br><p>  At the end of the script restart the computer. </p><br><p>  It remains for us to download the source code of the controller that controls the flight and assemble it. </p><br><p>  Clone the software repository of the flight controller PX4 with github: </p><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/PX4/Firmware.git</code> </pre><br><p>  In the Firmware folder, now we have the complete source code, which is executed in the flight controller (and in the simulator).  In the future, it can be useful both for the purpose of studying and making changes to it.  Go to the copied folder of the firmware repository: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> src/Firmware</code> </pre><br><p>  We compile and run the simulator: </p><br><pre> <code class="bash hljs">make px4_sitl jmavsim</code> </pre><br><p>  The first compilation process takes some time.  After successful completion, the PX4 console appears: </p><br><p><img src="https://habrastorage.org/webt/7l/rb/1u/7lrb1uqlicj_osjqsehpj0rwacs.png" alt="PX4 console"></p><br><p>  You can send a drone into flight by entering the command in the console: </p><br><pre> <code class="plaintext hljs">pxh&gt; commander takeoff</code> </pre> <br><p><img src="https://habrastorage.org/webt/x_/yn/2i/x_yn2ic0ejcwxe9dhohhkycwyg8.png" alt="Vitrualny drone in flight"></p><br><p>  Drone landing - <code>commander land</code> command, simulation stop - CTRL + C or <code>shutdown</code> . </p><br><h2 id="ustanovka-i-zapusk-jmavsim-na-windows">  Installing and running jMAVSim on Windows </h2><br><p>  The Cygwin PX4 tool kit appeared in 2018.  This is the most productive way to compile / develop a PX4 for Windows.  To install - download and run the installation file from <a href="https://github.com/PX4/windows-toolchain/releases">Github</a> or <a href="">Amazon</a> . </p><br><p>  By default, the toolchain is installed in the C: \ PX4 folder. </p><br><p>  At the last step of the installer, you can tick the "clone the PX4 repository, build and run simulation with jMAVSim" checkbox (clone the PX4 repository, compile and run the jMAVSim simulator). </p><br><p>  The development environment in Cygwin is launched using the run-console.bat file in the installation directory (by default, C: \ PX4). </p><br><p>  If you forgot to tick the jMAVSim launch checkbox during the installation process - in Cygwin you can clone the repository and start the simulator using the commands: </p><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> --recursive -j8 https://github.com/PX4/Firmware.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> Firmware make px4_sitl jmavsim</code> </pre><br><p>  After compiling, the PX4 console and the simulator window will appear on the screen: </p><br><p><img src="https://habrastorage.org/webt/ri/pd/pz/ripdpzbnhgyv6kktr8hfsftqpgw.png" alt="Windows jMAVSim simulator window"></p><br><p>  The sky and trees are not displayed on my Windows yet, instead of them - a black background, as <a href="https://github.com/PX4/jMAVSim/issues/84">reported by the developers of the simulator</a> . </p><br><p>  The console commands for managing the drone are the same: take-off ‚Äî <code>commander takeoff</code> , landing ‚Äî <code>commander land</code> , stop simulation ‚Äî CTRL + C, or the <code>shutdown</code> . </p><br><h2 id="polyoty-s-pomoschyu-programmy-nazemnoy-stancii-qgroundcontrol">  Flights using the QGroundControl ground station program </h2><br><p>  The QGroundControl program allows you to fully configure the drones on the PX4 or ArduPilot platforms, as well as plan and carry out autonomous flights outdoors using GPS. </p><br><p>  The program code is fully open, and it works on Windows, OS X, Linux, iOS and Android platforms.  The installation file for the desired platform can be downloaded <a href="https://docs.qgroundcontrol.com/en/getting_started/download_and_install.html">in the Download section of the program website</a> . </p><br><p>  For Windows, download and run <a href="">this file</a> . <br>  After installation and launch, if jMAVSim is already running on our computer, the program will connect to it automatically. </p><br><p>  You can launch a drone in flight using the Fly-Takeoff button, and land it.  You can also perform a virtual flight over GPS points: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/g-/sn/yo/g-snyoq6du43ymgelyeiyylaarc.png" alt="QGroundControl"></a> </p><br><h2 id="programmirovanie-avtonomnogo-polyota-s-pomoschyu-mavros">  Autonomous flight programming with mavros </h2><br><p>  Virtual drone jMAVSim can be controlled using the mavlink protocol, which is described in several articles (for example, <a href="https://habr.com/post/312300/">1</a> , <a href="https://habr.com/post/312592/">2</a> ).  To implement mavlink communication, we will use the mavros package of the <a href="http://www.ros.org/">ROS</a> system <a href="http://www.ros.org/">(robot operating system)</a> . </p><br><p>  PX4 developers recommend using ROS Kinetic. </p><br><p>  The mavros package provides MAVLink communication between the computer on which the ROS is running (for example, a Linux virtual machine, or Raspberry PI) and a flight controller (real or in a simulator environment). </p><br><p>  The mavros package is installed along with other packages during the <a href="http://wiki.ros.org/kinetic/Installation">full installation of Kinetic ROS</a> . </p><br><p>  The mavros package is launched with connection to the simulator using the roslaunch command, indicating the ip address and port of the computer on which the simulator is running: </p><br><pre> <code class="bash hljs">roslaunch mavros px4.launch fcu_url:=<span class="hljs-string"><span class="hljs-string">"udp://@192.168.0.22:14557"</span></span></code> </pre><br><p>  If the simulator is not running on the same host where jMAVSim is running, before connecting mavros, you must enable mavlink messages to be sent over the network using the <code>param set MAV_BROADCAST 1</code> in the jMAVSim console.  When the command is executed, the ip-address of the host used for the mavlink protocol is displayed.  The port can be found using the <code>mavlink status</code> command in the simulator console: </p><br><p><img src="https://habrastorage.org/webt/va/ap/xv/vaapxvkikt1ecz8k19p32rox2ua.png" alt="Mavlink status"></p><br><p>  The success of the connection to the flight controller should be checked with the command: </p><br><pre> <code class="bash hljs">rostopic <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> /mavros/state</code> </pre> <br><p>  If the connection is successful - so-called messages will appear in the console.  mavlink heartbeat, about once per second: </p><br><p><img src="https://habrastorage.org/webt/dg/lc/8v/dglc8vwds2msbjgsjqtx_mrhjqo.png" alt="mavlink heartbeat"></p><br><p>  If the messages do not appear / are not updated / the field Connected = False - the connection with the flight controller is not established, and you should find out why. </p><br><p>  At the time of this writing, under Windows, after the param set MAV_BROADCAST 1 command in the jMAVSim console, messages were started in a loop: </p><br><pre> <code class="plaintext hljs">WARN [mavlink] getting required buffer size failed.</code> </pre> <br><p>  In order for the simulator to work properly under Windows, you should add the line 1029 of the src / modules / mavlink / mavlink_main.cpp file: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(__APPLE__) &amp;&amp; defined(__MACH__) || defined(__CYGWIN__)</span></span></code> </pre><br><p>  And recompile / restart the simulator with the command <code>make px4_sitl jmavsim</code> . </p><br><p>  This problem has <a href="https://github.com/PX4/Firmware/issues/11030">been reported to the developers</a> , possibly, it will be fixed in subsequent releases. </p><br><p>  After a successful connection, you can launch the drone in an autonomous flight using the following commands of the ROS system console: </p><br><ul><li>  We publish 5 times per second target point for the flight of the drone in OFFBOARD mode.  To ensure that the drone does not ‚Äúfall out‚Äù of the OFFBOARD autonomous flight mode, it is necessary to publish the target point all the time, several times a second: <br><br><pre> <code class="bash hljs">rostopic pub -r 5 /mavros/setpoint_position/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span> geometry_msgs/PoseStamped <span class="hljs-string"><span class="hljs-string">"header: seq: 0 stamp: secs: 0 nsecs: 0 frame_id: '' pose: position: x: 0.0 y: 0.0 z: 5.0 orientation: x: 0.0 y: 0.0 z: 0.0 w: 0.0"</span></span></code> </pre> </li></ul><br><br><ul><li>  We transfer the drone to OFFBOARD mode (in a new separate terminal session): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="bash hljs">rosservice call /mavros/set_mode <span class="hljs-string"><span class="hljs-string">"base_mode: 0 custom_mode: 'OFFBOARD'"</span></span></code> </pre> <br></li><li>  We send the command to transfer the drone to flight mode (i.e. ‚Äúcharge‚Äù): <br><br><pre> <code class="bash hljs">rosservice call /mavros/cmd/arming <span class="hljs-string"><span class="hljs-string">"value: true"</span></span></code> </pre> </li></ul><br><p>  After the last command, the virtual drone should fly up and freeze at a height of 5 meters: </p><br><p><img src="https://habrastorage.org/webt/jo/if/xb/joifxbqtlwojorys81tmvxqti7q.png" alt="Flying jMAVSim"></p><br><p>  Also, the launch of the drone can be done using a simple code on Python: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> rospy <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> geometry_msgs.msg <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PoseStamped <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mavros_msgs.srv <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CommandBool, SetMode rospy.init_node(<span class="hljs-string"><span class="hljs-string">"offbrd"</span></span>,anonymous=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) rate=rospy.Rate(<span class="hljs-number"><span class="hljs-number">5</span></span>) setpoint_pub=rospy.Publisher(<span class="hljs-string"><span class="hljs-string">"/mavros/setpoint_position/local"</span></span>,PoseStamped,queue_size=<span class="hljs-number"><span class="hljs-number">10</span></span>) arming_s=rospy.ServiceProxy(<span class="hljs-string"><span class="hljs-string">"/mavros/cmd/arming"</span></span>,CommandBool) set_mode=rospy.ServiceProxy(<span class="hljs-string"><span class="hljs-string">"/mavros/set_mode"</span></span>,SetMode) setpt=PoseStamped() setpt.pose.position.z=<span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range (<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>): setpoint_pub.publish(setpt) rate.sleep() set_mode(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">"OFFBOARD"</span></span>) arming_s(<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (rospy.is_shutdown()==<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>): setpoint_pub.publish(setpt) rate.sleep()</code> </pre><br><p>  The code above uses the same ROS services as the command line example. </p><br><p>  The code needs to be copied to a text file, for example, fly_jmavsim.py, and run it from the command line with the command <code>python fly_jmavsim.py</code> . </p><br><p>  In the process of debugging this example, I encountered a feature of the jMAVSim simulator - it requires a productive processor for normal operation.  On a Linux virtual machine, he managed to calculate only 10 FPS, and fell immediately after takeoff.  On a laptop while I was writing an article - he also periodically lost control / fell.  It helped the laptop power from the network - because  when powered by a battery, power saving mode is activated, which underestimates processor performance, which directly affects the operation of the simulator. </p><br><p>  Based on the above examples, those who wish can develop autonomous flight programs themselves (by square, circle, arbitrary trajectory, etc.).  Performing such exercises can be useful to prepare for programming autonomous missions on a real quadcopter. </p><br><p>  We wish you all successful flights! </p><br><h2 id="ssylki">  References: </h2><br><p>  <a href="http://www.ros.org/">Robot Operating System (ROS)</a> <br>  <a href="https://px4.io/">Autopilot PX4</a> </p></div><p>Source: <a href="https://habr.com/ru/post/434220/">https://habr.com/ru/post/434220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434210/index.html">Analysis of the quiz contest on Android from the HeadHunter booth at Mobius 2018 Moscow</a></li>
<li><a href="../434212/index.html">Tesla Tower. What happens in and near the skyscraper when lightning strikes?</a></li>
<li><a href="../434214/index.html">Dynamic Java Proxy: What is it and how to use it?</a></li>
<li><a href="../434216/index.html">Brute-force attacks using Kali Linux</a></li>
<li><a href="../434218/index.html">Simple Java bot-clicker on the example of the game World of Warcraft 3.3.5a</a></li>
<li><a href="../434222/index.html">Amazon ground station for rent - receiving and processing data from satellites</a></li>
<li><a href="../434224/index.html">Digital events in Moscow from December 24 to 30</a></li>
<li><a href="../434226/index.html">Habrautilitis for the collection of habrastatistiki</a></li>
<li><a href="../434228/index.html">How to increase the security of web applications using HTTP headers</a></li>
<li><a href="../434230/index.html">Presentation of GOM Atos 5 / 5X 3D scanners at Top 3D Expo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>